import{c as Pn,u as Dn,a as De,r as Xs,b as Ft,d as En,g as l,e as xn,f as Tn,t as kn,h as Mn,n as Ge,m as Ve,s as $,i as An,M as Lt,j as Xt,P as B,p as Hi,k as Oi,l as js,o as $n,q as je,v as ve,w as me,x as ie,y as Be,z as N,A as T,B as M,C as z,D as kt,E as U,F as $e,G as ae,H as xe,I as ne,J as Ne,K as v,L as ye,N as Ce,O as ge,Q as Kt,R as V,S as Ss,T as Je,U as Qe,V as cs,W as he,X as ue,Y as Hn,Z as On,_ as qe,$ as Li,a0 as Ln,a1 as Rn}from"./PixelButton-F-003vX1.js";import"./phaser-DFK5Ua9d.js";function Nn(n=!1){const e=Pn,t=e.l.u;if(!t)return;let s=()=>xn(e.s);if(n){let i=0,a={};const r=Tn(()=>{let o=!1;const c=e.s;for(const d in c)c[d]!==a[d]&&(a[d]=c[d],o=!0);return o&&i++,i});s=()=>l(r)}t.b.length&&Dn(()=>{di(e,s),Xs(t.b)}),De(()=>{const i=Ft(()=>t.m.map(En));return()=>{for(const a of i)typeof a=="function"&&a()}}),t.a.length&&De(()=>{di(e,s),Xs(t.a)})}function di(n,e){if(n.l.s)for(const t of n.l.s)l(t);e()}let Ws=Symbol();function L(n,e,t){const s=t[e]??={store:null,source:Ve(void 0),unsubscribe:Ge};if(s.store!==n&&!(Ws in t))if(s.unsubscribe(),s.store=n??null,n==null)s.source.v=void 0,s.unsubscribe=Ge;else{var i=!0;s.unsubscribe=Vs(n,a=>{i?s.source.v=a:$(s.source,a)}),i=!1}return n&&Ws in t?Ze(n):l(s.source)}function Pe(){const n={};function e(){kn(()=>{for(var t in n)n[t].unsubscribe();Mn(n,Ws,{enumerable:!1,value:!0})})}return[n,e]}function Vs(n,e,t){if(n==null)return e(void 0),t&&t(void 0),Ge;const s=Ft(()=>n.subscribe(e,t));return s.unsubscribe?()=>s.unsubscribe():s}const _t=[];function Xn(n,e){return{subscribe:J(n,e).subscribe}}function J(n,e=Ge){let t=null;const s=new Set;function i(o){if(An(n,o)&&(n=o,t)){const c=!_t.length;for(const d of s)d[1](),_t.push(d,n);if(c){for(let d=0;d<_t.length;d+=2)_t[d][0](_t[d+1]);_t.length=0}}}function a(o){i(o(n))}function r(o,c=Ge){const d=[o,c];return s.add(d),s.size===1&&(t=e(i,a)||Ge),o(n),()=>{s.delete(d),s.size===0&&t&&(t(),t=null)}}return{set:i,update:a,subscribe:r}}function Te(n,e,t){const s=!Array.isArray(n),i=s?[n]:n;if(!i.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const a=e.length<2;return Xn(t,(r,o)=>{let c=!1;const d=[];let h=0,g=Ge;const f=()=>{if(h)return;g();const I=e(s?d[0]:d,r,o);a?r(I):g=typeof I=="function"?I:Ge},P=i.map((I,D)=>Vs(I,_=>{d[D]=_,h&=~(1<<D),c&&f()},()=>{h|=1<<D}));return c=!0,f(),function(){Xs(P),g(),c=!1}})}function Ze(n){let e;return Vs(n,t=>e=t)(),e}const Wn=J("#2a1a0a"),Yn=J(!0),Ri=J({x:0,y:0});function Bn(n,e){Ri.set({x:n,y:e})}const Zn=J({scrollX:0,scrollY:0,zoom:1});function Gn(n,e,t=1){Zn.set({scrollX:n,scrollY:e,zoom:t})}const Ni=J({worldWidth:640,worldHeight:640,offsetX:0,offsetY:0});function Fn(n,e,t,s,i=1){const a=n*i,r=e*i,o=Math.max(0,(t-a)/2),c=Math.max(0,(s-r)/2);Ni.set({worldWidth:a,worldHeight:r,offsetX:o,offsetY:c})}const Ys=J(!1);function Kn(){Ys.set(!0),setTimeout(()=>Ys.set(!1),150)}const qs=J(1);function es(n){qs.set(n)}const Xi=J({scrollX:0,scrollY:0,viewWidth:0,viewHeight:0,worldWidth:0,worldHeight:0,zoom:1,playerX:0,playerY:0});function zn(n){Xi.update(e=>({...e,...n}))}const Un={isActive:!1,config:null,selectedItemId:null,editMode:"items",selectedDialogZoneId:null,selectedSocialId:null,isPlayerSelected:!1},j=J(Un),jn=Te(j,n=>n.isActive),Wi=Te(j,n=>n.config),He=Te(j,n=>n.editMode),ds=J(!0);function Vn(){ds.update(n=>!n)}const ct=J(!1);function xt(n){ct.set(n)}const Bs=J(!1);function ks(n){Bs.set(n)}function qn(n){j.set({isActive:!0,config:{...n,placedItems:n.placedItems||[],dialogZones:n.dialogZones||[],placedSocials:n.placedSocials||[]},selectedItemId:null,editMode:"items",selectedDialogZoneId:null,selectedSocialId:null,isPlayerSelected:!1}),qs.set(1)}function Jn(){j.update(n=>{const e=n.config?{...n.config,dialogZones:(n.config.dialogZones||[]).filter(t=>t.texts.some(s=>s.title.trim()!==""||s.content.trim()!==""))}:n.config;return{...n,isActive:!1,selectedItemId:null,config:e}}),qs.set(1)}function Qn(){return Ze(j).config}function Rt(n){j.update(e=>({...e,editMode:n,selectedItemId:null,selectedDialogZoneId:null}))}const Me={BACKGROUND_LAYER_START:-99,GROUND_REFERENCE:-1,DYNAMIC_BASE:100,DYNAMIC_MAX:999,ITEMS_BEHIND:5,PLAYER:10,ITEMS_FRONT:15,FOREGROUND_LAYER_START:1e3,SELECTION_GRAPHICS:1999,GRID_OVERLAY:2e3};function ws(n,e){const t=Math.max(0,Math.min(1,n/e)),s=Me.DYNAMIC_MAX-Me.DYNAMIC_BASE;return Math.round(Me.DYNAMIC_BASE+t*s)}function Yi(n){return n==="behind"?Me.ITEMS_BEHIND:Me.ITEMS_FRONT}const ea=[{code:"cs",label:"CZ"},{code:"en",label:"EN"}],Bi="cs",zt=J("cs"),Zs=J("succubus"),Zi=J("Forest"),Gi=J(!1),Gs=J(!1),Nt=J(!1),Fi=J(!1),Js=J(!1),rt=J(!1),nt=J(!1),ot=J(!1),qt=J(!1),Jt=J(!1),bs=J(!1);function ta(){rt.update(n=>!n)}function sa(){nt.update(n=>!n)}function Ki(){ot.update(n=>!n)}function zi(){qt.set(!0)}function ia(){qt.set(!1)}function Ui(){Jt.set(!0)}function na(){Jt.set(!1)}function ji(){bs.set(!0)}function hi(){bs.set(!1)}const St=Te(j,n=>n.selectedItemId),Qs=Te(j,n=>!n.selectedItemId||!n.config?.placedItems?null:n.config.placedItems.find(e=>e.id===n.selectedItemId)??null),aa=Te(Qs,n=>n?.physicsEnabled??!1),ra=Te(Qs,n=>n?.flipX??!1),Vi=J(null);function Ms(n){Vi.set(n)}function oa(n){j.update(e=>{if(!e.config)return e;const t=e.config.placedItems||[];return{...e,config:{...e.config,placedItems:[...t,n]}}})}function hs(n,e){j.update(t=>!t.config||!t.config.placedItems?t:{...t,config:{...t.config,placedItems:t.config.placedItems.map(s=>s.id===n?{...s,...e}:s)}})}function qi(n){j.update(e=>!e.config||!e.config.placedItems?e:{...e,config:{...e.config,placedItems:e.config.placedItems.filter(t=>t.id!==n)},selectedItemId:e.selectedItemId===n?null:e.selectedItemId})}function _s(n){qt.set(!1),j.update(e=>({...e,selectedItemId:n,isPlayerSelected:n?!1:e.isPlayerSelected}))}function la(n,e){e?hs(n,{physicsEnabled:e,depth:Yi("behind")}):hs(n,{physicsEnabled:e})}function ca(n,e){hs(n,{flipX:e})}const Ut=Te(j,n=>n.selectedSocialId),da=Te(j,n=>n.config?.placedSocials||[]),ha=Te(j,n=>!n.selectedSocialId||!n.config?.placedSocials?null:n.config.placedSocials.find(e=>e.id===n.selectedSocialId)??null),Ji=J(null);function As(n){Ji.set(n)}function ua(n){j.update(e=>{if(!e.config)return e;const t=e.config.placedSocials||[];return{...e,config:{...e.config,placedSocials:[...t,n]}}})}function rs(n,e){j.update(t=>!t.config||!t.config.placedSocials?t:{...t,config:{...t.config,placedSocials:t.config.placedSocials.map(s=>s.id===n?{...s,...e}:s)}})}function ei(n){j.update(e=>!e.config||!e.config.placedSocials?e:{...e,config:{...e.config,placedSocials:e.config.placedSocials.filter(t=>t.id!==n)},selectedSocialId:e.selectedSocialId===n?null:e.selectedSocialId})}function Wt(n){Jt.set(!1),j.update(e=>({...e,selectedSocialId:n,isPlayerSelected:n?!1:e.isPlayerSelected,selectedItemId:n?null:e.selectedItemId}))}const Is=Te(j,n=>n.selectedDialogZoneId),ti=Te(j,n=>n.config?.dialogZones||[]),Qi=J(null);function ts(n){Qi.set(n)}function ga(n){j.update(e=>{if(!e.config)return e;const t=e.config.dialogZones||[];return{...e,config:{...e.config,dialogZones:[...t,n]}}})}function Ct(n,e){j.update(t=>!t.config||!t.config.dialogZones?t:{...t,config:{...t.config,dialogZones:t.config.dialogZones.map(s=>s.id===n?{...s,...e}:s)}})}function en(n){j.update(e=>!e.config||!e.config.dialogZones?e:{...e,config:{...e.config,dialogZones:e.config.dialogZones.filter(t=>t.id!==n)},selectedDialogZoneId:e.selectedDialogZoneId===n?null:e.selectedDialogZoneId})}function Yt(n){j.update(e=>({...e,selectedDialogZoneId:n}))}function fa(n,e,t){j.update(s=>!s.config||!s.config.dialogZones?s:{...s,config:{...s.config,dialogZones:s.config.dialogZones.map(i=>{if(i.id!==n)return i;const a=i.texts.findIndex(o=>o.language===e);let r;return a>=0?r=i.texts.map((o,c)=>c===a?{...o,...t}:o):r=[...i.texts,{language:e,title:"",content:"",...t}],{...i,texts:r}})}})}const ui=Te(j,n=>n.isPlayerSelected);function gi(n,e){j.update(t=>t.config?{...t,config:{...t.config,playerStartX:n,playerStartY:e}}:t)}function pa(n){j.update(e=>({...e,isPlayerSelected:n,selectedItemId:null}))}function wt(){j.update(n=>({...n,selectedItemId:null,selectedDialogZoneId:null,selectedSocialId:null,isPlayerSelected:!1}))}const si=Te(j,n=>!n.selectedItemId||!n.config?.placedNPCs?null:n.config.placedNPCs.find(e=>e.id===n.selectedItemId)??null),ma=Te(si,n=>n?.flipX??!1),tn=J(null);function ss(n){tn.set(n)}function va(n){j.update(e=>{if(!e.config)return e;const t=e.config.placedNPCs||[];return{...e,config:{...e.config,placedNPCs:[...t,n]},isDirty:!0}})}function ii(n,e){j.update(t=>{if(!t.config?.placedNPCs)return t;const s=t.config.placedNPCs.map(i=>i.id===n?{...i,...e}:i);return{...t,config:{...t.config,placedNPCs:s},isDirty:!0}})}function ya(n,e,t){j.update(s=>{if(!s.config?.placedNPCs)return s;const i=s.config.placedNPCs.map(a=>{if(a.id!==n)return a;const r=a.dialog||[],o=r.findIndex(d=>d.language===e);let c;return o>=0?(c=[...r],c[o]={...c[o],...t}):c=[...r,{language:e,title:"",content:t.content??""}],{...a,dialog:c}});return{...s,config:{...s.config,placedNPCs:i},isDirty:!0}})}function Sa(n,e){ii(n,{flipX:e})}function ni(n){j.update(e=>{if(!e.config?.placedNPCs)return e;const t=e.config.placedNPCs.filter(i=>i.id!==n),s=e.selectedItemId===n?null:e.selectedItemId;return{...e,selectedItemId:s,config:{...e.config,placedNPCs:t},isDirty:!0}})}let sn=!1,Pt=!1;function is(n){sn=n}function fi(){return sn}function bt(){return Pt}function $s(n){if(!n||n.tagName==="CANVAS")return!1;if(n.closest("[data-ui]"))return!0;const e=document.getElementById("game-ui");return!!(e&&e.contains(n)||n.closest("button"))}function wa(){document.addEventListener("pointerdown",n=>{Pt=$s(n.target)},{capture:!0}),document.addEventListener("pointermove",n=>{n.buttons>0||(Pt=$s(n.target))},{capture:!0}),document.addEventListener("pointerup",()=>{setTimeout(()=>{Pt=!1},10)},{capture:!0}),document.addEventListener("touchstart",n=>{Pt=$s(n.target)},{capture:!0,passive:!0}),document.addEventListener("touchend",()=>{setTimeout(()=>{Pt=!1},10)},{capture:!0,passive:!0})}function Bt(){const n=document.activeElement;if(!n)return!1;const e=n.tagName.toUpperCase();return e==="INPUT"||e==="TEXTAREA"||n.getAttribute("contenteditable")==="true"}function vt(n,e,t){const s=(n-t.worldView.x)*t.zoom,i=(e-t.worldView.y)*t.zoom;return{screenX:s,screenY:i}}function ba(n,e,t){const s=n/t.zoom+t.worldView.x,i=e/t.zoom+t.worldView.y;return{worldX:s,worldY:i}}const nn={campfire:{frameWidth:32,frameHeight:32,frameRate:10,repeat:-1,endFrame:39}},ai=[{key:"campfire",name:"Campfire",path:"assets/items/campfire.png",scale:5,group:"shared",category:"props"},{key:"stones_0",name:"Stones 0",path:"assets/items/stones_0.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_1",name:"Stones 1",path:"assets/items/stones_1.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_3",name:"Stones 3",path:"assets/items/stones_3.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_4",name:"Stones 4",path:"assets/items/stones_4.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"barell",name:"Barrel",path:"assets/items/barell.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"box",name:"Box",path:"assets/items/box.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"chair",name:"Chair",path:"assets/items/chair.png",scale:4,group:"shared",category:"furniture"},{key:"stool",name:"Stool",path:"assets/items/stool.png",scale:4,group:"shared",category:"furniture"},{key:"table_small",name:"Table Small",path:"assets/items/table_small.png",scale:4,group:"shared",category:"furniture"},{key:"table_full",name:"Table Full",path:"assets/items/table_full.png",scale:4,group:"forest_summer",category:"furniture"},{key:"kettle",name:"Kettle",path:"assets/items/kettle.png",scale:4,group:"shared",category:"props"},{key:"log_axe",name:"Log with Axe",path:"assets/items/log_axe.png",scale:4,group:"shared",category:"props"},{key:"log_chisel",name:"Log with Chisel",path:"assets/items/log_chisel.png",scale:4,group:"shared",category:"props"},{key:"apple_basket",name:"Apple Basket",path:"assets/items/apple_basket.png",scale:4,group:"shared",category:"props"},{key:"apples",name:"Apples",path:"assets/items/apples.png",scale:4,group:"forest_summer",category:"props"},{key:"pumpkin",name:"Pumpkin",path:"assets/items/pumpkin.png",scale:4,group:"forest_summer",category:"nature"},{key:"pumpkin_helloween",name:"Pumpkin Halloween",path:"assets/items/pumpkin_helloween.png",scale:4,group:"forest_summer",category:"props"},{key:"scarecrow",name:"Scarecrow",path:"assets/items/scarecrow.png",scale:4,group:"forest_summer",category:"props"},{key:"sign_skogen",name:"Sign Skogen",path:"assets/items/sign_skogen.png",scale:4,group:"forest_shared",category:"props"},{key:"statue",name:"Statue",path:"assets/items/statue.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"wall",name:"Wall",path:"assets/items/wall.png",scale:4,group:"forest_summer",category:"structures"},{key:"hanger",name:"Hanger",path:"assets/items/hanger.png",scale:4,group:"forest_summer",category:"furniture"},{key:"cauldron_campfire",name:"Cauldron Campfire",path:"assets/items/cauldron_campfire.png",scale:4,group:"shared",category:"props"},{key:"ore_copper",name:"Ore Copper",path:"assets/items/ore_copper.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_dia",name:"Ore Diamond",path:"assets/items/ore_dia.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_gold",name:"Ore Gold",path:"assets/items/ore_gold.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_tin",name:"Ore Tin",path:"assets/items/ore_tin.png",scale:4,group:"cave_dark",category:"nature"},{key:"tent_large",name:"Tent Large",path:"assets/items/tent_large.png",scale:4,group:"forest_summer",category:"structures"},{key:"tent",name:"Tent Small",path:"assets/items/tent.png",scale:4,group:"forest_summer",category:"structures"},{key:"bush_0",name:"Bush 0",path:"assets/items/bush_0.png",scale:4,group:"forest_summer",category:"nature"},{key:"bush_1",name:"Bush 1",path:"assets/items/bush_1.png",scale:4,group:"forest_summer",category:"nature"},{key:"bush_2",name:"Bush 2",path:"assets/items/bush_2.png",scale:4,group:"forest_summer",category:"nature"},{key:"grass",name:"Grass",path:"assets/items/grass.png",scale:4,group:"forest_summer",category:"nature"},{key:"grass_0",name:"Grass 0",path:"assets/items/grass_0.png",scale:4,group:"forest_summer",category:"nature"},{key:"tree_picea",name:"Tree Picea",path:"assets/items/tree_picea.png",scale:4,group:"forest_summer",category:"nature"},{key:"tree_pinus",name:"Tree Pinus",path:"assets/items/tree_pinus.png",scale:4,group:"forest_summer",category:"nature"},{key:"grave_0",name:"Grave 0",path:"assets/items/grave_0.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_1",name:"Grave 1",path:"assets/items/grave_1.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_2",name:"Grave 2",path:"assets/items/grave_2.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_3",name:"Grave 3",path:"assets/items/grave_3.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_4",name:"Grave 4",path:"assets/items/grave_4.png",scale:4,group:"forest_shared",category:"props"},{key:"icebush_0",name:"Ice Bush 0",path:"assets/items/icebush_0.png",scale:4,group:"forest_birch",category:"nature"},{key:"icebush_1",name:"Ice Bush 1",path:"assets/items/icebush_1.png",scale:4,group:"forest_birch",category:"nature"},{key:"icebush_2",name:"Ice Bush 2",path:"assets/items/icebush_2.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_0",name:"Ice Stones 0",path:"assets/items/icestones_0.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_1",name:"Ice Stones 1",path:"assets/items/icestones_1.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_2",name:"Ice Stones 2",path:"assets/items/icestones_2.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_3",name:"Ice Stones 3",path:"assets/items/icestones_3.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_4",name:"Ice Stones 4",path:"assets/items/icestones_4.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_5",name:"Ice Stones 5",path:"assets/items/icestones_5.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_6",name:"Ice Stones 6",path:"assets/items/icestones_6.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_7",name:"Ice Stones 7",path:"assets/items/icestones_7.png",scale:4,group:"forest_birch",category:"nature"},{key:"snow_pile",name:"Snow Pile",path:"assets/items/snow_pile.png",scale:4,group:"forest_birch",category:"nature"}];function an(n){return ai.find(e=>e.key===n)}function _a(n){return an(n)?.scale||1}function Fs(n){return n in nn}function Ks(n){return nn[n]}function Ia(n){return an(n)?.supportsPhysics??!1}class pi{scene;groundY;constructor(e,t){this.scene=e,this.groundY=t}static preloadAssets(e){ai.forEach(t=>{if(Fs(t.key)){const s=Ks(t.key);s&&e.load.spritesheet(t.key,t.path,{frameWidth:s.frameWidth,frameHeight:s.frameHeight})}else e.load.image(t.key,t.path)})}createSprite(e){const{id:t,assetKey:s,x:i,scale:a=1,depth:r=5,yOffset:o=0,flipX:c=!1}=e,d=this.groundY+o,h=this.scene.add.sprite(i,d,s);if(h.setScale(a),h.setDepth(r),h.setFlipX(c),h.setData("itemId",t),Fs(s)){const g=`${s}_anim`,f=Ks(s);f&&(this.scene.anims.exists(g)||this.scene.anims.create({key:g,frames:this.scene.anims.generateFrameNumbers(s,{start:f.startFrame??0,end:f.endFrame}),frameRate:f.frameRate??8,repeat:f.repeat??-1}),h.play(g))}return h}updatePosition(e,t,s){e.x=t,e.y=this.groundY+s}updateScale(e,t){e.setScale(t)}updateDepth(e,t){e.setDepth(t)}applyUpdates(e,t){t.x!==void 0&&(e.x=t.x),t.yOffset!==void 0&&(e.y=this.groundY+t.yOffset),t.scale!==void 0&&e.setScale(t.scale),t.depth!==void 0&&e.setDepth(t.depth),t.flipX!==void 0&&e.setFlipX(t.flipX)}worldYToOffset(e){return e-this.groundY}getGroundY(){return this.groundY}}function Dt(n){return parseInt(n.replace("#",""),16)}const mt={BLUE:"#4a90e2",GREEN:"#27ae60",PURPLE:"#9b59b6",TEAL:"#1abc9c",PINK:"#e91e8f"},Cs={ITEM:{hex:Dt(mt.BLUE)},FRAME:{hex:Dt(mt.PURPLE)},SOCIAL:{css:mt.PINK,hex:Dt(mt.PINK)},DIALOG_ZONE:{hex:Dt(mt.TEAL)},PLAYER:{hex:Dt(mt.GREEN)}},rn=Dt(mt.BLUE),on=240,Ca=48;function os(n){const e=`assets/skins/static/${n.folder}`;return n.variant?`${e}/${n.variant}`:e}function Zt(n){if(n.scale!==void 0)return n.scale;const e=n.frameHeight??Ca;return on/e}const Ie=[{id:"succubus",name:"SUCCUBUS",folder:"succubus",variant:"basic",character:"human",frameWidth:156,frameHeight:72,facingLeft:!0,frameRates:{idle:8,run:12}}],ln="succubus";class Pa{currentSkinId=ln;constructor(){this.loadFromStorage()}loadFromStorage(){const e=localStorage.getItem("playerSkin");e&&this.isValidSkinId(e)&&(this.currentSkinId=e)}isValidSkinId(e){return Ie.some(t=>t.id===e)}setSkin(e){this.isValidSkinId(e)&&(this.currentSkinId=e,localStorage.setItem("playerSkin",e))}getSkinId(){return this.currentSkinId}getSkinConfig(){return Ie.find(e=>e.id===this.currentSkinId)||Ie[0]}getSkinById(e){return Ie.find(t=>t.id===e)}getAllSkins(){return Ie}getAnimationPrefix(){const e=this.getSkinConfig();return`${e.character}-${e.id}`}}const yt=new Pa,Gt={DEPTH:Me.PLAYER},Da={HALF_HEIGHT:on/2},lt={FRAME_WIDTH:Lt.WIDTH,FRAME_HEIGHT:Lt.HEIGHT,WIDTH:Lt.WIDTH*Xt,HEIGHT:Lt.HEIGHT*Xt,HALF_HEIGHT:Lt.HEIGHT*Xt/2},We=40;function cn(n,e=We){return n-e}function Mt(n,e=We){return cn(n,e)-Da.HALF_HEIGHT}function Ea(n,e,t=We){const s=Mt(e,t);return n>s}function jt(n,e=We){return cn(n,e)-lt.HALF_HEIGHT}function xa(n,e,t=We){const s=jt(e,t);return n>s}const Hs={WIDTH:.33,HEIGHT:.25,OFFSET_Y:.75},mi={WIDTH:.4,HEIGHT:.3},zs={WIDTH:.6};function Ta(n,e){const t=Math.round(n*Hs.WIDTH),s=Math.round(e*Hs.HEIGHT),i=Math.round((n-t)/2),a=Math.round(e*Hs.OFFSET_Y);return{width:t,height:s,offsetX:i,offsetY:a}}function ka(){const n=Math.round(lt.WIDTH*mi.WIDTH),e=Math.round(lt.HEIGHT*mi.HEIGHT),t=-n/2,s=lt.HEIGHT/2-e;return{width:n,height:e,offsetX:t,offsetY:s}}const Et=50,Ma=4871528,Aa=.4,$a=1,dn=Me.GRID_OVERLAY,Os=16711680,Ha=2,Oa=.6,La=.1,Ra=1,Na=.2,vi=50,Xa=50,Wa=rn,Ya=()=>{try{return!1}catch{return!1}},yi=Ya(),Si=65280,Ba=.1,Za=1,Ga=.3,Fa=.2,Ka=2,za=.8;class hn{lastClickTime=0;lastClickId=null;threshold;constructor(e=300){this.threshold=e}check(e){const t=Date.now(),s=this.lastClickId===e&&t-this.lastClickTime<this.threshold;return this.lastClickTime=t,this.lastClickId=e,s}reset(){this.lastClickTime=0,this.lastClickId=null}}function ns(n,e){return Math.round(n/e)*e}function Ps(n){const{sprite:e,scene:t,callbacks:s={},constraints:i,useGridSnapping:a=!0,cursor:r="grab",hitArea:o}=n;let c=!1,d=0,h=0,g=0;if(o){if(e.setInteractive(o,B.Geom.Rectangle.Contains),e.input){const u=e.input;u.cursor=r,u.useHandCursor=!0}}else e.setInteractive({useHandCursor:!0,cursor:r});const f=(u,p)=>{const C=e.getBounds(),w=5;return u>=C.x-w&&u<=C.x+C.width+w&&p>=C.y-w&&p<=C.y+C.height+w},P=()=>{const u=t.data.get("lastTapTime");if(!u||u===g||Date.now()-u>100)return;g=u;const p=t.data.get("lastTapWorldX"),C=t.data.get("lastTapWorldY");f(p,C)&&s.onSelect?.()},I=u=>{if(u.wasTouch||Ze(Bs)||bt()||c||s.onDoubleClick?.())return;const p=s.isSelected?.()??!1;s.onSelect?.(),p&&(c=!0,t.data.set("isDraggingItem",!0),xt(!0),d=e.x-u.worldX,h=e.y-u.worldY,s.onDragStart?.())},D=u=>{if(u.wasTouch){const w=t.data.get("touchDragStarted");if(!c&&w&&s.isSelected?.()){const x=t.data.get("touchStartWorldX"),X=t.data.get("touchStartWorldY"),m=e.getBounds(),E=10;x>=m.x-E&&x<=m.x+m.width+E&&X>=m.y-E&&X<=m.y+m.height+E&&(c=!0,t.data.set("isDraggingItem",!0),t.data.set("touchDragStarted",!1),xt(!0),d=e.x-x,h=e.y-X,s.onDragStart?.())}if(c){let b=u.worldX+d,x=u.worldY+h;a&&Ze(ds)&&(b=ns(b,Et),x=ns(x,Et)),i&&(i.minX!==void 0&&(b=Math.max(b,i.minX)),i.maxX!==void 0&&(b=Math.min(b,i.maxX)),i.minY!==void 0&&(x=Math.max(x,i.minY)),i.maxY!==void 0&&(x=Math.min(x,i.maxY))),e.setPosition(b,x),s.onDrag?.(b,x)}return}if(!c)return;if(Ze(Bs)){y();return}if(!u.isDown){y();return}let p=u.worldX+d,C=u.worldY+h;a&&Ze(ds)&&(p=ns(p,Et),C=ns(C,Et)),i&&(i.minX!==void 0&&(p=Math.max(p,i.minX)),i.maxX!==void 0&&(p=Math.min(p,i.maxX)),i.minY!==void 0&&(C=Math.max(C,i.minY)),i.maxY!==void 0&&(C=Math.min(C,i.maxY))),e.setPosition(p,C),s.onDrag?.(p,C)},_=()=>{c&&y()},y=()=>{c=!1,t.data.set("isDraggingItem",!1),xt(!1),s.onDragEnd?.(e.x,e.y)};e.on("pointerdown",I),t.input.on("pointermove",D),t.input.on("pointerup",_);const S=()=>{P()};return t.events.on("update",S),()=>{e.off("pointerdown",I),t.input.off("pointermove",D),t.input.off("pointerup",_),t.events.off("update",S)}}class Ua{scene;groundY;worldWidth;worldHeight;isDragging=!1;callbacks;cleanupFunctions=new Map;constructor(e,t,s,i,a={}){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=i,this.callbacks=a}getIsDragging(){return this.isDragging}makeInteractive(e,t){const s=Ps({sprite:e,scene:this.scene,cursor:"pointer",constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{_s(t),this.callbacks.onSelect?.(t)},isSelected:()=>Ze(St)===t,onDragStart:()=>{this.isDragging=!0,e.setTint(rn),this.callbacks.onDragStart?.(t)},onDrag:(i,a)=>{this.callbacks.onDrag?.(t,i,a)},onDragEnd:(i,a)=>{e.clearTint(),this.isDragging=!1;const r=Math.round(i),c=Math.round(a)-this.groundY;hs(t,{x:r,yOffset:c}),this.callbacks.onDragEnd?.(t,r,c)}}});this.cleanupFunctions.set(t,s)}removeInteractivity(e){if(!e||!e.scene)return;const t=e.getData("itemId");t&&this.cleanupFunctions.has(t)&&(this.cleanupFunctions.get(t)(),this.cleanupFunctions.delete(t)),e.removeInteractive()}destroy(){this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear()}}const at={ITEM:"itemId",SOCIAL:"socialId",NPC:"npcId",PLAYER:"isPlayer",ZONE:"zoneId"},ja={[at.ITEM]:"selectedItemId",[at.SOCIAL]:"selectedSocialId",[at.NPC]:"selectedItemId",[at.PLAYER]:"isPlayerSelected"};function un(n){return typeof n.getData=="function"}function Va(n){return un(n)?n.type==="Rectangle"?!!n.getData(at.ZONE):Object.values(at).some(e=>e===at.ZONE?!1:!!n.getData(e)):!1}function qa(n,e){if(!un(n))return!1;for(const[t,s]of Object.entries(ja)){const i=n.getData(t);if(i)if(t===at.PLAYER){const a=e.data.get(s),r=e.data.get("playerSprite");if(a&&n===r)return!0}else{const a=e.data.get(s);if(i===a)return!0}}return!1}function Ja(n,e){const t=n.input.hitTestPointer(e);for(const s of t)if(qa(s,n))return!0;return!1}const Qa={lineWidth:3,lineColor:Cs.ITEM.hex,lineAlpha:1,padding:5};class er{scene;graphics;style;selectedId=null;constructor(e,t={}){this.scene=e,this.style={...Qa,...t},this.graphics=e.add.graphics(),this.graphics.setDepth(Me.SELECTION_GRAPHICS)}setSelectedId(e){this.selectedId=e}getSelectedId(){return this.selectedId}updateVisuals(e){if(this.graphics.clear(),!e||!this.selectedId)return;const t=e.getBounds(),{lineWidth:s,lineColor:i,lineAlpha:a,padding:r}=this.style;this.graphics.lineStyle(s,i,a),this.graphics.strokeRect(t.x-r,t.y-r,t.width+r*2,t.height+r*2)}clearVisuals(){this.graphics.clear(),this.selectedId=null}setupBackgroundDeselect(e){this.scene.input.on("pointerdown",t=>{if(bt()||e())return;this.scene.input.hitTestPointer(t).find(a=>Va(a))||(wt(),this.clearVisuals())})}destroy(){this.graphics?.destroy()}}class us{scene;items=new Map;isBuilderMode=!1;physicsGroup=null;renderer;dragController;selectionManager;constructor(e,t,s,i,a=!1){this.scene=e,this.isBuilderMode=a,this.renderer=new pi(e,t),a||(this.physicsGroup=e.physics.add.staticGroup()),this.isBuilderMode&&(this.dragController=new Ua(e,t,s,i,{onSelect:()=>this.updateSelectionVisuals(),onDrag:()=>this.updateSelectionVisuals()}),this.selectionManager=new er(e))}static preloadAssets(e){pi.preloadAssets(e)}createItems(e){e.forEach(t=>{this.createItem(t)})}createItem(e){const t=this.renderer.createSprite(e),s={sprite:t,data:e};if(!this.isBuilderMode&&e.physicsEnabled&&this.physicsGroup){const i=this.createPhysicsBody(t,e);s.physicsBody=i}this.items.set(e.id,s),this.isBuilderMode&&this.dragController&&this.dragController.makeInteractive(t,e.id)}createPhysicsBody(e,t){const s=e.getBounds(),i=s.width*.5,a=s.height*.8,r=e.x,o=e.y,c=this.scene.add.rectangle(r,o,i,a);return c.setVisible(!1),this.physicsGroup.add(c),c.setData("itemId",t.id),c}updateSelectionVisuals(){if(!this.selectionManager)return;const e=this.scene.data.get("selectedItemId");if(this.selectionManager.setSelectedId(e),!e){this.selectionManager.clearVisuals(),Ms(null);return}const t=this.items.get(e);if(this.selectionManager.updateVisuals(t?.sprite??null),t?.sprite){const s=this.scene.cameras.main,i=t.sprite.getBounds(),{screenX:a,screenY:r}=vt(i.centerX,i.centerY,s),o=i.height*s.zoom;Ms({screenX:a,screenY:r,itemHeight:o})}else Ms(null)}updateItem(e,t){const s=this.items.get(e);s&&(this.renderer.applyUpdates(s.sprite,t),s.data={...s.data,...t})}removeItem(e){const t=this.items.get(e);t&&(this.dragController&&this.dragController.removeInteractivity(t.sprite),t.physicsBody&&t.physicsBody.destroy(),t.sprite.destroy(),this.items.delete(e))}removeAllItems(){this.items.forEach(e=>{!e.sprite||!e.sprite.scene||(this.dragController&&this.dragController.removeInteractivity(e.sprite),e.physicsBody&&e.physicsBody.destroy(),e.sprite.destroy())}),this.items.clear()}getItem(e){return this.items.get(e)?.data}getAllItems(){return Array.from(this.items.values()).map(e=>e.data)}getPhysicsGroup(){return this.physicsGroup}setInteractiveEnabled(e){!this.isBuilderMode||!this.dragController||(this.items.forEach(({sprite:t,data:s})=>{e?(this.dragController.makeInteractive(t,s.id),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectionManager&&this.selectionManager.clearVisuals())}updateAutoDepth(e){this.items.forEach(({sprite:t,data:s})=>{if(s.physicsEnabled){t.setDepth(Me.DYNAMIC_BASE);return}const a=t.getBounds().bottom,r=ws(a,e);t.setDepth(r)})}destroy(){this.removeAllItems(),this.selectionManager?.destroy()}setupBackgroundDeselect(){!this.isBuilderMode||!this.selectionManager||this.selectionManager.setupBackgroundDeselect(()=>this.dragController?.getIsDragging()??!1)}}const ri=[{id:"beggar",name:"Beggar",path:"assets/npcs/humans/beggar.png",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"crusader",name:"Crusader",path:"assets/npcs/humans/crusader.png",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"dealer",name:"Dealer",path:"assets/npcs/humans/dealer.png",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"female_wizard",name:"Female Wizard",path:"assets/npcs/humans/female_wizard.png",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:9,frameRate:8}}},{id:"lady_christmas",name:"Lady Christmas",path:"assets/npcs/humans/lady_christmas.png",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"lady_drunk",name:"Lady Drunk",path:"assets/npcs/humans/lady_drunk.png",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:5,frameRate:8}}},{id:"lovers",name:"Lovers",path:"assets/npcs/humans/lovers.png",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:6,frameRate:8}}},{id:"mage",name:"Mage",path:"assets/npcs/humans/mage.png",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"medieval_servant",name:"Medieval Servant",path:"assets/npcs/humans/medieval_servant.png",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"town_crier",name:"Town Crier",path:"assets/npcs/humans/town_crier.png",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:8,frameRate:8}}},{id:"wounded_knight",name:"Wounded Knight",path:"assets/npcs/humans/wounded_knight.png",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}}];function gs(n){return ri.find(e=>e.id===n)}class oi extends B.Physics.Arcade.Sprite{id;npcId;dialogData;_triggerRadius;selectionIndicator;radiusIndicator;_isSelected=!1;isBuilderMode;_topOffset=0;static DEFAULT_TRIGGER_RADIUS=200;constructor(e,t,s=!1){const i=gs(t.npcId);if(!i)throw new Error(`NPC definition not found for id: ${t.npcId}`);super(e,t.x,t.y,t.npcId),this.id=t.id,this.npcId=t.npcId,this.dialogData=t.dialog,this._triggerRadius=t.triggerRadius??oi.DEFAULT_TRIGGER_RADIUS,this.isBuilderMode=s,e.add.existing(this),e.physics.add.existing(this);const a=t.scale??i.scale;this.setScale(a),this.setFlipX(t.flipX??!1),this._topOffset=(i.topOffset??0)*a,this.setImmovable(!0),this.body.setAllowGravity(!1);const r=i.topOffset??0,o=i.frameHeight-r,c=i.frameWidth*.5,d=o*.9;this.body?.setSize(c,d),this.body?.setOffset((i.frameWidth-c)/2,r+(o-d));const h=i.frameWidth*.5,g=o*.9,f=(i.frameWidth-h)/2,P=r+(o-g);this.setInteractive({hitArea:new B.Geom.Rectangle(f,P,h,g),hitAreaCallback:B.Geom.Rectangle.Contains,cursor:"pointer"}),this.isBuilderMode||(this.setupAnimations(i),this.play(`${this.npcId}_idle`))}setupAnimations(e){if(!e.animations)return;const t=`${this.npcId}_idle`;this.scene.anims.exists(t)||this.scene.anims.create({key:t,frames:this.scene.anims.generateFrameNumbers(this.npcId,{start:e.animations.idle.startFrame,end:e.animations.idle.endFrame}),frameRate:e.animations.idle.frameRate,repeat:-1})}updateDialog(e){this.dialogData=e}getDialogData(){return this.dialogData}getContentHeight(){return this.displayHeight-this._topOffset}get topOffset(){return this._topOffset}get triggerRadius(){return this._triggerRadius}setTriggerRadius(e){this._triggerRadius=e,this.radiusIndicator&&this.radiusIndicator.setRadius(e)}setFlipped(e){this.setFlipX(e)}getHitboxDimensions(){const e=gs(this.npcId);if(!e)return{width:this.displayWidth,height:this.displayHeight,offsetY:0};const t=this.scaleX,s=e.topOffset??0,i=e.frameHeight-s,a=e.frameWidth*.5*t,r=i*.9*t,o=s*t/2;return{width:a,height:r,offsetY:o}}get isSelected(){return this._isSelected}setSelected(e){if(this.scene?.add)if(this._isSelected=e,e){const t=this.getHitboxDimensions();this.selectionIndicator||(this.selectionIndicator=this.scene.add.rectangle(this.x,this.y+t.offsetY,t.width+8,t.height+8,15105570,0),this.selectionIndicator.setStrokeStyle(3,15105570,1),this.selectionIndicator.setDepth(this.depth-1)),this.radiusIndicator||(this.radiusIndicator=this.scene.add.circle(this.x,this.y,this._triggerRadius,15105570,.15),this.radiusIndicator.setStrokeStyle(2,15105570,.5),this.radiusIndicator.setDepth(this.depth-2))}else this.selectionIndicator&&(this.selectionIndicator.destroy(),this.selectionIndicator=void 0),this.radiusIndicator&&(this.radiusIndicator.destroy(),this.radiusIndicator=void 0)}updateSelectionIndicator(){if(this.selectionIndicator&&this._isSelected){const e=this.getHitboxDimensions();this.selectionIndicator.setPosition(this.x,this.y+e.offsetY),this.selectionIndicator.setSize(e.width+8,e.height+8)}this.radiusIndicator&&this._isSelected&&(this.radiusIndicator.setPosition(this.x,this.y),this.radiusIndicator.setRadius(this._triggerRadius))}destroy(e){this.selectionIndicator&&(this.selectionIndicator.destroy(),this.selectionIndicator=void 0),this.radiusIndicator&&(this.radiusIndicator.destroy(),this.radiusIndicator=void 0),super.destroy(e)}}class tr{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set);const s=this.listeners.get(e);return s.add(t),{unsubscribe:()=>{s.delete(t),s.size===0&&this.listeners.delete(e)}}}once(e,t){const s=this.on(e,i=>{s.unsubscribe(),t(i)});return s}emit(e,t){const s=this.listeners.get(e);s&&s.forEach(i=>{try{i(t)}catch(a){console.error(`[EventBus] Error in listener for "${e}":`,a)}})}off(e){this.listeners.delete(e)}clear(){this.listeners.clear()}listenerCount(e){return this.listeners.get(e)?.size??0}}const Ee=new tr,_e={ASSET_DROPPED:"asset:dropped",SOCIAL_DROPPED:"social:dropped",MINIMAP_NAVIGATE:"minimap:navigate",DIALOG_ZONE_CREATE:"dialogZone:create",DIALOG_ZONE_CREATE_AT:"dialogZone:createAt",NPC_DROPPED:"npc:dropped",NPC_SELECTED:"npc:selected",TEMP_ZONE_BUTTON_SHOW:"tempZoneButton:show",TEMP_ZONE_BUTTON_HIDE:"tempZoneButton:hide"};class fs{scene;npcs=new Map;isBuilderMode;groundY;worldWidth;worldHeight;selectedNPCId=null;unsubscribers=[];cleanupFunctions=new Map;doubleClickDetector=new hn;constructor(e,t,s,i,a=!1){if(this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=i,this.isBuilderMode=a,a){const r=St.subscribe(o=>{this.handleSelectionChange(o)});this.unsubscribers.push(r)}}static preloadAssets(e){ri.forEach(t=>{e.load.spritesheet(t.id,t.path,{frameWidth:t.frameWidth,frameHeight:t.frameHeight})})}createNPCs(e){e.forEach(t=>this.createNPC(t))}createNPC(e){const t=new oi(this.scene,e,this.isBuilderMode);this.npcs.set(e.id,t),this.isBuilderMode&&this.makeInteractive(t)}makeInteractive(e){e.setData("npcId",e.id);const t=Ps({sprite:e,scene:this.scene,cursor:"pointer",constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{_s(e.id),Ee.emit(_e.NPC_SELECTED,e.id)},isSelected:()=>Ze(St)===e.id,onDoubleClick:()=>this.doubleClickDetector.check(e.id)?(zi(),!0):!1,onDragStart:()=>{},onDrag:(s,i)=>{e.updateSelectionIndicator()},onDragEnd:(s,i)=>{ii(e.id,{x:Math.round(s),y:Math.round(i)})}}});this.cleanupFunctions.set(e.id,t)}removeNPC(e){const t=this.npcs.get(e);if(t){const s=this.cleanupFunctions.get(e);s&&(s(),this.cleanupFunctions.delete(e)),t.destroy(),this.npcs.delete(e)}}updateNPC(e,t){const s=this.npcs.get(e);s&&(t.x!==void 0&&(s.x=t.x),t.y!==void 0&&(s.y=t.y),t.flipX!==void 0&&s.setFlipped(t.flipX),t.dialog!==void 0&&s.updateDialog(t.dialog),t.scale!==void 0&&s.setScale(t.scale),t.triggerRadius!==void 0&&s.setTriggerRadius(t.triggerRadius))}getNPC(e){return this.npcs.get(e)}getAllNPCs(){return Array.from(this.npcs.values())}handleSelectionChange(e){if(this.selectedNPCId&&this.selectedNPCId!==e){const s=this.npcs.get(this.selectedNPCId);s&&s.setSelected(!1)}const t=e?this.npcs.get(e):null;t?(t.setSelected(!0),this.selectedNPCId=e,this.updateNPCScreenPosition(t)):(this.selectedNPCId=null,ss(null))}updateNPCScreenPosition(e){const t=this.scene.cameras.main,{screenX:s,screenY:i}=vt(e.x,e.y,t),a=e.displayHeight*t.zoom;ss({screenX:s,screenY:i,npcHeight:a})}update(){if(this.selectedNPCId){const e=this.npcs.get(this.selectedNPCId);e&&(e.updateSelectionIndicator(),this.updateNPCScreenPosition(e))}}setInteractiveEnabled(e){if(this.isBuilderMode&&(this.npcs.forEach(t=>{e?(t.setInteractive({cursor:"pointer"}),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectedNPCId)){const t=this.npcs.get(this.selectedNPCId);t&&t.setSelected(!1),this.selectedNPCId=null,ss(null)}}updateAutoDepth(e){this.npcs.forEach(t=>{const s=t.y+t.displayHeight/2,i=ws(s,e);t.setDepth(i)})}destroy(){this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear(),this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.npcs.forEach(e=>e.destroy()),this.npcs.clear(),ss(null)}}function sr(){return`social_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const Vt={S:{label:"Small",scale:1.5},M:{label:"Medium",scale:2},L:{label:"Large",scale:2.5}},Tt=Vt.M.scale;function ir(n){return Vt[n].scale}function nr(n){return n<=Vt.S.scale?"S":n>=Vt.L.scale?"L":"M"}const ps=[{key:"discord",name:"Discord",path:"assets/socials/Discord.png",scale:1},{key:"facebook",name:"Facebook",path:"assets/socials/Facebook.png",scale:1},{key:"instagram",name:"Instagram",path:"assets/socials/Instagram.png",scale:1},{key:"kofi",name:"Ko-Fi",path:"assets/socials/Ko Fi.png",scale:1},{key:"linkedin",name:"LinkedIn",path:"assets/socials/LinkedIn.png",scale:1},{key:"patreon",name:"Patreon",path:"assets/socials/Patreon.png",scale:1},{key:"tiktok",name:"TikTok",path:"assets/socials/TikTok.png",scale:1},{key:"twitch",name:"Twitch",path:"assets/socials/Twitch.png",scale:1},{key:"twitter",name:"Twitter",path:"assets/socials/Twitter.png",scale:1},{key:"whatsapp",name:"WhatsApp",path:"assets/socials/Whatsapp.png",scale:1},{key:"youtube",name:"YouTube",path:"assets/socials/Youtube.png",scale:1}];function ar(){return`zone_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const Us=["#e74c3c","#e67e22","#f1c40f","#2ecc71","#1abc9c","#3498db","#9b59b6","#e91e8f"];function rr(){return Us[Math.floor(Math.random()*Us.length)]}function or(n,e=300){return{id:ar(),x:n,width:e,color:rr(),texts:[{language:"cs",title:"",content:""}]}}function lr(n,e){const t=n.texts.find(s=>s.language===e);return t||n.texts[0]||null}const gn=J(null),cr=Te([gn,zt],([n,e])=>n?lr(n,e):null);function Ls(n){gn.set(n)}const li=J(null),dr=Te([li,zt],([n,e])=>n?n.texts.find(s=>s.language===e)??n.texts[0]??null:null);function as(n){li.set(n)}class wi{scene;socials=new Map;constructor(e){this.scene=e}static preloadAssets(e){ps.forEach(t=>{e.load.image(`social_${t.key}`,t.path)})}createSocials(e){e.forEach(t=>{this.createSocial(t)})}createSocial(e){const t=`social_${e.socialKey}`;if(!this.scene.textures.exists(t)){console.warn(`[GameSocialManager] Social texture not found: ${t}`);return}const s=e.scale??Tt,i=e.depth??Me.ITEMS_FRONT,a=this.scene.add.sprite(e.x,e.y,t);a.setScale(s),a.setDepth(i),a.setOrigin(.5,.5),this.socials.set(e.id,a),e.url&&this.makeClickable(a,e)}makeClickable(e,t){const s=t.scale??Tt;e.setInteractive({useHandCursor:!0}),e.on("pointerover",()=>{e.setScale(s*1.1)}),e.on("pointerout",()=>{e.setScale(s)}),e.on("pointerdown",()=>{t.url&&(Kn(),window.open(t.url,"_blank","noopener,noreferrer"))})}destroy(){this.socials.forEach(e=>{e.destroy()}),this.socials.clear()}}const Fe={GAME:"GameScene",BUILDER:"BuilderScene"};class hr{scene;currentSkinId;constructor(e,t=ln){this.scene=e,this.currentSkinId=t}createAll(){console.log("PlayerAnimations.createAll() is deprecated - animations created by skinLoader")}getSkinId(){return this.currentSkinId}setSkinId(e){this.currentSkinId=e}getAnimationKey(e){return`${this.currentSkinId}-${e}`}play(e,t){const s=this.getAnimationKey(t);if(e.anims.currentAnim?.key!==s){if(!this.scene.anims.exists(s)){if(t==="jump"||t==="fall"){const i=this.getAnimationKey("idle");if(this.scene.anims.exists(i)){e.play(i);return}}console.warn(`[PlayerAnimations] Animation not found: ${s}`);return}e.play(s)}}handleSkinChange(e,t){const s=this.currentSkinId;this.currentSkinId=t;const i=e.anims.currentAnim?.key;if(i){const a=i.replace(`${s}-`,""),r=`${t}-${a}`;if(this.scene.anims.exists(r))e.play(r);else{const o=`${t}-idle`;this.scene.anims.exists(o)&&e.play(o)}}}}const pt={THRESHOLD_X:20,LANGUAGE_BUTTON:{width:120,height:60},SKIN_BUTTON:{width:120,height:60,yOffset:60}},ms={SPEED:350,JUMP_SPEED:-600};class fn{scene;getPlayerPosition;keyLeft;keyRight;keyUp;keySpace;keyA;keyD;keyW;touchLeft=!1;touchRight=!1;touchJump=!1;touchHandlers;constructor(e){this.scene=e.scene,this.getPlayerPosition=e.getPlayerPosition,this.setupKeyboardControls(),this.setupTouchControls()}setupKeyboardControls(){this.scene.input.keyboard&&(this.keyLeft=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.LEFT,!1),this.keyRight=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.RIGHT,!1),this.keyUp=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.UP,!1),this.keySpace=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.SPACE,!1),this.keyA=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.A,!1),this.keyD=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.D,!1),this.keyW=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.W,!1))}setupTouchControls(){const e=this.scene,t=r=>{if(Ze(Ys)){this.touchLeft=!1,this.touchRight=!1,this.touchJump=!1;return}const o=r.x,c=r.y,d=e.scale.width;if(o>d-pt.LANGUAGE_BUTTON.width&&c<pt.LANGUAGE_BUTTON.height||o>d-pt.SKIN_BUTTON.width&&c>=pt.SKIN_BUTTON.yOffset&&c<pt.SKIN_BUTTON.yOffset+pt.SKIN_BUTTON.height)return;const h=e.cameras.main,g=this.getPlayerPosition(),f=g.x-h.scrollX,P=g.y-h.scrollY,I=o-f,D=c-P;I<-20?(this.touchLeft=!0,this.touchRight=!1):I>pt.THRESHOLD_X?(this.touchRight=!0,this.touchLeft=!1):(this.touchLeft=!1,this.touchRight=!1),D<-150?this.touchJump=!0:this.touchJump=!1},s=r=>{bt()||t(r)},i=r=>{bt()||r.isDown&&t(r)},a=()=>{this.touchLeft=!1,this.touchRight=!1,this.touchJump=!1};e.input.on("pointerdown",s),e.input.on("pointermove",i),e.input.on("pointerup",a),this.touchHandlers={pointerdown:s,pointermove:i,pointerup:a}}getInputState(){const e=this.keyA?.isDown||this.keyLeft?.isDown||this.touchLeft||!1,t=this.keyD?.isDown||this.keyRight?.isDown||this.touchRight||!1,s=this.keySpace?.isDown||this.keyUp?.isDown||this.keyW?.isDown||this.touchJump||!1;return{left:e,right:t,jump:s}}hasAnyInput(){const e=this.getInputState();return e.left||e.right||e.jump}destroy(){this.touchHandlers&&(this.scene.input.off("pointerdown",this.touchHandlers.pointerdown),this.scene.input.off("pointermove",this.touchHandlers.pointermove),this.scene.input.off("pointerup",this.touchHandlers.pointerup),this.touchHandlers=void 0)}}class bi extends B.GameObjects.Container{character=null;selection;animState="idle";hasNotifiedMovement=!1;hasReceivedInput=!1;currentFacing="right";inputController;constructor(e,t,s,i){super(e,t,s),this.selection=i,e.add.existing(this),e.physics.add.existing(this);const a=this.body;if(a){a.setCollideWorldBounds(!0),a.setBounce(0);const r=ka();a.setSize(r.width,r.height),a.setOffset(r.offsetX,r.offsetY)}this.inputController=new fn({scene:e,getPlayerPosition:()=>({x:this.x,y:this.y})}),this.setDepth(Gt.DEPTH)}getPosition(){return{x:this.x,y:this.y}}setPlayerPosition(e,t){this.x=e,this.y=t}getGroundY(e,t){return jt(e,t)}getPlayerType(){return"modular"}getHitBounds(){const e=lt.WIDTH,t=lt.HEIGHT;return{x:this.x-e/2,y:this.y-t/2,width:e,height:t}}setFacing(e){this.currentFacing!==e&&(this.currentFacing=e,this.character?.setFacing(e))}setTint(e){this.character?.setTint(e)}clearTint(){this.character?.clearTint()}setAlpha(e){return this.character?.setAlpha(e),this}getGameObject(){return this}static async preloadCharacter(e,t){return Hi(e,t)}buildCharacter(){this.character&&this.character.destroy(),this.character=new Oi(this.scene,0,0,this.selection,{animated:!0,animation:"idle",facing:"right",scale:Xt}),this.add(this.character),this.currentFacing="right"}playAnimation(e){this.character?.playAnimation(e)}update(){const e=this.inputController.getInputState(),t=this.body;if(t)switch(this.inputController.hasAnyInput()&&!this.hasReceivedInput&&(this.hasReceivedInput=!0),this.hasReceivedInput&&this.inputController.hasAnyInput()&&!this.hasNotifiedMovement&&(this.hasNotifiedMovement=!0,Js.set(!0)),e.left?(t.setVelocityX(-350),this.setFacing("left")):e.right?(t.setVelocityX(ms.SPEED),this.setFacing("right")):t.setVelocityX(0),e.jump&&t.blocked.down&&t.setVelocityY(ms.JUMP_SPEED),t.blocked.down?e.left||e.right?this.animState="running":this.animState="idle":t.velocity.y<0?this.animState="jumping":this.animState="falling",this.animState){case"idle":this.playAnimation("idle");break;case"running":this.playAnimation("run");break;case"jumping":this.playAnimation("jump");break;case"falling":this.playAnimation("fall");break}}destroy(e){this.inputController.destroy(),this.character&&(this.character.destroy(),this.character=null),super.destroy(e)}}class ur extends B.Physics.Arcade.Sprite{animations;inputController;animState="idle";hasNotifiedMovement=!1;hasReceivedInput=!1;currentSkin;constructor(e,t,s){const i=yt.getSkinId();super(e,t,s,`${i}-idle`),e.add.existing(this),e.physics.add.existing(this),this.animations=new hr(e,i),this.inputController=new fn({scene:e,getPlayerPosition:()=>({x:this.x,y:this.y})}),this.setCollideWorldBounds(!0),this.setBounce(0),this.currentSkin=Ie.find(d=>d.id===i)??Ie[0];const a=Zt(this.currentSkin),r=this.currentSkin.frameWidth??48,o=this.currentSkin.frameHeight??48,c=Ta(r,o);this.setSize(c.width,c.height),this.setOffset(c.offsetX,c.offsetY),this.setScale(a),this.setDepth(Gt.DEPTH),this.animations.play(this,"idle")}getPosition(){return{x:this.x,y:this.y}}setPlayerPosition(e,t){this.x=e,this.y=t}getGroundY(e,t){return Mt(e,t)}getPlayerType(){return"static"}getHitBounds(){const e=Zt(this.currentSkin),t=(this.currentSkin.frameWidth??48)*e,s=(this.currentSkin.frameHeight??48)*e,i=t*zs.WIDTH,a=(t-i)/2,r=this.originX??.5,o=this.originY??.5,c=this.x-t*r,d=this.y-s*o;return{x:c+a,y:d,width:i,height:s}}setFacing(e){const t=this.currentSkin.facingLeft??!1;e==="left"?this.setFlipX(!t):this.setFlipX(t)}playAnimation(e){(e==="idle"||e==="run"||e==="jump"||e==="fall")&&this.animations.play(this,e)}setTint(e){return super.setTint(e)}clearTint(){return super.clearTint()}setAlpha(e){return super.setAlpha(e)}getGameObject(){return this}changeSkin(e){this.currentSkin=Ie.find(d=>d.id===e)??Ie[0];const t=Zt(this.currentSkin),s=this.currentSkin.frameWidth??48,i=this.currentSkin.frameHeight??48,a=Math.round(s*.33),r=Math.round(i*.25),o=Math.round((s-a)/2),c=Math.round(i*.75);this.setSize(a,r),this.setOffset(o,c),this.setScale(t),this.animations.handleSkinChange(this,e)}update(){const e=this.inputController.getInputState();this.inputController.hasAnyInput()&&!this.hasReceivedInput&&(this.hasReceivedInput=!0),this.hasReceivedInput&&this.inputController.hasAnyInput()&&!this.hasNotifiedMovement&&(this.hasNotifiedMovement=!0,Js.set(!0));const t=this.currentSkin.facingLeft??!1;switch(e.left?(this.setVelocityX(-350),this.setFlipX(!t)):e.right?(this.setVelocityX(ms.SPEED),this.setFlipX(t)):this.setVelocityX(0),e.jump&&this.body?.blocked.down&&this.setVelocityY(ms.JUMP_SPEED),this.body?.blocked.down?e.left||e.right?this.animState="running":this.animState="idle":this.body.velocity.y<0?this.animState="jumping":this.animState="falling",this.animState){case"idle":this.playAnimation("idle");break;case"running":this.playAnimation("run");break;case"jumping":this.playAnimation("jump");break;case"falling":this.playAnimation("fall");break}}destroy(e){this.inputController.destroy(),super.destroy(e)}}const gr=48,fr=48;function pn(n){Ie.forEach(e=>{const t=e.frameWidth??gr,s=e.frameHeight??fr,i=os(e);n.load.spritesheet(`${e.id}-idle`,`${i}/idle.png`,{frameWidth:t,frameHeight:s}),n.load.spritesheet(`${e.id}-run`,`${i}/run.png`,{frameWidth:t,frameHeight:s}),n.load.spritesheet(`${e.id}-jump`,`${i}/jump.png`,{frameWidth:t,frameHeight:s}),n.load.spritesheet(`${e.id}-fall`,`${i}/fall.png`,{frameWidth:t,frameHeight:s})})}function pr(n,e){const t=e.id;n.anims.exists(`${t}-idle`)&&n.anims.remove(`${t}-idle`),n.anims.exists(`${t}-run`)&&n.anims.remove(`${t}-run`),n.anims.exists(`${t}-jump`)&&n.anims.remove(`${t}-jump`),n.anims.exists(`${t}-fall`)&&n.anims.remove(`${t}-fall`);const s=n.textures.get(`${t}-idle`),i=n.textures.get(`${t}-run`),a=n.textures.get(`${t}-jump`),r=n.textures.get(`${t}-fall`),o=s.frameTotal-1,c=i.frameTotal-1,d=a.key!=="__MISSING"?a.frameTotal-1:0,h=r.key!=="__MISSING"?r.frameTotal-1:0,g=e.frameRates?.idle??6,f=e.frameRates?.run??12,P=e.frameRates?.jump??10,I=e.frameRates?.fall??10;n.anims.create({key:`${t}-idle`,frames:n.anims.generateFrameNumbers(`${t}-idle`,{start:0,end:o-1}),frameRate:g,repeat:-1}),n.anims.create({key:`${t}-run`,frames:n.anims.generateFrameNumbers(`${t}-run`,{start:0,end:c-1}),frameRate:f,repeat:-1}),d>0&&n.anims.create({key:`${t}-jump`,frames:n.anims.generateFrameNumbers(`${t}-jump`,{start:0,end:d-1}),frameRate:P,repeat:-1}),h>0&&n.anims.create({key:`${t}-fall`,frames:n.anims.generateFrameNumbers(`${t}-fall`,{start:0,end:h-1}),frameRate:I,repeat:-1})}function mn(n){Ie.forEach(e=>{pr(n,e)})}const It={HEIGHT:We,VISUAL:{COLOR:9139029,ALPHA:.3},PHYSICS:{COLOR:0,ALPHA:0}},At={getGroundY(n,e=We){return n-e},createVisualGround(n,e){const t=e.height??It.HEIGHT,s=At.getGroundY(e.worldHeight,t),i=n.add.rectangle(0,s,e.worldWidth,t,e.color??It.VISUAL.COLOR,e.alpha??It.VISUAL.ALPHA);return i.setOrigin(0,0),i.setDepth(e.depth??Me.GROUND_REFERENCE),{ground:i,groundY:s}},createPhysicsGround(n,e){const t=e.height??It.HEIGHT,s=At.getGroundY(e.worldHeight,t),i=n.add.rectangle(0,s,e.worldWidth,t,e.color??It.PHYSICS.COLOR,e.alpha??It.PHYSICS.ALPHA);return i.setOrigin(0,0),n.physics.add.existing(i,!0),{ground:i,groundY:s}},addPlayerCollision(n,e,t){return n.physics.add.collider(e,t)}};class mr{scene;player=null;useModularPlayer=!1;savedCharacterSelection=null;constructor(e){this.scene=e}init(){const e=localStorage.getItem("useModularPlayer");this.savedCharacterSelection=js(),this.useModularPlayer=e==="true"&&this.savedCharacterSelection!==null}preload(){this.useModularPlayer||pn(this.scene)}async loadAssets(){this.useModularPlayer||mn(this.scene),this.useModularPlayer&&this.savedCharacterSelection&&await bi.preloadCharacter(this.scene,this.savedCharacterSelection)}createPlayer(e,t,s){if(this.useModularPlayer&&this.savedCharacterSelection){const i=jt(e.worldHeight,s),a=Math.min(e.playerStartY,i),r=new bi(this.scene,e.playerStartX,a,this.savedCharacterSelection);r.buildCharacter(),this.player=r,At.addPlayerCollision(this.scene,r,t)}else{const i=Mt(e.worldHeight,s),a=Math.min(e.playerStartY,i),r=new ur(this.scene,e.playerStartX,a);this.player=r,At.addPlayerCollision(this.scene,r,t)}return this.player}getPlayer(){return this.player}isModular(){return this.useModularPlayer}}async function _i(){const n=await fetch("./config/map.json");if(!n.ok)throw new Error(`Failed to load map config: ${n.status}`);const e=await n.json();if(!e.worldWidth||!e.worldHeight)throw new Error("Invalid map config structure");return e}const ls={generateId(){return`item_${Date.now()}_${Math.random().toString(36).substr(2,9)}`},create(n){const{assetKey:e,x:t,yOffset:s=0,depthLayer:i="behind",scale:a}=n;return{id:ls.generateId(),assetKey:e,x:Math.round(t),y:0,scale:a??_a(e),depth:Yi(i),yOffset:Math.round(s)}},createAtWorldPosition(n,e,t,s,i="behind"){return ls.create({assetKey:n,x:e,yOffset:t-s,depthLayer:i})},clone(n,e=50){return{...n,id:ls.generateId(),x:n.x+e}}},Ue=[{name:"FOREST SUMMER",folder:"forest_summer",scrollFactors:[.9,.95,.975,1,1.05],foregroundLayers:1,groundHeight:90,itemGroups:["shared","forest_summer","forest_shared"]},{name:"FOREST BIRCH",folder:"forest_birch",scrollFactors:[.9,.95,.975,1,1.05],foregroundLayers:1,groundHeight:30,itemGroups:["shared","forest_birch","forest_shared"]},{name:"CAVE DARK",folder:"cave_dark",scrollFactors:[.85,.875,.9,.925,.95,.975,1.05],foregroundLayers:2,groundHeight:20,itemGroups:["shared","cave_dark"]}];class vr{currentIndex=0;constructor(){const e=localStorage.getItem("background");if(e){const t=Ue.findIndex(s=>s.folder===e);t!==-1&&(this.currentIndex=t)}}getBackground(){return Ue[this.currentIndex].folder}getCurrentConfig(){return Ue[this.currentIndex]}setBackground(e){const t=Ue.findIndex(s=>s.folder===e);t!==-1&&(this.currentIndex=t,localStorage.setItem("background",e))}toggleBackground(){this.currentIndex=(this.currentIndex+1)%Ue.length;const e=Ue[this.currentIndex];return localStorage.setItem("background",e.folder),e}getAllBackgrounds(){return Ue}setBackgroundByIndex(e){e>=0&&e<Ue.length&&(this.currentIndex=e,localStorage.setItem("background",Ue[e].folder))}getCurrentIndex(){return this.currentIndex}}const Ke=new vr;function vn(n,e){return new Promise(t=>{for(let s=0;s<e.scrollFactors.length;s++){const i=s+1;n.load.image(`bg${i}-${e.folder}`,`assets/backgrounds/${e.folder}/${i}.png`)}n.load.once("complete",()=>{t(!0)}),n.load.once("loaderror",s=>{console.error(`Failed to load background asset: ${s.key}`),t(!1)}),n.load.start()})}function yn(n,e,t,s){const i=[],a=[],r=s.foregroundLayers??0,c=s.scrollFactors.length-r;for(let d=0;d<s.scrollFactors.length;d++){const g=`bg${d+1}-${s.folder}`,f=s.scrollFactors[d];if(n.textures.exists(g)){const P=n.textures.getFrame(g),I=P.width,D=P.height,_=t/D,y=I*_,S=e*3,u=Math.ceil(S/y)*I+I,p=n.add.tileSprite(0,0,u,D,g);p.setOrigin(0,0),p.setScale(_),p.setScrollFactor(1),p.setData("scrollFactor",f),p.setData("scale",_),d>=c?(p.setDepth(Me.FOREGROUND_LAYER_START+(d-c)),a.push(p)):(p.setDepth(Me.BACKGROUND_LAYER_START+d),i.push(p))}}return{bgLayers:i,fgLayers:a}}function Sn(n,e){if(!n)return;const t=e.width/e.zoom,s=e.getBounds().width,i=Math.max(0,s-t),a=Math.max(0,Math.min(e.scrollX,i)),r=[...n.bgLayers,...n.fgLayers];for(const o of r){const c=o.getData("scrollFactor"),d=o.getData("scale");o.tilePositionX=a*(1-c)/d}}function yr(n){n.bgLayers.forEach(e=>e.destroy()),n.fgLayers.forEach(e=>e.destroy())}class Sr{scene;mapConfig;parallaxLayers=null;loadedBackgrounds=new Set;ground=null;groundY=0;constructor(e){this.scene=e}async loadMapConfiguration(e=!1){try{if(e){const t=Qn();this.mapConfig=t||await _i()}else this.mapConfig=await _i()}catch(t){console.error("[MapManager] Failed to load map configuration:",t);const s=600;this.mapConfig={worldWidth:3200,worldHeight:s,playerStartX:400,playerStartY:Mt(s),placedItems:[]}}return this.mapConfig}async setupBackground(){const e=Ke.getCurrentConfig();this.loadedBackgrounds.has(e.folder)||await vn(this.scene,e)&&this.loadedBackgrounds.add(e.folder),this.parallaxLayers=yn(this.scene,this.mapConfig.worldWidth,this.mapConfig.worldHeight,e)}createGround(){const t=Ke.getCurrentConfig().groundHeight??40,s=At.createPhysicsGround(this.scene,{worldWidth:this.mapConfig.worldWidth,worldHeight:this.mapConfig.worldHeight,height:t});return this.ground=s.ground,this.groundY=s.groundY,this.scene.physics.world.setBounds(0,0,this.mapConfig.worldWidth,this.mapConfig.worldHeight),{...s,groundHeight:t}}update(e){this.parallaxLayers&&Sn(this.parallaxLayers,e)}getConfig(){return this.mapConfig}getGround(){return this.ground}getGroundY(){return this.groundY}}class wr extends B.Scene{playerManager;mapManager;player=null;getMapConfig(){return this.mapManager?.getConfig()||null}itemManager;npcManager;socialManager;dialogZones=[];currentDialogZone=null;currentNPCId=null;NPC_PROXIMITY_THRESHOLD=200;unsubscribers=[];initData;isInitialized=!1;constructor(){super({key:Fe.GAME})}init(e){this.initData=e,this.isInitialized=!1,this.playerManager=new mr(this),this.mapManager=new Sr(this),this.playerManager.init()}preload(){this.playerManager.preload(),us.preloadAssets(this),fs.preloadAssets(this),wi.preloadAssets(this)}create(){this.events.on("shutdown",this.shutdown,this),this.initializeScene()}async initializeScene(){Gs.set(!0);try{await this.playerManager.loadAssets();const e=await this.mapManager.loadMapConfiguration(this.initData?.useBuilderConfig);await this.mapManager.setupBackground();const{ground:t,groundY:s,groundHeight:i}=this.mapManager.createGround();this.player=this.playerManager.createPlayer(e,t,i),this.itemManager=new us(this,s,e.worldWidth,e.worldHeight,!1),e.placedItems&&e.placedItems.length>0&&this.itemManager.createItems(e.placedItems);const a=this.itemManager.getPhysicsGroup();a&&this.player&&this.physics.add.collider(this.player.getGameObject(),a),this.socialManager=new wi(this),e.placedSocials&&e.placedSocials.length>0&&this.socialManager.createSocials(e.placedSocials),this.npcManager=new fs(this,s,e.worldWidth,e.worldHeight,!1),e.placedNPCs&&e.placedNPCs.length>0&&this.npcManager.createNPCs(e.placedNPCs),this.dialogZones=e.dialogZones||[];const r=ti.subscribe(o=>{this.dialogZones=o,this.recheckCurrentZone()});this.unsubscribers.push(r),this.player&&this.cameras.main.startFollow(this.player.getGameObject(),!0,.1,.1),this.setupCameraBounds(),this.scale.on("resize",this.handleResize,this),this.isInitialized=!0}catch(e){console.error("[GameScene] Failed to initialize scene:",e)}finally{Gs.set(!1)}}setupCameraBounds(){const e=this.mapManager.getConfig();if(!e)return;const t=this.cameras.main,s=t.height,i=t.width,a=s/e.worldHeight,r=Math.min(1,a);t.setZoom(r);const o=s/r,c=i/r;let d=0,h=e.worldHeight;o>e.worldHeight&&(d=(e.worldHeight-o)/2,h=o);let g=0,f=e.worldWidth;c>e.worldWidth&&(g=(e.worldWidth-c)/2,f=c),t.setBounds(g,d,f,h),Fn(e.worldWidth,e.worldHeight,i,s,r)}handleResize(e){!this.cameras?.main||!this.mapManager||this.setupCameraBounds()}shutdown(){this.isInitialized=!1,this.scale.off("resize",this.handleResize,this),Ls(null),as(null),this.currentDialogZone=null,this.currentNPCId=null,this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.itemManager&&this.itemManager.destroy(),this.socialManager&&this.socialManager.destroy()}update(){if(!this.isInitialized||!this.player)return;this.player.update();const{x:e,y:t}=this.player.getPosition(),s=this.mapManager.getConfig()?.worldHeight??640,i=this.player.getGameObject(),r=i.getBounds().bottom,o=ws(r,s);i.setDepth(o),this.itemManager&&this.itemManager.updateAutoDepth(s),this.npcManager&&this.npcManager.updateAutoDepth(s);const c=this.cameras.main,d=e-c.scrollX,h=t-c.scrollY;Bn(d,h),Gn(c.scrollX,c.scrollY,c.zoom),this.checkDialogZonesForPosition(e),this.checkNPCProximity(e,t,c),this.mapManager&&this.mapManager.update(this.cameras.main)}checkDialogZonesForPosition(e){let t=null;for(const s of this.dialogZones)if(e>=s.x&&e<=s.x+s.width){t=s;break}t?.id!==this.currentDialogZone?.id&&(this.currentDialogZone=t,Ls(t))}recheckCurrentZone(){if(!this.currentDialogZone)return;const e=this.dialogZones.find(t=>t.id===this.currentDialogZone?.id);e&&(this.currentDialogZone=e,Ls(e))}checkNPCProximity(e,t,s){if(!this.npcManager)return;const i=this.npcManager.getAllNPCs();let a=null;for(const r of i){const o=r.getDialogData?.()??[];if(!o||o.length===0||!o.some(P=>P.content&&P.content.trim().length>0))continue;const d=r.x-e,h=r.y-t,g=Math.sqrt(d*d+h*h),f=r.triggerRadius??this.NPC_PROXIMITY_THRESHOLD;g<=f&&(!a||g<a.distance)&&(a={id:r.id,distance:g,npc:r})}if(a){const r=a.npc,o=r.x-s.scrollX,c=r.y-s.scrollY,d=r.getContentHeight(),h=c+r.topOffset/2;this.currentNPCId!==a.id?(this.currentNPCId=a.id,as({npcId:a.id,texts:r.getDialogData()??[],screenX:o,screenY:h,npcHeight:d})):as({npcId:a.id,texts:r.getDialogData()??[],screenX:o,screenY:h,npcHeight:d})}else this.currentNPCId&&(this.currentNPCId=null,as(null))}}const Rs=1,Ii=.001,br=.15,Ci=400;class _r{scene;camera;worldWidth;worldHeight;isPanning=!1;panStartX=0;panStartY=0;cameraDragStartX=0;cameraDragStartY=0;isDraggingToScroll=!1;dragScrollStartX=0;dragScrollStartY=0;dragScrollCameraStartX=0;dragScrollCameraStartY=0;currentZoom=1;targetZoom=1;minZoom=.1;isAnimatingReset=!1;zoomTargetWorldPoint=null;pinchStartDistance=0;pinchStartZoom=1;activeTouches=new Map;pinchEndTime=0;isPinching=!1;PINCH_COOLDOWN=150;touchStartTime=0;touchStartPos=null;touchOnSelectedSprite=!1;TAP_MAX_DURATION=200;TAP_MAX_DISTANCE=10;constructor(e,t,s){this.scene=e,this.camera=e.cameras.main,this.worldWidth=t,this.worldHeight=s}setup(){this.calculateMinZoom(),this.setupCamera(),this.setupMouseControls(),this.setupKeyboardControls(),this.setupUpdateLoop()}calculateMinZoom(){const e=this.camera.width/this.worldWidth,t=this.camera.height/this.worldHeight;this.minZoom=Math.min(e,t)}setupCamera(){this.currentZoom=this.minZoom,this.targetZoom=this.minZoom,this.camera.setZoom(this.minZoom);const e=this.camera.width/this.minZoom,t=this.camera.height/this.minZoom,s=Math.min(0,(this.worldWidth-e)/2),i=Math.min(0,(this.worldHeight-t)/2),a=Math.max(this.worldWidth,e),r=Math.max(this.worldHeight,t);this.camera.setBounds(s,i,a,r),this.camera.centerOn(this.worldWidth/2,this.worldHeight/2),es(this.minZoom)}centerOn(e,t){this.camera.centerOn(e,t),this.clampScroll()}handleResize(){this.calculateMinZoom(),this.currentZoom<this.minZoom&&(this.currentZoom=this.minZoom,this.targetZoom=this.minZoom,this.camera.setZoom(this.minZoom)),this.targetZoom<this.minZoom&&(this.targetZoom=this.minZoom),this.updateCameraBounds(),this.clampScroll(),es(this.currentZoom)}updateCameraBounds(){const e=this.camera.width/this.currentZoom,t=this.camera.height/this.currentZoom,s=Math.min(0,(this.worldWidth-e)/2),i=Math.min(0,(this.worldHeight-t)/2),a=Math.max(this.worldWidth,e),r=Math.max(this.worldHeight,t);this.camera.setBounds(s,i,a,r)}getScrollBounds(e=!0){const t=this.camera.width/this.currentZoom,s=this.camera.height/this.currentZoom;let i,a,r,o;return t>this.worldWidth?e?i=a=(this.worldWidth-t)/2:(i=this.worldWidth-t,a=0):(i=0,a=this.worldWidth-t),s>this.worldHeight?e?r=o=(this.worldHeight-s)/2:(r=this.worldHeight-s,o=0):(r=0,o=this.worldHeight-s),{minX:i,maxX:a,minY:r,maxY:o}}clampScroll(){const e=this.getScrollBounds(!0);this.camera.scrollX=B.Math.Clamp(this.camera.scrollX,e.minX,e.maxX),this.camera.scrollY=B.Math.Clamp(this.camera.scrollY,e.minY,e.maxY)}softClampScroll(){const e=this.getScrollBounds(!1);this.camera.scrollX=B.Math.Clamp(this.camera.scrollX,e.minX,e.maxX),this.camera.scrollY=B.Math.Clamp(this.camera.scrollY,e.minY,e.maxY)}applyPanDelta(e,t,s,i,a,r){const o=this.getScrollBounds(),c=(e-s)/this.currentZoom,d=(t-i)/this.currentZoom;this.camera.scrollX=B.Math.Clamp(a-c,o.minX,o.maxX),this.camera.scrollY=B.Math.Clamp(r-d,o.minY,o.maxY)}zoomToPoint(e,t,s){const i=this.camera.getWorldPoint(e,t);this.zoomToWorldPoint(i.x,i.y,s)}zoomToWorldPoint(e,t,s){const i=this.camera.scrollX,a=this.camera.scrollY,r=this.currentZoom;this.currentZoom=s,this.camera.setZoom(s),this.updateCameraBounds(),this.camera.scrollX=e-(e-i)*r/s,this.camera.scrollY=t-(t-a)*r/s,this.softClampScroll(),es(this.currentZoom)}setupMouseControls(){this.scene.input.on("wheel",(e,t,s,i,a)=>{if(this.isAnimatingReset)return;if((e.event.ctrlKey||Math.abs(s)<5&&Math.abs(i)>0)&&!e.event.ctrlKey){const o=-i*Ii*3;this.targetZoom=B.Math.Clamp(this.targetZoom+o,this.minZoom,Rs);const c=this.camera.getWorldPoint(e.x,e.y);this.zoomTargetWorldPoint={x:c.x,y:c.y}}else if(e.event.ctrlKey){const o=-i*Ii,c=B.Math.Clamp(this.currentZoom+o,this.minZoom,Rs);this.targetZoom=c,this.zoomToPoint(e.x,e.y,c)}else{const o=this.getScrollBounds();this.camera.scrollX=B.Math.Clamp(this.camera.scrollX+s/this.currentZoom,o.minX,o.maxX),this.camera.scrollY=B.Math.Clamp(this.camera.scrollY+i/this.currentZoom,o.minY,o.maxY)}}),this.scene.input.on("pointerdown",e=>{if(e.wasTouch){if(this.activeTouches.set(e.id,{x:e.x,y:e.y}),this.activeTouches.size===2){this.isPinching=!0,this.startPinch(),this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.scene.data.set("touchDraggingSprite",!1);return}this.activeTouches.size===1&&!this.isPinching&&(this.touchStartTime=Date.now(),this.touchStartPos={x:e.x,y:e.y},this.dragScrollStartX=e.x,this.dragScrollStartY=e.y,this.dragScrollCameraStartX=this.camera.scrollX,this.dragScrollCameraStartY=this.camera.scrollY,this.touchOnSelectedSprite=Ja(this.scene,e),this.scene.data.set("touchDraggingSprite",!1),this.scene.data.set("touchStartOnSelectedSprite",this.touchOnSelectedSprite),this.scene.data.set("touchStartWorldX",e.worldX),this.scene.data.set("touchStartWorldY",e.worldY));return}bt()||fi()||this.isAnimatingReset||(e.rightButtonDown()||e.middleButtonDown()?(this.isPanning=!0,this.panStartX=e.x,this.panStartY=e.y,this.cameraDragStartX=this.camera.scrollX,this.cameraDragStartY=this.camera.scrollY):e.leftButtonDown()&&!this.isDraggingObject()&&(this.scene.data.get("isDraggingItem")===!0||(this.dragScrollStartX=e.x,this.dragScrollStartY=e.y,this.dragScrollCameraStartX=this.camera.scrollX,this.dragScrollCameraStartY=this.camera.scrollY)))}),this.scene.input.on("pointermove",e=>{if(e.wasTouch){if(this.activeTouches.has(e.id)&&this.activeTouches.set(e.id,{x:e.x,y:e.y}),this.activeTouches.size>=2&&this.isPinching){this.handlePinch();return}if(this.isPinching||Date.now()-this.pinchEndTime<this.PINCH_COOLDOWN||this.scene.data.get("touchDraggingSprite"))return;if(this.touchStartPos&&!this.isDraggingToScroll){const t=Math.abs(e.x-this.touchStartPos.x),s=Math.abs(e.y-this.touchStartPos.y);if(Math.sqrt(t*t+s*s)>this.TAP_MAX_DISTANCE){if(this.touchOnSelectedSprite){this.scene.data.set("touchDragStarted",!0),this.scene.data.set("touchDraggingSprite",!0),this.touchStartPos=null;return}!bt()&&!this.isDraggingObject()&&!this.scene.data.get("isDraggingItem")&&(this.isDraggingToScroll=!0,this.touchStartPos=null)}}this.isDraggingToScroll&&this.applyPanDelta(e.x,e.y,this.dragScrollStartX,this.dragScrollStartY,this.dragScrollCameraStartX,this.dragScrollCameraStartY);return}if(!(fi()||this.isAnimatingReset)){if(this.isPanning)this.applyPanDelta(e.x,e.y,this.panStartX,this.panStartY,this.cameraDragStartX,this.cameraDragStartY);else if(e.leftButtonDown()&&!this.isDraggingToScroll&&!this.isDraggingObject()&&!(this.scene.data.get("isDraggingItem")===!0)){const s=Math.abs(e.x-this.dragScrollStartX),i=Math.abs(e.y-this.dragScrollStartY);Math.sqrt(s*s+i*i)>10&&(this.isDraggingToScroll=!0,this.scene.input.setDefaultCursor("grabbing"))}this.isDraggingToScroll&&this.applyPanDelta(e.x,e.y,this.dragScrollStartX,this.dragScrollStartY,this.dragScrollCameraStartX,this.dragScrollCameraStartY)}}),this.scene.input.on("pointerup",e=>{if(e.wasTouch){if(this.isPinching&&(this.pinchEndTime=Date.now(),this.isPinching=!1,ks(!1)),this.touchStartPos&&!this.isDraggingToScroll){const t=Date.now()-this.touchStartTime,s=Math.abs(e.x-this.touchStartPos.x),i=Math.abs(e.y-this.touchStartPos.y),a=Math.sqrt(s*s+i*i);t<this.TAP_MAX_DURATION&&a<this.TAP_MAX_DISTANCE&&(this.scene.data.set("lastTapTime",Date.now()),this.scene.data.set("lastTapWorldX",e.worldX),this.scene.data.set("lastTapWorldY",e.worldY))}this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.activeTouches.delete(e.id),this.scene.data.set("touchDraggingSprite",!1),this.scene.data.set("touchDragStarted",!1),this.scene.data.set("touchStartOnSelectedSprite",!1),this.isDraggingToScroll&&(this.isDraggingToScroll=!1);return}!e.rightButtonDown()&&!e.middleButtonDown()&&(this.isPanning=!1),this.isDraggingToScroll&&(this.isDraggingToScroll=!1,this.scene.input.setDefaultCursor("default"))}),this.scene.input.on("pointerout",e=>{e.wasTouch&&(this.activeTouches.delete(e.id),this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.isPinching&&this.activeTouches.size<2&&(this.isPinching=!1,this.pinchEndTime=Date.now(),ks(!1)))})}startPinch(){const e=Array.from(this.activeTouches.values());if(e.length!==2)return;const[t,s]=e;this.pinchStartDistance=Math.hypot(s.x-t.x,s.y-t.y),this.pinchStartZoom=this.currentZoom,ks(!0)}handlePinch(){const e=Array.from(this.activeTouches.values());if(e.length!==2)return;const[t,s]=e,i=Math.hypot(s.x-t.x,s.y-t.y),a=(t.x+s.x)/2,r=(t.y+s.y)/2,o=i/this.pinchStartDistance,c=B.Math.Clamp(this.pinchStartZoom*o,this.minZoom,Rs);this.targetZoom=c,this.zoomToPoint(a,r,c)}setupKeyboardControls(){const e={up:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.UP,!1),down:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.DOWN,!1),left:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.LEFT,!1),right:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.RIGHT,!1)},t={w:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.W,!1),a:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.A,!1),s:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.S,!1),d:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.D,!1)};this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.SPACE,!1).on("down",()=>{Bt()||this.centerOnPlayer()}),this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.F,!1).on("down",()=>{Bt()||this.resetToFit()}),this.scene.data.set("cameraArrowKeys",e),this.scene.data.set("cameraWasdKeys",t)}setupUpdateLoop(){const e=this.scene.data.get("cameraArrowKeys"),t=this.scene.data.get("cameraWasdKeys");this.scene.events.on("update",()=>{if(!this.isAnimatingReset&&Math.abs(this.currentZoom-this.targetZoom)>1e-4){const a=B.Math.Linear(this.currentZoom,this.targetZoom,br);this.zoomTargetWorldPoint?this.zoomToWorldPoint(this.zoomTargetWorldPoint.x,this.zoomTargetWorldPoint.y,a):this.zoomToPoint(this.camera.width/2,this.camera.height/2,a),Math.abs(this.currentZoom-this.targetZoom)<.001&&(this.zoomTargetWorldPoint=null)}if(Bt()||this.isAnimatingReset)return;const s=10/this.currentZoom,i=this.getScrollBounds();e?.left?.isDown||t?.a?.isDown?this.camera.scrollX=B.Math.Clamp(this.camera.scrollX-s,i.minX,i.maxX):(e?.right?.isDown||t?.d?.isDown)&&(this.camera.scrollX=B.Math.Clamp(this.camera.scrollX+s,i.minX,i.maxX)),e?.up?.isDown||t?.w?.isDown?this.camera.scrollY=B.Math.Clamp(this.camera.scrollY-s,i.minY,i.maxY):(e?.down?.isDown||t?.s?.isDown)&&(this.camera.scrollY=B.Math.Clamp(this.camera.scrollY+s,i.minY,i.maxY))})}centerOnPlayer(){const e=this.scene.data.get("playerSprite");e&&(this.camera.centerOn(e.x,e.y),this.clampScroll())}isDraggingObject(){return this.scene.data.get("isDraggingObject")===!0||this.scene.data.get("isDraggingItem")===!0}resetToFit(){if(this.isAnimatingReset)return;this.isAnimatingReset=!0,this.targetZoom=this.minZoom;const e=this.camera.width/this.minZoom,t=this.camera.height/this.minZoom,s=(this.worldWidth-e)/2,i=(this.worldHeight-t)/2,a=s+e/2,r=i+t/2;this.camera.pan(a,r,Ci,"Sine.easeInOut"),this.camera.zoomTo(this.minZoom,Ci,"Sine.easeInOut",!1,(o,c)=>{c===1&&(this.currentZoom=this.minZoom,this.camera.scrollX=s,this.camera.scrollY=i,this.isAnimatingReset=!1,es(this.minZoom))})}destroy(){this.activeTouches.clear()}}class Ir{scene;player;modularCharacter=null;worldWidth;worldHeight;unsubscribers=[];interactionCleanup=null;useModular=!1;modularSelection=null;debugGraphics=null;isSelected=!1;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s;const i=localStorage.getItem("useModularPlayer");this.modularSelection=js(),this.useModular=i==="true"&&this.modularSelection!==null}async preload(){!this.useModular||!this.modularSelection||await Hi(this.scene,this.modularSelection)}create(e,t){const s=Ke.getCurrentConfig().groundHeight??We;if(this.useModular&&this.modularSelection){const i=jt(this.worldHeight,s),a=Math.min(t,i);return this.createModularPlayer(e,a)}else{const i=Math.min(t,Mt(this.worldHeight,s));return this.createStaticPlayer(e,i)}}createStaticPlayer(e,t){const s=yt.getSkinId(),i=Ie.find(o=>o.id===s)??Ie[0],a=Zt(i),r=this.scene.add.sprite(e,t,`${s}-idle`,0);return r.setScale(a),r.setDepth(Gt.DEPTH),r.setData("isPlayer",!0),this.player=r,this.scene.data.set("playerSprite",this.player),this.setupInteraction(),this.setupEditModeSubscription(),this.setupSelectionSubscription(),r}createModularPlayer(e,t){this.modularCharacter=new Oi(this.scene,e,t,this.modularSelection,{animated:!1,facing:"right",scale:Xt});const s=this.modularCharacter;return s.setDepth(Gt.DEPTH),s.setData("isPlayer",!0),this.player=s,this.scene.data.set("playerSprite",this.player),this.setupInteraction(),this.setupEditModeSubscription(),this.setupSelectionSubscription(),s}setupInteraction(){let e;if(this.useModular&&this.modularCharacter)e=new B.Geom.Rectangle(-80/2,-64/2,lt.FRAME_WIDTH,lt.FRAME_HEIGHT),this.scene.data.set("modularPlayerHitArea",e);else{const t=yt.getSkinId(),s=Ie.find(c=>c.id===t)??Ie[0],i=s.frameWidth??48,a=s.frameHeight??48,r=i*zs.WIDTH,o=(i-r)/2;e=new B.Geom.Rectangle(o,0,r,a)}this.interactionCleanup=Ps({sprite:this.player,scene:this.scene,useGridSnapping:!1,cursor:"grab",hitArea:e,constraints:{minX:vi,maxX:this.worldWidth-vi,minY:Xa},callbacks:{onSelect:()=>{pa(!0)},isSelected:()=>Ze(ui),onDragStart:()=>{this.scene.data.set("isDraggingObject",!0)},onDrag:(t,s)=>{gi(Math.round(t),Math.round(s)),this.updateDebugVisualization()},onDragEnd:(t,s)=>{this.scene.data.set("isDraggingObject",!1);let i=this.player.y;const a=Ke.getCurrentConfig().groundHeight??We;this.useModular?xa(this.player.y,this.worldHeight,a)&&(i=jt(this.worldHeight,a),this.player.setY(i)):Ea(this.player.y,this.worldHeight,a)&&(i=Mt(this.worldHeight,a),this.player.setY(i)),gi(Math.round(this.player.x),Math.round(i)),this.updateDebugVisualization()}}}),yi&&this.createDebugVisualization()}createDebugVisualization(){this.debugGraphics&&this.debugGraphics.destroy(),this.debugGraphics=this.scene.add.graphics(),this.debugGraphics.setDepth(Gt.DEPTH+1),this.updateDebugVisualization()}updateDebugVisualization(){if(!this.debugGraphics||!yi)return;this.debugGraphics.clear();const e=this.isSelected?Fa:Ba,t=this.isSelected?Ka:Za,s=this.isSelected?za:Ga;let i=null;if(this.useModular&&this.modularCharacter){const a=this.player,r=this.scene.data.get("modularPlayerHitArea");if(r&&a.input){const o=a.scaleX;i={x:a.x+r.x*o,y:a.y+r.y*o,width:r.width*o,height:r.height*o}}}else{const a=this.player,r=yt.getSkinId(),o=Ie.find(D=>D.id===r)??Ie[0],c=Zt(o),d=(o.frameWidth??48)*c,h=(o.frameHeight??48)*c,g=d*zs.WIDTH,f=(d-g)/2,P=a.originX??.5,I=a.originY??.5;i={x:a.x-d*P+f,y:a.y-h*I,width:g,height:h}}i&&(this.debugGraphics.fillStyle(Si,e),this.debugGraphics.fillRect(i.x,i.y,i.width,i.height),this.debugGraphics.lineStyle(t,Si,s),this.debugGraphics.strokeRect(i.x,i.y,i.width,i.height))}setupSelectionSubscription(){const e=ui.subscribe(t=>{this.isSelected=t,this.updateDebugVisualization(),this.scene.data.set("isPlayerSelected",t)});this.unsubscribers.push(e)}setupEditModeSubscription(){const e=He.subscribe(t=>{t==="dialogs"?(this.interactionCleanup&&(this.interactionCleanup(),this.interactionCleanup=null),this.player.disableInteractive(),this.setAlpha(.6)):(this.setAlpha(1),this.interactionCleanup||this.setupInteraction())});this.unsubscribers.push(e)}setAlpha(e){this.modularCharacter?this.modularCharacter.setAlpha(e):this.player.setAlpha(e)}getSprite(){return this.player}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.interactionCleanup&&(this.interactionCleanup(),this.interactionCleanup=null),this.debugGraphics&&(this.debugGraphics.destroy(),this.debugGraphics=null),this.modularCharacter?(this.modularCharacter.destroy(),this.modularCharacter=null):this.player&&this.player.destroy()}}class Cr{scene;graphics;worldWidth;worldHeight;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}create(){return this.graphics=this.scene.add.graphics(),this.graphics.setDepth(dn),this.draw(),this.graphics}draw(){this.graphics.clear(),this.graphics.lineStyle($a,Ma,Aa);const e=Math.max(this.worldHeight,this.scene.scale.height);for(let i=0;i<=this.worldWidth;i+=Et)this.graphics.beginPath(),this.graphics.moveTo(i,0),this.graphics.lineTo(i,e),this.graphics.strokePath();for(let i=0;i<=e;i+=Et)this.graphics.beginPath(),this.graphics.moveTo(0,i),this.graphics.lineTo(this.worldWidth,i),this.graphics.strokePath();const t=Ke.getCurrentConfig().groundHeight??We,s=this.worldHeight-t;this.graphics.lineStyle(Ha,Os,Oa),this.graphics.beginPath(),this.graphics.moveTo(0,s),this.graphics.lineTo(this.worldWidth,s),this.graphics.strokePath(),this.graphics.lineStyle(Ra,Os,Na),this.graphics.fillStyle(Os,La),this.graphics.fillRect(0,s,this.worldWidth,e-s)}getGraphics(){return this.graphics}redraw(){this.draw()}destroy(){this.graphics&&this.graphics.destroy()}}class Pr{scene;groundY;worldWidth;worldHeight;itemManager;unsubscribers=[];constructor(e,t,s,i){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=i}create(e){return this.itemManager=new us(this.scene,this.groundY,this.worldWidth,this.worldHeight,!0),e&&e.length>0&&this.itemManager.createItems(e),this.setupBackgroundDeselect(),this.setupStoreSubscriptions(),this.setupAssetDropListener(),this.setupDeleteKeys(),this.itemManager}setupBackgroundDeselect(){this.itemManager.setupBackgroundDeselect()}setupStoreSubscriptions(){const e=St.subscribe(a=>{this.scene.data.set("selectedItemId",a),this.itemManager.updateSelectionVisuals()});this.unsubscribers.push(e);const t=He.subscribe(a=>{a==="dialogs"?(wt(),this.itemManager.setInteractiveEnabled(!1)):this.itemManager.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const i=Wi.subscribe(a=>{if(!a?.placedItems)return;const r=a.placedItems;s.forEach(o=>{r.find(d=>d.id===o.id)||this.itemManager.removeItem(o.id)}),r.forEach(o=>{const c=s.find(d=>d.id===o.id);c&&JSON.stringify(c)!==JSON.stringify(o)&&this.itemManager.updateItem(o.id,o)}),s=r.map(o=>({...o}))});this.unsubscribers.push(i)}setupAssetDropListener(){const e=Ee.on(_e.ASSET_DROPPED,t=>{const{assetKey:s,canvasX:i,canvasY:a}=t,o=this.scene.cameras.main.getWorldPoint(i,a),c=Math.max(0,Math.min(this.worldWidth,o.x)),d=Math.max(0,Math.min(this.worldHeight,o.y)),h=ls.createAtWorldPosition(s,c,d,this.groundY,"behind");oa(h),this.itemManager.createItem(h),_s(h.id),rt.set(!1)});this.unsubscribers.push(()=>e.unsubscribe())}setupDeleteKeys(){const e=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.DELETE,!1),t=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.BACKSPACE,!1),s=()=>{if(Bt())return;const i=this.scene.data.get("selectedItemId");i&&qi(i)};e.on("down",s),t.on("down",s)}getManager(){return this.itemManager}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.itemManager&&this.itemManager.destroy()}}class Pi{scene;worldWidth;worldHeight;socials=new Map;unsubscribers=[];selectionGraphics=null;cleanupFunctions=new Map;doubleClickDetector=new hn;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}static preloadAssets(e){e.load.image("social_discord","assets/socials/Discord.png"),e.load.image("social_facebook","assets/socials/Facebook.png"),e.load.image("social_instagram","assets/socials/Instagram.png"),e.load.image("social_kofi","assets/socials/Ko Fi.png"),e.load.image("social_linkedin","assets/socials/LinkedIn.png"),e.load.image("social_patreon","assets/socials/Patreon.png"),e.load.image("social_tiktok","assets/socials/TikTok.png"),e.load.image("social_twitch","assets/socials/Twitch.png"),e.load.image("social_twitter","assets/socials/Twitter.png"),e.load.image("social_whatsapp","assets/socials/Whatsapp.png"),e.load.image("social_youtube","assets/socials/Youtube.png")}create(e){this.selectionGraphics=this.scene.add.graphics(),this.selectionGraphics.setDepth(Me.SELECTION_GRAPHICS),e&&e.length>0&&e.forEach(t=>this.createSocial(t)),this.setupStoreSubscriptions(),this.setupSocialDropListener(),this.setupDeleteKeys()}createSocial(e){const t=`social_${e.socialKey}`;if(!this.scene.textures.exists(t)){console.warn(`Social texture not found: ${t}`);return}const s=e.scale??Tt,i=e.depth??Me.ITEMS_FRONT,a=this.scene.add.sprite(e.x,e.y,t);a.setScale(s),a.setDepth(i),a.setOrigin(.5,.5),a.setData("socialId",e.id),this.socials.set(e.id,{sprite:a,data:e}),this.makeInteractive(e.id)}updateSocialVisuals(e){const t=this.socials.get(e);if(!t)return;const{sprite:s,data:i}=t,a=`social_${i.socialKey}`;s.texture.key!==a&&this.scene.textures.exists(a)&&s.setTexture(a);const r=i.scale??Tt;s.setScale(r)}makeInteractive(e){const t=this.socials.get(e);if(!t)return;const{sprite:s}=t,i=Ps({sprite:s,scene:this.scene,cursor:"grab",useGridSnapping:!0,constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{Wt(e),this.updateSelectionVisuals()},isSelected:()=>Ze(Ut)===e,onDoubleClick:()=>this.doubleClickDetector.check(e)?(Ui(),!0):!1,onDragStart:()=>{s.setTint(Wa)},onDrag:()=>{this.updateSelectionVisuals()},onDragEnd:(a,r)=>{s.clearTint();const o=this.socials.get(e);o&&(o.data.x=Math.round(a),o.data.y=Math.round(r),rs(e,{x:o.data.x,y:o.data.y}))}}});this.cleanupFunctions.set(e,i)}setupStoreSubscriptions(){const e=Ut.subscribe(a=>{this.scene.data.set("selectedSocialId",a),this.updateSelectionVisuals()});this.unsubscribers.push(e);const t=He.subscribe(a=>{a==="dialogs"?(Wt(null),this.setInteractiveEnabled(!1)):this.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const i=da.subscribe(a=>{s.forEach(r=>{a.find(c=>c.id===r.id)||this.removeSocial(r.id)}),a.forEach(r=>{const o=s.find(d=>d.id===r.id),c=this.socials.get(r.id);if(c&&o){const d=o.scale!==r.scale,h=o.socialKey!==r.socialKey;c.data=r,(d||h)&&(this.updateSocialVisuals(r.id),this.scene.data.get("selectedSocialId")===r.id&&this.updateSelectionVisuals())}}),s=a.map(r=>({...r}))});this.unsubscribers.push(i)}setupSocialDropListener(){const e=Ee.on(_e.SOCIAL_DROPPED,t=>{const{socialKey:s,canvasX:i,canvasY:a}=t,o=this.scene.cameras.main.getWorldPoint(i,a),c=Math.max(0,Math.min(this.worldWidth,o.x)),d=Math.max(0,Math.min(this.worldHeight,o.y)),h={id:sr(),socialKey:s,x:Math.round(c),y:Math.round(d),scale:Tt,depth:Me.ITEMS_FRONT};ua(h),this.createSocial(h),Wt(h.id)});this.unsubscribers.push(()=>e.unsubscribe())}setupDeleteKeys(){const e=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.DELETE,!1),t=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.BACKSPACE,!1),s=()=>{if(Bt())return;let i="items";if(He.subscribe(o=>i=o)(),i!=="socials")return;const r=this.scene.data.get("selectedSocialId");r&&ei(r)};e.on("down",s),t.on("down",s)}updateSelectionVisuals(){if(!this.selectionGraphics)return;this.selectionGraphics.clear();const e=this.scene.data.get("selectedSocialId");if(!e){As(null);return}const t=this.socials.get(e);if(!t){As(null);return}const s=t.sprite,i=s.getBounds(),a=this.scene.cameras.main,{screenX:r,screenY:o}=vt(s.x,s.y,a);As({screenX:r,screenY:o,socialHeight:i.height*a.zoom}),this.selectionGraphics.lineStyle(3,Cs.SOCIAL.hex,1),this.selectionGraphics.strokeRect(i.x-4,i.y-4,i.width+8,i.height+8)}removeSocial(e){const t=this.socials.get(e);t&&(t.sprite.destroy(),this.socials.delete(e));const s=this.cleanupFunctions.get(e);s&&(s(),this.cleanupFunctions.delete(e)),this.updateSelectionVisuals()}setInteractiveEnabled(e){this.socials.forEach(({sprite:t})=>{e?(t.setInteractive(),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectionGraphics&&this.selectionGraphics.clear()}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear(),this.socials.forEach(({sprite:e})=>{e.destroy()}),this.socials.clear(),this.selectionGraphics&&(this.selectionGraphics.destroy(),this.selectionGraphics=null)}}class Di{scene;groundY;worldWidth;worldHeight;npcManager;unsubscribers=[];currentSelectedId=null;constructor(e,t,s,i){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=i}static preloadAssets(e){fs.preloadAssets(e)}create(e){return this.npcManager=new fs(this.scene,this.groundY,this.worldWidth,this.worldHeight,!0),e&&e.length>0&&this.npcManager.createNPCs(e),this.setupStoreSubscriptions(),this.setupAssetDropListener(),this.setupDeleteKeys(),this.npcManager}setupStoreSubscriptions(){const e=St.subscribe(a=>{this.currentSelectedId=a});this.unsubscribers.push(e);const t=He.subscribe(a=>{a==="dialogs"?(wt(),this.npcManager.setInteractiveEnabled(!1)):this.npcManager.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const i=Wi.subscribe(a=>{if(!a?.placedNPCs)return;const r=a.placedNPCs;s.forEach(o=>{r.find(d=>d.id===o.id)||this.npcManager.removeNPC(o.id)}),r.forEach(o=>{const c=s.find(d=>d.id===o.id);c&&JSON.stringify(c)!==JSON.stringify(o)&&this.npcManager.updateNPC(o.id,o)}),s=JSON.parse(JSON.stringify(r))});this.unsubscribers.push(i)}setupAssetDropListener(){const e=Ee.on(_e.NPC_DROPPED,t=>{const{assetKey:s,canvasX:i,canvasY:a}=t,r=this.scene.cameras.main.getWorldPoint(i,a),o=Math.max(0,Math.min(this.worldWidth,r.x)),c=Math.max(0,Math.min(this.worldHeight,r.y)),d=gs(s);if(!d)return;const h={id:`npc_${Date.now()}`,npcId:s,x:Math.round(o),y:Math.round(c),scale:d.scale,flipX:!1};va(h),this.npcManager.createNPC(h),_s(h.id),ot.set(!1)});this.unsubscribers.push(()=>e.unsubscribe())}setupDeleteKeys(){this.scene.input.keyboard?.on("keydown-DELETE",()=>this.handleDelete()),this.scene.input.keyboard?.on("keydown-BACKSPACE",()=>this.handleDelete())}handleDelete(){this.currentSelectedId&&this.npcManager.getNPC(this.currentSelectedId)&&(ni(this.currentSelectedId),wt())}update(){this.npcManager.update()}updateAutoDepth(e){this.npcManager.updateAutoDepth(e)}destroy(){this.unsubscribers.forEach(e=>e()),this.npcManager.destroy(),this.scene.input.keyboard?.off("keydown-DELETE"),this.scene.input.keyboard?.off("keydown-BACKSPACE")}getManager(){return this.npcManager}}const st=dn-1,it=300,Ei=150,Dr=.3,Er=.5,Ns=40,xi=60,Ti=16777215,ki=.6,Mi=0,ze=60,Ai=8;class xr{scene;worldWidth;worldHeight;graphics=null;zoneAreas=new Map;leftHandles=new Map;leftHandleVisuals=new Map;rightHandles=new Map;rightHandleVisuals=new Map;arrowGraphics=new Map;dragging=null;unsubscribers=[];createZoneSubscription;currentEditMode="items";currentZones=[];currentSelectedId=null;lastClickTime=0;lastClickX=0;DOUBLE_CLICK_THRESHOLD=300;DOUBLE_CLICK_DISTANCE=20;pendingTap=null;TAP_MAX_DURATION=300;TAP_MAX_DISTANCE=15;pendingZoneSelection=null;createZoneAtSubscription;boundWindowPointerUp=()=>{};boundWindowPointerMove=()=>{};currentScreenX=0;autoScrollTimer=null;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}create(){this.graphics=this.scene.add.graphics(),this.graphics.setDepth(st);const e=He.subscribe(i=>{this.currentEditMode=i,this.render()});this.unsubscribers.push(e);const t=ti.subscribe(i=>{this.currentZones=i,this.render()});this.unsubscribers.push(t);const s=Is.subscribe(i=>{this.currentSelectedId=i,this.render()});this.unsubscribers.push(s),this.scene.input.on("pointermove",this.handlePointerMove,this),this.scene.input.on("pointerup",this.handlePointerUp,this),this.boundWindowPointerUp=this.handlePointerUp.bind(this),this.boundWindowPointerMove=this.handleWindowPointerMove.bind(this),window.addEventListener("pointerup",this.boundWindowPointerUp),window.addEventListener("pointermove",this.boundWindowPointerMove),this.scene.input.on("pointerdown",this.handlePointerDown,this),this.createZoneSubscription=Ee.on(_e.DIALOG_ZONE_CREATE,()=>{this.createNewZone()}),this.createZoneAtSubscription=Ee.on(_e.DIALOG_ZONE_CREATE_AT,i=>{this.createZoneAtPosition(i.worldX)}),this.render()}clearVisuals(){this.graphics&&this.graphics.clear(),this.zoneAreas.forEach(e=>e.destroy()),this.zoneAreas.clear(),this.leftHandles.forEach(e=>e.destroy()),this.leftHandles.clear(),this.rightHandles.forEach(e=>e.destroy()),this.rightHandles.clear(),this.leftHandleVisuals.forEach(e=>e.destroy()),this.leftHandleVisuals.clear(),this.rightHandleVisuals.forEach(e=>e.destroy()),this.rightHandleVisuals.clear(),this.arrowGraphics.forEach(e=>e.destroy()),this.arrowGraphics.clear()}render(){if(this.clearVisuals(),this.currentEditMode==="dialogs")for(const e of this.currentZones)this.renderZone(e,e.id===this.currentSelectedId)}renderZone(e,t){if(!this.graphics)return;const s=B.Display.Color.HexStringToColor(e.color).color,i=t?Er:Dr;this.graphics.fillStyle(s,i),this.graphics.fillRect(e.x,0,e.width,this.worldHeight),this.graphics.lineStyle(2,s,.8),this.graphics.strokeRect(e.x,0,e.width,this.worldHeight);const a=this.scene.add.rectangle(e.x+e.width/2,this.worldHeight/2,e.width-Ns*2,this.worldHeight);a.setOrigin(.5,.5),a.setInteractive({cursor:t?"grab":"pointer"}),a.setDepth(st+.1),a.setAlpha(.001),a.setData("zoneId",e.id),a.on("pointerdown",r=>{if(this.isClickOnUIElement(r))return;const o=Date.now(),c=o-this.lastClickTime<this.DOUBLE_CLICK_THRESHOLD&&Math.abs(r.worldX-this.lastClickX)<this.DOUBLE_CLICK_DISTANCE;this.lastClickTime=o,this.lastClickX=r.worldX;const d=this.currentSelectedId===e.id;if(c&&d){ji();return}d?(this.scene.data.set("isDraggingItem",!0),xt(!0),this.startDrag(e.id,"move",r.worldX)):this.pendingZoneSelection={zoneId:e.id,worldX:r.worldX,startTime:o}}),this.zoneAreas.set(e.id,a),t&&this.createHandles(e)}createHandles(e){const t=this.scene.cameras.main.scrollY,s=this.scene.cameras.main.height,i=t+s/2,a=this.scene.add.rectangle(e.x,this.worldHeight/2,Ns,this.worldHeight);a.setOrigin(.5,.5),a.setDepth(st+.2),a.setFillStyle(Ti,ki);const r=this.scene.add.rectangle(e.x,this.worldHeight/2,xi,this.worldHeight);r.setOrigin(.5,.5),r.setInteractive({cursor:"ew-resize"}),r.setDepth(st+.25),r.setAlpha(.001),r.setData("zoneId",e.id),r.setData("type","left"),r.on("pointerdown",f=>{this.isClickOnUIElement(f)||this.startDrag(e.id,"left",f.worldX)}),this.leftHandles.set(e.id,r),this.leftHandleVisuals.set(e.id,a);const o=8,c=this.scene.add.graphics();c.setDepth(st+.3),this.drawArrow(c,e.x-o,i,"left"),this.arrowGraphics.set(`${e.id}_left`,c);const d=this.scene.add.rectangle(e.x+e.width,this.worldHeight/2,Ns,this.worldHeight);d.setOrigin(.5,.5),d.setDepth(st+.2),d.setFillStyle(Ti,ki);const h=this.scene.add.rectangle(e.x+e.width,this.worldHeight/2,xi,this.worldHeight);h.setOrigin(.5,.5),h.setInteractive({cursor:"ew-resize"}),h.setDepth(st+.25),h.setAlpha(.001),h.setData("zoneId",e.id),h.setData("type","right"),h.on("pointerdown",f=>{this.isClickOnUIElement(f)||this.startDrag(e.id,"right",f.worldX)}),this.rightHandles.set(e.id,h),this.rightHandleVisuals.set(e.id,d);const g=this.scene.add.graphics();g.setDepth(st+.3),this.drawArrow(g,e.x+e.width+o,i,"right"),this.arrowGraphics.set(`${e.id}_right`,g)}drawArrow(e,t,s,i){const r=i==="left"?-1:1;e.fillStyle(3355443,.8),e.beginPath(),e.moveTo(t+r*10+1,s),e.lineTo(t-r*10+1,s-10+1),e.lineTo(t-r*10+1,s+10-1),e.closePath(),e.fillPath(),e.fillStyle(16777215,.9),e.beginPath(),e.moveTo(t+r*10,s),e.lineTo(t-r*10,s-10),e.lineTo(t-r*10,s+10),e.closePath(),e.fillPath()}startDrag(e,t,s){const i=this.currentZones.find(a=>a.id===e);i&&(this.scene.data.set("isDraggingItem",!0),xt(!0),this.dragging={zoneId:e,type:t,startX:s,originalX:i.x,originalWidth:i.width})}getZoneBounds(e){let t=0,s=this.worldWidth;for(const i of this.currentZones){if(i.id===e)continue;const a=i.x+i.width,r=this.currentZones.find(o=>o.id===e);r&&(a<=r.x+r.width/2&&(t=Math.max(t,a+Mi)),i.x>=r.x+r.width/2&&(s=Math.min(s,i.x-Mi)))}return{minX:t,maxX:s-it,maxRight:s}}wouldOverlap(e,t,s){const i=t+s;for(const a of this.currentZones){if(a.id===e)continue;const r=a.x,o=a.x+a.width;if(t<o&&i>r)return!0}return!1}isClickOnUIElement(e){const t=e.downElement;return t?t.tagName?.toUpperCase()!=="CANVAS":!1}cancelPendingIfMoved(e){this.pendingTap&&Math.abs(e-this.pendingTap.worldX)>this.TAP_MAX_DISTANCE&&(this.pendingTap=null),this.pendingZoneSelection&&Math.abs(e-this.pendingZoneSelection.worldX)>this.TAP_MAX_DISTANCE&&(this.pendingZoneSelection=null)}screenToWorld(e,t){const s=this.scene.cameras.main,a=this.scene.game.canvas.getBoundingClientRect(),r=e-a.left,o=t-a.top;return ba(r,o,s)}handleWindowPointerMove(e){const t=this.screenToWorld(e.clientX,e.clientY);if(this.cancelPendingIfMoved(t.worldX),!this.dragging)return;const i=this.scene.game.canvas.getBoundingClientRect();e.clientX>=i.left&&e.clientX<=i.right&&e.clientY>=i.top&&e.clientY<=i.bottom||(this.currentScreenX=e.clientX-i.left,this.updateDrag(t.worldX),this.checkAutoScroll())}handlePointerMove(e){this.cancelPendingIfMoved(e.worldX),this.dragging&&(this.currentScreenX=e.x,e.event?.stopPropagation?.(),this.updateDrag(e.worldX),this.checkAutoScroll())}checkAutoScroll(){if(!this.dragging||this.dragging.type!=="move"){this.stopAutoScroll();return}const e=this.scene.cameras.main,t=e.width,s=this.currentZones.find(S=>S.id===this.dragging?.zoneId);if(!s)return;const i=Math.max(0,this.worldWidth-e.width/e.zoom);if(i<=0){this.stopAutoScroll();return}const{screenX:a}=vt(s.x,0,e),{screenX:r}=vt(s.x+s.width,0,e),o=a<=ze,c=r>=t-ze,d=e.scrollX>0,h=e.scrollX<i,g=s.x>0,f=s.x+s.width<this.worldWidth,P=this.currentScreenX<ze,I=this.currentScreenX>t-ze,y=o&&P&&d&&g||c&&I&&h&&f;y&&!this.autoScrollTimer?this.autoScrollTimer=this.scene.time.addEvent({delay:16,callback:this.performAutoScroll,callbackScope:this,loop:!0}):!y&&this.autoScrollTimer&&this.stopAutoScroll()}performAutoScroll(){if(!this.dragging||this.dragging.type!=="move"){this.stopAutoScroll();return}const e=this.scene.cameras.main,t=e.width,s=this.currentZones.find(_=>_.id===this.dragging?.zoneId);if(!s)return;let i=0;if(this.currentScreenX<ze){if(s.x<=0){this.stopAutoScroll();return}const y=(ze-this.currentScreenX)/ze;i=-Ai*y}else if(this.currentScreenX>t-ze){if(s.x+s.width>=this.worldWidth){this.stopAutoScroll();return}const y=(this.currentScreenX-(t-ze))/ze;i=Ai*y}if(i===0)return;const a=e.scrollX+i,r=0,o=Math.max(0,this.worldWidth-e.width/e.zoom),d=Math.max(r,Math.min(o,a))-e.scrollX;if(o<=0){this.stopAutoScroll();return}if(d===0){this.stopAutoScroll();return}const h=s.x+d,g=Math.max(0,Math.min(this.worldWidth-s.width,h)),f=g-s.x;if(f===0){this.stopAutoScroll();return}const P=e.scrollX+f,I=Math.max(0,Math.min(o,P));if(Math.abs(I-e.scrollX)>Math.abs(f)*2){this.stopAutoScroll();return}e.scrollX=I,this.wouldOverlap(s.id,g,s.width)||(Ct(s.id,{x:g}),this.dragging.originalX+=f,this.dragging.startX+=f)}stopAutoScroll(){this.autoScrollTimer&&(this.autoScrollTimer.destroy(),this.autoScrollTimer=null)}updateDrag(e){if(!this.dragging)return;const t=e-this.dragging.startX,s=this.currentZones.find(a=>a.id===this.dragging?.zoneId);if(!s)return;const i=this.getZoneBounds(s.id);if(this.dragging.type==="left"){let a=this.dragging.originalX+t,r=this.dragging.originalWidth-t;if(a<0&&(r+=a,a=0),r<it&&(a=this.dragging.originalX+this.dragging.originalWidth-it,r=it),a<i.minX){const o=i.minX-a;a=i.minX,r-=o}r>=it&&!this.wouldOverlap(s.id,a,r)&&Ct(s.id,{x:a,width:r})}else if(this.dragging.type==="right"){let a=this.dragging.originalWidth+t;a<it&&(a=it),s.x+a>this.worldWidth&&(a=this.worldWidth-s.x),s.x+a>i.maxRight&&(a=i.maxRight-s.x),a>=it&&!this.wouldOverlap(s.id,s.x,a)&&Ct(s.id,{width:a})}else if(this.dragging.type==="move"){let a=this.dragging.originalX+t;const r=s.width;if(a<0&&(a=0),a+r>this.worldWidth&&(a=this.worldWidth-r),!this.wouldOverlap(s.id,a,r))Ct(s.id,{x:a});else{const o=this.findNonOverlappingPosition(s.id,a,r);o!==null&&Ct(s.id,{x:o})}}}findNonOverlappingPosition(e,t,s){const i=this.currentZones.filter(h=>h.id!==e).sort((h,g)=>h.x-g.x);if(i.length===0)return Math.max(0,Math.min(t,this.worldWidth-s));let a=t,r=1/0;const o=i[0];if(o.x>=s){const h=o.x-s,g=Math.max(0,Math.min(t,h)),f=Math.abs(g-t);f<r&&(r=f,a=g)}for(let h=0;h<i.length-1;h++){const g=i[h],f=i[h+1],P=g.x+g.width,I=f.x;if(I-P>=s){const _=P,y=I-s,S=Math.max(_,Math.min(t,y)),u=Math.abs(S-t);u<r&&(r=u,a=S)}}const c=i[i.length-1],d=c.x+c.width;if(this.worldWidth-d>=s){const h=d,g=this.worldWidth-s,f=Math.max(h,Math.min(t,g)),P=Math.abs(f-t);P<r&&(r=P,a=f)}return r<1/0&&!this.wouldOverlap(e,a,s)?a:null}handlePointerUp(e){if(this.dragging&&(this.stopAutoScroll(),this.scene.data.set("isDraggingItem",!1),xt(!1),this.dragging=null),this.pendingZoneSelection){let i=Date.now()-this.pendingZoneSelection.startTime<this.TAP_MAX_DURATION;i&&e&&e.worldX!==void 0&&(i=Math.abs(e.worldX-this.pendingZoneSelection.worldX)<this.TAP_MAX_DISTANCE),i&&Yt(this.pendingZoneSelection.zoneId),this.pendingZoneSelection=null}if(this.pendingTap&&this.currentEditMode==="dialogs"){if(Date.now()-this.pendingTap.startTime<this.TAP_MAX_DURATION){let i=!0;e&&e.worldX!==void 0&&(i=Math.abs(e.worldX-this.pendingTap.worldX)<this.TAP_MAX_DISTANCE),i&&this.showTempAddButton(this.pendingTap.worldX,this.pendingTap.worldY)}this.pendingTap=null}}handlePointerDown(e){if(bt()||this.currentEditMode!=="dialogs"||this.dragging)return;const t=e.downElement;if(t&&t.tagName?.toUpperCase()!=="CANVAS")return;const s=e.worldX;for(const o of this.currentZones)if(s>=o.x&&s<=o.x+o.width)return;const i=Date.now(),a=i-this.lastClickTime,r=Math.abs(s-this.lastClickX);if(a<this.DOUBLE_CLICK_THRESHOLD&&r<this.DOUBLE_CLICK_DISTANCE){this.createZoneAtPosition(s),this.lastClickTime=0,this.hideTempAddButton();return}this.lastClickTime=i,this.lastClickX=s,this.pendingTap={worldX:s,worldY:e.worldY,startTime:i},this.currentSelectedId&&Yt(null)}showTempAddButton(e,t){const s=this.scene.cameras.main,{screenX:i,screenY:a}=vt(e,t,s);Ee.emit(_e.TEMP_ZONE_BUTTON_SHOW,{screenX:i,screenY:a,worldX:e})}hideTempAddButton(){Ee.emit(_e.TEMP_ZONE_BUTTON_HIDE,{})}createZoneAtPosition(e){this.createZoneAt(e)}createNewZone(){const e=this.scene.cameras.main,t=e.worldView.x+e.worldView.width/2;this.createZoneAt(t)}createZoneAt(e){let t=e-Ei/2;const s=Ei;if(t=Math.max(0,Math.min(this.worldWidth-s,t)),this.wouldOverlap("",t,s)){const a=this.findNonOverlappingPosition("",t,s);if(a===null){console.warn("No room for a new dialog zone");return}t=a}const i=or(t,s);i.x=t,ga(i),Yt(i.id)}updateSelectionVisuals(){if(this.currentEditMode!=="dialogs"){ts(null);return}if(!this.currentSelectedId){ts(null);return}const e=this.currentZones.find(r=>r.id===this.currentSelectedId);if(!e){ts(null);return}const t=this.scene.cameras.main,s=e.x+e.width/2,{screenX:i}=vt(s,0,t),a=t.height*.65;ts({screenX:i,screenY:a})}destroy(){this.hideTempAddButton();for(const e of this.unsubscribers)e();this.unsubscribers=[],this.createZoneSubscription&&this.createZoneSubscription.unsubscribe(),this.createZoneAtSubscription&&this.createZoneAtSubscription.unsubscribe(),this.stopAutoScroll(),this.scene.input.off("pointerdown",this.handlePointerDown,this),this.scene.input.off("pointermove",this.handlePointerMove,this),this.scene.input.off("pointerup",this.handlePointerUp,this),window.removeEventListener("pointerup",this.boundWindowPointerUp),window.removeEventListener("pointermove",this.boundWindowPointerMove),this.clearVisuals(),this.graphics&&(this.graphics.destroy(),this.graphics=null),this.dragging=null}}class Tr extends B.Scene{parallaxLayers=null;cameraController;playerController;gridOverlay;itemsController;socialsController;npcsController;dialogZoneRenderer;config;minimapSubscription;isShuttingDown=!1;get itemManager(){return this.itemsController?.getManager()}resetZoom(){this.cameraController?.resetToFit()}constructor(){super({key:Fe.BUILDER})}init(e){this.config=e.config}preload(){pn(this),us.preloadAssets(this),Pi.preloadAssets(this),Di.preloadAssets(this)}create(){this.isShuttingDown=!1,this.initializeScene()}async initializeScene(){mn(this),this.physics.world.setBounds(0,0,this.config.worldWidth,this.config.worldHeight);const t=Ke.getCurrentConfig().groundHeight??We,s=this.config.worldHeight-t;this.cameraController=new _r(this,this.config.worldWidth,this.config.worldHeight),this.playerController=new Ir(this,this.config.worldWidth,this.config.worldHeight),this.gridOverlay=new Cr(this,this.config.worldWidth,this.config.worldHeight),this.itemsController=new Pr(this,s,this.config.worldWidth,this.config.worldHeight),this.socialsController=new Pi(this,this.config.worldWidth,this.config.worldHeight),this.npcsController=new Di(this,s,this.config.worldWidth,this.config.worldHeight),this.dialogZoneRenderer=new xr(this,this.config.worldWidth,this.config.worldHeight),this.createBackground(),this.gridOverlay.create(),this.createGroundReference(),await this.playerController.preload(),this.playerController.create(this.config.playerStartX,this.config.playerStartY),this.itemsController.create(this.config.placedItems||[]),this.socialsController.create(this.config.placedSocials||[]),this.npcsController.create(this.config.placedNPCs||[]),this.dialogZoneRenderer.create(),this.cameraController.setup(),this.cameraController.centerOn(this.config.playerStartX,this.config.playerStartY),this.minimapSubscription=Ee.on(_e.MINIMAP_NAVIGATE,i=>{this.navigateToPosition(i.worldX,i.worldY)}),this.scale.on("resize",this.handleResize,this),this.events.on("shutdown",this.shutdown,this)}async createBackground(){const e=Ke.getCurrentConfig();try{await vn(this,e)}catch(t){console.error("Failed to load background:",t);return}this.parallaxLayers&&(yr(this.parallaxLayers),this.parallaxLayers=null),this.parallaxLayers=yn(this,this.config.worldWidth,this.config.worldHeight,e)}createGroundReference(){const t=Ke.getCurrentConfig().groundHeight??We;At.createVisualGround(this,{worldWidth:this.config.worldWidth,worldHeight:this.config.worldHeight,height:t})}update(){this.parallaxLayers&&Sn(this.parallaxLayers,this.cameras.main);const e=this.config.worldHeight,t=this.data.get("playerSprite");if(t){const a=t.getBounds().bottom,r=ws(a,e);t.setDepth(r)}this.itemManager?.updateAutoDepth(e),this.npcsController?.updateAutoDepth(e),this.itemManager?.updateSelectionVisuals(),this.socialsController?.updateSelectionVisuals(),this.dialogZoneRenderer?.updateSelectionVisuals(),this.npcsController?.update();const s=this.cameras.main;zn({scrollX:s.worldView.x,scrollY:s.worldView.y,viewWidth:s.width,viewHeight:s.height,worldWidth:this.config.worldWidth,worldHeight:this.config.worldHeight,zoom:s.zoom,playerX:t?.x??this.config.playerStartX,playerY:t?.y??this.config.playerStartY})}navigateToPosition(e,t){this.cameraController.centerOn(e,t)}handleResize(e){!this.cameras?.main||!this.config||(this.cameraController?.handleResize(),this.gridOverlay&&this.gridOverlay.redraw())}shutdown(){this.isShuttingDown||(this.isShuttingDown=!0,this.scale.off("resize",this.handleResize,this),this.minimapSubscription&&this.minimapSubscription.unsubscribe(),this.cameraController&&this.cameraController.destroy(),this.playerController&&this.playerController.destroy(),this.gridOverlay&&this.gridOverlay.destroy(),this.itemsController&&this.itemsController.destroy(),this.socialsController&&this.socialsController.destroy(),this.dialogZoneRenderer&&this.dialogZoneRenderer.destroy(),this.npcsController&&this.npcsController.destroy())}}$n();class kr{currentLanguage="cs";setLanguage(e){this.currentLanguage=e,localStorage.setItem("language",e)}getLanguage(){const e=localStorage.getItem("language");return(e==="cs"||e==="en")&&(this.currentLanguage=e),this.currentLanguage}toggleLanguage(){return this.currentLanguage=this.currentLanguage==="cs"?"en":"cs",this.setLanguage(this.currentLanguage),this.currentLanguage}}const wn=new kr;let Xe=null;function Mr(n){Xe=n}function Ar(){if(!Xe)return console.error("Scene manager not initialized"),null;try{const n=Xe.scene.getScene(Fe.GAME);return typeof n.getMapConfig=="function"?n.getMapConfig():n?.mapConfig||null}catch(n){return console.error("Failed to get map config:",n),null}}function $r(n){if(!Xe)return console.error("Scene manager not initialized"),!1;try{return Xe.scene.getScene(Fe.GAME)?(Xe.scene.stop(Fe.GAME),qn(n),Xe.scene.start(Fe.BUILDER,{config:n}),!0):(console.error("GameScene not found"),!1)}catch(e){return console.error("Failed to switch to builder:",e),!1}}function Hr(){if(console.log("[SceneManager] switchToGame called"),!Xe)return console.error("Scene manager not initialized"),!1;try{return console.log("[SceneManager] Stopping builder scene..."),Xe.scene.stop(Fe.BUILDER),console.log("[SceneManager] Exiting builder mode..."),Jn(),console.log("[SceneManager] Starting game scene..."),Xe.scene.start(Fe.GAME,{useBuilderConfig:!0}),console.log("[SceneManager] switchToGame completed successfully"),!0}catch(n){return console.error("Failed to switch to game:",n),!1}}function Or(){if(!Xe){console.error("Scene manager not initialized");return}try{Xe.scene.start(Fe.GAME)}catch(n){console.error("Failed to start game scene:",n)}}var Lr=N('<button class="close-btn svelte-164n75j" title="Close"></button>'),Rr=N('<div class="resize-handle resize-handle-nw svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M9 9L1 1M5 1L1 1L1 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-ne svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M1 9L9 1M5 1L9 1L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-sw svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M9 1L1 9M1 5L1 9L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-se svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M1 1L9 9M9 5L9 9L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>',1),Nr=N("<div><!></div> <!>",1),Xr=N('<div data-ui=""><div class="panel-header svelte-164n75j"><span class="panel-title svelte-164n75j"> </span> <!> <div class="header-buttons svelte-164n75j"><button class="minimize-btn svelte-164n75j"> </button> <!></div></div> <!></div>');function $t(n,e){ve(e,!0);const t=()=>L(ct,"$isDraggingInBuilder",s),[s,i]=Pe();let a=1e3,r=me(e,"initialRight",3,10),o=me(e,"initialTop",3,60),c=me(e,"width",3,280),d=me(e,"minWidth",3,200),h=me(e,"minHeight",3,100),g=me(e,"maxWidth",3,600),f=me(e,"maxHeight",3,800),P=me(e,"resizable",3,!1),I=me(e,"startMinimized",3,!1),D=me(e,"showClose",3,!1),_=ie(Be(I())),y=ie(!1),S=ie(Be({x:0,y:0})),u=ie(Be({width:c(),height:e.height??0})),p=ie(!1),C=ie(!1),w=ie("se"),b=ie(Be({x:0,y:0})),x=ie(null),X=ie(!1),m=ie(Be(a)),E=ie(null),H=ie("");function O(){a++,$(m,a,!0)}function W(A,Z,se){let ke=A;const Re=window.innerWidth-se-10;ke>Re&&(ke=Math.max(10,Re)),ke<10&&(ke=10);let Oe=Z;const et=window.innerHeight-40;return Oe>et&&(Oe=Math.max(10,et)),Oe<10&&(Oe=10),{x:ke,y:Oe}}De(()=>{if(typeof window>"u"||l(X))return;const A=localStorage.getItem(`panel-state-${e.panelId}`);if(A)try{const Z=JSON.parse(A),se=P()&&Z.width?Z.width:c(),oe=W(Z.x,Z.y,se);$(S,oe,!0),P()&&Z.width&&Z.height&&$(u,{width:Z.width,height:Z.height},!0);const be=P()?{x:oe.x,y:oe.y,width:l(u).width,height:l(u).height}:{x:oe.x,y:oe.y};$(H,JSON.stringify(be),!0)}catch{$(S,{x:window.innerWidth-c()-r(),y:o()},!0)}else $(S,{x:window.innerWidth-c()-r(),y:o()},!0);$(X,!0)}),De(()=>{if(!l(X))return;const A=P()?{x:l(S).x,y:l(S).y,width:l(u).width,height:l(u).height}:{x:l(S).x,y:l(S).y},Z=JSON.stringify(A);Z!==l(H)&&($(H,Z,!0),localStorage.setItem(`panel-state-${e.panelId}`,Z))}),De(()=>{if(!l(X))return;function A(){if(!l(x))return;const Z=P()?l(u).width:c();let se=l(S).x,oe=l(S).y,be=!1;const ke=window.innerWidth-Z;l(S).x>ke&&(se=Math.max(10,ke),be=!0);const Re=window.innerHeight-40;l(S).y>Re&&(oe=Math.max(10,Re),be=!0),l(S).x<0&&(se=10,be=!0),l(S).y<0&&(oe=10,be=!0),be&&$(S,{x:se,y:oe},!0)}return window.addEventListener("resize",A),()=>{window.removeEventListener("resize",A)}});function k(){$(_,!l(_))}function Y(){e.onclose?.()}function G(){if(P())if(l(y))l(E)&&($(S,{x:l(E).x,y:l(E).y},!0),$(u,{width:l(E).width,height:l(E).height},!0),$(E,null)),$(y,!1);else{$(E,{x:l(S).x,y:l(S).y,width:l(u).width,height:l(u).height},!0);const A=20,Z=Math.min(g(),window.innerWidth-A*2),se=Math.min(f(),window.innerHeight-A*2),oe=Math.max(A,(window.innerWidth-Z)/2),be=Math.max(A,(window.innerHeight-se)/2);$(S,{x:oe,y:be},!0),$(u,{width:Z,height:se},!0),$(y,!0)}}function ee(A){A.target.closest("button")||G()}function F(A){A.target.closest("button")||($(p,!0),$(b,{x:A.clientX-l(S).x,y:A.clientY-l(S).y},!0),A.currentTarget.setPointerCapture(A.pointerId),A.preventDefault())}function q(A){if(!l(p))return;const Z=A.clientX-l(b).x,se=A.clientY-l(b).y,oe=window.innerWidth-(l(x)?.offsetWidth??c()),be=window.innerHeight-40;$(S,{x:Math.max(0,Math.min(Z,oe)),y:Math.max(0,Math.min(se,be))},!0)}function te(A){l(p)&&($(p,!1),A.currentTarget.releasePointerCapture(A.pointerId))}function R(A){return Z=>{P()&&($(C,!0),$(w,A,!0),Z.currentTarget.setPointerCapture(Z.pointerId),Z.preventDefault(),Z.stopPropagation())}}function K(A){if(!l(C)||!l(x))return;const Z=l(x).getBoundingClientRect();let se,oe,be=l(S).x,ke=l(S).y;const Re=l(w)==="se"||l(w)==="ne",Oe=l(w)==="se"||l(w)==="sw";Re?se=A.clientX-Z.left:(se=Z.right-A.clientX,be=A.clientX),Oe?oe=A.clientY-Z.top:(oe=Z.bottom-A.clientY,ke=A.clientY);const et=Math.max(d(),Math.min(g(),se)),tt=Math.max(h(),Math.min(f(),oe));Re||(be=Z.right-et,be<0&&(be=0)),Oe||(ke=Z.bottom-tt,ke<0&&(ke=0));const xs=Re?window.innerWidth-l(S).x-10:Z.right-10,ht=Oe?window.innerHeight-l(S).y-10:Z.bottom-10,Ts=Math.min(et,xs),ut=Math.min(tt,ht);$(u,{width:Ts,height:ut},!0);let Ot=!1,gt=l(S).x,Qt=l(S).y;!Re&&se>=d()&&(gt=Math.max(0,be),Ot=!0),!Oe&&oe>=h()&&(Qt=Math.max(0,ke),Ot=!0),Ot&&$(S,{x:gt,y:Qt},!0)}function Q(A){l(C)&&($(C,!1),A.currentTarget.releasePointerCapture(A.pointerId))}function le(A){A.stopPropagation()}De(()=>{if(!l(x))return;const A=l(x),Z=oe=>{oe.ctrlKey&&oe.preventDefault(),oe.stopPropagation()},se=oe=>{oe.preventDefault(),oe.stopPropagation()};return A.addEventListener("wheel",Z,{passive:!1}),A.addEventListener("gesturestart",se,{passive:!1}),A.addEventListener("gesturechange",se,{passive:!1}),A.addEventListener("gestureend",se,{passive:!1}),()=>{A.removeEventListener("wheel",Z),A.removeEventListener("gesturestart",se),A.removeEventListener("gesturechange",se),A.removeEventListener("gestureend",se)}});var re=Xr();let ce;re.__pointerdown=A=>{O(),le(A)},re.__click=le;var Se=T(re);Se.__pointerdown=F,Se.__pointermove=q,Se.__pointerup=te,Se.__dblclick=ee;var de=T(Se),pe=T(de),fe=M(de,2);{var we=A=>{var Z=Ce(),se=ge(Z);Kt(se,()=>e.headerExtra),v(A,Z)};z(fe,A=>{e.headerExtra&&A(we)})}var Ye=M(fe,2),Ae=T(Ye);Ae.__click=k;var Le=T(Ae),dt=M(Ae,2);{var Es=A=>{var Z=Lr();Z.__click=Y,v(A,Z)};z(dt,A=>{D()&&A(Es)})}var Ht=M(Se,2);{var Cn=A=>{var Z=Nr(),se=ge(Z);let oe;var be=T(se);Kt(be,()=>e.children);var ke=M(se,2);{var Re=Oe=>{var et=Rr(),tt=ge(et),xs=V(()=>R("nw"));tt.__pointerdown=function(...ft){l(xs)?.apply(this,ft)},tt.__pointermove=K,tt.__pointerup=Q;var ht=M(tt,2),Ts=V(()=>R("ne"));ht.__pointerdown=function(...ft){l(Ts)?.apply(this,ft)},ht.__pointermove=K,ht.__pointerup=Q;var ut=M(ht,2),Ot=V(()=>R("sw"));ut.__pointerdown=function(...ft){l(Ot)?.apply(this,ft)},ut.__pointermove=K,ut.__pointerup=Q;var gt=M(ut,2),Qt=V(()=>R("se"));gt.__pointerdown=function(...ft){l(Qt)?.apply(this,ft)},gt.__pointermove=K,gt.__pointerup=Q,Ne("pointercancel",tt,Q),Ne("pointercancel",ht,Q),Ne("pointercancel",ut,Q),Ne("pointercancel",gt,Q),v(Oe,et)};z(ke,Oe=>{P()&&Oe(Re)})}U(()=>oe=$e(se,1,"panel-body svelte-164n75j",null,oe,{"has-fixed-height":P()&&l(u).height>0})),v(A,Z)};z(Ht,A=>{l(_)||A(Cn)})}kt(re,A=>$(x,A),()=>l(x)),U(()=>{ce=$e(re,1,"draggable-panel svelte-164n75j",null,ce,{minimized:l(_),maximized:l(y),dragging:l(p),resizing:l(C),resizable:P()}),ae(re,`left: ${l(S).x??""}px; top: ${l(S).y??""}px; width: ${l(_)?"auto":`${P()?l(u).width:c()}px`}; ${P()&&l(u).height>0&&!l(_)?`height: ${l(u).height}px;`:""}${t()?" pointer-events: none;":""} z-index: ${l(m)??""};`),xe(pe,e.title),ne(Ae,"title",l(_)?"Expand":"Minimize"),xe(Le,l(_)?"":"")}),Ne("pointercancel",Se,te),v(n,re),ye(),i()}je(["pointerdown","click","pointermove","pointerup","dblclick"]);const $i=10,Wr=150,Yr=`
  position: fixed;
  pointer-events: none;
  z-index: 10000;
  opacity: 0.9;
  image-rendering: pixelated;
  filter: drop-shadow(3px 3px 0 rgba(0, 0, 0, 0.5));
  background: rgba(26, 26, 46, 0.9);
`,Br=`
  width: 100%;
  height: 100%;
  object-fit: contain;
  image-rendering: pixelated;
`;function ci(n,e,t){const{previewSize:s,borderColor:i,dataKey:a,eventName:r,onDrop:o}=n,c=s/2,d={startX:0,startY:0,hasMoved:!1,isActivated:!1,pendingKey:null,pendingTarget:null,longPressTimer:null};function h(m,E,H){Ee.emit(r,{[a]:m,canvasX:E,canvasY:H}),o?.()}function g(m,E){const H=document.querySelector("canvas");if(!H)return null;const O=H.getBoundingClientRect();return m>=O.left&&m<=O.right&&E>=O.top&&E<=O.bottom?{canvasX:m-O.left,canvasY:E-O.top}:null}function f(m,E,H){const O=document.createElement("div");return O.className="touch-drag-preview",O.innerHTML=`<img src="${m}" alt="" />`,O.style.cssText=`
      ${Yr}
      top: ${H-c}px;
      left: ${E-c}px;
      width: ${s}px;
      height: ${s}px;
      border: 2px solid ${i};
    `,O.querySelector("img").style.cssText=Br,document.body.appendChild(O),O}function P(m,E,H){m.style.top=`${H-c}px`,m.style.left=`${E-c}px`}function I(){d.longPressTimer&&(clearTimeout(d.longPressTimer),d.longPressTimer=null),d.pendingKey=null,d.pendingTarget=null,d.isActivated=!1,d.hasMoved=!1}function D(){I();const m=e();m.touchDragElement&&(m.touchDragElement.remove(),t({touchDragElement:null})),t({draggedKey:null}),is(!1)}function _(m,E){if(!m.dataTransfer)return;t({draggedKey:E}),is(!0),m.dataTransfer.effectAllowed="copy",m.dataTransfer.setData(a,E);const H=m.target,W=(H.querySelector("[data-drag-preview]")||H.querySelector("img"))?.cloneNode(!0);W&&(W.style.position="absolute",W.style.top="-1000px",W.style.left="-1000px",W.style.zIndex="-1",document.body.appendChild(W),m.dataTransfer.setDragImage(W,c,c),requestAnimationFrame(()=>W.remove()))}function y(){t({draggedKey:null}),is(!1)}function S(m){m.preventDefault(),m.dataTransfer&&(m.dataTransfer.dropEffect="copy")}function u(m){m.preventDefault();const E=m.dataTransfer?.getData(a);if(!E)return;const H=g(m.clientX,m.clientY);H&&h(E,H.canvasX,H.canvasY)}function p(m,E){if(!d.pendingKey||!d.pendingTarget||d.isActivated)return;d.isActivated=!0,t({draggedKey:d.pendingKey}),is(!0);const H=d.pendingTarget.querySelector("img");if(H){const O=f(H.src,m,E);t({touchDragElement:O})}}function C(m,E){if(m.touches.length!==1)return;const H=m.touches[0];d.startX=H.clientX,d.startY=H.clientY,d.hasMoved=!1,d.isActivated=!1,d.pendingKey=E,d.pendingTarget=m.currentTarget,d.longPressTimer=setTimeout(()=>{d.pendingKey&&!d.hasMoved&&p(H.clientX,H.clientY)},Wr)}function w(m){const E=m.touches[0],H=E.clientX-d.startX,O=E.clientY-d.startY;if(!d.hasMoved&&(Math.abs(H)>$i||Math.abs(O)>$i)&&(d.hasMoved=!0,!d.isActivated)){if(Math.abs(O)>Math.abs(H)){I();return}p(E.clientX,E.clientY)}const W=e();d.isActivated&&W.touchDragElement&&(P(W.touchDragElement,E.clientX,E.clientY),m.preventDefault())}function b(m){const E=e(),H=d.isActivated,O=E.draggedKey;if(H&&O&&d.hasMoved){const W=m.changedTouches[0],k=g(W.clientX,W.clientY);k&&h(O,k.canvasX,k.canvasY)}D()}function x(){const m=document.querySelector("canvas");return m?(m.addEventListener("dragover",S),m.addEventListener("drop",u),()=>{m.removeEventListener("dragover",S),m.removeEventListener("drop",u)}):()=>{}}function X(){return document.addEventListener("touchmove",w,{passive:!1}),document.addEventListener("touchend",b),document.addEventListener("touchcancel",b),()=>{document.removeEventListener("touchmove",w),document.removeEventListener("touchend",b),document.removeEventListener("touchcancel",b)}}return{onDragStart:_,onDragEnd:y,onTouchStart:C,setupCanvasListeners:x,setupTouchListeners:X}}var Zr=N('<span class="palette-hint svelte-lnmxj4">Drag to place</span>'),Gr=N('<div class="animated-wrapper svelte-lnmxj4" data-drag-preview=""><img class="item-preview animated svelte-lnmxj4"/></div>'),Fr=N('<img class="item-preview svelte-lnmxj4" data-drag-preview=""/>'),Kr=N('<div data-ui="" draggable="true" role="button" tabindex="0"><!></div>'),zr=N('<div class="palette-content svelte-lnmxj4" role="toolbar" tabindex="-1"><div class="palette-grid svelte-lnmxj4"></div></div>');function Ur(n,e){ve(e,!0);const t=()=>L(rt,"$isItemPaletteOpen",i),s=()=>L(He,"$builderEditMode",i),[i,a]=Pe(),r="#4a90e2",o=600,d=Ke.getCurrentConfig().itemGroups||["shared"],h=ai.filter(w=>d.includes(w.group));function g(){return window.innerWidth<o}function f(){g()&&rt.set(!1)}let P=ie(null),I=ie(null);const D=ci({previewSize:48,borderColor:r,dataKey:"assetKey",eventName:_e.ASSET_DROPPED,onDrop:f},()=>({draggedKey:l(P),touchDragElement:l(I)}),w=>{"draggedKey"in w&&$(P,w.draggedKey??null,!0),"touchDragElement"in w&&$(I,w.touchDragElement??null,!0)});function _(w){w.stopPropagation()}function y(){rt.set(!1)}function S(w){const b=document.querySelector("canvas");if(!b)return;const x=b.getBoundingClientRect(),X=x.width/2,m=x.height/2;Ee.emit(_e.ASSET_DROPPED,{assetKey:w,canvasX:X,canvasY:m}),f()}Ss(()=>D.setupCanvasListeners()),De(()=>D.setupTouchListeners());var u=Ce(),p=ge(u);{var C=w=>{$t(w,{panelId:"item-palette",title:"Items",initialRight:10,initialTop:60,width:280,height:400,minWidth:200,minHeight:160,maxWidth:500,maxHeight:600,resizable:!0,showClose:!0,onclose:y,headerExtra:x=>{var X=Zr();v(x,X)},children:(x,X)=>{var m=zr();m.__pointerdown=_;var E=T(m);Je(E,21,()=>h,Qe,(H,O)=>{var W=Kr();let k;W.__touchstart=F=>D.onTouchStart(F,l(O).key),W.__dblclick=()=>S(l(O).key),ae(W,"",{},{"--accent-color":r});var Y=T(W);{var G=F=>{const q=V(()=>Ks(l(O).key));var te=Gr();let R;var K=T(te);let Q;U(()=>{R=ae(te,"",R,{width:`${l(q)?.frameWidth??""}px`,height:`${l(q)?.frameHeight??""}px`}),ne(K,"src",l(O).path),ne(K,"alt",l(O).name),Q=ae(K,"",Q,{width:`${l(q)?.frameWidth??""}px`,height:`${l(q)?.frameHeight??""}px`,"object-fit":"none","object-position":"0 0"})}),v(F,te)},ee=F=>{var q=Fr();U(()=>{ne(q,"src",l(O).path),ne(q,"alt",l(O).name)}),v(F,q)};z(Y,F=>{Fs(l(O).key)?F(G):F(ee,!1)})}U(()=>{k=$e(W,1,"palette-item svelte-lnmxj4",null,k,{dragging:l(P)===l(O).key}),ne(W,"title",`${l(O).name??""} (double-click to place)`)}),Ne("dragstart",W,F=>D.onDragStart(F,l(O).key)),Ne("dragend",W,function(...F){D.onDragEnd?.apply(this,F)}),v(H,W)}),v(x,m)},$$slots:{headerExtra:!0,default:!0}})};z(p,w=>{t()&&s()==="items"&&w(C)})}v(n,u),ye(),a()}je(["pointerdown","touchstart","dblclick"]);var jr=N('<span class="palette-hint svelte-4tctcn">Drag to place</span>'),Vr=N('<div data-ui="" draggable="true" role="button" tabindex="0"><img class="item-preview svelte-4tctcn"/> <span class="item-name svelte-4tctcn"> </span></div>'),qr=N('<div class="palette-content svelte-4tctcn" role="toolbar" tabindex="-1"><div class="palette-grid svelte-4tctcn"></div></div>');function Jr(n,e){ve(e,!0);const t=()=>L(nt,"$isSocialPaletteOpen",i),s=()=>L(He,"$builderEditMode",i),[i,a]=Pe(),r=Cs.SOCIAL.css,o=ps;let c=ie(null),d=ie(null);const h=ci({previewSize:64,borderColor:r,dataKey:"socialKey",eventName:_e.SOCIAL_DROPPED,onDrop:()=>{nt.set(!1)}},()=>({draggedKey:l(c),touchDragElement:l(d)}),y=>{"draggedKey"in y&&$(c,y.draggedKey??null,!0),"touchDragElement"in y&&$(d,y.touchDragElement??null,!0)});function g(y){y.stopPropagation()}function f(){nt.set(!1)}function P(y){const S=document.querySelector("canvas");if(!S)return;const u=S.getBoundingClientRect(),p=u.width/2,C=u.height/2;Ee.emit(_e.SOCIAL_DROPPED,{socialKey:y,canvasX:p,canvasY:C}),nt.set(!1)}Ss(()=>h.setupCanvasListeners()),De(()=>h.setupTouchListeners());var I=Ce(),D=ge(I);{var _=y=>{$t(y,{panelId:"social-palette",title:"Socials",initialRight:10,initialTop:60,width:280,height:350,minWidth:200,minHeight:200,maxWidth:500,maxHeight:500,resizable:!0,showClose:!0,onclose:f,headerExtra:u=>{var p=jr();v(u,p)},children:(u,p)=>{var C=qr();C.__pointerdown=g;var w=T(C);Je(w,21,()=>o,Qe,(b,x)=>{var X=Vr();let m;X.__touchstart=k=>h.onTouchStart(k,l(x).key),X.__dblclick=()=>P(l(x).key);let E;var H=T(X),O=M(H,2),W=T(O);U(()=>{m=$e(X,1,"palette-item svelte-4tctcn",null,m,{dragging:l(c)===l(x).key}),ne(X,"title",`${l(x).name??""} (double-click to place)`),E=ae(X,"",E,{"--accent-color":r}),ne(H,"src",l(x).path),ne(H,"alt",l(x).name),xe(W,l(x).name)}),Ne("dragstart",X,k=>h.onDragStart(k,l(x).key)),Ne("dragend",X,function(...k){h.onDragEnd?.apply(this,k)}),v(b,X)}),v(u,C)},$$slots:{headerExtra:!0,default:!0}})};z(D,y=>{t()&&s()==="socials"&&y(_)})}v(n,I),ye(),a()}je(["pointerdown","touchstart","dblclick"]);var Qr=N('<span class="palette-hint svelte-1tjg0mk">Drag to place</span>'),eo=N('<div data-ui="" draggable="true" role="button" tabindex="0"><div class="animated-wrapper svelte-1tjg0mk" data-drag-preview=""><img class="item-preview animated svelte-1tjg0mk"/></div> <span class="npc-name svelte-1tjg0mk"> </span></div>'),to=N('<div class="palette-content svelte-1tjg0mk" role="toolbar" tabindex="-1"><div class="palette-grid svelte-1tjg0mk"></div></div>');function so(n,e){ve(e,!0);const t=()=>L(ot,"$isNPCPaletteOpen",i),s=()=>L(He,"$builderEditMode",i),[i,a]=Pe(),r="#e67e22",o=600;function c(){return window.innerWidth<o}function d(){c()&&ot.set(!1)}let h=ie(null),g=ie(null);const f=ci({previewSize:48,borderColor:r,dataKey:"assetKey",eventName:_e.NPC_DROPPED,onDrop:d},()=>({draggedKey:l(h),touchDragElement:l(g)}),u=>{"draggedKey"in u&&$(h,u.draggedKey??null,!0),"touchDragElement"in u&&$(g,u.touchDragElement??null,!0)});function P(u){u.stopPropagation()}function I(){Ki()}function D(u){const p=document.querySelector("canvas");if(!p)return;const C=p.getBoundingClientRect(),w=C.width/2,b=C.height/2;Ee.emit(_e.NPC_DROPPED,{assetKey:u,canvasX:w,canvasY:b}),ot.set(!1)}Ss(()=>f.setupCanvasListeners()),De(()=>f.setupTouchListeners());var _=Ce(),y=ge(_);{var S=u=>{$t(u,{panelId:"npc-palette",title:"NPCs",initialRight:10,initialTop:60,width:280,height:400,minWidth:200,minHeight:160,maxWidth:500,maxHeight:600,resizable:!0,showClose:!0,onclose:I,headerExtra:C=>{var w=Qr();v(C,w)},children:(C,w)=>{var b=to();b.__pointerdown=P;var x=T(b);Je(x,21,()=>ri,Qe,(X,m)=>{var E=eo();let H;E.__touchstart=F=>f.onTouchStart(F,l(m).id),E.__dblclick=()=>D(l(m).id),ae(E,"",{},{"--accent-color":r});var O=T(E);let W;var k=T(O);let Y;var G=M(O,2),ee=T(G);U(()=>{H=$e(E,1,"palette-item svelte-1tjg0mk",null,H,{dragging:l(h)===l(m).id}),ne(E,"title",`${l(m).name??""} (double-click to place)`),W=ae(O,"",W,{width:`${l(m).frameWidth??""}px`,height:`${l(m).frameHeight??""}px`}),ne(k,"src",l(m).path),ne(k,"alt",l(m).name),Y=ae(k,"",Y,{width:`${l(m).frameWidth??""}px`,height:`${l(m).frameHeight??""}px`,"object-fit":"none","object-position":"0 0"}),xe(ee,l(m).name)}),Ne("dragstart",E,F=>f.onDragStart(F,l(m).id)),Ne("dragend",E,function(...F){f.onDragEnd?.apply(this,F)}),v(X,E)}),v(C,b)},$$slots:{headerExtra:!0,default:!0}})};z(y,u=>{t()&&s()==="npcs"&&u(S)})}v(n,_),ye(),a()}je(["pointerdown","touchstart","dblclick"]);var io=N("<button> </button>"),no=N('<div class="language-tabs svelte-1hfe466"></div>');function bn(n,e){ve(e,!0);let t=me(e,"accentColor",3,"#88ddff");var s=no();Je(s,21,()=>ea,Qe,(i,a)=>{var r=io();let o;r.__click=()=>e.onselect(l(a).code);let c;var d=T(r);U(()=>{o=$e(r,1,"lang-tab svelte-1hfe466",null,o,{active:e.selectedLanguage===l(a).code}),c=ae(r,"",c,{"--accent-color":t()}),xe(d,l(a).label)}),v(i,r)}),v(n,s),ye()}je(["click"]);var ao=N("<button></button>"),ro=N('<div class="color-picker svelte-wbnbhn"></div>'),oo=N('<div class="color-section svelte-wbnbhn"><span class="color-label-title svelte-wbnbhn"> </span> <button class="color-button svelte-wbnbhn" title="Change color"><span class="color-preview svelte-wbnbhn"></span> <span class="color-label svelte-wbnbhn">Change</span></button> <!></div>');function lo(n,e){ve(e,!0);let t=me(e,"label",3,"Color"),s=me(e,"accentColor",3,"#88ddff"),i=ie(!1),a=ie(null);De(()=>{l(i)&&l(a)&&requestAnimationFrame(()=>{l(a)?.scrollIntoView({behavior:"smooth",block:"nearest"})})});function r(y){e.onselect(y)}function o(){$(i,!l(i))}var c=oo(),d=T(c),h=T(d),g=M(d,2);g.__click=o;let f;var P=T(g);let I;var D=M(g,2);{var _=y=>{var S=ro();Je(S,21,()=>e.colors,Qe,(u,p)=>{var C=ao();let w;C.__click=()=>r(l(p));let b;U(()=>{w=$e(C,1,"color-swatch svelte-wbnbhn",null,w,{selected:e.selectedColor===l(p)}),ne(C,"title",l(p)),b=ae(C,"",b,{background:l(p),"--accent-color":s()})}),v(u,C)}),kt(S,u=>$(a,u),()=>l(a)),v(y,S)};z(D,y=>{l(i)&&y(_)})}U(()=>{xe(h,t()),f=ae(g,"",f,{"--accent-color":s()}),I=ae(P,"",I,{background:e.selectedColor})}),v(n,c),ye()}je(["click"]);const vs=400,co=400,_n=70;var ho=N('<div class="form-section svelte-vzwc0p"><div class="form-group svelte-vzwc0p"><label class="svelte-vzwc0p"> </label> <textarea rows="6" class="svelte-vzwc0p"></textarea></div></div>');function uo(n,e){ve(e,!0);let t=me(e,"contentPlaceholder",3,"Enter text..."),s=me(e,"idPrefix",3,"text-form"),i=me(e,"accentColor",3,"#88ddff");function a(f){const P=f.target;e.oncontentchange(P.value)}var r=ho();let o;var c=T(r),d=T(c),h=T(d),g=M(d,2);g.__input=a,U(()=>{o=ae(r,"",o,{"--accent-color":i()}),ne(d,"for",`${s()??""}-content`),xe(h,`Content (max ${vs} chars)`),ne(g,"id",`${s()??""}-content`),cs(g,e.content),ne(g,"placeholder",t()),ne(g,"maxlength",vs)}),v(n,r),ye()}je(["input"]);var go=N('<div class="panel-content svelte-7qe9ti"><!> <!> <div class="panel-extras svelte-7qe9ti"><!></div> <div class="panel-footer svelte-7qe9ti"><!> <!></div></div>');function fo(n,e){ve(e,!0);const t=()=>L(ti,"$dialogZones",a),s=()=>L(Is,"$selectedDialogZoneId",a),i=()=>L(bs,"$isDialogZonePanelOpen",a),[a,r]=Pe(),o="#88ddff";let c=ie(Be(Bi)),d=V(()=>t().find(u=>u.id===s())??null),h=V(()=>l(d)?.texts.find(u=>u.language===l(c))??null);function g(u){s()&&fa(s(),l(c),{content:u})}function f(){s()&&(en(s()),hi())}function P(){hi()}function I(u){s()&&Ct(s(),{color:u})}function D(u){$(c,u,!0)}var _=Ce(),y=ge(_);{var S=u=>{$t(u,{panelId:"dialog-zone-panel",title:"Dialog Zone",initialRight:10,initialTop:160,width:280,height:450,minWidth:250,minHeight:370,maxWidth:500,maxHeight:700,resizable:!0,showClose:!0,onclose:P,children:(p,C)=>{var w=go(),b=T(w);bn(b,{get selectedLanguage(){return l(c)},onselect:D,accentColor:o});var x=M(b,2);{let W=V(()=>l(h)?.content??"");uo(x,{get content(){return l(W)},oncontentchange:g,contentPlaceholder:"Enter dialog text...",idPrefix:"dialog",accentColor:o})}var X=M(x,2),m=T(X);lo(m,{get colors(){return Us},get selectedColor(){return l(d).color},onselect:I,label:"Zone Color",accentColor:o});var E=M(X,2),H=T(E);he(H,{variant:"cyan",onclick:P,children:(W,k)=>{var Y=ue("CONFIRM");v(W,Y)},$$slots:{default:!0}});var O=M(H,2);he(O,{variant:"red",onclick:f,children:(W,k)=>{var Y=ue("DELETE");v(W,Y)},$$slots:{default:!0}}),v(p,w)},$$slots:{default:!0}})};z(y,u=>{l(d)&&i()&&u(S)})}v(n,_),ye(),r()}var po=N("<button> </button>"),mo=N('<a target="_blank" rel="noopener noreferrer" class="url-preview svelte-6kd0po">Test link </a>'),vo=N('<button><img class="svelte-6kd0po"/></button>'),yo=N('<div class="style-picker svelte-6kd0po"></div>'),So=N('<div class="panel-content svelte-6kd0po"><div class="social-size-row svelte-6kd0po"><div class="social-size-section svelte-6kd0po"><span class="section-label svelte-6kd0po">Size</span> <div class="size-buttons svelte-6kd0po"></div></div></div> <div class="panel-extras svelte-6kd0po"><div class="url-section svelte-6kd0po"><label for="social-url" class="svelte-6kd0po">Link URL (opens on click)</label> <input id="social-url" type="url" placeholder="https://example.com" class="svelte-6kd0po"/> <!></div> <div class="style-section svelte-6kd0po"><span class="section-label svelte-6kd0po">Social Icon</span> <button class="style-button svelte-6kd0po" title="Change social icon"><img alt="Current social" class="style-preview svelte-6kd0po"/> <span class="style-label svelte-6kd0po"> </span></button> <!></div></div> <div class="panel-footer svelte-6kd0po"><!> <!></div></div>');function wo(n,e){ve(e,!0);const t=()=>L(ha,"$selectedSocial",a),s=()=>L(Ut,"$selectedSocialId",a),i=()=>L(Jt,"$isSocialPanelOpen",a),[a,r]=Pe(),o=Cs.SOCIAL.css;let c=V(t),d=V(()=>l(c)?nr(l(c).scale??Tt):"M"),h=V(()=>l(c)?ps.find(b=>b.key===l(c).socialKey):null);function g(b){const x=b.target;s()&&rs(s(),{url:x.value||void 0})}function f(b){s()&&rs(s(),{scale:ir(b)})}function P(){s()&&ei(s())}function I(){na(),Wt(null)}let D=ie(!1),_=ie(null),y=ie(null);function S(b){s()&&rs(s(),{socialKey:b})}function u(){$(D,!l(D))}De(()=>{l(D)&&l(_)&&requestAnimationFrame(()=>{l(_)?.scrollIntoView({behavior:"smooth",block:"nearest"})})}),De(()=>{if(!l(D))return;function b(x){const X=x.target;l(_)&&!l(_).contains(X)&&l(y)&&!l(y).contains(X)&&$(D,!1)}return document.addEventListener("click",b),()=>document.removeEventListener("click",b)});var p=Ce(),C=ge(p);{var w=b=>{$t(b,{panelId:"social-panel",title:"Edit Social",initialRight:10,initialTop:160,width:280,height:350,minWidth:250,minHeight:300,maxWidth:400,maxHeight:500,resizable:!0,showClose:!0,onclose:I,children:(x,X)=>{var m=So(),E=T(m),H=T(E),O=M(T(H),2);Je(O,21,()=>Object.entries(Vt),Qe,(de,pe)=>{var fe=V(()=>Hn(l(pe),2));let we=()=>l(fe)[0],Ye=()=>l(fe)[1].label;var Ae=po();let Le;Ae.__click=()=>f(we());var dt=T(Ae);U(()=>{Le=$e(Ae,1,"size-btn svelte-6kd0po",null,Le,{active:l(d)===we()}),ne(Ae,"title",Ye()),xe(dt,we())}),v(de,Ae)});var W=M(E,2),k=T(W),Y=M(T(k),2);Y.__input=g;var G=M(Y,2);{var ee=de=>{var pe=mo();U(()=>ne(pe,"href",l(c).url)),v(de,pe)};z(G,de=>{l(c).url&&de(ee)})}var F=M(k,2),q=M(T(F),2);q.__click=u;var te=T(q),R=M(te,2),K=T(R);kt(q,de=>$(y,de),()=>l(y));var Q=M(q,2);{var le=de=>{var pe=yo();Je(pe,21,()=>ps,Qe,(fe,we)=>{var Ye=vo();let Ae;Ye.__click=()=>S(l(we).key);var Le=T(Ye);U(()=>{Ae=$e(Ye,1,"style-item svelte-6kd0po",null,Ae,{selected:l(c).socialKey===l(we).key}),ne(Ye,"title",l(we).name),ne(Le,"src",l(we).path),ne(Le,"alt",l(we).name)}),v(fe,Ye)}),kt(pe,fe=>$(_,fe),()=>l(_)),v(de,pe)};z(Q,de=>{l(D)&&de(le)})}var re=M(W,2),ce=T(re);he(ce,{variant:"pink",onclick:I,children:(de,pe)=>{var fe=ue("CONFIRM");v(de,fe)},$$slots:{default:!0}});var Se=M(ce,2);he(Se,{variant:"red",onclick:P,children:(de,pe)=>{var fe=ue("DELETE");v(de,fe)},$$slots:{default:!0}}),U(()=>{ae(m,`--accent-color: ${o}`),cs(Y,l(c).url??""),ne(te,"src",l(h)?.path??""),xe(K,l(h)?.name??"Select")}),v(x,m)},$$slots:{default:!0}})};z(C,b=>{i()&&l(c)&&b(w)})}v(n,p),ye(),r()}je(["click","input"]);var bo=N('<div class="panel-content svelte-j84kgd"><!> <div class="form-section svelte-j84kgd"><div class="form-group svelte-j84kgd"><label for="npc-content" class="svelte-j84kgd"> </label> <textarea id="npc-content" placeholder="Enter dialog text..." rows="8" class="svelte-j84kgd"></textarea></div> <div class="form-group slider-group svelte-j84kgd"><label for="npc-trigger-radius" class="svelte-j84kgd">Trigger Radius</label> <input type="range" id="npc-trigger-radius" step="100" class="svelte-j84kgd"/></div></div> <div class="panel-footer svelte-j84kgd"><!> <!></div></div>');function _o(n,e){ve(e,!0);const t=()=>L(si,"$selectedNPC",i),s=()=>L(qt,"$isNPCConfigPanelOpen",i),[i,a]=Pe(),r="#e67e22",o=200,c=100,d=500;let h=ie(Be(Bi)),g=V(()=>t()?.dialog?.find(w=>w.language===l(h))??null),f=V(()=>t()?gs(t().npcId)?.name??t().npcId:"NPC"),P=V(()=>t()?.triggerRadius??o);function I(w){if(!t())return;const b=w.target;ya(t().id,l(h),{content:b.value})}function D(w){if(!t())return;const b=w.target;ii(t().id,{triggerRadius:parseInt(b.value,10)})}function _(){t()&&ni(t().id)}function y(){ia(),wt()}function S(w){$(h,w,!0)}var u=Ce(),p=ge(u);{var C=w=>{$t(w,{panelId:"npc-config-panel",get title(){return l(f)},initialRight:10,initialTop:160,width:280,height:450,minWidth:250,minHeight:370,maxWidth:500,maxHeight:700,resizable:!0,showClose:!0,onclose:y,children:(b,x)=>{var X=bo(),m=T(X);bn(m,{get selectedLanguage(){return l(h)},onselect:S,accentColor:r});var E=M(m,2);ae(E,"",{},{"--accent-color":r});var H=T(E),O=T(H),W=T(O),k=M(O,2);k.__input=I;var Y=M(H,2),G=M(T(Y),2);ne(G,"min",c),ne(G,"max",d),G.__input=D;var ee=M(E,2),F=T(ee);he(F,{variant:"cyan",onclick:y,children:(te,R)=>{var K=ue("CONFIRM");v(te,K)},$$slots:{default:!0}});var q=M(F,2);he(q,{variant:"red",onclick:_,children:(te,R)=>{var K=ue("DELETE");v(te,K)},$$slots:{default:!0}}),U(()=>{xe(W,`Content (max ${vs} chars)`),cs(k,l(g)?.content??""),ne(k,"maxlength",vs),cs(G,l(P))}),v(b,X)},$$slots:{default:!0}})};z(p,w=>{s()&&t()&&w(C)})}v(n,u),ye(),a()}je(["input"]);var Io=N('<div class="temp-zone-button svelte-1vrg7di"><!></div>');function Co(n,e){ve(e,!0);const t=()=>L(Xi,"$builderCameraInfo",a),s=()=>L(He,"$builderEditMode",a),i=()=>L(ct,"$isDraggingInBuilder",a),[a,r]=Pe();let o=ie(null),c=null,d=null,h=ie(null);function g(y){c&&clearTimeout(c),$(o,y,!0),$(h,t()?.scrollX??null,!0),c=setTimeout(()=>{$(o,null),$(h,null)},2e3)}function f(){l(o)&&(Ee.emit(_e.DIALOG_ZONE_CREATE_AT,{worldX:l(o).worldX}),$(o,null),$(h,null),c&&(clearTimeout(c),c=null))}function P(){$(o,null),$(h,null),c&&(clearTimeout(c),c=null)}Ss(()=>{d=Ee.on(_e.TEMP_ZONE_BUTTON_SHOW,g);const y=Ee.on(_e.TEMP_ZONE_BUTTON_HIDE,P);return()=>{d?.unsubscribe(),y.unsubscribe()}}),On(()=>{c&&clearTimeout(c)}),De(()=>{s()!=="dialogs"&&($(o,null),$(h,null))}),De(()=>{const y=t()?.scrollX;l(o)&&l(h)!==null&&y!==void 0&&Math.abs(y-l(h))>10&&($(o,null),$(h,null),c&&(clearTimeout(c),c=null))});var I=Ce(),D=ge(I);{var _=y=>{var S=Io(),u=T(S);he(u,{variant:"cyan",width:"90px",onclick:f,children:(p,C)=>{var w=ue("+ ZONE");v(p,w)},$$slots:{default:!0}}),U(()=>ae(S,`left: ${l(o).screenX??""}px; top: ${l(o).screenY-50}px;${i()?" pointer-events: none;":""}`)),v(y,S)};z(D,y=>{l(o)&&s()==="dialogs"&&y(_)})}v(n,I),ye(),r()}var Po=N('<div class="item-controls svelte-1529z5h"><div class="controls-row svelte-1529z5h"><!> <!> <!></div></div>');function Do(n,e){ve(e,!0);const t=()=>L(Qs,"$selectedItem",d),s=()=>L(Vi,"$selectedItemScreenPosition",d),i=()=>L(St,"$selectedItemId",d),a=()=>L(aa,"$selectedItemPhysicsEnabled",d),r=()=>L(ra,"$selectedItemFlipX",d),o=()=>L(He,"$builderEditMode",d),c=()=>L(ct,"$isDraggingInBuilder",d),[d,h]=Pe();let g=V(()=>t()?Ia(t().assetKey):!1),f=V(()=>{const u=s();if(!u)return null;const p=10,C=40,w=l(g)?290:200;let b=u.screenY-u.itemHeight/2-45;const x=p+C;b<x&&(b=u.screenY+u.itemHeight/2+10);const X=window.innerHeight-C-p;b>X&&(b=X);let m=u.screenX;const E=w/2,H=E+p,O=window.innerWidth-E-p;return m<H&&(m=H),m>O&&(m=O),{x:m,y:b}});function P(){i()&&la(i(),!a())}function I(){i()&&ca(i(),!r())}function D(){i()&&(qi(i()),wt())}var _=Ce(),y=ge(_);{var S=u=>{var p=Po(),C=T(p),w=T(C);{let m=V(()=>r()?"orange":"blue");he(w,{get variant(){return l(m)},title:"Flip item horizontally",onclick:I,children:(E,H)=>{var O=ue("Flip");v(E,O)},$$slots:{default:!0}})}var b=M(w,2);{var x=m=>{{let E=V(()=>a()?"orange":"blue");he(m,{get variant(){return l(E)},title:"Toggle physics: item will block player movement",onclick:P,children:(H,O)=>{var W=ue();U(()=>xe(W,a()?"Ghost":"Solid")),v(H,W)},$$slots:{default:!0}})}};z(b,m=>{l(g)&&m(x)})}var X=M(b,2);he(X,{variant:"red",title:"Delete selected item",onclick:D,children:(m,E)=>{var H=ue("DEL");v(m,H)},$$slots:{default:!0}}),U(()=>ae(p,`left: ${l(f).x??""}px; top: ${l(f).y??""}px;${c()?" pointer-events: none;":""}`)),v(u,p)};z(y,u=>{o()!=="dialogs"&&i()&&l(f)&&u(S)})}v(n,_),ye(),h()}var Eo=N('<div class="npc-controls svelte-wxsibf"><div class="controls-row svelte-wxsibf"><!> <!> <!></div></div>');function xo(n,e){ve(e,!0);const t=()=>L(tn,"$selectedNPCScreenPosition",o),s=()=>L(si,"$selectedNPC",o),i=()=>L(ma,"$selectedNPCFlipX",o),a=()=>L(He,"$builderEditMode",o),r=()=>L(ct,"$isDraggingInBuilder",o),[o,c]=Pe();let d=V(()=>{const _=t();if(!_)return null;const y=10,S=40,u=270;let p=_.screenY-_.npcHeight/2-45;const C=y+S;p<C&&(p=_.screenY+_.npcHeight/2+10);const w=window.innerHeight-S-y;p>w&&(p=w);let b=_.screenX;const x=u/2,X=x+y,m=window.innerWidth-x-y;return b<X&&(b=X),b>m&&(b=m),{x:b,y:p}});function h(){s()&&Sa(s().id,!i())}function g(){zi()}function f(){s()&&(ni(s().id),wt())}var P=Ce(),I=ge(P);{var D=_=>{var y=Eo(),S=T(y),u=T(S);{let w=V(()=>i()?"orange":"blue");he(u,{get variant(){return l(w)},title:"Flip NPC horizontally",onclick:h,children:(b,x)=>{var X=ue("Flip");v(b,X)},$$slots:{default:!0}})}var p=M(u,2);he(p,{variant:"cyan",title:"Edit NPC dialog",onclick:g,children:(w,b)=>{var x=ue("EDIT");v(w,x)},$$slots:{default:!0}});var C=M(p,2);he(C,{variant:"red",title:"Delete selected NPC",onclick:f,children:(w,b)=>{var x=ue("DEL");v(w,x)},$$slots:{default:!0}}),U(()=>ae(y,`left: ${l(d).x??""}px; top: ${l(d).y??""}px;${r()?" pointer-events: none;":""}`)),v(_,y)};z(I,_=>{a()!=="dialogs"&&s()&&l(d)&&_(D)})}v(n,P),ye(),c()}var To=N('<div class="zone-controls svelte-7umuek"><div class="controls-row svelte-7umuek"><!> <!> <!></div></div>');function ko(n,e){ve(e,!0);const t=()=>L(Qi,"$selectedDialogZoneScreenPosition",r),s=()=>L(Is,"$selectedDialogZoneId",r),i=()=>L(He,"$builderEditMode",r),a=()=>L(ct,"$isDraggingInBuilder",r),[r,o]=Pe();let c=V(()=>{const D=t();if(!D)return null;const _=10,y=120,S=85;let u=D.screenY;const p=_+y/2,C=window.innerHeight-y/2-_;u<p&&(u=p),u>C&&(u=C);let w=D.screenX;const b=S/2,x=b+_,X=window.innerWidth-b-_;return w<x&&(w=x),w>X&&(w=X),{x:w,y:u}});function d(){ji()}function h(){s()&&(en(s()),Yt(null))}function g(){Yt(null)}var f=Ce(),P=ge(f);{var I=D=>{var _=To(),y=T(_),S=T(y);he(S,{variant:"cyan",title:"Edit zone content (or double-click)",onclick:d,children:(C,w)=>{var b=ue("EDIT");v(C,b)},$$slots:{default:!0}});var u=M(S,2);he(u,{variant:"red",title:"Delete selected zone",onclick:h,children:(C,w)=>{var b=ue("DEL");v(C,b)},$$slots:{default:!0}});var p=M(u,2);he(p,{variant:"default",title:"Deselect zone",onclick:g,children:(C,w)=>{var b=ue("DONE");v(C,b)},$$slots:{default:!0}}),U(()=>ae(_,`left: ${l(c).x??""}px; top: ${l(c).y??""}px;${a()?" pointer-events: none;":""}`)),v(D,_)};z(P,D=>{i()==="dialogs"&&s()&&l(c)&&D(I)})}v(n,f),ye(),o()}var Mo=N('<div class="social-controls svelte-q16c5x"><div class="controls-row svelte-q16c5x"><!> <!></div></div>');function Ao(n,e){ve(e,!0);const t=()=>L(Ji,"$selectedSocialScreenPosition",r),s=()=>L(Ut,"$selectedSocialId",r),i=()=>L(He,"$builderEditMode",r),a=()=>L(ct,"$isDraggingInBuilder",r),[r,o]=Pe();let c=V(()=>{const I=t();if(!I)return null;const D=10,_=40,y=190;let S=I.screenY-I.socialHeight/2-45;const u=D+_;S<u&&(S=I.screenY+I.socialHeight/2+10);const p=window.innerHeight-_-D;S>p&&(S=p);let C=I.screenX;const w=y/2,b=w+D,x=window.innerWidth-w-D;return C<b&&(C=b),C>x&&(C=x),{x:C,y:S}});function d(){Ui()}function h(){s()&&(ei(s()),Wt(null))}var g=Ce(),f=ge(g);{var P=I=>{var D=Mo(),_=T(D),y=T(_);he(y,{variant:"pink",title:"Edit social settings (or double-click)",onclick:d,children:(u,p)=>{var C=ue("EDIT");v(u,C)},$$slots:{default:!0}});var S=M(y,2);he(S,{variant:"red",title:"Delete selected social",onclick:h,children:(u,p)=>{var C=ue("DEL");v(u,C)},$$slots:{default:!0}}),U(()=>ae(D,`left: ${l(c).x??""}px; top: ${l(c).y??""}px;${a()?" pointer-events: none;":""}`)),v(I,D)};z(f,I=>{i()!=="dialogs"&&s()&&l(c)&&I(P)})}v(n,g),ye(),o()}var $o=N('<div class="hstack svelte-13tonpt"><!></div>');function Ho(n,e){let t=me(e,"gap",3,"10px"),s=me(e,"align",3,"center");var i=$o(),a=T(i);Kt(a,()=>e.children??Ge),U(()=>ae(i,`gap: ${t()??""}; align-items: ${(s()==="start"?"flex-start":s()==="end"?"flex-end":s())??""};`)),v(n,i)}var Oo=N('<div class="vstack svelte-eir7yr"><!></div>');function Lo(n,e){let t=me(e,"gap",3,"10px"),s=me(e,"align",3,"stretch");var i=Oo(),a=T(i);Kt(a,()=>e.children??Ge),U(()=>ae(i,`gap: ${t()??""}; align-items: ${(s()==="start"?"flex-start":s()==="end"?"flex-end":s())??""};`)),v(n,i)}var Ro=N("<div><!></div>");function ys(n,e){const t=()=>L(ct,"$isDraggingInBuilder",s),[s,i]=Pe();let a=me(e,"padding",3,"10px");var r=Ro();let o;var c=T(r);Kt(c,()=>e.children??Ge),U(()=>{o=$e(r,1,`fixed fixed--${e.position??""}`,"svelte-cx4lc",o,{"dragging-in-builder":t()}),ae(r,`--padding: ${a()??""};`)}),v(n,r),i()}var No=N("<div><!> <!></div>"),Xo=N("<!> <!>",1),Wo=N("<!> <!> <!> <!>",1),Yo=N("<div><!></div>"),Bo=N("<!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!>",1);function Zo(n,e){ve(e,!0);const t=()=>L(St,"$selectedItemId",h),s=()=>L(Is,"$selectedDialogZoneId",h),i=()=>L(Ut,"$selectedSocialId",h),a=()=>L(He,"$builderEditMode",h),r=()=>L(ds,"$gridSnappingEnabled",h),o=()=>L(rt,"$isItemPaletteOpen",h),c=()=>L(nt,"$isSocialPaletteOpen",h),d=()=>L(ot,"$isNPCPaletteOpen",h),[h,g]=Pe(),f=600;let P=ie(Be(typeof window<"u"?window.innerWidth<f:!1)),I=V(()=>l(P)&&(t()!==null||s()!==null||i()!==null));De(()=>{function G(){$(P,window.innerWidth<f)}return window.addEventListener("resize",G),()=>window.removeEventListener("resize",G)});function D(G){const ee=G.target;ee.closest(".draggable-panel")||ee.tagName!=="CANVAS"&&(rt.set(!1),nt.set(!1),ot.set(!1),Jt.set(!1),bs.set(!1),qt.set(!1))}De(()=>(window.addEventListener("dblclick",D),()=>window.removeEventListener("dblclick",D)));function _(){console.log("[BuilderUI] handleSave called, switching to game...");const G=Hr();console.log("[BuilderUI] switchToGame result:",G)}function y(){Vn()}function S(){Ee.emit(_e.DIALOG_ZONE_CREATE)}var u=Bo(),p=ge(u);Do(p,{});var C=M(p,2);xo(C,{});var w=M(C,2);ko(w,{});var b=M(w,2);Ao(b,{});var x=M(b,2);{var X=G=>{Ur(G,{})},m=G=>{var ee=Ce(),F=ge(ee);{var q=R=>{fo(R,{})},te=R=>{var K=Ce(),Q=ge(K);{var le=ce=>{Jr(ce,{})},re=ce=>{var Se=Ce(),de=ge(Se);{var pe=fe=>{so(fe,{})};z(de,fe=>{a()==="npcs"&&fe(pe)},!0)}v(ce,Se)};z(Q,ce=>{a()==="socials"?ce(le):ce(re,!1)},!0)}v(R,K)};z(F,R=>{a()==="dialogs"?R(q):R(te,!1)},!0)}v(G,ee)};z(x,G=>{a()==="items"?G(X):G(m,!1)})}var E=M(x,2);wo(E,{});var H=M(E,2);_o(H,{});var O=M(H,2);Co(O,{});var W=M(O,2),k=M(W,2);ys(k,{position:"top-left",children:(G,ee)=>{var F=No();let q;var te=T(F);he(te,{variant:"green",width:"100px",onclick:_,children:(K,Q)=>{var le=ue("SAVE");v(K,le)},$$slots:{default:!0}});var R=M(te,2);{let K=V(()=>r()?"blue":"orange");he(R,{get variant(){return l(K)},width:"80px",onclick:y,title:"Toggle grid snapping",children:(Q,le)=>{var re=ue();U(()=>xe(re,r()?"FREE":"SNAP")),v(Q,re)},$$slots:{default:!0}})}U(()=>q=$e(F,1,"left-buttons svelte-1lbkour",null,q,{"hide-left":l(I)})),v(G,F)},$$slots:{default:!0}});var Y=M(k,2);ys(Y,{position:"top-right",children:(G,ee)=>{var F=Yo();let q;var te=T(F);Lo(te,{align:"end",children:(R,K)=>{var Q=Wo(),le=ge(Q);{let de=V(()=>a()==="items"&&o()?"orange":"blue");he(le,{get variant(){return l(de)},onclick:()=>{a()==="items"?ta():(Rt("items"),rt.set(!0))},title:"Edit items",children:(pe,fe)=>{var we=ue("ITEMS");v(pe,we)},$$slots:{default:!0}})}var re=M(le,2);{let de=V(()=>a()==="socials"&&c()?"orange":"pink");he(re,{get variant(){return l(de)},onclick:()=>{a()==="socials"?sa():(Rt("socials"),nt.set(!0))},title:"Edit social icons",children:(pe,fe)=>{var we=ue("SOCIALS");v(pe,we)},$$slots:{default:!0}})}var ce=M(re,2);{let de=V(()=>a()==="npcs"&&d()?"orange":"green");he(ce,{get variant(){return l(de)},onclick:()=>{a()==="npcs"?Ki():(Rt("npcs"),ot.set(!0))},title:"Edit NPCs",children:(pe,fe)=>{var we=ue("NPCS");v(pe,we)},$$slots:{default:!0}})}var Se=M(ce,2);Ho(Se,{children:(de,pe)=>{var fe=Xo(),we=ge(fe);{var Ye=Le=>{he(Le,{variant:"cyan",width:"100px",onclick:S,title:"Create new dialog zone at center of view",children:(dt,Es)=>{var Ht=ue("+ ZONE");v(dt,Ht)},$$slots:{default:!0}})};z(we,Le=>{a()==="dialogs"&&Le(Ye)})}var Ae=M(we,2);{let Le=V(()=>a()==="dialogs"?"orange":"cyan");he(Ae,{get variant(){return l(Le)},onclick:()=>{a()==="dialogs"?Rt("items"):Rt("dialogs")},title:"Edit dialog zones",children:(dt,Es)=>{var Ht=ue("DIALOGS");v(dt,Ht)},$$slots:{default:!0}})}v(de,fe)},$$slots:{default:!0}}),v(R,Q)},$$slots:{default:!0}}),U(()=>q=$e(F,1,"right-buttons svelte-1lbkour",null,q,{"hide-right":l(I)})),v(G,F)},$$slots:{default:!0}}),v(n,u),ye(),g()}var Go=N('<img class="skin-preview-img svelte-12jgjc8"/>'),Fo=N('<canvas width="96" height="96" class="skin-preview svelte-12jgjc8"></canvas>'),Ko=N('<button type="button"><div class="skin-preview-container svelte-12jgjc8"><!></div> <span class="skin-name svelte-12jgjc8"> </span></button>'),zo=N('<span class="custom-icon svelte-12jgjc8"></span>'),Uo=N('<span class="custom-icon svelte-12jgjc8"></span>'),jo=N('<button class="edit-btn svelte-12jgjc8" type="button">EDIT</button>'),Vo=N('<button class="background-card svelte-12jgjc8" type="button"><div class="preview-container svelte-12jgjc8"><img class="preview-image svelte-12jgjc8"/></div> <span class="background-name svelte-12jgjc8"> </span></button>'),qo=N('<div class="background-select-screen svelte-12jgjc8"><div class="content svelte-12jgjc8"><h1 class="title svelte-12jgjc8">SELECT CHARACTER</h1> <div class="skins-grid svelte-12jgjc8"><!> <div class="skin-card-wrapper svelte-12jgjc8"><button type="button"><div class="skin-preview-container custom-preview svelte-12jgjc8"><!></div> <span class="skin-name svelte-12jgjc8">CUSTOM</span></button> <!></div></div> <h1 class="title svelte-12jgjc8">SELECT BACKGROUND</h1> <div class="backgrounds-grid svelte-12jgjc8"></div></div></div>');function Jo(n,e){ve(e,!0);const t="custom";function s(){window.location.href="./builder.html"}const i=Ue,a=Ie,r=js()!==null,o=localStorage.getItem("useModularPlayer")==="true";let c=ie(Be(o&&r?t:yt.getSkinId())),d=Be({}),h=Be({});De(()=>{a.forEach(k=>{const Y=os(k),G=new Image;G.onload=()=>{h[k.id]=!0},G.onerror=()=>{h[k.id]=!1,f(k)},G.src=`./${Y}/preview.png`})});function g(k){return`./${os(k)}/preview.png`}function f(k){const Y=d[k.id];if(!Y)return;const G=Y.getContext("2d");if(!G)return;const ee=k.frameWidth??48,F=k.frameHeight??48,q=os(k),te=new Image;te.src=`./${q}/idle.png`,te.onload=()=>{G.clearRect(0,0,Y.width,Y.height),G.imageSmoothingEnabled=!1;const R=Y.width/ee,K=Y.height/F,Q=Math.min(R,K),le=ee*Q,re=F*Q,ce=(Y.width-le)/2,Se=(Y.height-re)/2;G.drawImage(te,0,0,ee,F,ce,Se,le,re)}}function P(k){return`./assets/backgrounds/${k}/preview.png`}function I(k){if(k===t){if(!r){s();return}$(c,t),localStorage.setItem("useModularPlayer","true"),Zs.set(t)}else $(c,k,!0),yt.setSkin(k),localStorage.setItem("useModularPlayer","false"),Zs.set(k)}function D(){s()}function _(k){Ke.setBackgroundByIndex(k),Zi.set(i[k].name),Gi.set(!0),Or()}var y=qo(),S=T(y),u=M(T(S),2),p=T(u);Je(p,17,()=>a,Qe,(k,Y)=>{var G=Ko();let ee;G.__click=()=>I(l(Y).id);var F=T(G),q=T(F);{var te=le=>{var re=Go();U(ce=>{ne(re,"src",ce),ne(re,"alt",l(Y).name)},[()=>g(l(Y))]),v(le,re)},R=le=>{var re=Fo();kt(re,(ce,Se)=>d[Se.id]=ce,ce=>d?.[ce.id],()=>[l(Y)]),v(le,re)};z(q,le=>{h[l(Y).id]?le(te):le(R,!1)})}var K=M(F,2),Q=T(K);U(()=>{ee=$e(G,1,"skin-card svelte-12jgjc8",null,ee,{selected:l(c)===l(Y).id}),xe(Q,l(Y).name)}),v(k,G)});var C=M(p,2),w=T(C);let b;w.__click=()=>I(t);var x=T(w),X=T(x);{var m=k=>{var Y=zo();v(k,Y)},E=k=>{var Y=Uo();v(k,Y)};z(X,k=>{r?k(m):k(E,!1)})}var H=M(w,2);{var O=k=>{var Y=jo();Y.__click=D,v(k,Y)};z(H,k=>{r&&l(c)===t&&k(O)})}var W=M(u,4);Je(W,21,()=>i,Qe,(k,Y,G)=>{var ee=Vo();ee.__click=()=>_(G);var F=T(ee),q=T(F),te=M(F,2),R=T(te);U(K=>{ne(q,"src",K),ne(q,"alt",l(Y).name),xe(R,l(Y).name)},[()=>P(l(Y).folder)]),v(k,ee)}),U(()=>b=$e(w,1,"skin-card custom-card svelte-12jgjc8",null,b,{selected:l(c)===t})),v(n,y),ye()}je(["click"]);var Qo=N('<div class="dialog-content svelte-hli3ii"> </div>'),el=N("<div><!></div>");function tl(n,e){ve(e,!0);const t=()=>L(Ri,"$playerScreenPosition",i),s=()=>L(cr,"$activeDialogText",i),[i,a]=Pe();let r=V(()=>Math.max(10,window.innerHeight-t().y+_n)),o=V(()=>window.innerWidth<=co),c=V(()=>l(o)?50:t().x),d=V(()=>l(o)?"percent":"px");var h=Ce(),g=ge(h);{var f=P=>{var I=el();let D;var _=T(I);{var y=S=>{var u=Qo(),p=T(u);U(()=>xe(p,s().content)),v(S,u)};z(_,S=>{s().content&&S(y)})}U(()=>{D=$e(I,1,"dialog-bubble svelte-hli3ii",null,D,{narrow:l(o)}),ae(I,`bottom: ${l(r)??""}px; left: ${l(c)??""}${l(d)??""};`)}),v(P,I)};z(g,P=>{s()&&P(f)})}v(n,h),ye(),a()}var sl=N('<div class="dialog-content svelte-b2j5a3"> </div>'),il=N('<div class="npc-dialog-bubble svelte-b2j5a3"><!></div>');function nl(n,e){ve(e,!0);const t=()=>L(li,"$activeNPCDialog",i),s=()=>L(dr,"$activeNPCDialogText",i),[i,a]=Pe();let r=V(()=>{if(!t())return 0;const g=t().screenY-t().npcHeight/2;return Math.max(10,window.innerHeight-g+_n)}),o=V(()=>t()?.screenX??0);var c=Ce(),d=ge(c);{var h=g=>{var f=il(),P=T(f);{var I=D=>{var _=sl(),y=T(_);U(()=>xe(y,s().content)),v(D,_)};z(P,D=>{s().content&&D(I)})}U(()=>ae(f,`bottom: ${l(r)??""}px; left: ${l(o)??""}px;`)),v(g,f)};z(d,g=>{s()&&t()&&g(h)})}v(n,c),ye(),a()}var al=N('<div class="game-mask mask-top svelte-1u9aoac"></div> <div class="game-mask mask-bottom svelte-1u9aoac"></div> <div class="game-mask mask-left svelte-1u9aoac"></div> <div class="game-mask mask-right svelte-1u9aoac"></div> <div class="game-frame svelte-1u9aoac"><div class="frame-border frame-top svelte-1u9aoac"></div> <div class="frame-border frame-bottom svelte-1u9aoac"></div> <div class="frame-border frame-left svelte-1u9aoac"></div> <div class="frame-border frame-right svelte-1u9aoac"></div> <div class="frame-corner corner-top-left svelte-1u9aoac"></div> <div class="frame-corner corner-top-right svelte-1u9aoac"></div> <div class="frame-corner corner-bottom-left svelte-1u9aoac"></div> <div class="frame-corner corner-bottom-right svelte-1u9aoac"></div></div>',1);function rl(n,e){ve(e,!1);const t=()=>L(Wn,"$gameFrameColor",i),s=()=>L(Ni,"$gameWorldDimensions",i),[i,a]=Pe(),r=Ve(),o=Ve(),c=Ve(),d=Ve(),h=Ve(),g=Ve(),f=Ve();qe(()=>t(),()=>{$(r,t())}),qe(()=>s(),()=>{$(o,s())}),qe(()=>l(o),()=>{$(c,`
    top: ${l(o).offsetY}px;
    left: ${l(o).offsetX}px;
    width: ${l(o).worldWidth}px;
    height: ${l(o).worldHeight}px;
  `)}),qe(()=>l(o),()=>{$(d,l(o).offsetY)}),qe(()=>l(o),()=>{$(h,l(o).offsetX)}),qe(()=>l(o),()=>{$(g,l(o).offsetX+l(o).worldWidth)}),qe(()=>l(o),()=>{$(f,l(o).offsetY+l(o).worldHeight)}),Li();var P=al(),I=ge(P),D=M(I,2),_=M(D,2),y=M(_,2),S=M(y,2);U(()=>{ae(I,`height: ${l(d)??""}px; background: ${l(r)??""};`),ae(D,`top: ${l(f)??""}px; background: ${l(r)??""};`),ae(_,`top: ${l(d)??""}px; height: ${l(o),Ft(()=>l(o).worldHeight)??""}px; width: ${l(h)??""}px; background: ${l(r)??""};`),ae(y,`top: ${l(d)??""}px; height: ${l(o),Ft(()=>l(o).worldHeight)??""}px; left: ${l(g)??""}px; background: ${l(r)??""};`),ae(S,`--frame-thickness: 16px; --frame-color: ${l(r)??""}; ${l(c)??""}`)}),v(n,P),ye(),a()}var ol=N("<!> <!>",1),ll=N('<div class="touch-controls"><p class="touch-text">Tap and hold<br/>where you want<br/>to move</p></div>'),cl=N('<div class="desktop-controls"><div class="key-row"><div class="pixel-key">A</div> <div class="pixel-key">W</div> <div class="pixel-key">D</div></div> <p class="or-text">or</p> <div class="key-row"><div class="pixel-key"></div> <div class="pixel-key"></div> <div class="pixel-key"></div></div></div>'),dl=N('<div class="loader-overlay"><div class="pixel-loader"></div></div>'),hl=N('<div class="game-ui-wrapper svelte-1aa1t05"><!> <!> <!> <!> <dialog class="pixel-dialog"><h1>CONTROLS</h1> <div class="controls-content"><!></div></dialog> <!></div>');function ul(n,e){ve(e,!1);const t=()=>L(Nt,"$showControlsDialog",h),s=()=>L(Js,"$hasPlayerMoved",h),i=()=>L(Gi,"$hasSelectedBackground",h),a=()=>L(Yn,"$gameFrameVisible",h),r=()=>L(jn,"$isBuilderMode",h),o=()=>L(zt,"$currentLanguage",h),c=()=>L(Fi,"$isTouchDevice",h),d=()=>L(Gs,"$isLoading",h),[h,g]=Pe();let f=Ve();function P(){const p=wn.toggleLanguage();zt.set(p)}function I(p){!l(f)?.open||p.target.closest(".pixel-button")||Nt.set(!1)}function D(){const p=Ar();if(!p){console.error("Cannot enter builder mode: map config not found");return}$r(p)}qe(()=>(l(f),t()),()=>{l(f)&&(t()?l(f).showModal():l(f).close())}),qe(()=>(s(),l(f),Nt),()=>{s()&&l(f)?.open&&Nt.set(!1)}),Li(),Nn();var _=Ce();Ne("pointerdown",Ln,I);var y=ge(_);{var S=p=>{Jo(p,{})},u=p=>{var C=hl(),w=T(C);{var b=R=>{rl(R,{})};z(w,R=>{a()&&!r()&&R(b)})}var x=M(w,2);{var X=R=>{Zo(R,{})},m=R=>{var K=ol(),Q=ge(K);tl(Q,{});var le=M(Q,2);nl(le,{}),v(R,K)};z(x,R=>{r()?R(X):R(m,!1)})}var E=M(x,2);{var H=R=>{ys(R,{position:"top-left",children:(K,Q)=>{he(K,{variant:"green",width:"120px",onclick:D,title:"Toggle Builder Mode",children:(le,re)=>{var ce=ue("BUILD");v(le,ce)},$$slots:{default:!0}})},$$slots:{default:!0}})};z(E,R=>{r()||R(H)})}var O=M(E,2);{var W=R=>{ys(R,{position:"top-right",children:(K,Q)=>{he(K,{variant:"default",width:"100px",onclick:P,title:"Toggle Language (L)",children:(le,re)=>{var ce=ue();U(Se=>xe(ce,Se),[()=>(o(),Ft(()=>o().toUpperCase()))]),v(le,ce)},$$slots:{default:!0}})},$$slots:{default:!0}})};z(O,R=>{r()||R(W)})}var k=M(O,2),Y=M(T(k),2),G=T(Y);{var ee=R=>{var K=ll();v(R,K)},F=R=>{var K=cl();v(R,K)};z(G,R=>{c()?R(ee):R(F,!1)})}kt(k,R=>$(f,R),()=>l(f));var q=M(k,2);{var te=R=>{var K=dl();v(R,K)};z(q,R=>{d()&&R(te)})}v(p,C)};z(y,p=>{i()?p(u,!1):p(S)})}v(n,_),ye(),g()}wa();const In=document.getElementById("game-ui");if(!In)throw new Error("game-ui element not found!");Rn(ul,{target:In});zt.set(wn.getLanguage());Zs.set(yt.getSkinId());Zi.set(Ke.getCurrentConfig().name);const gl={type:B.AUTO,width:800,height:600,parent:"game-container",backgroundColor:"#000000",pixelArt:!0,roundPixels:!0,scale:{mode:B.Scale.RESIZE,autoCenter:B.Scale.CENTER_BOTH},input:{activePointers:3},physics:{default:"arcade",arcade:{gravity:{y:1e3,x:0},debug:!1}},audio:{noAudio:!0},scene:[]},Ds=new B.Game(gl);Ds.scene.add(Fe.GAME,wr);Ds.scene.add(Fe.BUILDER,Tr);Mr(Ds);const fl=Ds.device.input.touch;Fi.set(fl);const pl=performance.getEntriesByType("navigation")[0]&&performance.getEntriesByType("navigation")[0].type==="reload",ml=sessionStorage.getItem("hasSeenControlsHint");(!ml||pl)&&(sessionStorage.setItem("hasSeenControlsHint","true"),Nt.set(!0));
//# sourceMappingURL=main-CGFBlqY_.js.map
