import{c as kn,u as Mn,a as Ee,r as Ws,b as Kt,d as An,g as o,e as Hn,f as $n,t as On,h as Rn,n as Ge,m as Ke,s as H,i as Ln,M as Lt,j as Yt,P as G,p as Oi,k as Ri,l as Js,o as Nn,q as Je,v as ve,w as me,x as se,y as Be,z as X,A as T,B as M,C as K,D as Tt,E as U,F as Ae,G as ae,H as Pe,I as ne,J as Xe,K as p,L as ye,N as Ie,O as ge,Q as Ut,R as V,S as _s,T as je,U as Ve,V as us,W as he,X as ue,Y as Xn,Z as Wn,_ as Ue,$ as Li,a0 as Yn,a1 as Bn}from"./PixelButton-C9N6GpO-.js";import"./phaser-DFK5Ua9d.js";function Zn(i=!1){const e=kn,t=e.l.u;if(!t)return;let s=()=>Hn(e.s);if(i){let n=0,a={};const r=$n(()=>{let l=!1;const c=e.s;for(const d in c)c[d]!==a[d]&&(a[d]=c[d],l=!0);return l&&n++,n});s=()=>o(r)}t.b.length&&Mn(()=>{gi(e,s),Ws(t.b)}),Ee(()=>{const n=Kt(()=>t.m.map(An));return()=>{for(const a of n)typeof a=="function"&&a()}}),t.a.length&&Ee(()=>{gi(e,s),Ws(t.a)})}function gi(i,e){if(i.l.s)for(const t of i.l.s)o(t);e()}let Ys=Symbol();function N(i,e,t){const s=t[e]??={store:null,source:Ke(void 0),unsubscribe:Ge};if(s.store!==i&&!(Ys in t))if(s.unsubscribe(),s.store=i??null,i==null)s.source.v=void 0,s.unsubscribe=Ge;else{var n=!0;s.unsubscribe=Qs(i,a=>{n?s.source.v=a:H(s.source,a)}),n=!1}return i&&Ys in t?Ze(i):o(s.source)}function xe(){const i={};function e(){On(()=>{for(var t in i)i[t].unsubscribe();Rn(i,Ys,{enumerable:!1,value:!0})})}return[i,e]}function Qs(i,e,t){if(i==null)return e(void 0),t&&t(void 0),Ge;const s=Kt(()=>i.subscribe(e,t));return s.unsubscribe?()=>s.unsubscribe():s}const _t=[];function Gn(i,e){return{subscribe:J(i,e).subscribe}}function J(i,e=Ge){let t=null;const s=new Set;function n(l){if(Ln(i,l)&&(i=l,t)){const c=!_t.length;for(const d of s)d[1](),_t.push(d,i);if(c){for(let d=0;d<_t.length;d+=2)_t[d][0](_t[d+1]);_t.length=0}}}function a(l){n(l(i))}function r(l,c=Ge){const d=[l,c];return s.add(d),s.size===1&&(t=e(n,a)||Ge),l(i),()=>{s.delete(d),s.size===0&&t&&(t(),t=null)}}return{set:n,update:a,subscribe:r}}function Te(i,e,t){const s=!Array.isArray(i),n=s?[i]:i;if(!n.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const a=e.length<2;return Gn(t,(r,l)=>{let c=!1;const d=[];let h=0,m=Ge;const S=()=>{if(h)return;m();const C=e(s?d[0]:d,r,l);a?r(C):m=typeof C=="function"?C:Ge},x=n.map((C,I)=>Qs(C,b=>{d[I]=b,h&=~(1<<I),c&&S()},()=>{h|=1<<I}));return c=!0,S(),function(){Ws(x),m(),c=!1}})}function Ze(i){let e;return Qs(i,t=>e=t)(),e}const Fn=J("#2a1a0a"),zn=J(!0),Ni=J({x:0,y:0});function Kn(i,e){Ni.set({x:i,y:e})}const Un=J({scrollX:0,scrollY:0,zoom:1});function jn(i,e,t=1){Un.set({scrollX:i,scrollY:e,zoom:t})}const ei=J({worldWidth:640,worldHeight:640,offsetX:0,offsetY:0,ready:!1});function Vn(i,e,t,s,n=1){const a=i*n,r=e*n,l=Math.min(a,t),c=Math.min(r,s),d=Math.max(0,(t-l)/2),h=Math.max(0,(s-c)/2);ei.set({worldWidth:l,worldHeight:c,offsetX:d,offsetY:h,ready:!0})}function qn(){ei.set({worldWidth:640,worldHeight:640,offsetX:0,offsetY:0,ready:!1})}const Bs=J(!1);function Jn(){Bs.set(!0),setTimeout(()=>Bs.set(!1),150)}const ti=J(1);function Nt(i){ti.set(i)}const Xi=J(null);function Qn(i,e,t){Xi.set({scrollX:i,scrollY:e,zoom:t})}function ea(){let i=null;return Xi.update(e=>(i=e,null)),i}const Wi=J({scrollX:0,scrollY:0,viewWidth:0,viewHeight:0,worldWidth:0,worldHeight:0,zoom:1,playerX:0,playerY:0});function ta(i){Wi.update(e=>({...e,...i}))}const sa={isActive:!1,config:null,selectedItemId:null,editMode:"items",selectedDialogZoneId:null,selectedSocialId:null,isPlayerSelected:!1},q=J(sa),ia=Te(q,i=>i.isActive),Yi=Te(q,i=>i.config),Oe=Te(q,i=>i.editMode),gs=J(!0);function na(){gs.update(i=>!i)}const ct=J(!1);function Et(i){ct.set(i)}const Zs=J(!1);function Ms(i){Zs.set(i)}function aa(i){q.set({isActive:!0,config:{...i,placedItems:i.placedItems||[],dialogZones:i.dialogZones||[],placedSocials:i.placedSocials||[]},selectedItemId:null,editMode:"items",selectedDialogZoneId:null,selectedSocialId:null,isPlayerSelected:!1}),ti.set(1)}function ra(){q.update(i=>{const e=i.config?{...i.config,dialogZones:(i.config.dialogZones||[]).filter(t=>t.texts.some(s=>s.title.trim()!==""||s.content.trim()!==""))}:i.config;return{...i,isActive:!1,selectedItemId:null,config:e}}),ti.set(1)}function oa(){return Ze(q).config}function Xt(i){q.update(e=>({...e,editMode:i,selectedItemId:null,selectedDialogZoneId:null}))}const Me={BACKGROUND_LAYER_START:-99,GROUND_REFERENCE:-1,DYNAMIC_BASE:100,DYNAMIC_MAX:999,ITEMS_BEHIND:5,PLAYER:10,ITEMS_FRONT:15,FOREGROUND_LAYER_START:1e3,SELECTION_GRAPHICS:1999,GRID_OVERLAY:2e3};function si(i,e){const t=Math.max(0,Math.min(1,i/e)),s=Me.DYNAMIC_MAX-Me.DYNAMIC_BASE;return Math.round(Me.DYNAMIC_BASE+t*s)}function Bi(i){return i==="behind"?Me.ITEMS_BEHIND:Me.ITEMS_FRONT}function Zi(i,e){if(!("getBounds"in i)||typeof i.getBounds!="function")return-1;const s=i.getBounds().bottom,n=si(s,e);return i.setDepth(n),n}const la=[{code:"cs",label:"CZ"},{code:"en",label:"EN"}],Gi="cs",jt=J("cs"),Gs=J("succubus"),Fi=J("Forest"),zi=J(!1),Fs=J(!1),Wt=J(!1),Ki=J(!1),ii=J(!1),at=J(!1),it=J(!1),rt=J(!1),es=J(!1),ts=J(!1),bs=J(!1);function ca(){at.update(i=>!i)}function da(){it.update(i=>!i)}function Ui(){rt.update(i=>!i)}function ji(){es.set(!0)}function ha(){es.set(!1)}function Vi(){ts.set(!0)}function ua(){ts.set(!1)}function qi(){bs.set(!0)}function fi(){bs.set(!1)}const kt=Te(q,i=>i.selectedItemId),ni=Te(q,i=>!i.selectedItemId||!i.config?.placedItems?null:i.config.placedItems.find(e=>e.id===i.selectedItemId)??null),ga=Te(ni,i=>i?.physicsEnabled??!1),fa=Te(ni,i=>i?.flipX??!1),Ji=J(null);function As(i){Ji.set(i)}function pa(i){q.update(e=>{if(!e.config)return e;const t=e.config.placedItems||[];return{...e,config:{...e.config,placedItems:[...t,i]}}})}function fs(i,e){q.update(t=>!t.config||!t.config.placedItems?t:{...t,config:{...t.config,placedItems:t.config.placedItems.map(s=>s.id===i?{...s,...e}:s)}})}function ma(i){q.update(e=>!e.config||!e.config.placedItems?e:{...e,config:{...e.config,placedItems:e.config.placedItems.filter(t=>t.id!==i)},selectedItemId:e.selectedItemId===i?null:e.selectedItemId})}function Is(i){es.set(!1),q.update(e=>({...e,selectedItemId:i,isPlayerSelected:i?!1:e.isPlayerSelected}))}function va(i,e){e?fs(i,{physicsEnabled:e,depth:Bi("behind")}):fs(i,{physicsEnabled:e})}function ya(i,e){fs(i,{flipX:e})}const Vt=Te(q,i=>i.selectedSocialId),Sa=Te(q,i=>i.config?.placedSocials||[]),wa=Te(q,i=>!i.selectedSocialId||!i.config?.placedSocials?null:i.config.placedSocials.find(e=>e.id===i.selectedSocialId)??null),Qi=J(null);function Hs(i){Qi.set(i)}function _a(i){q.update(e=>{if(!e.config)return e;const t=e.config.placedSocials||[];return{...e,config:{...e.config,placedSocials:[...t,i]}}})}function cs(i,e){q.update(t=>!t.config||!t.config.placedSocials?t:{...t,config:{...t.config,placedSocials:t.config.placedSocials.map(s=>s.id===i?{...s,...e}:s)}})}function en(i){q.update(e=>!e.config||!e.config.placedSocials?e:{...e,config:{...e.config,placedSocials:e.config.placedSocials.filter(t=>t.id!==i)},selectedSocialId:e.selectedSocialId===i?null:e.selectedSocialId})}function Bt(i){ts.set(!1),q.update(e=>({...e,selectedSocialId:i,isPlayerSelected:i?!1:e.isPlayerSelected,selectedItemId:i?null:e.selectedItemId}))}const Cs=Te(q,i=>i.selectedDialogZoneId),ai=Te(q,i=>i.config?.dialogZones||[]),tn=J(null);function is(i){tn.set(i)}function ba(i){q.update(e=>{if(!e.config)return e;const t=e.config.dialogZones||[];return{...e,config:{...e.config,dialogZones:[...t,i]}}})}function It(i,e){q.update(t=>!t.config||!t.config.dialogZones?t:{...t,config:{...t.config,dialogZones:t.config.dialogZones.map(s=>s.id===i?{...s,...e}:s)}})}function sn(i){q.update(e=>!e.config||!e.config.dialogZones?e:{...e,config:{...e.config,dialogZones:e.config.dialogZones.filter(t=>t.id!==i)},selectedDialogZoneId:e.selectedDialogZoneId===i?null:e.selectedDialogZoneId})}function Zt(i){q.update(e=>({...e,selectedDialogZoneId:i}))}function Ia(i,e,t){q.update(s=>!s.config||!s.config.dialogZones?s:{...s,config:{...s.config,dialogZones:s.config.dialogZones.map(n=>{if(n.id!==i)return n;const a=n.texts.findIndex(l=>l.language===e);let r;return a>=0?r=n.texts.map((l,c)=>c===a?{...l,...t}:l):r=[...n.texts,{language:e,title:"",content:"",...t}],{...n,texts:r}})}})}const pi=Te(q,i=>i.isPlayerSelected);function mi(i,e){q.update(t=>t.config?{...t,config:{...t.config,playerStartX:i,playerStartY:e}}:t)}function Ca(i){q.update(e=>({...e,isPlayerSelected:i,selectedItemId:null}))}function Ht(){q.update(i=>({...i,selectedItemId:null,selectedDialogZoneId:null,selectedSocialId:null,isPlayerSelected:!1}))}const ri=Te(q,i=>!i.selectedItemId||!i.config?.placedNPCs?null:i.config.placedNPCs.find(e=>e.id===i.selectedItemId)??null),Pa=Te(ri,i=>i?.flipX??!1),nn=J(null);function ns(i){nn.set(i)}function xa(i){q.update(e=>{if(!e.config)return e;const t=e.config.placedNPCs||[];return{...e,config:{...e.config,placedNPCs:[...t,i]},isDirty:!0}})}function oi(i,e){q.update(t=>{if(!t.config?.placedNPCs)return t;const s=t.config.placedNPCs.map(n=>n.id===i?{...n,...e}:n);return{...t,config:{...t.config,placedNPCs:s},isDirty:!0}})}function Ea(i,e,t){q.update(s=>{if(!s.config?.placedNPCs)return s;const n=s.config.placedNPCs.map(a=>{if(a.id!==i)return a;const r=a.dialog||[],l=r.findIndex(d=>d.language===e);let c;return l>=0?(c=[...r],c[l]={...c[l],...t}):c=[...r,{language:e,title:"",content:t.content??""}],{...a,dialog:c}});return{...s,config:{...s.config,placedNPCs:n},isDirty:!0}})}function Da(i,e){oi(i,{flipX:e})}function an(i){q.update(e=>{if(!e.config?.placedNPCs)return e;const t=e.config.placedNPCs.filter(n=>n.id!==i),s=e.selectedItemId===i?null:e.selectedItemId;return{...e,selectedItemId:s,config:{...e.config,placedNPCs:t},isDirty:!0}})}let rn=!1,Ct=!1;function as(i){rn=i}function vi(){return rn}function wt(){return Ct}function $s(i){if(!i||i.tagName==="CANVAS")return!1;if(i.closest("[data-ui]"))return!0;const e=document.getElementById("game-ui");return!!(e&&e.contains(i)||i.closest("button"))}function Ta(){document.addEventListener("pointerdown",i=>{Ct=$s(i.target)},{capture:!0}),document.addEventListener("pointermove",i=>{i.buttons>0||(Ct=$s(i.target))},{capture:!0}),document.addEventListener("pointerup",()=>{setTimeout(()=>{Ct=!1},10)},{capture:!0}),document.addEventListener("touchstart",i=>{Ct=$s(i.target)},{capture:!0,passive:!0}),document.addEventListener("touchend",()=>{setTimeout(()=>{Ct=!1},10)},{capture:!0,passive:!0})}function Os(){const i=document.activeElement;if(!i)return!1;const e=i.tagName.toUpperCase();return e==="INPUT"||e==="TEXTAREA"||i.getAttribute("contenteditable")==="true"}function yt(i,e,t){const s=(i-t.worldView.x)*t.zoom,n=(e-t.worldView.y)*t.zoom;return{screenX:s,screenY:n}}function ka(i,e,t){const s=i/t.zoom+t.worldView.x,n=e/t.zoom+t.worldView.y;return{worldX:s,worldY:n}}const on={campfire:{frameWidth:32,frameHeight:32,frameRate:10,repeat:-1,endFrame:39}},li=[{key:"campfire",name:"Campfire",path:"assets/items/campfire.png",scale:5,group:"shared",category:"props"},{key:"stones_0",name:"Stones 0",path:"assets/items/stones_0.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_1",name:"Stones 1",path:"assets/items/stones_1.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_3",name:"Stones 3",path:"assets/items/stones_3.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_4",name:"Stones 4",path:"assets/items/stones_4.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"barell",name:"Barrel",path:"assets/items/barell.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"box",name:"Box",path:"assets/items/box.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"chair",name:"Chair",path:"assets/items/chair.png",scale:4,group:"shared",category:"furniture"},{key:"stool",name:"Stool",path:"assets/items/stool.png",scale:4,group:"shared",category:"furniture"},{key:"table_small",name:"Table Small",path:"assets/items/table_small.png",scale:4,group:"shared",category:"furniture"},{key:"table_full",name:"Table Full",path:"assets/items/table_full.png",scale:4,group:"forest_summer",category:"furniture"},{key:"kettle",name:"Kettle",path:"assets/items/kettle.png",scale:4,group:"shared",category:"props"},{key:"log_axe",name:"Log with Axe",path:"assets/items/log_axe.png",scale:4,group:"shared",category:"props"},{key:"log_chisel",name:"Log with Chisel",path:"assets/items/log_chisel.png",scale:4,group:"shared",category:"props"},{key:"apple_basket",name:"Apple Basket",path:"assets/items/apple_basket.png",scale:4,group:"shared",category:"props"},{key:"apples",name:"Apples",path:"assets/items/apples.png",scale:4,group:"forest_summer",category:"props"},{key:"pumpkin",name:"Pumpkin",path:"assets/items/pumpkin.png",scale:4,group:"forest_summer",category:"nature"},{key:"pumpkin_helloween",name:"Pumpkin Halloween",path:"assets/items/pumpkin_helloween.png",scale:4,group:"forest_summer",category:"props"},{key:"scarecrow",name:"Scarecrow",path:"assets/items/scarecrow.png",scale:4,group:"forest_summer",category:"props"},{key:"sign_skogen",name:"Sign Skogen",path:"assets/items/sign_skogen.png",scale:4,group:"forest_shared",category:"props"},{key:"statue",name:"Statue",path:"assets/items/statue.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"wall",name:"Wall",path:"assets/items/wall.png",scale:4,group:"forest_summer",category:"structures"},{key:"hanger",name:"Hanger",path:"assets/items/hanger.png",scale:4,group:"forest_summer",category:"furniture"},{key:"cauldron_campfire",name:"Cauldron Campfire",path:"assets/items/cauldron_campfire.png",scale:4,group:"shared",category:"props"},{key:"ore_copper",name:"Ore Copper",path:"assets/items/ore_copper.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_dia",name:"Ore Diamond",path:"assets/items/ore_dia.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_gold",name:"Ore Gold",path:"assets/items/ore_gold.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_tin",name:"Ore Tin",path:"assets/items/ore_tin.png",scale:4,group:"cave_dark",category:"nature"},{key:"tent_large",name:"Tent Large",path:"assets/items/tent_large.png",scale:4,group:"forest_summer",category:"structures"},{key:"tent",name:"Tent Small",path:"assets/items/tent.png",scale:4,group:"forest_summer",category:"structures"},{key:"bush_0",name:"Bush 0",path:"assets/items/bush_0.png",scale:4,group:"forest_summer",category:"nature"},{key:"bush_1",name:"Bush 1",path:"assets/items/bush_1.png",scale:4,group:"forest_summer",category:"nature"},{key:"bush_2",name:"Bush 2",path:"assets/items/bush_2.png",scale:4,group:"forest_summer",category:"nature"},{key:"grass",name:"Grass",path:"assets/items/grass.png",scale:4,group:"forest_summer",category:"nature"},{key:"grass_0",name:"Grass 0",path:"assets/items/grass_0.png",scale:4,group:"forest_summer",category:"nature"},{key:"tree_picea",name:"Tree Picea",path:"assets/items/tree_picea.png",scale:4,group:"forest_summer",category:"nature"},{key:"tree_pinus",name:"Tree Pinus",path:"assets/items/tree_pinus.png",scale:4,group:"forest_summer",category:"nature"},{key:"grave_0",name:"Grave 0",path:"assets/items/grave_0.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_1",name:"Grave 1",path:"assets/items/grave_1.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_2",name:"Grave 2",path:"assets/items/grave_2.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_3",name:"Grave 3",path:"assets/items/grave_3.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_4",name:"Grave 4",path:"assets/items/grave_4.png",scale:4,group:"forest_shared",category:"props"},{key:"icebush_0",name:"Ice Bush 0",path:"assets/items/icebush_0.png",scale:4,group:"forest_birch",category:"nature"},{key:"icebush_1",name:"Ice Bush 1",path:"assets/items/icebush_1.png",scale:4,group:"forest_birch",category:"nature"},{key:"icebush_2",name:"Ice Bush 2",path:"assets/items/icebush_2.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_0",name:"Ice Stones 0",path:"assets/items/icestones_0.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_1",name:"Ice Stones 1",path:"assets/items/icestones_1.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_2",name:"Ice Stones 2",path:"assets/items/icestones_2.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_3",name:"Ice Stones 3",path:"assets/items/icestones_3.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_4",name:"Ice Stones 4",path:"assets/items/icestones_4.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_5",name:"Ice Stones 5",path:"assets/items/icestones_5.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_6",name:"Ice Stones 6",path:"assets/items/icestones_6.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_7",name:"Ice Stones 7",path:"assets/items/icestones_7.png",scale:4,group:"forest_birch",category:"nature"},{key:"snow_pile",name:"Snow Pile",path:"assets/items/snow_pile.png",scale:4,group:"forest_birch",category:"nature"}];function ln(i){return li.find(e=>e.key===i)}function Ma(i){return ln(i)?.scale||1}function zs(i){return i in on}function Ks(i){return on[i]}function Aa(i){return ln(i)?.supportsPhysics??!1}class yi{scene;groundY;constructor(e,t){this.scene=e,this.groundY=t}static preloadAssets(e){li.forEach(t=>{if(zs(t.key)){const s=Ks(t.key);s&&e.load.spritesheet(t.key,t.path,{frameWidth:s.frameWidth,frameHeight:s.frameHeight})}else e.load.image(t.key,t.path)})}createSprite(e){const{id:t,assetKey:s,x:n,scale:a=1,depth:r=5,yOffset:l=0,flipX:c=!1}=e,d=this.groundY+l,h=this.scene.add.sprite(n,d,s);if(h.setScale(a),h.setDepth(r),h.setFlipX(c),h.setData("itemId",t),zs(s)){const m=`${s}_anim`,S=Ks(s);S&&(this.scene.anims.exists(m)||this.scene.anims.create({key:m,frames:this.scene.anims.generateFrameNumbers(s,{start:S.startFrame??0,end:S.endFrame}),frameRate:S.frameRate??8,repeat:S.repeat??-1}),h.play(m))}return h}updatePosition(e,t,s){e.x=t,e.y=this.groundY+s}updateScale(e,t){e.setScale(t)}updateDepth(e,t){e.setDepth(t)}applyUpdates(e,t){t.x!==void 0&&(e.x=t.x),t.yOffset!==void 0&&(e.y=this.groundY+t.yOffset),t.scale!==void 0&&e.setScale(t.scale),t.depth!==void 0&&e.setDepth(t.depth),t.flipX!==void 0&&e.setFlipX(t.flipX)}worldYToOffset(e){return e-this.groundY}getGroundY(){return this.groundY}}function Pt(i){return parseInt(i.replace("#",""),16)}const mt={BLUE:"#4a90e2",GREEN:"#27ae60",PURPLE:"#9b59b6",TEAL:"#1abc9c",PINK:"#e91e8f"},Ps={ITEM:{hex:Pt(mt.BLUE)},FRAME:{hex:Pt(mt.PURPLE)},SOCIAL:{css:mt.PINK,hex:Pt(mt.PINK)},DIALOG_ZONE:{hex:Pt(mt.TEAL)},PLAYER:{hex:Pt(mt.GREEN)}},cn=Pt(mt.BLUE),dn=240,Ha=48;function ds(i){const e=`assets/skins/static/${i.folder}`;return i.variant?`${e}/${i.variant}`:e}function Gt(i){if(i.scale!==void 0)return i.scale;const e=i.frameHeight??Ha;return dn/e}const Ce=[{id:"succubus",name:"SUCCUBUS",folder:"succubus",variant:"basic",character:"human",frameWidth:156,frameHeight:72,facingLeft:!0,frameRates:{idle:8,run:12}}],hn="succubus";class $a{currentSkinId=hn;constructor(){this.loadFromStorage()}loadFromStorage(){const e=localStorage.getItem("playerSkin");e&&this.isValidSkinId(e)&&(this.currentSkinId=e)}isValidSkinId(e){return Ce.some(t=>t.id===e)}setSkin(e){this.isValidSkinId(e)&&(this.currentSkinId=e,localStorage.setItem("playerSkin",e))}getSkinId(){return this.currentSkinId}getSkinConfig(){return Ce.find(e=>e.id===this.currentSkinId)||Ce[0]}getSkinById(e){return Ce.find(t=>t.id===e)}getAllSkins(){return Ce}getAnimationPrefix(){const e=this.getSkinConfig();return`${e.character}-${e.id}`}}const St=new $a,Ft={DEPTH:Me.PLAYER},Oa={HALF_HEIGHT:dn/2},ot={FRAME_WIDTH:Lt.WIDTH,FRAME_HEIGHT:Lt.HEIGHT,WIDTH:Lt.WIDTH*Yt,HEIGHT:Lt.HEIGHT*Yt,HALF_HEIGHT:Lt.HEIGHT*Yt/2},qe=40;function un(i,e=qe){return i-e}function Mt(i,e=qe){return un(i,e)-Oa.HALF_HEIGHT}function Ra(i,e,t=qe){const s=Mt(e,t);return i>s}function qt(i,e=qe){return un(i,e)-ot.HALF_HEIGHT}function La(i,e,t=qe){const s=qt(e,t);return i>s}const Rs={WIDTH:.33,HEIGHT:.25,OFFSET_Y:.75},Si={WIDTH:.4,HEIGHT:.3},Us={WIDTH:.6};function Na(i,e){const t=Math.round(i*Rs.WIDTH),s=Math.round(e*Rs.HEIGHT),n=Math.round((i-t)/2),a=Math.round(e*Rs.OFFSET_Y);return{width:t,height:s,offsetX:n,offsetY:a}}function Xa(){const i=Math.round(ot.WIDTH*Si.WIDTH),e=Math.round(ot.HEIGHT*Si.HEIGHT),t=-i/2,s=ot.HEIGHT/2-e;return{width:i,height:e,offsetX:t,offsetY:s}}const xt=50,Wa=4871528,Ya=.4,Ba=1,gn=Me.GRID_OVERLAY,Ls=16711680,Za=2,Ga=.6,Fa=.1,za=1,Ka=.2,wi=50,Ua=50,ja=cn,Va=()=>{try{return!1}catch{return!1}},_i=Va(),bi=65280,qa=.1,Ja=1,Qa=.3,er=.2,tr=2,sr=.8;class fn{lastClickTime=0;lastClickId=null;threshold;constructor(e=300){this.threshold=e}check(e){const t=Date.now(),s=this.lastClickId===e&&t-this.lastClickTime<this.threshold;return this.lastClickTime=t,this.lastClickId=e,s}reset(){this.lastClickTime=0,this.lastClickId=null}}function rs(i,e){return Math.round(i/e)*e}function xs(i){const{sprite:e,scene:t,callbacks:s={},constraints:n,useGridSnapping:a=!0,cursor:r="grab",hitArea:l}=i;let c=!1,d=0,h=0,m=0;if(l){if(e.setInteractive(l,G.Geom.Rectangle.Contains),e.input){const u=e.input;u.cursor=r,u.useHandCursor=!0}}else e.setInteractive({useHandCursor:!0,cursor:r});const S=(u,g)=>{const P=e.getBounds(),f=5;return u>=P.x-f&&u<=P.x+P.width+f&&g>=P.y-f&&g<=P.y+P.height+f},x=()=>{const u=t.data.get("lastTapTime");if(!u||u===m||Date.now()-u>100)return;m=u;const g=t.data.get("lastTapWorldX"),P=t.data.get("lastTapWorldY");S(g,P)&&s.onSelect?.()},C=u=>{if(u.wasTouch||Ze(Zs)||wt()||c||s.onDoubleClick?.())return;const g=s.isSelected?.()??!1;s.onSelect?.(),g&&(c=!0,t.data.set("isDraggingItem",!0),Et(!0),d=e.x-u.worldX,h=e.y-u.worldY,s.onDragStart?.())},I=u=>{if(u.wasTouch){const f=t.data.get("touchDragStarted");if(!c&&f&&s.isSelected?.()){const D=t.data.get("touchStartWorldX"),W=t.data.get("touchStartWorldY"),y=e.getBounds(),k=10;D>=y.x-k&&D<=y.x+y.width+k&&W>=y.y-k&&W<=y.y+y.height+k&&(c=!0,t.data.set("isDraggingItem",!0),t.data.set("touchDragStarted",!1),Et(!0),d=e.x-D,h=e.y-W,s.onDragStart?.())}if(c){let _=u.worldX+d,D=u.worldY+h;a&&Ze(gs)&&(_=rs(_,xt),D=rs(D,xt)),n&&(n.minX!==void 0&&(_=Math.max(_,n.minX)),n.maxX!==void 0&&(_=Math.min(_,n.maxX)),n.minY!==void 0&&(D=Math.max(D,n.minY)),n.maxY!==void 0&&(D=Math.min(D,n.maxY))),e.setPosition(_,D),s.onDrag?.(_,D)}return}if(!c)return;if(Ze(Zs)){v();return}if(!u.isDown){v();return}let g=u.worldX+d,P=u.worldY+h;a&&Ze(gs)&&(g=rs(g,xt),P=rs(P,xt)),n&&(n.minX!==void 0&&(g=Math.max(g,n.minX)),n.maxX!==void 0&&(g=Math.min(g,n.maxX)),n.minY!==void 0&&(P=Math.max(P,n.minY)),n.maxY!==void 0&&(P=Math.min(P,n.maxY))),e.setPosition(g,P),s.onDrag?.(g,P)},b=()=>{c&&v()},v=()=>{c=!1,t.data.set("isDraggingItem",!1),Et(!1),s.onDragEnd?.(e.x,e.y)};e.on("pointerdown",C),t.input.on("pointermove",I),t.input.on("pointerup",b);const w=()=>{x()};return t.events.on("update",w),()=>{e.off("pointerdown",C),t.input.off("pointermove",I),t.input.off("pointerup",b),t.events.off("update",w)}}class ir{scene;groundY;worldWidth;worldHeight;isDragging=!1;callbacks;cleanupFunctions=new Map;constructor(e,t,s,n,a={}){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=n,this.callbacks=a}getIsDragging(){return this.isDragging}makeInteractive(e,t){const s=xs({sprite:e,scene:this.scene,cursor:"pointer",constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{Is(t),this.callbacks.onSelect?.(t)},isSelected:()=>Ze(kt)===t,onDragStart:()=>{this.isDragging=!0,e.setTint(cn),this.callbacks.onDragStart?.(t)},onDrag:(n,a)=>{this.callbacks.onDrag?.(t,n,a)},onDragEnd:(n,a)=>{e.clearTint(),this.isDragging=!1;const r=Math.round(n),c=Math.round(a)-this.groundY;fs(t,{x:r,yOffset:c}),this.callbacks.onDragEnd?.(t,r,c)}}});this.cleanupFunctions.set(t,s)}removeInteractivity(e){if(!e||!e.scene)return;const t=e.getData("itemId");t&&this.cleanupFunctions.has(t)&&(this.cleanupFunctions.get(t)(),this.cleanupFunctions.delete(t)),e.removeInteractive()}destroy(){this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear()}}const nt={ITEM:"itemId",SOCIAL:"socialId",NPC:"npcId",PLAYER:"isPlayer",ZONE:"zoneId"},nr={[nt.ITEM]:"selectedItemId",[nt.SOCIAL]:"selectedSocialId",[nt.NPC]:"selectedItemId",[nt.PLAYER]:"isPlayerSelected"};function pn(i){return typeof i.getData=="function"}function ar(i){return pn(i)?i.type==="Rectangle"?!!i.getData(nt.ZONE):Object.values(nt).some(e=>e===nt.ZONE?!1:!!i.getData(e)):!1}function rr(i,e){if(!pn(i))return!1;for(const[t,s]of Object.entries(nr)){const n=i.getData(t);if(n)if(t===nt.PLAYER){const a=e.data.get(s),r=e.data.get("playerSprite");if(a&&i===r)return!0}else{const a=e.data.get(s);if(n===a)return!0}}return!1}function or(i,e){const t=i.input.hitTestPointer(e);for(const s of t)if(rr(s,i))return!0;return!1}const lr={lineWidth:3,lineColor:Ps.ITEM.hex,lineAlpha:1,padding:5};class cr{scene;graphics;style;selectedId=null;constructor(e,t={}){this.scene=e,this.style={...lr,...t},this.graphics=e.add.graphics(),this.graphics.setDepth(Me.SELECTION_GRAPHICS)}setSelectedId(e){this.selectedId=e}getSelectedId(){return this.selectedId}updateVisuals(e){if(this.graphics.clear(),!e||!this.selectedId)return;const t=e.getBounds(),{lineWidth:s,lineColor:n,lineAlpha:a,padding:r}=this.style;this.graphics.lineStyle(s,n,a),this.graphics.strokeRect(t.x-r,t.y-r,t.width+r*2,t.height+r*2)}clearVisuals(){this.graphics.clear(),this.selectedId=null}setupBackgroundDeselect(e){this.scene.input.on("pointerdown",t=>{if(wt()||e())return;this.scene.input.hitTestPointer(t).find(a=>ar(a))||(Ht(),this.clearVisuals())})}destroy(){this.graphics?.destroy()}}class zt{scene;items=new Map;isBuilderMode=!1;physicsGroup=null;renderer;dragController;selectionManager;constructor(e,t,s,n,a=!1){this.scene=e,this.isBuilderMode=a,this.renderer=new yi(e,t),a||(this.physicsGroup=e.physics.add.staticGroup()),this.isBuilderMode&&(this.dragController=new ir(e,t,s,n,{onSelect:()=>this.updateSelectionVisuals(),onDrag:()=>this.updateSelectionVisuals()}),this.selectionManager=new cr(e))}static preloadAssets(e){yi.preloadAssets(e)}createItems(e){e.forEach(t=>{this.createItem(t)})}createItem(e){const t=this.renderer.createSprite(e),s={sprite:t,data:e};if(!this.isBuilderMode&&e.physicsEnabled&&this.physicsGroup){const n=this.createPhysicsBody(t,e);s.physicsBody=n}this.items.set(e.id,s),this.isBuilderMode&&this.dragController&&this.dragController.makeInteractive(t,e.id)}createPhysicsBody(e,t){const s=e.getBounds(),n=s.width*.5,a=s.height*.8,r=e.x,l=e.y,c=this.scene.add.rectangle(r,l,n,a);return c.setVisible(!1),this.physicsGroup.add(c),c.setData("itemId",t.id),c}updateSelectionVisuals(){if(!this.selectionManager)return;const e=this.scene.data.get("selectedItemId");if(this.selectionManager.setSelectedId(e),!e){this.selectionManager.clearVisuals(),As(null);return}const t=this.items.get(e);if(this.selectionManager.updateVisuals(t?.sprite??null),t?.sprite){const s=this.scene.cameras.main,n=t.sprite.getBounds(),{screenX:a,screenY:r}=yt(n.centerX,n.centerY,s),l=n.height*s.zoom;As({screenX:a,screenY:r,itemHeight:l})}else As(null)}updateItem(e,t){const s=this.items.get(e);s&&(this.renderer.applyUpdates(s.sprite,t),s.data={...s.data,...t})}removeItem(e){const t=this.items.get(e);t&&(this.dragController&&this.dragController.removeInteractivity(t.sprite),t.physicsBody&&t.physicsBody.destroy(),t.sprite.destroy(),this.items.delete(e))}removeAllItems(){this.items.forEach(e=>{!e.sprite||!e.sprite.scene||(this.dragController&&this.dragController.removeInteractivity(e.sprite),e.physicsBody&&e.physicsBody.destroy(),e.sprite.destroy())}),this.items.clear()}getItem(e){return this.items.get(e)?.data}getAllItems(){return Array.from(this.items.values()).map(e=>e.data)}getPhysicsGroup(){return this.physicsGroup}setInteractiveEnabled(e){!this.isBuilderMode||!this.dragController||(this.items.forEach(({sprite:t,data:s})=>{e?(this.dragController.makeInteractive(t,s.id),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectionManager&&this.selectionManager.clearVisuals())}updateAutoDepth(e){this.items.forEach(({sprite:t,data:s})=>{if(s.physicsEnabled){t.setDepth(Me.DYNAMIC_BASE);return}const a=t.getBounds().bottom,r=si(a,e);t.setDepth(r)})}destroy(){this.removeAllItems(),this.selectionManager?.destroy()}setupBackgroundDeselect(){!this.isBuilderMode||!this.selectionManager||this.selectionManager.setupBackgroundDeselect(()=>this.dragController?.getIsDragging()??!1)}}const ci=[{id:"beggar",name:"Beggar",path:"assets/npcs/humans/beggar.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"crusader",name:"Crusader",path:"assets/npcs/humans/crusader.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"dealer",name:"Dealer",path:"assets/npcs/humans/dealer.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"female_wizard",name:"Female Wizard",path:"assets/npcs/humans/female_wizard.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:9,frameRate:8}}},{id:"lady_christmas",name:"Lady Christmas",path:"assets/npcs/humans/lady_christmas.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"lady_drunk",name:"Lady Drunk",path:"assets/npcs/humans/lady_drunk.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:5,frameRate:8}}},{id:"lovers",name:"Lovers",path:"assets/npcs/humans/lovers.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:6,frameRate:8}}},{id:"mage",name:"Mage",path:"assets/npcs/humans/mage.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"medieval_servant",name:"Medieval Servant",path:"assets/npcs/humans/medieval_servant.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"town_crier",name:"Town Crier",path:"assets/npcs/humans/town_crier.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:8,frameRate:8}}},{id:"wounded_knight",name:"Wounded Knight",path:"assets/npcs/humans/wounded_knight.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"demon_old",name:"Demon",path:"assets/npcs/fantasy/demon_old.png",category:"fantasy",frameWidth:80,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:6,frameRate:8}}},{id:"fairy",name:"Fairy",path:"assets/npcs/fantasy/fairy.png",category:"fantasy",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:7,frameRate:8}}},{id:"snowman_couple",name:"Snowman Couple",path:"assets/npcs/fantasy/snowman_couple.png",category:"fantasy",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:9,frameRate:8}}},{id:"toad",name:"Toad",path:"assets/npcs/fantasy/toad.png",category:"fantasy",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:11,frameRate:8}}},{id:"toad_wizard",name:"Toad Wizard",path:"assets/npcs/fantasy/toad_wizard.png",category:"fantasy",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}}];function ps(i){return ci.find(e=>e.id===i)}class dr{npc;constructor(e){this.npc=e}}class hr extends dr{enter(){const e=`${this.npc.npcId}_idle`;this.npc.anims.exists(e)&&this.npc.play(e,!0),this.npc.setVelocity(0,0)}update(e,t){}exit(){}}class vt extends G.Physics.Arcade.Sprite{id;npcId;dialogData;_triggerRadius;selectionIndicator;radiusIndicator;_isSelected=!1;isBuilderMode;_topOffset=0;currentState;static DEFAULT_TRIGGER_RADIUS=200;static HITBOX_WIDTH_FACTOR=.5;static HITBOX_HEIGHT_FACTOR=.9;constructor(e,t,s=!1){const n=ps(t.npcId);if(!n)throw new Error(`NPC definition not found for id: ${t.npcId}`);super(e,t.x,t.y,t.npcId),this.id=t.id,this.npcId=t.npcId,this.dialogData=t.dialog,this._triggerRadius=t.triggerRadius??vt.DEFAULT_TRIGGER_RADIUS,this.isBuilderMode=s,e.add.existing(this),e.physics.add.existing(this);const a=t.scale??n.scale;this.setScale(a),this.setFlipX(t.flipX??!1),this._topOffset=(n.topOffset??0)*a,this.setImmovable(!0),this.body.setAllowGravity(!1),this.setupHitbox(n),this.isBuilderMode||(this.setupAnimations(n),this.setNPCState(new hr(this)))}setNPCState(e){this.currentState&&this.currentState.exit(),this.currentState=e,this.currentState.enter()}preUpdate(e,t){super.preUpdate(e,t),this.currentState&&this.currentState.update(e,t)}setupHitbox(e){const t=e.topOffset??0,s=e.frameHeight-t,n=e.frameWidth*vt.HITBOX_WIDTH_FACTOR,a=s*vt.HITBOX_HEIGHT_FACTOR;this.body?.setSize(n,a),this.body?.setOffset((e.frameWidth-n)/2,t+(s-a));const r=(e.frameWidth-n)/2,l=t+(s-a);this.setInteractive({hitArea:new G.Geom.Rectangle(r,l,n,a),hitAreaCallback:G.Geom.Rectangle.Contains,cursor:"pointer"})}setupAnimations(e){if(!e.animations)return;const t=`${this.npcId}_idle`;this.scene.anims.exists(t)||this.scene.anims.create({key:t,frames:this.scene.anims.generateFrameNumbers(this.npcId,{start:e.animations.idle.startFrame,end:e.animations.idle.endFrame}),frameRate:e.animations.idle.frameRate,repeat:-1})}updateDialog(e){this.dialogData=e}getDialogData(){return this.dialogData}getContentHeight(){return this.displayHeight-this._topOffset}get topOffset(){return this._topOffset}get triggerRadius(){return this._triggerRadius}setTriggerRadius(e){this._triggerRadius=e,this.radiusIndicator&&this.radiusIndicator.setRadius(e)}setFlipped(e){this.setFlipX(e)}getHitboxDimensions(){const e=ps(this.npcId);if(!e)return{width:this.displayWidth,height:this.displayHeight,offsetY:0};const t=this.scaleX,s=e.topOffset??0,n=e.frameHeight-s,a=e.frameWidth*vt.HITBOX_WIDTH_FACTOR*t,r=n*vt.HITBOX_HEIGHT_FACTOR*t,l=s*t/2;return{width:a,height:r,offsetY:l}}get isSelected(){return this._isSelected}setSelected(e){if(this.scene?.add)if(this._isSelected=e,e){const t=this.getHitboxDimensions();this.selectionIndicator||(this.selectionIndicator=this.scene.add.rectangle(this.x,this.y+t.offsetY,t.width+8,t.height+8,15105570,0),this.selectionIndicator.setStrokeStyle(3,15105570,1),this.selectionIndicator.setDepth(this.depth-1)),this.radiusIndicator||(this.radiusIndicator=this.scene.add.circle(this.x,this.y,this._triggerRadius,15105570,.15),this.radiusIndicator.setStrokeStyle(2,15105570,.5),this.radiusIndicator.setDepth(this.depth-2))}else this.selectionIndicator&&(this.selectionIndicator.destroy(),this.selectionIndicator=void 0),this.radiusIndicator&&(this.radiusIndicator.destroy(),this.radiusIndicator=void 0)}updateSelectionIndicator(){if(this.selectionIndicator&&this._isSelected){const e=this.getHitboxDimensions();this.selectionIndicator.setPosition(this.x,this.y+e.offsetY),this.selectionIndicator.setSize(e.width+8,e.height+8)}this.radiusIndicator&&this._isSelected&&(this.radiusIndicator.setPosition(this.x,this.y),this.radiusIndicator.setRadius(this._triggerRadius))}destroy(e){this.selectionIndicator&&(this.selectionIndicator.destroy(),this.selectionIndicator=void 0),this.radiusIndicator&&(this.radiusIndicator.destroy(),this.radiusIndicator=void 0),super.destroy(e)}}class ur{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set);const s=this.listeners.get(e);return s.add(t),{unsubscribe:()=>{s.delete(t),s.size===0&&this.listeners.delete(e)}}}once(e,t){const s=this.on(e,n=>{s.unsubscribe(),t(n)});return s}emit(e,t){const s=this.listeners.get(e);s&&s.forEach(n=>{try{n(t)}catch(a){console.error(`[EventBus] Error in listener for "${e}":`,a)}})}off(e){this.listeners.delete(e)}clear(){this.listeners.clear()}listenerCount(e){return this.listeners.get(e)?.size??0}}const De=new ur,be={ASSET_DROPPED:"asset:dropped",SOCIAL_DROPPED:"social:dropped",MINIMAP_NAVIGATE:"minimap:navigate",DIALOG_ZONE_CREATE:"dialogZone:create",DIALOG_ZONE_CREATE_AT:"dialogZone:createAt",NPC_DROPPED:"npc:dropped",NPC_SELECTED:"npc:selected",TEMP_ZONE_BUTTON_SHOW:"tempZoneButton:show",TEMP_ZONE_BUTTON_HIDE:"tempZoneButton:hide"};class Jt{scene;npcs=new Map;isBuilderMode;worldWidth;worldHeight;selectedNPCId=null;unsubscribers=[];cleanupFunctions=new Map;doubleClickDetector=new fn;constructor(e,t,s,n,a=!1){if(this.scene=e,this.worldWidth=s,this.worldHeight=n,this.isBuilderMode=a,a){const r=kt.subscribe(l=>{this.handleSelectionChange(l)});this.unsubscribers.push(r)}}static preloadAssets(e){ci.forEach(t=>{e.load.spritesheet(t.id,t.path,{frameWidth:t.frameWidth,frameHeight:t.frameHeight})})}createNPCs(e){e.forEach(t=>this.createNPC(t))}createNPC(e){const t=new vt(this.scene,e,this.isBuilderMode);this.npcs.set(e.id,t),this.isBuilderMode&&this.makeInteractive(t)}makeInteractive(e){e.setData("npcId",e.id);const t=xs({sprite:e,scene:this.scene,cursor:"pointer",constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{Is(e.id),De.emit(be.NPC_SELECTED,e.id)},isSelected:()=>Ze(kt)===e.id,onDoubleClick:()=>this.doubleClickDetector.check(e.id)?(ji(),!0):!1,onDragStart:()=>{},onDrag:(s,n)=>{e.updateSelectionIndicator()},onDragEnd:(s,n)=>{oi(e.id,{x:Math.round(s),y:Math.round(n)})}}});this.cleanupFunctions.set(e.id,t)}removeNPC(e){const t=this.npcs.get(e);if(t){const s=this.cleanupFunctions.get(e);s&&(s(),this.cleanupFunctions.delete(e)),t.destroy(),this.npcs.delete(e)}}updateNPC(e,t){const s=this.npcs.get(e);s&&(t.x!==void 0&&(s.x=t.x),t.y!==void 0&&(s.y=t.y),t.flipX!==void 0&&s.setFlipped(t.flipX),t.dialog!==void 0&&s.updateDialog(t.dialog),t.scale!==void 0&&s.setScale(t.scale),t.triggerRadius!==void 0&&s.setTriggerRadius(t.triggerRadius))}getNPC(e){return this.npcs.get(e)}getAllNPCs(){return Array.from(this.npcs.values())}handleSelectionChange(e){if(this.selectedNPCId&&this.selectedNPCId!==e){const s=this.npcs.get(this.selectedNPCId);s&&s.setSelected(!1)}const t=e?this.npcs.get(e):null;t?(t.setSelected(!0),this.selectedNPCId=e,this.updateNPCScreenPosition(t)):(this.selectedNPCId=null,ns(null))}updateNPCScreenPosition(e){const t=this.scene.cameras.main,{screenX:s,screenY:n}=yt(e.x,e.y,t),a=e.displayHeight*t.zoom;ns({screenX:s,screenY:n,npcHeight:a})}update(){if(this.selectedNPCId){const e=this.npcs.get(this.selectedNPCId);e&&(e.updateSelectionIndicator(),this.updateNPCScreenPosition(e))}}setInteractiveEnabled(e){if(this.isBuilderMode&&(this.npcs.forEach(t=>{e?(t.setInteractive({cursor:"pointer"}),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectedNPCId)){const t=this.npcs.get(this.selectedNPCId);t&&t.setSelected(!1),this.selectedNPCId=null,ns(null)}}updateAutoDepth(e){this.npcs.forEach(t=>{const s=t.y+t.displayHeight/2,n=si(s,e);t.setDepth(n)})}destroy(){this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear(),this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.npcs.forEach(e=>e.destroy()),this.npcs.clear(),ns(null)}}function gr(){return`social_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const Qt={S:{label:"Small",scale:1.5},M:{label:"Medium",scale:2},L:{label:"Large",scale:2.5}},Dt=Qt.M.scale;function fr(i){return Qt[i].scale}function pr(i){return i<=Qt.S.scale?"S":i>=Qt.L.scale?"L":"M"}const ms=[{key:"discord",name:"Discord",path:"assets/socials/Discord.png",scale:1},{key:"facebook",name:"Facebook",path:"assets/socials/Facebook.png",scale:1},{key:"instagram",name:"Instagram",path:"assets/socials/Instagram.png",scale:1},{key:"kofi",name:"Ko-Fi",path:"assets/socials/Ko Fi.png",scale:1},{key:"linkedin",name:"LinkedIn",path:"assets/socials/LinkedIn.png",scale:1},{key:"patreon",name:"Patreon",path:"assets/socials/Patreon.png",scale:1},{key:"tiktok",name:"TikTok",path:"assets/socials/TikTok.png",scale:1},{key:"twitch",name:"Twitch",path:"assets/socials/Twitch.png",scale:1},{key:"twitter",name:"Twitter",path:"assets/socials/Twitter.png",scale:1},{key:"whatsapp",name:"WhatsApp",path:"assets/socials/Whatsapp.png",scale:1},{key:"youtube",name:"YouTube",path:"assets/socials/Youtube.png",scale:1}];function mr(){return`zone_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const js=["#e74c3c","#e67e22","#f1c40f","#2ecc71","#1abc9c","#3498db","#9b59b6","#e91e8f"];function vr(){return js[Math.floor(Math.random()*js.length)]}function yr(i,e=300){return{id:mr(),x:i,width:e,color:vr(),texts:[{language:"cs",title:"",content:""}]}}function Sr(i,e){const t=i.texts.find(s=>s.language===e);return t||i.texts[0]||null}const mn=J(null),vn=Te([mn,jt],([i,e])=>i?Sr(i,e):null);function Ns(i){mn.set(i)}const di=J(null),wr=Te([di,jt],([i,e])=>i?i.texts.find(s=>s.language===e)??i.texts[0]??null:null);function os(i){di.set(i)}class Vs{scene;socials=new Map;constructor(e){this.scene=e}static preloadAssets(e){ms.forEach(t=>{e.load.image(`social_${t.key}`,t.path)})}createSocials(e){e.forEach(t=>{this.createSocial(t)})}createSocial(e){const t=`social_${e.socialKey}`;if(!this.scene.textures.exists(t)){console.warn(`[GameSocialManager] Social texture not found: ${t}`);return}const s=e.scale??Dt,n=e.depth??Me.ITEMS_FRONT,a=this.scene.add.sprite(e.x,e.y,t);a.setScale(s),a.setDepth(n),a.setOrigin(.5,.5),this.socials.set(e.id,a),e.url&&this.makeClickable(a,e)}makeClickable(e,t){const s=t.scale??Dt;e.setInteractive({useHandCursor:!0}),e.on("pointerover",()=>{e.setScale(s*1.1)}),e.on("pointerout",()=>{e.setScale(s)}),e.on("pointerdown",()=>{t.url&&(Jn(),window.open(t.url,"_blank","noopener,noreferrer"))})}destroy(){this.socials.forEach(e=>{e.destroy()}),this.socials.clear()}}const We={GAME:"GameScene",BUILDER:"BuilderScene"};class _r{scene;currentSkinId;constructor(e,t=hn){this.scene=e,this.currentSkinId=t}createAll(){console.log("PlayerAnimations.createAll() is deprecated - animations created by skinLoader")}getSkinId(){return this.currentSkinId}setSkinId(e){this.currentSkinId=e}getAnimationKey(e){return`${this.currentSkinId}-${e}`}play(e,t){const s=this.getAnimationKey(t);if(e.anims.currentAnim?.key!==s){if(!this.scene.anims.exists(s)){if(t==="jump"||t==="fall"){const n=this.getAnimationKey("idle");if(this.scene.anims.exists(n)){e.play(n);return}}console.warn(`[PlayerAnimations] Animation not found: ${s}`);return}e.play(s)}}handleSkinChange(e,t){const s=this.currentSkinId;this.currentSkinId=t;const n=e.anims.currentAnim?.key;if(n){const a=n.replace(`${s}-`,""),r=`${t}-${a}`;if(this.scene.anims.exists(r))e.play(r);else{const l=`${t}-idle`;this.scene.anims.exists(l)&&e.play(l)}}}}const pt={THRESHOLD_X:20,LANGUAGE_BUTTON:{width:120,height:60},SKIN_BUTTON:{width:120,height:60,yOffset:60}},vs={SPEED:280,JUMP_SPEED:-600};class yn{scene;getPlayerPosition;keyLeft;keyRight;keyUp;keySpace;keyA;keyD;keyW;touchLeft=!1;touchRight=!1;touchJump=!1;touchHandlers;constructor(e){this.scene=e.scene,this.getPlayerPosition=e.getPlayerPosition,this.setupKeyboardControls(),this.setupTouchControls()}setupKeyboardControls(){this.scene.input.keyboard&&(this.keyLeft=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.LEFT,!1),this.keyRight=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.RIGHT,!1),this.keyUp=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.UP,!1),this.keySpace=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.SPACE,!1),this.keyA=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.A,!1),this.keyD=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.D,!1),this.keyW=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.W,!1))}setupTouchControls(){const e=this.scene,t=r=>{if(Ze(Bs)){this.touchLeft=!1,this.touchRight=!1,this.touchJump=!1;return}const l=r.x,c=r.y,d=e.scale.width;if(l>d-pt.LANGUAGE_BUTTON.width&&c<pt.LANGUAGE_BUTTON.height||l>d-pt.SKIN_BUTTON.width&&c>=pt.SKIN_BUTTON.yOffset&&c<pt.SKIN_BUTTON.yOffset+pt.SKIN_BUTTON.height)return;const h=e.cameras.main,m=this.getPlayerPosition(),S=m.x-h.scrollX,x=m.y-h.scrollY,C=l-S,I=c-x;C<-20?(this.touchLeft=!0,this.touchRight=!1):C>pt.THRESHOLD_X?(this.touchRight=!0,this.touchLeft=!1):(this.touchLeft=!1,this.touchRight=!1),I<-150?this.touchJump=!0:this.touchJump=!1},s=r=>{wt()||t(r)},n=r=>{wt()||r.isDown&&t(r)},a=()=>{this.touchLeft=!1,this.touchRight=!1,this.touchJump=!1};e.input.on("pointerdown",s),e.input.on("pointermove",n),e.input.on("pointerup",a),this.touchHandlers={pointerdown:s,pointermove:n,pointerup:a}}getInputState(){const e=this.keyA?.isDown||this.keyLeft?.isDown||this.touchLeft||!1,t=this.keyD?.isDown||this.keyRight?.isDown||this.touchRight||!1,s=this.keySpace?.isDown||this.keyUp?.isDown||this.keyW?.isDown||this.touchJump||!1;return{left:e,right:t,jump:s}}hasAnyInput(){const e=this.getInputState();return e.left||e.right||e.jump}destroy(){this.touchHandlers&&(this.scene.input.off("pointerdown",this.touchHandlers.pointerdown),this.scene.input.off("pointermove",this.touchHandlers.pointermove),this.scene.input.off("pointerup",this.touchHandlers.pointerup),this.touchHandlers=void 0)}}class Ii extends G.GameObjects.Container{character=null;selection;animState="idle";hasNotifiedMovement=!1;hasReceivedInput=!1;currentFacing="right";inputController;constructor(e,t,s,n){super(e,t,s),this.selection=n,e.add.existing(this),e.physics.add.existing(this);const a=this.body;if(a){a.setCollideWorldBounds(!0),a.setBounce(0);const r=Xa();a.setSize(r.width,r.height),a.setOffset(r.offsetX,r.offsetY)}this.inputController=new yn({scene:e,getPlayerPosition:()=>({x:this.x,y:this.y})}),this.setDepth(Ft.DEPTH)}getPosition(){return{x:this.x,y:this.y}}setPlayerPosition(e,t){this.x=e,this.y=t}getGroundY(e,t){return qt(e,t)}getPlayerType(){return"modular"}getHitBounds(){const e=ot.WIDTH,t=ot.HEIGHT;return{x:this.x-e/2,y:this.y-t/2,width:e,height:t}}setFacing(e){this.currentFacing!==e&&(this.currentFacing=e,this.character?.setFacing(e))}setTint(e){this.character?.setTint(e)}clearTint(){this.character?.clearTint()}setAlpha(e){return this.character?.setAlpha(e),this}getGameObject(){return this}static async preloadCharacter(e,t){return Oi(e,t)}buildCharacter(){this.character&&this.character.destroy(),this.character=new Ri(this.scene,0,0,this.selection,{animated:!0,animation:"idle",facing:"right",scale:Yt}),this.add(this.character),this.currentFacing="right"}playAnimation(e){this.character?.playAnimation(e)}update(){const e=this.inputController.getInputState(),t=this.body;if(t)switch(this.inputController.hasAnyInput()&&!this.hasReceivedInput&&(this.hasReceivedInput=!0),this.hasReceivedInput&&this.inputController.hasAnyInput()&&!this.hasNotifiedMovement&&(this.hasNotifiedMovement=!0,ii.set(!0)),e.left?(t.setVelocityX(-280),this.setFacing("left")):e.right?(t.setVelocityX(vs.SPEED),this.setFacing("right")):t.setVelocityX(0),e.jump&&t.blocked.down&&t.setVelocityY(vs.JUMP_SPEED),t.blocked.down?e.left||e.right?this.animState="running":this.animState="idle":t.velocity.y<0?this.animState="jumping":this.animState="falling",this.animState){case"idle":this.playAnimation("idle");break;case"running":this.playAnimation("run");break;case"jumping":this.playAnimation("jump");break;case"falling":this.playAnimation("fall");break}}destroy(e){this.inputController.destroy(),this.character&&(this.character.destroy(),this.character=null),super.destroy(e)}}class br extends G.Physics.Arcade.Sprite{animations;inputController;animState="idle";hasNotifiedMovement=!1;hasReceivedInput=!1;currentSkin;constructor(e,t,s){const n=St.getSkinId();super(e,t,s,`${n}-idle`),e.add.existing(this),e.physics.add.existing(this),this.animations=new _r(e,n),this.inputController=new yn({scene:e,getPlayerPosition:()=>({x:this.x,y:this.y})}),this.setCollideWorldBounds(!0),this.setBounce(0),this.currentSkin=Ce.find(d=>d.id===n)??Ce[0];const a=Gt(this.currentSkin),r=this.currentSkin.frameWidth??48,l=this.currentSkin.frameHeight??48,c=Na(r,l);this.setSize(c.width,c.height),this.setOffset(c.offsetX,c.offsetY),this.setScale(a),this.setDepth(Ft.DEPTH),this.animations.play(this,"idle")}getPosition(){return{x:this.x,y:this.y}}setPlayerPosition(e,t){this.x=e,this.y=t}getGroundY(e,t){return Mt(e,t)}getPlayerType(){return"static"}getHitBounds(){const e=Gt(this.currentSkin),t=(this.currentSkin.frameWidth??48)*e,s=(this.currentSkin.frameHeight??48)*e,n=t*Us.WIDTH,a=(t-n)/2,r=this.originX??.5,l=this.originY??.5,c=this.x-t*r,d=this.y-s*l;return{x:c+a,y:d,width:n,height:s}}setFacing(e){const t=this.currentSkin.facingLeft??!1;e==="left"?this.setFlipX(!t):this.setFlipX(t)}playAnimation(e){(e==="idle"||e==="run"||e==="jump"||e==="fall")&&this.animations.play(this,e)}setTint(e){return super.setTint(e)}clearTint(){return super.clearTint()}setAlpha(e){return super.setAlpha(e)}getGameObject(){return this}changeSkin(e){this.currentSkin=Ce.find(d=>d.id===e)??Ce[0];const t=Gt(this.currentSkin),s=this.currentSkin.frameWidth??48,n=this.currentSkin.frameHeight??48,a=Math.round(s*.33),r=Math.round(n*.25),l=Math.round((s-a)/2),c=Math.round(n*.75);this.setSize(a,r),this.setOffset(l,c),this.setScale(t),this.animations.handleSkinChange(this,e)}update(){const e=this.inputController.getInputState();this.inputController.hasAnyInput()&&!this.hasReceivedInput&&(this.hasReceivedInput=!0),this.hasReceivedInput&&this.inputController.hasAnyInput()&&!this.hasNotifiedMovement&&(this.hasNotifiedMovement=!0,ii.set(!0));const t=this.currentSkin.facingLeft??!1;switch(e.left?(this.setVelocityX(-280),this.setFlipX(!t)):e.right?(this.setVelocityX(vs.SPEED),this.setFlipX(t)):this.setVelocityX(0),e.jump&&this.body?.blocked.down&&this.setVelocityY(vs.JUMP_SPEED),this.body?.blocked.down?e.left||e.right?this.animState="running":this.animState="idle":this.body.velocity.y<0?this.animState="jumping":this.animState="falling",this.animState){case"idle":this.playAnimation("idle");break;case"running":this.playAnimation("run");break;case"jumping":this.playAnimation("jump");break;case"falling":this.playAnimation("fall");break}}destroy(e){this.inputController.destroy(),super.destroy(e)}}const Ir=48,Cr=48;function qs(i){Ce.forEach(e=>{const t=e.frameWidth??Ir,s=e.frameHeight??Cr,n=ds(e);i.load.spritesheet(`${e.id}-idle`,`${n}/idle.png`,{frameWidth:t,frameHeight:s}),i.load.spritesheet(`${e.id}-run`,`${n}/run.png`,{frameWidth:t,frameHeight:s}),i.load.spritesheet(`${e.id}-jump`,`${n}/jump.png`,{frameWidth:t,frameHeight:s}),i.load.spritesheet(`${e.id}-fall`,`${n}/fall.png`,{frameWidth:t,frameHeight:s})})}function Pr(i,e){const t=e.id;i.anims.exists(`${t}-idle`)&&i.anims.remove(`${t}-idle`),i.anims.exists(`${t}-run`)&&i.anims.remove(`${t}-run`),i.anims.exists(`${t}-jump`)&&i.anims.remove(`${t}-jump`),i.anims.exists(`${t}-fall`)&&i.anims.remove(`${t}-fall`);const s=i.textures.get(`${t}-idle`),n=i.textures.get(`${t}-run`),a=i.textures.get(`${t}-jump`),r=i.textures.get(`${t}-fall`),l=s.frameTotal-1,c=n.frameTotal-1,d=a.key!=="__MISSING"?a.frameTotal-1:0,h=r.key!=="__MISSING"?r.frameTotal-1:0,m=e.frameRates?.idle??6,S=e.frameRates?.run??12,x=e.frameRates?.jump??10,C=e.frameRates?.fall??10;i.anims.create({key:`${t}-idle`,frames:i.anims.generateFrameNumbers(`${t}-idle`,{start:0,end:l-1}),frameRate:m,repeat:-1}),i.anims.create({key:`${t}-run`,frames:i.anims.generateFrameNumbers(`${t}-run`,{start:0,end:c-1}),frameRate:S,repeat:-1}),d>0&&i.anims.create({key:`${t}-jump`,frames:i.anims.generateFrameNumbers(`${t}-jump`,{start:0,end:d-1}),frameRate:x,repeat:-1}),h>0&&i.anims.create({key:`${t}-fall`,frames:i.anims.generateFrameNumbers(`${t}-fall`,{start:0,end:h-1}),frameRate:C,repeat:-1})}function Sn(i){Ce.forEach(e=>{Pr(i,e)})}const bt={HEIGHT:qe,VISUAL:{COLOR:9139029,ALPHA:.3},PHYSICS:{COLOR:0,ALPHA:0}},At={getGroundY(i,e=qe){return i-e},createVisualGround(i,e){const t=e.height??bt.HEIGHT,s=At.getGroundY(e.worldHeight,t),n=i.add.rectangle(0,s,e.worldWidth,t,e.color??bt.VISUAL.COLOR,e.alpha??bt.VISUAL.ALPHA);return n.setOrigin(0,0),n.setDepth(e.depth??Me.GROUND_REFERENCE),{ground:n,groundY:s}},createPhysicsGround(i,e){const t=e.height??bt.HEIGHT,s=At.getGroundY(e.worldHeight,t),n=i.add.rectangle(0,s,e.worldWidth,t,e.color??bt.PHYSICS.COLOR,e.alpha??bt.PHYSICS.ALPHA);return n.setOrigin(0,0),i.physics.add.existing(n,!0),{ground:n,groundY:s}},addPlayerCollision(i,e,t){return i.physics.add.collider(e,t)}};class xr{scene;player=null;useModularPlayer=!1;savedCharacterSelection=null;constructor(e){this.scene=e}init(){const e=localStorage.getItem("useModularPlayer");this.savedCharacterSelection=Js(),this.useModularPlayer=e==="true"&&this.savedCharacterSelection!==null}preload(){this.useModularPlayer||qs(this.scene)}async loadAssets(){this.useModularPlayer||Sn(this.scene),this.useModularPlayer&&this.savedCharacterSelection&&await Ii.preloadCharacter(this.scene,this.savedCharacterSelection)}createPlayer(e,t,s){if(this.useModularPlayer&&this.savedCharacterSelection){const n=qt(e.worldHeight,s),a=Math.min(e.playerStartY,n),r=new Ii(this.scene,e.playerStartX,a,this.savedCharacterSelection);r.buildCharacter(),this.player=r,At.addPlayerCollision(this.scene,r,t)}else{const n=Mt(e.worldHeight,s),a=Math.min(e.playerStartY,n),r=new br(this.scene,e.playerStartX,a);this.player=r,At.addPlayerCollision(this.scene,r,t)}return this.player}getPlayer(){return this.player}isModular(){return this.useModularPlayer}}class ys{scene;mapConfig=null;static FOLLOW_LERP_X=.1;static FOLLOW_LERP_Y=.1;constructor(e){this.scene=e}setConfig(e){this.mapConfig=e}followPlayer(e,t=!0){this.scene.cameras.main.startFollow(e,t,ys.FOLLOW_LERP_X,ys.FOLLOW_LERP_Y)}setupBounds(){if(!this.mapConfig){console.warn("[GameCameraController] Cannot setup bounds: no config set");return}const e=this.scene.cameras.main,t=e.height,s=e.width,n=t/this.mapConfig.worldHeight,a=Math.min(1,n);e.setZoom(a);const r=t/a,l=s/a;let c=0,d=this.mapConfig.worldHeight;r>this.mapConfig.worldHeight&&(c=(this.mapConfig.worldHeight-r)/2,d=r);let h=0,m=this.mapConfig.worldWidth;l>this.mapConfig.worldWidth&&(h=(this.mapConfig.worldWidth-l)/2,m=l),e.setBounds(h,c,m,d),Vn(this.mapConfig.worldWidth,this.mapConfig.worldHeight,s,t,a)}handleResize(){!this.scene.cameras?.main||!this.mapConfig||this.setupBounds()}updateCameraInfo(){const e=this.scene.cameras.main;jn(e.scrollX,e.scrollY,e.zoom)}getCamera(){return this.scene.cameras.main}getZoom(){return this.scene.cameras.main.zoom}getScrollPosition(){const e=this.scene.cameras.main;return{scrollX:e.scrollX,scrollY:e.scrollY}}}async function Ci(){const i=await fetch("./config/map.json");if(!i.ok)throw new Error(`Failed to load map config: ${i.status}`);const e=await i.json();if(!e.worldWidth||!e.worldHeight)throw new Error("Invalid map config structure");return e}const hs={generateId(){return`item_${Date.now()}_${Math.random().toString(36).substr(2,9)}`},create(i){const{assetKey:e,x:t,yOffset:s=0,depthLayer:n="behind",scale:a}=i;return{id:hs.generateId(),assetKey:e,x:Math.round(t),y:0,scale:a??Ma(e),depth:Bi(n),yOffset:Math.round(s)}},createAtWorldPosition(i,e,t,s,n="behind"){return hs.create({assetKey:i,x:e,yOffset:t-s,depthLayer:n})},clone(i,e=50){return{...i,id:hs.generateId(),x:i.x+e}}},ze=[{name:"FOREST SUMMER",folder:"forest_summer",scrollFactors:[.9,.95,.975,1,1.05],foregroundLayers:1,groundHeight:90,itemGroups:["shared","forest_summer","forest_shared"]},{name:"FOREST BIRCH",folder:"forest_birch",scrollFactors:[.9,.95,.975,1,1.05],foregroundLayers:1,groundHeight:30,itemGroups:["shared","forest_birch","forest_shared"]},{name:"CAVE DARK",folder:"cave_dark",scrollFactors:[.85,.875,.9,.925,.95,.975,1.05],foregroundLayers:2,groundHeight:20,itemGroups:["shared","cave_dark"]}];class Er{currentIndex=0;constructor(){const e=localStorage.getItem("background");if(e){const t=ze.findIndex(s=>s.folder===e);t!==-1&&(this.currentIndex=t)}}getBackground(){return ze[this.currentIndex].folder}getCurrentConfig(){return ze[this.currentIndex]}setBackground(e){const t=ze.findIndex(s=>s.folder===e);t!==-1&&(this.currentIndex=t,localStorage.setItem("background",e))}toggleBackground(){this.currentIndex=(this.currentIndex+1)%ze.length;const e=ze[this.currentIndex];return localStorage.setItem("background",e.folder),e}getAllBackgrounds(){return ze}setBackgroundByIndex(e){e>=0&&e<ze.length&&(this.currentIndex=e,localStorage.setItem("background",ze[e].folder))}getCurrentIndex(){return this.currentIndex}}const lt=new Er;function Dr(i,e){return new Promise(t=>{for(let s=0;s<e.scrollFactors.length;s++){const n=s+1;i.load.image(`bg${n}-${e.folder}`,`assets/backgrounds/${e.folder}/${n}.png`)}i.load.once("complete",()=>{t(!0)}),i.load.once("loaderror",s=>{console.error(`Failed to load background asset: ${s.key}`),t(!1)}),i.load.start()})}function Tr(i,e,t,s){const n=[],a=[],r=s.foregroundLayers??0,c=s.scrollFactors.length-r;for(let d=0;d<s.scrollFactors.length;d++){const m=`bg${d+1}-${s.folder}`,S=s.scrollFactors[d];if(i.textures.exists(m)){const x=i.textures.getFrame(m),C=x.width,I=x.height,b=t/I,v=C*b,w=e*3,u=Math.ceil(w/v)*C+C,g=i.add.tileSprite(0,0,u,I,m);g.setOrigin(0,0),g.setScale(b),g.setScrollFactor(1),g.setData("scrollFactor",S),g.setData("scale",b),d>=c?(g.setDepth(Me.FOREGROUND_LAYER_START+(d-c)),a.push(g)):(g.setDepth(Me.BACKGROUND_LAYER_START+d),n.push(g))}}return{bgLayers:n,fgLayers:a}}function kr(i,e){if(!i)return;const t=e.width/e.zoom,s=e.getBounds().width,n=Math.max(0,s-t),a=Math.max(0,Math.min(e.scrollX,n)),r=[...i.bgLayers,...i.fgLayers];for(const l of r){const c=l.getData("scrollFactor"),d=l.getData("scale");l.tilePositionX=a*(1-c)/d}}function Pi(i){i.bgLayers.forEach(e=>e.destroy()),i.fgLayers.forEach(e=>e.destroy())}class wn{scene;mapConfig;parallaxLayers=null;loadedBackgrounds=new Set;ground=null;groundY=0;groundHeight=0;constructor(e){this.scene=e}async loadConfiguration(e=!1){try{if(e){const t=oa();this.mapConfig=t||await Ci()}else this.mapConfig=await Ci()}catch(t){console.error("[WorldManager] Failed to load map configuration:",t);const s=600;this.mapConfig={worldWidth:3200,worldHeight:s,playerStartX:400,playerStartY:Mt(s),placedItems:[]}}return this.mapConfig}setConfiguration(e){this.mapConfig=e}getConfig(){return this.mapConfig}async setupBackground(){const e=lt.getCurrentConfig();this.parallaxLayers&&(Pi(this.parallaxLayers),this.parallaxLayers=null),this.loadedBackgrounds.has(e.folder)||await Dr(this.scene,e)&&this.loadedBackgrounds.add(e.folder),this.parallaxLayers=Tr(this.scene,this.mapConfig.worldWidth,this.mapConfig.worldHeight,e)}updateParallax(e){this.parallaxLayers&&kr(this.parallaxLayers,e)}getParallaxLayers(){return this.parallaxLayers}createGround(e){const t=lt.getCurrentConfig();this.groundHeight=t.groundHeight??40;let s;return e==="physics"?s=At.createPhysicsGround(this.scene,{worldWidth:this.mapConfig.worldWidth,worldHeight:this.mapConfig.worldHeight,height:this.groundHeight}):s=At.createVisualGround(this.scene,{worldWidth:this.mapConfig.worldWidth,worldHeight:this.mapConfig.worldHeight,height:this.groundHeight}),this.ground=s.ground,this.groundY=s.groundY,{...s,groundHeight:this.groundHeight}}setupWorldBounds(){this.scene.physics.world.setBounds(0,0,this.mapConfig.worldWidth,this.mapConfig.worldHeight)}getGround(){return this.ground}getGroundY(){return this.groundY}getGroundHeight(){return this.groundHeight}destroy(){this.parallaxLayers&&(Pi(this.parallaxLayers),this.parallaxLayers=null),this.ground&&(this.ground.destroy(),this.ground=null)}}class _n{scene;worldWidth;worldHeight;socials=new Map;unsubscribers=[];selectionGraphics=null;cleanupFunctions=new Map;doubleClickDetector=new fn;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}static preloadAssets(e){e.load.image("social_discord","assets/socials/Discord.png"),e.load.image("social_facebook","assets/socials/Facebook.png"),e.load.image("social_instagram","assets/socials/Instagram.png"),e.load.image("social_kofi","assets/socials/Ko Fi.png"),e.load.image("social_linkedin","assets/socials/LinkedIn.png"),e.load.image("social_patreon","assets/socials/Patreon.png"),e.load.image("social_tiktok","assets/socials/TikTok.png"),e.load.image("social_twitch","assets/socials/Twitch.png"),e.load.image("social_twitter","assets/socials/Twitter.png"),e.load.image("social_whatsapp","assets/socials/Whatsapp.png"),e.load.image("social_youtube","assets/socials/Youtube.png")}create(e){this.selectionGraphics=this.scene.add.graphics(),this.selectionGraphics.setDepth(Me.SELECTION_GRAPHICS),e&&e.length>0&&e.forEach(t=>this.createSocial(t)),this.setupStoreSubscriptions(),this.setupSocialDropListener()}createSocial(e){const t=`social_${e.socialKey}`;if(!this.scene.textures.exists(t)){console.warn(`Social texture not found: ${t}`);return}const s=e.scale??Dt,n=e.depth??Me.ITEMS_FRONT,a=this.scene.add.sprite(e.x,e.y,t);a.setScale(s),a.setDepth(n),a.setOrigin(.5,.5),a.setData("socialId",e.id),this.socials.set(e.id,{sprite:a,data:e}),this.makeInteractive(e.id)}updateSocialVisuals(e){const t=this.socials.get(e);if(!t)return;const{sprite:s,data:n}=t,a=`social_${n.socialKey}`;s.texture.key!==a&&this.scene.textures.exists(a)&&s.setTexture(a);const r=n.scale??Dt;s.setScale(r)}makeInteractive(e){const t=this.socials.get(e);if(!t)return;const{sprite:s}=t,n=xs({sprite:s,scene:this.scene,cursor:"grab",useGridSnapping:!0,constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{Bt(e),this.updateSelectionVisuals()},isSelected:()=>Ze(Vt)===e,onDoubleClick:()=>this.doubleClickDetector.check(e)?(Vi(),!0):!1,onDragStart:()=>{s.setTint(ja)},onDrag:()=>{this.updateSelectionVisuals()},onDragEnd:(a,r)=>{s.clearTint();const l=this.socials.get(e);l&&(l.data.x=Math.round(a),l.data.y=Math.round(r),cs(e,{x:l.data.x,y:l.data.y}))}}});this.cleanupFunctions.set(e,n)}setupStoreSubscriptions(){const e=Vt.subscribe(a=>{this.scene.data.set("selectedSocialId",a),this.updateSelectionVisuals()});this.unsubscribers.push(e);const t=Oe.subscribe(a=>{a==="dialogs"?(Bt(null),this.setInteractiveEnabled(!1)):this.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const n=Sa.subscribe(a=>{s.forEach(r=>{a.find(c=>c.id===r.id)||this.removeSocial(r.id)}),a.forEach(r=>{const l=s.find(d=>d.id===r.id),c=this.socials.get(r.id);if(c&&l){const d=l.scale!==r.scale,h=l.socialKey!==r.socialKey;c.data=r,(d||h)&&(this.updateSocialVisuals(r.id),this.scene.data.get("selectedSocialId")===r.id&&this.updateSelectionVisuals())}}),s=a.map(r=>({...r}))});this.unsubscribers.push(n)}setupSocialDropListener(){const e=De.on(be.SOCIAL_DROPPED,t=>{const{socialKey:s,canvasX:n,canvasY:a}=t,l=this.scene.cameras.main.getWorldPoint(n,a),c=Math.max(0,Math.min(this.worldWidth,l.x)),d=Math.max(0,Math.min(this.worldHeight,l.y)),h={id:gr(),socialKey:s,x:Math.round(c),y:Math.round(d),scale:Dt,depth:Me.ITEMS_FRONT};_a(h),this.createSocial(h),Bt(h.id)});this.unsubscribers.push(()=>e.unsubscribe())}updateSelectionVisuals(){if(!this.selectionGraphics)return;this.selectionGraphics.clear();const e=this.scene.data.get("selectedSocialId");if(!e){Hs(null);return}const t=this.socials.get(e);if(!t){Hs(null);return}const s=t.sprite,n=s.getBounds(),a=this.scene.cameras.main,{screenX:r,screenY:l}=yt(s.x,s.y,a);Hs({screenX:r,screenY:l,socialHeight:n.height*a.zoom}),this.selectionGraphics.lineStyle(3,Ps.SOCIAL.hex,1),this.selectionGraphics.strokeRect(n.x-4,n.y-4,n.width+8,n.height+8)}removeSocial(e){const t=this.socials.get(e);t&&(t.sprite.destroy(),this.socials.delete(e));const s=this.cleanupFunctions.get(e);s&&(s(),this.cleanupFunctions.delete(e)),this.updateSelectionVisuals()}setInteractiveEnabled(e){this.socials.forEach(({sprite:t})=>{e?(t.setInteractive(),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectionGraphics&&this.selectionGraphics.clear()}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear(),this.socials.forEach(({sprite:e})=>{e.destroy()}),this.socials.clear(),this.selectionGraphics&&(this.selectionGraphics.destroy(),this.selectionGraphics=null)}}class bn{scene;groundY;worldWidth;worldHeight;npcManager;unsubscribers=[];constructor(e,t,s,n){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=n}static preloadAssets(e){Jt.preloadAssets(e)}create(e){return this.npcManager=new Jt(this.scene,this.groundY,this.worldWidth,this.worldHeight,!0),e&&e.length>0&&this.npcManager.createNPCs(e),this.setupStoreSubscriptions(),this.setupAssetDropListener(),this.npcManager}setupStoreSubscriptions(){const e=Oe.subscribe(n=>{n==="dialogs"?(Ht(),this.npcManager.setInteractiveEnabled(!1)):this.npcManager.setInteractiveEnabled(!0)});this.unsubscribers.push(e);let t=[];const s=Yi.subscribe(n=>{if(!n?.placedNPCs)return;const a=n.placedNPCs;t.forEach(r=>{a.find(c=>c.id===r.id)||this.npcManager.removeNPC(r.id)}),a.forEach(r=>{const l=t.find(c=>c.id===r.id);l&&JSON.stringify(l)!==JSON.stringify(r)&&this.npcManager.updateNPC(r.id,r)}),t=JSON.parse(JSON.stringify(a))});this.unsubscribers.push(s)}setupAssetDropListener(){const e=De.on(be.NPC_DROPPED,t=>{const{assetKey:s,canvasX:n,canvasY:a}=t,r=this.scene.cameras.main.getWorldPoint(n,a),l=Math.max(0,Math.min(this.worldWidth,r.x)),c=Math.max(0,Math.min(this.worldHeight,r.y)),d=ps(s);if(!d)return;const h={id:`npc_${Date.now()}`,npcId:s,x:Math.round(l),y:Math.round(c),scale:d.scale,flipX:!1};xa(h),this.npcManager.createNPC(h),Is(h.id),rt.set(!1)});this.unsubscribers.push(()=>e.unsubscribe())}update(){this.npcManager.update()}updateAutoDepth(e){this.npcManager.updateAutoDepth(e)}destroy(){this.unsubscribers.forEach(e=>e()),this.npcManager.destroy()}getManager(){return this.npcManager}}const In={preloadForGame(i,e=!0){e&&qs(i),zt.preloadAssets(i),Jt.preloadAssets(i),Vs.preloadAssets(i)},preloadForBuilder(i){qs(i),zt.preloadAssets(i),_n.preloadAssets(i),bn.preloadAssets(i)},preloadItems(i){zt.preloadAssets(i)},preloadNPCs(i){Jt.preloadAssets(i)},preloadSocials(i){Vs.preloadAssets(i)}};class Cn extends G.Scene{isInitialized=!1;isShuttingDown=!1;unsubscribers=[];init(e){this.isInitialized=!1,this.isShuttingDown=!1,this.unsubscribers=[]}create(){this.events.on("shutdown",this.shutdown,this),this.setupResizeHandler()}setupResizeHandler(){this.scale.on("resize",this.handleResize,this)}removeResizeHandler(){this.scale.off("resize",this.handleResize,this)}addUnsubscriber(e){this.unsubscribers.push(e)}cleanupSubscriptions(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[]}shutdown(){this.isShuttingDown||(this.isShuttingDown=!0,this.isInitialized=!1,this.removeResizeHandler(),this.cleanupSubscriptions())}}class hi extends Cn{worldManager;playerManager;cameraController;itemManager;npcManager;socialManager;player=null;dialogZones=[];currentDialogZone=null;currentNPCId=null;initData;static NPC_PROXIMITY_THRESHOLD=200;getMapConfig(){return this.worldManager?.getConfig()||null}constructor(){super({key:We.GAME})}init(e){super.init(e),this.initData=e,this.worldManager=new wn(this),this.playerManager=new xr(this),this.cameraController=new ys(this),this.playerManager.init()}preload(){this.playerManager.preload(),In.preloadForGame(this,!1)}create(){super.create(),this.initializeScene()}async initializeScene(){Fs.set(!0);try{await this.playerManager.loadAssets();const e=await this.worldManager.loadConfiguration(this.initData?.useBuilderConfig);await this.worldManager.setupBackground(),this.worldManager.setupWorldBounds();const{ground:t,groundHeight:s}=this.worldManager.createGround("physics"),n=this.worldManager.getGroundY();this.player=this.playerManager.createPlayer(e,t,s),this.itemManager=new zt(this,n,e.worldWidth,e.worldHeight,!1),e.placedItems&&e.placedItems.length>0&&this.itemManager.createItems(e.placedItems);const a=this.itemManager.getPhysicsGroup();a&&this.player&&this.physics.add.collider(this.player.getGameObject(),a),this.socialManager=new Vs(this),e.placedSocials&&e.placedSocials.length>0&&this.socialManager.createSocials(e.placedSocials),this.npcManager=new Jt(this,n,e.worldWidth,e.worldHeight,!1),e.placedNPCs&&e.placedNPCs.length>0&&this.npcManager.createNPCs(e.placedNPCs),this.dialogZones=e.dialogZones||[];const r=ai.subscribe(l=>{this.dialogZones=l,this.recheckCurrentZone()});this.addUnsubscriber(r),this.cameraController.setConfig(e),this.player&&this.cameraController.followPlayer(this.player.getGameObject()),this.cameraController.setupBounds(),this.isInitialized=!0}catch(e){console.error("[GameScene] Failed to initialize scene:",e)}finally{Fs.set(!1)}}handleResize(e){this.cameraController&&this.cameraController.handleResize()}shutdown(){Ns(null),os(null),this.currentDialogZone=null,this.currentNPCId=null,this.worldManager?.destroy(),this.itemManager?.destroy(),this.socialManager?.destroy(),super.shutdown()}update(){if(!this.isInitialized||!this.player)return;this.player.update();const{x:e,y:t}=this.player.getPosition(),s=this.worldManager.getConfig()?.worldHeight??640;Zi(this.player.getGameObject(),s),this.itemManager?.updateAutoDepth(s),this.npcManager?.updateAutoDepth(s);const n=this.cameras.main;Kn(e-n.scrollX,t-n.scrollY),this.cameraController.updateCameraInfo(),this.checkDialogZonesForPosition(e),this.checkNPCProximity(e,t,n),this.worldManager.updateParallax(n)}checkDialogZonesForPosition(e){let t=null;for(const s of this.dialogZones)if(e>=s.x&&e<=s.x+s.width){t=s;break}t?.id!==this.currentDialogZone?.id&&(this.currentDialogZone=t,Ns(t))}recheckCurrentZone(){if(!this.currentDialogZone)return;const e=this.dialogZones.find(t=>t.id===this.currentDialogZone?.id);e&&(this.currentDialogZone=e,Ns(e))}checkNPCProximity(e,t,s){if(!this.npcManager)return;const n=this.npcManager.getAllNPCs();let a=null;for(const r of n){const l=r.getDialogData?.()??[];if(!l||l.length===0||!l.some(x=>x.content&&x.content.trim().length>0))continue;const d=r.x-e,h=r.y-t,m=Math.sqrt(d*d+h*h),S=r.triggerRadius??hi.NPC_PROXIMITY_THRESHOLD;m<=S&&(!a||m<a.distance)&&(a={id:r.id,distance:m,npc:r})}if(a){const r=a.npc,l=r.x-s.scrollX,c=r.y-s.scrollY,d=r.getContentHeight(),h=c+r.topOffset/2;this.currentNPCId!==a.id?(this.currentNPCId=a.id,os({npcId:a.id,texts:r.getDialogData()??[],screenX:l,screenY:h,npcHeight:d})):os({npcId:a.id,texts:r.getDialogData()??[],screenX:l,screenY:h,npcHeight:d})}else this.currentNPCId&&(this.currentNPCId=null,os(null))}}const ls=1,xi=.001,Mr=.15,Ei=400;class Ar{scene;camera;worldWidth;worldHeight;isPanning=!1;panStartX=0;panStartY=0;cameraDragStartX=0;cameraDragStartY=0;isDraggingToScroll=!1;dragScrollStartX=0;dragScrollStartY=0;dragScrollCameraStartX=0;dragScrollCameraStartY=0;currentZoom=1;targetZoom=1;minZoom=.1;isAnimatingReset=!1;zoomTargetWorldPoint=null;pinchStartDistance=0;pinchStartZoom=1;activeTouches=new Map;pinchEndTime=0;isPinching=!1;PINCH_COOLDOWN=150;touchStartTime=0;touchStartPos=null;touchOnSelectedSprite=!1;TAP_MAX_DURATION=200;TAP_MAX_DISTANCE=10;constructor(e,t,s){this.scene=e,this.camera=e.cameras.main,this.worldWidth=t,this.worldHeight=s}setup(){this.calculateMinZoom(),this.setupCamera(),this.setupMouseControls(),this.setupKeyboardControls(),this.setupUpdateLoop()}calculateMinZoom(){const e=this.camera.width/this.worldWidth,t=this.camera.height/this.worldHeight;this.minZoom=Math.min(e,t)}setupCamera(){this.currentZoom=this.minZoom,this.targetZoom=this.minZoom,this.camera.setZoom(this.minZoom);const e=this.camera.width/this.minZoom,t=this.camera.height/this.minZoom,s=Math.min(0,(this.worldWidth-e)/2),n=Math.min(0,(this.worldHeight-t)/2),a=Math.max(this.worldWidth,e),r=Math.max(this.worldHeight,t);this.camera.setBounds(s,n,a,r),this.camera.centerOn(this.worldWidth/2,this.worldHeight/2),Nt(this.minZoom)}centerOn(e,t){this.camera.centerOn(e,t),this.clampScroll()}setPosition(e,t,s){this.currentZoom=G.Math.Clamp(s,this.minZoom,ls),this.targetZoom=this.currentZoom,this.camera.setZoom(this.currentZoom),this.camera.scrollX=e,this.camera.scrollY=t,this.clampScroll(),Nt(this.currentZoom)}getPosition(){return{scrollX:this.camera.scrollX,scrollY:this.camera.scrollY,zoom:this.currentZoom}}handleResize(){this.calculateMinZoom(),this.currentZoom<this.minZoom&&(this.currentZoom=this.minZoom,this.targetZoom=this.minZoom,this.camera.setZoom(this.minZoom)),this.targetZoom<this.minZoom&&(this.targetZoom=this.minZoom),this.updateCameraBounds(),this.clampScroll(),Nt(this.currentZoom)}updateCameraBounds(){const e=this.camera.width/this.currentZoom,t=this.camera.height/this.currentZoom,s=Math.min(0,(this.worldWidth-e)/2),n=Math.min(0,(this.worldHeight-t)/2),a=Math.max(this.worldWidth,e),r=Math.max(this.worldHeight,t);this.camera.setBounds(s,n,a,r)}getScrollBounds(e=!0){const t=this.camera.width/this.currentZoom,s=this.camera.height/this.currentZoom;let n,a,r,l;return t>this.worldWidth?e?n=a=(this.worldWidth-t)/2:(n=this.worldWidth-t,a=0):(n=0,a=this.worldWidth-t),s>this.worldHeight?e?r=l=(this.worldHeight-s)/2:(r=this.worldHeight-s,l=0):(r=0,l=this.worldHeight-s),{minX:n,maxX:a,minY:r,maxY:l}}clampScroll(){const e=this.getScrollBounds(!0);this.camera.scrollX=G.Math.Clamp(this.camera.scrollX,e.minX,e.maxX),this.camera.scrollY=G.Math.Clamp(this.camera.scrollY,e.minY,e.maxY)}softClampScroll(){const e=this.getScrollBounds(!1);this.camera.scrollX=G.Math.Clamp(this.camera.scrollX,e.minX,e.maxX),this.camera.scrollY=G.Math.Clamp(this.camera.scrollY,e.minY,e.maxY)}applyPanDelta(e,t,s,n,a,r){const l=this.getScrollBounds(),c=(e-s)/this.currentZoom,d=(t-n)/this.currentZoom;this.camera.scrollX=G.Math.Clamp(a-c,l.minX,l.maxX),this.camera.scrollY=G.Math.Clamp(r-d,l.minY,l.maxY)}zoomToPoint(e,t,s){const n=this.camera.getWorldPoint(e,t);this.zoomToWorldPoint(n.x,n.y,s)}zoomToWorldPoint(e,t,s){const n=this.camera.scrollX,a=this.camera.scrollY,r=this.currentZoom;this.currentZoom=s,this.camera.setZoom(s),this.updateCameraBounds(),this.camera.scrollX=e-(e-n)*r/s,this.camera.scrollY=t-(t-a)*r/s,this.softClampScroll(),Nt(this.currentZoom)}setupMouseControls(){this.scene.input.on("wheel",(e,t,s,n,a)=>{if(this.isAnimatingReset)return;if((e.event.ctrlKey||Math.abs(s)<5&&Math.abs(n)>0)&&!e.event.ctrlKey){const l=-n*xi*3;this.targetZoom=G.Math.Clamp(this.targetZoom+l,this.minZoom,ls);const c=this.camera.getWorldPoint(e.x,e.y);this.zoomTargetWorldPoint={x:c.x,y:c.y}}else if(e.event.ctrlKey){const l=-n*xi,c=G.Math.Clamp(this.currentZoom+l,this.minZoom,ls);this.targetZoom=c,this.zoomToPoint(e.x,e.y,c)}else{const l=this.getScrollBounds();this.camera.scrollX=G.Math.Clamp(this.camera.scrollX+s/this.currentZoom,l.minX,l.maxX),this.camera.scrollY=G.Math.Clamp(this.camera.scrollY+n/this.currentZoom,l.minY,l.maxY)}}),this.scene.input.on("pointerdown",e=>{if(e.wasTouch){if(this.activeTouches.set(e.id,{x:e.x,y:e.y}),this.activeTouches.size===2){this.isPinching=!0,this.startPinch(),this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.scene.data.set("touchDraggingSprite",!1);return}this.activeTouches.size===1&&!this.isPinching&&(this.touchStartTime=Date.now(),this.touchStartPos={x:e.x,y:e.y},this.dragScrollStartX=e.x,this.dragScrollStartY=e.y,this.dragScrollCameraStartX=this.camera.scrollX,this.dragScrollCameraStartY=this.camera.scrollY,this.touchOnSelectedSprite=or(this.scene,e),this.scene.data.set("touchDraggingSprite",!1),this.scene.data.set("touchStartOnSelectedSprite",this.touchOnSelectedSprite),this.scene.data.set("touchStartWorldX",e.worldX),this.scene.data.set("touchStartWorldY",e.worldY));return}wt()||vi()||this.isAnimatingReset||(e.rightButtonDown()||e.middleButtonDown()?(this.isPanning=!0,this.panStartX=e.x,this.panStartY=e.y,this.cameraDragStartX=this.camera.scrollX,this.cameraDragStartY=this.camera.scrollY):e.leftButtonDown()&&!this.isDraggingObject()&&(this.scene.data.get("isDraggingItem")===!0||(this.dragScrollStartX=e.x,this.dragScrollStartY=e.y,this.dragScrollCameraStartX=this.camera.scrollX,this.dragScrollCameraStartY=this.camera.scrollY)))}),this.scene.input.on("pointermove",e=>{if(e.wasTouch){if(this.activeTouches.has(e.id)&&this.activeTouches.set(e.id,{x:e.x,y:e.y}),this.activeTouches.size>=2&&this.isPinching){this.handlePinch();return}if(this.isPinching||Date.now()-this.pinchEndTime<this.PINCH_COOLDOWN||this.scene.data.get("touchDraggingSprite"))return;if(this.touchStartPos&&!this.isDraggingToScroll){const t=Math.abs(e.x-this.touchStartPos.x),s=Math.abs(e.y-this.touchStartPos.y);if(Math.sqrt(t*t+s*s)>this.TAP_MAX_DISTANCE){if(this.touchOnSelectedSprite){this.scene.data.set("touchDragStarted",!0),this.scene.data.set("touchDraggingSprite",!0),this.touchStartPos=null;return}!wt()&&!this.isDraggingObject()&&!this.scene.data.get("isDraggingItem")&&(this.isDraggingToScroll=!0,this.touchStartPos=null)}}this.isDraggingToScroll&&this.applyPanDelta(e.x,e.y,this.dragScrollStartX,this.dragScrollStartY,this.dragScrollCameraStartX,this.dragScrollCameraStartY);return}if(!(vi()||this.isAnimatingReset)){if(this.isPanning)this.applyPanDelta(e.x,e.y,this.panStartX,this.panStartY,this.cameraDragStartX,this.cameraDragStartY);else if(e.leftButtonDown()&&!this.isDraggingToScroll&&!this.isDraggingObject()&&!(this.scene.data.get("isDraggingItem")===!0)){const s=Math.abs(e.x-this.dragScrollStartX),n=Math.abs(e.y-this.dragScrollStartY);Math.sqrt(s*s+n*n)>10&&(this.isDraggingToScroll=!0,this.scene.input.setDefaultCursor("grabbing"))}this.isDraggingToScroll&&this.applyPanDelta(e.x,e.y,this.dragScrollStartX,this.dragScrollStartY,this.dragScrollCameraStartX,this.dragScrollCameraStartY)}}),this.scene.input.on("pointerup",e=>{if(e.wasTouch){if(this.isPinching&&(this.pinchEndTime=Date.now(),this.isPinching=!1,Ms(!1)),this.touchStartPos&&!this.isDraggingToScroll){const t=Date.now()-this.touchStartTime,s=Math.abs(e.x-this.touchStartPos.x),n=Math.abs(e.y-this.touchStartPos.y),a=Math.sqrt(s*s+n*n);t<this.TAP_MAX_DURATION&&a<this.TAP_MAX_DISTANCE&&(this.scene.data.set("lastTapTime",Date.now()),this.scene.data.set("lastTapWorldX",e.worldX),this.scene.data.set("lastTapWorldY",e.worldY))}this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.activeTouches.delete(e.id),this.scene.data.set("touchDraggingSprite",!1),this.scene.data.set("touchDragStarted",!1),this.scene.data.set("touchStartOnSelectedSprite",!1),this.isDraggingToScroll&&(this.isDraggingToScroll=!1);return}!e.rightButtonDown()&&!e.middleButtonDown()&&(this.isPanning=!1),this.isDraggingToScroll&&(this.isDraggingToScroll=!1,this.scene.input.setDefaultCursor("default"))}),this.scene.input.on("pointerout",e=>{e.wasTouch&&(this.activeTouches.delete(e.id),this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.isPinching&&this.activeTouches.size<2&&(this.isPinching=!1,this.pinchEndTime=Date.now(),Ms(!1)))})}startPinch(){const e=Array.from(this.activeTouches.values());if(e.length!==2)return;const[t,s]=e;this.pinchStartDistance=Math.hypot(s.x-t.x,s.y-t.y),this.pinchStartZoom=this.currentZoom,Ms(!0)}handlePinch(){const e=Array.from(this.activeTouches.values());if(e.length!==2)return;const[t,s]=e,n=Math.hypot(s.x-t.x,s.y-t.y),a=(t.x+s.x)/2,r=(t.y+s.y)/2,l=n/this.pinchStartDistance,c=G.Math.Clamp(this.pinchStartZoom*l,this.minZoom,ls);this.targetZoom=c,this.zoomToPoint(a,r,c)}setupKeyboardControls(){const e={up:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.UP,!1),down:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.DOWN,!1),left:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.LEFT,!1),right:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.RIGHT,!1)},t={w:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.W,!1),a:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.A,!1),s:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.S,!1),d:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.D,!1)};this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.SPACE,!1).on("down",()=>{Os()||this.centerOnPlayer()}),this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.F,!1).on("down",()=>{Os()||this.resetToFit()}),this.scene.data.set("cameraArrowKeys",e),this.scene.data.set("cameraWasdKeys",t)}setupUpdateLoop(){const e=this.scene.data.get("cameraArrowKeys"),t=this.scene.data.get("cameraWasdKeys");this.scene.events.on("update",()=>{if(!this.isAnimatingReset&&Math.abs(this.currentZoom-this.targetZoom)>1e-4){const a=G.Math.Linear(this.currentZoom,this.targetZoom,Mr);this.zoomTargetWorldPoint?this.zoomToWorldPoint(this.zoomTargetWorldPoint.x,this.zoomTargetWorldPoint.y,a):this.zoomToPoint(this.camera.width/2,this.camera.height/2,a),Math.abs(this.currentZoom-this.targetZoom)<.001&&(this.zoomTargetWorldPoint=null)}if(Os()||this.isAnimatingReset)return;const s=10/this.currentZoom,n=this.getScrollBounds();e?.left?.isDown||t?.a?.isDown?this.camera.scrollX=G.Math.Clamp(this.camera.scrollX-s,n.minX,n.maxX):(e?.right?.isDown||t?.d?.isDown)&&(this.camera.scrollX=G.Math.Clamp(this.camera.scrollX+s,n.minX,n.maxX)),e?.up?.isDown||t?.w?.isDown?this.camera.scrollY=G.Math.Clamp(this.camera.scrollY-s,n.minY,n.maxY):(e?.down?.isDown||t?.s?.isDown)&&(this.camera.scrollY=G.Math.Clamp(this.camera.scrollY+s,n.minY,n.maxY))})}centerOnPlayer(){const e=this.scene.data.get("playerSprite");e&&(this.camera.centerOn(e.x,e.y),this.clampScroll())}isDraggingObject(){return this.scene.data.get("isDraggingObject")===!0||this.scene.data.get("isDraggingItem")===!0}resetToFit(){if(this.isAnimatingReset)return;this.isAnimatingReset=!0,this.targetZoom=this.minZoom;const e=this.camera.width/this.minZoom,t=this.camera.height/this.minZoom,s=(this.worldWidth-e)/2,n=(this.worldHeight-t)/2,a=s+e/2,r=n+t/2;this.camera.pan(a,r,Ei,"Sine.easeInOut"),this.camera.zoomTo(this.minZoom,Ei,"Sine.easeInOut",!1,(l,c)=>{c===1&&(this.currentZoom=this.minZoom,this.camera.scrollX=s,this.camera.scrollY=n,this.isAnimatingReset=!1,Nt(this.minZoom))})}destroy(){this.activeTouches.clear()}}class Hr{scene;player;modularCharacter=null;worldWidth;worldHeight;unsubscribers=[];interactionCleanup=null;useModular=!1;modularSelection=null;debugGraphics=null;isSelected=!1;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s;const n=localStorage.getItem("useModularPlayer");this.modularSelection=Js(),this.useModular=n==="true"&&this.modularSelection!==null}async preload(){!this.useModular||!this.modularSelection||await Oi(this.scene,this.modularSelection)}create(e,t){const s=lt.getCurrentConfig().groundHeight??qe;if(this.useModular&&this.modularSelection){const n=qt(this.worldHeight,s),a=Math.min(t,n);return this.createModularPlayer(e,a)}else{const n=Math.min(t,Mt(this.worldHeight,s));return this.createStaticPlayer(e,n)}}createStaticPlayer(e,t){const s=St.getSkinId(),n=Ce.find(l=>l.id===s)??Ce[0],a=Gt(n),r=this.scene.add.sprite(e,t,`${s}-idle`,0);return r.setScale(a),r.setDepth(Ft.DEPTH),r.setData("isPlayer",!0),this.player=r,this.scene.data.set("playerSprite",this.player),this.setupInteraction(),this.setupEditModeSubscription(),this.setupSelectionSubscription(),r}createModularPlayer(e,t){this.modularCharacter=new Ri(this.scene,e,t,this.modularSelection,{animated:!1,facing:"right",scale:Yt});const s=this.modularCharacter;return s.setDepth(Ft.DEPTH),s.setData("isPlayer",!0),this.player=s,this.scene.data.set("playerSprite",this.player),this.setupInteraction(),this.setupEditModeSubscription(),this.setupSelectionSubscription(),s}setupInteraction(){let e;if(this.useModular&&this.modularCharacter)e=new G.Geom.Rectangle(-80/2,-64/2,ot.FRAME_WIDTH,ot.FRAME_HEIGHT),this.scene.data.set("modularPlayerHitArea",e);else{const t=St.getSkinId(),s=Ce.find(c=>c.id===t)??Ce[0],n=s.frameWidth??48,a=s.frameHeight??48,r=n*Us.WIDTH,l=(n-r)/2;e=new G.Geom.Rectangle(l,0,r,a)}this.interactionCleanup=xs({sprite:this.player,scene:this.scene,useGridSnapping:!1,cursor:"grab",hitArea:e,constraints:{minX:wi,maxX:this.worldWidth-wi,minY:Ua},callbacks:{onSelect:()=>{Ca(!0)},isSelected:()=>Ze(pi),onDragStart:()=>{this.scene.data.set("isDraggingObject",!0)},onDrag:(t,s)=>{mi(Math.round(t),Math.round(s)),this.updateDebugVisualization()},onDragEnd:(t,s)=>{this.scene.data.set("isDraggingObject",!1);let n=this.player.y;const a=lt.getCurrentConfig().groundHeight??qe;this.useModular?La(this.player.y,this.worldHeight,a)&&(n=qt(this.worldHeight,a),this.player.setY(n)):Ra(this.player.y,this.worldHeight,a)&&(n=Mt(this.worldHeight,a),this.player.setY(n)),mi(Math.round(this.player.x),Math.round(n)),this.updateDebugVisualization()}}}),_i&&this.createDebugVisualization()}createDebugVisualization(){this.debugGraphics&&this.debugGraphics.destroy(),this.debugGraphics=this.scene.add.graphics(),this.debugGraphics.setDepth(Ft.DEPTH+1),this.updateDebugVisualization()}updateDebugVisualization(){if(!this.debugGraphics||!_i)return;this.debugGraphics.clear();const e=this.isSelected?er:qa,t=this.isSelected?tr:Ja,s=this.isSelected?sr:Qa;let n=null;if(this.useModular&&this.modularCharacter){const a=this.player,r=this.scene.data.get("modularPlayerHitArea");if(r&&a.input){const l=a.scaleX;n={x:a.x+r.x*l,y:a.y+r.y*l,width:r.width*l,height:r.height*l}}}else{const a=this.player,r=St.getSkinId(),l=Ce.find(I=>I.id===r)??Ce[0],c=Gt(l),d=(l.frameWidth??48)*c,h=(l.frameHeight??48)*c,m=d*Us.WIDTH,S=(d-m)/2,x=a.originX??.5,C=a.originY??.5;n={x:a.x-d*x+S,y:a.y-h*C,width:m,height:h}}n&&(this.debugGraphics.fillStyle(bi,e),this.debugGraphics.fillRect(n.x,n.y,n.width,n.height),this.debugGraphics.lineStyle(t,bi,s),this.debugGraphics.strokeRect(n.x,n.y,n.width,n.height))}setupSelectionSubscription(){const e=pi.subscribe(t=>{this.isSelected=t,this.updateDebugVisualization(),this.scene.data.set("isPlayerSelected",t)});this.unsubscribers.push(e)}setupEditModeSubscription(){const e=Oe.subscribe(t=>{t==="dialogs"?(this.interactionCleanup&&(this.interactionCleanup(),this.interactionCleanup=null),this.player.disableInteractive(),this.setAlpha(.6)):(this.setAlpha(1),this.interactionCleanup||this.setupInteraction())});this.unsubscribers.push(e)}setAlpha(e){this.modularCharacter?this.modularCharacter.setAlpha(e):this.player.setAlpha(e)}getSprite(){return this.player}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.interactionCleanup&&(this.interactionCleanup(),this.interactionCleanup=null),this.debugGraphics&&(this.debugGraphics.destroy(),this.debugGraphics=null),this.modularCharacter?(this.modularCharacter.destroy(),this.modularCharacter=null):this.player&&this.player.destroy()}}class $r{scene;graphics;worldWidth;worldHeight;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}create(){return this.graphics=this.scene.add.graphics(),this.graphics.setDepth(gn),this.draw(),this.graphics}draw(){this.graphics.clear(),this.graphics.lineStyle(Ba,Wa,Ya);const e=Math.max(this.worldHeight,this.scene.scale.height);for(let n=0;n<=this.worldWidth;n+=xt)this.graphics.beginPath(),this.graphics.moveTo(n,0),this.graphics.lineTo(n,e),this.graphics.strokePath();for(let n=0;n<=e;n+=xt)this.graphics.beginPath(),this.graphics.moveTo(0,n),this.graphics.lineTo(this.worldWidth,n),this.graphics.strokePath();const t=lt.getCurrentConfig().groundHeight??qe,s=this.worldHeight-t;this.graphics.lineStyle(Za,Ls,Ga),this.graphics.beginPath(),this.graphics.moveTo(0,s),this.graphics.lineTo(this.worldWidth,s),this.graphics.strokePath(),this.graphics.lineStyle(za,Ls,Ka),this.graphics.fillStyle(Ls,Fa),this.graphics.fillRect(0,s,this.worldWidth,e-s)}getGraphics(){return this.graphics}redraw(){this.draw()}destroy(){this.graphics&&this.graphics.destroy()}}class Or{scene;groundY;worldWidth;worldHeight;itemManager;unsubscribers=[];constructor(e,t,s,n){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=n}create(e){return this.itemManager=new zt(this.scene,this.groundY,this.worldWidth,this.worldHeight,!0),e&&e.length>0&&this.itemManager.createItems(e),this.setupBackgroundDeselect(),this.setupStoreSubscriptions(),this.setupAssetDropListener(),this.itemManager}setupBackgroundDeselect(){this.itemManager.setupBackgroundDeselect()}setupStoreSubscriptions(){const e=kt.subscribe(a=>{this.scene.data.set("selectedItemId",a),this.itemManager.updateSelectionVisuals()});this.unsubscribers.push(e);const t=Oe.subscribe(a=>{a==="dialogs"?(Ht(),this.itemManager.setInteractiveEnabled(!1)):this.itemManager.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const n=Yi.subscribe(a=>{if(!a?.placedItems)return;const r=a.placedItems;s.forEach(l=>{r.find(d=>d.id===l.id)||this.itemManager.removeItem(l.id)}),r.forEach(l=>{const c=s.find(d=>d.id===l.id);c&&JSON.stringify(c)!==JSON.stringify(l)&&this.itemManager.updateItem(l.id,l)}),s=r.map(l=>({...l}))});this.unsubscribers.push(n)}setupAssetDropListener(){const e=De.on(be.ASSET_DROPPED,t=>{const{assetKey:s,canvasX:n,canvasY:a}=t,l=this.scene.cameras.main.getWorldPoint(n,a),c=Math.max(0,Math.min(this.worldWidth,l.x)),d=Math.max(0,Math.min(this.worldHeight,l.y)),h=hs.createAtWorldPosition(s,c,d,this.groundY,"behind");pa(h),this.itemManager.createItem(h),Is(h.id),at.set(!1)});this.unsubscribers.push(()=>e.unsubscribe())}getManager(){return this.itemManager}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.itemManager&&this.itemManager.destroy()}}const tt=gn-1,st=300,Di=150,Rr=.3,Lr=.5,Xs=40,Ti=60,ki=16777215,Mi=.6,Ai=0,Fe=60,Hi=8;class Nr{scene;worldWidth;worldHeight;graphics=null;zoneAreas=new Map;leftHandles=new Map;leftHandleVisuals=new Map;rightHandles=new Map;rightHandleVisuals=new Map;arrowGraphics=new Map;dragging=null;unsubscribers=[];createZoneSubscription;currentEditMode="items";currentZones=[];currentSelectedId=null;lastClickTime=0;lastClickX=0;DOUBLE_CLICK_THRESHOLD=300;DOUBLE_CLICK_DISTANCE=20;pendingTap=null;TAP_MAX_DURATION=300;TAP_MAX_DISTANCE=15;pendingZoneSelection=null;createZoneAtSubscription;boundWindowPointerUp=()=>{};boundWindowPointerMove=()=>{};currentScreenX=0;autoScrollTimer=null;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}create(){this.graphics=this.scene.add.graphics(),this.graphics.setDepth(tt);const e=Oe.subscribe(n=>{this.currentEditMode=n,this.render()});this.unsubscribers.push(e);const t=ai.subscribe(n=>{this.currentZones=n,this.render()});this.unsubscribers.push(t);const s=Cs.subscribe(n=>{this.currentSelectedId=n,this.render()});this.unsubscribers.push(s),this.scene.input.on("pointermove",this.handlePointerMove,this),this.scene.input.on("pointerup",this.handlePointerUp,this),this.boundWindowPointerUp=this.handlePointerUp.bind(this),this.boundWindowPointerMove=this.handleWindowPointerMove.bind(this),window.addEventListener("pointerup",this.boundWindowPointerUp),window.addEventListener("pointermove",this.boundWindowPointerMove),this.scene.input.on("pointerdown",this.handlePointerDown,this),this.createZoneSubscription=De.on(be.DIALOG_ZONE_CREATE,()=>{this.createNewZone()}),this.createZoneAtSubscription=De.on(be.DIALOG_ZONE_CREATE_AT,n=>{this.createZoneAtPosition(n.worldX)}),this.render()}clearVisuals(){this.graphics&&this.graphics.clear(),this.zoneAreas.forEach(e=>e.destroy()),this.zoneAreas.clear(),this.leftHandles.forEach(e=>e.destroy()),this.leftHandles.clear(),this.rightHandles.forEach(e=>e.destroy()),this.rightHandles.clear(),this.leftHandleVisuals.forEach(e=>e.destroy()),this.leftHandleVisuals.clear(),this.rightHandleVisuals.forEach(e=>e.destroy()),this.rightHandleVisuals.clear(),this.arrowGraphics.forEach(e=>e.destroy()),this.arrowGraphics.clear()}render(){if(this.clearVisuals(),this.currentEditMode==="dialogs")for(const e of this.currentZones)this.renderZone(e,e.id===this.currentSelectedId)}renderZone(e,t){if(!this.graphics)return;const s=G.Display.Color.HexStringToColor(e.color).color,n=t?Lr:Rr;this.graphics.fillStyle(s,n),this.graphics.fillRect(e.x,0,e.width,this.worldHeight),this.graphics.lineStyle(2,s,.8),this.graphics.strokeRect(e.x,0,e.width,this.worldHeight);const a=this.scene.add.rectangle(e.x+e.width/2,this.worldHeight/2,e.width-Xs*2,this.worldHeight);a.setOrigin(.5,.5),a.setInteractive({cursor:t?"grab":"pointer"}),a.setDepth(tt+.1),a.setAlpha(.001),a.setData("zoneId",e.id),a.on("pointerdown",r=>{if(this.isClickOnUIElement(r))return;const l=Date.now(),c=l-this.lastClickTime<this.DOUBLE_CLICK_THRESHOLD&&Math.abs(r.worldX-this.lastClickX)<this.DOUBLE_CLICK_DISTANCE;this.lastClickTime=l,this.lastClickX=r.worldX;const d=this.currentSelectedId===e.id;if(c&&d){qi();return}d?(this.scene.data.set("isDraggingItem",!0),Et(!0),this.startDrag(e.id,"move",r.worldX)):this.pendingZoneSelection={zoneId:e.id,worldX:r.worldX,startTime:l}}),this.zoneAreas.set(e.id,a),t&&this.createHandles(e)}createHandles(e){const t=this.scene.cameras.main.scrollY,s=this.scene.cameras.main.height,n=t+s/2,a=this.scene.add.rectangle(e.x,this.worldHeight/2,Xs,this.worldHeight);a.setOrigin(.5,.5),a.setDepth(tt+.2),a.setFillStyle(ki,Mi);const r=this.scene.add.rectangle(e.x,this.worldHeight/2,Ti,this.worldHeight);r.setOrigin(.5,.5),r.setInteractive({cursor:"ew-resize"}),r.setDepth(tt+.25),r.setAlpha(.001),r.setData("zoneId",e.id),r.setData("type","left"),r.on("pointerdown",S=>{this.isClickOnUIElement(S)||this.startDrag(e.id,"left",S.worldX)}),this.leftHandles.set(e.id,r),this.leftHandleVisuals.set(e.id,a);const l=8,c=this.scene.add.graphics();c.setDepth(tt+.3),this.drawArrow(c,e.x-l,n,"left"),this.arrowGraphics.set(`${e.id}_left`,c);const d=this.scene.add.rectangle(e.x+e.width,this.worldHeight/2,Xs,this.worldHeight);d.setOrigin(.5,.5),d.setDepth(tt+.2),d.setFillStyle(ki,Mi);const h=this.scene.add.rectangle(e.x+e.width,this.worldHeight/2,Ti,this.worldHeight);h.setOrigin(.5,.5),h.setInteractive({cursor:"ew-resize"}),h.setDepth(tt+.25),h.setAlpha(.001),h.setData("zoneId",e.id),h.setData("type","right"),h.on("pointerdown",S=>{this.isClickOnUIElement(S)||this.startDrag(e.id,"right",S.worldX)}),this.rightHandles.set(e.id,h),this.rightHandleVisuals.set(e.id,d);const m=this.scene.add.graphics();m.setDepth(tt+.3),this.drawArrow(m,e.x+e.width+l,n,"right"),this.arrowGraphics.set(`${e.id}_right`,m)}drawArrow(e,t,s,n){const r=n==="left"?-1:1;e.fillStyle(3355443,.8),e.beginPath(),e.moveTo(t+r*10+1,s),e.lineTo(t-r*10+1,s-10+1),e.lineTo(t-r*10+1,s+10-1),e.closePath(),e.fillPath(),e.fillStyle(16777215,.9),e.beginPath(),e.moveTo(t+r*10,s),e.lineTo(t-r*10,s-10),e.lineTo(t-r*10,s+10),e.closePath(),e.fillPath()}startDrag(e,t,s){const n=this.currentZones.find(a=>a.id===e);n&&(this.scene.data.set("isDraggingItem",!0),Et(!0),this.dragging={zoneId:e,type:t,startX:s,originalX:n.x,originalWidth:n.width})}getZoneBounds(e){let t=0,s=this.worldWidth;for(const n of this.currentZones){if(n.id===e)continue;const a=n.x+n.width,r=this.currentZones.find(l=>l.id===e);r&&(a<=r.x+r.width/2&&(t=Math.max(t,a+Ai)),n.x>=r.x+r.width/2&&(s=Math.min(s,n.x-Ai)))}return{minX:t,maxX:s-st,maxRight:s}}wouldOverlap(e,t,s){const n=t+s;for(const a of this.currentZones){if(a.id===e)continue;const r=a.x,l=a.x+a.width;if(t<l&&n>r)return!0}return!1}isClickOnUIElement(e){const t=e.downElement;return t?t.tagName?.toUpperCase()!=="CANVAS":!1}cancelPendingIfMoved(e){this.pendingTap&&Math.abs(e-this.pendingTap.worldX)>this.TAP_MAX_DISTANCE&&(this.pendingTap=null),this.pendingZoneSelection&&Math.abs(e-this.pendingZoneSelection.worldX)>this.TAP_MAX_DISTANCE&&(this.pendingZoneSelection=null)}screenToWorld(e,t){const s=this.scene.cameras.main,a=this.scene.game.canvas.getBoundingClientRect(),r=e-a.left,l=t-a.top;return ka(r,l,s)}handleWindowPointerMove(e){const t=this.screenToWorld(e.clientX,e.clientY);if(this.cancelPendingIfMoved(t.worldX),!this.dragging)return;const n=this.scene.game.canvas.getBoundingClientRect();e.clientX>=n.left&&e.clientX<=n.right&&e.clientY>=n.top&&e.clientY<=n.bottom||(this.currentScreenX=e.clientX-n.left,this.updateDrag(t.worldX),this.checkAutoScroll())}handlePointerMove(e){this.cancelPendingIfMoved(e.worldX),this.dragging&&(this.currentScreenX=e.x,e.event?.stopPropagation?.(),this.updateDrag(e.worldX),this.checkAutoScroll())}checkAutoScroll(){if(!this.dragging||this.dragging.type!=="move"){this.stopAutoScroll();return}const e=this.scene.cameras.main,t=e.width,s=this.currentZones.find(w=>w.id===this.dragging?.zoneId);if(!s)return;const n=Math.max(0,this.worldWidth-e.width/e.zoom);if(n<=0){this.stopAutoScroll();return}const{screenX:a}=yt(s.x,0,e),{screenX:r}=yt(s.x+s.width,0,e),l=a<=Fe,c=r>=t-Fe,d=e.scrollX>0,h=e.scrollX<n,m=s.x>0,S=s.x+s.width<this.worldWidth,x=this.currentScreenX<Fe,C=this.currentScreenX>t-Fe,v=l&&x&&d&&m||c&&C&&h&&S;v&&!this.autoScrollTimer?this.autoScrollTimer=this.scene.time.addEvent({delay:16,callback:this.performAutoScroll,callbackScope:this,loop:!0}):!v&&this.autoScrollTimer&&this.stopAutoScroll()}performAutoScroll(){if(!this.dragging||this.dragging.type!=="move"){this.stopAutoScroll();return}const e=this.scene.cameras.main,t=e.width,s=this.currentZones.find(b=>b.id===this.dragging?.zoneId);if(!s)return;let n=0;if(this.currentScreenX<Fe){if(s.x<=0){this.stopAutoScroll();return}const v=(Fe-this.currentScreenX)/Fe;n=-Hi*v}else if(this.currentScreenX>t-Fe){if(s.x+s.width>=this.worldWidth){this.stopAutoScroll();return}const v=(this.currentScreenX-(t-Fe))/Fe;n=Hi*v}if(n===0)return;const a=e.scrollX+n,r=0,l=Math.max(0,this.worldWidth-e.width/e.zoom),d=Math.max(r,Math.min(l,a))-e.scrollX;if(l<=0){this.stopAutoScroll();return}if(d===0){this.stopAutoScroll();return}const h=s.x+d,m=Math.max(0,Math.min(this.worldWidth-s.width,h)),S=m-s.x;if(S===0){this.stopAutoScroll();return}const x=e.scrollX+S,C=Math.max(0,Math.min(l,x));if(Math.abs(C-e.scrollX)>Math.abs(S)*2){this.stopAutoScroll();return}e.scrollX=C,this.wouldOverlap(s.id,m,s.width)||(It(s.id,{x:m}),this.dragging.originalX+=S,this.dragging.startX+=S)}stopAutoScroll(){this.autoScrollTimer&&(this.autoScrollTimer.destroy(),this.autoScrollTimer=null)}updateDrag(e){if(!this.dragging)return;const t=e-this.dragging.startX,s=this.currentZones.find(a=>a.id===this.dragging?.zoneId);if(!s)return;const n=this.getZoneBounds(s.id);if(this.dragging.type==="left"){let a=this.dragging.originalX+t,r=this.dragging.originalWidth-t;if(a<0&&(r+=a,a=0),r<st&&(a=this.dragging.originalX+this.dragging.originalWidth-st,r=st),a<n.minX){const l=n.minX-a;a=n.minX,r-=l}r>=st&&!this.wouldOverlap(s.id,a,r)&&It(s.id,{x:a,width:r})}else if(this.dragging.type==="right"){let a=this.dragging.originalWidth+t;a<st&&(a=st),s.x+a>this.worldWidth&&(a=this.worldWidth-s.x),s.x+a>n.maxRight&&(a=n.maxRight-s.x),a>=st&&!this.wouldOverlap(s.id,s.x,a)&&It(s.id,{width:a})}else if(this.dragging.type==="move"){let a=this.dragging.originalX+t;const r=s.width;if(a<0&&(a=0),a+r>this.worldWidth&&(a=this.worldWidth-r),!this.wouldOverlap(s.id,a,r))It(s.id,{x:a});else{const l=this.findNonOverlappingPosition(s.id,a,r);l!==null&&It(s.id,{x:l})}}}findNonOverlappingPosition(e,t,s){const n=this.currentZones.filter(h=>h.id!==e).sort((h,m)=>h.x-m.x);if(n.length===0)return Math.max(0,Math.min(t,this.worldWidth-s));let a=t,r=1/0;const l=n[0];if(l.x>=s){const h=l.x-s,m=Math.max(0,Math.min(t,h)),S=Math.abs(m-t);S<r&&(r=S,a=m)}for(let h=0;h<n.length-1;h++){const m=n[h],S=n[h+1],x=m.x+m.width,C=S.x;if(C-x>=s){const b=x,v=C-s,w=Math.max(b,Math.min(t,v)),u=Math.abs(w-t);u<r&&(r=u,a=w)}}const c=n[n.length-1],d=c.x+c.width;if(this.worldWidth-d>=s){const h=d,m=this.worldWidth-s,S=Math.max(h,Math.min(t,m)),x=Math.abs(S-t);x<r&&(r=x,a=S)}return r<1/0&&!this.wouldOverlap(e,a,s)?a:null}handlePointerUp(e){if(this.dragging&&(this.stopAutoScroll(),this.scene.data.set("isDraggingItem",!1),Et(!1),this.dragging=null),this.pendingZoneSelection){let n=Date.now()-this.pendingZoneSelection.startTime<this.TAP_MAX_DURATION;n&&e&&e.worldX!==void 0&&(n=Math.abs(e.worldX-this.pendingZoneSelection.worldX)<this.TAP_MAX_DISTANCE),n&&Zt(this.pendingZoneSelection.zoneId),this.pendingZoneSelection=null}if(this.pendingTap&&this.currentEditMode==="dialogs"){if(Date.now()-this.pendingTap.startTime<this.TAP_MAX_DURATION){let n=!0;e&&e.worldX!==void 0&&(n=Math.abs(e.worldX-this.pendingTap.worldX)<this.TAP_MAX_DISTANCE),n&&this.showTempAddButton(this.pendingTap.worldX,this.pendingTap.worldY)}this.pendingTap=null}}handlePointerDown(e){if(wt()||this.currentEditMode!=="dialogs"||this.dragging)return;const t=e.downElement;if(t&&t.tagName?.toUpperCase()!=="CANVAS")return;const s=e.worldX;for(const l of this.currentZones)if(s>=l.x&&s<=l.x+l.width)return;const n=Date.now(),a=n-this.lastClickTime,r=Math.abs(s-this.lastClickX);if(a<this.DOUBLE_CLICK_THRESHOLD&&r<this.DOUBLE_CLICK_DISTANCE){this.createZoneAtPosition(s),this.lastClickTime=0,this.hideTempAddButton();return}this.lastClickTime=n,this.lastClickX=s,this.pendingTap={worldX:s,worldY:e.worldY,startTime:n},this.currentSelectedId&&Zt(null)}showTempAddButton(e,t){const s=this.scene.cameras.main,{screenX:n,screenY:a}=yt(e,t,s);De.emit(be.TEMP_ZONE_BUTTON_SHOW,{screenX:n,screenY:a,worldX:e})}hideTempAddButton(){De.emit(be.TEMP_ZONE_BUTTON_HIDE,{})}createZoneAtPosition(e){this.createZoneAt(e)}createNewZone(){const e=this.scene.cameras.main,t=e.worldView.x+e.worldView.width/2;this.createZoneAt(t)}createZoneAt(e){let t=e-Di/2;const s=Di;if(t=Math.max(0,Math.min(this.worldWidth-s,t)),this.wouldOverlap("",t,s)){const a=this.findNonOverlappingPosition("",t,s);if(a===null){console.warn("No room for a new dialog zone");return}t=a}const n=yr(t,s);n.x=t,ba(n),Zt(n.id)}updateSelectionVisuals(){if(this.currentEditMode!=="dialogs"){is(null);return}if(!this.currentSelectedId){is(null);return}const e=this.currentZones.find(r=>r.id===this.currentSelectedId);if(!e){is(null);return}const t=this.scene.cameras.main,s=e.x+e.width/2,{screenX:n}=yt(s,0,t),a=t.height*.65;is({screenX:n,screenY:a})}destroy(){this.hideTempAddButton();for(const e of this.unsubscribers)e();this.unsubscribers=[],this.createZoneSubscription&&this.createZoneSubscription.unsubscribe(),this.createZoneAtSubscription&&this.createZoneAtSubscription.unsubscribe(),this.stopAutoScroll(),this.scene.input.off("pointerdown",this.handlePointerDown,this),this.scene.input.off("pointermove",this.handlePointerMove,this),this.scene.input.off("pointerup",this.handlePointerUp,this),window.removeEventListener("pointerup",this.boundWindowPointerUp),window.removeEventListener("pointermove",this.boundWindowPointerMove),this.clearVisuals(),this.graphics&&(this.graphics.destroy(),this.graphics=null),this.dragging=null}}class Xr extends Cn{worldManager;cameraController;playerController;gridOverlay;itemsController;socialsController;npcsController;dialogZoneRenderer;config;minimapSubscription;savedCameraPosition=null;get itemManager(){return this.itemsController?.getManager()}resetZoom(){this.cameraController?.resetToFit()}getCameraPosition(){return this.cameraController?.getPosition()??null}setCameraPosition(e,t,s){this.cameraController?.setPosition(e,t,s)}constructor(){super({key:We.BUILDER})}init(e){super.init(e),this.config=e.config,this.savedCameraPosition=e.savedCameraPosition??null,this.worldManager=new wn(this),this.worldManager.setConfiguration(this.config)}preload(){In.preloadForBuilder(this)}create(){super.create(),this.initializeScene()}async initializeScene(){Sn(this),this.worldManager.setupWorldBounds();const{groundY:e}=this.worldManager.createGround("visual");this.cameraController=new Ar(this,this.config.worldWidth,this.config.worldHeight),this.playerController=new Hr(this,this.config.worldWidth,this.config.worldHeight),this.gridOverlay=new $r(this,this.config.worldWidth,this.config.worldHeight),this.itemsController=new Or(this,e,this.config.worldWidth,this.config.worldHeight),this.socialsController=new _n(this,this.config.worldWidth,this.config.worldHeight),this.npcsController=new bn(this,e,this.config.worldWidth,this.config.worldHeight),this.dialogZoneRenderer=new Nr(this,this.config.worldWidth,this.config.worldHeight),await this.worldManager.setupBackground(),this.gridOverlay.create(),await this.playerController.preload(),this.playerController.create(this.config.playerStartX,this.config.playerStartY),this.itemsController.create(this.config.placedItems||[]),this.socialsController.create(this.config.placedSocials||[]),this.npcsController.create(this.config.placedNPCs||[]),this.dialogZoneRenderer.create(),this.cameraController.setup(),this.savedCameraPosition?(this.cameraController.setPosition(this.savedCameraPosition.scrollX,this.savedCameraPosition.scrollY,this.savedCameraPosition.zoom),this.savedCameraPosition=null):this.cameraController.centerOn(this.config.playerStartX,this.config.playerStartY),this.minimapSubscription=De.on(be.MINIMAP_NAVIGATE,t=>{this.navigateToPosition(t.worldX,t.worldY)}),this.isInitialized=!0}update(){if(!this.isInitialized)return;this.worldManager.updateParallax(this.cameras.main);const e=this.config.worldHeight,t=this.data.get("playerSprite");t&&Zi(t,e),this.itemManager?.updateAutoDepth(e),this.npcsController?.updateAutoDepth(e),this.itemManager?.updateSelectionVisuals(),this.socialsController?.updateSelectionVisuals(),this.dialogZoneRenderer?.updateSelectionVisuals(),this.npcsController?.update();const s=this.cameras.main;ta({scrollX:s.worldView.x,scrollY:s.worldView.y,viewWidth:s.width,viewHeight:s.height,worldWidth:this.config.worldWidth,worldHeight:this.config.worldHeight,zoom:s.zoom,playerX:t?.x??this.config.playerStartX,playerY:t?.y??this.config.playerStartY})}navigateToPosition(e,t){this.cameraController.centerOn(e,t)}handleResize(e){!this.cameraController||!this.config||(this.cameraController.handleResize(),this.gridOverlay?.redraw())}shutdown(){this.minimapSubscription?.unsubscribe(),this.worldManager?.destroy(),this.cameraController?.destroy(),this.playerController?.destroy(),this.gridOverlay?.destroy(),this.itemsController?.destroy(),this.socialsController?.destroy(),this.dialogZoneRenderer?.destroy(),this.npcsController?.destroy(),super.shutdown()}}Nn();class Wr{currentLanguage="cs";setLanguage(e){this.currentLanguage=e,localStorage.setItem("language",e)}getLanguage(){const e=localStorage.getItem("language");return(e==="cs"||e==="en")&&(this.currentLanguage=e),this.currentLanguage}toggleLanguage(){return this.currentLanguage=this.currentLanguage==="cs"?"en":"cs",this.setLanguage(this.currentLanguage),this.currentLanguage}}const Pn=new Wr;let Le=null;function Yr(i){Le=i}function Br(){if(!Le)return console.error("Scene manager not initialized"),null;try{const i=Le.scene.getScene(We.GAME);return typeof i.getMapConfig=="function"?i.getMapConfig():i?.mapConfig||null}catch(i){return console.error("Failed to get map config:",i),null}}function Zr(i){if(!Le)return console.error("Scene manager not initialized"),!1;try{if(!Le.scene.getScene(We.GAME))return console.error("GameScene not found"),!1;Le.scene.stop(We.GAME),qn();const t=ea();return aa(i),Le.scene.start(We.BUILDER,{config:i,savedCameraPosition:t}),!0}catch(e){return console.error("Failed to switch to builder:",e),!1}}function Gr(){if(console.log("[SceneManager] switchToGame called"),!Le)return console.error("Scene manager not initialized"),!1;try{const i=Le.scene.getScene(We.BUILDER);if(i){const e=i.getCameraPosition();e&&Qn(e.scrollX,e.scrollY,e.zoom)}return console.log("[SceneManager] Stopping builder scene..."),Le.scene.stop(We.BUILDER),console.log("[SceneManager] Exiting builder mode..."),ra(),console.log("[SceneManager] Starting game scene..."),Le.scene.start(We.GAME,{useBuilderConfig:!0}),console.log("[SceneManager] switchToGame completed successfully"),!0}catch(i){return console.error("Failed to switch to game:",i),!1}}function Fr(){if(!Le){console.error("Scene manager not initialized");return}try{Le.scene.start(We.GAME)}catch(i){console.error("Failed to start game scene:",i)}}var zr=X('<button class="close-btn svelte-164n75j" title="Close"></button>'),Kr=X('<div class="resize-handle resize-handle-nw svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M9 9L1 1M5 1L1 1L1 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-ne svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M1 9L9 1M5 1L9 1L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-sw svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M9 1L1 9M1 5L1 9L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-se svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M1 1L9 9M9 5L9 9L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>',1),Ur=X("<div><!></div> <!>",1),jr=X('<div data-ui=""><div class="panel-header svelte-164n75j"><span class="panel-title svelte-164n75j"> </span> <!> <div class="header-buttons svelte-164n75j"><button class="minimize-btn svelte-164n75j"> </button> <!></div></div> <!></div>');function $t(i,e){ve(e,!0);const t=()=>N(ct,"$isDraggingInBuilder",s),[s,n]=xe();let a=1e3,r=me(e,"initialRight",3,10),l=me(e,"initialTop",3,60),c=me(e,"width",3,280),d=me(e,"minWidth",3,200),h=me(e,"minHeight",3,100),m=me(e,"maxWidth",3,600),S=me(e,"maxHeight",3,800),x=me(e,"resizable",3,!1),C=me(e,"startMinimized",3,!1),I=me(e,"showClose",3,!1),b=se(Be(C())),v=se(!1),w=se(Be({x:0,y:0})),u=se(Be({width:c(),height:e.height??0})),g=se(!1),P=se(!1),f=se("se"),_=se(Be({x:0,y:0})),D=se(null),W=se(!1),y=se(Be(a)),k=se(null),O=se("");function R(){a++,H(y,a,!0)}function $(A,Z,ie){let ke=A;const Ne=window.innerWidth-ie-10;ke>Ne&&(ke=Math.max(10,Ne)),ke<10&&(ke=10);let $e=Z;const Qe=window.innerHeight-40;return $e>Qe&&($e=Math.max(10,Qe)),$e<10&&($e=10),{x:ke,y:$e}}Ee(()=>{if(typeof window>"u"||o(W))return;const A=localStorage.getItem(`panel-state-${e.panelId}`);if(A)try{const Z=JSON.parse(A),ie=x()&&Z.width?Z.width:c(),oe=$(Z.x,Z.y,ie);H(w,oe,!0),x()&&Z.width&&Z.height&&H(u,{width:Z.width,height:Z.height},!0);const _e=x()?{x:oe.x,y:oe.y,width:o(u).width,height:o(u).height}:{x:oe.x,y:oe.y};H(O,JSON.stringify(_e),!0)}catch{H(w,{x:window.innerWidth-c()-r(),y:l()},!0)}else H(w,{x:window.innerWidth-c()-r(),y:l()},!0);H(W,!0)}),Ee(()=>{if(!o(W))return;const A=x()?{x:o(w).x,y:o(w).y,width:o(u).width,height:o(u).height}:{x:o(w).x,y:o(w).y},Z=JSON.stringify(A);Z!==o(O)&&(H(O,Z,!0),localStorage.setItem(`panel-state-${e.panelId}`,Z))}),Ee(()=>{if(!o(W))return;function A(){if(!o(D))return;const Z=x()?o(u).width:c();let ie=o(w).x,oe=o(w).y,_e=!1;const ke=window.innerWidth-Z;o(w).x>ke&&(ie=Math.max(10,ke),_e=!0);const Ne=window.innerHeight-40;o(w).y>Ne&&(oe=Math.max(10,Ne),_e=!0),o(w).x<0&&(ie=10,_e=!0),o(w).y<0&&(oe=10,_e=!0),_e&&H(w,{x:ie,y:oe},!0)}return window.addEventListener("resize",A),()=>{window.removeEventListener("resize",A)}});function E(){H(b,!o(b))}function Y(){e.onclose?.()}function B(){if(x())if(o(v))o(k)&&(H(w,{x:o(k).x,y:o(k).y},!0),H(u,{width:o(k).width,height:o(k).height},!0),H(k,null)),H(v,!1);else{H(k,{x:o(w).x,y:o(w).y,width:o(u).width,height:o(u).height},!0);const A=20,Z=Math.min(m(),window.innerWidth-A*2),ie=Math.min(S(),window.innerHeight-A*2),oe=Math.max(A,(window.innerWidth-Z)/2),_e=Math.max(A,(window.innerHeight-ie)/2);H(w,{x:oe,y:_e},!0),H(u,{width:Z,height:ie},!0),H(v,!0)}}function ee(A){A.target.closest("button")||B()}function z(A){A.target.closest("button")||(H(g,!0),H(_,{x:A.clientX-o(w).x,y:A.clientY-o(w).y},!0),A.currentTarget.setPointerCapture(A.pointerId),A.preventDefault())}function j(A){if(!o(g))return;const Z=A.clientX-o(_).x,ie=A.clientY-o(_).y,oe=window.innerWidth-(o(D)?.offsetWidth??c()),_e=window.innerHeight-40;H(w,{x:Math.max(0,Math.min(Z,oe)),y:Math.max(0,Math.min(ie,_e))},!0)}function Q(A){o(g)&&(H(g,!1),A.currentTarget.releasePointerCapture(A.pointerId))}function L(A){return Z=>{x()&&(H(P,!0),H(f,A,!0),Z.currentTarget.setPointerCapture(Z.pointerId),Z.preventDefault(),Z.stopPropagation())}}function F(A){if(!o(P)||!o(D))return;const Z=o(D).getBoundingClientRect();let ie,oe,_e=o(w).x,ke=o(w).y;const Ne=o(f)==="se"||o(f)==="ne",$e=o(f)==="se"||o(f)==="sw";Ne?ie=A.clientX-Z.left:(ie=Z.right-A.clientX,_e=A.clientX),$e?oe=A.clientY-Z.top:(oe=Z.bottom-A.clientY,ke=A.clientY);const Qe=Math.max(d(),Math.min(m(),ie)),et=Math.max(h(),Math.min(S(),oe));Ne||(_e=Z.right-Qe,_e<0&&(_e=0)),$e||(ke=Z.bottom-et,ke<0&&(ke=0));const Ts=Ne?window.innerWidth-o(w).x-10:Z.right-10,ht=$e?window.innerHeight-o(w).y-10:Z.bottom-10,ks=Math.min(Qe,Ts),ut=Math.min(et,ht);H(u,{width:ks,height:ut},!0);let Rt=!1,gt=o(w).x,ss=o(w).y;!Ne&&ie>=d()&&(gt=Math.max(0,_e),Rt=!0),!$e&&oe>=h()&&(ss=Math.max(0,ke),Rt=!0),Rt&&H(w,{x:gt,y:ss},!0)}function te(A){o(P)&&(H(P,!1),A.currentTarget.releasePointerCapture(A.pointerId))}function le(A){A.stopPropagation()}Ee(()=>{if(!o(D))return;const A=o(D),Z=oe=>{oe.ctrlKey&&oe.preventDefault(),oe.stopPropagation()},ie=oe=>{oe.preventDefault(),oe.stopPropagation()};return A.addEventListener("wheel",Z,{passive:!1}),A.addEventListener("gesturestart",ie,{passive:!1}),A.addEventListener("gesturechange",ie,{passive:!1}),A.addEventListener("gestureend",ie,{passive:!1}),()=>{A.removeEventListener("wheel",Z),A.removeEventListener("gesturestart",ie),A.removeEventListener("gesturechange",ie),A.removeEventListener("gestureend",ie)}});var re=jr();let ce;re.__pointerdown=A=>{R(),le(A)},re.__click=le;var Se=T(re);Se.__pointerdown=z,Se.__pointermove=j,Se.__pointerup=Q,Se.__dblclick=ee;var de=T(Se),pe=T(de),fe=M(de,2);{var we=A=>{var Z=Ie(),ie=ge(Z);Ut(ie,()=>e.headerExtra),p(A,Z)};K(fe,A=>{e.headerExtra&&A(we)})}var Ye=M(fe,2),He=T(Ye);He.__click=E;var Re=T(He),dt=M(He,2);{var Ds=A=>{var Z=zr();Z.__click=Y,p(A,Z)};K(dt,A=>{I()&&A(Ds)})}var Ot=M(Se,2);{var Tn=A=>{var Z=Ur(),ie=ge(Z);let oe;var _e=T(ie);Ut(_e,()=>e.children);var ke=M(ie,2);{var Ne=$e=>{var Qe=Kr(),et=ge(Qe),Ts=V(()=>L("nw"));et.__pointerdown=function(...ft){o(Ts)?.apply(this,ft)},et.__pointermove=F,et.__pointerup=te;var ht=M(et,2),ks=V(()=>L("ne"));ht.__pointerdown=function(...ft){o(ks)?.apply(this,ft)},ht.__pointermove=F,ht.__pointerup=te;var ut=M(ht,2),Rt=V(()=>L("sw"));ut.__pointerdown=function(...ft){o(Rt)?.apply(this,ft)},ut.__pointermove=F,ut.__pointerup=te;var gt=M(ut,2),ss=V(()=>L("se"));gt.__pointerdown=function(...ft){o(ss)?.apply(this,ft)},gt.__pointermove=F,gt.__pointerup=te,Xe("pointercancel",et,te),Xe("pointercancel",ht,te),Xe("pointercancel",ut,te),Xe("pointercancel",gt,te),p($e,Qe)};K(ke,$e=>{x()&&$e(Ne)})}U(()=>oe=Ae(ie,1,"panel-body svelte-164n75j",null,oe,{"has-fixed-height":x()&&o(u).height>0})),p(A,Z)};K(Ot,A=>{o(b)||A(Tn)})}Tt(re,A=>H(D,A),()=>o(D)),U(()=>{ce=Ae(re,1,"draggable-panel svelte-164n75j",null,ce,{minimized:o(b),maximized:o(v),dragging:o(g),resizing:o(P),resizable:x()}),ae(re,`left: ${o(w).x??""}px; top: ${o(w).y??""}px; width: ${o(b)?"auto":`${x()?o(u).width:c()}px`}; ${x()&&o(u).height>0&&!o(b)?`height: ${o(u).height}px;`:""}${t()?" pointer-events: none;":""} z-index: ${o(y)??""};`),Pe(pe,e.title),ne(He,"title",o(b)?"Expand":"Minimize"),Pe(Re,o(b)?"":"")}),Xe("pointercancel",Se,Q),p(i,re),ye(),n()}Je(["pointerdown","click","pointermove","pointerup","dblclick"]);const $i=10,Vr=150,qr=`
  position: fixed;
  pointer-events: none;
  z-index: 10000;
  opacity: 0.9;
  image-rendering: pixelated;
  filter: drop-shadow(3px 3px 0 rgba(0, 0, 0, 0.5));
  background: rgba(26, 26, 46, 0.9);
`,Jr=`
  width: 100%;
  height: 100%;
  object-fit: contain;
  image-rendering: pixelated;
`;function ui(i,e,t){const{previewSize:s,borderColor:n,dataKey:a,eventName:r,onDrop:l}=i,c=s/2,d={startX:0,startY:0,hasMoved:!1,isActivated:!1,pendingKey:null,pendingTarget:null,longPressTimer:null};function h(y,k,O){De.emit(r,{[a]:y,canvasX:k,canvasY:O}),l?.()}function m(y,k){const O=document.querySelector("canvas");if(!O)return null;const R=O.getBoundingClientRect();return y>=R.left&&y<=R.right&&k>=R.top&&k<=R.bottom?{canvasX:y-R.left,canvasY:k-R.top}:null}function S(y,k,O){const R=document.createElement("div");return R.className="touch-drag-preview",R.innerHTML=`<img src="${y}" alt="" />`,R.style.cssText=`
      ${qr}
      top: ${O-c}px;
      left: ${k-c}px;
      width: ${s}px;
      height: ${s}px;
      border: 2px solid ${n};
    `,R.querySelector("img").style.cssText=Jr,document.body.appendChild(R),R}function x(y,k,O){y.style.top=`${O-c}px`,y.style.left=`${k-c}px`}function C(){d.longPressTimer&&(clearTimeout(d.longPressTimer),d.longPressTimer=null),d.pendingKey=null,d.pendingTarget=null,d.isActivated=!1,d.hasMoved=!1}function I(){C();const y=e();y.touchDragElement&&(y.touchDragElement.remove(),t({touchDragElement:null})),t({draggedKey:null}),as(!1)}function b(y,k){if(!y.dataTransfer)return;t({draggedKey:k}),as(!0),y.dataTransfer.effectAllowed="copy",y.dataTransfer.setData(a,k);const O=y.target,$=(O.querySelector("[data-drag-preview]")||O.querySelector("img"))?.cloneNode(!0);$&&($.style.position="absolute",$.style.top="-1000px",$.style.left="-1000px",$.style.zIndex="-1",document.body.appendChild($),y.dataTransfer.setDragImage($,c,c),requestAnimationFrame(()=>$.remove()))}function v(){t({draggedKey:null}),as(!1)}function w(y){y.preventDefault(),y.dataTransfer&&(y.dataTransfer.dropEffect="copy")}function u(y){y.preventDefault();const k=y.dataTransfer?.getData(a);if(!k)return;const O=m(y.clientX,y.clientY);O&&h(k,O.canvasX,O.canvasY)}function g(y,k){if(!d.pendingKey||!d.pendingTarget||d.isActivated)return;d.isActivated=!0,t({draggedKey:d.pendingKey}),as(!0);const O=d.pendingTarget.querySelector("img");if(O){const R=S(O.src,y,k);t({touchDragElement:R})}}function P(y,k){if(y.touches.length!==1)return;const O=y.touches[0];d.startX=O.clientX,d.startY=O.clientY,d.hasMoved=!1,d.isActivated=!1,d.pendingKey=k,d.pendingTarget=y.currentTarget,d.longPressTimer=setTimeout(()=>{d.pendingKey&&!d.hasMoved&&g(O.clientX,O.clientY)},Vr)}function f(y){const k=y.touches[0],O=k.clientX-d.startX,R=k.clientY-d.startY;if(!d.hasMoved&&(Math.abs(O)>$i||Math.abs(R)>$i)&&(d.hasMoved=!0,!d.isActivated)){if(Math.abs(R)>Math.abs(O)){C();return}g(k.clientX,k.clientY)}const $=e();d.isActivated&&$.touchDragElement&&(x($.touchDragElement,k.clientX,k.clientY),y.preventDefault())}function _(y){const k=e(),O=d.isActivated,R=k.draggedKey;if(O&&R&&d.hasMoved){const $=y.changedTouches[0],E=m($.clientX,$.clientY);E&&h(R,E.canvasX,E.canvasY)}I()}function D(){const y=document.querySelector("canvas");return y?(y.addEventListener("dragover",w),y.addEventListener("drop",u),()=>{y.removeEventListener("dragover",w),y.removeEventListener("drop",u)}):()=>{}}function W(){return document.addEventListener("touchmove",f,{passive:!1}),document.addEventListener("touchend",_),document.addEventListener("touchcancel",_),()=>{document.removeEventListener("touchmove",f),document.removeEventListener("touchend",_),document.removeEventListener("touchcancel",_)}}return{onDragStart:b,onDragEnd:v,onTouchStart:P,setupCanvasListeners:D,setupTouchListeners:W}}var Qr=X('<span class="palette-hint svelte-lnmxj4">Drag to place</span>'),eo=X('<div class="animated-wrapper svelte-lnmxj4" data-drag-preview=""><img class="item-preview animated svelte-lnmxj4"/></div>'),to=X('<img class="item-preview svelte-lnmxj4" data-drag-preview=""/>'),so=X('<div data-ui="" draggable="true" role="button" tabindex="0"><!></div>'),io=X('<div class="palette-content svelte-lnmxj4" role="toolbar" tabindex="-1"><div class="palette-grid svelte-lnmxj4"></div></div>');function no(i,e){ve(e,!0);const t=()=>N(at,"$isItemPaletteOpen",n),s=()=>N(Oe,"$builderEditMode",n),[n,a]=xe(),r="#4a90e2",l=600,d=lt.getCurrentConfig().itemGroups||["shared"],h=li.filter(f=>d.includes(f.group));function m(){return window.innerWidth<l}function S(){m()&&at.set(!1)}let x=se(null),C=se(null);const I=ui({previewSize:48,borderColor:r,dataKey:"assetKey",eventName:be.ASSET_DROPPED,onDrop:S},()=>({draggedKey:o(x),touchDragElement:o(C)}),f=>{"draggedKey"in f&&H(x,f.draggedKey??null,!0),"touchDragElement"in f&&H(C,f.touchDragElement??null,!0)});function b(f){f.stopPropagation()}function v(){at.set(!1)}function w(f){const _=document.querySelector("canvas");if(!_)return;const D=_.getBoundingClientRect(),W=D.width/2,y=D.height/2;De.emit(be.ASSET_DROPPED,{assetKey:f,canvasX:W,canvasY:y}),S()}_s(()=>I.setupCanvasListeners()),Ee(()=>I.setupTouchListeners());var u=Ie(),g=ge(u);{var P=f=>{$t(f,{panelId:"item-palette",title:"Items",initialRight:10,initialTop:60,width:280,height:400,minWidth:200,minHeight:160,maxWidth:500,maxHeight:600,resizable:!0,showClose:!0,onclose:v,headerExtra:D=>{var W=Qr();p(D,W)},children:(D,W)=>{var y=io();y.__pointerdown=b;var k=T(y);je(k,21,()=>h,Ve,(O,R)=>{var $=so();let E;$.__touchstart=z=>I.onTouchStart(z,o(R).key),$.__dblclick=()=>w(o(R).key),ae($,"",{},{"--accent-color":r});var Y=T($);{var B=z=>{const j=V(()=>Ks(o(R).key));var Q=eo();let L;var F=T(Q);let te;U(()=>{L=ae(Q,"",L,{width:`${o(j)?.frameWidth??""}px`,height:`${o(j)?.frameHeight??""}px`}),ne(F,"src",o(R).path),ne(F,"alt",o(R).name),te=ae(F,"",te,{width:`${o(j)?.frameWidth??""}px`,height:`${o(j)?.frameHeight??""}px`,"object-fit":"none","object-position":"0 0"})}),p(z,Q)},ee=z=>{var j=to();U(()=>{ne(j,"src",o(R).path),ne(j,"alt",o(R).name)}),p(z,j)};K(Y,z=>{zs(o(R).key)?z(B):z(ee,!1)})}U(()=>{E=Ae($,1,"palette-item svelte-lnmxj4",null,E,{dragging:o(x)===o(R).key}),ne($,"title",`${o(R).name??""} (double-click to place)`)}),Xe("dragstart",$,z=>I.onDragStart(z,o(R).key)),Xe("dragend",$,function(...z){I.onDragEnd?.apply(this,z)}),p(O,$)}),p(D,y)},$$slots:{headerExtra:!0,default:!0}})};K(g,f=>{t()&&s()==="items"&&f(P)})}p(i,u),ye(),a()}Je(["pointerdown","touchstart","dblclick"]);var ao=X('<span class="palette-hint svelte-4tctcn">Drag to place</span>'),ro=X('<div data-ui="" draggable="true" role="button" tabindex="0"><img class="item-preview svelte-4tctcn"/> <span class="item-name svelte-4tctcn"> </span></div>'),oo=X('<div class="palette-content svelte-4tctcn" role="toolbar" tabindex="-1"><div class="palette-grid svelte-4tctcn"></div></div>');function lo(i,e){ve(e,!0);const t=()=>N(it,"$isSocialPaletteOpen",n),s=()=>N(Oe,"$builderEditMode",n),[n,a]=xe(),r=Ps.SOCIAL.css,l=ms;let c=se(null),d=se(null);const h=ui({previewSize:64,borderColor:r,dataKey:"socialKey",eventName:be.SOCIAL_DROPPED,onDrop:()=>{it.set(!1)}},()=>({draggedKey:o(c),touchDragElement:o(d)}),v=>{"draggedKey"in v&&H(c,v.draggedKey??null,!0),"touchDragElement"in v&&H(d,v.touchDragElement??null,!0)});function m(v){v.stopPropagation()}function S(){it.set(!1)}function x(v){const w=document.querySelector("canvas");if(!w)return;const u=w.getBoundingClientRect(),g=u.width/2,P=u.height/2;De.emit(be.SOCIAL_DROPPED,{socialKey:v,canvasX:g,canvasY:P}),it.set(!1)}_s(()=>h.setupCanvasListeners()),Ee(()=>h.setupTouchListeners());var C=Ie(),I=ge(C);{var b=v=>{$t(v,{panelId:"social-palette",title:"Socials",initialRight:10,initialTop:60,width:280,height:350,minWidth:200,minHeight:200,maxWidth:500,maxHeight:500,resizable:!0,showClose:!0,onclose:S,headerExtra:u=>{var g=ao();p(u,g)},children:(u,g)=>{var P=oo();P.__pointerdown=m;var f=T(P);je(f,21,()=>l,Ve,(_,D)=>{var W=ro();let y;W.__touchstart=E=>h.onTouchStart(E,o(D).key),W.__dblclick=()=>x(o(D).key);let k;var O=T(W),R=M(O,2),$=T(R);U(()=>{y=Ae(W,1,"palette-item svelte-4tctcn",null,y,{dragging:o(c)===o(D).key}),ne(W,"title",`${o(D).name??""} (double-click to place)`),k=ae(W,"",k,{"--accent-color":r}),ne(O,"src",o(D).path),ne(O,"alt",o(D).name),Pe($,o(D).name)}),Xe("dragstart",W,E=>h.onDragStart(E,o(D).key)),Xe("dragend",W,function(...E){h.onDragEnd?.apply(this,E)}),p(_,W)}),p(u,P)},$$slots:{headerExtra:!0,default:!0}})};K(I,v=>{t()&&s()==="socials"&&v(b)})}p(i,C),ye(),a()}Je(["pointerdown","touchstart","dblclick"]);var co=X('<span class="palette-hint svelte-1tjg0mk">Drag to place</span>'),ho=X("<button> </button>"),uo=X('<div data-ui="" draggable="true" role="button" tabindex="0"><div class="animated-wrapper svelte-1tjg0mk" data-drag-preview=""><img class="item-preview animated svelte-1tjg0mk"/></div> <span class="npc-name svelte-1tjg0mk"> </span></div>'),go=X('<div class="palette-content svelte-1tjg0mk" role="toolbar" tabindex="-1"><div class="category-tabs svelte-1tjg0mk"></div> <div class="palette-grid svelte-1tjg0mk"></div></div>');function fo(i,e){ve(e,!0);const t=()=>N(rt,"$isNPCPaletteOpen",n),s=()=>N(Oe,"$builderEditMode",n),[n,a]=xe(),r="#e67e22",l=600,c=[{id:"humans",label:"Humans"},{id:"fantasy",label:"Fantasy"}];let d=se("humans");const h=V(()=>ci.filter(f=>f.category===o(d)));function m(){return window.innerWidth<l}function S(){m()&&rt.set(!1)}let x=se(null),C=se(null);const I=ui({previewSize:48,borderColor:r,dataKey:"assetKey",eventName:be.NPC_DROPPED,onDrop:S},()=>({draggedKey:o(x),touchDragElement:o(C)}),f=>{"draggedKey"in f&&H(x,f.draggedKey??null,!0),"touchDragElement"in f&&H(C,f.touchDragElement??null,!0)});function b(f){f.stopPropagation()}function v(){Ui()}function w(f){const _=document.querySelector("canvas");if(!_)return;const D=_.getBoundingClientRect(),W=D.width/2,y=D.height/2;De.emit(be.NPC_DROPPED,{assetKey:f,canvasX:W,canvasY:y}),rt.set(!1)}_s(()=>I.setupCanvasListeners()),Ee(()=>I.setupTouchListeners());var u=Ie(),g=ge(u);{var P=f=>{$t(f,{panelId:"npc-palette",title:"NPCs",initialRight:10,initialTop:60,width:280,height:400,minWidth:200,minHeight:160,maxWidth:500,maxHeight:600,resizable:!0,showClose:!0,onclose:v,headerExtra:D=>{var W=co();p(D,W)},children:(D,W)=>{var y=go();y.__pointerdown=b;var k=T(y);je(k,21,()=>c,Ve,(R,$)=>{var E=ho();let Y;E.__click=()=>H(d,o($).id,!0);var B=T(E);U(()=>{Y=Ae(E,1,"category-tab svelte-1tjg0mk",null,Y,{active:o(d)===o($).id}),Pe(B,o($).label)}),p(R,E)});var O=M(k,2);je(O,21,()=>o(h),Ve,(R,$)=>{var E=uo();let Y;E.__touchstart=F=>I.onTouchStart(F,o($).id),E.__dblclick=()=>w(o($).id),ae(E,"",{},{"--accent-color":r});var B=T(E);let ee;var z=T(B);let j;var Q=M(B,2),L=T(Q);U(()=>{Y=Ae(E,1,"palette-item svelte-1tjg0mk",null,Y,{dragging:o(x)===o($).id}),ne(E,"title",`${o($).name??""} (double-click to place)`),ee=ae(B,"",ee,{width:`${o($).frameWidth??""}px`,height:`${o($).frameHeight??""}px`}),ne(z,"src",o($).path),ne(z,"alt",o($).name),j=ae(z,"",j,{width:`${o($).frameWidth??""}px`,height:`${o($).frameHeight??""}px`,"object-fit":"none","object-position":"0 0"}),Pe(L,o($).name)}),Xe("dragstart",E,F=>I.onDragStart(F,o($).id)),Xe("dragend",E,function(...F){I.onDragEnd?.apply(this,F)}),p(R,E)}),p(D,y)},$$slots:{headerExtra:!0,default:!0}})};K(g,f=>{t()&&s()==="npcs"&&f(P)})}p(i,u),ye(),a()}Je(["pointerdown","click","touchstart","dblclick"]);var po=X("<button> </button>"),mo=X('<div class="language-tabs svelte-1hfe466"></div>');function xn(i,e){ve(e,!0);let t=me(e,"accentColor",3,"#88ddff");var s=mo();je(s,21,()=>la,Ve,(n,a)=>{var r=po();let l;r.__click=()=>e.onselect(o(a).code);let c;var d=T(r);U(()=>{l=Ae(r,1,"lang-tab svelte-1hfe466",null,l,{active:e.selectedLanguage===o(a).code}),c=ae(r,"",c,{"--accent-color":t()}),Pe(d,o(a).label)}),p(n,r)}),p(i,s),ye()}Je(["click"]);var vo=X("<button></button>"),yo=X('<div class="color-picker svelte-wbnbhn"></div>'),So=X('<div class="color-section svelte-wbnbhn"><span class="color-label-title svelte-wbnbhn"> </span> <button class="color-button svelte-wbnbhn" title="Change color"><span class="color-preview svelte-wbnbhn"></span> <span class="color-label svelte-wbnbhn">Change</span></button> <!></div>');function wo(i,e){ve(e,!0);let t=me(e,"label",3,"Color"),s=me(e,"accentColor",3,"#88ddff"),n=se(!1),a=se(null);Ee(()=>{o(n)&&o(a)&&requestAnimationFrame(()=>{o(a)?.scrollIntoView({behavior:"smooth",block:"nearest"})})});function r(v){e.onselect(v)}function l(){H(n,!o(n))}var c=So(),d=T(c),h=T(d),m=M(d,2);m.__click=l;let S;var x=T(m);let C;var I=M(m,2);{var b=v=>{var w=yo();je(w,21,()=>e.colors,Ve,(u,g)=>{var P=vo();let f;P.__click=()=>r(o(g));let _;U(()=>{f=Ae(P,1,"color-swatch svelte-wbnbhn",null,f,{selected:e.selectedColor===o(g)}),ne(P,"title",o(g)),_=ae(P,"",_,{background:o(g),"--accent-color":s()})}),p(u,P)}),Tt(w,u=>H(a,u),()=>o(a)),p(v,w)};K(I,v=>{o(n)&&v(b)})}U(()=>{Pe(h,t()),S=ae(m,"",S,{"--accent-color":s()}),C=ae(x,"",C,{background:e.selectedColor})}),p(i,c),ye()}Je(["click"]);const Ss=400,_o=400,En=70;var bo=X('<div class="form-section svelte-vzwc0p"><div class="form-group svelte-vzwc0p"><label class="svelte-vzwc0p"> </label> <textarea rows="6" class="svelte-vzwc0p"></textarea></div></div>');function Io(i,e){ve(e,!0);let t=me(e,"contentPlaceholder",3,"Enter text..."),s=me(e,"idPrefix",3,"text-form"),n=me(e,"accentColor",3,"#88ddff");function a(S){const x=S.target;e.oncontentchange(x.value)}var r=bo();let l;var c=T(r),d=T(c),h=T(d),m=M(d,2);m.__input=a,U(()=>{l=ae(r,"",l,{"--accent-color":n()}),ne(d,"for",`${s()??""}-content`),Pe(h,`Content (max ${Ss} chars)`),ne(m,"id",`${s()??""}-content`),us(m,e.content),ne(m,"placeholder",t()),ne(m,"maxlength",Ss)}),p(i,r),ye()}Je(["input"]);var Co=X('<div class="panel-content svelte-7qe9ti"><!> <!> <div class="panel-extras svelte-7qe9ti"><!></div> <div class="panel-footer svelte-7qe9ti"><!> <!></div></div>');function Po(i,e){ve(e,!0);const t=()=>N(ai,"$dialogZones",a),s=()=>N(Cs,"$selectedDialogZoneId",a),n=()=>N(bs,"$isDialogZonePanelOpen",a),[a,r]=xe(),l="#88ddff";let c=se(Be(Gi)),d=V(()=>t().find(u=>u.id===s())??null),h=V(()=>o(d)?.texts.find(u=>u.language===o(c))??null);function m(u){s()&&Ia(s(),o(c),{content:u})}function S(){s()&&(sn(s()),fi())}function x(){fi()}function C(u){s()&&It(s(),{color:u})}function I(u){H(c,u,!0)}var b=Ie(),v=ge(b);{var w=u=>{$t(u,{panelId:"dialog-zone-panel",title:"Dialog Zone",initialRight:10,initialTop:160,width:280,height:450,minWidth:250,minHeight:370,maxWidth:500,maxHeight:700,resizable:!0,showClose:!0,onclose:x,children:(g,P)=>{var f=Co(),_=T(f);xn(_,{get selectedLanguage(){return o(c)},onselect:I,accentColor:l});var D=M(_,2);{let $=V(()=>o(h)?.content??"");Io(D,{get content(){return o($)},oncontentchange:m,contentPlaceholder:"Enter dialog text...",idPrefix:"dialog",accentColor:l})}var W=M(D,2),y=T(W);wo(y,{get colors(){return js},get selectedColor(){return o(d).color},onselect:C,label:"Zone Color",accentColor:l});var k=M(W,2),O=T(k);he(O,{variant:"cyan",onclick:x,children:($,E)=>{var Y=ue("CONFIRM");p($,Y)},$$slots:{default:!0}});var R=M(O,2);he(R,{variant:"red",onclick:S,children:($,E)=>{var Y=ue("DELETE");p($,Y)},$$slots:{default:!0}}),p(g,f)},$$slots:{default:!0}})};K(v,u=>{o(d)&&n()&&u(w)})}p(i,b),ye(),r()}var xo=X("<button> </button>"),Eo=X('<a target="_blank" rel="noopener noreferrer" class="url-preview svelte-6kd0po">Test link </a>'),Do=X('<button><img class="svelte-6kd0po"/></button>'),To=X('<div class="style-picker svelte-6kd0po"></div>'),ko=X('<div class="panel-content svelte-6kd0po"><div class="social-size-row svelte-6kd0po"><div class="social-size-section svelte-6kd0po"><span class="section-label svelte-6kd0po">Size</span> <div class="size-buttons svelte-6kd0po"></div></div></div> <div class="panel-extras svelte-6kd0po"><div class="url-section svelte-6kd0po"><label for="social-url" class="svelte-6kd0po">Link URL (opens on click)</label> <input id="social-url" type="url" placeholder="https://example.com" class="svelte-6kd0po"/> <!></div> <div class="style-section svelte-6kd0po"><span class="section-label svelte-6kd0po">Social Icon</span> <button class="style-button svelte-6kd0po" title="Change social icon"><img alt="Current social" class="style-preview svelte-6kd0po"/> <span class="style-label svelte-6kd0po"> </span></button> <!></div></div> <div class="panel-footer svelte-6kd0po"><!> <!></div></div>');function Mo(i,e){ve(e,!0);const t=()=>N(wa,"$selectedSocial",a),s=()=>N(Vt,"$selectedSocialId",a),n=()=>N(ts,"$isSocialPanelOpen",a),[a,r]=xe(),l=Ps.SOCIAL.css;let c=V(t),d=V(()=>o(c)?pr(o(c).scale??Dt):"M"),h=V(()=>o(c)?ms.find(_=>_.key===o(c).socialKey):null);function m(_){const D=_.target;s()&&cs(s(),{url:D.value||void 0})}function S(_){s()&&cs(s(),{scale:fr(_)})}function x(){s()&&en(s())}function C(){ua(),Bt(null)}let I=se(!1),b=se(null),v=se(null);function w(_){s()&&cs(s(),{socialKey:_})}function u(){H(I,!o(I))}Ee(()=>{o(I)&&o(b)&&requestAnimationFrame(()=>{o(b)?.scrollIntoView({behavior:"smooth",block:"nearest"})})}),Ee(()=>{if(!o(I))return;function _(D){const W=D.target;o(b)&&!o(b).contains(W)&&o(v)&&!o(v).contains(W)&&H(I,!1)}return document.addEventListener("click",_),()=>document.removeEventListener("click",_)});var g=Ie(),P=ge(g);{var f=_=>{$t(_,{panelId:"social-panel",title:"Edit Social",initialRight:10,initialTop:160,width:280,height:350,minWidth:250,minHeight:300,maxWidth:400,maxHeight:500,resizable:!0,showClose:!0,onclose:C,children:(D,W)=>{var y=ko(),k=T(y),O=T(k),R=M(T(O),2);je(R,21,()=>Object.entries(Qt),Ve,(de,pe)=>{var fe=V(()=>Xn(o(pe),2));let we=()=>o(fe)[0],Ye=()=>o(fe)[1].label;var He=xo();let Re;He.__click=()=>S(we());var dt=T(He);U(()=>{Re=Ae(He,1,"size-btn svelte-6kd0po",null,Re,{active:o(d)===we()}),ne(He,"title",Ye()),Pe(dt,we())}),p(de,He)});var $=M(k,2),E=T($),Y=M(T(E),2);Y.__input=m;var B=M(Y,2);{var ee=de=>{var pe=Eo();U(()=>ne(pe,"href",o(c).url)),p(de,pe)};K(B,de=>{o(c).url&&de(ee)})}var z=M(E,2),j=M(T(z),2);j.__click=u;var Q=T(j),L=M(Q,2),F=T(L);Tt(j,de=>H(v,de),()=>o(v));var te=M(j,2);{var le=de=>{var pe=To();je(pe,21,()=>ms,Ve,(fe,we)=>{var Ye=Do();let He;Ye.__click=()=>w(o(we).key);var Re=T(Ye);U(()=>{He=Ae(Ye,1,"style-item svelte-6kd0po",null,He,{selected:o(c).socialKey===o(we).key}),ne(Ye,"title",o(we).name),ne(Re,"src",o(we).path),ne(Re,"alt",o(we).name)}),p(fe,Ye)}),Tt(pe,fe=>H(b,fe),()=>o(b)),p(de,pe)};K(te,de=>{o(I)&&de(le)})}var re=M($,2),ce=T(re);he(ce,{variant:"pink",onclick:C,children:(de,pe)=>{var fe=ue("CONFIRM");p(de,fe)},$$slots:{default:!0}});var Se=M(ce,2);he(Se,{variant:"red",onclick:x,children:(de,pe)=>{var fe=ue("DELETE");p(de,fe)},$$slots:{default:!0}}),U(()=>{ae(y,`--accent-color: ${l}`),us(Y,o(c).url??""),ne(Q,"src",o(h)?.path??""),Pe(F,o(h)?.name??"Select")}),p(D,y)},$$slots:{default:!0}})};K(P,_=>{n()&&o(c)&&_(f)})}p(i,g),ye(),r()}Je(["click","input"]);var Ao=X('<div class="panel-content svelte-j84kgd"><!> <div class="form-section svelte-j84kgd"><div class="form-group svelte-j84kgd"><label for="npc-content" class="svelte-j84kgd"> </label> <textarea id="npc-content" placeholder="Enter dialog text..." rows="8" class="svelte-j84kgd"></textarea></div> <div class="form-group slider-group svelte-j84kgd"><label for="npc-trigger-radius" class="svelte-j84kgd">Trigger Radius</label> <input type="range" id="npc-trigger-radius" step="100" class="svelte-j84kgd"/></div></div> <div class="panel-footer svelte-j84kgd"><!> <!></div></div>');function Ho(i,e){ve(e,!0);const t=()=>N(ri,"$selectedNPC",n),s=()=>N(es,"$isNPCConfigPanelOpen",n),[n,a]=xe(),r="#e67e22",l=200,c=100,d=500;let h=se(Be(Gi)),m=V(()=>t()?.dialog?.find(f=>f.language===o(h))??null),S=V(()=>t()?ps(t().npcId)?.name??t().npcId:"NPC"),x=V(()=>t()?.triggerRadius??l);function C(f){if(!t())return;const _=f.target;Ea(t().id,o(h),{content:_.value})}function I(f){if(!t())return;const _=f.target;oi(t().id,{triggerRadius:parseInt(_.value,10)})}function b(){t()&&an(t().id)}function v(){ha(),Ht()}function w(f){H(h,f,!0)}var u=Ie(),g=ge(u);{var P=f=>{$t(f,{panelId:"npc-config-panel",get title(){return o(S)},initialRight:10,initialTop:160,width:280,height:450,minWidth:250,minHeight:370,maxWidth:500,maxHeight:700,resizable:!0,showClose:!0,onclose:v,children:(_,D)=>{var W=Ao(),y=T(W);xn(y,{get selectedLanguage(){return o(h)},onselect:w,accentColor:r});var k=M(y,2);ae(k,"",{},{"--accent-color":r});var O=T(k),R=T(O),$=T(R),E=M(R,2);E.__input=C;var Y=M(O,2),B=M(T(Y),2);ne(B,"min",c),ne(B,"max",d),B.__input=I;var ee=M(k,2),z=T(ee);he(z,{variant:"cyan",onclick:v,children:(Q,L)=>{var F=ue("CONFIRM");p(Q,F)},$$slots:{default:!0}});var j=M(z,2);he(j,{variant:"red",onclick:b,children:(Q,L)=>{var F=ue("DELETE");p(Q,F)},$$slots:{default:!0}}),U(()=>{Pe($,`Content (max ${Ss} chars)`),us(E,o(m)?.content??""),ne(E,"maxlength",Ss),us(B,o(x))}),p(_,W)},$$slots:{default:!0}})};K(g,f=>{s()&&t()&&f(P)})}p(i,u),ye(),a()}Je(["input"]);var $o=X('<div class="temp-zone-button svelte-1vrg7di"><!></div>');function Oo(i,e){ve(e,!0);const t=()=>N(Wi,"$builderCameraInfo",a),s=()=>N(Oe,"$builderEditMode",a),n=()=>N(ct,"$isDraggingInBuilder",a),[a,r]=xe();let l=se(null),c=null,d=null,h=se(null);function m(v){c&&clearTimeout(c),H(l,v,!0),H(h,t()?.scrollX??null,!0),c=setTimeout(()=>{H(l,null),H(h,null)},2e3)}function S(){o(l)&&(De.emit(be.DIALOG_ZONE_CREATE_AT,{worldX:o(l).worldX}),H(l,null),H(h,null),c&&(clearTimeout(c),c=null))}function x(){H(l,null),H(h,null),c&&(clearTimeout(c),c=null)}_s(()=>{d=De.on(be.TEMP_ZONE_BUTTON_SHOW,m);const v=De.on(be.TEMP_ZONE_BUTTON_HIDE,x);return()=>{d?.unsubscribe(),v.unsubscribe()}}),Wn(()=>{c&&clearTimeout(c)}),Ee(()=>{s()!=="dialogs"&&(H(l,null),H(h,null))}),Ee(()=>{const v=t()?.scrollX;o(l)&&o(h)!==null&&v!==void 0&&Math.abs(v-o(h))>10&&(H(l,null),H(h,null),c&&(clearTimeout(c),c=null))});var C=Ie(),I=ge(C);{var b=v=>{var w=$o(),u=T(w);he(u,{variant:"cyan",width:"90px",onclick:S,children:(g,P)=>{var f=ue("+ ZONE");p(g,f)},$$slots:{default:!0}}),U(()=>ae(w,`left: ${o(l).screenX??""}px; top: ${o(l).screenY-50}px;${n()?" pointer-events: none;":""}`)),p(v,w)};K(I,v=>{o(l)&&s()==="dialogs"&&v(b)})}p(i,C),ye(),r()}var Ro=X('<div class="item-controls svelte-1529z5h"><div class="controls-row svelte-1529z5h"><!> <!> <!></div></div>');function Lo(i,e){ve(e,!0);const t=()=>N(ni,"$selectedItem",d),s=()=>N(Ji,"$selectedItemScreenPosition",d),n=()=>N(kt,"$selectedItemId",d),a=()=>N(ga,"$selectedItemPhysicsEnabled",d),r=()=>N(fa,"$selectedItemFlipX",d),l=()=>N(Oe,"$builderEditMode",d),c=()=>N(ct,"$isDraggingInBuilder",d),[d,h]=xe();let m=V(()=>t()?Aa(t().assetKey):!1),S=V(()=>{const u=s();if(!u)return null;const g=10,P=40,f=o(m)?290:200;let _=u.screenY-u.itemHeight/2-45;const D=g+P;_<D&&(_=u.screenY+u.itemHeight/2+10);const W=window.innerHeight-P-g;_>W&&(_=W);let y=u.screenX;const k=f/2,O=k+g,R=window.innerWidth-k-g;return y<O&&(y=O),y>R&&(y=R),{x:y,y:_}});function x(){n()&&va(n(),!a())}function C(){n()&&ya(n(),!r())}function I(){n()&&(ma(n()),Ht())}var b=Ie(),v=ge(b);{var w=u=>{var g=Ro(),P=T(g),f=T(P);{let y=V(()=>r()?"orange":"blue");he(f,{get variant(){return o(y)},title:"Flip item horizontally",onclick:C,children:(k,O)=>{var R=ue("Flip");p(k,R)},$$slots:{default:!0}})}var _=M(f,2);{var D=y=>{{let k=V(()=>a()?"orange":"blue");he(y,{get variant(){return o(k)},title:"Toggle physics: item will block player movement",onclick:x,children:(O,R)=>{var $=ue();U(()=>Pe($,a()?"Ghost":"Solid")),p(O,$)},$$slots:{default:!0}})}};K(_,y=>{o(m)&&y(D)})}var W=M(_,2);he(W,{variant:"red",title:"Delete selected item",onclick:I,children:(y,k)=>{var O=ue("DEL");p(y,O)},$$slots:{default:!0}}),U(()=>ae(g,`left: ${o(S).x??""}px; top: ${o(S).y??""}px;${c()?" pointer-events: none;":""}`)),p(u,g)};K(v,u=>{l()!=="dialogs"&&n()&&o(S)&&u(w)})}p(i,b),ye(),h()}var No=X('<div class="npc-controls svelte-wxsibf"><div class="controls-row svelte-wxsibf"><!> <!> <!></div></div>');function Xo(i,e){ve(e,!0);const t=()=>N(nn,"$selectedNPCScreenPosition",l),s=()=>N(ri,"$selectedNPC",l),n=()=>N(Pa,"$selectedNPCFlipX",l),a=()=>N(Oe,"$builderEditMode",l),r=()=>N(ct,"$isDraggingInBuilder",l),[l,c]=xe();let d=V(()=>{const b=t();if(!b)return null;const v=10,w=40,u=270;let g=b.screenY-b.npcHeight/2-45;const P=v+w;g<P&&(g=b.screenY+b.npcHeight/2+10);const f=window.innerHeight-w-v;g>f&&(g=f);let _=b.screenX;const D=u/2,W=D+v,y=window.innerWidth-D-v;return _<W&&(_=W),_>y&&(_=y),{x:_,y:g}});function h(){s()&&Da(s().id,!n())}function m(){ji()}function S(){s()&&(an(s().id),Ht())}var x=Ie(),C=ge(x);{var I=b=>{var v=No(),w=T(v),u=T(w);{let f=V(()=>n()?"orange":"blue");he(u,{get variant(){return o(f)},title:"Flip NPC horizontally",onclick:h,children:(_,D)=>{var W=ue("Flip");p(_,W)},$$slots:{default:!0}})}var g=M(u,2);he(g,{variant:"cyan",title:"Edit NPC dialog",onclick:m,children:(f,_)=>{var D=ue("EDIT");p(f,D)},$$slots:{default:!0}});var P=M(g,2);he(P,{variant:"red",title:"Delete selected NPC",onclick:S,children:(f,_)=>{var D=ue("DEL");p(f,D)},$$slots:{default:!0}}),U(()=>ae(v,`left: ${o(d).x??""}px; top: ${o(d).y??""}px;${r()?" pointer-events: none;":""}`)),p(b,v)};K(C,b=>{a()!=="dialogs"&&s()&&o(d)&&b(I)})}p(i,x),ye(),c()}var Wo=X('<div class="zone-controls svelte-7umuek"><div class="controls-row svelte-7umuek"><!> <!> <!></div></div>');function Yo(i,e){ve(e,!0);const t=()=>N(tn,"$selectedDialogZoneScreenPosition",r),s=()=>N(Cs,"$selectedDialogZoneId",r),n=()=>N(Oe,"$builderEditMode",r),a=()=>N(ct,"$isDraggingInBuilder",r),[r,l]=xe();let c=V(()=>{const I=t();if(!I)return null;const b=10,v=120,w=85;let u=I.screenY;const g=b+v/2,P=window.innerHeight-v/2-b;u<g&&(u=g),u>P&&(u=P);let f=I.screenX;const _=w/2,D=_+b,W=window.innerWidth-_-b;return f<D&&(f=D),f>W&&(f=W),{x:f,y:u}});function d(){qi()}function h(){s()&&(sn(s()),Zt(null))}function m(){Zt(null)}var S=Ie(),x=ge(S);{var C=I=>{var b=Wo(),v=T(b),w=T(v);he(w,{variant:"cyan",title:"Edit zone content (or double-click)",onclick:d,children:(P,f)=>{var _=ue("EDIT");p(P,_)},$$slots:{default:!0}});var u=M(w,2);he(u,{variant:"red",title:"Delete selected zone",onclick:h,children:(P,f)=>{var _=ue("DEL");p(P,_)},$$slots:{default:!0}});var g=M(u,2);he(g,{variant:"default",title:"Deselect zone",onclick:m,children:(P,f)=>{var _=ue("DONE");p(P,_)},$$slots:{default:!0}}),U(()=>ae(b,`left: ${o(c).x??""}px; top: ${o(c).y??""}px;${a()?" pointer-events: none;":""}`)),p(I,b)};K(x,I=>{n()==="dialogs"&&s()&&o(c)&&I(C)})}p(i,S),ye(),l()}var Bo=X('<div class="social-controls svelte-q16c5x"><div class="controls-row svelte-q16c5x"><!> <!></div></div>');function Zo(i,e){ve(e,!0);const t=()=>N(Qi,"$selectedSocialScreenPosition",r),s=()=>N(Vt,"$selectedSocialId",r),n=()=>N(Oe,"$builderEditMode",r),a=()=>N(ct,"$isDraggingInBuilder",r),[r,l]=xe();let c=V(()=>{const C=t();if(!C)return null;const I=10,b=40,v=190;let w=C.screenY-C.socialHeight/2-45;const u=I+b;w<u&&(w=C.screenY+C.socialHeight/2+10);const g=window.innerHeight-b-I;w>g&&(w=g);let P=C.screenX;const f=v/2,_=f+I,D=window.innerWidth-f-I;return P<_&&(P=_),P>D&&(P=D),{x:P,y:w}});function d(){Vi()}function h(){s()&&(en(s()),Bt(null))}var m=Ie(),S=ge(m);{var x=C=>{var I=Bo(),b=T(I),v=T(b);he(v,{variant:"pink",title:"Edit social settings (or double-click)",onclick:d,children:(u,g)=>{var P=ue("EDIT");p(u,P)},$$slots:{default:!0}});var w=M(v,2);he(w,{variant:"red",title:"Delete selected social",onclick:h,children:(u,g)=>{var P=ue("DEL");p(u,P)},$$slots:{default:!0}}),U(()=>ae(I,`left: ${o(c).x??""}px; top: ${o(c).y??""}px;${a()?" pointer-events: none;":""}`)),p(C,I)};K(S,C=>{n()!=="dialogs"&&s()&&o(c)&&C(x)})}p(i,m),ye(),l()}var Go=X('<div class="hstack svelte-13tonpt"><!></div>');function Fo(i,e){let t=me(e,"gap",3,"10px"),s=me(e,"align",3,"center");var n=Go(),a=T(n);Ut(a,()=>e.children??Ge),U(()=>ae(n,`gap: ${t()??""}; align-items: ${(s()==="start"?"flex-start":s()==="end"?"flex-end":s())??""};`)),p(i,n)}var zo=X('<div class="vstack svelte-eir7yr"><!></div>');function Ko(i,e){let t=me(e,"gap",3,"10px"),s=me(e,"align",3,"stretch");var n=zo(),a=T(n);Ut(a,()=>e.children??Ge),U(()=>ae(n,`gap: ${t()??""}; align-items: ${(s()==="start"?"flex-start":s()==="end"?"flex-end":s())??""};`)),p(i,n)}var Uo=X("<div><!></div>");function ws(i,e){const t=()=>N(ct,"$isDraggingInBuilder",s),[s,n]=xe();let a=me(e,"padding",3,"10px");var r=Uo();let l;var c=T(r);Ut(c,()=>e.children??Ge),U(()=>{l=Ae(r,1,`fixed fixed--${e.position??""}`,"svelte-cx4lc",l,{"dragging-in-builder":t()}),ae(r,`--padding: ${a()??""};`)}),p(i,r),n()}var jo=X("<div><!> <!></div>"),Vo=X("<!> <!>",1),qo=X("<!> <!> <!> <!>",1),Jo=X("<div><!></div>"),Qo=X("<!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!>",1);function el(i,e){ve(e,!0);const t=()=>N(kt,"$selectedItemId",h),s=()=>N(Cs,"$selectedDialogZoneId",h),n=()=>N(Vt,"$selectedSocialId",h),a=()=>N(Oe,"$builderEditMode",h),r=()=>N(gs,"$gridSnappingEnabled",h),l=()=>N(at,"$isItemPaletteOpen",h),c=()=>N(it,"$isSocialPaletteOpen",h),d=()=>N(rt,"$isNPCPaletteOpen",h),[h,m]=xe(),S=600;let x=se(Be(typeof window<"u"?window.innerWidth<S:!1)),C=V(()=>o(x)&&(t()!==null||s()!==null||n()!==null));Ee(()=>{function B(){H(x,window.innerWidth<S)}return window.addEventListener("resize",B),()=>window.removeEventListener("resize",B)});function I(B){const ee=B.target;ee.closest(".draggable-panel")||ee.tagName!=="CANVAS"&&(at.set(!1),it.set(!1),rt.set(!1),ts.set(!1),bs.set(!1),es.set(!1))}Ee(()=>(window.addEventListener("dblclick",I),()=>window.removeEventListener("dblclick",I)));function b(){console.log("[BuilderUI] handleSave called, switching to game...");const B=Gr();console.log("[BuilderUI] switchToGame result:",B)}function v(){na()}function w(){De.emit(be.DIALOG_ZONE_CREATE)}var u=Qo(),g=ge(u);Lo(g,{});var P=M(g,2);Xo(P,{});var f=M(P,2);Yo(f,{});var _=M(f,2);Zo(_,{});var D=M(_,2);{var W=B=>{no(B,{})},y=B=>{var ee=Ie(),z=ge(ee);{var j=L=>{Po(L,{})},Q=L=>{var F=Ie(),te=ge(F);{var le=ce=>{lo(ce,{})},re=ce=>{var Se=Ie(),de=ge(Se);{var pe=fe=>{fo(fe,{})};K(de,fe=>{a()==="npcs"&&fe(pe)},!0)}p(ce,Se)};K(te,ce=>{a()==="socials"?ce(le):ce(re,!1)},!0)}p(L,F)};K(z,L=>{a()==="dialogs"?L(j):L(Q,!1)},!0)}p(B,ee)};K(D,B=>{a()==="items"?B(W):B(y,!1)})}var k=M(D,2);Mo(k,{});var O=M(k,2);Ho(O,{});var R=M(O,2);Oo(R,{});var $=M(R,2),E=M($,2);ws(E,{position:"top-left",children:(B,ee)=>{var z=jo();let j;var Q=T(z);he(Q,{variant:"green",width:"100px",onclick:b,children:(F,te)=>{var le=ue("SAVE");p(F,le)},$$slots:{default:!0}});var L=M(Q,2);{let F=V(()=>r()?"blue":"orange");he(L,{get variant(){return o(F)},width:"80px",onclick:v,title:"Toggle grid snapping",children:(te,le)=>{var re=ue();U(()=>Pe(re,r()?"FREE":"SNAP")),p(te,re)},$$slots:{default:!0}})}U(()=>j=Ae(z,1,"left-buttons svelte-1lbkour",null,j,{"hide-left":o(C)})),p(B,z)},$$slots:{default:!0}});var Y=M(E,2);ws(Y,{position:"top-right",children:(B,ee)=>{var z=Jo();let j;var Q=T(z);Ko(Q,{align:"end",children:(L,F)=>{var te=qo(),le=ge(te);{let de=V(()=>a()==="items"&&l()?"orange":"blue");he(le,{get variant(){return o(de)},onclick:()=>{a()==="items"?ca():(Xt("items"),at.set(!0))},title:"Edit items",children:(pe,fe)=>{var we=ue("ITEMS");p(pe,we)},$$slots:{default:!0}})}var re=M(le,2);{let de=V(()=>a()==="socials"&&c()?"orange":"pink");he(re,{get variant(){return o(de)},onclick:()=>{a()==="socials"?da():(Xt("socials"),it.set(!0))},title:"Edit social icons",children:(pe,fe)=>{var we=ue("SOCIALS");p(pe,we)},$$slots:{default:!0}})}var ce=M(re,2);{let de=V(()=>a()==="npcs"&&d()?"orange":"green");he(ce,{get variant(){return o(de)},onclick:()=>{a()==="npcs"?Ui():(Xt("npcs"),rt.set(!0))},title:"Edit NPCs",children:(pe,fe)=>{var we=ue("NPCS");p(pe,we)},$$slots:{default:!0}})}var Se=M(ce,2);Fo(Se,{children:(de,pe)=>{var fe=Vo(),we=ge(fe);{var Ye=Re=>{he(Re,{variant:"cyan",width:"100px",onclick:w,title:"Create new dialog zone at center of view",children:(dt,Ds)=>{var Ot=ue("+ ZONE");p(dt,Ot)},$$slots:{default:!0}})};K(we,Re=>{a()==="dialogs"&&Re(Ye)})}var He=M(we,2);{let Re=V(()=>a()==="dialogs"?"orange":"cyan");he(He,{get variant(){return o(Re)},onclick:()=>{a()==="dialogs"?Xt("items"):Xt("dialogs")},title:"Edit dialog zones",children:(dt,Ds)=>{var Ot=ue("DIALOGS");p(dt,Ot)},$$slots:{default:!0}})}p(de,fe)},$$slots:{default:!0}}),p(L,te)},$$slots:{default:!0}}),U(()=>j=Ae(z,1,"right-buttons svelte-1lbkour",null,j,{"hide-right":o(C)})),p(B,z)},$$slots:{default:!0}}),p(i,u),ye(),m()}var tl=X('<img class="skin-preview-img svelte-12jgjc8"/>'),sl=X('<canvas width="96" height="96" class="skin-preview svelte-12jgjc8"></canvas>'),il=X('<button type="button"><div class="skin-preview-container svelte-12jgjc8"><!></div> <span class="skin-name svelte-12jgjc8"> </span></button>'),nl=X('<span class="custom-icon svelte-12jgjc8"></span>'),al=X('<span class="custom-icon svelte-12jgjc8"></span>'),rl=X('<button class="edit-btn svelte-12jgjc8" type="button">EDIT</button>'),ol=X('<button class="background-card svelte-12jgjc8" type="button"><div class="preview-container svelte-12jgjc8"><img class="preview-image svelte-12jgjc8"/></div> <span class="background-name svelte-12jgjc8"> </span></button>'),ll=X('<div class="background-select-screen svelte-12jgjc8"><div class="content svelte-12jgjc8"><h1 class="title svelte-12jgjc8">SELECT CHARACTER</h1> <div class="skins-grid svelte-12jgjc8"><!> <div class="skin-card-wrapper svelte-12jgjc8"><button type="button"><div class="skin-preview-container custom-preview svelte-12jgjc8"><!></div> <span class="skin-name svelte-12jgjc8">CUSTOM</span></button> <!></div></div> <h1 class="title svelte-12jgjc8">SELECT BACKGROUND</h1> <div class="backgrounds-grid svelte-12jgjc8"></div></div></div>');function cl(i,e){ve(e,!0);const t="custom";function s(){window.location.href="./builder.html"}const n=ze,a=Ce,r=Js()!==null,l=localStorage.getItem("useModularPlayer")==="true";let c=se(Be(l&&r?t:St.getSkinId())),d=Be({}),h=Be({});Ee(()=>{a.forEach(E=>{const Y=ds(E),B=new Image;B.onload=()=>{h[E.id]=!0},B.onerror=()=>{h[E.id]=!1,S(E)},B.src=`./${Y}/preview.png`})});function m(E){return`./${ds(E)}/preview.png`}function S(E){const Y=d[E.id];if(!Y)return;const B=Y.getContext("2d");if(!B)return;const ee=E.frameWidth??48,z=E.frameHeight??48,j=ds(E),Q=new Image;Q.src=`./${j}/idle.png`,Q.onload=()=>{B.clearRect(0,0,Y.width,Y.height),B.imageSmoothingEnabled=!1;const L=Y.width/ee,F=Y.height/z,te=Math.min(L,F),le=ee*te,re=z*te,ce=(Y.width-le)/2,Se=(Y.height-re)/2;B.drawImage(Q,0,0,ee,z,ce,Se,le,re)}}function x(E){return`./assets/backgrounds/${E}/preview.png`}function C(E){if(E===t){if(!r){s();return}H(c,t),localStorage.setItem("useModularPlayer","true"),Gs.set(t)}else H(c,E,!0),St.setSkin(E),localStorage.setItem("useModularPlayer","false"),Gs.set(E)}function I(){s()}function b(E){lt.setBackgroundByIndex(E),Fi.set(n[E].name),zi.set(!0),Fr()}var v=ll(),w=T(v),u=M(T(w),2),g=T(u);je(g,17,()=>a,Ve,(E,Y)=>{var B=il();let ee;B.__click=()=>C(o(Y).id);var z=T(B),j=T(z);{var Q=le=>{var re=tl();U(ce=>{ne(re,"src",ce),ne(re,"alt",o(Y).name)},[()=>m(o(Y))]),p(le,re)},L=le=>{var re=sl();Tt(re,(ce,Se)=>d[Se.id]=ce,ce=>d?.[ce.id],()=>[o(Y)]),p(le,re)};K(j,le=>{h[o(Y).id]?le(Q):le(L,!1)})}var F=M(z,2),te=T(F);U(()=>{ee=Ae(B,1,"skin-card svelte-12jgjc8",null,ee,{selected:o(c)===o(Y).id}),Pe(te,o(Y).name)}),p(E,B)});var P=M(g,2),f=T(P);let _;f.__click=()=>C(t);var D=T(f),W=T(D);{var y=E=>{var Y=nl();p(E,Y)},k=E=>{var Y=al();p(E,Y)};K(W,E=>{r?E(y):E(k,!1)})}var O=M(f,2);{var R=E=>{var Y=rl();Y.__click=I,p(E,Y)};K(O,E=>{r&&o(c)===t&&E(R)})}var $=M(u,4);je($,21,()=>n,Ve,(E,Y,B)=>{var ee=ol();ee.__click=()=>b(B);var z=T(ee),j=T(z),Q=M(z,2),L=T(Q);U(F=>{ne(j,"src",F),ne(j,"alt",o(Y).name),Pe(L,o(Y).name)},[()=>x(o(Y).folder)]),p(E,ee)}),U(()=>_=Ae(f,1,"skin-card custom-card svelte-12jgjc8",null,_,{selected:o(c)===t})),p(i,v),ye()}Je(["click"]);var dl=X('<div class="dialog-content svelte-hli3ii"> </div>'),hl=X("<div><!></div>");function ul(i,e){ve(e,!0);const t=()=>N(Ni,"$playerScreenPosition",n),s=()=>N(vn,"$activeDialogText",n),[n,a]=xe(),r=320,l=20;let c=V(()=>Math.max(10,window.innerHeight-t().y+En)),d=V(()=>window.innerWidth<=_o),h=V(()=>{if(o(d))return window.innerWidth/2;const I=r/2,b=I+l,v=window.innerWidth-I-l;return Math.max(b,Math.min(v,t().x))}),m=V(()=>o(d)?0:t().x-o(h));var S=Ie(),x=ge(S);{var C=I=>{var b=hl();let v;var w=T(b);{var u=g=>{var P=dl(),f=T(P);U(()=>Pe(f,s().content)),p(g,P)};K(w,g=>{s().content&&g(u)})}U(()=>{v=Ae(b,1,"dialog-bubble svelte-hli3ii",null,v,{narrow:o(d)}),ae(b,`bottom: ${o(c)??""}px; left: ${o(h)??""}px; --arrow-offset: ${o(m)??""}px;`)}),p(I,b)};K(x,I=>{s()&&I(C)})}p(i,S),ye(),a()}var gl=X('<div class="dialog-content svelte-b2j5a3"> </div>'),fl=X('<div class="npc-dialog-bubble svelte-b2j5a3"><!></div>');function pl(i,e){ve(e,!0);const t=()=>N(vn,"$activeDialogText",a),s=()=>N(di,"$activeNPCDialog",a),n=()=>N(wr,"$activeNPCDialogText",a),[a,r]=xe(),l=120;let c=V(()=>!!t()),d=V(()=>{if(!s())return 0;const C=s().screenY-s().npcHeight/2;let I=Math.max(10,window.innerHeight-C+En);return o(c)&&(I+=l),I}),h=V(()=>s()?s().screenX:0);var m=Ie(),S=ge(m);{var x=C=>{var I=fl(),b=T(I);{var v=w=>{var u=gl(),g=T(u);U(()=>Pe(g,n().content)),p(w,u)};K(b,w=>{n().content&&w(v)})}U(()=>ae(I,`bottom: ${o(d)??""}px; left: ${o(h)??""}px;`)),p(C,I)};K(S,C=>{n()&&s()&&C(x)})}p(i,m),ye(),r()}var ml=X('<div class="game-mask mask-top svelte-1u9aoac"></div> <div class="game-mask mask-bottom svelte-1u9aoac"></div> <div class="game-mask mask-left svelte-1u9aoac"></div> <div class="game-mask mask-right svelte-1u9aoac"></div> <div class="game-frame svelte-1u9aoac"><div class="frame-border frame-top svelte-1u9aoac"></div> <div class="frame-border frame-bottom svelte-1u9aoac"></div> <div class="frame-border frame-left svelte-1u9aoac"></div> <div class="frame-border frame-right svelte-1u9aoac"></div> <div class="frame-corner corner-top-left svelte-1u9aoac"></div> <div class="frame-corner corner-top-right svelte-1u9aoac"></div> <div class="frame-corner corner-bottom-left svelte-1u9aoac"></div> <div class="frame-corner corner-bottom-right svelte-1u9aoac"></div></div>',1);function vl(i,e){ve(e,!1);const t=()=>N(Fn,"$gameFrameColor",n),s=()=>N(ei,"$gameWorldDimensions",n),[n,a]=xe(),r=Ke(),l=Ke(),c=Ke(),d=Ke(),h=Ke(),m=Ke(),S=Ke(),x=Ke();Ue(()=>t(),()=>{H(r,t())}),Ue(()=>s(),()=>{H(l,s())}),Ue(()=>o(l),()=>{H(c,o(l).ready)}),Ue(()=>o(l),()=>{H(d,`
    top: ${o(l).offsetY}px;
    left: ${o(l).offsetX}px;
    width: ${o(l).worldWidth}px;
    height: ${o(l).worldHeight}px;
  `)}),Ue(()=>o(l),()=>{H(h,o(l).offsetY)}),Ue(()=>o(l),()=>{H(m,o(l).offsetX)}),Ue(()=>o(l),()=>{H(S,o(l).offsetX+o(l).worldWidth)}),Ue(()=>o(l),()=>{H(x,o(l).offsetY+o(l).worldHeight)}),Li();var C=Ie(),I=ge(C);{var b=v=>{var w=ml(),u=ge(w),g=M(u,2),P=M(g,2),f=M(P,2),_=M(f,2);U(()=>{ae(u,`height: ${o(h)??""}px; background: ${o(r)??""};`),ae(g,`top: ${o(x)??""}px; background: ${o(r)??""};`),ae(P,`top: ${o(h)??""}px; height: ${o(l),Kt(()=>o(l).worldHeight)??""}px; width: ${o(m)??""}px; background: ${o(r)??""};`),ae(f,`top: ${o(h)??""}px; height: ${o(l),Kt(()=>o(l).worldHeight)??""}px; left: ${o(S)??""}px; background: ${o(r)??""};`),ae(_,`--frame-thickness: 16px; --frame-color: ${o(r)??""}; ${o(d)??""}`)}),p(v,w)};K(I,v=>{o(c)&&v(b)})}p(i,C),ye(),a()}var yl=X("<!> <!>",1),Sl=X('<div class="touch-controls"><p class="touch-text">Tap and hold<br/>where you want<br/>to move</p></div>'),wl=X('<div class="desktop-controls"><div class="key-row"><div class="pixel-key">A</div> <div class="pixel-key">W</div> <div class="pixel-key">D</div></div> <p class="or-text">or</p> <div class="key-row"><div class="pixel-key"></div> <div class="pixel-key"></div> <div class="pixel-key"></div></div></div>'),_l=X('<div class="loader-overlay"><div class="pixel-loader"></div> <div class="loader-text">LOADING</div></div>'),bl=X('<div class="game-ui-wrapper svelte-1aa1t05"><!> <!> <!> <!> <dialog class="pixel-dialog"><h1>CONTROLS</h1> <div class="controls-content"><!></div></dialog> <!></div>');function Il(i,e){ve(e,!1);const t=()=>N(Wt,"$showControlsDialog",h),s=()=>N(ii,"$hasPlayerMoved",h),n=()=>N(zi,"$hasSelectedBackground",h),a=()=>N(zn,"$gameFrameVisible",h),r=()=>N(ia,"$isBuilderMode",h),l=()=>N(Fs,"$isLoading",h),c=()=>N(jt,"$currentLanguage",h),d=()=>N(Ki,"$isTouchDevice",h),[h,m]=xe();let S=Ke();function x(){const g=Pn.toggleLanguage();jt.set(g)}function C(g){!o(S)?.open||g.target.closest(".pixel-button")||Wt.set(!1)}function I(){const g=Br();if(!g){console.error("Cannot enter builder mode: map config not found");return}Zr(g)}Ue(()=>(o(S),t()),()=>{o(S)&&(t()?o(S).showModal():o(S).close())}),Ue(()=>(s(),o(S),Wt),()=>{s()&&o(S)?.open&&Wt.set(!1)}),Li(),Zn();var b=Ie();Xe("pointerdown",Yn,C);var v=ge(b);{var w=g=>{cl(g,{})},u=g=>{var P=bl(),f=T(P);{var _=L=>{vl(L,{})};K(f,L=>{a()&&!r()&&!l()&&L(_)})}var D=M(f,2);{var W=L=>{el(L,{})},y=L=>{var F=yl(),te=ge(F);ul(te,{});var le=M(te,2);pl(le,{}),p(L,F)};K(D,L=>{r()?L(W):L(y,!1)})}var k=M(D,2);{var O=L=>{ws(L,{position:"top-left",children:(F,te)=>{he(F,{variant:"green",width:"120px",onclick:I,title:"Toggle Builder Mode",children:(le,re)=>{var ce=ue("BUILD");p(le,ce)},$$slots:{default:!0}})},$$slots:{default:!0}})};K(k,L=>{r()||L(O)})}var R=M(k,2);{var $=L=>{ws(L,{position:"top-right",children:(F,te)=>{he(F,{variant:"default",width:"100px",onclick:x,title:"Toggle Language (L)",children:(le,re)=>{var ce=ue();U(Se=>Pe(ce,Se),[()=>(c(),Kt(()=>c().toUpperCase()))]),p(le,ce)},$$slots:{default:!0}})},$$slots:{default:!0}})};K(R,L=>{r()||L($)})}var E=M(R,2),Y=M(T(E),2),B=T(Y);{var ee=L=>{var F=Sl();p(L,F)},z=L=>{var F=wl();p(L,F)};K(B,L=>{d()?L(ee):L(z,!1)})}Tt(E,L=>H(S,L),()=>o(S));var j=M(E,2);{var Q=L=>{var F=_l();p(L,F)};K(j,L=>{l()&&L(Q)})}p(g,P)};K(v,g=>{n()?g(u,!1):g(w)})}p(i,b),ye(),m()}Ta();const Dn=document.getElementById("game-ui");if(!Dn)throw new Error("game-ui element not found!");Bn(Il,{target:Dn});jt.set(Pn.getLanguage());Gs.set(St.getSkinId());Fi.set(lt.getCurrentConfig().name);const Cl={type:G.AUTO,width:800,height:600,parent:"game-container",backgroundColor:"#000000",pixelArt:!0,roundPixels:!0,scale:{mode:G.Scale.RESIZE,autoCenter:G.Scale.CENTER_BOTH},input:{activePointers:3},physics:{default:"arcade",arcade:{gravity:{y:1e3,x:0},debug:!1}},audio:{noAudio:!0},scene:[]},Es=new G.Game(Cl);Es.scene.add(We.GAME,hi);Es.scene.add(We.BUILDER,Xr);Yr(Es);const Pl=Es.device.input.touch;Ki.set(Pl);const xl=performance.getEntriesByType("navigation")[0]&&performance.getEntriesByType("navigation")[0].type==="reload",El=sessionStorage.getItem("hasSeenControlsHint");(!El||xl)&&(sessionStorage.setItem("hasSeenControlsHint","true"),Wt.set(!0));
//# sourceMappingURL=main-BBso7VXZ.js.map
