import{t as Gi,i as Zn,s as Bn,a as Gn,c as Nn,u as zn,b as Xe,r as Ws,d as Qt,e as Kn,g as o,f as Un,h as Vn,j as jn,n as Je,m as rt,k as L,l as qn,o as Jn,p as Ys,q as Qn,M as lt,v as ea,w as ta,L as sa,x as ia,y as na,P as G,z as aa,A as at,B as Te,C as _e,D as te,E as nt,F,G as P,H as C,I as V,J as pt,K as z,N as De,O as pe,Q as Ee,R as J,S as Ve,T as S,U as Ce,V as $e,W as fe,X as es,Y as Z,Z as _s,_ as Ne,$ as Ke,a0 as ts,a1 as oe,a2 as le,a3 as Ni,a4 as ra,a5 as ot,a6 as zi,a7 as oa,a8 as la}from"./PixelButton-DPdsozSk.js";import"./phaser-DFK5Ua9d.js";const Ki=240,ca=48;function gs(i){const e=`assets/skins/static/${i.folder}`;return i.variant?`${e}/${i.variant}`:e}function Kt(i){const e=i.frameHeight??ca;return Ki/e}const Me=[{id:"succubus",name:"SUCCUBUS",folder:"succubus",variant:"basic",character:"human",frameWidth:156,frameHeight:72,facingLeft:!0,frameRates:{idle:8,run:12}}],Ui="succubus";class da{currentSkinId=Ui;constructor(){this.loadFromStorage()}loadFromStorage(){const e=localStorage.getItem("playerSkin");e&&this.isValidSkinId(e)&&(this.currentSkinId=e)}isValidSkinId(e){return Me.some(t=>t.id===e)}setSkin(e){this.isValidSkinId(e)&&(this.currentSkinId=e,localStorage.setItem("playerSkin",e))}getSkinId(){return this.currentSkinId}getSkinConfig(){return Me.find(e=>e.id===this.currentSkinId)||Me[0]}getSkinById(e){return Me.find(t=>t.id===e)}getAllSkins(){return Me}getAnimationPrefix(){const e=this.getSkinConfig();return`${e.character}-${e.id}`}}const xt=new da;function Vi(i,e,t=!1){if(i.multiple){if(e==null)return;if(!Zn(e))return Bn();for(var s of i.options)s.selected=e.includes(gi(s));return}for(s of i.options){var n=gi(s);if(Gn(n,e)){s.selected=!0;return}}(!t||e!==void 0)&&(i.selectedIndex=-1)}function ha(i){var e=new MutationObserver(()=>{Vi(i,i.__value)});e.observe(i,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Gi(()=>{e.disconnect()})}function gi(i){return"__value"in i?i.__value:i.value}function ua(i=!1){const e=Nn,t=e.l.u;if(!t)return;let s=()=>Un(e.s);if(i){let n=0,a={};const r=Vn(()=>{let l=!1;const c=e.s;for(const d in c)c[d]!==a[d]&&(a[d]=c[d],l=!0);return l&&n++,n});s=()=>o(r)}t.b.length&&zn(()=>{fi(e,s),Ws(t.b)}),Xe(()=>{const n=Qt(()=>t.m.map(Kn));return()=>{for(const a of n)typeof a=="function"&&a()}}),t.a.length&&Xe(()=>{fi(e,s),Ws(t.a)})}function fi(i,e){if(i.l.s)for(const t of i.l.s)o(t);e()}let Zs=Symbol();function O(i,e,t){const s=t[e]??={store:null,source:rt(void 0),unsubscribe:Je};if(s.store!==i&&!(Zs in t))if(s.unsubscribe(),s.store=i??null,i==null)s.source.v=void 0,s.unsubscribe=Je;else{var n=!0;s.unsubscribe=js(i,a=>{n?s.source.v=a:L(s.source,a)}),n=!1}return i&&Zs in t?je(i):o(s.source)}function He(){const i={};function e(){Gi(()=>{for(var t in i)i[t].unsubscribe();jn(i,Zs,{enumerable:!1,value:!0})})}return[i,e]}function js(i,e,t){if(i==null)return e(void 0),t&&t(void 0),Je;const s=Qt(()=>i.subscribe(e,t));return s.unsubscribe?()=>s.unsubscribe():s}const Dt=[];function ga(i,e){return{subscribe:ee(i,e).subscribe}}function ee(i,e=Je){let t=null;const s=new Set;function n(l){if(qn(i,l)&&(i=l,t)){const c=!Dt.length;for(const d of s)d[1](),Dt.push(d,i);if(c){for(let d=0;d<Dt.length;d+=2)Dt[d][0](Dt[d+1]);Dt.length=0}}}function a(l){n(l(i))}function r(l,c=Je){const d=[l,c];return s.add(d),s.size===1&&(t=e(n,a)||Je),l(i),()=>{s.delete(d),s.size===0&&t&&(t(),t=null)}}return{set:n,update:a,subscribe:r}}function Le(i,e,t){const s=!Array.isArray(i),n=s?[i]:i;if(!n.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const a=e.length<2;return ga(t,(r,l)=>{let c=!1;const d=[];let h=0,v=Je;const w=()=>{if(h)return;v();const p=e(s?d[0]:d,r,l);a?r(p):v=typeof p=="function"?p:Je},y=n.map((p,_)=>js(p,I=>{d[_]=I,h&=~(1<<_),c&&w()},()=>{h|=1<<_}));return c=!0,w(),function(){Ws(y),v(),c=!1}})}function je(i){let e;return js(i,t=>e=t)(),e}function fa(){return`zone_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const Bs=["#e74c3c","#e67e22","#f1c40f","#2ecc71","#1abc9c","#3498db","#9b59b6","#e91e8f"];function pa(){return Bs[Math.floor(Math.random()*Bs.length)]}function ma(i,e=300){return{id:fa(),x:i,width:e,color:pa(),texts:[{language:"cs",title:"",content:""}]}}function va(i,e){const t=i.texts.find(s=>s.language===e);return t||i.texts[0]||null}const ss=ee("cs"),Gs=ee("cat_orange"),ji=ee("Forest"),qi=ee(!1),Ns=ee(!1),Nt=ee(!1),Ji=ee(!1),qs=ee(!1),ya=ee("#2a1a0a"),Sa=ee(!0),Qi=ee(null),ba=Le([Qi,ss],([i,e])=>i?va(i,e):null);function Ps(i){Qi.set(i)}const en=ee({x:0,y:0});function wa(i,e){en.set({x:i,y:e})}const tn=ee({scrollX:0,scrollY:0,zoom:1});function _a(i,e,t=1){tn.set({scrollX:i,scrollY:e,zoom:t})}const sn=ee({worldWidth:640,worldHeight:640,offsetX:0,offsetY:0});function Ia(i,e,t,s,n=1){const a=i*n,r=e*n,l=Math.max(0,(t-a)/2),c=Math.max(0,(s-r)/2);sn.set({worldWidth:a,worldHeight:r,offsetX:l,offsetY:c})}const zs=ee(!1);function nn(){zs.set(!0),setTimeout(()=>zs.set(!1),150)}const Ye={BACKGROUND_LAYER_START:-99,GROUND_REFERENCE:-1,ITEMS_BEHIND:5,PLAYER:10,ITEMS_FRONT:15,FOREGROUND_LAYER_START:50,SELECTION_GRAPHICS:999,GRID_OVERLAY:1e3};function Js(i){return i==="behind"?Ye.ITEMS_BEHIND:Ye.ITEMS_FRONT}const Ht=3;async function an(i,e){const t=Jn(e);return new Promise(s=>{let n=!1;if(t.forEach(a=>{const r=Ys(a);if(!i.textures.exists(r)){n=!0;const l=Qn(a);i.load.spritesheet(r,l,{frameWidth:lt.WIDTH,frameHeight:lt.HEIGHT})}}),!n){s();return}i.load.once("complete",()=>{t.forEach(a=>{const r=Ys(a);xa(i,r)}),s()}),i.load.start()})}function xa(i,e){ta.forEach(t=>{const s=`${e}-${t.name}`;i.anims.exists(s)||i.anims.create({key:s,frames:i.anims.generateFrameNumbers(e,{start:t.from,end:t.to}),frameRate:t.frameRate,repeat:-1})})}function Ea(i){const e=[];sa.forEach(s=>{switch(s){case"skins":i.skin&&e.push(i.skin);break;case"hair":i.hair&&e.push(i.hair);break;case"clothing":e.push(...ia(i.clothing));break}});const t=na(i.clothing);return e.push(...t),e}function rn(i,e,t,s,n={}){const{animated:a=!1,animation:r="idle",facing:l="right",scale:c=Ht}=n,d=i.add.container(e,t),h=[];d.setScale(c),Ea(s).forEach(y=>{const p=ea(y);if(!p)return;const _=Ys(p);if(!i.textures.exists(_))return;const I=i.add.sprite(0,0,_);if(I.setOrigin(.5,.5),I.disableInteractive(),a){const f=`${_}-${r}`;i.anims.exists(f)&&I.play(f)}else I.setFrame(0);d.add(I),h.push(I)});const w=l==="right";return h.forEach(y=>y.setFlipX(w)),{container:d,sprites:h,scale:c,setFacing(y){const p=y==="right";h.forEach(_=>_.setFlipX(p))},playAnimation(y){h.forEach(p=>{const I=`${p.texture.key}-${y}`;i.anims.exists(I)&&p.play(I,!0)})},setFrame(y){h.forEach(p=>p.setFrame(y))},setTint(y){h.forEach(p=>p.setTint(y))},clearTint(){h.forEach(y=>y.clearTint())},setAlpha(y){h.forEach(p=>p.setAlpha(y))},getHitBounds(){const y=lt.WIDTH*c,p=lt.HEIGHT*c;return{x:d.x-y/2,y:d.y-p/2,width:y,height:p}},destroy(){h.forEach(y=>y.destroy()),d.destroy()}}}const Ut={DEPTH:Ye.PLAYER},Ta={HALF_HEIGHT:Ki/2},ft={FRAME_WIDTH:lt.WIDTH,FRAME_HEIGHT:lt.HEIGHT,WIDTH:lt.WIDTH*Ht,HEIGHT:lt.HEIGHT*Ht,HALF_HEIGHT:lt.HEIGHT*Ht/2},Xt=40;function on(i){return i-Xt}function Wt(i){return on(i)-Ta.HALF_HEIGHT}function Ca(i,e){const t=Wt(e);return i>t}function is(i){return on(i)-ft.HALF_HEIGHT}function Da(i,e){const t=is(e);return i>t}const ks={WIDTH:.33,HEIGHT:.25,OFFSET_Y:.75},pi={WIDTH:.4,HEIGHT:.3},Ks={WIDTH:.6};function Pa(i,e){const t=Math.round(i*ks.WIDTH),s=Math.round(e*ks.HEIGHT),n=Math.round((i-t)/2),a=Math.round(e*ks.OFFSET_Y);return{width:t,height:s,offsetX:n,offsetY:a}}function ka(){const i=Math.round(ft.WIDTH*pi.WIDTH),e=Math.round(ft.HEIGHT*pi.HEIGHT),t=-i/2,s=ft.HEIGHT/2-e;return{width:i,height:e,offsetX:t,offsetY:s}}class Ma{scene;currentSkinId;constructor(e,t=Ui){this.scene=e,this.currentSkinId=t}createAll(){console.log("PlayerAnimations.createAll() is deprecated - animations created by skinLoader")}getSkinId(){return this.currentSkinId}setSkinId(e){this.currentSkinId=e}getAnimationKey(e){return`${this.currentSkinId}-${e}`}play(e,t){const s=this.getAnimationKey(t);if(e.anims.currentAnim?.key!==s){if(!this.scene.anims.exists(s)){console.warn(`[PlayerAnimations] Animation not found: ${s}`);return}e.play(s)}}handleSkinChange(e,t){const s=this.currentSkinId;this.currentSkinId=t;const n=e.anims.currentAnim?.key;if(n){const a=n.replace(`${s}-`,""),r=`${t}-${a}`;if(this.scene.anims.exists(r))e.play(r);else{const l=`${t}-idle`;this.scene.anims.exists(l)&&e.play(l)}}}}let ln=!1,kt=!1;function cs(i){ln=i}function mi(){return ln}function Tt(){return kt}function Ms(i){if(!i||i.tagName==="CANVAS")return!1;if(i.closest("[data-ui]"))return!0;const e=document.getElementById("game-ui");return!!(e&&e.contains(i)||i.closest("button"))}function Aa(){document.addEventListener("pointerdown",i=>{kt=Ms(i.target)},{capture:!0}),document.addEventListener("pointermove",i=>{i.buttons>0||(kt=Ms(i.target))},{capture:!0}),document.addEventListener("pointerup",()=>{setTimeout(()=>{kt=!1},10)},{capture:!0}),document.addEventListener("touchstart",i=>{kt=Ms(i.target)},{capture:!0,passive:!0}),document.addEventListener("touchend",()=>{setTimeout(()=>{kt=!1},10)},{capture:!0,passive:!0})}function Lt(){const i=document.activeElement;if(!i)return!1;const e=i.tagName.toUpperCase();return e==="INPUT"||e==="TEXTAREA"||i.getAttribute("contenteditable")==="true"}function wt(i,e,t){const s=(i-t.worldView.x)*t.zoom,n=(e-t.worldView.y)*t.zoom;return{screenX:s,screenY:n}}function $a(i,e,t){const s=i/t.zoom+t.worldView.x,n=e/t.zoom+t.worldView.y;return{worldX:s,worldY:n}}const St={THRESHOLD_X:20,LANGUAGE_BUTTON:{width:120,height:60},SKIN_BUTTON:{width:120,height:60,yOffset:60}},cn={SPEED:350};class dn{scene;getPlayerPosition;keyLeft;keyRight;keyA;keyD;touchLeft=!1;touchRight=!1;touchHandlers;constructor(e){this.scene=e.scene,this.getPlayerPosition=e.getPlayerPosition,this.setupKeyboardControls(),this.setupTouchControls()}setupKeyboardControls(){this.scene.input.keyboard&&(this.keyLeft=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.LEFT,!1),this.keyRight=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.RIGHT,!1),this.keyA=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.A,!1),this.keyD=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.D,!1))}setupTouchControls(){const e=this.scene,t=r=>{if(je(zs)){this.touchLeft=!1,this.touchRight=!1;return}const l=r.x,c=r.y,d=e.scale.width;if(l>d-St.LANGUAGE_BUTTON.width&&c<St.LANGUAGE_BUTTON.height||l>d-St.SKIN_BUTTON.width&&c>=St.SKIN_BUTTON.yOffset&&c<St.SKIN_BUTTON.yOffset+St.SKIN_BUTTON.height)return;const h=e.cameras.main,w=this.getPlayerPosition().x-h.scrollX,y=l-w;y<-20?(this.touchLeft=!0,this.touchRight=!1):y>St.THRESHOLD_X?(this.touchRight=!0,this.touchLeft=!1):(this.touchLeft=!1,this.touchRight=!1)},s=r=>{Tt()||t(r)},n=r=>{Tt()||r.isDown&&t(r)},a=()=>{this.touchLeft=!1,this.touchRight=!1};e.input.on("pointerdown",s),e.input.on("pointermove",n),e.input.on("pointerup",a),this.touchHandlers={pointerdown:s,pointermove:n,pointerup:a}}getInputState(){const e=this.keyA?.isDown||this.keyLeft?.isDown||this.touchLeft||!1,t=this.keyD?.isDown||this.keyRight?.isDown||this.touchRight||!1;return{left:e,right:t}}hasAnyInput(){const e=this.getInputState();return e.left||e.right}destroy(){this.touchHandlers&&(this.scene.input.off("pointerdown",this.touchHandlers.pointerdown),this.scene.input.off("pointermove",this.touchHandlers.pointermove),this.scene.input.off("pointerup",this.touchHandlers.pointerup),this.touchHandlers=void 0)}}class Ha extends G.Physics.Arcade.Sprite{animations;inputController;animState="idle";hasNotifiedMovement=!1;hasReceivedInput=!1;currentSkin;constructor(e,t,s){const n=xt.getSkinId();super(e,t,s,`${n}-idle`),e.add.existing(this),e.physics.add.existing(this),this.animations=new Ma(e,n),this.inputController=new dn({scene:e,getPlayerPosition:()=>({x:this.x,y:this.y})}),this.setCollideWorldBounds(!0),this.setBounce(0),this.currentSkin=Me.find(d=>d.id===n)??Me[0];const a=Kt(this.currentSkin),r=this.currentSkin.frameWidth??48,l=this.currentSkin.frameHeight??48,c=Pa(r,l);this.setSize(c.width,c.height),this.setOffset(c.offsetX,c.offsetY),this.setScale(a),this.setDepth(Ut.DEPTH),this.animations.play(this,"idle")}getPosition(){return{x:this.x,y:this.y}}setPlayerPosition(e,t){this.x=e,this.y=t}getGroundY(e){return Wt(e)}getPlayerType(){return"static"}getHitBounds(){const e=Kt(this.currentSkin),t=(this.currentSkin.frameWidth??48)*e,s=(this.currentSkin.frameHeight??48)*e,n=t*Ks.WIDTH,a=(t-n)/2,r=this.originX??.5,l=this.originY??.5,c=this.x-t*r,d=this.y-s*l;return{x:c+a,y:d,width:n,height:s}}setFacing(e){const t=this.currentSkin.facingLeft??!1;e==="left"?this.setFlipX(!t):this.setFlipX(t)}playAnimation(e){(e==="idle"||e==="run")&&this.animations.play(this,e)}setTint(e){return super.setTint(e)}clearTint(){return super.clearTint()}setAlpha(e){return super.setAlpha(e)}getGameObject(){return this}changeSkin(e){this.currentSkin=Me.find(d=>d.id===e)??Me[0];const t=Kt(this.currentSkin),s=this.currentSkin.frameWidth??48,n=this.currentSkin.frameHeight??48,a=Math.round(s*.33),r=Math.round(n*.25),l=Math.round((s-a)/2),c=Math.round(n*.75);this.setSize(a,r),this.setOffset(l,c),this.setScale(t),this.animations.handleSkinChange(this,e)}update(){const e=this.inputController.getInputState();this.inputController.hasAnyInput()&&!this.hasReceivedInput&&(this.hasReceivedInput=!0),this.hasReceivedInput&&this.inputController.hasAnyInput()&&!this.hasNotifiedMovement&&(this.hasNotifiedMovement=!0,qs.set(!0));const t=this.currentSkin.facingLeft??!1;switch(e.left?(this.setVelocityX(-350),this.setFlipX(!t),this.animState="running"):e.right?(this.setVelocityX(cn.SPEED),this.setFlipX(t),this.animState="running"):(this.setVelocityX(0),this.animState="idle"),this.animState){case"idle":this.playAnimation("idle");break;case"running":this.playAnimation("run");break}}destroy(e){this.inputController.destroy(),super.destroy(e)}}function Qs(){const i=localStorage.getItem("characterSelection");if(!i)return null;try{const e=JSON.parse(i);if(e.gender&&(e.gender==="male"||e.gender==="female"))return{...e,clothing:Array.isArray(e.clothing)?e.clothing:[]}}catch(e){console.warn("Failed to load saved character selection:",e)}return null}class vi extends G.GameObjects.Container{character=null;selection;animState="idle";hasNotifiedMovement=!1;hasReceivedInput=!1;currentFacing="right";inputController;velocityX=0;constructor(e,t,s,n){super(e,t,s),this.selection=n,e.add.existing(this),e.physics.add.existing(this);const a=this.body;if(a){a.setCollideWorldBounds(!0),a.setBounce(0);const r=ka();a.setSize(r.width,r.height),a.setOffset(r.offsetX,r.offsetY)}this.inputController=new dn({scene:e,getPlayerPosition:()=>({x:this.x,y:this.y})}),this.setDepth(Ut.DEPTH)}getPosition(){return{x:this.x,y:this.y}}setPlayerPosition(e,t){this.x=e,this.y=t}getGroundY(e){return is(e)}getPlayerType(){return"modular"}getHitBounds(){const e=ft.WIDTH,t=ft.HEIGHT;return{x:this.x-e/2,y:this.y-t/2,width:e,height:t}}setFacing(e){this.currentFacing!==e&&(this.currentFacing=e,this.character?.setFacing(e))}setTint(e){this.character?.setTint(e)}clearTint(){this.character?.clearTint()}setAlpha(e){return this.character?.setAlpha(e),this}getGameObject(){return this}static async preloadCharacter(e,t){return an(e,t)}buildCharacter(){this.character&&this.character.destroy(),this.character=rn(this.scene,0,0,this.selection,{animated:!0,animation:"idle",facing:"right",scale:Ht}),this.add(this.character.container),this.currentFacing="right"}playAnimation(e){this.character?.playAnimation(e)}update(){const e=this.inputController.getInputState(),{left:t,right:s}=e;switch(this.inputController.hasAnyInput()&&!this.hasReceivedInput&&(this.hasReceivedInput=!0),this.hasReceivedInput&&this.inputController.hasAnyInput()&&!this.hasNotifiedMovement&&(this.hasNotifiedMovement=!0,qs.set(!0)),t?(this.velocityX=-350,this.setFacing("left"),this.animState="running"):s?(this.velocityX=cn.SPEED,this.setFacing("right"),this.animState="running"):(this.velocityX=0,this.animState="idle"),this.x+=this.velocityX*(this.scene.game.loop.delta/1e3),this.animState){case"idle":this.playAnimation("idle");break;case"running":this.playAnimation("run");break}}destroy(e){this.inputController.destroy(),this.character&&(this.character.destroy(),this.character=null),super.destroy(e)}}const La=48,Oa=48;function hn(i){Me.forEach(e=>{const t=e.frameWidth??La,s=e.frameHeight??Oa,n=gs(e);i.load.spritesheet(`${e.id}-idle`,`${n}/idle.png`,{frameWidth:t,frameHeight:s}),i.load.spritesheet(`${e.id}-run`,`${n}/run.png`,{frameWidth:t,frameHeight:s})})}function Ra(i,e){const t=e.id;i.anims.exists(`${t}-idle`)&&i.anims.remove(`${t}-idle`),i.anims.exists(`${t}-run`)&&i.anims.remove(`${t}-run`);const s=i.textures.get(`${t}-idle`),n=i.textures.get(`${t}-run`),a=s.frameTotal-1,r=n.frameTotal-1,l=e.frameRates?.idle??6,c=e.frameRates?.run??12;i.anims.create({key:`${t}-idle`,frames:i.anims.generateFrameNumbers(`${t}-idle`,{start:0,end:a-1}),frameRate:l,repeat:-1}),i.anims.create({key:`${t}-run`,frames:i.anims.generateFrameNumbers(`${t}-run`,{start:0,end:r-1}),frameRate:c,repeat:-1})}function un(i){Me.forEach(e=>{Ra(i,e)})}const st=[{name:"FOREST GREEN",folder:"forest_green",scrollFactors:[.75,.8,.85,.9,1,1],foregroundLayers:1},{name:"FOREST BLUE",folder:"forest_blue",scrollFactors:[.75,.8,.85,.9,.95,1]},{name:"FOREST BIRCH",folder:"forest_birch",scrollFactors:[.75,.8,.85,.95,1],foregroundLayers:1},{name:"FOREST FANTASY",folder:"forest_fantasy",scrollFactors:[.75,.8,.85,.9,1,1,1],foregroundLayers:2},{name:"FOREST GOLD",folder:"forest_gold",scrollFactors:[.75,.8,.85,1,1,1],foregroundLayers:2},{name:"FOREST JUNGLE",folder:"forest_jungle",scrollFactors:[.75,.8,.95,1],foregroundLayers:1},{name:"FOREST SUMMER",folder:"forest_summer",scrollFactors:[.75,.8,.85,1,1],foregroundLayers:1},{name:"CAVE DARK",folder:"cave_dark",scrollFactors:[.7,.75,.8,.85,.9,1,1],foregroundLayers:2},{name:"FOREST DEAD",folder:"forest_dead",scrollFactors:[.75,.8,.85,.9,.95,1],foregroundLayers:1}];class Fa{currentIndex=0;constructor(){const e=localStorage.getItem("background");if(e){const t=st.findIndex(s=>s.folder===e);t!==-1&&(this.currentIndex=t)}}getBackground(){return st[this.currentIndex].folder}getCurrentConfig(){return st[this.currentIndex]}setBackground(e){const t=st.findIndex(s=>s.folder===e);t!==-1&&(this.currentIndex=t,localStorage.setItem("background",e))}toggleBackground(){this.currentIndex=(this.currentIndex+1)%st.length;const e=st[this.currentIndex];return localStorage.setItem("background",e.folder),e}getAllBackgrounds(){return st}setBackgroundByIndex(e){e>=0&&e<st.length&&(this.currentIndex=e,localStorage.setItem("background",st[e].folder))}getCurrentIndex(){return this.currentIndex}}const ns=new Fa;function gn(i,e){return new Promise(t=>{for(let s=0;s<e.scrollFactors.length;s++){const n=s+1;i.load.image(`bg${n}-${e.folder}`,`assets/backgrounds/${e.folder}/${n}.png`)}i.load.once("complete",()=>{t(!0)}),i.load.once("loaderror",s=>{console.error(`Failed to load background asset: ${s.key}`),t(!1)}),i.load.start()})}function fn(i,e,t,s){const n=[],a=[],r=s.foregroundLayers??0,c=s.scrollFactors.length-r;for(let d=0;d<s.scrollFactors.length;d++){const v=`bg${d+1}-${s.folder}`,w=s.scrollFactors[d];if(i.textures.exists(v)){const y=i.textures.getFrame(v),p=y.width,_=y.height,I=t/_,f=p*I,b=e*3,m=Math.ceil(b/f)*p+p,g=i.add.tileSprite(0,0,m,_,v);g.setOrigin(0,0),g.setScale(I),g.setScrollFactor(1),g.setData("scrollFactor",w),g.setData("scale",I),d>=c?(g.setDepth(Ye.FOREGROUND_LAYER_START+(d-c)),a.push(g)):(g.setDepth(Ye.BACKGROUND_LAYER_START+d),n.push(g))}}return{bgLayers:n,fgLayers:a}}function pn(i,e){if(!i)return;const t=e.width/e.zoom,s=e.getBounds().width,n=Math.max(0,s-t),a=Math.max(0,Math.min(e.scrollX,n)),r=[...i.bgLayers,...i.fgLayers];for(const l of r){const c=l.getData("scrollFactor"),d=l.getData("scale");l.tilePositionX=a*(1-c)/d}}function Xa(i){i.bgLayers.forEach(e=>e.destroy()),i.fgLayers.forEach(e=>e.destroy())}const Wa=[{code:"cs",label:"CZ"},{code:"en",label:"EN"}],mn="cs",Ya={isActive:!1,config:null,selectedItemId:null,itemDepthLayer:"behind",editMode:"items",selectedDialogZoneId:null,selectedFrameId:null,selectedSocialId:null,isPlayerSelected:!1},K=ee(Ya),vn=Le(K,i=>i.isActive),Za=Le(K,i=>i.config),ys=ee(!0);function Ba(){ys.update(i=>!i)}const mt=ee(!1);function Ot(i){mt.set(i)}const Us=ee(!1);function As(i){Us.set(i)}const Et=ee(!1),_t=ee(!1),Is=ee(!1),It=ee(!1),xs=ee(!1);function Ga(){Et.update(i=>!i)}function Na(){_t.update(i=>!i)}function yn(){Is.set(!0)}function za(){Is.set(!1)}function Ka(){It.update(i=>!i)}function Sn(){xs.set(!0)}function Ua(){xs.set(!1)}const ei=ee(mn);function Va(i){ei.set(i)}const Es=Le(K,i=>i.selectedItemId),bn=Le(K,i=>i.itemDepthLayer),Ze=Le(K,i=>i.editMode),Ts=Le(K,i=>i.selectedDialogZoneId),ti=Le(K,i=>i.config?.dialogZones||[]),as=Le(K,i=>i.selectedFrameId),$s=Le(K,i=>i.isPlayerSelected),wn=Le(K,i=>i.config?.placedFrames||[]),rs=Le(K,i=>i.selectedSocialId),ja=Le(K,i=>i.config?.placedSocials||[]),qa=Le(K,i=>!i.selectedSocialId||!i.config?.placedSocials?null:i.config.placedSocials.find(e=>e.id===i.selectedSocialId)??null),_n=ee(null);function Hs(i){_n.set(i)}const si=ee(new Map);function Ja(i,e,t){si.update(s=>{const n=new Map(s);return n.set(i,{x:e,y:t}),n})}function Qa(i){si.update(e=>{const t=new Map(e);return t.delete(i),t})}const In=ee(null);function Ls(i){In.set(i)}const er=Le(K,i=>!i.selectedFrameId||!i.config?.placedFrames?null:i.config.placedFrames.find(e=>e.id===i.selectedFrameId)??null),xn=ee(null);function Os(i){xn.set(i)}const En=ee(null);function ds(i){En.set(i)}const ii=ee(!1);function Tn(){ii.set(!0)}function yi(){ii.set(!1)}const ni=Le(K,i=>!i.selectedItemId||!i.config?.placedItems?null:i.config.placedItems.find(e=>e.id===i.selectedItemId)??null),tr=Le(ni,i=>i?.physicsEnabled??!1),sr=Le(ni,i=>i?.flipX??!1);function Si(i,e){K.update(t=>t.config?{...t,config:{...t.config,playerStartX:i,playerStartY:e}}:t)}function ir(i){K.update(e=>{if(!e.config)return e;const t=e.config.placedItems||[];return{...e,config:{...e.config,placedItems:[...t,i]}}})}function os(i,e){K.update(t=>!t.config||!t.config.placedItems?t:{...t,config:{...t.config,placedItems:t.config.placedItems.map(s=>s.id===i?{...s,...e}:s)}})}function Cn(i){K.update(e=>!e.config||!e.config.placedItems?e:{...e,config:{...e.config,placedItems:e.config.placedItems.filter(t=>t.id!==i)},selectedItemId:e.selectedItemId===i?null:e.selectedItemId})}function Dn(i){K.update(e=>({...e,selectedItemId:i,isPlayerSelected:i?!1:e.isPlayerSelected}))}function nr(i){K.update(e=>({...e,isPlayerSelected:i,selectedItemId:null}))}function ai(){K.update(i=>({...i,selectedItemId:null,selectedFrameId:null,selectedDialogZoneId:null,selectedSocialId:null,isPlayerSelected:!1}))}function ar(){K.update(i=>({...i,itemDepthLayer:i.itemDepthLayer==="behind"?"front":"behind"}))}function rr(i,e){os(i,{depth:e})}function or(i,e){e?(os(i,{physicsEnabled:e,depth:Js("behind")}),K.update(t=>({...t,itemDepthLayer:"behind"}))):os(i,{physicsEnabled:e})}function lr(i,e){os(i,{flipX:e})}function cr(i){K.set({isActive:!0,config:{...i,placedItems:i.placedItems||[],dialogZones:i.dialogZones||[],placedFrames:i.placedFrames||[],placedSocials:i.placedSocials||[]},selectedItemId:null,itemDepthLayer:"behind",editMode:"items",selectedDialogZoneId:null,selectedFrameId:null,selectedSocialId:null,isPlayerSelected:!1}),ri.set(1)}function dr(){K.update(i=>{const e=i.config?{...i.config,dialogZones:(i.config.dialogZones||[]).filter(t=>t.texts.some(s=>s.title.trim()!==""||s.content.trim()!==""))}:i.config;return{...i,isActive:!1,selectedItemId:null,config:e}}),ri.set(1)}function hr(){return je(K).config}const ri=ee(1);function hs(i){ri.set(i)}const oi=ee({scrollX:0,scrollY:0,viewWidth:0,viewHeight:0,worldWidth:0,worldHeight:0,zoom:1,playerX:0,playerY:0});function ur(i){oi.update(e=>({...e,...i}))}function Gt(i){K.update(e=>({...e,editMode:i,selectedItemId:null,selectedDialogZoneId:null}))}function gr(i){K.update(e=>{if(!e.config)return e;const t=e.config.dialogZones||[];return{...e,config:{...e.config,dialogZones:[...t,i]}}})}function Mt(i,e){K.update(t=>!t.config||!t.config.dialogZones?t:{...t,config:{...t.config,dialogZones:t.config.dialogZones.map(s=>s.id===i?{...s,...e}:s)}})}function Pn(i){K.update(e=>!e.config||!e.config.dialogZones?e:{...e,config:{...e.config,dialogZones:e.config.dialogZones.filter(t=>t.id!==i)},selectedDialogZoneId:e.selectedDialogZoneId===i?null:e.selectedDialogZoneId})}function Vt(i){K.update(e=>({...e,selectedDialogZoneId:i}))}function bi(i,e,t){K.update(s=>!s.config||!s.config.dialogZones?s:{...s,config:{...s.config,dialogZones:s.config.dialogZones.map(n=>{if(n.id!==i)return n;const a=n.texts.findIndex(l=>l.language===e);let r;return a>=0?r=n.texts.map((l,c)=>c===a?{...l,...t}:l):r=[...n.texts,{language:e,title:"",content:"",...t}],{...n,texts:r}})}})}function fr(i){K.update(e=>{if(!e.config)return e;const t=e.config.placedFrames||[];return{...e,config:{...e.config,placedFrames:[...t,i]}}})}function it(i,e){K.update(t=>!t.config||!t.config.placedFrames?t:{...t,config:{...t.config,placedFrames:t.config.placedFrames.map(s=>s.id===i?{...s,...e}:s)}})}function li(i){K.update(e=>!e.config||!e.config.placedFrames?e:{...e,config:{...e.config,placedFrames:e.config.placedFrames.filter(t=>t.id!==i)},selectedFrameId:e.selectedFrameId===i?null:e.selectedFrameId})}function jt(i){Is.set(!1),K.update(e=>({...e,selectedFrameId:i,isPlayerSelected:i?!1:e.isPlayerSelected,selectedItemId:i?null:e.selectedItemId}))}function pr(i){K.update(e=>{if(!e.config)return e;const t=e.config.placedSocials||[];return{...e,config:{...e.config,placedSocials:[...t,i]}}})}function fs(i,e){K.update(t=>!t.config||!t.config.placedSocials?t:{...t,config:{...t.config,placedSocials:t.config.placedSocials.map(s=>s.id===i?{...s,...e}:s)}})}function ci(i){K.update(e=>!e.config||!e.config.placedSocials?e:{...e,config:{...e.config,placedSocials:e.config.placedSocials.filter(t=>t.id!==i)},selectedSocialId:e.selectedSocialId===i?null:e.selectedSocialId})}function qt(i){xs.set(!1),K.update(e=>({...e,selectedSocialId:i,isPlayerSelected:i?!1:e.isPlayerSelected,selectedItemId:i?null:e.selectedItemId,selectedFrameId:i?null:e.selectedFrameId}))}const di=[{key:"tent",name:"Tent",path:"assets/ui/tent.png",scale:6,category:"structures"},{key:"lamp",name:"Lamp",path:"assets/ui/lamp.png",scale:8,category:"props"},{key:"sign_left",name:"Sign ←",path:"assets/ui/sign_left.png",scale:7,category:"signs"},{key:"sign_right",name:"Sign →",path:"assets/ui/sign_right.png",scale:7,category:"signs"},{key:"stone_0",name:"Stone 0",path:"assets/ui/stone_0.png",scale:4,category:"nature",supportsPhysics:!0},{key:"stone_1",name:"Stone 1",path:"assets/ui/stone_1.png",scale:5,category:"nature",supportsPhysics:!0},{key:"stone_2",name:"Stone 2",path:"assets/ui/stone_2.png",scale:4,category:"nature",supportsPhysics:!0}];function kn(i){return di.find(e=>e.key===i)}function mr(i){return kn(i)?.scale||1}function vr(i){return kn(i)?.supportsPhysics??!1}class wi{scene;groundY;constructor(e,t){this.scene=e,this.groundY=t}static preloadAssets(e){di.forEach(t=>{e.load.image(t.key,t.path)})}createSprite(e){const{id:t,assetKey:s,x:n,scale:a=1,depth:r=5,yOffset:l=0,flipX:c=!1}=e,d=this.groundY+l,h=this.scene.add.sprite(n,d,s);return h.setScale(a),h.setDepth(r),h.setFlipX(c),h.setData("itemId",t),h}updatePosition(e,t,s){e.x=t,e.y=this.groundY+s}updateScale(e,t){e.setScale(t)}updateDepth(e,t){e.setDepth(t)}applyUpdates(e,t){t.x!==void 0&&(e.x=t.x),t.yOffset!==void 0&&(e.y=this.groundY+t.yOffset),t.scale!==void 0&&e.setScale(t.scale),t.depth!==void 0&&e.setDepth(t.depth),t.flipX!==void 0&&e.setFlipX(t.flipX)}worldYToOffset(e){return e-this.groundY}getGroundY(){return this.groundY}}function At(i){return parseInt(i.replace("#",""),16)}const bt={BLUE:"#4a90e2",GREEN:"#27ae60",PURPLE:"#9b59b6",TEAL:"#1abc9c",PINK:"#e91e8f"},Yt={ITEM:{hex:At(bt.BLUE)},FRAME:{hex:At(bt.PURPLE)},SOCIAL:{css:bt.PINK,hex:At(bt.PINK)},DIALOG_ZONE:{hex:At(bt.TEAL)},PLAYER:{hex:At(bt.GREEN)}},Mn=At(bt.BLUE),$t=50,yr=4871528,Sr=.4,br=1,An=Ye.GRID_OVERLAY,Rs=16711680,wr=2,_r=.6,Ir=.1,xr=1,Er=.2,_i=50,Tr=50,hi=Mn,Cr=()=>{try{return!1}catch{return!1}},Ii=Cr(),xi=65280,Dr=.3,Pr=2,kr=.8;class $n{lastClickTime=0;lastClickId=null;threshold;constructor(e=300){this.threshold=e}check(e){const t=Date.now(),s=this.lastClickId===e&&t-this.lastClickTime<this.threshold;return this.lastClickTime=t,this.lastClickId=e,s}reset(){this.lastClickTime=0,this.lastClickId=null}}function us(i,e){return Math.round(i/e)*e}function Cs(i){const{sprite:e,scene:t,callbacks:s={},constraints:n,useGridSnapping:a=!0,cursor:r="grab",hitArea:l}=i;let c=!1,d=0,h=0,v=0;if(l){if(e.setInteractive(l,G.Geom.Rectangle.Contains),e.input){const m=e.input;m.cursor=r,m.useHandCursor=!0}}else e.setInteractive({useHandCursor:!0,cursor:r});const w=(m,g)=>{const u=e.getBounds(),x=5;return m>=u.x-x&&m<=u.x+u.width+x&&g>=u.y-x&&g<=u.y+u.height+x},y=()=>{const m=t.data.get("lastTapTime");if(!m||m===v||Date.now()-m>100)return;v=m;const g=t.data.get("lastTapWorldX"),u=t.data.get("lastTapWorldY");w(g,u)&&s.onSelect?.()},p=m=>{if(m.wasTouch||je(Us)||Tt()||c||s.onDoubleClick?.())return;const g=s.isSelected?.()??!1;s.onSelect?.(),g&&(c=!0,t.data.set("isDraggingItem",!0),Ot(!0),d=e.x-m.worldX,h=e.y-m.worldY,s.onDragStart?.())},_=m=>{if(m.wasTouch){const x=t.data.get("touchDragStarted");if(!c&&x&&s.isSelected?.()){const D=t.data.get("touchStartWorldX"),H=t.data.get("touchStartWorldY"),T=e.getBounds(),A=10;D>=T.x-A&&D<=T.x+T.width+A&&H>=T.y-A&&H<=T.y+T.height+A&&(c=!0,t.data.set("isDraggingItem",!0),t.data.set("touchDragStarted",!1),Ot(!0),d=e.x-D,h=e.y-H,s.onDragStart?.())}if(c){let E=m.worldX+d,D=m.worldY+h;a&&je(ys)&&(E=us(E,$t),D=us(D,$t)),n&&(n.minX!==void 0&&(E=Math.max(E,n.minX)),n.maxX!==void 0&&(E=Math.min(E,n.maxX)),n.minY!==void 0&&(D=Math.max(D,n.minY)),n.maxY!==void 0&&(D=Math.min(D,n.maxY))),e.setPosition(E,D),s.onDrag?.(E,D)}return}if(!c)return;if(je(Us)){f();return}if(!m.isDown){f();return}let g=m.worldX+d,u=m.worldY+h;a&&je(ys)&&(g=us(g,$t),u=us(u,$t)),n&&(n.minX!==void 0&&(g=Math.max(g,n.minX)),n.maxX!==void 0&&(g=Math.min(g,n.maxX)),n.minY!==void 0&&(u=Math.max(u,n.minY)),n.maxY!==void 0&&(u=Math.min(u,n.maxY))),e.setPosition(g,u),s.onDrag?.(g,u)},I=()=>{c&&f()},f=()=>{c=!1,t.data.set("isDraggingItem",!1),Ot(!1),s.onDragEnd?.(e.x,e.y)};e.on("pointerdown",p),t.input.on("pointermove",_),t.input.on("pointerup",I);const b=()=>{y()};return t.events.on("update",b),()=>{e.off("pointerdown",p),t.input.off("pointermove",_),t.input.off("pointerup",I),t.events.off("update",b)}}class Mr{scene;groundY;worldWidth;worldHeight;isDragging=!1;callbacks;cleanupFunctions=new Map;constructor(e,t,s,n,a={}){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=n,this.callbacks=a}getIsDragging(){return this.isDragging}makeInteractive(e,t){const s=Cs({sprite:e,scene:this.scene,cursor:"pointer",constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{Dn(t),this.callbacks.onSelect?.(t)},isSelected:()=>je(Es)===t,onDragStart:()=>{this.isDragging=!0,e.setTint(Mn),this.callbacks.onDragStart?.(t)},onDrag:(n,a)=>{this.callbacks.onDrag?.(t,n,a)},onDragEnd:(n,a)=>{e.clearTint(),this.isDragging=!1;const r=Math.round(n),c=Math.round(a)-this.groundY;os(t,{x:r,yOffset:c}),this.callbacks.onDragEnd?.(t,r,c)}}});this.cleanupFunctions.set(t,s)}removeInteractivity(e){if(!e||!e.scene)return;const t=e.getData("itemId");t&&this.cleanupFunctions.has(t)&&(this.cleanupFunctions.get(t)(),this.cleanupFunctions.delete(t)),e.removeInteractive()}destroy(){this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear()}}const gt={ITEM:"itemId",FRAME:"frameId",SOCIAL:"socialId",PLAYER:"isPlayer",ZONE:"zoneId"},Ar={[gt.ITEM]:"selectedItemId",[gt.FRAME]:"selectedFrameId",[gt.SOCIAL]:"selectedSocialId",[gt.PLAYER]:"isPlayerSelected"};function Hn(i){return typeof i.getData=="function"}function $r(i){return Hn(i)?i.type==="Rectangle"?!!i.getData(gt.ZONE):Object.values(gt).some(e=>e===gt.ZONE?!1:!!i.getData(e)):!1}function Hr(i,e){if(!Hn(i))return!1;for(const[t,s]of Object.entries(Ar)){const n=i.getData(t);if(n)if(t===gt.PLAYER){const a=e.data.get(s),r=e.data.get("playerSprite");if(a&&i===r)return!0}else{const a=e.data.get(s);if(n===a)return!0}}return!1}function Lr(i,e){const t=i.input.hitTestPointer(e);for(const s of t)if(Hr(s,i))return!0;return!1}const Or={lineWidth:3,lineColor:Yt.ITEM.hex,lineAlpha:1,padding:5};class Rr{scene;graphics;style;selectedId=null;constructor(e,t={}){this.scene=e,this.style={...Or,...t},this.graphics=e.add.graphics(),this.graphics.setDepth(Ye.SELECTION_GRAPHICS)}setSelectedId(e){this.selectedId=e}getSelectedId(){return this.selectedId}updateVisuals(e){if(this.graphics.clear(),!e||!this.selectedId)return;const t=e.getBounds(),{lineWidth:s,lineColor:n,lineAlpha:a,padding:r}=this.style;this.graphics.lineStyle(s,n,a),this.graphics.strokeRect(t.x-r,t.y-r,t.width+r*2,t.height+r*2)}clearVisuals(){this.graphics.clear(),this.selectedId=null}setupBackgroundDeselect(e){this.scene.input.on("pointerdown",t=>{if(Tt()||e())return;this.scene.input.hitTestPointer(t).find(a=>$r(a))||(ai(),this.clearVisuals())})}destroy(){this.graphics?.destroy()}}class Ss{scene;items=new Map;isBuilderMode=!1;physicsGroup=null;renderer;dragController;selectionManager;constructor(e,t,s,n,a=!1){this.scene=e,this.isBuilderMode=a,this.renderer=new wi(e,t),a||(this.physicsGroup=e.physics.add.staticGroup()),this.isBuilderMode&&(this.dragController=new Mr(e,t,s,n,{onSelect:()=>this.updateSelectionVisuals(),onDrag:()=>this.updateSelectionVisuals()}),this.selectionManager=new Rr(e))}static preloadAssets(e){wi.preloadAssets(e)}createItems(e){e.forEach(t=>{this.createItem(t)})}createItem(e){const t=this.renderer.createSprite(e),s={sprite:t,data:e};if(!this.isBuilderMode&&e.physicsEnabled&&this.physicsGroup){const n=this.createPhysicsBody(t,e);s.physicsBody=n}this.items.set(e.id,s),this.isBuilderMode&&this.dragController&&this.dragController.makeInteractive(t,e.id)}createPhysicsBody(e,t){const s=e.getBounds(),n=s.width*.5,a=s.height*.8,r=e.x,l=e.y,c=this.scene.add.rectangle(r,l,n,a);return c.setVisible(!1),this.physicsGroup.add(c),c.setData("itemId",t.id),c}updateSelectionVisuals(){if(!this.selectionManager)return;const e=this.scene.data.get("selectedItemId");if(this.selectionManager.setSelectedId(e),!e){this.selectionManager.clearVisuals(),Ls(null);return}const t=this.items.get(e);if(this.selectionManager.updateVisuals(t?.sprite??null),t?.sprite){const s=this.scene.cameras.main,n=t.sprite.getBounds(),{screenX:a,screenY:r}=wt(n.centerX,n.centerY,s),l=n.height*s.zoom;Ls({screenX:a,screenY:r,itemHeight:l})}else Ls(null)}updateItem(e,t){const s=this.items.get(e);s&&(this.renderer.applyUpdates(s.sprite,t),s.data={...s.data,...t})}removeItem(e){const t=this.items.get(e);t&&(this.dragController&&this.dragController.removeInteractivity(t.sprite),t.physicsBody&&t.physicsBody.destroy(),t.sprite.destroy(),this.items.delete(e))}removeAllItems(){this.items.forEach(e=>{!e.sprite||!e.sprite.scene||(this.dragController&&this.dragController.removeInteractivity(e.sprite),e.physicsBody&&e.physicsBody.destroy(),e.sprite.destroy())}),this.items.clear()}getItem(e){return this.items.get(e)?.data}getAllItems(){return Array.from(this.items.values()).map(e=>e.data)}getPhysicsGroup(){return this.physicsGroup}setInteractiveEnabled(e){!this.isBuilderMode||!this.dragController||(this.items.forEach(({sprite:t,data:s})=>{e?(this.dragController.makeInteractive(t,s.id),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectionManager&&this.selectionManager.clearVisuals())}destroy(){this.removeAllItems(),this.selectionManager?.destroy()}setupBackgroundDeselect(){!this.isBuilderMode||!this.selectionManager||this.selectionManager.setupBackgroundDeselect(()=>this.dragController?.getIsDragging()??!1)}}function Fr(){return`frame_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const Xr=["#ffffff","#f8f8f8","#fffacd","#ffefd5","#ffe4e1","#e6e6fa","#f0fff0","#f5fffa","#fff0f5","#f0f8ff","#2d2d2d","#1a1a2e","#16213e","#1a1a1a","#2d132c","#1e3a3a","#3d1a1a","#1a2f1a","#3d3d1a","#2a1a3d"],Wr=["#333333","#000000","#ffffff","#1a1a1a","#666666","#8b4513","#2c3e50","#c0392b","#27ae60","#2980b9","#8e44ad","#f39c12"],Yr=[12,14,16,18,20,24,28,32],Zr=[{value:"top",label:"Top",icon:"↑"},{value:"center",label:"Center",icon:"⬌"},{value:"bottom",label:"Bottom",icon:"↓"}],Ln={S:{label:"Small",scale:3},M:{label:"Medium",scale:4},L:{label:"Large",scale:5}};function Br(i){return Ln[i].scale}function Gr(i){return i<=3?"S":i>=5?"L":"M"}const ct=4,zt="#ffffff",On="#333333",ps=16,Rn="center",Nr=64,zr=96,Kr=.06,Ei=32,bs=[{key:"base_1",name:"Frame 1",path:"assets/frames/base 1.png",scale:4},{key:"base_2",name:"Frame 2",path:"assets/frames/base 2.png",scale:4},{key:"base_3",name:"Frame 3",path:"assets/frames/base 3.png",scale:4},{key:"base_4",name:"Frame 4",path:"assets/frames/base 4.png",scale:4},{key:"base_5",name:"Frame 5",path:"assets/frames/base 5.png",scale:4},{key:"base_6",name:"Frame 6",path:"assets/frames/base 6.png",scale:4},{key:"base_7",name:"Frame 7",path:"assets/frames/base 7.png",scale:4},{key:"base_8",name:"Frame 8",path:"assets/frames/base 8.png",scale:4},{key:"base_9",name:"Frame 9",path:"assets/frames/base 9.png",scale:4},{key:"base_10",name:"Frame 10",path:"assets/frames/base 10.png",scale:4},{key:"base_11",name:"Frame 11",path:"assets/frames/base 11.png",scale:4},{key:"base_12",name:"Frame 12",path:"assets/frames/base 12.png",scale:4},{key:"base_13",name:"Frame 13",path:"assets/frames/base 13.png",scale:4},{key:"base_14",name:"Frame 14",path:"assets/frames/base 14.png",scale:4},{key:"base_15",name:"Frame 15",path:"assets/frames/base 15.png",scale:4},{key:"base_16",name:"Frame 16",path:"assets/frames/base 16.png",scale:4},{key:"base_17",name:"Frame 17",path:"assets/frames/base 17.png",scale:4},{key:"base_18",name:"Frame 18",path:"assets/frames/base 18.png",scale:4},{key:"base_19",name:"Frame 19",path:"assets/frames/base 19.png",scale:4},{key:"base_20",name:"Frame 20",path:"assets/frames/base 20.png",scale:4},{key:"base_21",name:"Frame 21",path:"assets/frames/base 21.png",scale:4},{key:"base_22",name:"Frame 22",path:"assets/frames/base 22.png",scale:4},{key:"base_23",name:"Frame 23",path:"assets/frames/base 23.png",scale:4},{key:"base_24",name:"Frame 24",path:"assets/frames/base 24.png",scale:4},{key:"base_25",name:"Frame 25",path:"assets/frames/base 25.png",scale:4}];function Ur(i){return bs.find(e=>e.key===i)}function Vr(i){return Ur(i)?.scale??ct}function Jt(i=ct,e=!1){const t=Nr*i,s=zr*i,n=e?s:t,a=e?t:s,r=Math.min(t,s)*Kr,l=n-r*2,c=a-r*2,d=l-Ei*2,h=c-Ei*2;return{frameWidth:n,frameHeight:a,innerWidth:l,innerHeight:c,textWidth:d,textHeight:h}}function ms(i,e,t,s,n,a,r=4){i.clear();const l=parseInt(a.replace("#",""),16);i.fillStyle(l,1),i.fillRoundedRect(e-s/2,t-n/2,s,n,r)}class Ti{scene;frames=new Map;constructor(e){this.scene=e}static preloadAssets(e){for(let t=1;t<=25;t++)e.load.image(`frame_base_${t}`,`assets/frames/base ${t}.png`)}createFrames(e){e.forEach(t=>{this.createFrame(t)})}createFrame(e){const t=`frame_${e.frameKey}`;if(!this.scene.textures.exists(t)){console.warn(`[GameFrameManager] Frame texture not found: ${t}`);return}const s=e.scale??ct,n=e.depth??Ye.ITEMS_FRONT,a=(e.rotation??0)*(Math.PI/180),r=e.rotation===90,{innerWidth:l,innerHeight:c}=Jt(s,r),d=this.scene.add.graphics();d.setDepth(n-.1),ms(d,e.x,e.y,l,c,e.backgroundColor||zt);const h=this.scene.add.sprite(e.x,e.y,t);h.setScale(s),h.setDepth(n),h.setOrigin(.5,.5),h.setRotation(a);const v={sprite:h,background:d,data:e};this.frames.set(e.id,v),e.url&&this.makeClickable(v)}makeClickable(e){const{sprite:t,data:s}=e;t.setInteractive({useHandCursor:!0}),t.on("pointerover",()=>{t.setScale((s.scale??ct)*1.05)}),t.on("pointerout",()=>{t.setScale(s.scale??ct)}),t.on("pointerdown",()=>{s.url&&(nn(),window.open(s.url,"_blank","noopener,noreferrer"))})}destroy(){this.frames.forEach(({sprite:e,background:t})=>{e.destroy(),t.destroy()}),this.frames.clear()}}function jr(){return`social_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const ls={S:{label:"Small",scale:1.5},M:{label:"Medium",scale:2},L:{label:"Large",scale:2.5}},Rt=ls.M.scale;function qr(i){return ls[i].scale}function Jr(i){return i<=ls.S.scale?"S":i>=ls.L.scale?"L":"M"}const ws=[{key:"discord",name:"Discord",path:"assets/socials/Discord.png",scale:1},{key:"facebook",name:"Facebook",path:"assets/socials/Facebook.png",scale:1},{key:"instagram",name:"Instagram",path:"assets/socials/Instagram.png",scale:1},{key:"kofi",name:"Ko-Fi",path:"assets/socials/Ko Fi.png",scale:1},{key:"linkedin",name:"LinkedIn",path:"assets/socials/LinkedIn.png",scale:1},{key:"patreon",name:"Patreon",path:"assets/socials/Patreon.png",scale:1},{key:"tiktok",name:"TikTok",path:"assets/socials/TikTok.png",scale:1},{key:"twitch",name:"Twitch",path:"assets/socials/Twitch.png",scale:1},{key:"twitter",name:"Twitter",path:"assets/socials/Twitter.png",scale:1},{key:"whatsapp",name:"WhatsApp",path:"assets/socials/Whatsapp.png",scale:1},{key:"youtube",name:"YouTube",path:"assets/socials/Youtube.png",scale:1}];class Ci{scene;socials=new Map;constructor(e){this.scene=e}static preloadAssets(e){ws.forEach(t=>{e.load.image(`social_${t.key}`,t.path)})}createSocials(e){e.forEach(t=>{this.createSocial(t)})}createSocial(e){const t=`social_${e.socialKey}`;if(!this.scene.textures.exists(t)){console.warn(`[GameSocialManager] Social texture not found: ${t}`);return}const s=e.scale??Rt,n=e.depth??Ye.ITEMS_FRONT,a=this.scene.add.sprite(e.x,e.y,t);a.setScale(s),a.setDepth(n),a.setOrigin(.5,.5),this.socials.set(e.id,a),e.url&&this.makeClickable(a,e)}makeClickable(e,t){const s=t.scale??Rt;e.setInteractive({useHandCursor:!0}),e.on("pointerover",()=>{e.setScale(s*1.1)}),e.on("pointerout",()=>{e.setScale(s)}),e.on("pointerdown",()=>{t.url&&(nn(),window.open(t.url,"_blank","noopener,noreferrer"))})}destroy(){this.socials.forEach(e=>{e.destroy()}),this.socials.clear()}}async function Di(){const i=await fetch("./config/map.json");if(!i.ok)throw new Error(`Failed to load map config: ${i.status}`);const e=await i.json();if(!e.worldWidth||!e.worldHeight)throw new Error("Invalid map config structure");return e}const vs={generateId(){return`item_${Date.now()}_${Math.random().toString(36).substr(2,9)}`},create(i){const{assetKey:e,x:t,yOffset:s=0,depthLayer:n="behind",scale:a}=i;return{id:vs.generateId(),assetKey:e,x:Math.round(t),y:0,scale:a??mr(e),depth:Js(n),yOffset:Math.round(s)}},createAtWorldPosition(i,e,t,s,n="behind"){return vs.create({assetKey:i,x:e,yOffset:t-s,depthLayer:n})},clone(i,e=50){return{...i,id:vs.generateId(),x:i.x+e}}},Pt={HEIGHT:Xt,VISUAL:{COLOR:9139029,ALPHA:.3},PHYSICS:{COLOR:0,ALPHA:0}},Ft={getGroundY(i,e=Xt){return i-e},createVisualGround(i,e){const t=e.height??Pt.HEIGHT,s=Ft.getGroundY(e.worldHeight,t),n=i.add.rectangle(0,s,e.worldWidth,t,e.color??Pt.VISUAL.COLOR,e.alpha??Pt.VISUAL.ALPHA);return n.setOrigin(0,0),n.setDepth(e.depth??Ye.GROUND_REFERENCE),{ground:n,groundY:s}},createPhysicsGround(i,e){const t=e.height??Pt.HEIGHT,s=Ft.getGroundY(e.worldHeight,t),n=i.add.rectangle(0,s,e.worldWidth,t,e.color??Pt.PHYSICS.COLOR,e.alpha??Pt.PHYSICS.ALPHA);return n.setOrigin(0,0),i.physics.add.existing(n,!0),{ground:n,groundY:s}},addPlayerCollision(i,e,t){return i.physics.add.collider(e,t)}},Qe={GAME:"GameScene",BUILDER:"BuilderScene"};class Qr extends G.Scene{player=null;useModularPlayer=!1;savedCharacterSelection=null;mapConfig;parallaxLayers=null;loadedBackgrounds=new Set;itemManager;frameManager;socialManager;dialogZones=[];currentDialogZone=null;unsubscribers=[];initData;isInitialized=!1;constructor(){super({key:Qe.GAME})}init(e){this.initData=e,this.isInitialized=!1;const t=localStorage.getItem("useModularPlayer");this.savedCharacterSelection=Qs(),this.useModularPlayer=t==="true"&&this.savedCharacterSelection!==null}preload(){this.useModularPlayer||hn(this),Ss.preloadAssets(this),Ti.preloadAssets(this),Ci.preloadAssets(this)}create(){this.events.on("shutdown",this.shutdown,this),this.initializeScene()}async initializeScene(){Ns.set(!0);try{this.useModularPlayer||un(this),this.useModularPlayer&&this.savedCharacterSelection&&await vi.preloadCharacter(this,this.savedCharacterSelection),await this.loadMapConfiguration();const e=ns.getCurrentConfig();await this.loadBackgroundIfNeeded(e),this.createParallaxBackground();const{ground:t,groundY:s}=Ft.createPhysicsGround(this,{worldWidth:this.mapConfig.worldWidth,worldHeight:this.mapConfig.worldHeight});if(this.useModularPlayer&&this.savedCharacterSelection){const r=is(this.mapConfig.worldHeight),l=Math.min(this.mapConfig.playerStartY,r),c=new vi(this,this.mapConfig.playerStartX,l,this.savedCharacterSelection);c.buildCharacter(),this.player=c,Ft.addPlayerCollision(this,c,t)}else{const r=Wt(this.mapConfig.worldHeight),l=Math.min(this.mapConfig.playerStartY,r),c=new Ha(this,this.mapConfig.playerStartX,l);this.player=c,Ft.addPlayerCollision(this,c,t)}this.itemManager=new Ss(this,s,this.mapConfig.worldWidth,this.mapConfig.worldHeight,!1),this.mapConfig.placedItems&&this.mapConfig.placedItems.length>0&&this.itemManager.createItems(this.mapConfig.placedItems);const n=this.itemManager.getPhysicsGroup();n&&this.player&&this.physics.add.collider(this.player.getGameObject(),n),this.frameManager=new Ti(this),this.mapConfig.placedFrames&&this.mapConfig.placedFrames.length>0&&this.frameManager.createFrames(this.mapConfig.placedFrames),this.socialManager=new Ci(this),this.mapConfig.placedSocials&&this.mapConfig.placedSocials.length>0&&this.socialManager.createSocials(this.mapConfig.placedSocials),this.dialogZones=this.mapConfig.dialogZones||[];const a=ti.subscribe(r=>{this.dialogZones=r,this.recheckCurrentZone()});this.unsubscribers.push(a),this.player&&this.cameras.main.startFollow(this.player.getGameObject(),!0,.1,.1),this.setupCameraBounds(),this.physics.world.setBounds(0,0,this.mapConfig.worldWidth,this.mapConfig.worldHeight),this.scale.on("resize",this.handleResize,this),this.isInitialized=!0}catch(e){console.error("[GameScene] Failed to initialize scene:",e)}finally{Ns.set(!1)}}async loadMapConfiguration(){try{if(this.initData?.useBuilderConfig){const e=hr();this.mapConfig=e||await Di()}else this.mapConfig=await Di()}catch(e){console.error("[GameScene] Failed to load map configuration:",e);const t=600;this.mapConfig={worldWidth:3200,worldHeight:t,playerStartX:400,playerStartY:Wt(t),placedItems:[]}}}createParallaxBackground(){const e=ns.getCurrentConfig();this.parallaxLayers=fn(this,this.mapConfig.worldWidth,this.mapConfig.worldHeight,e)}async loadBackgroundIfNeeded(e){if(this.loadedBackgrounds.has(e.folder))return!0;const t=await gn(this,e);return t&&this.loadedBackgrounds.add(e.folder),t}setupCameraBounds(){const e=this.cameras.main,t=e.height,s=e.width,n=t/this.mapConfig.worldHeight,a=Math.min(1,n);e.setZoom(a);const r=t/a,l=s/a;let c=0,d=this.mapConfig.worldHeight;r>this.mapConfig.worldHeight&&(c=(this.mapConfig.worldHeight-r)/2,d=r);let h=0,v=this.mapConfig.worldWidth;l>this.mapConfig.worldWidth&&(h=(this.mapConfig.worldWidth-l)/2,v=l),e.setBounds(h,c,v,d),Ia(this.mapConfig.worldWidth,this.mapConfig.worldHeight,s,t,a)}handleResize(e){!this.cameras?.main||!this.mapConfig||this.setupCameraBounds()}shutdown(){this.isInitialized=!1,this.scale.off("resize",this.handleResize,this),Ps(null),this.currentDialogZone=null,this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.itemManager&&this.itemManager.destroy(),this.frameManager&&this.frameManager.destroy(),this.socialManager&&this.socialManager.destroy()}update(){if(!this.isInitialized||!this.player)return;this.player.update();const{x:e,y:t}=this.player.getPosition(),s=this.cameras.main,n=e-s.scrollX,a=t-s.scrollY;wa(n,a),_a(s.scrollX,s.scrollY,s.zoom),this.checkDialogZonesForPosition(e),this.parallaxLayers&&pn(this.parallaxLayers,this.cameras.main)}checkDialogZonesForPosition(e){let t=null;for(const s of this.dialogZones)if(e>=s.x&&e<=s.x+s.width){t=s;break}t?.id!==this.currentDialogZone?.id&&(this.currentDialogZone=t,Ps(t))}recheckCurrentZone(){if(!this.currentDialogZone)return;const e=this.dialogZones.find(t=>t.id===this.currentDialogZone?.id);e&&(this.currentDialogZone=e,Ps(e))}}const Fs=1,Pi=.001,eo=.15,ki=400;class to{scene;camera;worldWidth;worldHeight;isPanning=!1;panStartX=0;panStartY=0;cameraDragStartX=0;cameraDragStartY=0;isDraggingToScroll=!1;dragScrollStartX=0;dragScrollStartY=0;dragScrollCameraStartX=0;dragScrollCameraStartY=0;currentZoom=1;targetZoom=1;minZoom=.1;isAnimatingReset=!1;zoomTargetWorldPoint=null;pinchStartDistance=0;pinchStartZoom=1;activeTouches=new Map;pinchEndTime=0;isPinching=!1;PINCH_COOLDOWN=150;touchStartTime=0;touchStartPos=null;touchOnSelectedSprite=!1;TAP_MAX_DURATION=200;TAP_MAX_DISTANCE=10;constructor(e,t,s){this.scene=e,this.camera=e.cameras.main,this.worldWidth=t,this.worldHeight=s}setup(){this.calculateMinZoom(),this.setupCamera(),this.setupMouseControls(),this.setupKeyboardControls(),this.setupUpdateLoop()}calculateMinZoom(){const e=this.camera.width/this.worldWidth,t=this.camera.height/this.worldHeight;this.minZoom=Math.min(e,t)}setupCamera(){this.currentZoom=this.minZoom,this.targetZoom=this.minZoom,this.camera.setZoom(this.minZoom);const e=this.camera.width/this.minZoom,t=this.camera.height/this.minZoom,s=Math.min(0,(this.worldWidth-e)/2),n=Math.min(0,(this.worldHeight-t)/2),a=Math.max(this.worldWidth,e),r=Math.max(this.worldHeight,t);this.camera.setBounds(s,n,a,r),this.camera.centerOn(this.worldWidth/2,this.worldHeight/2),hs(this.minZoom)}centerOn(e,t){this.camera.centerOn(e,t),this.clampScroll()}handleResize(){this.calculateMinZoom(),this.currentZoom<this.minZoom&&(this.currentZoom=this.minZoom,this.targetZoom=this.minZoom,this.camera.setZoom(this.minZoom)),this.targetZoom<this.minZoom&&(this.targetZoom=this.minZoom),this.updateCameraBounds(),this.clampScroll(),hs(this.currentZoom)}updateCameraBounds(){const e=this.camera.width/this.currentZoom,t=this.camera.height/this.currentZoom,s=Math.min(0,(this.worldWidth-e)/2),n=Math.min(0,(this.worldHeight-t)/2),a=Math.max(this.worldWidth,e),r=Math.max(this.worldHeight,t);this.camera.setBounds(s,n,a,r)}getScrollBounds(e=!0){const t=this.camera.width/this.currentZoom,s=this.camera.height/this.currentZoom;let n,a,r,l;return t>this.worldWidth?e?n=a=(this.worldWidth-t)/2:(n=this.worldWidth-t,a=0):(n=0,a=this.worldWidth-t),s>this.worldHeight?e?r=l=(this.worldHeight-s)/2:(r=this.worldHeight-s,l=0):(r=0,l=this.worldHeight-s),{minX:n,maxX:a,minY:r,maxY:l}}clampScroll(){const e=this.getScrollBounds(!0);this.camera.scrollX=G.Math.Clamp(this.camera.scrollX,e.minX,e.maxX),this.camera.scrollY=G.Math.Clamp(this.camera.scrollY,e.minY,e.maxY)}softClampScroll(){const e=this.getScrollBounds(!1);this.camera.scrollX=G.Math.Clamp(this.camera.scrollX,e.minX,e.maxX),this.camera.scrollY=G.Math.Clamp(this.camera.scrollY,e.minY,e.maxY)}applyPanDelta(e,t,s,n,a,r){const l=this.getScrollBounds(),c=(e-s)/this.currentZoom,d=(t-n)/this.currentZoom;this.camera.scrollX=G.Math.Clamp(a-c,l.minX,l.maxX),this.camera.scrollY=G.Math.Clamp(r-d,l.minY,l.maxY)}zoomToPoint(e,t,s){const n=this.camera.getWorldPoint(e,t);this.zoomToWorldPoint(n.x,n.y,s)}zoomToWorldPoint(e,t,s){const n=this.camera.scrollX,a=this.camera.scrollY,r=this.currentZoom;this.currentZoom=s,this.camera.setZoom(s),this.updateCameraBounds(),this.camera.scrollX=e-(e-n)*r/s,this.camera.scrollY=t-(t-a)*r/s,this.softClampScroll(),hs(this.currentZoom)}setupMouseControls(){this.scene.input.on("wheel",(e,t,s,n,a)=>{if(this.isAnimatingReset)return;if((e.event.ctrlKey||Math.abs(s)<5&&Math.abs(n)>0)&&!e.event.ctrlKey){const l=-n*Pi*3;this.targetZoom=G.Math.Clamp(this.targetZoom+l,this.minZoom,Fs);const c=this.camera.getWorldPoint(e.x,e.y);this.zoomTargetWorldPoint={x:c.x,y:c.y}}else if(e.event.ctrlKey){const l=-n*Pi,c=G.Math.Clamp(this.currentZoom+l,this.minZoom,Fs);this.targetZoom=c,this.zoomToPoint(e.x,e.y,c)}else{const l=this.getScrollBounds();this.camera.scrollX=G.Math.Clamp(this.camera.scrollX+s/this.currentZoom,l.minX,l.maxX),this.camera.scrollY=G.Math.Clamp(this.camera.scrollY+n/this.currentZoom,l.minY,l.maxY)}}),this.scene.input.on("pointerdown",e=>{if(e.wasTouch){if(this.activeTouches.set(e.id,{x:e.x,y:e.y}),this.activeTouches.size===2){this.isPinching=!0,this.startPinch(),this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.scene.data.set("touchDraggingSprite",!1);return}this.activeTouches.size===1&&!this.isPinching&&(this.touchStartTime=Date.now(),this.touchStartPos={x:e.x,y:e.y},this.dragScrollStartX=e.x,this.dragScrollStartY=e.y,this.dragScrollCameraStartX=this.camera.scrollX,this.dragScrollCameraStartY=this.camera.scrollY,this.touchOnSelectedSprite=Lr(this.scene,e),this.scene.data.set("touchDraggingSprite",!1),this.scene.data.set("touchStartOnSelectedSprite",this.touchOnSelectedSprite),this.scene.data.set("touchStartWorldX",e.worldX),this.scene.data.set("touchStartWorldY",e.worldY));return}Tt()||mi()||this.isAnimatingReset||(e.rightButtonDown()||e.middleButtonDown()?(this.isPanning=!0,this.panStartX=e.x,this.panStartY=e.y,this.cameraDragStartX=this.camera.scrollX,this.cameraDragStartY=this.camera.scrollY):e.leftButtonDown()&&!this.isDraggingObject()&&(this.scene.data.get("isDraggingItem")===!0||(this.dragScrollStartX=e.x,this.dragScrollStartY=e.y,this.dragScrollCameraStartX=this.camera.scrollX,this.dragScrollCameraStartY=this.camera.scrollY)))}),this.scene.input.on("pointermove",e=>{if(e.wasTouch){if(this.activeTouches.has(e.id)&&this.activeTouches.set(e.id,{x:e.x,y:e.y}),this.activeTouches.size>=2&&this.isPinching){this.handlePinch();return}if(this.isPinching||Date.now()-this.pinchEndTime<this.PINCH_COOLDOWN||this.scene.data.get("touchDraggingSprite"))return;if(this.touchStartPos&&!this.isDraggingToScroll){const t=Math.abs(e.x-this.touchStartPos.x),s=Math.abs(e.y-this.touchStartPos.y);if(Math.sqrt(t*t+s*s)>this.TAP_MAX_DISTANCE){if(this.touchOnSelectedSprite){this.scene.data.set("touchDragStarted",!0),this.scene.data.set("touchDraggingSprite",!0),this.touchStartPos=null;return}!Tt()&&!this.isDraggingObject()&&!this.scene.data.get("isDraggingItem")&&(this.isDraggingToScroll=!0,this.touchStartPos=null)}}this.isDraggingToScroll&&this.applyPanDelta(e.x,e.y,this.dragScrollStartX,this.dragScrollStartY,this.dragScrollCameraStartX,this.dragScrollCameraStartY);return}if(!(mi()||this.isAnimatingReset)){if(this.isPanning)this.applyPanDelta(e.x,e.y,this.panStartX,this.panStartY,this.cameraDragStartX,this.cameraDragStartY);else if(e.leftButtonDown()&&!this.isDraggingToScroll&&!this.isDraggingObject()&&!(this.scene.data.get("isDraggingItem")===!0)){const s=Math.abs(e.x-this.dragScrollStartX),n=Math.abs(e.y-this.dragScrollStartY);Math.sqrt(s*s+n*n)>10&&(this.isDraggingToScroll=!0,this.scene.input.setDefaultCursor("grabbing"))}this.isDraggingToScroll&&this.applyPanDelta(e.x,e.y,this.dragScrollStartX,this.dragScrollStartY,this.dragScrollCameraStartX,this.dragScrollCameraStartY)}}),this.scene.input.on("pointerup",e=>{if(e.wasTouch){if(this.isPinching&&(this.pinchEndTime=Date.now(),this.isPinching=!1,As(!1)),this.touchStartPos&&!this.isDraggingToScroll){const t=Date.now()-this.touchStartTime,s=Math.abs(e.x-this.touchStartPos.x),n=Math.abs(e.y-this.touchStartPos.y),a=Math.sqrt(s*s+n*n);t<this.TAP_MAX_DURATION&&a<this.TAP_MAX_DISTANCE&&(this.scene.data.set("lastTapTime",Date.now()),this.scene.data.set("lastTapWorldX",e.worldX),this.scene.data.set("lastTapWorldY",e.worldY))}this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.activeTouches.delete(e.id),this.scene.data.set("touchDraggingSprite",!1),this.scene.data.set("touchDragStarted",!1),this.scene.data.set("touchStartOnSelectedSprite",!1),this.isDraggingToScroll&&(this.isDraggingToScroll=!1);return}!e.rightButtonDown()&&!e.middleButtonDown()&&(this.isPanning=!1),this.isDraggingToScroll&&(this.isDraggingToScroll=!1,this.scene.input.setDefaultCursor("default"))}),this.scene.input.on("pointerout",e=>{e.wasTouch&&(this.activeTouches.delete(e.id),this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.isPinching&&this.activeTouches.size<2&&(this.isPinching=!1,this.pinchEndTime=Date.now(),As(!1)))})}startPinch(){const e=Array.from(this.activeTouches.values());if(e.length!==2)return;const[t,s]=e;this.pinchStartDistance=Math.hypot(s.x-t.x,s.y-t.y),this.pinchStartZoom=this.currentZoom,As(!0)}handlePinch(){const e=Array.from(this.activeTouches.values());if(e.length!==2)return;const[t,s]=e,n=Math.hypot(s.x-t.x,s.y-t.y),a=(t.x+s.x)/2,r=(t.y+s.y)/2,l=n/this.pinchStartDistance,c=G.Math.Clamp(this.pinchStartZoom*l,this.minZoom,Fs);this.targetZoom=c,this.zoomToPoint(a,r,c)}setupKeyboardControls(){const e={up:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.UP,!1),down:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.DOWN,!1),left:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.LEFT,!1),right:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.RIGHT,!1)},t={w:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.W,!1),a:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.A,!1),s:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.S,!1),d:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.D,!1)};this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.SPACE,!1).on("down",()=>{Lt()||this.centerOnPlayer()}),this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.F,!1).on("down",()=>{Lt()||this.resetToFit()}),this.scene.data.set("cameraArrowKeys",e),this.scene.data.set("cameraWasdKeys",t)}setupUpdateLoop(){const e=this.scene.data.get("cameraArrowKeys"),t=this.scene.data.get("cameraWasdKeys");this.scene.events.on("update",()=>{if(!this.isAnimatingReset&&Math.abs(this.currentZoom-this.targetZoom)>1e-4){const a=G.Math.Linear(this.currentZoom,this.targetZoom,eo);this.zoomTargetWorldPoint?this.zoomToWorldPoint(this.zoomTargetWorldPoint.x,this.zoomTargetWorldPoint.y,a):this.zoomToPoint(this.camera.width/2,this.camera.height/2,a),Math.abs(this.currentZoom-this.targetZoom)<.001&&(this.zoomTargetWorldPoint=null)}if(Lt()||this.isAnimatingReset)return;const s=10/this.currentZoom,n=this.getScrollBounds();e?.left?.isDown||t?.a?.isDown?this.camera.scrollX=G.Math.Clamp(this.camera.scrollX-s,n.minX,n.maxX):(e?.right?.isDown||t?.d?.isDown)&&(this.camera.scrollX=G.Math.Clamp(this.camera.scrollX+s,n.minX,n.maxX)),e?.up?.isDown||t?.w?.isDown?this.camera.scrollY=G.Math.Clamp(this.camera.scrollY-s,n.minY,n.maxY):(e?.down?.isDown||t?.s?.isDown)&&(this.camera.scrollY=G.Math.Clamp(this.camera.scrollY+s,n.minY,n.maxY))})}centerOnPlayer(){const e=this.scene.data.get("playerSprite");e&&(this.camera.centerOn(e.x,e.y),this.clampScroll())}isDraggingObject(){return this.scene.data.get("isDraggingObject")===!0||this.scene.data.get("isDraggingItem")===!0}resetToFit(){if(this.isAnimatingReset)return;this.isAnimatingReset=!0,this.targetZoom=this.minZoom;const e=this.camera.width/this.minZoom,t=this.camera.height/this.minZoom,s=(this.worldWidth-e)/2,n=(this.worldHeight-t)/2,a=s+e/2,r=n+t/2;this.camera.pan(a,r,ki,"Sine.easeInOut"),this.camera.zoomTo(this.minZoom,ki,"Sine.easeInOut",!1,(l,c)=>{c===1&&(this.currentZoom=this.minZoom,this.camera.scrollX=s,this.camera.scrollY=n,this.isAnimatingReset=!1,hs(this.minZoom))})}destroy(){this.activeTouches.clear()}}const Mi=Yt.PLAYER.hex;class so{scene;player;modularCharacter=null;worldWidth;worldHeight;unsubscribers=[];interactionCleanup=null;useModular=!1;modularSelection=null;debugGraphics=null;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s;const n=localStorage.getItem("useModularPlayer");this.modularSelection=Qs(),this.useModular=n==="true"&&this.modularSelection!==null}async preload(){!this.useModular||!this.modularSelection||await an(this.scene,this.modularSelection)}create(e,t){if(this.useModular&&this.modularSelection){const s=is(this.worldHeight),n=Math.min(t,s);return this.createModularPlayer(e,n)}else{const s=Math.min(t,Wt(this.worldHeight));return this.createStaticPlayer(e,s)}}createStaticPlayer(e,t){const s=xt.getSkinId(),n=Me.find(l=>l.id===s)??Me[0],a=Kt(n),r=this.scene.add.sprite(e,t,`${s}-idle`,0);return r.setScale(a),r.setDepth(Ut.DEPTH),r.setData("isPlayer",!0),this.player=r,this.scene.data.set("playerSprite",this.player),this.setupInteraction(),this.setupEditModeSubscription(),this.setupSelectionSubscription(),r}createModularPlayer(e,t){this.modularCharacter=rn(this.scene,e,t,this.modularSelection,{animated:!1,facing:"right",scale:Ht});const s=this.modularCharacter.container;return s.setDepth(Ut.DEPTH),s.setData("isPlayer",!0),this.player=s,this.scene.data.set("playerSprite",this.player),this.setupInteraction(),this.setupEditModeSubscription(),this.setupSelectionSubscription(),s}setupInteraction(){let e;if(this.useModular&&this.modularCharacter)e=new G.Geom.Rectangle(-80/2,-64/2,ft.FRAME_WIDTH,ft.FRAME_HEIGHT),this.scene.data.set("modularPlayerHitArea",e);else{const t=xt.getSkinId(),s=Me.find(c=>c.id===t)??Me[0],n=s.frameWidth??48,a=s.frameHeight??48,r=n*Ks.WIDTH,l=(n-r)/2;e=new G.Geom.Rectangle(l,0,r,a)}this.interactionCleanup=Cs({sprite:this.player,scene:this.scene,useGridSnapping:!1,cursor:"grab",hitArea:e,constraints:{minX:_i,maxX:this.worldWidth-_i,minY:Tr},callbacks:{onSelect:()=>{nr(!0)},isSelected:()=>je($s),onDragStart:()=>{this.applyTint(hi),this.scene.data.set("isDraggingObject",!0)},onDrag:(t,s)=>{Si(Math.round(t),Math.round(s)),this.updateDebugVisualization()},onDragEnd:(t,s)=>{this.updateSelectionVisual(je($s)),this.scene.data.set("isDraggingObject",!1);let n=this.player.y;this.useModular?Da(this.player.y,this.worldHeight)&&(n=is(this.worldHeight),this.player.setY(n)):Ca(this.player.y,this.worldHeight)&&(n=Wt(this.worldHeight),this.player.setY(n)),Si(Math.round(this.player.x),Math.round(n)),this.updateDebugVisualization()}}}),Ii&&this.createDebugVisualization()}createDebugVisualization(){this.debugGraphics&&this.debugGraphics.destroy(),this.debugGraphics=this.scene.add.graphics(),this.debugGraphics.setDepth(Ut.DEPTH+1),this.updateDebugVisualization()}updateDebugVisualization(){if(!this.debugGraphics||!Ii)return;this.debugGraphics.clear();let e;if(this.useModular&&this.modularCharacter){e=this.modularCharacter.getHitBounds(),this.debugGraphics.fillStyle(65280,.2),this.debugGraphics.fillRect(e.x,e.y,e.width,e.height),this.debugGraphics.lineStyle(3,65280,.8),this.debugGraphics.strokeRect(e.x,e.y,e.width,e.height);const t=this.player,s=this.scene.data.get("modularPlayerHitArea");if(s&&t.input){const n=t.scaleX,a={x:t.x+s.x*n,y:t.y+s.y*n,width:s.width*n,height:s.height*n};this.debugGraphics.fillStyle(16711680,.3),this.debugGraphics.fillRect(a.x,a.y,a.width,a.height),this.debugGraphics.lineStyle(3,16711680,1),this.debugGraphics.strokeRect(a.x,a.y,a.width,a.height)}}else{const t=this.player,s=xt.getSkinId(),n=Me.find(w=>w.id===s)??Me[0],a=Kt(n),r=(n.frameWidth??48)*a,l=(n.frameHeight??48)*a,c=r*Ks.WIDTH,d=(r-c)/2,h=t.originX??.5,v=t.originY??.5;e={x:t.x-r*h+d,y:t.y-l*v,width:c,height:l},this.debugGraphics.fillStyle(xi,Dr),this.debugGraphics.fillRect(e.x,e.y,e.width,e.height),this.debugGraphics.lineStyle(Pr,xi,kr),this.debugGraphics.strokeRect(e.x,e.y,e.width,e.height)}}setupSelectionSubscription(){const e=$s.subscribe(t=>{this.updateSelectionVisual(t),this.scene.data.set("isPlayerSelected",t)});this.unsubscribers.push(e)}updateSelectionVisual(e){if(this.player)if(this.modularCharacter)e?this.modularCharacter.setTint(Mi):this.modularCharacter.clearTint();else{const t=this.player;e?t.setTint(Mi):t.clearTint()}}applyTint(e){this.modularCharacter?this.modularCharacter.setTint(e):this.player.setTint(e)}setupEditModeSubscription(){const e=Ze.subscribe(t=>{t==="dialogs"?(this.interactionCleanup&&(this.interactionCleanup(),this.interactionCleanup=null),this.player.disableInteractive(),this.setAlpha(.6)):(this.setAlpha(1),this.interactionCleanup||this.setupInteraction())});this.unsubscribers.push(e)}setAlpha(e){this.modularCharacter?this.modularCharacter.setAlpha(e):this.player.setAlpha(e)}getSprite(){return this.player}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.interactionCleanup&&(this.interactionCleanup(),this.interactionCleanup=null),this.debugGraphics&&(this.debugGraphics.destroy(),this.debugGraphics=null),this.modularCharacter?(this.modularCharacter.destroy(),this.modularCharacter=null):this.player&&this.player.destroy()}}class io{scene;graphics;worldWidth;worldHeight;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}create(){return this.graphics=this.scene.add.graphics(),this.graphics.setDepth(An),this.draw(),this.graphics}draw(){this.graphics.clear(),this.graphics.lineStyle(br,yr,Sr);const e=Math.max(this.worldHeight,this.scene.scale.height);for(let s=0;s<=this.worldWidth;s+=$t)this.graphics.beginPath(),this.graphics.moveTo(s,0),this.graphics.lineTo(s,e),this.graphics.strokePath();for(let s=0;s<=e;s+=$t)this.graphics.beginPath(),this.graphics.moveTo(0,s),this.graphics.lineTo(this.worldWidth,s),this.graphics.strokePath();const t=this.worldHeight-Xt;this.graphics.lineStyle(wr,Rs,_r),this.graphics.beginPath(),this.graphics.moveTo(0,t),this.graphics.lineTo(this.worldWidth,t),this.graphics.strokePath(),this.graphics.lineStyle(xr,Rs,Er),this.graphics.fillStyle(Rs,Ir),this.graphics.fillRect(0,t,this.worldWidth,e-t)}getGraphics(){return this.graphics}redraw(){this.draw()}destroy(){this.graphics&&this.graphics.destroy()}}class no{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set);const s=this.listeners.get(e);return s.add(t),{unsubscribe:()=>{s.delete(t),s.size===0&&this.listeners.delete(e)}}}once(e,t){const s=this.on(e,n=>{s.unsubscribe(),t(n)});return s}emit(e,t){const s=this.listeners.get(e);s&&s.forEach(n=>{try{n(t)}catch(a){console.error(`[EventBus] Error in listener for "${e}":`,a)}})}off(e){this.listeners.delete(e)}clear(){this.listeners.clear()}listenerCount(e){return this.listeners.get(e)?.size??0}}const We=new no,Ae={ASSET_DROPPED:"asset:dropped",FRAME_DROPPED:"frame:dropped",SOCIAL_DROPPED:"social:dropped",MINIMAP_NAVIGATE:"minimap:navigate",DIALOG_ZONE_CREATE:"dialogZone:create",DIALOG_ZONE_CREATE_AT:"dialogZone:createAt",TEMP_ZONE_BUTTON_SHOW:"tempZoneButton:show",TEMP_ZONE_BUTTON_HIDE:"tempZoneButton:hide"};class ao{scene;groundY;worldWidth;worldHeight;itemManager;unsubscribers=[];constructor(e,t,s,n){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=n}create(e){return this.itemManager=new Ss(this.scene,this.groundY,this.worldWidth,this.worldHeight,!0),e&&e.length>0&&this.itemManager.createItems(e),this.setupBackgroundDeselect(),this.setupStoreSubscriptions(),this.setupAssetDropListener(),this.setupDeleteKeys(),this.itemManager}setupBackgroundDeselect(){this.itemManager.setupBackgroundDeselect()}setupStoreSubscriptions(){const e=Es.subscribe(a=>{this.scene.data.set("selectedItemId",a),this.itemManager.updateSelectionVisuals()});this.unsubscribers.push(e);const t=Ze.subscribe(a=>{a==="dialogs"?(ai(),this.itemManager.setInteractiveEnabled(!1)):this.itemManager.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const n=Za.subscribe(a=>{if(!a?.placedItems)return;const r=a.placedItems;s.forEach(l=>{r.find(d=>d.id===l.id)||this.itemManager.removeItem(l.id)}),r.forEach(l=>{const c=s.find(d=>d.id===l.id);c&&JSON.stringify(c)!==JSON.stringify(l)&&this.itemManager.updateItem(l.id,l)}),s=r.map(l=>({...l}))});this.unsubscribers.push(n)}setupAssetDropListener(){const e=We.on(Ae.ASSET_DROPPED,t=>{const{assetKey:s,canvasX:n,canvasY:a}=t,l=this.scene.cameras.main.getWorldPoint(n,a),c=Math.max(0,Math.min(this.worldWidth,l.x)),d=Math.max(0,Math.min(this.worldHeight,l.y));let h="behind";bn.subscribe(y=>{h=y})();const w=vs.createAtWorldPosition(s,c,d,this.groundY,h);ir(w),this.itemManager.createItem(w),Dn(w.id),Et.set(!1)});this.unsubscribers.push(()=>e.unsubscribe())}setupDeleteKeys(){const e=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.DELETE,!1),t=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.BACKSPACE,!1),s=()=>{if(Lt())return;const n=this.scene.data.get("selectedItemId");n&&Cn(n)};e.on("down",s),t.on("down",s)}getManager(){return this.itemManager}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.itemManager&&this.itemManager.destroy()}}class Ai{scene;worldWidth;worldHeight;frames=new Map;unsubscribers=[];selectionGraphics=null;cleanupFunctions=new Map;doubleClickDetector=new $n;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}static preloadAssets(e){for(let t=1;t<=25;t++)e.load.image(`frame_base_${t}`,`assets/frames/base ${t}.png`)}create(e){this.selectionGraphics=this.scene.add.graphics(),this.selectionGraphics.setDepth(Ye.SELECTION_GRAPHICS),e&&e.length>0&&e.forEach(t=>this.createFrame(t)),this.setupStoreSubscriptions(),this.setupFrameDropListener(),this.setupDeleteKeys()}createFrame(e){const t=`frame_${e.frameKey}`;if(!this.scene.textures.exists(t)){console.warn(`Frame texture not found: ${t}`);return}const s=e.scale??ct,n=e.depth??Ye.ITEMS_FRONT,a=(e.rotation??0)*(Math.PI/180),r=e.rotation===90,{innerWidth:l,innerHeight:c}=Jt(s,r),d=this.scene.add.graphics();d.setDepth(n-.1),ms(d,e.x,e.y,l,c,e.backgroundColor||zt);const h=this.scene.add.sprite(e.x,e.y,t);h.setScale(s),h.setDepth(n),h.setOrigin(.5,.5),h.setRotation(a),h.setData("frameId",e.id);const v={sprite:h,background:d,data:e};this.frames.set(e.id,v),this.makeInteractive(v,e.id)}updateFrameVisuals(e){const{sprite:t,background:s,data:n}=e,a=`frame_${n.frameKey}`;t.texture.key!==a&&this.scene.textures.exists(a)&&t.setTexture(a);const r=n.scale??ct;t.setScale(r);const l=(n.rotation??0)*(Math.PI/180);t.setRotation(l);const c=n.rotation===90,{innerWidth:d,innerHeight:h}=Jt(r,c);ms(s,t.x,t.y,d,h,n.backgroundColor||zt)}moveContainer(e,t,s){const{sprite:n,background:a,data:r}=e;n.setPosition(t,s);const l=r.scale??ct,c=r.rotation===90,{innerWidth:d,innerHeight:h}=Jt(l,c);ms(a,t,s,d,h,r.backgroundColor||zt)}makeInteractive(e,t){const{sprite:s}=e,n=Cs({sprite:s,scene:this.scene,cursor:"grab",useGridSnapping:!0,constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{jt(t),this.updateSelectionVisuals()},isSelected:()=>je(as)===t,onDoubleClick:()=>this.doubleClickDetector.check(t)?(yn(),!0):!1,onDragStart:()=>{s.setTint(hi)},onDrag:(a,r)=>{this.moveContainer(e,a,r),this.updateSelectionVisuals(),Ja(t,a,r)},onDragEnd:(a,r)=>{s.clearTint(),Qa(t),e.data.x=Math.round(a),e.data.y=Math.round(r),it(t,{x:e.data.x,y:e.data.y})}}});this.cleanupFunctions.set(t,n)}setupStoreSubscriptions(){const e=as.subscribe(a=>{this.scene.data.set("selectedFrameId",a),this.updateSelectionVisuals()});this.unsubscribers.push(e);const t=Ze.subscribe(a=>{a==="dialogs"?(jt(null),this.setInteractiveEnabled(!1)):this.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const n=wn.subscribe(a=>{s.forEach(r=>{a.find(c=>c.id===r.id)||this.removeFrame(r.id)}),a.forEach(r=>{const l=s.find(d=>d.id===r.id),c=this.frames.get(r.id);if(c&&l){const d=l.backgroundColor!==r.backgroundColor,h=l.textColor!==r.textColor,v=l.textSize!==r.textSize,w=JSON.stringify(l.texts)!==JSON.stringify(r.texts),y=l.rotation!==r.rotation,p=l.scale!==r.scale,_=l.frameKey!==r.frameKey;c.data=r,(d||h||v||w||y||p||_)&&(this.updateFrameVisuals(c),this.scene.data.get("selectedFrameId")===r.id&&this.updateSelectionVisuals())}}),s=a.map(r=>({...r}))});this.unsubscribers.push(n)}setupFrameDropListener(){const e=We.on(Ae.FRAME_DROPPED,t=>{const{frameKey:s,canvasX:n,canvasY:a}=t,l=this.scene.cameras.main.getWorldPoint(n,a),c=Math.max(0,Math.min(this.worldWidth,l.x)),d=Math.max(0,Math.min(this.worldHeight,l.y)),h={id:Fr(),frameKey:s,x:Math.round(c),y:Math.round(d),scale:Vr(s),depth:Ye.ITEMS_FRONT,rotation:90,backgroundColor:zt,textColor:"#333333",textSize:16,texts:[{language:"cs",text:""},{language:"en",text:""}]};fr(h),this.createFrame(h),jt(h.id)});this.unsubscribers.push(()=>e.unsubscribe())}setupDeleteKeys(){const e=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.DELETE,!1),t=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.BACKSPACE,!1),s=()=>{if(Lt())return;let n="items";if(Ze.subscribe(l=>n=l)(),n!=="frames")return;const r=this.scene.data.get("selectedFrameId");r&&li(r)};e.on("down",s),t.on("down",s)}updateSelectionVisuals(){if(!this.selectionGraphics)return;this.selectionGraphics.clear();const e=this.scene.data.get("selectedFrameId");if(!e){Os(null);return}const t=this.frames.get(e);if(!t){Os(null);return}const s=t.sprite,n=s.getBounds(),a=this.scene.cameras.main,{screenX:r,screenY:l}=wt(s.x,s.y,a);Os({screenX:r,screenY:l,frameHeight:n.height*a.zoom}),this.selectionGraphics.lineStyle(3,Yt.FRAME.hex,1),this.selectionGraphics.strokeRect(n.x-4,n.y-4,n.width+8,n.height+8)}removeFrame(e){const t=this.frames.get(e);t&&(t.sprite.destroy(),t.background.destroy(),this.frames.delete(e)),this.updateSelectionVisuals()}setInteractiveEnabled(e){this.frames.forEach(({sprite:t,background:s})=>{e?(t.setInteractive(),t.setAlpha(1),s.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6),s.setAlpha(.6))}),!e&&this.selectionGraphics&&this.selectionGraphics.clear()}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.frames.forEach(({sprite:e,background:t})=>{e.destroy(),t.destroy()}),this.frames.clear(),this.selectionGraphics&&(this.selectionGraphics.destroy(),this.selectionGraphics=null)}}class $i{scene;worldWidth;worldHeight;socials=new Map;unsubscribers=[];selectionGraphics=null;cleanupFunctions=new Map;doubleClickDetector=new $n;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}static preloadAssets(e){e.load.image("social_discord","assets/socials/Discord.png"),e.load.image("social_facebook","assets/socials/Facebook.png"),e.load.image("social_instagram","assets/socials/Instagram.png"),e.load.image("social_kofi","assets/socials/Ko Fi.png"),e.load.image("social_linkedin","assets/socials/LinkedIn.png"),e.load.image("social_patreon","assets/socials/Patreon.png"),e.load.image("social_tiktok","assets/socials/TikTok.png"),e.load.image("social_twitch","assets/socials/Twitch.png"),e.load.image("social_twitter","assets/socials/Twitter.png"),e.load.image("social_whatsapp","assets/socials/Whatsapp.png"),e.load.image("social_youtube","assets/socials/Youtube.png")}create(e){this.selectionGraphics=this.scene.add.graphics(),this.selectionGraphics.setDepth(Ye.SELECTION_GRAPHICS),e&&e.length>0&&e.forEach(t=>this.createSocial(t)),this.setupStoreSubscriptions(),this.setupSocialDropListener(),this.setupDeleteKeys()}createSocial(e){const t=`social_${e.socialKey}`;if(!this.scene.textures.exists(t)){console.warn(`Social texture not found: ${t}`);return}const s=e.scale??Rt,n=e.depth??Ye.ITEMS_FRONT,a=this.scene.add.sprite(e.x,e.y,t);a.setScale(s),a.setDepth(n),a.setOrigin(.5,.5),a.setData("socialId",e.id),this.socials.set(e.id,{sprite:a,data:e}),this.makeInteractive(e.id)}updateSocialVisuals(e){const t=this.socials.get(e);if(!t)return;const{sprite:s,data:n}=t,a=`social_${n.socialKey}`;s.texture.key!==a&&this.scene.textures.exists(a)&&s.setTexture(a);const r=n.scale??Rt;s.setScale(r)}makeInteractive(e){const t=this.socials.get(e);if(!t)return;const{sprite:s}=t,n=Cs({sprite:s,scene:this.scene,cursor:"grab",useGridSnapping:!0,constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{qt(e),this.updateSelectionVisuals()},isSelected:()=>je(rs)===e,onDoubleClick:()=>this.doubleClickDetector.check(e)?(Sn(),!0):!1,onDragStart:()=>{s.setTint(hi)},onDrag:()=>{this.updateSelectionVisuals()},onDragEnd:(a,r)=>{s.clearTint();const l=this.socials.get(e);l&&(l.data.x=Math.round(a),l.data.y=Math.round(r),fs(e,{x:l.data.x,y:l.data.y}))}}});this.cleanupFunctions.set(e,n)}setupStoreSubscriptions(){const e=rs.subscribe(a=>{this.scene.data.set("selectedSocialId",a),this.updateSelectionVisuals()});this.unsubscribers.push(e);const t=Ze.subscribe(a=>{a==="dialogs"?(qt(null),this.setInteractiveEnabled(!1)):this.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const n=ja.subscribe(a=>{s.forEach(r=>{a.find(c=>c.id===r.id)||this.removeSocial(r.id)}),a.forEach(r=>{const l=s.find(d=>d.id===r.id),c=this.socials.get(r.id);if(c&&l){const d=l.scale!==r.scale,h=l.socialKey!==r.socialKey;c.data=r,(d||h)&&(this.updateSocialVisuals(r.id),this.scene.data.get("selectedSocialId")===r.id&&this.updateSelectionVisuals())}}),s=a.map(r=>({...r}))});this.unsubscribers.push(n)}setupSocialDropListener(){const e=We.on(Ae.SOCIAL_DROPPED,t=>{const{socialKey:s,canvasX:n,canvasY:a}=t,l=this.scene.cameras.main.getWorldPoint(n,a),c=Math.max(0,Math.min(this.worldWidth,l.x)),d=Math.max(0,Math.min(this.worldHeight,l.y)),h={id:jr(),socialKey:s,x:Math.round(c),y:Math.round(d),scale:Rt,depth:Ye.ITEMS_FRONT};pr(h),this.createSocial(h),qt(h.id)});this.unsubscribers.push(()=>e.unsubscribe())}setupDeleteKeys(){const e=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.DELETE,!1),t=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.BACKSPACE,!1),s=()=>{if(Lt())return;let n="items";if(Ze.subscribe(l=>n=l)(),n!=="socials")return;const r=this.scene.data.get("selectedSocialId");r&&ci(r)};e.on("down",s),t.on("down",s)}updateSelectionVisuals(){if(!this.selectionGraphics)return;this.selectionGraphics.clear();const e=this.scene.data.get("selectedSocialId");if(!e){Hs(null);return}const t=this.socials.get(e);if(!t){Hs(null);return}const s=t.sprite,n=s.getBounds(),a=this.scene.cameras.main,{screenX:r,screenY:l}=wt(s.x,s.y,a);Hs({screenX:r,screenY:l,socialHeight:n.height*a.zoom}),this.selectionGraphics.lineStyle(3,Yt.SOCIAL.hex,1),this.selectionGraphics.strokeRect(n.x-4,n.y-4,n.width+8,n.height+8)}removeSocial(e){const t=this.socials.get(e);t&&(t.sprite.destroy(),this.socials.delete(e));const s=this.cleanupFunctions.get(e);s&&(s(),this.cleanupFunctions.delete(e)),this.updateSelectionVisuals()}setInteractiveEnabled(e){this.socials.forEach(({sprite:t})=>{e?(t.setInteractive(),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectionGraphics&&this.selectionGraphics.clear()}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear(),this.socials.forEach(({sprite:e})=>{e.destroy()}),this.socials.clear(),this.selectionGraphics&&(this.selectionGraphics.destroy(),this.selectionGraphics=null)}}const ht=An-1,ut=300,Hi=150,ro=.3,oo=.5,Xs=40,Li=60,Oi=16777215,Ri=.6,Fi=0,tt=60,Xi=8;class lo{scene;worldWidth;worldHeight;graphics=null;zoneAreas=new Map;leftHandles=new Map;leftHandleVisuals=new Map;rightHandles=new Map;rightHandleVisuals=new Map;arrowGraphics=new Map;dragging=null;unsubscribers=[];createZoneSubscription;currentEditMode="items";currentZones=[];currentSelectedId=null;lastClickTime=0;lastClickX=0;DOUBLE_CLICK_THRESHOLD=300;DOUBLE_CLICK_DISTANCE=20;pendingTap=null;TAP_MAX_DURATION=300;TAP_MAX_DISTANCE=15;pendingZoneSelection=null;createZoneAtSubscription;boundWindowPointerUp=()=>{};boundWindowPointerMove=()=>{};currentScreenX=0;autoScrollTimer=null;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}create(){this.graphics=this.scene.add.graphics(),this.graphics.setDepth(ht);const e=Ze.subscribe(n=>{this.currentEditMode=n,this.render()});this.unsubscribers.push(e);const t=ti.subscribe(n=>{this.currentZones=n,this.render()});this.unsubscribers.push(t);const s=Ts.subscribe(n=>{this.currentSelectedId=n,this.render()});this.unsubscribers.push(s),this.scene.input.on("pointermove",this.handlePointerMove,this),this.scene.input.on("pointerup",this.handlePointerUp,this),this.boundWindowPointerUp=this.handlePointerUp.bind(this),this.boundWindowPointerMove=this.handleWindowPointerMove.bind(this),window.addEventListener("pointerup",this.boundWindowPointerUp),window.addEventListener("pointermove",this.boundWindowPointerMove),this.scene.input.on("pointerdown",this.handlePointerDown,this),this.createZoneSubscription=We.on(Ae.DIALOG_ZONE_CREATE,()=>{this.createNewZone()}),this.createZoneAtSubscription=We.on(Ae.DIALOG_ZONE_CREATE_AT,n=>{this.createZoneAtPosition(n.worldX)}),this.render()}clearVisuals(){this.graphics&&this.graphics.clear(),this.zoneAreas.forEach(e=>e.destroy()),this.zoneAreas.clear(),this.leftHandles.forEach(e=>e.destroy()),this.leftHandles.clear(),this.rightHandles.forEach(e=>e.destroy()),this.rightHandles.clear(),this.leftHandleVisuals.forEach(e=>e.destroy()),this.leftHandleVisuals.clear(),this.rightHandleVisuals.forEach(e=>e.destroy()),this.rightHandleVisuals.clear(),this.arrowGraphics.forEach(e=>e.destroy()),this.arrowGraphics.clear()}render(){if(this.clearVisuals(),this.currentEditMode==="dialogs")for(const e of this.currentZones)this.renderZone(e,e.id===this.currentSelectedId)}renderZone(e,t){if(!this.graphics)return;const s=G.Display.Color.HexStringToColor(e.color).color,n=t?oo:ro;this.graphics.fillStyle(s,n),this.graphics.fillRect(e.x,0,e.width,this.worldHeight),this.graphics.lineStyle(2,s,.8),this.graphics.strokeRect(e.x,0,e.width,this.worldHeight);const a=this.scene.add.rectangle(e.x+e.width/2,this.worldHeight/2,e.width-Xs*2,this.worldHeight);a.setOrigin(.5,.5),a.setInteractive({cursor:t?"grab":"pointer"}),a.setDepth(ht+.1),a.setAlpha(.001),a.setData("zoneId",e.id),a.on("pointerdown",r=>{if(this.isClickOnUIElement(r))return;const l=Date.now(),c=l-this.lastClickTime<this.DOUBLE_CLICK_THRESHOLD&&Math.abs(r.worldX-this.lastClickX)<this.DOUBLE_CLICK_DISTANCE;this.lastClickTime=l,this.lastClickX=r.worldX;const d=this.currentSelectedId===e.id;if(c&&d){Tn();return}d?(this.scene.data.set("isDraggingItem",!0),Ot(!0),this.startDrag(e.id,"move",r.worldX)):this.pendingZoneSelection={zoneId:e.id,worldX:r.worldX,startTime:l}}),this.zoneAreas.set(e.id,a),t&&this.createHandles(e)}createHandles(e){const t=this.scene.cameras.main.scrollY,s=this.scene.cameras.main.height,n=t+s/2,a=this.scene.add.rectangle(e.x,this.worldHeight/2,Xs,this.worldHeight);a.setOrigin(.5,.5),a.setDepth(ht+.2),a.setFillStyle(Oi,Ri);const r=this.scene.add.rectangle(e.x,this.worldHeight/2,Li,this.worldHeight);r.setOrigin(.5,.5),r.setInteractive({cursor:"ew-resize"}),r.setDepth(ht+.25),r.setAlpha(.001),r.setData("zoneId",e.id),r.setData("type","left"),r.on("pointerdown",w=>{this.isClickOnUIElement(w)||this.startDrag(e.id,"left",w.worldX)}),this.leftHandles.set(e.id,r),this.leftHandleVisuals.set(e.id,a);const l=8,c=this.scene.add.graphics();c.setDepth(ht+.3),this.drawArrow(c,e.x-l,n,"left"),this.arrowGraphics.set(`${e.id}_left`,c);const d=this.scene.add.rectangle(e.x+e.width,this.worldHeight/2,Xs,this.worldHeight);d.setOrigin(.5,.5),d.setDepth(ht+.2),d.setFillStyle(Oi,Ri);const h=this.scene.add.rectangle(e.x+e.width,this.worldHeight/2,Li,this.worldHeight);h.setOrigin(.5,.5),h.setInteractive({cursor:"ew-resize"}),h.setDepth(ht+.25),h.setAlpha(.001),h.setData("zoneId",e.id),h.setData("type","right"),h.on("pointerdown",w=>{this.isClickOnUIElement(w)||this.startDrag(e.id,"right",w.worldX)}),this.rightHandles.set(e.id,h),this.rightHandleVisuals.set(e.id,d);const v=this.scene.add.graphics();v.setDepth(ht+.3),this.drawArrow(v,e.x+e.width+l,n,"right"),this.arrowGraphics.set(`${e.id}_right`,v)}drawArrow(e,t,s,n){const r=n==="left"?-1:1;e.fillStyle(3355443,.8),e.beginPath(),e.moveTo(t+r*10+1,s),e.lineTo(t-r*10+1,s-10+1),e.lineTo(t-r*10+1,s+10-1),e.closePath(),e.fillPath(),e.fillStyle(16777215,.9),e.beginPath(),e.moveTo(t+r*10,s),e.lineTo(t-r*10,s-10),e.lineTo(t-r*10,s+10),e.closePath(),e.fillPath()}startDrag(e,t,s){const n=this.currentZones.find(a=>a.id===e);n&&(this.scene.data.set("isDraggingItem",!0),Ot(!0),this.dragging={zoneId:e,type:t,startX:s,originalX:n.x,originalWidth:n.width})}getZoneBounds(e){let t=0,s=this.worldWidth;for(const n of this.currentZones){if(n.id===e)continue;const a=n.x+n.width,r=this.currentZones.find(l=>l.id===e);r&&(a<=r.x+r.width/2&&(t=Math.max(t,a+Fi)),n.x>=r.x+r.width/2&&(s=Math.min(s,n.x-Fi)))}return{minX:t,maxX:s-ut,maxRight:s}}wouldOverlap(e,t,s){const n=t+s;for(const a of this.currentZones){if(a.id===e)continue;const r=a.x,l=a.x+a.width;if(t<l&&n>r)return!0}return!1}isClickOnUIElement(e){const t=e.downElement;return t?t.tagName?.toUpperCase()!=="CANVAS":!1}cancelPendingIfMoved(e){this.pendingTap&&Math.abs(e-this.pendingTap.worldX)>this.TAP_MAX_DISTANCE&&(this.pendingTap=null),this.pendingZoneSelection&&Math.abs(e-this.pendingZoneSelection.worldX)>this.TAP_MAX_DISTANCE&&(this.pendingZoneSelection=null)}screenToWorld(e,t){const s=this.scene.cameras.main,a=this.scene.game.canvas.getBoundingClientRect(),r=e-a.left,l=t-a.top;return $a(r,l,s)}handleWindowPointerMove(e){const t=this.screenToWorld(e.clientX,e.clientY);if(this.cancelPendingIfMoved(t.worldX),!this.dragging)return;const n=this.scene.game.canvas.getBoundingClientRect();e.clientX>=n.left&&e.clientX<=n.right&&e.clientY>=n.top&&e.clientY<=n.bottom||(this.currentScreenX=e.clientX-n.left,this.updateDrag(t.worldX),this.checkAutoScroll())}handlePointerMove(e){this.cancelPendingIfMoved(e.worldX),this.dragging&&(this.currentScreenX=e.x,e.event?.stopPropagation?.(),this.updateDrag(e.worldX),this.checkAutoScroll())}checkAutoScroll(){if(!this.dragging||this.dragging.type!=="move"){this.stopAutoScroll();return}const e=this.scene.cameras.main,t=e.width,s=this.currentZones.find(b=>b.id===this.dragging?.zoneId);if(!s)return;const n=Math.max(0,this.worldWidth-e.width/e.zoom);if(n<=0){this.stopAutoScroll();return}const{screenX:a}=wt(s.x,0,e),{screenX:r}=wt(s.x+s.width,0,e),l=a<=tt,c=r>=t-tt,d=e.scrollX>0,h=e.scrollX<n,v=s.x>0,w=s.x+s.width<this.worldWidth,y=this.currentScreenX<tt,p=this.currentScreenX>t-tt,f=l&&y&&d&&v||c&&p&&h&&w;f&&!this.autoScrollTimer?this.autoScrollTimer=this.scene.time.addEvent({delay:16,callback:this.performAutoScroll,callbackScope:this,loop:!0}):!f&&this.autoScrollTimer&&this.stopAutoScroll()}performAutoScroll(){if(!this.dragging||this.dragging.type!=="move"){this.stopAutoScroll();return}const e=this.scene.cameras.main,t=e.width,s=this.currentZones.find(I=>I.id===this.dragging?.zoneId);if(!s)return;let n=0;if(this.currentScreenX<tt){if(s.x<=0){this.stopAutoScroll();return}const f=(tt-this.currentScreenX)/tt;n=-Xi*f}else if(this.currentScreenX>t-tt){if(s.x+s.width>=this.worldWidth){this.stopAutoScroll();return}const f=(this.currentScreenX-(t-tt))/tt;n=Xi*f}if(n===0)return;const a=e.scrollX+n,r=0,l=Math.max(0,this.worldWidth-e.width/e.zoom),d=Math.max(r,Math.min(l,a))-e.scrollX;if(l<=0){this.stopAutoScroll();return}if(d===0){this.stopAutoScroll();return}const h=s.x+d,v=Math.max(0,Math.min(this.worldWidth-s.width,h)),w=v-s.x;if(w===0){this.stopAutoScroll();return}const y=e.scrollX+w,p=Math.max(0,Math.min(l,y));if(Math.abs(p-e.scrollX)>Math.abs(w)*2){this.stopAutoScroll();return}e.scrollX=p,this.wouldOverlap(s.id,v,s.width)||(Mt(s.id,{x:v}),this.dragging.originalX+=w,this.dragging.startX+=w)}stopAutoScroll(){this.autoScrollTimer&&(this.autoScrollTimer.destroy(),this.autoScrollTimer=null)}updateDrag(e){if(!this.dragging)return;const t=e-this.dragging.startX,s=this.currentZones.find(a=>a.id===this.dragging?.zoneId);if(!s)return;const n=this.getZoneBounds(s.id);if(this.dragging.type==="left"){let a=this.dragging.originalX+t,r=this.dragging.originalWidth-t;if(a<0&&(r+=a,a=0),r<ut&&(a=this.dragging.originalX+this.dragging.originalWidth-ut,r=ut),a<n.minX){const l=n.minX-a;a=n.minX,r-=l}r>=ut&&!this.wouldOverlap(s.id,a,r)&&Mt(s.id,{x:a,width:r})}else if(this.dragging.type==="right"){let a=this.dragging.originalWidth+t;a<ut&&(a=ut),s.x+a>this.worldWidth&&(a=this.worldWidth-s.x),s.x+a>n.maxRight&&(a=n.maxRight-s.x),a>=ut&&!this.wouldOverlap(s.id,s.x,a)&&Mt(s.id,{width:a})}else if(this.dragging.type==="move"){let a=this.dragging.originalX+t;const r=s.width;if(a<0&&(a=0),a+r>this.worldWidth&&(a=this.worldWidth-r),!this.wouldOverlap(s.id,a,r))Mt(s.id,{x:a});else{const l=this.findNonOverlappingPosition(s.id,a,r);l!==null&&Mt(s.id,{x:l})}}}findNonOverlappingPosition(e,t,s){const n=this.currentZones.filter(h=>h.id!==e).sort((h,v)=>h.x-v.x);if(n.length===0)return Math.max(0,Math.min(t,this.worldWidth-s));let a=t,r=1/0;const l=n[0];if(l.x>=s){const h=l.x-s,v=Math.max(0,Math.min(t,h)),w=Math.abs(v-t);w<r&&(r=w,a=v)}for(let h=0;h<n.length-1;h++){const v=n[h],w=n[h+1],y=v.x+v.width,p=w.x;if(p-y>=s){const I=y,f=p-s,b=Math.max(I,Math.min(t,f)),m=Math.abs(b-t);m<r&&(r=m,a=b)}}const c=n[n.length-1],d=c.x+c.width;if(this.worldWidth-d>=s){const h=d,v=this.worldWidth-s,w=Math.max(h,Math.min(t,v)),y=Math.abs(w-t);y<r&&(r=y,a=w)}return r<1/0&&!this.wouldOverlap(e,a,s)?a:null}handlePointerUp(e){if(this.dragging&&(this.stopAutoScroll(),this.scene.data.set("isDraggingItem",!1),Ot(!1),this.dragging=null),this.pendingZoneSelection){let n=Date.now()-this.pendingZoneSelection.startTime<this.TAP_MAX_DURATION;n&&e&&e.worldX!==void 0&&(n=Math.abs(e.worldX-this.pendingZoneSelection.worldX)<this.TAP_MAX_DISTANCE),n&&Vt(this.pendingZoneSelection.zoneId),this.pendingZoneSelection=null}if(this.pendingTap&&this.currentEditMode==="dialogs"){if(Date.now()-this.pendingTap.startTime<this.TAP_MAX_DURATION){let n=!0;e&&e.worldX!==void 0&&(n=Math.abs(e.worldX-this.pendingTap.worldX)<this.TAP_MAX_DISTANCE),n&&this.showTempAddButton(this.pendingTap.worldX,this.pendingTap.worldY)}this.pendingTap=null}}handlePointerDown(e){if(Tt()||this.currentEditMode!=="dialogs"||this.dragging)return;const t=e.downElement;if(t&&t.tagName?.toUpperCase()!=="CANVAS")return;const s=e.worldX;for(const l of this.currentZones)if(s>=l.x&&s<=l.x+l.width)return;const n=Date.now(),a=n-this.lastClickTime,r=Math.abs(s-this.lastClickX);if(a<this.DOUBLE_CLICK_THRESHOLD&&r<this.DOUBLE_CLICK_DISTANCE){this.createZoneAtPosition(s),this.lastClickTime=0,this.hideTempAddButton();return}this.lastClickTime=n,this.lastClickX=s,this.pendingTap={worldX:s,worldY:e.worldY,startTime:n},this.currentSelectedId&&Vt(null)}showTempAddButton(e,t){const s=this.scene.cameras.main,{screenX:n,screenY:a}=wt(e,t,s);We.emit(Ae.TEMP_ZONE_BUTTON_SHOW,{screenX:n,screenY:a,worldX:e})}hideTempAddButton(){We.emit(Ae.TEMP_ZONE_BUTTON_HIDE,{})}createZoneAtPosition(e){this.createZoneAt(e)}createNewZone(){const e=this.scene.cameras.main,t=e.worldView.x+e.worldView.width/2;this.createZoneAt(t)}createZoneAt(e){let t=e-Hi/2;const s=Hi;if(t=Math.max(0,Math.min(this.worldWidth-s,t)),this.wouldOverlap("",t,s)){const a=this.findNonOverlappingPosition("",t,s);if(a===null){console.warn("No room for a new dialog zone");return}t=a}const n=ma(t,s);n.x=t,gr(n),Vt(n.id)}updateSelectionVisuals(){if(this.currentEditMode!=="dialogs"){ds(null);return}if(!this.currentSelectedId){ds(null);return}const e=this.currentZones.find(r=>r.id===this.currentSelectedId);if(!e){ds(null);return}const t=this.scene.cameras.main,s=e.x+e.width/2,{screenX:n}=wt(s,0,t),a=t.height*.65;ds({screenX:n,screenY:a})}destroy(){this.hideTempAddButton();for(const e of this.unsubscribers)e();this.unsubscribers=[],this.createZoneSubscription&&this.createZoneSubscription.unsubscribe(),this.createZoneAtSubscription&&this.createZoneAtSubscription.unsubscribe(),this.stopAutoScroll(),this.scene.input.off("pointerdown",this.handlePointerDown,this),this.scene.input.off("pointermove",this.handlePointerMove,this),this.scene.input.off("pointerup",this.handlePointerUp,this),window.removeEventListener("pointerup",this.boundWindowPointerUp),window.removeEventListener("pointermove",this.boundWindowPointerMove),this.clearVisuals(),this.graphics&&(this.graphics.destroy(),this.graphics=null),this.dragging=null}}class co extends G.Scene{parallaxLayers=null;cameraController;playerController;gridOverlay;itemsController;framesController;socialsController;dialogZoneRenderer;config;minimapSubscription;isShuttingDown=!1;get itemManager(){return this.itemsController?.getManager()}resetZoom(){this.cameraController?.resetToFit()}constructor(){super({key:Qe.BUILDER})}init(e){this.config=e.config}preload(){hn(this),Ss.preloadAssets(this),Ai.preloadAssets(this),$i.preloadAssets(this)}create(){this.isShuttingDown=!1,this.initializeScene()}async initializeScene(){un(this),this.physics.world.setBounds(0,0,this.config.worldWidth,this.config.worldHeight);const e=this.config.worldHeight-Xt;this.cameraController=new to(this,this.config.worldWidth,this.config.worldHeight),this.playerController=new so(this,this.config.worldWidth,this.config.worldHeight),this.gridOverlay=new io(this,this.config.worldWidth,this.config.worldHeight),this.itemsController=new ao(this,e,this.config.worldWidth,this.config.worldHeight),this.framesController=new Ai(this,this.config.worldWidth,this.config.worldHeight),this.socialsController=new $i(this,this.config.worldWidth,this.config.worldHeight),this.dialogZoneRenderer=new lo(this,this.config.worldWidth,this.config.worldHeight),this.createBackground(),this.gridOverlay.create(),this.createGroundReference(),await this.playerController.preload(),this.playerController.create(this.config.playerStartX,this.config.playerStartY),this.itemsController.create(this.config.placedItems||[]),this.framesController.create(this.config.placedFrames||[]),this.socialsController.create(this.config.placedSocials||[]),this.dialogZoneRenderer.create(),this.cameraController.setup(),this.cameraController.centerOn(this.config.playerStartX,this.config.playerStartY),this.minimapSubscription=We.on(Ae.MINIMAP_NAVIGATE,t=>{this.navigateToPosition(t.worldX,t.worldY)}),this.scale.on("resize",this.handleResize,this),this.events.on("shutdown",this.shutdown,this)}async createBackground(){const e=ns.getCurrentConfig();try{await gn(this,e)}catch(t){console.error("Failed to load background:",t);return}this.parallaxLayers&&(Xa(this.parallaxLayers),this.parallaxLayers=null),this.parallaxLayers=fn(this,this.config.worldWidth,this.config.worldHeight,e)}createGroundReference(){Ft.createVisualGround(this,{worldWidth:this.config.worldWidth,worldHeight:this.config.worldHeight,height:Xt})}update(){this.parallaxLayers&&pn(this.parallaxLayers,this.cameras.main),this.itemManager?.updateSelectionVisuals(),this.framesController?.updateSelectionVisuals(),this.socialsController?.updateSelectionVisuals(),this.dialogZoneRenderer?.updateSelectionVisuals();const e=this.cameras.main,t=this.data.get("playerSprite");ur({scrollX:e.worldView.x,scrollY:e.worldView.y,viewWidth:e.width,viewHeight:e.height,worldWidth:this.config.worldWidth,worldHeight:this.config.worldHeight,zoom:e.zoom,playerX:t?.x??this.config.playerStartX,playerY:t?.y??this.config.playerStartY})}navigateToPosition(e,t){this.cameraController.centerOn(e,t)}handleResize(e){!this.cameras?.main||!this.config||(this.cameraController?.handleResize(),this.gridOverlay&&this.gridOverlay.redraw())}shutdown(){this.isShuttingDown||(this.isShuttingDown=!0,this.scale.off("resize",this.handleResize,this),this.minimapSubscription&&this.minimapSubscription.unsubscribe(),this.cameraController&&this.cameraController.destroy(),this.playerController&&this.playerController.destroy(),this.gridOverlay&&this.gridOverlay.destroy(),this.itemsController&&this.itemsController.destroy(),this.framesController&&this.framesController.destroy(),this.socialsController&&this.socialsController.destroy(),this.dialogZoneRenderer&&this.dialogZoneRenderer.destroy())}}aa();class ho{currentLanguage="cs";setLanguage(e){this.currentLanguage=e,localStorage.setItem("language",e)}getLanguage(){const e=localStorage.getItem("language");return(e==="cs"||e==="en")&&(this.currentLanguage=e),this.currentLanguage}toggleLanguage(){return this.currentLanguage=this.currentLanguage==="cs"?"en":"cs",this.setLanguage(this.currentLanguage),this.currentLanguage}}const Fn=new ho;let qe=null;function uo(i){qe=i}function go(){if(!qe)return console.error("Scene manager not initialized"),null;try{return qe.scene.getScene(Qe.GAME)?.mapConfig||null}catch(i){return console.error("Failed to get map config:",i),null}}function fo(i){if(!qe)return console.error("Scene manager not initialized"),!1;try{return qe.scene.getScene(Qe.GAME)?(qe.scene.stop(Qe.GAME),cr(i),qe.scene.start(Qe.BUILDER,{config:i}),!0):(console.error("GameScene not found"),!1)}catch(e){return console.error("Failed to switch to builder:",e),!1}}function po(){if(console.log("[SceneManager] switchToGame called"),!qe)return console.error("Scene manager not initialized"),!1;try{return console.log("[SceneManager] Stopping builder scene..."),qe.scene.stop(Qe.BUILDER),console.log("[SceneManager] Exiting builder mode..."),dr(),console.log("[SceneManager] Starting game scene..."),qe.scene.start(Qe.GAME,{useBuilderConfig:!0}),console.log("[SceneManager] switchToGame completed successfully"),!0}catch(i){return console.error("Failed to switch to game:",i),!1}}function mo(){if(!qe){console.error("Scene manager not initialized");return}try{qe.scene.start(Qe.GAME)}catch(i){console.error("Failed to start game scene:",i)}}var vo=F('<button class="close-btn svelte-yrmttr" title="Close">×</button>'),yo=F('<div class="resize-handle resize-handle-nw svelte-yrmttr"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-yrmttr"><path d="M9 9L1 1M5 1L1 1L1 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-ne svelte-yrmttr"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-yrmttr"><path d="M1 9L9 1M5 1L9 1L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-sw svelte-yrmttr"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-yrmttr"><path d="M9 1L1 9M1 5L1 9L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-se svelte-yrmttr"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-yrmttr"><path d="M1 1L9 9M9 5L9 9L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>',1),So=F("<div><!></div> <!>",1),bo=F('<div data-ui=""><div class="panel-header svelte-yrmttr"><span class="panel-title svelte-yrmttr"> </span> <!> <div class="header-buttons svelte-yrmttr"><button class="minimize-btn svelte-yrmttr"> </button> <!></div></div> <!></div>');function Zt(i,e){Te(e,!0);const t=()=>O(mt,"$isDraggingInBuilder",s),[s,n]=He();let a=1e3,r=_e(e,"initialRight",3,10),l=_e(e,"initialTop",3,60),c=_e(e,"width",3,280),d=_e(e,"minWidth",3,200),h=_e(e,"minHeight",3,100),v=_e(e,"maxWidth",3,600),w=_e(e,"maxHeight",3,800),y=_e(e,"resizable",3,!1),p=_e(e,"startMinimized",3,!1),_=_e(e,"showClose",3,!1),I=te(nt(p())),f=te(!1),b=te(nt({x:0,y:0})),m=te(nt({width:c(),height:e.height??0})),g=te(!1),u=te(!1),x=te("se"),E=te(nt({x:0,y:0})),D=te(null),H=te(!1),T=te(nt(a)),A=te(null),$=te("");function R(){a++,L(T,a,!0)}function U(X,B,re){let Pe=X;const Ge=window.innerWidth-re-10;Pe>Ge&&(Pe=Math.max(10,Ge)),Pe<10&&(Pe=10);let Re=B;const et=window.innerHeight-40;return Re>et&&(Re=Math.max(10,et)),Re<10&&(Re=10),{x:Pe,y:Re}}Xe(()=>{if(typeof window>"u"||o(H))return;const X=localStorage.getItem(`panel-state-${e.panelId}`);if(X)try{const B=JSON.parse(X),re=y()&&B.width?B.width:c(),Se=U(B.x,B.y,re);L(b,Se,!0),y()&&B.width&&B.height&&L(m,{width:B.width,height:B.height},!0);const we=y()?{x:Se.x,y:Se.y,width:o(m).width,height:o(m).height}:{x:Se.x,y:Se.y};L($,JSON.stringify(we),!0)}catch{L(b,{x:window.innerWidth-c()-r(),y:l()},!0)}else L(b,{x:window.innerWidth-c()-r(),y:l()},!0);L(H,!0)}),Xe(()=>{if(!o(H))return;const X=y()?{x:o(b).x,y:o(b).y,width:o(m).width,height:o(m).height}:{x:o(b).x,y:o(b).y},B=JSON.stringify(X);B!==o($)&&(L($,B,!0),localStorage.setItem(`panel-state-${e.panelId}`,B))}),Xe(()=>{if(!o(H))return;function X(){if(!o(D))return;const B=y()?o(m).width:c();let re=o(b).x,Se=o(b).y,we=!1;const Pe=window.innerWidth-B;o(b).x>Pe&&(re=Math.max(10,Pe),we=!0);const Ge=window.innerHeight-40;o(b).y>Ge&&(Se=Math.max(10,Ge),we=!0),o(b).x<0&&(re=10,we=!0),o(b).y<0&&(Se=10,we=!0),we&&L(b,{x:re,y:Se},!0)}return window.addEventListener("resize",X),()=>{window.removeEventListener("resize",X)}});function M(){L(I,!o(I))}function k(){e.onclose?.()}function Y(){if(y())if(o(f))o(A)&&(L(b,{x:o(A).x,y:o(A).y},!0),L(m,{width:o(A).width,height:o(A).height},!0),L(A,null)),L(f,!1);else{L(A,{x:o(b).x,y:o(b).y,width:o(m).width,height:o(m).height},!0);const X=20,B=Math.min(v(),window.innerWidth-X*2),re=Math.min(w(),window.innerHeight-X*2),Se=Math.max(X,(window.innerWidth-B)/2),we=Math.max(X,(window.innerHeight-re)/2);L(b,{x:Se,y:we},!0),L(m,{width:B,height:re},!0),L(f,!0)}}function N(X){X.target.closest("button")||Y()}function ie(X){X.target.closest("button")||(L(g,!0),L(E,{x:X.clientX-o(b).x,y:X.clientY-o(b).y},!0),X.currentTarget.setPointerCapture(X.pointerId),X.preventDefault())}function ae(X){if(!o(g))return;const B=X.clientX-o(E).x,re=X.clientY-o(E).y,Se=window.innerWidth-(o(D)?.offsetWidth??c()),we=window.innerHeight-40;L(b,{x:Math.max(0,Math.min(B,Se)),y:Math.max(0,Math.min(re,we))},!0)}function ce(X){o(g)&&(L(g,!1),X.currentTarget.releasePointerCapture(X.pointerId))}function me(X){return B=>{y()&&(L(u,!0),L(x,X,!0),B.currentTarget.setPointerCapture(B.pointerId),B.preventDefault(),B.stopPropagation())}}function W(X){if(!o(u)||!o(D))return;const B=o(D).getBoundingClientRect();let re,Se,we=o(b).x,Pe=o(b).y;const Ge=o(x)==="se"||o(x)==="ne",Re=o(x)==="se"||o(x)==="sw";Ge?re=X.clientX-B.left:(re=B.right-X.clientX,we=X.clientX),Re?Se=X.clientY-B.top:(Se=B.bottom-X.clientY,Pe=X.clientY);const et=Math.max(d(),Math.min(v(),re)),Q=Math.max(h(),Math.min(w(),Se));Ge||(we=B.right-et,we<0&&(we=0)),Re||(Pe=B.bottom-Q,Pe<0&&(Pe=0));const xe=Ge?window.innerWidth-o(b).x-10:B.right-10,ge=Re?window.innerHeight-o(b).y-10:B.bottom-10,ke=Math.min(et,xe),be=Math.min(Q,ge);L(m,{width:ke,height:be},!0);let Fe=!1,Be=o(b).x,Ct=o(b).y;!Ge&&re>=d()&&(Be=Math.max(0,we),Fe=!0),!Re&&Se>=h()&&(Ct=Math.max(0,Pe),Fe=!0),Fe&&L(b,{x:Be,y:Ct},!0)}function j(X){o(u)&&(L(u,!1),X.currentTarget.releasePointerCapture(X.pointerId))}function se(X){X.stopPropagation()}var q=bo();let de;q.__pointerdown=X=>{R(),se(X)},q.__click=se;var he=P(q);he.__pointerdown=ie,he.__pointermove=ae,he.__pointerup=ce,he.__dblclick=N;var ue=P(he),ve=P(ue),ne=C(ue,2);{var ye=X=>{var B=$e(),re=fe(B);es(re,()=>e.headerExtra),S(X,B)};V(ne,X=>{e.headerExtra&&X(ye)})}var Ie=C(ne,2),Oe=P(Ie);Oe.__click=M;var Ue=P(Oe),ze=C(Oe,2);{var vt=X=>{var B=vo();B.__click=k,S(X,B)};V(ze,X=>{_()&&X(vt)})}var Bt=C(he,2);{var dt=X=>{var B=So(),re=fe(B);let Se;var we=P(re);es(we,()=>e.children);var Pe=C(re,2);{var Ge=Re=>{var et=yo(),Q=fe(et),xe=Z(()=>me("nw"));Q.__pointerdown=function(...yt){o(xe)?.apply(this,yt)},Q.__pointermove=W,Q.__pointerup=j;var ge=C(Q,2),ke=Z(()=>me("ne"));ge.__pointerdown=function(...yt){o(ke)?.apply(this,yt)},ge.__pointermove=W,ge.__pointerup=j;var be=C(ge,2),Fe=Z(()=>me("sw"));be.__pointerdown=function(...yt){o(Fe)?.apply(this,yt)},be.__pointermove=W,be.__pointerup=j;var Be=C(be,2),Ct=Z(()=>me("se"));Be.__pointerdown=function(...yt){o(Ct)?.apply(this,yt)},Be.__pointermove=W,Be.__pointerup=j,Ve("pointercancel",Q,j),Ve("pointercancel",ge,j),Ve("pointercancel",be,j),Ve("pointercancel",Be,j),S(Re,et)};V(Pe,Re=>{y()&&Re(Ge)})}z(()=>Se=De(re,1,"panel-body svelte-yrmttr",null,Se,{"has-fixed-height":y()&&o(m).height>0})),S(X,B)};V(Bt,X=>{o(I)||X(dt)})}pt(q,X=>L(D,X),()=>o(D)),z(()=>{de=De(q,1,"draggable-panel svelte-yrmttr",null,de,{minimized:o(I),maximized:o(f),dragging:o(g),resizing:o(u),resizable:y()}),pe(q,`left: ${o(b).x??""}px; top: ${o(b).y??""}px; width: ${o(I)?"auto":`${y()?o(m).width:c()}px`}; ${y()&&o(m).height>0&&!o(I)?`height: ${o(m).height}px;`:""}${t()?" pointer-events: none;":""} z-index: ${o(T)??""};`),Ee(ve,e.title),J(Oe,"title",o(I)?"Expand":"Minimize"),Ee(Ue,o(I)?"▲":"▼")}),Ve("pointercancel",he,ce),S(i,q),Ce(),n()}at(["pointerdown","click","pointermove","pointerup","dblclick"]);const Wi=10,wo=150,_o=`
  position: fixed;
  pointer-events: none;
  z-index: 10000;
  opacity: 0.9;
  image-rendering: pixelated;
  filter: drop-shadow(3px 3px 0 rgba(0, 0, 0, 0.5));
  background: rgba(26, 26, 46, 0.9);
`,Io=`
  width: 100%;
  height: 100%;
  object-fit: contain;
  image-rendering: pixelated;
`;function ui(i,e,t){const{previewSize:s,borderColor:n,dataKey:a,eventName:r,onDrop:l}=i,c=s/2,d={startX:0,startY:0,hasMoved:!1,isActivated:!1,pendingKey:null,pendingTarget:null,longPressTimer:null};function h(T,A,$){We.emit(r,{[a]:T,canvasX:A,canvasY:$}),l?.()}function v(T,A){const $=document.querySelector("canvas");if(!$)return null;const R=$.getBoundingClientRect();return T>=R.left&&T<=R.right&&A>=R.top&&A<=R.bottom?{canvasX:T-R.left,canvasY:A-R.top}:null}function w(T,A,$){const R=document.createElement("div");return R.className="touch-drag-preview",R.innerHTML=`<img src="${T}" alt="" />`,R.style.cssText=`
      ${_o}
      top: ${$-c}px;
      left: ${A-c}px;
      width: ${s}px;
      height: ${s}px;
      border: 2px solid ${n};
    `,R.querySelector("img").style.cssText=Io,document.body.appendChild(R),R}function y(T,A,$){T.style.top=`${$-c}px`,T.style.left=`${A-c}px`}function p(){d.longPressTimer&&(clearTimeout(d.longPressTimer),d.longPressTimer=null),d.pendingKey=null,d.pendingTarget=null,d.isActivated=!1,d.hasMoved=!1}function _(){p();const T=e();T.touchDragElement&&(T.touchDragElement.remove(),t({touchDragElement:null})),t({draggedKey:null}),cs(!1)}function I(T,A){if(!T.dataTransfer)return;t({draggedKey:A}),cs(!0),T.dataTransfer.effectAllowed="copy",T.dataTransfer.setData(a,A);const R=T.target.querySelector("img")?.cloneNode(!0);R&&(R.style.cssText="position: absolute; top: -1000px;",document.body.appendChild(R),T.dataTransfer.setDragImage(R,c,c),requestAnimationFrame(()=>R.remove()))}function f(){t({draggedKey:null}),cs(!1)}function b(T){T.preventDefault(),T.dataTransfer&&(T.dataTransfer.dropEffect="copy")}function m(T){T.preventDefault();const A=T.dataTransfer?.getData(a);if(!A)return;const $=v(T.clientX,T.clientY);$&&h(A,$.canvasX,$.canvasY)}function g(T,A){if(!d.pendingKey||!d.pendingTarget||d.isActivated)return;d.isActivated=!0,t({draggedKey:d.pendingKey}),cs(!0);const $=d.pendingTarget.querySelector("img");if($){const R=w($.src,T,A);t({touchDragElement:R})}}function u(T,A){if(T.touches.length!==1)return;const $=T.touches[0];d.startX=$.clientX,d.startY=$.clientY,d.hasMoved=!1,d.isActivated=!1,d.pendingKey=A,d.pendingTarget=T.currentTarget,d.longPressTimer=setTimeout(()=>{d.pendingKey&&!d.hasMoved&&g($.clientX,$.clientY)},wo)}function x(T){const A=T.touches[0],$=A.clientX-d.startX,R=A.clientY-d.startY;if(!d.hasMoved&&(Math.abs($)>Wi||Math.abs(R)>Wi)&&(d.hasMoved=!0,!d.isActivated)){if(Math.abs(R)>Math.abs($)){p();return}g(A.clientX,A.clientY)}const U=e();d.isActivated&&U.touchDragElement&&(y(U.touchDragElement,A.clientX,A.clientY),T.preventDefault())}function E(T){const A=e(),$=d.isActivated,R=A.draggedKey;if($&&R&&d.hasMoved){const U=T.changedTouches[0],M=v(U.clientX,U.clientY);M&&h(R,M.canvasX,M.canvasY)}_()}function D(){const T=document.querySelector("canvas");return T?(T.addEventListener("dragover",b),T.addEventListener("drop",m),()=>{T.removeEventListener("dragover",b),T.removeEventListener("drop",m)}):()=>{}}function H(){return document.addEventListener("touchmove",x,{passive:!1}),document.addEventListener("touchend",E),document.addEventListener("touchcancel",E),()=>{document.removeEventListener("touchmove",x),document.removeEventListener("touchend",E),document.removeEventListener("touchcancel",E)}}return{onDragStart:I,onDragEnd:f,onTouchStart:u,setupCanvasListeners:D,setupTouchListeners:H}}var xo=F('<span class="palette-hint svelte-ntcafk">Drag to place</span>'),Eo=F('<div data-ui="" draggable="true" role="button" tabindex="0"><img class="item-preview svelte-ntcafk"/></div>'),To=F('<div class="palette-content svelte-ntcafk" role="toolbar" tabindex="-1"><div class="palette-grid svelte-ntcafk"></div></div>');function Co(i,e){Te(e,!0);const t=()=>O(Et,"$isItemPaletteOpen",n),s=()=>O(Ze,"$builderEditMode",n),[n,a]=He(),r="#4a90e2",l=600,c=di;function d(){return window.innerWidth<l}function h(){d()&&Et.set(!1)}let v=te(null),w=te(null);const y=ui({previewSize:48,borderColor:r,dataKey:"assetKey",eventName:Ae.ASSET_DROPPED,onDrop:h},()=>({draggedKey:o(v),touchDragElement:o(w)}),g=>{"draggedKey"in g&&L(v,g.draggedKey??null,!0),"touchDragElement"in g&&L(w,g.touchDragElement??null,!0)});function p(g){g.stopPropagation()}function _(){Et.set(!1)}function I(g){const u=document.querySelector("canvas");if(!u)return;const x=u.getBoundingClientRect(),E=x.width/2,D=x.height/2;We.emit(Ae.ASSET_DROPPED,{assetKey:g,canvasX:E,canvasY:D}),h()}_s(()=>y.setupCanvasListeners()),Xe(()=>y.setupTouchListeners());var f=$e(),b=fe(f);{var m=g=>{Zt(g,{panelId:"item-palette",title:"Items",initialRight:10,initialTop:60,width:280,height:400,minWidth:200,minHeight:160,maxWidth:500,maxHeight:600,resizable:!0,showClose:!0,onclose:_,headerExtra:x=>{var E=xo();S(x,E)},children:(x,E)=>{var D=To();D.__pointerdown=p;var H=P(D);Ne(H,21,()=>c,Ke,(T,A)=>{var $=Eo();let R;$.__touchstart=M=>y.onTouchStart(M,o(A).key),$.__dblclick=()=>I(o(A).key),pe($,"",{},{"--accent-color":r});var U=P($);z(()=>{R=De($,1,"palette-item svelte-ntcafk",null,R,{dragging:o(v)===o(A).key}),J($,"title",`${o(A).name??""} (double-click to place)`),J(U,"src",o(A).path),J(U,"alt",o(A).name)}),Ve("dragstart",$,M=>y.onDragStart(M,o(A).key)),Ve("dragend",$,function(...M){y.onDragEnd?.apply(this,M)}),S(T,$)}),S(x,D)},$$slots:{headerExtra:!0,default:!0}})};V(b,g=>{t()&&s()==="items"&&g(m)})}S(i,f),Ce(),a()}at(["pointerdown","touchstart","dblclick"]);var Do=F('<span class="palette-hint svelte-jnw59q">Drag to place</span>'),Po=F('<div data-ui="" draggable="true" role="button" tabindex="0"><img class="item-preview svelte-jnw59q"/></div>'),ko=F('<div class="palette-content svelte-jnw59q" role="toolbar" tabindex="-1"><div class="palette-grid svelte-jnw59q"></div></div>');function Mo(i,e){Te(e,!0);const t=()=>O(_t,"$isFramePaletteOpen",n),s=()=>O(Ze,"$builderEditMode",n),[n,a]=He(),r="#9b59b6",l=bs;let c=te(null),d=te(null);const h=ui({previewSize:64,borderColor:r,dataKey:"frameKey",eventName:Ae.FRAME_DROPPED,onDrop:()=>{_t.set(!1)}},()=>({draggedKey:o(c),touchDragElement:o(d)}),f=>{"draggedKey"in f&&L(c,f.draggedKey??null,!0),"touchDragElement"in f&&L(d,f.touchDragElement??null,!0)});function v(f){f.stopPropagation()}function w(){_t.set(!1)}function y(f){const b=document.querySelector("canvas");if(!b)return;const m=b.getBoundingClientRect(),g=m.width/2,u=m.height/2;We.emit(Ae.FRAME_DROPPED,{frameKey:f,canvasX:g,canvasY:u}),_t.set(!1)}_s(()=>h.setupCanvasListeners()),Xe(()=>h.setupTouchListeners());var p=$e(),_=fe(p);{var I=f=>{Zt(f,{panelId:"frame-palette",title:"Frames",initialRight:10,initialTop:60,width:320,height:400,minWidth:220,minHeight:200,maxWidth:600,maxHeight:600,resizable:!0,showClose:!0,onclose:w,headerExtra:m=>{var g=Do();S(m,g)},children:(m,g)=>{var u=ko();u.__pointerdown=v;var x=P(u);Ne(x,21,()=>l,Ke,(E,D)=>{var H=Po();let T;H.__touchstart=$=>h.onTouchStart($,o(D).key),H.__dblclick=()=>y(o(D).key),pe(H,"",{},{"--accent-color":r});var A=P(H);z(()=>{T=De(H,1,"palette-item svelte-jnw59q",null,T,{dragging:o(c)===o(D).key}),J(H,"title",`${o(D).name??""} (double-click to place)`),J(A,"src",o(D).path),J(A,"alt",o(D).name)}),Ve("dragstart",H,$=>h.onDragStart($,o(D).key)),Ve("dragend",H,function(...$){h.onDragEnd?.apply(this,$)}),S(E,H)}),S(m,u)},$$slots:{headerExtra:!0,default:!0}})};V(_,f=>{t()&&s()==="frames"&&f(I)})}S(i,p),Ce(),a()}at(["pointerdown","touchstart","dblclick"]);var Ao=F('<span class="palette-hint svelte-whpd9j">Drag to place</span>'),$o=F('<div data-ui="" draggable="true" role="button" tabindex="0"><img class="item-preview svelte-whpd9j"/> <span class="item-name svelte-whpd9j"> </span></div>'),Ho=F('<div class="palette-content svelte-whpd9j" role="toolbar" tabindex="-1"><div class="palette-grid svelte-whpd9j"></div></div>');function Lo(i,e){Te(e,!0);const t=()=>O(It,"$isSocialPaletteOpen",n),s=()=>O(Ze,"$builderEditMode",n),[n,a]=He(),r=Yt.SOCIAL.css,l=ws;let c=te(null),d=te(null);const h=ui({previewSize:64,borderColor:r,dataKey:"socialKey",eventName:Ae.SOCIAL_DROPPED,onDrop:()=>{It.set(!1)}},()=>({draggedKey:o(c),touchDragElement:o(d)}),f=>{"draggedKey"in f&&L(c,f.draggedKey??null,!0),"touchDragElement"in f&&L(d,f.touchDragElement??null,!0)});function v(f){f.stopPropagation()}function w(){It.set(!1)}function y(f){const b=document.querySelector("canvas");if(!b)return;const m=b.getBoundingClientRect(),g=m.width/2,u=m.height/2;We.emit(Ae.SOCIAL_DROPPED,{socialKey:f,canvasX:g,canvasY:u}),It.set(!1)}_s(()=>h.setupCanvasListeners()),Xe(()=>h.setupTouchListeners());var p=$e(),_=fe(p);{var I=f=>{Zt(f,{panelId:"social-palette",title:"Socials",initialRight:10,initialTop:60,width:280,height:350,minWidth:200,minHeight:200,maxWidth:500,maxHeight:500,resizable:!0,showClose:!0,onclose:w,headerExtra:m=>{var g=Ao();S(m,g)},children:(m,g)=>{var u=Ho();u.__pointerdown=v;var x=P(u);Ne(x,21,()=>l,Ke,(E,D)=>{var H=$o();let T;H.__touchstart=M=>h.onTouchStart(M,o(D).key),H.__dblclick=()=>y(o(D).key);let A;var $=P(H),R=C($,2),U=P(R);z(()=>{T=De(H,1,"palette-item svelte-whpd9j",null,T,{dragging:o(c)===o(D).key}),J(H,"title",`${o(D).name??""} (double-click to place)`),A=pe(H,"",A,{"--accent-color":r}),J($,"src",o(D).path),J($,"alt",o(D).name),Ee(U,o(D).name)}),Ve("dragstart",H,M=>h.onDragStart(M,o(D).key)),Ve("dragend",H,function(...M){h.onDragEnd?.apply(this,M)}),S(E,H)}),S(m,u)},$$slots:{headerExtra:!0,default:!0}})};V(_,f=>{t()&&s()==="socials"&&f(I)})}S(i,p),Ce(),a()}at(["pointerdown","touchstart","dblclick"]);var Oo=F("<button> </button>"),Ro=F('<div class="language-tabs svelte-ng6pis"></div>');function Xn(i,e){Te(e,!0);let t=_e(e,"accentColor",3,"#88ddff");var s=Ro();Ne(s,21,()=>Wa,Ke,(n,a)=>{var r=Oo();let l;r.__click=()=>e.onselect(o(a).code);let c;var d=P(r);z(()=>{l=De(r,1,"lang-tab svelte-ng6pis",null,l,{active:e.selectedLanguage===o(a).code}),c=pe(r,"",c,{"--accent-color":t()}),Ee(d,o(a).label)}),S(n,r)}),S(i,s),Ce()}at(["click"]);var Fo=F("<button></button>"),Xo=F('<div class="color-picker svelte-1jc3e0j"></div>'),Wo=F('<div class="color-section svelte-1jc3e0j"><span class="color-label-title svelte-1jc3e0j"> </span> <button class="color-button svelte-1jc3e0j" title="Change color"><span class="color-preview svelte-1jc3e0j"></span> <span class="color-label svelte-1jc3e0j">Change</span></button> <!></div>');function Vs(i,e){Te(e,!0);let t=_e(e,"label",3,"Color"),s=_e(e,"accentColor",3,"#88ddff"),n=te(!1),a=te(null);Xe(()=>{o(n)&&o(a)&&requestAnimationFrame(()=>{o(a)?.scrollIntoView({behavior:"smooth",block:"nearest"})})});function r(f){e.onselect(f)}function l(){L(n,!o(n))}var c=Wo(),d=P(c),h=P(d),v=C(d,2);v.__click=l;let w;var y=P(v);let p;var _=C(v,2);{var I=f=>{var b=Xo();Ne(b,21,()=>e.colors,Ke,(m,g)=>{var u=Fo();let x;u.__click=()=>r(o(g));let E;z(()=>{x=De(u,1,"color-swatch svelte-1jc3e0j",null,x,{selected:e.selectedColor===o(g)}),J(u,"title",o(g)),E=pe(u,"",E,{background:o(g),"--accent-color":s()})}),S(m,u)}),pt(b,m=>L(a,m),()=>o(a)),S(f,b)};V(_,f=>{o(n)&&f(I)})}z(()=>{Ee(h,t()),w=pe(v,"",w,{"--accent-color":s()}),p=pe(y,"",p,{background:e.selectedColor})}),S(i,c),Ce()}at(["click"]);const Yi=50,Zi=400,Yo=400,Zo=70;var Bo=F('<div class="form-section svelte-jhtkop"><div class="form-group svelte-jhtkop"><label class="svelte-jhtkop"> </label> <input type="text" class="svelte-jhtkop"/></div> <div class="form-group svelte-jhtkop"><label class="svelte-jhtkop"> </label> <textarea rows="6" class="svelte-jhtkop"></textarea></div></div>');function Go(i,e){Te(e,!0);let t=_e(e,"titlePlaceholder",3,"Enter title..."),s=_e(e,"contentPlaceholder",3,"Enter text..."),n=_e(e,"idPrefix",3,"text-form"),a=_e(e,"accentColor",3,"#88ddff");function r(b){const m=b.target;e.ontitlechange(m.value)}function l(b){const m=b.target;e.oncontentchange(m.value)}var c=Bo();let d;var h=P(c),v=P(h),w=P(v),y=C(v,2);y.__input=r;var p=C(h,2),_=P(p),I=P(_),f=C(_,2);f.__input=l,z(()=>{d=pe(c,"",d,{"--accent-color":a()}),J(v,"for",`${n()??""}-title`),Ee(w,`Title (max ${Yi} chars)`),J(y,"id",`${n()??""}-title`),ts(y,e.title),J(y,"placeholder",t()),J(y,"maxlength",Yi),J(_,"for",`${n()??""}-content`),Ee(I,`Content (max ${Zi} chars)`),J(f,"id",`${n()??""}-content`),ts(f,e.content),J(f,"placeholder",s()),J(f,"maxlength",Zi)}),S(i,c),Ce()}at(["input"]);var No=F('<div class="panel-content svelte-zzlycq"><!> <!> <div class="panel-extras svelte-zzlycq"><!></div> <div class="panel-footer svelte-zzlycq"><!> <!></div></div>');function zo(i,e){Te(e,!0);const t=()=>O(ti,"$dialogZones",a),s=()=>O(Ts,"$selectedDialogZoneId",a),n=()=>O(ii,"$isDialogZonePanelOpen",a),[a,r]=He(),l="#88ddff";let c=te(nt(mn)),d=Z(()=>t().find(g=>g.id===s())??null),h=Z(()=>o(d)?.texts.find(g=>g.language===o(c))??null);function v(g){s()&&bi(s(),o(c),{title:g})}function w(g){s()&&bi(s(),o(c),{content:g})}function y(){s()&&(Pn(s()),yi())}function p(){yi()}function _(g){s()&&Mt(s(),{color:g})}function I(g){L(c,g,!0)}var f=$e(),b=fe(f);{var m=g=>{Zt(g,{panelId:"dialog-zone-panel",title:"Dialog Zone",initialRight:10,initialTop:160,width:280,height:450,minWidth:250,minHeight:370,maxWidth:500,maxHeight:700,resizable:!0,showClose:!0,onclose:p,children:(u,x)=>{var E=No(),D=P(E);Xn(D,{get selectedLanguage(){return o(c)},onselect:I,accentColor:l});var H=C(D,2);{let M=Z(()=>o(h)?.title??""),k=Z(()=>o(h)?.content??"");Go(H,{get title(){return o(M)},get content(){return o(k)},ontitlechange:v,oncontentchange:w,titlePlaceholder:"Enter title...",contentPlaceholder:"Enter dialog text...",idPrefix:"dialog",accentColor:l})}var T=C(H,2),A=P(T);Vs(A,{get colors(){return Bs},get selectedColor(){return o(d).color},onselect:_,label:"Zone Color",accentColor:l});var $=C(T,2),R=P($);oe(R,{variant:"cyan",onclick:p,children:(M,k)=>{var Y=le("CONFIRM");S(M,Y)},$$slots:{default:!0}});var U=C(R,2);oe(U,{variant:"red",onclick:y,children:(M,k)=>{var Y=le("DELETE");S(M,Y)},$$slots:{default:!0}}),S(u,E)},$$slots:{default:!0}})};V(b,g=>{o(d)&&n()&&g(m)})}S(i,f),Ce(),r()}var Ko=F("<button> </button>"),Uo=F("<option> </option>"),Vo=F("<button> </button>"),jo=F('<a target="_blank" rel="noopener noreferrer" class="url-preview svelte-ds1z4d">Test link ↗</a>'),qo=F('<button><img class="svelte-ds1z4d"/></button>'),Jo=F('<div class="style-picker svelte-ds1z4d"></div>'),Qo=F('<div class="panel-content svelte-ds1z4d"><!> <div class="frame-size-row svelte-ds1z4d"><div class="frame-size-section svelte-ds1z4d"><span class="section-label svelte-ds1z4d">Frame Size</span> <div class="size-buttons svelte-ds1z4d"></div></div> <div class="rotate-section svelte-ds1z4d"><span class="section-label svelte-ds1z4d">Rotate</span> <button class="rotate-btn svelte-ds1z4d"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-ds1z4d"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button></div></div> <div class="panel-extras svelte-ds1z4d"><div class="text-section svelte-ds1z4d"><label for="frame-text" class="svelte-ds1z4d">Text</label> <textarea id="frame-text" placeholder="Enter text..." rows="3" class="svelte-ds1z4d"></textarea></div> <div class="size-rotation-row svelte-ds1z4d"><div class="size-section svelte-ds1z4d"><label for="text-size" class="svelte-ds1z4d">Text Size</label> <select id="text-size" class="svelte-ds1z4d"></select></div></div> <div class="text-align-section svelte-ds1z4d"><span class="section-label svelte-ds1z4d">Text Alignment</span> <div class="align-buttons svelte-ds1z4d"></div></div> <div class="url-section svelte-ds1z4d"><label for="frame-url" class="svelte-ds1z4d">Link URL (opens on click)</label> <input id="frame-url" type="url" placeholder="https://example.com" class="svelte-ds1z4d"/> <!></div> <!> <!> <div class="style-section svelte-ds1z4d"><span class="section-label svelte-ds1z4d">Frame Style</span> <button class="style-button svelte-ds1z4d" title="Change frame style"><img alt="Current frame" class="style-preview svelte-ds1z4d"/> <span class="style-label svelte-ds1z4d">Change Style</span></button> <!></div></div> <div class="panel-footer svelte-ds1z4d"><!> <!></div></div>');function el(i,e){Te(e,!0);const t=()=>O(ei,"$builderPreviewLanguage",r),s=()=>O(er,"$selectedFrame",r),n=()=>O(as,"$selectedFrameId",r),a=()=>O(Is,"$isFramePanelOpen",r),[r,l]=He(),c="#9b59b6";let d=Z(t),h=Z(s),v=Z(()=>o(h)?.texts.find(k=>k.language===o(d))??null),w=Z(()=>o(h)?Gr(o(h).scale??4):"M");function y(k){const Y=k.target;if(!n()||!o(h))return;const N=o(h).texts.map(ie=>ie.language===o(d)?{...ie,text:Y.value}:ie);N.some(ie=>ie.language===o(d))||N.push({language:o(d),text:Y.value}),it(n(),{texts:N})}function p(k){const Y=k.target;n()&&it(n(),{url:Y.value||void 0})}function _(k){n()&&it(n(),{backgroundColor:k})}function I(k){n()&&it(n(),{textColor:k})}function f(k){const Y=k.target;n()&&it(n(),{textSize:parseInt(Y.value,10)})}function b(k){n()&&it(n(),{scale:Br(k)})}function m(k){n()&&it(n(),{textAlign:k})}function g(){if(!n()||!o(h))return;const Y=(o(h).rotation??0)===0?90:0;it(n(),{rotation:Y})}function u(){n()&&li(n())}function x(){za(),jt(null)}function E(k){Va(k)}let D=te(!1),H=te(null),T=te(null);function A(k){n()&&it(n(),{frameKey:k})}function $(){L(D,!o(D))}Xe(()=>{o(D)&&o(H)&&requestAnimationFrame(()=>{o(H)?.scrollIntoView({behavior:"smooth",block:"nearest"})})}),Xe(()=>{if(!o(D))return;function k(Y){const N=Y.target;o(H)&&!o(H).contains(N)&&o(T)&&!o(T).contains(N)&&L(D,!1)}return document.addEventListener("click",k),()=>document.removeEventListener("click",k)});var R=$e(),U=fe(R);{var M=k=>{Zt(k,{panelId:"frame-panel",title:"Edit Frame",initialRight:10,initialTop:160,width:280,height:520,minWidth:250,minHeight:450,maxWidth:500,maxHeight:700,resizable:!0,showClose:!0,onclose:x,children:(Y,N)=>{var ie=Qo(),ae=P(ie);Xn(ae,{get selectedLanguage(){return o(d)},onselect:E,accentColor:c});var ce=C(ae,2),me=P(ce),W=C(P(me),2);Ne(W,21,()=>Object.entries(Ln),Ke,(Q,xe)=>{var ge=Z(()=>Ni(o(xe),2));let ke=()=>o(ge)[0],be=()=>o(ge)[1].label;var Fe=Ko();let Be;Fe.__click=()=>b(ke());var Ct=P(Fe);z(()=>{Be=De(Fe,1,"size-btn svelte-ds1z4d",null,Be,{active:o(w)===ke()}),J(Fe,"title",be()),Ee(Ct,ke())}),S(Q,Fe)});var j=C(me,2),se=C(P(j),2);se.__click=g;var q=C(ce,2),de=P(q),he=C(P(de),2);he.__input=y;var ue=C(de,2),ve=P(ue),ne=C(P(ve),2);ne.__change=f,Ne(ne,21,()=>Yr,Ke,(Q,xe)=>{var ge=Uo(),ke=P(ge),be={};z(()=>{Ee(ke,`${o(xe)??""}px`),be!==(be=o(xe))&&(ge.value=(ge.__value=o(xe))??"")}),S(Q,ge)});var ye;ha(ne);var Ie=C(ue,2),Oe=C(P(Ie),2);Ne(Oe,21,()=>Zr,Ke,(Q,xe)=>{let ge=()=>o(xe).value,ke=()=>o(xe).label;var be=Vo();let Fe;be.__click=()=>m(ge());var Be=P(be);z(()=>{Fe=De(be,1,"align-btn svelte-ds1z4d",null,Fe,{active:(o(h).textAlign??Rn)===ge()}),J(be,"title",ke()),Ee(Be,ke())}),S(Q,be)});var Ue=C(Ie,2),ze=C(P(Ue),2);ze.__input=p;var vt=C(ze,2);{var Bt=Q=>{var xe=jo();z(()=>J(xe,"href",o(h).url)),S(Q,xe)};V(vt,Q=>{o(h).url&&Q(Bt)})}var dt=C(Ue,2);{let Q=Z(()=>o(h).textColor??On);Vs(dt,{get colors(){return Wr},get selectedColor(){return o(Q)},onselect:I,label:"Text Color",accentColor:c})}var X=C(dt,2);Vs(X,{get colors(){return Xr},get selectedColor(){return o(h).backgroundColor},onselect:_,label:"Background Color",accentColor:c});var B=C(X,2),re=C(P(B),2);re.__click=$;var Se=P(re);pt(re,Q=>L(T,Q),()=>o(T));var we=C(re,2);{var Pe=Q=>{var xe=Jo();Ne(xe,21,()=>bs,Ke,(ge,ke)=>{var be=qo();let Fe;be.__click=()=>A(o(ke).key);var Be=P(be);z(()=>{Fe=De(be,1,"style-item svelte-ds1z4d",null,Fe,{selected:o(h).frameKey===o(ke).key}),J(be,"title",o(ke).name),J(Be,"src",o(ke).path),J(Be,"alt",o(ke).name)}),S(ge,be)}),pt(xe,ge=>L(H,ge),()=>o(H)),S(Q,xe)};V(we,Q=>{o(D)&&Q(Pe)})}var Ge=C(q,2),Re=P(Ge);oe(Re,{variant:"purple",onclick:x,children:(Q,xe)=>{var ge=le("CONFIRM");S(Q,ge)},$$slots:{default:!0}});var et=C(Re,2);oe(et,{variant:"red",onclick:u,children:(Q,xe)=>{var ge=le("DELETE");S(Q,ge)},$$slots:{default:!0}}),z(Q=>{J(se,"title",o(h).rotation===90?"Portrait (click to rotate)":"Landscape (click to rotate)"),ts(he,o(v)?.text??""),ye!==(ye=o(h).textSize??ps)&&(ne.value=(ne.__value=o(h).textSize??ps)??"",Vi(ne,o(h).textSize??ps)),ts(ze,o(h).url??""),J(Se,"src",Q)},[()=>bs.find(Q=>Q.key===o(h).frameKey)?.path??""]),S(Y,ie)},$$slots:{default:!0}})};V(U,k=>{a()&&o(h)&&k(M)})}S(i,R),Ce(),l()}at(["click","input","change"]);var tl=F("<button> </button>"),sl=F('<a target="_blank" rel="noopener noreferrer" class="url-preview svelte-1v3ae2c">Test link ↗</a>'),il=F('<button><img class="svelte-1v3ae2c"/></button>'),nl=F('<div class="style-picker svelte-1v3ae2c"></div>'),al=F('<div class="panel-content svelte-1v3ae2c"><div class="social-size-row svelte-1v3ae2c"><div class="social-size-section svelte-1v3ae2c"><span class="section-label svelte-1v3ae2c">Size</span> <div class="size-buttons svelte-1v3ae2c"></div></div></div> <div class="panel-extras svelte-1v3ae2c"><div class="url-section svelte-1v3ae2c"><label for="social-url" class="svelte-1v3ae2c">Link URL (opens on click)</label> <input id="social-url" type="url" placeholder="https://example.com" class="svelte-1v3ae2c"/> <!></div> <div class="style-section svelte-1v3ae2c"><span class="section-label svelte-1v3ae2c">Social Icon</span> <button class="style-button svelte-1v3ae2c" title="Change social icon"><img alt="Current social" class="style-preview svelte-1v3ae2c"/> <span class="style-label svelte-1v3ae2c"> </span></button> <!></div></div> <div class="panel-footer svelte-1v3ae2c"><!> <!></div></div>');function rl(i,e){Te(e,!0);const t=()=>O(qa,"$selectedSocial",a),s=()=>O(rs,"$selectedSocialId",a),n=()=>O(xs,"$isSocialPanelOpen",a),[a,r]=He(),l=Yt.SOCIAL.css;let c=Z(t),d=Z(()=>o(c)?Jr(o(c).scale??Rt):"M"),h=Z(()=>o(c)?ws.find(E=>E.key===o(c).socialKey):null);function v(E){const D=E.target;s()&&fs(s(),{url:D.value||void 0})}function w(E){s()&&fs(s(),{scale:qr(E)})}function y(){s()&&ci(s())}function p(){Ua(),qt(null)}let _=te(!1),I=te(null),f=te(null);function b(E){s()&&fs(s(),{socialKey:E})}function m(){L(_,!o(_))}Xe(()=>{o(_)&&o(I)&&requestAnimationFrame(()=>{o(I)?.scrollIntoView({behavior:"smooth",block:"nearest"})})}),Xe(()=>{if(!o(_))return;function E(D){const H=D.target;o(I)&&!o(I).contains(H)&&o(f)&&!o(f).contains(H)&&L(_,!1)}return document.addEventListener("click",E),()=>document.removeEventListener("click",E)});var g=$e(),u=fe(g);{var x=E=>{Zt(E,{panelId:"social-panel",title:"Edit Social",initialRight:10,initialTop:160,width:280,height:350,minWidth:250,minHeight:300,maxWidth:400,maxHeight:500,resizable:!0,showClose:!0,onclose:p,children:(D,H)=>{var T=al(),A=P(T),$=P(A),R=C(P($),2);Ne(R,21,()=>Object.entries(ls),Ke,(ue,ve)=>{var ne=Z(()=>Ni(o(ve),2));let ye=()=>o(ne)[0],Ie=()=>o(ne)[1].label;var Oe=tl();let Ue;Oe.__click=()=>w(ye());var ze=P(Oe);z(()=>{Ue=De(Oe,1,"size-btn svelte-1v3ae2c",null,Ue,{active:o(d)===ye()}),J(Oe,"title",Ie()),Ee(ze,ye())}),S(ue,Oe)});var U=C(A,2),M=P(U),k=C(P(M),2);k.__input=v;var Y=C(k,2);{var N=ue=>{var ve=sl();z(()=>J(ve,"href",o(c).url)),S(ue,ve)};V(Y,ue=>{o(c).url&&ue(N)})}var ie=C(M,2),ae=C(P(ie),2);ae.__click=m;var ce=P(ae),me=C(ce,2),W=P(me);pt(ae,ue=>L(f,ue),()=>o(f));var j=C(ae,2);{var se=ue=>{var ve=nl();Ne(ve,21,()=>ws,Ke,(ne,ye)=>{var Ie=il();let Oe;Ie.__click=()=>b(o(ye).key);var Ue=P(Ie);z(()=>{Oe=De(Ie,1,"style-item svelte-1v3ae2c",null,Oe,{selected:o(c).socialKey===o(ye).key}),J(Ie,"title",o(ye).name),J(Ue,"src",o(ye).path),J(Ue,"alt",o(ye).name)}),S(ne,Ie)}),pt(ve,ne=>L(I,ne),()=>o(I)),S(ue,ve)};V(j,ue=>{o(_)&&ue(se)})}var q=C(U,2),de=P(q);oe(de,{variant:"pink",onclick:p,children:(ue,ve)=>{var ne=le("CONFIRM");S(ue,ne)},$$slots:{default:!0}});var he=C(de,2);oe(he,{variant:"red",onclick:y,children:(ue,ve)=>{var ne=le("DELETE");S(ue,ne)},$$slots:{default:!0}}),z(()=>{pe(T,`--accent-color: ${l}`),ts(k,o(c).url??""),J(ce,"src",o(h)?.path??""),Ee(W,o(h)?.name??"Select")}),S(D,T)},$$slots:{default:!0}})};V(u,E=>{n()&&o(c)&&E(x)})}S(i,g),Ce(),r()}at(["click","input"]);var ol=F("<div> </div>"),ll=F('<div class="frame-content-layer svelte-1vp2oo0"></div>');function Wn(i,e){Te(e,!0);const t=()=>O(wn,"$placedFrames",d),s=()=>O(vn,"$isBuilderMode",d),n=()=>O(oi,"$builderCameraInfo",d),a=()=>O(tn,"$gameCameraInfo",d),r=()=>O(ei,"$builderPreviewLanguage",d),l=()=>O(ss,"$currentLanguage",d),c=()=>O(si,"$draggingFramePositions",d),[d,h]=He();let v=Z(t),w=Z(()=>s()?n().scrollX:a().scrollX),y=Z(()=>s()?n().scrollY:a().scrollY),p=Z(()=>s()?n().zoom:a().zoom),_=Z(()=>s()?r():l()),I=Z(c);function f(u){const x=o(I).get(u.id);return x||{x:u.x,y:u.y}}function b(u){const x=u.scale??ct,E=u.rotation===90,{textWidth:D,textHeight:H}=Jt(x,E),T=f(u),A=(T.x-o(w))*o(p),$=(T.y-o(y))*o(p);return{x:A,y:$,width:D*o(p),height:H*o(p)}}function m(u){return(u.texts.find(E=>E.language===o(_))||u.texts[0]||{text:""}).text||""}var g=ll();Ne(g,21,()=>o(v),u=>u.id,(u,x)=>{const E=Z(()=>b(o(x))),D=Z(()=>m(o(x))),H=Z(()=>(o(x).textSize??ps)*o(p)),T=Z(()=>o(x).textColor??On),A=Z(()=>o(x).textAlign??Rn);var $=$e(),R=fe($);{var U=M=>{var k=ol();let Y;var N=P(k);z(()=>{Y=De(k,1,"frame-text svelte-1vp2oo0",null,Y,{"align-top":o(A)==="top","align-center":o(A)==="center","align-bottom":o(A)==="bottom"}),pe(k,`
          left: ${o(E).x??""}px;
          top: ${o(E).y??""}px;
          width: ${o(E).width??""}px;
          height: ${o(E).height??""}px;
          font-size: ${o(H)??""}px;
          color: ${o(T)??""};
        `),Ee(N,o(D))}),S(M,k)};V(R,M=>{o(D)&&M(U)})}S(u,$)}),S(i,g),Ce(),h()}var cl=F('<div class="temp-zone-button svelte-130i47e"><!></div>');function dl(i,e){Te(e,!0);const t=()=>O(oi,"$builderCameraInfo",a),s=()=>O(Ze,"$builderEditMode",a),n=()=>O(mt,"$isDraggingInBuilder",a),[a,r]=He();let l=te(null),c=null,d=null,h=te(null);function v(f){c&&clearTimeout(c),L(l,f,!0),L(h,t()?.scrollX??null,!0),c=setTimeout(()=>{L(l,null),L(h,null)},2e3)}function w(){o(l)&&(We.emit(Ae.DIALOG_ZONE_CREATE_AT,{worldX:o(l).worldX}),L(l,null),L(h,null),c&&(clearTimeout(c),c=null))}function y(){L(l,null),L(h,null),c&&(clearTimeout(c),c=null)}_s(()=>{d=We.on(Ae.TEMP_ZONE_BUTTON_SHOW,v);const f=We.on(Ae.TEMP_ZONE_BUTTON_HIDE,y);return()=>{d?.unsubscribe(),f.unsubscribe()}}),ra(()=>{c&&clearTimeout(c)}),Xe(()=>{s()!=="dialogs"&&(L(l,null),L(h,null))}),Xe(()=>{const f=t()?.scrollX;o(l)&&o(h)!==null&&f!==void 0&&Math.abs(f-o(h))>10&&(L(l,null),L(h,null),c&&(clearTimeout(c),c=null))});var p=$e(),_=fe(p);{var I=f=>{var b=cl(),m=P(b);oe(m,{variant:"cyan",width:"90px",onclick:w,children:(g,u)=>{var x=le("+ ZONE");S(g,x)},$$slots:{default:!0}}),z(()=>pe(b,`left: ${o(l).screenX??""}px; top: ${o(l).screenY-50}px;${n()?" pointer-events: none;":""}`)),S(f,b)};V(_,f=>{o(l)&&s()==="dialogs"&&f(I)})}S(i,p),Ce(),r()}var hl=F('<div class="item-controls svelte-1is3rex"><div class="controls-row svelte-1is3rex"><!> <!> <!> <!></div></div>');function ul(i,e){Te(e,!0);const t=()=>O(ni,"$selectedItem",h),s=()=>O(In,"$selectedItemScreenPosition",h),n=()=>O(Es,"$selectedItemId",h),a=()=>O(bn,"$itemDepthLayer",h),r=()=>O(tr,"$selectedItemPhysicsEnabled",h),l=()=>O(sr,"$selectedItemFlipX",h),c=()=>O(Ze,"$builderEditMode",h),d=()=>O(mt,"$isDraggingInBuilder",h),[h,v]=He();let w=Z(()=>t()?vr(t().assetKey):!1),y=Z(()=>{const u=s();if(!u)return null;const x=10,E=40,D=o(w)?380:290;let H=u.screenY-u.itemHeight/2-45;const T=x+E;H<T&&(H=u.screenY+u.itemHeight/2+10);const A=window.innerHeight-E-x;H>A&&(H=A);let $=u.screenX;const R=D/2,U=R+x,M=window.innerWidth-R-x;return $<U&&($=U),$>M&&($=M),{x:$,y:H}});function p(){if(!n())return;const u=a()==="behind"?"front":"behind",x=Js(u);ar(),rr(n(),x)}function _(){n()&&or(n(),!r())}function I(){n()&&lr(n(),!l())}function f(){n()&&(Cn(n()),ai())}var b=$e(),m=fe(b);{var g=u=>{var x=hl(),E=P(x),D=P(E);{let R=Z(()=>a()==="behind"?"blue":"orange"),U=Z(()=>r()?"Solid items must be behind player":"Toggle item depth: behind or in front of player");oe(D,{get variant(){return o(R)},get title(){return o(U)},onclick:p,get disabled(){return r()},children:(M,k)=>{var Y=le();z(()=>Ee(Y,a()==="behind"?"Front":"Back")),S(M,Y)},$$slots:{default:!0}})}var H=C(D,2);{let R=Z(()=>l()?"orange":"blue");oe(H,{get variant(){return o(R)},title:"Flip item horizontally",onclick:I,children:(U,M)=>{var k=le("Flip");S(U,k)},$$slots:{default:!0}})}var T=C(H,2);{var A=R=>{{let U=Z(()=>r()?"orange":"blue");oe(R,{get variant(){return o(U)},title:"Toggle physics: item will block player movement",onclick:_,children:(M,k)=>{var Y=le();z(()=>Ee(Y,r()?"Ghost":"Solid")),S(M,Y)},$$slots:{default:!0}})}};V(T,R=>{o(w)&&R(A)})}var $=C(T,2);oe($,{variant:"red",title:"Delete selected item",onclick:f,children:(R,U)=>{var M=le("DEL");S(R,M)},$$slots:{default:!0}}),z(()=>pe(x,`left: ${o(y).x??""}px; top: ${o(y).y??""}px;${d()?" pointer-events: none;":""}`)),S(u,x)};V(m,u=>{c()!=="dialogs"&&n()&&o(y)&&u(g)})}S(i,b),Ce(),v()}var gl=F('<div class="frame-controls svelte-eqt3a9"><div class="controls-row svelte-eqt3a9"><!> <!></div></div>');function fl(i,e){Te(e,!0);const t=()=>O(xn,"$selectedFrameScreenPosition",r),s=()=>O(as,"$selectedFrameId",r),n=()=>O(Ze,"$builderEditMode",r),a=()=>O(mt,"$isDraggingInBuilder",r),[r,l]=He();let c=Z(()=>{const p=t();if(!p)return null;const _=10,I=40,f=190;let b=p.screenY-p.frameHeight/2-45;const m=_+I;b<m&&(b=p.screenY+p.frameHeight/2+10);const g=window.innerHeight-I-_;b>g&&(b=g);let u=p.screenX;const x=f/2,E=x+_,D=window.innerWidth-x-_;return u<E&&(u=E),u>D&&(u=D),{x:u,y:b}});function d(){yn()}function h(){s()&&(li(s()),jt(null))}var v=$e(),w=fe(v);{var y=p=>{var _=gl(),I=P(_),f=P(I);oe(f,{variant:"purple",title:"Edit frame content (or double-click)",onclick:d,children:(m,g)=>{var u=le("EDIT");S(m,u)},$$slots:{default:!0}});var b=C(f,2);oe(b,{variant:"red",title:"Delete selected frame",onclick:h,children:(m,g)=>{var u=le("DEL");S(m,u)},$$slots:{default:!0}}),z(()=>pe(_,`left: ${o(c).x??""}px; top: ${o(c).y??""}px;${a()?" pointer-events: none;":""}`)),S(p,_)};V(w,p=>{n()!=="dialogs"&&s()&&o(c)&&p(y)})}S(i,v),Ce(),l()}var pl=F('<div class="zone-controls svelte-sm01rq"><div class="controls-row svelte-sm01rq"><!> <!> <!></div></div>');function ml(i,e){Te(e,!0);const t=()=>O(En,"$selectedDialogZoneScreenPosition",r),s=()=>O(Ts,"$selectedDialogZoneId",r),n=()=>O(Ze,"$builderEditMode",r),a=()=>O(mt,"$isDraggingInBuilder",r),[r,l]=He();let c=Z(()=>{const _=t();if(!_)return null;const I=10,f=120,b=85;let m=_.screenY;const g=I+f/2,u=window.innerHeight-f/2-I;m<g&&(m=g),m>u&&(m=u);let x=_.screenX;const E=b/2,D=E+I,H=window.innerWidth-E-I;return x<D&&(x=D),x>H&&(x=H),{x,y:m}});function d(){Tn()}function h(){s()&&(Pn(s()),Vt(null))}function v(){Vt(null)}var w=$e(),y=fe(w);{var p=_=>{var I=pl(),f=P(I),b=P(f);oe(b,{variant:"cyan",title:"Edit zone content (or double-click)",onclick:d,children:(u,x)=>{var E=le("EDIT");S(u,E)},$$slots:{default:!0}});var m=C(b,2);oe(m,{variant:"red",title:"Delete selected zone",onclick:h,children:(u,x)=>{var E=le("DEL");S(u,E)},$$slots:{default:!0}});var g=C(m,2);oe(g,{variant:"default",title:"Deselect zone",onclick:v,children:(u,x)=>{var E=le("DONE");S(u,E)},$$slots:{default:!0}}),z(()=>pe(I,`left: ${o(c).x??""}px; top: ${o(c).y??""}px;${a()?" pointer-events: none;":""}`)),S(_,I)};V(y,_=>{n()==="dialogs"&&s()&&o(c)&&_(p)})}S(i,w),Ce(),l()}var vl=F('<div class="social-controls svelte-1v4dckp"><div class="controls-row svelte-1v4dckp"><!> <!></div></div>');function yl(i,e){Te(e,!0);const t=()=>O(_n,"$selectedSocialScreenPosition",r),s=()=>O(rs,"$selectedSocialId",r),n=()=>O(Ze,"$builderEditMode",r),a=()=>O(mt,"$isDraggingInBuilder",r),[r,l]=He();let c=Z(()=>{const p=t();if(!p)return null;const _=10,I=40,f=190;let b=p.screenY-p.socialHeight/2-45;const m=_+I;b<m&&(b=p.screenY+p.socialHeight/2+10);const g=window.innerHeight-I-_;b>g&&(b=g);let u=p.screenX;const x=f/2,E=x+_,D=window.innerWidth-x-_;return u<E&&(u=E),u>D&&(u=D),{x:u,y:b}});function d(){Sn()}function h(){s()&&(ci(s()),qt(null))}var v=$e(),w=fe(v);{var y=p=>{var _=vl(),I=P(_),f=P(I);oe(f,{variant:"pink",title:"Edit social settings (or double-click)",onclick:d,children:(m,g)=>{var u=le("EDIT");S(m,u)},$$slots:{default:!0}});var b=C(f,2);oe(b,{variant:"red",title:"Delete selected social",onclick:h,children:(m,g)=>{var u=le("DEL");S(m,u)},$$slots:{default:!0}}),z(()=>pe(_,`left: ${o(c).x??""}px; top: ${o(c).y??""}px;${a()?" pointer-events: none;":""}`)),S(p,_)};V(w,p=>{n()!=="dialogs"&&s()&&o(c)&&p(y)})}S(i,v),Ce(),l()}var Sl=F('<div class="hstack svelte-8vtf35"><!></div>');function bl(i,e){let t=_e(e,"gap",3,"10px"),s=_e(e,"align",3,"center");var n=Sl(),a=P(n);es(a,()=>e.children??Je),z(()=>pe(n,`gap: ${t()??""}; align-items: ${(s()==="start"?"flex-start":s()==="end"?"flex-end":s())??""};`)),S(i,n)}var wl=F('<div class="vstack svelte-1y4dqnf"><!></div>');function _l(i,e){let t=_e(e,"gap",3,"10px"),s=_e(e,"align",3,"stretch");var n=wl(),a=P(n);es(a,()=>e.children??Je),z(()=>pe(n,`gap: ${t()??""}; align-items: ${(s()==="start"?"flex-start":s()==="end"?"flex-end":s())??""};`)),S(i,n)}var Il=F("<div><!></div>");function Bi(i,e){const t=()=>O(mt,"$isDraggingInBuilder",s),[s,n]=He();let a=_e(e,"padding",3,"10px");var r=Il();let l;var c=P(r);es(c,()=>e.children??Je),z(()=>{l=De(r,1,`fixed fixed--${e.position??""}`,"svelte-vwlo0e",l,{"dragging-in-builder":t()}),pe(r,`--padding: ${a()??""};`)}),S(i,r),n()}var xl=F("<div><!> <!></div>"),El=F("<!> <!>",1),Tl=F("<!> <!> <!> <!>",1),Cl=F("<div><!></div>"),Dl=F("<!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!>",1);function Pl(i,e){Te(e,!0);const t=()=>O(Es,"$selectedItemId",v),s=()=>O(as,"$selectedFrameId",v),n=()=>O(Ts,"$selectedDialogZoneId",v),a=()=>O(rs,"$selectedSocialId",v),r=()=>O(Ze,"$builderEditMode",v),l=()=>O(ys,"$gridSnappingEnabled",v),c=()=>O(Et,"$isItemPaletteOpen",v),d=()=>O(_t,"$isFramePaletteOpen",v),h=()=>O(It,"$isSocialPaletteOpen",v),[v,w]=He(),y=600;let p=te(nt(typeof window<"u"?window.innerWidth<y:!1)),_=Z(()=>o(p)&&(t()!==null||s()!==null||n()!==null||a()!==null));Xe(()=>{function N(){L(p,window.innerWidth<y)}return window.addEventListener("resize",N),()=>window.removeEventListener("resize",N)});function I(){console.log("[BuilderUI] handleSave called, switching to game...");const N=po();console.log("[BuilderUI] switchToGame result:",N)}function f(){Ba()}function b(){We.emit(Ae.DIALOG_ZONE_CREATE)}var m=Dl(),g=fe(m);ul(g,{});var u=C(g,2);fl(u,{});var x=C(u,2);ml(x,{});var E=C(x,2);yl(E,{});var D=C(E,2);{var H=N=>{Co(N,{})},T=N=>{var ie=$e(),ae=fe(ie);{var ce=W=>{zo(W,{})},me=W=>{var j=$e(),se=fe(j);{var q=he=>{Mo(he,{})},de=he=>{var ue=$e(),ve=fe(ue);{var ne=ye=>{Lo(ye,{})};V(ve,ye=>{r()==="socials"&&ye(ne)},!0)}S(he,ue)};V(se,he=>{r()==="frames"?he(q):he(de,!1)},!0)}S(W,j)};V(ae,W=>{r()==="dialogs"?W(ce):W(me,!1)},!0)}S(N,ie)};V(D,N=>{r()==="items"?N(H):N(T,!1)})}var A=C(D,2);el(A,{});var $=C(A,2);rl($,{});var R=C($,2);Wn(R,{});var U=C(R,2);dl(U,{});var M=C(U,2),k=C(M,2);Bi(k,{position:"top-left",children:(N,ie)=>{var ae=xl();let ce;var me=P(ae);oe(me,{variant:"green",width:"100px",onclick:I,children:(j,se)=>{var q=le("SAVE");S(j,q)},$$slots:{default:!0}});var W=C(me,2);{let j=Z(()=>l()?"blue":"orange");oe(W,{get variant(){return o(j)},width:"80px",onclick:f,title:"Toggle grid snapping",children:(se,q)=>{var de=le();z(()=>Ee(de,l()?"FREE":"SNAP")),S(se,de)},$$slots:{default:!0}})}z(()=>ce=De(ae,1,"left-buttons svelte-1vm8op7",null,ce,{"hide-left":o(_)})),S(N,ae)},$$slots:{default:!0}});var Y=C(k,2);Bi(Y,{position:"top-right",children:(N,ie)=>{var ae=Cl();let ce;var me=P(ae);_l(me,{align:"end",children:(W,j)=>{var se=Tl(),q=fe(se);{let ve=Z(()=>r()==="items"&&c()?"orange":"blue");oe(q,{get variant(){return o(ve)},onclick:()=>{r()==="items"?Ga():(Gt("items"),Et.set(!0))},title:"Edit items",children:(ne,ye)=>{var Ie=le("ITEMS");S(ne,Ie)},$$slots:{default:!0}})}var de=C(q,2);{let ve=Z(()=>r()==="frames"&&d()?"orange":"purple");oe(de,{get variant(){return o(ve)},onclick:()=>{r()==="frames"?Na():(Gt("frames"),_t.set(!0))},title:"Edit text frames",children:(ne,ye)=>{var Ie=le("FRAMES");S(ne,Ie)},$$slots:{default:!0}})}var he=C(de,2);{let ve=Z(()=>r()==="socials"&&h()?"orange":"pink");oe(he,{get variant(){return o(ve)},onclick:()=>{r()==="socials"?Ka():(Gt("socials"),It.set(!0))},title:"Edit social icons",children:(ne,ye)=>{var Ie=le("SOCIALS");S(ne,Ie)},$$slots:{default:!0}})}var ue=C(he,2);bl(ue,{children:(ve,ne)=>{var ye=El(),Ie=fe(ye);{var Oe=ze=>{oe(ze,{variant:"cyan",width:"100px",onclick:b,title:"Create new dialog zone at center of view",children:(vt,Bt)=>{var dt=le("+ ZONE");S(vt,dt)},$$slots:{default:!0}})};V(Ie,ze=>{r()==="dialogs"&&ze(Oe)})}var Ue=C(Ie,2);{let ze=Z(()=>r()==="dialogs"?"orange":"cyan");oe(Ue,{get variant(){return o(ze)},onclick:()=>{r()==="dialogs"?Gt("items"):Gt("dialogs")},title:"Edit dialog zones",children:(vt,Bt)=>{var dt=le("DIALOGS");S(vt,dt)},$$slots:{default:!0}})}S(ve,ye)},$$slots:{default:!0}}),S(W,se)},$$slots:{default:!0}}),z(()=>ce=De(ae,1,"right-buttons svelte-1vm8op7",null,ce,{"hide-right":o(_)})),S(N,ae)},$$slots:{default:!0}}),S(i,m),Ce(),w()}var kl=F('<img class="skin-preview-img svelte-crre06"/>'),Ml=F('<canvas width="96" height="96" class="skin-preview svelte-crre06"></canvas>'),Al=F('<button type="button"><div class="skin-preview-container svelte-crre06"><!></div> <span class="skin-name svelte-crre06"> </span></button>'),$l=F('<span class="custom-icon svelte-crre06">👤</span>'),Hl=F('<span class="custom-icon svelte-crre06">✨</span>'),Ll=F('<button class="edit-btn svelte-crre06" type="button">EDIT</button>'),Ol=F('<button class="background-card svelte-crre06" type="button"><div class="preview-container svelte-crre06"><img class="preview-image svelte-crre06"/></div> <span class="background-name svelte-crre06"> </span></button>'),Rl=F('<div class="background-select-screen svelte-crre06"><div class="content svelte-crre06"><h1 class="title svelte-crre06">SELECT CHARACTER</h1> <div class="skins-grid svelte-crre06"><!> <div class="skin-card-wrapper svelte-crre06"><button type="button"><div class="skin-preview-container custom-preview svelte-crre06"><!></div> <span class="skin-name svelte-crre06">CUSTOM</span></button> <!></div></div> <h1 class="title svelte-crre06">SELECT BACKGROUND</h1> <div class="backgrounds-grid svelte-crre06"></div></div></div>');function Fl(i,e){Te(e,!0);const t="custom";function s(){window.location.href="./builder.html"}const n=st,a=Me,r=Qs()!==null,l=localStorage.getItem("useModularPlayer")==="true";let c=te(nt(l&&r?t:xt.getSkinId())),d=nt({}),h=nt({});Xe(()=>{a.forEach(M=>{const k=gs(M),Y=new Image;Y.onload=()=>{h[M.id]=!0},Y.onerror=()=>{h[M.id]=!1,w(M)},Y.src=`./${k}/preview.png`})});function v(M){return`./${gs(M)}/preview.png`}function w(M){const k=d[M.id];if(!k)return;const Y=k.getContext("2d");if(!Y)return;const N=M.frameWidth??48,ie=M.frameHeight??48,ae=gs(M),ce=new Image;ce.src=`./${ae}/idle.png`,ce.onload=()=>{Y.clearRect(0,0,k.width,k.height),Y.imageSmoothingEnabled=!1;const me=k.width/N,W=k.height/ie,j=Math.min(me,W),se=N*j,q=ie*j,de=(k.width-se)/2,he=(k.height-q)/2;Y.drawImage(ce,0,0,N,ie,de,he,se,q)}}function y(M){return`./assets/backgrounds/${M}/preview.png`}function p(M){if(M===t){if(!r){s();return}L(c,t),localStorage.setItem("useModularPlayer","true"),Gs.set(t)}else L(c,M,!0),xt.setSkin(M),localStorage.setItem("useModularPlayer","false"),Gs.set(M)}function _(){s()}function I(M){ns.setBackgroundByIndex(M),ji.set(n[M].name),qi.set(!0),mo()}var f=Rl(),b=P(f),m=C(P(b),2),g=P(m);Ne(g,17,()=>a,Ke,(M,k)=>{var Y=Al();let N;Y.__click=()=>p(o(k).id);var ie=P(Y),ae=P(ie);{var ce=se=>{var q=kl();z(de=>{J(q,"src",de),J(q,"alt",o(k).name)},[()=>v(o(k))]),S(se,q)},me=se=>{var q=Ml();pt(q,(de,he)=>d[he.id]=de,de=>d?.[de.id],()=>[o(k)]),S(se,q)};V(ae,se=>{h[o(k).id]?se(ce):se(me,!1)})}var W=C(ie,2),j=P(W);z(()=>{N=De(Y,1,"skin-card svelte-crre06",null,N,{selected:o(c)===o(k).id}),Ee(j,o(k).name)}),S(M,Y)});var u=C(g,2),x=P(u);let E;x.__click=()=>p(t);var D=P(x),H=P(D);{var T=M=>{var k=$l();S(M,k)},A=M=>{var k=Hl();S(M,k)};V(H,M=>{r?M(T):M(A,!1)})}var $=C(x,2);{var R=M=>{var k=Ll();k.__click=_,S(M,k)};V($,M=>{r&&o(c)===t&&M(R)})}var U=C(m,4);Ne(U,21,()=>n,Ke,(M,k,Y)=>{var N=Ol();N.__click=()=>I(Y);var ie=P(N),ae=P(ie),ce=C(ie,2),me=P(ce);z(W=>{J(ae,"src",W),J(ae,"alt",o(k).name),Ee(me,o(k).name)},[()=>y(o(k).folder)]),S(M,N)}),z(()=>E=De(x,1,"skin-card custom-card svelte-crre06",null,E,{selected:o(c)===t})),S(i,f),Ce()}at(["click"]);var Xl=F("<div> </div>"),Wl=F('<div class="dialog-content svelte-1jd14ss"> </div>'),Yl=F("<div><!> <!></div>");function Zl(i,e){Te(e,!0);const t=()=>O(ba,"$activeDialogText",n),s=()=>O(en,"$playerScreenPosition",n),[n,a]=He();let r=Z(()=>t()?.title&&t()?.content),l=Z(()=>Math.max(10,window.innerHeight-s().y+Zo)),c=Z(()=>window.innerWidth<=Yo),d=Z(()=>o(c)?50:s().x),h=Z(()=>o(c)?"percent":"px");var v=$e(),w=fe(v);{var y=p=>{var _=Yl();let I;var f=P(_);{var b=u=>{var x=Xl();let E;var D=P(x);z(()=>{E=De(x,1,"dialog-title svelte-1jd14ss",null,E,{"has-divider":o(r)}),Ee(D,t().title)}),S(u,x)};V(f,u=>{t().title&&u(b)})}var m=C(f,2);{var g=u=>{var x=Wl(),E=P(x);z(()=>Ee(E,t().content)),S(u,x)};V(m,u=>{t().content&&u(g)})}z(()=>{I=De(_,1,"dialog-bubble svelte-1jd14ss",null,I,{narrow:o(c)}),pe(_,`bottom: ${o(l)??""}px; left: ${o(d)??""}${o(h)??""};`)}),S(p,_)};V(w,p=>{t()&&p(y)})}S(i,v),Ce(),a()}var Bl=F('<div class="game-mask mask-top svelte-ptsgmd"></div> <div class="game-mask mask-bottom svelte-ptsgmd"></div> <div class="game-mask mask-left svelte-ptsgmd"></div> <div class="game-mask mask-right svelte-ptsgmd"></div> <div class="game-frame svelte-ptsgmd"><div class="frame-border frame-top svelte-ptsgmd"></div> <div class="frame-border frame-bottom svelte-ptsgmd"></div> <div class="frame-border frame-left svelte-ptsgmd"></div> <div class="frame-border frame-right svelte-ptsgmd"></div> <div class="frame-corner corner-top-left svelte-ptsgmd"></div> <div class="frame-corner corner-top-right svelte-ptsgmd"></div> <div class="frame-corner corner-bottom-left svelte-ptsgmd"></div> <div class="frame-corner corner-bottom-right svelte-ptsgmd"></div></div>',1);function Gl(i,e){Te(e,!1);const t=()=>O(ya,"$gameFrameColor",n),s=()=>O(sn,"$gameWorldDimensions",n),[n,a]=He(),r=rt(),l=rt(),c=rt(),d=rt(),h=rt(),v=rt(),w=rt();ot(()=>t(),()=>{L(r,t())}),ot(()=>s(),()=>{L(l,s())}),ot(()=>o(l),()=>{L(c,`
    top: ${o(l).offsetY}px;
    left: ${o(l).offsetX}px;
    width: ${o(l).worldWidth}px;
    height: ${o(l).worldHeight}px;
  `)}),ot(()=>o(l),()=>{L(d,o(l).offsetY)}),ot(()=>o(l),()=>{L(h,o(l).offsetX)}),ot(()=>o(l),()=>{L(v,o(l).offsetX+o(l).worldWidth)}),ot(()=>o(l),()=>{L(w,o(l).offsetY+o(l).worldHeight)}),zi();var y=Bl(),p=fe(y),_=C(p,2),I=C(_,2),f=C(I,2),b=C(f,2);z(()=>{pe(p,`height: ${o(d)??""}px; background: ${o(r)??""};`),pe(_,`top: ${o(w)??""}px; background: ${o(r)??""};`),pe(I,`top: ${o(d)??""}px; height: ${o(l),Qt(()=>o(l).worldHeight)??""}px; width: ${o(h)??""}px; background: ${o(r)??""};`),pe(f,`top: ${o(d)??""}px; height: ${o(l),Qt(()=>o(l).worldHeight)??""}px; left: ${o(v)??""}px; background: ${o(r)??""};`),pe(b,`--frame-thickness: 16px; --frame-color: ${o(r)??""}; ${o(c)??""}`)}),S(i,y),Ce(),a()}var Nl=F("<!> <!>",1),zl=F('<div class="touch-controls"><p class="touch-text">Tap and hold<br/>where you want<br/>to move</p></div>'),Kl=F('<div class="desktop-controls"><div class="key-row"><div class="pixel-key">A</div> <div class="pixel-key">W</div> <div class="pixel-key">D</div></div> <p class="or-text">or</p> <div class="key-row"><div class="pixel-key">←</div> <div class="pixel-key">↑</div> <div class="pixel-key">→</div></div></div>'),Ul=F('<div class="loader-overlay"><div class="pixel-loader"></div></div>'),Vl=F('<!> <div class="game-ui-wrapper svelte-13dvmla"><!> <!> <!> <dialog class="pixel-dialog"><h1>CONTROLS</h1> <div class="controls-content"><!></div></dialog> <!></div>',1);function jl(i,e){Te(e,!1);const t=()=>O(Nt,"$showControlsDialog",h),s=()=>O(qs,"$hasPlayerMoved",h),n=()=>O(qi,"$hasSelectedBackground",h),a=()=>O(Sa,"$gameFrameVisible",h),r=()=>O(vn,"$isBuilderMode",h),l=()=>O(ss,"$currentLanguage",h),c=()=>O(Ji,"$isTouchDevice",h),d=()=>O(Ns,"$isLoading",h),[h,v]=He();let w=rt();function y(){const g=Fn.toggleLanguage();ss.set(g)}function p(g){!o(w)?.open||g.target.closest(".pixel-button")||Nt.set(!1)}function _(){const g=go();if(!g){console.error("Cannot enter builder mode: map config not found");return}fo(g)}ot(()=>(o(w),t()),()=>{o(w)&&(t()?o(w).showModal():o(w).close())}),ot(()=>(s(),o(w),Nt),()=>{s()&&o(w)?.open&&Nt.set(!1)}),zi(),ua();var I=$e();Ve("pointerdown",oa,p);var f=fe(I);{var b=g=>{Fl(g,{})},m=g=>{var u=Vl(),x=fe(u);{var E=W=>{Gl(W,{})};V(x,W=>{a()&&!r()&&W(E)})}var D=C(x,2),H=P(D);{var T=W=>{Pl(W,{})},A=W=>{var j=Nl(),se=fe(j);Zl(se,{});var q=C(se,2);Wn(q,{}),S(W,j)};V(H,W=>{r()?W(T):W(A,!1)})}var $=C(H,2);{var R=W=>{oe(W,{position:"top-left",variant:"green",width:"120px",onclick:_,title:"Toggle Builder Mode",children:(j,se)=>{var q=le("BUILD");S(j,q)},$$slots:{default:!0}})};V($,W=>{r()||W(R)})}var U=C($,2);{var M=W=>{oe(W,{position:"top-right",variant:"default",width:"100px",onclick:y,title:"Toggle Language (L)",children:(j,se)=>{var q=le();z(de=>Ee(q,de),[()=>(l(),Qt(()=>l().toUpperCase()))]),S(j,q)},$$slots:{default:!0}})};V(U,W=>{r()||W(M)})}var k=C(U,2),Y=C(P(k),2),N=P(Y);{var ie=W=>{var j=zl();S(W,j)},ae=W=>{var j=Kl();S(W,j)};V(N,W=>{c()?W(ie):W(ae,!1)})}pt(k,W=>L(w,W),()=>o(w));var ce=C(k,2);{var me=W=>{var j=Ul();S(W,j)};V(ce,W=>{d()&&W(me)})}S(g,u)};V(f,g=>{n()?g(m,!1):g(b)})}S(i,I),Ce(),v()}Aa();const Yn=document.getElementById("game-ui");if(!Yn)throw new Error("game-ui element not found!");la(jl,{target:Yn});ss.set(Fn.getLanguage());Gs.set(xt.getSkinId());ji.set(ns.getCurrentConfig().name);const ql={type:G.AUTO,width:800,height:600,parent:"game-container",backgroundColor:"#000000",pixelArt:!0,roundPixels:!0,scale:{mode:G.Scale.RESIZE,autoCenter:G.Scale.CENTER_BOTH},input:{activePointers:3},physics:{default:"arcade",arcade:{gravity:{y:1e3,x:0},debug:!1}},audio:{noAudio:!0},scene:[]},Ds=new G.Game(ql);Ds.scene.add(Qe.GAME,Qr);Ds.scene.add(Qe.BUILDER,co);uo(Ds);const Jl=Ds.device.input.touch;Ji.set(Jl);const Ql=performance.getEntriesByType("navigation")[0]&&performance.getEntriesByType("navigation")[0].type==="reload",ec=sessionStorage.getItem("hasSeenControlsHint");(!ec||Ql)&&(sessionStorage.setItem("hasSeenControlsHint","true"),Nt.set(!0));
//# sourceMappingURL=main-DF9tMG6r.js.map
