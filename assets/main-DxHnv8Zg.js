import{c as xn,u as Dn,a as De,r as Xs,b as Ft,d as En,g as o,e as Tn,f as kn,t as Mn,h as An,n as Fe,m as Je,s as $,i as $n,M as Rt,j as Wt,P as G,p as Ai,k as $i,l as js,o as Hn,q as qe,v as ve,w as me,x as se,y as Ze,z as X,A as T,B as M,C as K,D as Et,E as U,F as Ae,G as ae,H as Pe,I as ne,J as Xe,K as S,L as ye,N as Ce,O as ge,Q as zt,R as j,S as Ss,T as je,U as Ve,V as cs,W as he,X as ue,Y as On,Z as Rn,_ as Qe,$ as Hi,a0 as Ln,a1 as Nn}from"./PixelButton-CA55Tbh3.js";import"./phaser-DFK5Ua9d.js";function Xn(n=!1){const e=xn,t=e.l.u;if(!t)return;let s=()=>Tn(e.s);if(n){let i=0,a={};const r=kn(()=>{let l=!1;const c=e.s;for(const d in c)c[d]!==a[d]&&(a[d]=c[d],l=!0);return l&&i++,i});s=()=>o(r)}t.b.length&&Dn(()=>{li(e,s),Xs(t.b)}),De(()=>{const i=Ft(()=>t.m.map(En));return()=>{for(const a of i)typeof a=="function"&&a()}}),t.a.length&&De(()=>{li(e,s),Xs(t.a)})}function li(n,e){if(n.l.s)for(const t of n.l.s)o(t);e()}let Ws=Symbol();function N(n,e,t){const s=t[e]??={store:null,source:Je(void 0),unsubscribe:Fe};if(s.store!==n&&!(Ws in t))if(s.unsubscribe(),s.store=n??null,n==null)s.source.v=void 0,s.unsubscribe=Fe;else{var i=!0;s.unsubscribe=Vs(n,a=>{i?s.source.v=a:$(s.source,a)}),i=!1}return n&&Ws in t?Ge(n):o(s.source)}function xe(){const n={};function e(){Mn(()=>{for(var t in n)n[t].unsubscribe();An(n,Ws,{enumerable:!1,value:!0})})}return[n,e]}function Vs(n,e,t){if(n==null)return e(void 0),t&&t(void 0),Fe;const s=Ft(()=>n.subscribe(e,t));return s.unsubscribe?()=>s.unsubscribe():s}const wt=[];function Wn(n,e){return{subscribe:J(n,e).subscribe}}function J(n,e=Fe){let t=null;const s=new Set;function i(l){if($n(n,l)&&(n=l,t)){const c=!wt.length;for(const d of s)d[1](),wt.push(d,n);if(c){for(let d=0;d<wt.length;d+=2)wt[d][0](wt[d+1]);wt.length=0}}}function a(l){i(l(n))}function r(l,c=Fe){const d=[l,c];return s.add(d),s.size===1&&(t=e(i,a)||Fe),l(n),()=>{s.delete(d),s.size===0&&t&&(t(),t=null)}}return{set:i,update:a,subscribe:r}}function Te(n,e,t){const s=!Array.isArray(n),i=s?[n]:n;if(!i.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const a=e.length<2;return Wn(t,(r,l)=>{let c=!1;const d=[];let h=0,v=Fe;const m=()=>{if(h)return;v();const x=e(s?d[0]:d,r,l);a?r(x):v=typeof x=="function"?x:Fe},P=i.map((x,C)=>Vs(x,b=>{d[C]=b,h&=~(1<<C),c&&m()},()=>{h|=1<<C}));return c=!0,m(),function(){Xs(P),v(),c=!1}})}function Ge(n){let e;return Vs(n,t=>e=t)(),e}const Yn=J("#2a1a0a"),Bn=J(!0),Oi=J({x:0,y:0});function Zn(n,e){Oi.set({x:n,y:e})}const Gn=J({scrollX:0,scrollY:0,zoom:1});function Fn(n,e,t=1){Gn.set({scrollX:n,scrollY:e,zoom:t})}const Ri=J({worldWidth:640,worldHeight:640,offsetX:0,offsetY:0});function zn(n,e,t,s,i=1){const a=n*i,r=e*i,l=Math.min(a,t),c=Math.min(r,s),d=Math.max(0,(t-l)/2),h=Math.max(0,(s-c)/2);Ri.set({worldWidth:l,worldHeight:c,offsetX:d,offsetY:h})}const Ys=J(!1);function Kn(){Ys.set(!0),setTimeout(()=>Ys.set(!1),150)}const qs=J(1);function Lt(n){qs.set(n)}const Li=J(null);function Un(n,e,t){Li.set({scrollX:n,scrollY:e,zoom:t})}function jn(){let n=null;return Li.update(e=>(n=e,null)),n}const Ni=J({scrollX:0,scrollY:0,viewWidth:0,viewHeight:0,worldWidth:0,worldHeight:0,zoom:1,playerX:0,playerY:0});function Vn(n){Ni.update(e=>({...e,...n}))}const qn={isActive:!1,config:null,selectedItemId:null,editMode:"items",selectedDialogZoneId:null,selectedSocialId:null,isPlayerSelected:!1},q=J(qn),Jn=Te(q,n=>n.isActive),Xi=Te(q,n=>n.config),Oe=Te(q,n=>n.editMode),ds=J(!0);function Qn(){ds.update(n=>!n)}const ct=J(!1);function xt(n){ct.set(n)}const Bs=J(!1);function ks(n){Bs.set(n)}function ea(n){q.set({isActive:!0,config:{...n,placedItems:n.placedItems||[],dialogZones:n.dialogZones||[],placedSocials:n.placedSocials||[]},selectedItemId:null,editMode:"items",selectedDialogZoneId:null,selectedSocialId:null,isPlayerSelected:!1}),qs.set(1)}function ta(){q.update(n=>{const e=n.config?{...n.config,dialogZones:(n.config.dialogZones||[]).filter(t=>t.texts.some(s=>s.title.trim()!==""||s.content.trim()!==""))}:n.config;return{...n,isActive:!1,selectedItemId:null,config:e}}),qs.set(1)}function sa(){return Ge(q).config}function Nt(n){q.update(e=>({...e,editMode:n,selectedItemId:null,selectedDialogZoneId:null}))}const Me={BACKGROUND_LAYER_START:-99,GROUND_REFERENCE:-1,DYNAMIC_BASE:100,DYNAMIC_MAX:999,ITEMS_BEHIND:5,PLAYER:10,ITEMS_FRONT:15,FOREGROUND_LAYER_START:1e3,SELECTION_GRAPHICS:1999,GRID_OVERLAY:2e3};function ws(n,e){const t=Math.max(0,Math.min(1,n/e)),s=Me.DYNAMIC_MAX-Me.DYNAMIC_BASE;return Math.round(Me.DYNAMIC_BASE+t*s)}function Wi(n){return n==="behind"?Me.ITEMS_BEHIND:Me.ITEMS_FRONT}const ia=[{code:"cs",label:"CZ"},{code:"en",label:"EN"}],Yi="cs",Kt=J("cs"),Zs=J("succubus"),Bi=J("Forest"),Zi=J(!1),Gs=J(!1),Xt=J(!1),Gi=J(!1),Js=J(!1),rt=J(!1),nt=J(!1),ot=J(!1),qt=J(!1),Jt=J(!1),_s=J(!1);function na(){rt.update(n=>!n)}function aa(){nt.update(n=>!n)}function Fi(){ot.update(n=>!n)}function zi(){qt.set(!0)}function ra(){qt.set(!1)}function Ki(){Jt.set(!0)}function oa(){Jt.set(!1)}function Ui(){_s.set(!0)}function ci(){_s.set(!1)}const Tt=Te(q,n=>n.selectedItemId),Qs=Te(q,n=>!n.selectedItemId||!n.config?.placedItems?null:n.config.placedItems.find(e=>e.id===n.selectedItemId)??null),la=Te(Qs,n=>n?.physicsEnabled??!1),ca=Te(Qs,n=>n?.flipX??!1),ji=J(null);function Ms(n){ji.set(n)}function da(n){q.update(e=>{if(!e.config)return e;const t=e.config.placedItems||[];return{...e,config:{...e.config,placedItems:[...t,n]}}})}function hs(n,e){q.update(t=>!t.config||!t.config.placedItems?t:{...t,config:{...t.config,placedItems:t.config.placedItems.map(s=>s.id===n?{...s,...e}:s)}})}function ha(n){q.update(e=>!e.config||!e.config.placedItems?e:{...e,config:{...e.config,placedItems:e.config.placedItems.filter(t=>t.id!==n)},selectedItemId:e.selectedItemId===n?null:e.selectedItemId})}function bs(n){qt.set(!1),q.update(e=>({...e,selectedItemId:n,isPlayerSelected:n?!1:e.isPlayerSelected}))}function ua(n,e){e?hs(n,{physicsEnabled:e,depth:Wi("behind")}):hs(n,{physicsEnabled:e})}function ga(n,e){hs(n,{flipX:e})}const Ut=Te(q,n=>n.selectedSocialId),fa=Te(q,n=>n.config?.placedSocials||[]),pa=Te(q,n=>!n.selectedSocialId||!n.config?.placedSocials?null:n.config.placedSocials.find(e=>e.id===n.selectedSocialId)??null),Vi=J(null);function As(n){Vi.set(n)}function ma(n){q.update(e=>{if(!e.config)return e;const t=e.config.placedSocials||[];return{...e,config:{...e.config,placedSocials:[...t,n]}}})}function rs(n,e){q.update(t=>!t.config||!t.config.placedSocials?t:{...t,config:{...t.config,placedSocials:t.config.placedSocials.map(s=>s.id===n?{...s,...e}:s)}})}function qi(n){q.update(e=>!e.config||!e.config.placedSocials?e:{...e,config:{...e.config,placedSocials:e.config.placedSocials.filter(t=>t.id!==n)},selectedSocialId:e.selectedSocialId===n?null:e.selectedSocialId})}function Yt(n){Jt.set(!1),q.update(e=>({...e,selectedSocialId:n,isPlayerSelected:n?!1:e.isPlayerSelected,selectedItemId:n?null:e.selectedItemId}))}const Is=Te(q,n=>n.selectedDialogZoneId),ei=Te(q,n=>n.config?.dialogZones||[]),Ji=J(null);function es(n){Ji.set(n)}function va(n){q.update(e=>{if(!e.config)return e;const t=e.config.dialogZones||[];return{...e,config:{...e.config,dialogZones:[...t,n]}}})}function bt(n,e){q.update(t=>!t.config||!t.config.dialogZones?t:{...t,config:{...t.config,dialogZones:t.config.dialogZones.map(s=>s.id===n?{...s,...e}:s)}})}function Qi(n){q.update(e=>!e.config||!e.config.dialogZones?e:{...e,config:{...e.config,dialogZones:e.config.dialogZones.filter(t=>t.id!==n)},selectedDialogZoneId:e.selectedDialogZoneId===n?null:e.selectedDialogZoneId})}function Bt(n){q.update(e=>({...e,selectedDialogZoneId:n}))}function ya(n,e,t){q.update(s=>!s.config||!s.config.dialogZones?s:{...s,config:{...s.config,dialogZones:s.config.dialogZones.map(i=>{if(i.id!==n)return i;const a=i.texts.findIndex(l=>l.language===e);let r;return a>=0?r=i.texts.map((l,c)=>c===a?{...l,...t}:l):r=[...i.texts,{language:e,title:"",content:"",...t}],{...i,texts:r}})}})}const di=Te(q,n=>n.isPlayerSelected);function hi(n,e){q.update(t=>t.config?{...t,config:{...t.config,playerStartX:n,playerStartY:e}}:t)}function Sa(n){q.update(e=>({...e,isPlayerSelected:n,selectedItemId:null}))}function At(){q.update(n=>({...n,selectedItemId:null,selectedDialogZoneId:null,selectedSocialId:null,isPlayerSelected:!1}))}const ti=Te(q,n=>!n.selectedItemId||!n.config?.placedNPCs?null:n.config.placedNPCs.find(e=>e.id===n.selectedItemId)??null),wa=Te(ti,n=>n?.flipX??!1),en=J(null);function ts(n){en.set(n)}function _a(n){q.update(e=>{if(!e.config)return e;const t=e.config.placedNPCs||[];return{...e,config:{...e.config,placedNPCs:[...t,n]},isDirty:!0}})}function si(n,e){q.update(t=>{if(!t.config?.placedNPCs)return t;const s=t.config.placedNPCs.map(i=>i.id===n?{...i,...e}:i);return{...t,config:{...t.config,placedNPCs:s},isDirty:!0}})}function ba(n,e,t){q.update(s=>{if(!s.config?.placedNPCs)return s;const i=s.config.placedNPCs.map(a=>{if(a.id!==n)return a;const r=a.dialog||[],l=r.findIndex(d=>d.language===e);let c;return l>=0?(c=[...r],c[l]={...c[l],...t}):c=[...r,{language:e,title:"",content:t.content??""}],{...a,dialog:c}});return{...s,config:{...s.config,placedNPCs:i},isDirty:!0}})}function Ia(n,e){si(n,{flipX:e})}function tn(n){q.update(e=>{if(!e.config?.placedNPCs)return e;const t=e.config.placedNPCs.filter(i=>i.id!==n),s=e.selectedItemId===n?null:e.selectedItemId;return{...e,selectedItemId:s,config:{...e.config,placedNPCs:t},isDirty:!0}})}let sn=!1,It=!1;function ss(n){sn=n}function ui(){return sn}function St(){return It}function $s(n){if(!n||n.tagName==="CANVAS")return!1;if(n.closest("[data-ui]"))return!0;const e=document.getElementById("game-ui");return!!(e&&e.contains(n)||n.closest("button"))}function Ca(){document.addEventListener("pointerdown",n=>{It=$s(n.target)},{capture:!0}),document.addEventListener("pointermove",n=>{n.buttons>0||(It=$s(n.target))},{capture:!0}),document.addEventListener("pointerup",()=>{setTimeout(()=>{It=!1},10)},{capture:!0}),document.addEventListener("touchstart",n=>{It=$s(n.target)},{capture:!0,passive:!0}),document.addEventListener("touchend",()=>{setTimeout(()=>{It=!1},10)},{capture:!0,passive:!0})}function Hs(){const n=document.activeElement;if(!n)return!1;const e=n.tagName.toUpperCase();return e==="INPUT"||e==="TEXTAREA"||n.getAttribute("contenteditable")==="true"}function vt(n,e,t){const s=(n-t.worldView.x)*t.zoom,i=(e-t.worldView.y)*t.zoom;return{screenX:s,screenY:i}}function Pa(n,e,t){const s=n/t.zoom+t.worldView.x,i=e/t.zoom+t.worldView.y;return{worldX:s,worldY:i}}const nn={campfire:{frameWidth:32,frameHeight:32,frameRate:10,repeat:-1,endFrame:39}},ii=[{key:"campfire",name:"Campfire",path:"assets/items/campfire.png",scale:5,group:"shared",category:"props"},{key:"stones_0",name:"Stones 0",path:"assets/items/stones_0.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_1",name:"Stones 1",path:"assets/items/stones_1.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_3",name:"Stones 3",path:"assets/items/stones_3.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_4",name:"Stones 4",path:"assets/items/stones_4.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"barell",name:"Barrel",path:"assets/items/barell.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"box",name:"Box",path:"assets/items/box.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"chair",name:"Chair",path:"assets/items/chair.png",scale:4,group:"shared",category:"furniture"},{key:"stool",name:"Stool",path:"assets/items/stool.png",scale:4,group:"shared",category:"furniture"},{key:"table_small",name:"Table Small",path:"assets/items/table_small.png",scale:4,group:"shared",category:"furniture"},{key:"table_full",name:"Table Full",path:"assets/items/table_full.png",scale:4,group:"forest_summer",category:"furniture"},{key:"kettle",name:"Kettle",path:"assets/items/kettle.png",scale:4,group:"shared",category:"props"},{key:"log_axe",name:"Log with Axe",path:"assets/items/log_axe.png",scale:4,group:"shared",category:"props"},{key:"log_chisel",name:"Log with Chisel",path:"assets/items/log_chisel.png",scale:4,group:"shared",category:"props"},{key:"apple_basket",name:"Apple Basket",path:"assets/items/apple_basket.png",scale:4,group:"shared",category:"props"},{key:"apples",name:"Apples",path:"assets/items/apples.png",scale:4,group:"forest_summer",category:"props"},{key:"pumpkin",name:"Pumpkin",path:"assets/items/pumpkin.png",scale:4,group:"forest_summer",category:"nature"},{key:"pumpkin_helloween",name:"Pumpkin Halloween",path:"assets/items/pumpkin_helloween.png",scale:4,group:"forest_summer",category:"props"},{key:"scarecrow",name:"Scarecrow",path:"assets/items/scarecrow.png",scale:4,group:"forest_summer",category:"props"},{key:"sign_skogen",name:"Sign Skogen",path:"assets/items/sign_skogen.png",scale:4,group:"forest_shared",category:"props"},{key:"statue",name:"Statue",path:"assets/items/statue.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"wall",name:"Wall",path:"assets/items/wall.png",scale:4,group:"forest_summer",category:"structures"},{key:"hanger",name:"Hanger",path:"assets/items/hanger.png",scale:4,group:"forest_summer",category:"furniture"},{key:"cauldron_campfire",name:"Cauldron Campfire",path:"assets/items/cauldron_campfire.png",scale:4,group:"shared",category:"props"},{key:"ore_copper",name:"Ore Copper",path:"assets/items/ore_copper.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_dia",name:"Ore Diamond",path:"assets/items/ore_dia.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_gold",name:"Ore Gold",path:"assets/items/ore_gold.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_tin",name:"Ore Tin",path:"assets/items/ore_tin.png",scale:4,group:"cave_dark",category:"nature"},{key:"tent_large",name:"Tent Large",path:"assets/items/tent_large.png",scale:4,group:"forest_summer",category:"structures"},{key:"tent",name:"Tent Small",path:"assets/items/tent.png",scale:4,group:"forest_summer",category:"structures"},{key:"bush_0",name:"Bush 0",path:"assets/items/bush_0.png",scale:4,group:"forest_summer",category:"nature"},{key:"bush_1",name:"Bush 1",path:"assets/items/bush_1.png",scale:4,group:"forest_summer",category:"nature"},{key:"bush_2",name:"Bush 2",path:"assets/items/bush_2.png",scale:4,group:"forest_summer",category:"nature"},{key:"grass",name:"Grass",path:"assets/items/grass.png",scale:4,group:"forest_summer",category:"nature"},{key:"grass_0",name:"Grass 0",path:"assets/items/grass_0.png",scale:4,group:"forest_summer",category:"nature"},{key:"tree_picea",name:"Tree Picea",path:"assets/items/tree_picea.png",scale:4,group:"forest_summer",category:"nature"},{key:"tree_pinus",name:"Tree Pinus",path:"assets/items/tree_pinus.png",scale:4,group:"forest_summer",category:"nature"},{key:"grave_0",name:"Grave 0",path:"assets/items/grave_0.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_1",name:"Grave 1",path:"assets/items/grave_1.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_2",name:"Grave 2",path:"assets/items/grave_2.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_3",name:"Grave 3",path:"assets/items/grave_3.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_4",name:"Grave 4",path:"assets/items/grave_4.png",scale:4,group:"forest_shared",category:"props"},{key:"icebush_0",name:"Ice Bush 0",path:"assets/items/icebush_0.png",scale:4,group:"forest_birch",category:"nature"},{key:"icebush_1",name:"Ice Bush 1",path:"assets/items/icebush_1.png",scale:4,group:"forest_birch",category:"nature"},{key:"icebush_2",name:"Ice Bush 2",path:"assets/items/icebush_2.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_0",name:"Ice Stones 0",path:"assets/items/icestones_0.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_1",name:"Ice Stones 1",path:"assets/items/icestones_1.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_2",name:"Ice Stones 2",path:"assets/items/icestones_2.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_3",name:"Ice Stones 3",path:"assets/items/icestones_3.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_4",name:"Ice Stones 4",path:"assets/items/icestones_4.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_5",name:"Ice Stones 5",path:"assets/items/icestones_5.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_6",name:"Ice Stones 6",path:"assets/items/icestones_6.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_7",name:"Ice Stones 7",path:"assets/items/icestones_7.png",scale:4,group:"forest_birch",category:"nature"},{key:"snow_pile",name:"Snow Pile",path:"assets/items/snow_pile.png",scale:4,group:"forest_birch",category:"nature"}];function an(n){return ii.find(e=>e.key===n)}function xa(n){return an(n)?.scale||1}function Fs(n){return n in nn}function zs(n){return nn[n]}function Da(n){return an(n)?.supportsPhysics??!1}class gi{scene;groundY;constructor(e,t){this.scene=e,this.groundY=t}static preloadAssets(e){ii.forEach(t=>{if(Fs(t.key)){const s=zs(t.key);s&&e.load.spritesheet(t.key,t.path,{frameWidth:s.frameWidth,frameHeight:s.frameHeight})}else e.load.image(t.key,t.path)})}createSprite(e){const{id:t,assetKey:s,x:i,scale:a=1,depth:r=5,yOffset:l=0,flipX:c=!1}=e,d=this.groundY+l,h=this.scene.add.sprite(i,d,s);if(h.setScale(a),h.setDepth(r),h.setFlipX(c),h.setData("itemId",t),Fs(s)){const v=`${s}_anim`,m=zs(s);m&&(this.scene.anims.exists(v)||this.scene.anims.create({key:v,frames:this.scene.anims.generateFrameNumbers(s,{start:m.startFrame??0,end:m.endFrame}),frameRate:m.frameRate??8,repeat:m.repeat??-1}),h.play(v))}return h}updatePosition(e,t,s){e.x=t,e.y=this.groundY+s}updateScale(e,t){e.setScale(t)}updateDepth(e,t){e.setDepth(t)}applyUpdates(e,t){t.x!==void 0&&(e.x=t.x),t.yOffset!==void 0&&(e.y=this.groundY+t.yOffset),t.scale!==void 0&&e.setScale(t.scale),t.depth!==void 0&&e.setDepth(t.depth),t.flipX!==void 0&&e.setFlipX(t.flipX)}worldYToOffset(e){return e-this.groundY}getGroundY(){return this.groundY}}function Ct(n){return parseInt(n.replace("#",""),16)}const mt={BLUE:"#4a90e2",GREEN:"#27ae60",PURPLE:"#9b59b6",TEAL:"#1abc9c",PINK:"#e91e8f"},Cs={ITEM:{hex:Ct(mt.BLUE)},FRAME:{hex:Ct(mt.PURPLE)},SOCIAL:{css:mt.PINK,hex:Ct(mt.PINK)},DIALOG_ZONE:{hex:Ct(mt.TEAL)},PLAYER:{hex:Ct(mt.GREEN)}},rn=Ct(mt.BLUE),on=240,Ea=48;function os(n){const e=`assets/skins/static/${n.folder}`;return n.variant?`${e}/${n.variant}`:e}function Zt(n){if(n.scale!==void 0)return n.scale;const e=n.frameHeight??Ea;return on/e}const Ie=[{id:"succubus",name:"SUCCUBUS",folder:"succubus",variant:"basic",character:"human",frameWidth:156,frameHeight:72,facingLeft:!0,frameRates:{idle:8,run:12}}],ln="succubus";class Ta{currentSkinId=ln;constructor(){this.loadFromStorage()}loadFromStorage(){const e=localStorage.getItem("playerSkin");e&&this.isValidSkinId(e)&&(this.currentSkinId=e)}isValidSkinId(e){return Ie.some(t=>t.id===e)}setSkin(e){this.isValidSkinId(e)&&(this.currentSkinId=e,localStorage.setItem("playerSkin",e))}getSkinId(){return this.currentSkinId}getSkinConfig(){return Ie.find(e=>e.id===this.currentSkinId)||Ie[0]}getSkinById(e){return Ie.find(t=>t.id===e)}getAllSkins(){return Ie}getAnimationPrefix(){const e=this.getSkinConfig();return`${e.character}-${e.id}`}}const yt=new Ta,Gt={DEPTH:Me.PLAYER},ka={HALF_HEIGHT:on/2},lt={FRAME_WIDTH:Rt.WIDTH,FRAME_HEIGHT:Rt.HEIGHT,WIDTH:Rt.WIDTH*Wt,HEIGHT:Rt.HEIGHT*Wt,HALF_HEIGHT:Rt.HEIGHT*Wt/2},Ye=40;function cn(n,e=Ye){return n-e}function kt(n,e=Ye){return cn(n,e)-ka.HALF_HEIGHT}function Ma(n,e,t=Ye){const s=kt(e,t);return n>s}function jt(n,e=Ye){return cn(n,e)-lt.HALF_HEIGHT}function Aa(n,e,t=Ye){const s=jt(e,t);return n>s}const Os={WIDTH:.33,HEIGHT:.25,OFFSET_Y:.75},fi={WIDTH:.4,HEIGHT:.3},Ks={WIDTH:.6};function $a(n,e){const t=Math.round(n*Os.WIDTH),s=Math.round(e*Os.HEIGHT),i=Math.round((n-t)/2),a=Math.round(e*Os.OFFSET_Y);return{width:t,height:s,offsetX:i,offsetY:a}}function Ha(){const n=Math.round(lt.WIDTH*fi.WIDTH),e=Math.round(lt.HEIGHT*fi.HEIGHT),t=-n/2,s=lt.HEIGHT/2-e;return{width:n,height:e,offsetX:t,offsetY:s}}const Pt=50,Oa=4871528,Ra=.4,La=1,dn=Me.GRID_OVERLAY,Rs=16711680,Na=2,Xa=.6,Wa=.1,Ya=1,Ba=.2,pi=50,Za=50,Ga=rn,Fa=()=>{try{return!1}catch{return!1}},mi=Fa(),vi=65280,za=.1,Ka=1,Ua=.3,ja=.2,Va=2,qa=.8;class hn{lastClickTime=0;lastClickId=null;threshold;constructor(e=300){this.threshold=e}check(e){const t=Date.now(),s=this.lastClickId===e&&t-this.lastClickTime<this.threshold;return this.lastClickTime=t,this.lastClickId=e,s}reset(){this.lastClickTime=0,this.lastClickId=null}}function is(n,e){return Math.round(n/e)*e}function Ps(n){const{sprite:e,scene:t,callbacks:s={},constraints:i,useGridSnapping:a=!0,cursor:r="grab",hitArea:l}=n;let c=!1,d=0,h=0,v=0;if(l){if(e.setInteractive(l,G.Geom.Rectangle.Contains),e.input){const u=e.input;u.cursor=r,u.useHandCursor=!0}}else e.setInteractive({useHandCursor:!0,cursor:r});const m=(u,g)=>{const I=e.getBounds(),f=5;return u>=I.x-f&&u<=I.x+I.width+f&&g>=I.y-f&&g<=I.y+I.height+f},P=()=>{const u=t.data.get("lastTapTime");if(!u||u===v||Date.now()-u>100)return;v=u;const g=t.data.get("lastTapWorldX"),I=t.data.get("lastTapWorldY");m(g,I)&&s.onSelect?.()},x=u=>{if(u.wasTouch||Ge(Bs)||St()||c||s.onDoubleClick?.())return;const g=s.isSelected?.()??!1;s.onSelect?.(),g&&(c=!0,t.data.set("isDraggingItem",!0),xt(!0),d=e.x-u.worldX,h=e.y-u.worldY,s.onDragStart?.())},C=u=>{if(u.wasTouch){const f=t.data.get("touchDragStarted");if(!c&&f&&s.isSelected?.()){const E=t.data.get("touchStartWorldX"),W=t.data.get("touchStartWorldY"),w=e.getBounds(),k=10;E>=w.x-k&&E<=w.x+w.width+k&&W>=w.y-k&&W<=w.y+w.height+k&&(c=!0,t.data.set("isDraggingItem",!0),t.data.set("touchDragStarted",!1),xt(!0),d=e.x-E,h=e.y-W,s.onDragStart?.())}if(c){let _=u.worldX+d,E=u.worldY+h;a&&Ge(ds)&&(_=is(_,Pt),E=is(E,Pt)),i&&(i.minX!==void 0&&(_=Math.max(_,i.minX)),i.maxX!==void 0&&(_=Math.min(_,i.maxX)),i.minY!==void 0&&(E=Math.max(E,i.minY)),i.maxY!==void 0&&(E=Math.min(E,i.maxY))),e.setPosition(_,E),s.onDrag?.(_,E)}return}if(!c)return;if(Ge(Bs)){p();return}if(!u.isDown){p();return}let g=u.worldX+d,I=u.worldY+h;a&&Ge(ds)&&(g=is(g,Pt),I=is(I,Pt)),i&&(i.minX!==void 0&&(g=Math.max(g,i.minX)),i.maxX!==void 0&&(g=Math.min(g,i.maxX)),i.minY!==void 0&&(I=Math.max(I,i.minY)),i.maxY!==void 0&&(I=Math.min(I,i.maxY))),e.setPosition(g,I),s.onDrag?.(g,I)},b=()=>{c&&p()},p=()=>{c=!1,t.data.set("isDraggingItem",!1),xt(!1),s.onDragEnd?.(e.x,e.y)};e.on("pointerdown",x),t.input.on("pointermove",C),t.input.on("pointerup",b);const y=()=>{P()};return t.events.on("update",y),()=>{e.off("pointerdown",x),t.input.off("pointermove",C),t.input.off("pointerup",b),t.events.off("update",y)}}class Ja{scene;groundY;worldWidth;worldHeight;isDragging=!1;callbacks;cleanupFunctions=new Map;constructor(e,t,s,i,a={}){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=i,this.callbacks=a}getIsDragging(){return this.isDragging}makeInteractive(e,t){const s=Ps({sprite:e,scene:this.scene,cursor:"pointer",constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{bs(t),this.callbacks.onSelect?.(t)},isSelected:()=>Ge(Tt)===t,onDragStart:()=>{this.isDragging=!0,e.setTint(rn),this.callbacks.onDragStart?.(t)},onDrag:(i,a)=>{this.callbacks.onDrag?.(t,i,a)},onDragEnd:(i,a)=>{e.clearTint(),this.isDragging=!1;const r=Math.round(i),c=Math.round(a)-this.groundY;hs(t,{x:r,yOffset:c}),this.callbacks.onDragEnd?.(t,r,c)}}});this.cleanupFunctions.set(t,s)}removeInteractivity(e){if(!e||!e.scene)return;const t=e.getData("itemId");t&&this.cleanupFunctions.has(t)&&(this.cleanupFunctions.get(t)(),this.cleanupFunctions.delete(t)),e.removeInteractive()}destroy(){this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear()}}const at={ITEM:"itemId",SOCIAL:"socialId",NPC:"npcId",PLAYER:"isPlayer",ZONE:"zoneId"},Qa={[at.ITEM]:"selectedItemId",[at.SOCIAL]:"selectedSocialId",[at.NPC]:"selectedItemId",[at.PLAYER]:"isPlayerSelected"};function un(n){return typeof n.getData=="function"}function er(n){return un(n)?n.type==="Rectangle"?!!n.getData(at.ZONE):Object.values(at).some(e=>e===at.ZONE?!1:!!n.getData(e)):!1}function tr(n,e){if(!un(n))return!1;for(const[t,s]of Object.entries(Qa)){const i=n.getData(t);if(i)if(t===at.PLAYER){const a=e.data.get(s),r=e.data.get("playerSprite");if(a&&n===r)return!0}else{const a=e.data.get(s);if(i===a)return!0}}return!1}function sr(n,e){const t=n.input.hitTestPointer(e);for(const s of t)if(tr(s,n))return!0;return!1}const ir={lineWidth:3,lineColor:Cs.ITEM.hex,lineAlpha:1,padding:5};class nr{scene;graphics;style;selectedId=null;constructor(e,t={}){this.scene=e,this.style={...ir,...t},this.graphics=e.add.graphics(),this.graphics.setDepth(Me.SELECTION_GRAPHICS)}setSelectedId(e){this.selectedId=e}getSelectedId(){return this.selectedId}updateVisuals(e){if(this.graphics.clear(),!e||!this.selectedId)return;const t=e.getBounds(),{lineWidth:s,lineColor:i,lineAlpha:a,padding:r}=this.style;this.graphics.lineStyle(s,i,a),this.graphics.strokeRect(t.x-r,t.y-r,t.width+r*2,t.height+r*2)}clearVisuals(){this.graphics.clear(),this.selectedId=null}setupBackgroundDeselect(e){this.scene.input.on("pointerdown",t=>{if(St()||e())return;this.scene.input.hitTestPointer(t).find(a=>er(a))||(At(),this.clearVisuals())})}destroy(){this.graphics?.destroy()}}class us{scene;items=new Map;isBuilderMode=!1;physicsGroup=null;renderer;dragController;selectionManager;constructor(e,t,s,i,a=!1){this.scene=e,this.isBuilderMode=a,this.renderer=new gi(e,t),a||(this.physicsGroup=e.physics.add.staticGroup()),this.isBuilderMode&&(this.dragController=new Ja(e,t,s,i,{onSelect:()=>this.updateSelectionVisuals(),onDrag:()=>this.updateSelectionVisuals()}),this.selectionManager=new nr(e))}static preloadAssets(e){gi.preloadAssets(e)}createItems(e){e.forEach(t=>{this.createItem(t)})}createItem(e){const t=this.renderer.createSprite(e),s={sprite:t,data:e};if(!this.isBuilderMode&&e.physicsEnabled&&this.physicsGroup){const i=this.createPhysicsBody(t,e);s.physicsBody=i}this.items.set(e.id,s),this.isBuilderMode&&this.dragController&&this.dragController.makeInteractive(t,e.id)}createPhysicsBody(e,t){const s=e.getBounds(),i=s.width*.5,a=s.height*.8,r=e.x,l=e.y,c=this.scene.add.rectangle(r,l,i,a);return c.setVisible(!1),this.physicsGroup.add(c),c.setData("itemId",t.id),c}updateSelectionVisuals(){if(!this.selectionManager)return;const e=this.scene.data.get("selectedItemId");if(this.selectionManager.setSelectedId(e),!e){this.selectionManager.clearVisuals(),Ms(null);return}const t=this.items.get(e);if(this.selectionManager.updateVisuals(t?.sprite??null),t?.sprite){const s=this.scene.cameras.main,i=t.sprite.getBounds(),{screenX:a,screenY:r}=vt(i.centerX,i.centerY,s),l=i.height*s.zoom;Ms({screenX:a,screenY:r,itemHeight:l})}else Ms(null)}updateItem(e,t){const s=this.items.get(e);s&&(this.renderer.applyUpdates(s.sprite,t),s.data={...s.data,...t})}removeItem(e){const t=this.items.get(e);t&&(this.dragController&&this.dragController.removeInteractivity(t.sprite),t.physicsBody&&t.physicsBody.destroy(),t.sprite.destroy(),this.items.delete(e))}removeAllItems(){this.items.forEach(e=>{!e.sprite||!e.sprite.scene||(this.dragController&&this.dragController.removeInteractivity(e.sprite),e.physicsBody&&e.physicsBody.destroy(),e.sprite.destroy())}),this.items.clear()}getItem(e){return this.items.get(e)?.data}getAllItems(){return Array.from(this.items.values()).map(e=>e.data)}getPhysicsGroup(){return this.physicsGroup}setInteractiveEnabled(e){!this.isBuilderMode||!this.dragController||(this.items.forEach(({sprite:t,data:s})=>{e?(this.dragController.makeInteractive(t,s.id),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectionManager&&this.selectionManager.clearVisuals())}updateAutoDepth(e){this.items.forEach(({sprite:t,data:s})=>{if(s.physicsEnabled){t.setDepth(Me.DYNAMIC_BASE);return}const a=t.getBounds().bottom,r=ws(a,e);t.setDepth(r)})}destroy(){this.removeAllItems(),this.selectionManager?.destroy()}setupBackgroundDeselect(){!this.isBuilderMode||!this.selectionManager||this.selectionManager.setupBackgroundDeselect(()=>this.dragController?.getIsDragging()??!1)}}const ni=[{id:"beggar",name:"Beggar",path:"assets/npcs/humans/beggar.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"crusader",name:"Crusader",path:"assets/npcs/humans/crusader.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"dealer",name:"Dealer",path:"assets/npcs/humans/dealer.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"female_wizard",name:"Female Wizard",path:"assets/npcs/humans/female_wizard.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:9,frameRate:8}}},{id:"lady_christmas",name:"Lady Christmas",path:"assets/npcs/humans/lady_christmas.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"lady_drunk",name:"Lady Drunk",path:"assets/npcs/humans/lady_drunk.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:5,frameRate:8}}},{id:"lovers",name:"Lovers",path:"assets/npcs/humans/lovers.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:6,frameRate:8}}},{id:"mage",name:"Mage",path:"assets/npcs/humans/mage.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"medieval_servant",name:"Medieval Servant",path:"assets/npcs/humans/medieval_servant.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"town_crier",name:"Town Crier",path:"assets/npcs/humans/town_crier.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:8,frameRate:8}}},{id:"wounded_knight",name:"Wounded Knight",path:"assets/npcs/humans/wounded_knight.png",category:"humans",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}},{id:"demon_old",name:"Demon",path:"assets/npcs/fantasy/demon_old.png",category:"fantasy",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:6,frameRate:8}}},{id:"fairy",name:"Fairy",path:"assets/npcs/fantasy/fairy.png",category:"fantasy",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:7,frameRate:8}}},{id:"snowman_couple",name:"Snowman Couple",path:"assets/npcs/fantasy/snowman_couple.png",category:"fantasy",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:9,frameRate:8}}},{id:"toad",name:"Toad",path:"assets/npcs/fantasy/toad.png",category:"fantasy",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:11,frameRate:8}}},{id:"toad_wizard",name:"Toad Wizard",path:"assets/npcs/fantasy/toad_wizard.png",category:"fantasy",frameWidth:64,frameHeight:64,scale:4,topOffset:28,animations:{idle:{startFrame:0,endFrame:4,frameRate:8}}}];function gs(n){return ni.find(e=>e.id===n)}class ai extends G.Physics.Arcade.Sprite{id;npcId;dialogData;_triggerRadius;selectionIndicator;radiusIndicator;_isSelected=!1;isBuilderMode;_topOffset=0;static DEFAULT_TRIGGER_RADIUS=200;constructor(e,t,s=!1){const i=gs(t.npcId);if(!i)throw new Error(`NPC definition not found for id: ${t.npcId}`);super(e,t.x,t.y,t.npcId),this.id=t.id,this.npcId=t.npcId,this.dialogData=t.dialog,this._triggerRadius=t.triggerRadius??ai.DEFAULT_TRIGGER_RADIUS,this.isBuilderMode=s,e.add.existing(this),e.physics.add.existing(this);const a=t.scale??i.scale;this.setScale(a),this.setFlipX(t.flipX??!1),this._topOffset=(i.topOffset??0)*a,this.setImmovable(!0),this.body.setAllowGravity(!1);const r=i.topOffset??0,l=i.frameHeight-r,c=i.frameWidth*.5,d=l*.9;this.body?.setSize(c,d),this.body?.setOffset((i.frameWidth-c)/2,r+(l-d));const h=i.frameWidth*.5,v=l*.9,m=(i.frameWidth-h)/2,P=r+(l-v);this.setInteractive({hitArea:new G.Geom.Rectangle(m,P,h,v),hitAreaCallback:G.Geom.Rectangle.Contains,cursor:"pointer"}),this.isBuilderMode||(this.setupAnimations(i),this.play(`${this.npcId}_idle`))}setupAnimations(e){if(!e.animations)return;const t=`${this.npcId}_idle`;this.scene.anims.exists(t)||this.scene.anims.create({key:t,frames:this.scene.anims.generateFrameNumbers(this.npcId,{start:e.animations.idle.startFrame,end:e.animations.idle.endFrame}),frameRate:e.animations.idle.frameRate,repeat:-1})}updateDialog(e){this.dialogData=e}getDialogData(){return this.dialogData}getContentHeight(){return this.displayHeight-this._topOffset}get topOffset(){return this._topOffset}get triggerRadius(){return this._triggerRadius}setTriggerRadius(e){this._triggerRadius=e,this.radiusIndicator&&this.radiusIndicator.setRadius(e)}setFlipped(e){this.setFlipX(e)}getHitboxDimensions(){const e=gs(this.npcId);if(!e)return{width:this.displayWidth,height:this.displayHeight,offsetY:0};const t=this.scaleX,s=e.topOffset??0,i=e.frameHeight-s,a=e.frameWidth*.5*t,r=i*.9*t,l=s*t/2;return{width:a,height:r,offsetY:l}}get isSelected(){return this._isSelected}setSelected(e){if(this.scene?.add)if(this._isSelected=e,e){const t=this.getHitboxDimensions();this.selectionIndicator||(this.selectionIndicator=this.scene.add.rectangle(this.x,this.y+t.offsetY,t.width+8,t.height+8,15105570,0),this.selectionIndicator.setStrokeStyle(3,15105570,1),this.selectionIndicator.setDepth(this.depth-1)),this.radiusIndicator||(this.radiusIndicator=this.scene.add.circle(this.x,this.y,this._triggerRadius,15105570,.15),this.radiusIndicator.setStrokeStyle(2,15105570,.5),this.radiusIndicator.setDepth(this.depth-2))}else this.selectionIndicator&&(this.selectionIndicator.destroy(),this.selectionIndicator=void 0),this.radiusIndicator&&(this.radiusIndicator.destroy(),this.radiusIndicator=void 0)}updateSelectionIndicator(){if(this.selectionIndicator&&this._isSelected){const e=this.getHitboxDimensions();this.selectionIndicator.setPosition(this.x,this.y+e.offsetY),this.selectionIndicator.setSize(e.width+8,e.height+8)}this.radiusIndicator&&this._isSelected&&(this.radiusIndicator.setPosition(this.x,this.y),this.radiusIndicator.setRadius(this._triggerRadius))}destroy(e){this.selectionIndicator&&(this.selectionIndicator.destroy(),this.selectionIndicator=void 0),this.radiusIndicator&&(this.radiusIndicator.destroy(),this.radiusIndicator=void 0),super.destroy(e)}}class ar{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set);const s=this.listeners.get(e);return s.add(t),{unsubscribe:()=>{s.delete(t),s.size===0&&this.listeners.delete(e)}}}once(e,t){const s=this.on(e,i=>{s.unsubscribe(),t(i)});return s}emit(e,t){const s=this.listeners.get(e);s&&s.forEach(i=>{try{i(t)}catch(a){console.error(`[EventBus] Error in listener for "${e}":`,a)}})}off(e){this.listeners.delete(e)}clear(){this.listeners.clear()}listenerCount(e){return this.listeners.get(e)?.size??0}}const Ee=new ar,be={ASSET_DROPPED:"asset:dropped",SOCIAL_DROPPED:"social:dropped",MINIMAP_NAVIGATE:"minimap:navigate",DIALOG_ZONE_CREATE:"dialogZone:create",DIALOG_ZONE_CREATE_AT:"dialogZone:createAt",NPC_DROPPED:"npc:dropped",NPC_SELECTED:"npc:selected",TEMP_ZONE_BUTTON_SHOW:"tempZoneButton:show",TEMP_ZONE_BUTTON_HIDE:"tempZoneButton:hide"};class fs{scene;npcs=new Map;isBuilderMode;groundY;worldWidth;worldHeight;selectedNPCId=null;unsubscribers=[];cleanupFunctions=new Map;doubleClickDetector=new hn;constructor(e,t,s,i,a=!1){if(this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=i,this.isBuilderMode=a,a){const r=Tt.subscribe(l=>{this.handleSelectionChange(l)});this.unsubscribers.push(r)}}static preloadAssets(e){ni.forEach(t=>{e.load.spritesheet(t.id,t.path,{frameWidth:t.frameWidth,frameHeight:t.frameHeight})})}createNPCs(e){e.forEach(t=>this.createNPC(t))}createNPC(e){const t=new ai(this.scene,e,this.isBuilderMode);this.npcs.set(e.id,t),this.isBuilderMode&&this.makeInteractive(t)}makeInteractive(e){e.setData("npcId",e.id);const t=Ps({sprite:e,scene:this.scene,cursor:"pointer",constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{bs(e.id),Ee.emit(be.NPC_SELECTED,e.id)},isSelected:()=>Ge(Tt)===e.id,onDoubleClick:()=>this.doubleClickDetector.check(e.id)?(zi(),!0):!1,onDragStart:()=>{},onDrag:(s,i)=>{e.updateSelectionIndicator()},onDragEnd:(s,i)=>{si(e.id,{x:Math.round(s),y:Math.round(i)})}}});this.cleanupFunctions.set(e.id,t)}removeNPC(e){const t=this.npcs.get(e);if(t){const s=this.cleanupFunctions.get(e);s&&(s(),this.cleanupFunctions.delete(e)),t.destroy(),this.npcs.delete(e)}}updateNPC(e,t){const s=this.npcs.get(e);s&&(t.x!==void 0&&(s.x=t.x),t.y!==void 0&&(s.y=t.y),t.flipX!==void 0&&s.setFlipped(t.flipX),t.dialog!==void 0&&s.updateDialog(t.dialog),t.scale!==void 0&&s.setScale(t.scale),t.triggerRadius!==void 0&&s.setTriggerRadius(t.triggerRadius))}getNPC(e){return this.npcs.get(e)}getAllNPCs(){return Array.from(this.npcs.values())}handleSelectionChange(e){if(this.selectedNPCId&&this.selectedNPCId!==e){const s=this.npcs.get(this.selectedNPCId);s&&s.setSelected(!1)}const t=e?this.npcs.get(e):null;t?(t.setSelected(!0),this.selectedNPCId=e,this.updateNPCScreenPosition(t)):(this.selectedNPCId=null,ts(null))}updateNPCScreenPosition(e){const t=this.scene.cameras.main,{screenX:s,screenY:i}=vt(e.x,e.y,t),a=e.displayHeight*t.zoom;ts({screenX:s,screenY:i,npcHeight:a})}update(){if(this.selectedNPCId){const e=this.npcs.get(this.selectedNPCId);e&&(e.updateSelectionIndicator(),this.updateNPCScreenPosition(e))}}setInteractiveEnabled(e){if(this.isBuilderMode&&(this.npcs.forEach(t=>{e?(t.setInteractive({cursor:"pointer"}),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectedNPCId)){const t=this.npcs.get(this.selectedNPCId);t&&t.setSelected(!1),this.selectedNPCId=null,ts(null)}}updateAutoDepth(e){this.npcs.forEach(t=>{const s=t.y+t.displayHeight/2,i=ws(s,e);t.setDepth(i)})}destroy(){this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear(),this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.npcs.forEach(e=>e.destroy()),this.npcs.clear(),ts(null)}}function rr(){return`social_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const Vt={S:{label:"Small",scale:1.5},M:{label:"Medium",scale:2},L:{label:"Large",scale:2.5}},Dt=Vt.M.scale;function or(n){return Vt[n].scale}function lr(n){return n<=Vt.S.scale?"S":n>=Vt.L.scale?"L":"M"}const ps=[{key:"discord",name:"Discord",path:"assets/socials/Discord.png",scale:1},{key:"facebook",name:"Facebook",path:"assets/socials/Facebook.png",scale:1},{key:"instagram",name:"Instagram",path:"assets/socials/Instagram.png",scale:1},{key:"kofi",name:"Ko-Fi",path:"assets/socials/Ko Fi.png",scale:1},{key:"linkedin",name:"LinkedIn",path:"assets/socials/LinkedIn.png",scale:1},{key:"patreon",name:"Patreon",path:"assets/socials/Patreon.png",scale:1},{key:"tiktok",name:"TikTok",path:"assets/socials/TikTok.png",scale:1},{key:"twitch",name:"Twitch",path:"assets/socials/Twitch.png",scale:1},{key:"twitter",name:"Twitter",path:"assets/socials/Twitter.png",scale:1},{key:"whatsapp",name:"WhatsApp",path:"assets/socials/Whatsapp.png",scale:1},{key:"youtube",name:"YouTube",path:"assets/socials/Youtube.png",scale:1}];function cr(){return`zone_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const Us=["#e74c3c","#e67e22","#f1c40f","#2ecc71","#1abc9c","#3498db","#9b59b6","#e91e8f"];function dr(){return Us[Math.floor(Math.random()*Us.length)]}function hr(n,e=300){return{id:cr(),x:n,width:e,color:dr(),texts:[{language:"cs",title:"",content:""}]}}function ur(n,e){const t=n.texts.find(s=>s.language===e);return t||n.texts[0]||null}const gn=J(null),fn=Te([gn,Kt],([n,e])=>n?ur(n,e):null);function Ls(n){gn.set(n)}const ri=J(null),gr=Te([ri,Kt],([n,e])=>n?n.texts.find(s=>s.language===e)??n.texts[0]??null:null);function ns(n){ri.set(n)}class yi{scene;socials=new Map;constructor(e){this.scene=e}static preloadAssets(e){ps.forEach(t=>{e.load.image(`social_${t.key}`,t.path)})}createSocials(e){e.forEach(t=>{this.createSocial(t)})}createSocial(e){const t=`social_${e.socialKey}`;if(!this.scene.textures.exists(t)){console.warn(`[GameSocialManager] Social texture not found: ${t}`);return}const s=e.scale??Dt,i=e.depth??Me.ITEMS_FRONT,a=this.scene.add.sprite(e.x,e.y,t);a.setScale(s),a.setDepth(i),a.setOrigin(.5,.5),this.socials.set(e.id,a),e.url&&this.makeClickable(a,e)}makeClickable(e,t){const s=t.scale??Dt;e.setInteractive({useHandCursor:!0}),e.on("pointerover",()=>{e.setScale(s*1.1)}),e.on("pointerout",()=>{e.setScale(s)}),e.on("pointerdown",()=>{t.url&&(Kn(),window.open(t.url,"_blank","noopener,noreferrer"))})}destroy(){this.socials.forEach(e=>{e.destroy()}),this.socials.clear()}}const We={GAME:"GameScene",BUILDER:"BuilderScene"};class fr{scene;currentSkinId;constructor(e,t=ln){this.scene=e,this.currentSkinId=t}createAll(){console.log("PlayerAnimations.createAll() is deprecated - animations created by skinLoader")}getSkinId(){return this.currentSkinId}setSkinId(e){this.currentSkinId=e}getAnimationKey(e){return`${this.currentSkinId}-${e}`}play(e,t){const s=this.getAnimationKey(t);if(e.anims.currentAnim?.key!==s){if(!this.scene.anims.exists(s)){if(t==="jump"||t==="fall"){const i=this.getAnimationKey("idle");if(this.scene.anims.exists(i)){e.play(i);return}}console.warn(`[PlayerAnimations] Animation not found: ${s}`);return}e.play(s)}}handleSkinChange(e,t){const s=this.currentSkinId;this.currentSkinId=t;const i=e.anims.currentAnim?.key;if(i){const a=i.replace(`${s}-`,""),r=`${t}-${a}`;if(this.scene.anims.exists(r))e.play(r);else{const l=`${t}-idle`;this.scene.anims.exists(l)&&e.play(l)}}}}const pt={THRESHOLD_X:20,LANGUAGE_BUTTON:{width:120,height:60},SKIN_BUTTON:{width:120,height:60,yOffset:60}},ms={SPEED:280,JUMP_SPEED:-600};class pn{scene;getPlayerPosition;keyLeft;keyRight;keyUp;keySpace;keyA;keyD;keyW;touchLeft=!1;touchRight=!1;touchJump=!1;touchHandlers;constructor(e){this.scene=e.scene,this.getPlayerPosition=e.getPlayerPosition,this.setupKeyboardControls(),this.setupTouchControls()}setupKeyboardControls(){this.scene.input.keyboard&&(this.keyLeft=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.LEFT,!1),this.keyRight=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.RIGHT,!1),this.keyUp=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.UP,!1),this.keySpace=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.SPACE,!1),this.keyA=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.A,!1),this.keyD=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.D,!1),this.keyW=this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.W,!1))}setupTouchControls(){const e=this.scene,t=r=>{if(Ge(Ys)){this.touchLeft=!1,this.touchRight=!1,this.touchJump=!1;return}const l=r.x,c=r.y,d=e.scale.width;if(l>d-pt.LANGUAGE_BUTTON.width&&c<pt.LANGUAGE_BUTTON.height||l>d-pt.SKIN_BUTTON.width&&c>=pt.SKIN_BUTTON.yOffset&&c<pt.SKIN_BUTTON.yOffset+pt.SKIN_BUTTON.height)return;const h=e.cameras.main,v=this.getPlayerPosition(),m=v.x-h.scrollX,P=v.y-h.scrollY,x=l-m,C=c-P;x<-20?(this.touchLeft=!0,this.touchRight=!1):x>pt.THRESHOLD_X?(this.touchRight=!0,this.touchLeft=!1):(this.touchLeft=!1,this.touchRight=!1),C<-150?this.touchJump=!0:this.touchJump=!1},s=r=>{St()||t(r)},i=r=>{St()||r.isDown&&t(r)},a=()=>{this.touchLeft=!1,this.touchRight=!1,this.touchJump=!1};e.input.on("pointerdown",s),e.input.on("pointermove",i),e.input.on("pointerup",a),this.touchHandlers={pointerdown:s,pointermove:i,pointerup:a}}getInputState(){const e=this.keyA?.isDown||this.keyLeft?.isDown||this.touchLeft||!1,t=this.keyD?.isDown||this.keyRight?.isDown||this.touchRight||!1,s=this.keySpace?.isDown||this.keyUp?.isDown||this.keyW?.isDown||this.touchJump||!1;return{left:e,right:t,jump:s}}hasAnyInput(){const e=this.getInputState();return e.left||e.right||e.jump}destroy(){this.touchHandlers&&(this.scene.input.off("pointerdown",this.touchHandlers.pointerdown),this.scene.input.off("pointermove",this.touchHandlers.pointermove),this.scene.input.off("pointerup",this.touchHandlers.pointerup),this.touchHandlers=void 0)}}class Si extends G.GameObjects.Container{character=null;selection;animState="idle";hasNotifiedMovement=!1;hasReceivedInput=!1;currentFacing="right";inputController;constructor(e,t,s,i){super(e,t,s),this.selection=i,e.add.existing(this),e.physics.add.existing(this);const a=this.body;if(a){a.setCollideWorldBounds(!0),a.setBounce(0);const r=Ha();a.setSize(r.width,r.height),a.setOffset(r.offsetX,r.offsetY)}this.inputController=new pn({scene:e,getPlayerPosition:()=>({x:this.x,y:this.y})}),this.setDepth(Gt.DEPTH)}getPosition(){return{x:this.x,y:this.y}}setPlayerPosition(e,t){this.x=e,this.y=t}getGroundY(e,t){return jt(e,t)}getPlayerType(){return"modular"}getHitBounds(){const e=lt.WIDTH,t=lt.HEIGHT;return{x:this.x-e/2,y:this.y-t/2,width:e,height:t}}setFacing(e){this.currentFacing!==e&&(this.currentFacing=e,this.character?.setFacing(e))}setTint(e){this.character?.setTint(e)}clearTint(){this.character?.clearTint()}setAlpha(e){return this.character?.setAlpha(e),this}getGameObject(){return this}static async preloadCharacter(e,t){return Ai(e,t)}buildCharacter(){this.character&&this.character.destroy(),this.character=new $i(this.scene,0,0,this.selection,{animated:!0,animation:"idle",facing:"right",scale:Wt}),this.add(this.character),this.currentFacing="right"}playAnimation(e){this.character?.playAnimation(e)}update(){const e=this.inputController.getInputState(),t=this.body;if(t)switch(this.inputController.hasAnyInput()&&!this.hasReceivedInput&&(this.hasReceivedInput=!0),this.hasReceivedInput&&this.inputController.hasAnyInput()&&!this.hasNotifiedMovement&&(this.hasNotifiedMovement=!0,Js.set(!0)),e.left?(t.setVelocityX(-280),this.setFacing("left")):e.right?(t.setVelocityX(ms.SPEED),this.setFacing("right")):t.setVelocityX(0),e.jump&&t.blocked.down&&t.setVelocityY(ms.JUMP_SPEED),t.blocked.down?e.left||e.right?this.animState="running":this.animState="idle":t.velocity.y<0?this.animState="jumping":this.animState="falling",this.animState){case"idle":this.playAnimation("idle");break;case"running":this.playAnimation("run");break;case"jumping":this.playAnimation("jump");break;case"falling":this.playAnimation("fall");break}}destroy(e){this.inputController.destroy(),this.character&&(this.character.destroy(),this.character=null),super.destroy(e)}}class pr extends G.Physics.Arcade.Sprite{animations;inputController;animState="idle";hasNotifiedMovement=!1;hasReceivedInput=!1;currentSkin;constructor(e,t,s){const i=yt.getSkinId();super(e,t,s,`${i}-idle`),e.add.existing(this),e.physics.add.existing(this),this.animations=new fr(e,i),this.inputController=new pn({scene:e,getPlayerPosition:()=>({x:this.x,y:this.y})}),this.setCollideWorldBounds(!0),this.setBounce(0),this.currentSkin=Ie.find(d=>d.id===i)??Ie[0];const a=Zt(this.currentSkin),r=this.currentSkin.frameWidth??48,l=this.currentSkin.frameHeight??48,c=$a(r,l);this.setSize(c.width,c.height),this.setOffset(c.offsetX,c.offsetY),this.setScale(a),this.setDepth(Gt.DEPTH),this.animations.play(this,"idle")}getPosition(){return{x:this.x,y:this.y}}setPlayerPosition(e,t){this.x=e,this.y=t}getGroundY(e,t){return kt(e,t)}getPlayerType(){return"static"}getHitBounds(){const e=Zt(this.currentSkin),t=(this.currentSkin.frameWidth??48)*e,s=(this.currentSkin.frameHeight??48)*e,i=t*Ks.WIDTH,a=(t-i)/2,r=this.originX??.5,l=this.originY??.5,c=this.x-t*r,d=this.y-s*l;return{x:c+a,y:d,width:i,height:s}}setFacing(e){const t=this.currentSkin.facingLeft??!1;e==="left"?this.setFlipX(!t):this.setFlipX(t)}playAnimation(e){(e==="idle"||e==="run"||e==="jump"||e==="fall")&&this.animations.play(this,e)}setTint(e){return super.setTint(e)}clearTint(){return super.clearTint()}setAlpha(e){return super.setAlpha(e)}getGameObject(){return this}changeSkin(e){this.currentSkin=Ie.find(d=>d.id===e)??Ie[0];const t=Zt(this.currentSkin),s=this.currentSkin.frameWidth??48,i=this.currentSkin.frameHeight??48,a=Math.round(s*.33),r=Math.round(i*.25),l=Math.round((s-a)/2),c=Math.round(i*.75);this.setSize(a,r),this.setOffset(l,c),this.setScale(t),this.animations.handleSkinChange(this,e)}update(){const e=this.inputController.getInputState();this.inputController.hasAnyInput()&&!this.hasReceivedInput&&(this.hasReceivedInput=!0),this.hasReceivedInput&&this.inputController.hasAnyInput()&&!this.hasNotifiedMovement&&(this.hasNotifiedMovement=!0,Js.set(!0));const t=this.currentSkin.facingLeft??!1;switch(e.left?(this.setVelocityX(-280),this.setFlipX(!t)):e.right?(this.setVelocityX(ms.SPEED),this.setFlipX(t)):this.setVelocityX(0),e.jump&&this.body?.blocked.down&&this.setVelocityY(ms.JUMP_SPEED),this.body?.blocked.down?e.left||e.right?this.animState="running":this.animState="idle":this.body.velocity.y<0?this.animState="jumping":this.animState="falling",this.animState){case"idle":this.playAnimation("idle");break;case"running":this.playAnimation("run");break;case"jumping":this.playAnimation("jump");break;case"falling":this.playAnimation("fall");break}}destroy(e){this.inputController.destroy(),super.destroy(e)}}const mr=48,vr=48;function mn(n){Ie.forEach(e=>{const t=e.frameWidth??mr,s=e.frameHeight??vr,i=os(e);n.load.spritesheet(`${e.id}-idle`,`${i}/idle.png`,{frameWidth:t,frameHeight:s}),n.load.spritesheet(`${e.id}-run`,`${i}/run.png`,{frameWidth:t,frameHeight:s}),n.load.spritesheet(`${e.id}-jump`,`${i}/jump.png`,{frameWidth:t,frameHeight:s}),n.load.spritesheet(`${e.id}-fall`,`${i}/fall.png`,{frameWidth:t,frameHeight:s})})}function yr(n,e){const t=e.id;n.anims.exists(`${t}-idle`)&&n.anims.remove(`${t}-idle`),n.anims.exists(`${t}-run`)&&n.anims.remove(`${t}-run`),n.anims.exists(`${t}-jump`)&&n.anims.remove(`${t}-jump`),n.anims.exists(`${t}-fall`)&&n.anims.remove(`${t}-fall`);const s=n.textures.get(`${t}-idle`),i=n.textures.get(`${t}-run`),a=n.textures.get(`${t}-jump`),r=n.textures.get(`${t}-fall`),l=s.frameTotal-1,c=i.frameTotal-1,d=a.key!=="__MISSING"?a.frameTotal-1:0,h=r.key!=="__MISSING"?r.frameTotal-1:0,v=e.frameRates?.idle??6,m=e.frameRates?.run??12,P=e.frameRates?.jump??10,x=e.frameRates?.fall??10;n.anims.create({key:`${t}-idle`,frames:n.anims.generateFrameNumbers(`${t}-idle`,{start:0,end:l-1}),frameRate:v,repeat:-1}),n.anims.create({key:`${t}-run`,frames:n.anims.generateFrameNumbers(`${t}-run`,{start:0,end:c-1}),frameRate:m,repeat:-1}),d>0&&n.anims.create({key:`${t}-jump`,frames:n.anims.generateFrameNumbers(`${t}-jump`,{start:0,end:d-1}),frameRate:P,repeat:-1}),h>0&&n.anims.create({key:`${t}-fall`,frames:n.anims.generateFrameNumbers(`${t}-fall`,{start:0,end:h-1}),frameRate:x,repeat:-1})}function vn(n){Ie.forEach(e=>{yr(n,e)})}const _t={HEIGHT:Ye,VISUAL:{COLOR:9139029,ALPHA:.3},PHYSICS:{COLOR:0,ALPHA:0}},Mt={getGroundY(n,e=Ye){return n-e},createVisualGround(n,e){const t=e.height??_t.HEIGHT,s=Mt.getGroundY(e.worldHeight,t),i=n.add.rectangle(0,s,e.worldWidth,t,e.color??_t.VISUAL.COLOR,e.alpha??_t.VISUAL.ALPHA);return i.setOrigin(0,0),i.setDepth(e.depth??Me.GROUND_REFERENCE),{ground:i,groundY:s}},createPhysicsGround(n,e){const t=e.height??_t.HEIGHT,s=Mt.getGroundY(e.worldHeight,t),i=n.add.rectangle(0,s,e.worldWidth,t,e.color??_t.PHYSICS.COLOR,e.alpha??_t.PHYSICS.ALPHA);return i.setOrigin(0,0),n.physics.add.existing(i,!0),{ground:i,groundY:s}},addPlayerCollision(n,e,t){return n.physics.add.collider(e,t)}};class Sr{scene;player=null;useModularPlayer=!1;savedCharacterSelection=null;constructor(e){this.scene=e}init(){const e=localStorage.getItem("useModularPlayer");this.savedCharacterSelection=js(),this.useModularPlayer=e==="true"&&this.savedCharacterSelection!==null}preload(){this.useModularPlayer||mn(this.scene)}async loadAssets(){this.useModularPlayer||vn(this.scene),this.useModularPlayer&&this.savedCharacterSelection&&await Si.preloadCharacter(this.scene,this.savedCharacterSelection)}createPlayer(e,t,s){if(this.useModularPlayer&&this.savedCharacterSelection){const i=jt(e.worldHeight,s),a=Math.min(e.playerStartY,i),r=new Si(this.scene,e.playerStartX,a,this.savedCharacterSelection);r.buildCharacter(),this.player=r,Mt.addPlayerCollision(this.scene,r,t)}else{const i=kt(e.worldHeight,s),a=Math.min(e.playerStartY,i),r=new pr(this.scene,e.playerStartX,a);this.player=r,Mt.addPlayerCollision(this.scene,r,t)}return this.player}getPlayer(){return this.player}isModular(){return this.useModularPlayer}}async function wi(){const n=await fetch("./config/map.json");if(!n.ok)throw new Error(`Failed to load map config: ${n.status}`);const e=await n.json();if(!e.worldWidth||!e.worldHeight)throw new Error("Invalid map config structure");return e}const ls={generateId(){return`item_${Date.now()}_${Math.random().toString(36).substr(2,9)}`},create(n){const{assetKey:e,x:t,yOffset:s=0,depthLayer:i="behind",scale:a}=n;return{id:ls.generateId(),assetKey:e,x:Math.round(t),y:0,scale:a??xa(e),depth:Wi(i),yOffset:Math.round(s)}},createAtWorldPosition(n,e,t,s,i="behind"){return ls.create({assetKey:n,x:e,yOffset:t-s,depthLayer:i})},clone(n,e=50){return{...n,id:ls.generateId(),x:n.x+e}}},Ue=[{name:"FOREST SUMMER",folder:"forest_summer",scrollFactors:[.9,.95,.975,1,1.05],foregroundLayers:1,groundHeight:90,itemGroups:["shared","forest_summer","forest_shared"]},{name:"FOREST BIRCH",folder:"forest_birch",scrollFactors:[.9,.95,.975,1,1.05],foregroundLayers:1,groundHeight:30,itemGroups:["shared","forest_birch","forest_shared"]},{name:"CAVE DARK",folder:"cave_dark",scrollFactors:[.85,.875,.9,.925,.95,.975,1.05],foregroundLayers:2,groundHeight:20,itemGroups:["shared","cave_dark"]}];class wr{currentIndex=0;constructor(){const e=localStorage.getItem("background");if(e){const t=Ue.findIndex(s=>s.folder===e);t!==-1&&(this.currentIndex=t)}}getBackground(){return Ue[this.currentIndex].folder}getCurrentConfig(){return Ue[this.currentIndex]}setBackground(e){const t=Ue.findIndex(s=>s.folder===e);t!==-1&&(this.currentIndex=t,localStorage.setItem("background",e))}toggleBackground(){this.currentIndex=(this.currentIndex+1)%Ue.length;const e=Ue[this.currentIndex];return localStorage.setItem("background",e.folder),e}getAllBackgrounds(){return Ue}setBackgroundByIndex(e){e>=0&&e<Ue.length&&(this.currentIndex=e,localStorage.setItem("background",Ue[e].folder))}getCurrentIndex(){return this.currentIndex}}const ze=new wr;function yn(n,e){return new Promise(t=>{for(let s=0;s<e.scrollFactors.length;s++){const i=s+1;n.load.image(`bg${i}-${e.folder}`,`assets/backgrounds/${e.folder}/${i}.png`)}n.load.once("complete",()=>{t(!0)}),n.load.once("loaderror",s=>{console.error(`Failed to load background asset: ${s.key}`),t(!1)}),n.load.start()})}function Sn(n,e,t,s){const i=[],a=[],r=s.foregroundLayers??0,c=s.scrollFactors.length-r;for(let d=0;d<s.scrollFactors.length;d++){const v=`bg${d+1}-${s.folder}`,m=s.scrollFactors[d];if(n.textures.exists(v)){const P=n.textures.getFrame(v),x=P.width,C=P.height,b=t/C,p=x*b,y=e*3,u=Math.ceil(y/p)*x+x,g=n.add.tileSprite(0,0,u,C,v);g.setOrigin(0,0),g.setScale(b),g.setScrollFactor(1),g.setData("scrollFactor",m),g.setData("scale",b),d>=c?(g.setDepth(Me.FOREGROUND_LAYER_START+(d-c)),a.push(g)):(g.setDepth(Me.BACKGROUND_LAYER_START+d),i.push(g))}}return{bgLayers:i,fgLayers:a}}function wn(n,e){if(!n)return;const t=e.width/e.zoom,s=e.getBounds().width,i=Math.max(0,s-t),a=Math.max(0,Math.min(e.scrollX,i)),r=[...n.bgLayers,...n.fgLayers];for(const l of r){const c=l.getData("scrollFactor"),d=l.getData("scale");l.tilePositionX=a*(1-c)/d}}function _r(n){n.bgLayers.forEach(e=>e.destroy()),n.fgLayers.forEach(e=>e.destroy())}class br{scene;mapConfig;parallaxLayers=null;loadedBackgrounds=new Set;ground=null;groundY=0;constructor(e){this.scene=e}async loadMapConfiguration(e=!1){try{if(e){const t=sa();this.mapConfig=t||await wi()}else this.mapConfig=await wi()}catch(t){console.error("[MapManager] Failed to load map configuration:",t);const s=600;this.mapConfig={worldWidth:3200,worldHeight:s,playerStartX:400,playerStartY:kt(s),placedItems:[]}}return this.mapConfig}async setupBackground(){const e=ze.getCurrentConfig();this.loadedBackgrounds.has(e.folder)||await yn(this.scene,e)&&this.loadedBackgrounds.add(e.folder),this.parallaxLayers=Sn(this.scene,this.mapConfig.worldWidth,this.mapConfig.worldHeight,e)}createGround(){const t=ze.getCurrentConfig().groundHeight??40,s=Mt.createPhysicsGround(this.scene,{worldWidth:this.mapConfig.worldWidth,worldHeight:this.mapConfig.worldHeight,height:t});return this.ground=s.ground,this.groundY=s.groundY,this.scene.physics.world.setBounds(0,0,this.mapConfig.worldWidth,this.mapConfig.worldHeight),{...s,groundHeight:t}}update(e){this.parallaxLayers&&wn(this.parallaxLayers,e)}getConfig(){return this.mapConfig}getGround(){return this.ground}getGroundY(){return this.groundY}}class Ir extends G.Scene{playerManager;mapManager;player=null;getMapConfig(){return this.mapManager?.getConfig()||null}itemManager;npcManager;socialManager;dialogZones=[];currentDialogZone=null;currentNPCId=null;NPC_PROXIMITY_THRESHOLD=200;unsubscribers=[];initData;isInitialized=!1;constructor(){super({key:We.GAME})}init(e){this.initData=e,this.isInitialized=!1,this.playerManager=new Sr(this),this.mapManager=new br(this),this.playerManager.init()}preload(){this.playerManager.preload(),us.preloadAssets(this),fs.preloadAssets(this),yi.preloadAssets(this)}create(){this.events.on("shutdown",this.shutdown,this),this.initializeScene()}async initializeScene(){Gs.set(!0);try{await this.playerManager.loadAssets();const e=await this.mapManager.loadMapConfiguration(this.initData?.useBuilderConfig);await this.mapManager.setupBackground();const{ground:t,groundY:s,groundHeight:i}=this.mapManager.createGround();this.player=this.playerManager.createPlayer(e,t,i),this.itemManager=new us(this,s,e.worldWidth,e.worldHeight,!1),e.placedItems&&e.placedItems.length>0&&this.itemManager.createItems(e.placedItems);const a=this.itemManager.getPhysicsGroup();a&&this.player&&this.physics.add.collider(this.player.getGameObject(),a),this.socialManager=new yi(this),e.placedSocials&&e.placedSocials.length>0&&this.socialManager.createSocials(e.placedSocials),this.npcManager=new fs(this,s,e.worldWidth,e.worldHeight,!1),e.placedNPCs&&e.placedNPCs.length>0&&this.npcManager.createNPCs(e.placedNPCs),this.dialogZones=e.dialogZones||[];const r=ei.subscribe(l=>{this.dialogZones=l,this.recheckCurrentZone()});this.unsubscribers.push(r),this.player&&this.cameras.main.startFollow(this.player.getGameObject(),!0,.1,.1),this.setupCameraBounds(),this.scale.on("resize",this.handleResize,this),this.isInitialized=!0}catch(e){console.error("[GameScene] Failed to initialize scene:",e)}finally{Gs.set(!1)}}setupCameraBounds(){const e=this.mapManager.getConfig();if(!e)return;const t=this.cameras.main,s=t.height,i=t.width,a=s/e.worldHeight,r=Math.min(1,a);t.setZoom(r);const l=s/r,c=i/r;let d=0,h=e.worldHeight;l>e.worldHeight&&(d=(e.worldHeight-l)/2,h=l);let v=0,m=e.worldWidth;c>e.worldWidth&&(v=(e.worldWidth-c)/2,m=c),t.setBounds(v,d,m,h),zn(e.worldWidth,e.worldHeight,i,s,r)}handleResize(e){!this.cameras?.main||!this.mapManager||this.setupCameraBounds()}shutdown(){this.isInitialized=!1,this.scale.off("resize",this.handleResize,this),Ls(null),ns(null),this.currentDialogZone=null,this.currentNPCId=null,this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.itemManager&&this.itemManager.destroy(),this.socialManager&&this.socialManager.destroy()}update(){if(!this.isInitialized||!this.player)return;this.player.update();const{x:e,y:t}=this.player.getPosition(),s=this.mapManager.getConfig()?.worldHeight??640,i=this.player.getGameObject(),r=i.getBounds().bottom,l=ws(r,s);i.setDepth(l),this.itemManager&&this.itemManager.updateAutoDepth(s),this.npcManager&&this.npcManager.updateAutoDepth(s);const c=this.cameras.main,d=e-c.scrollX,h=t-c.scrollY;Zn(d,h),Fn(c.scrollX,c.scrollY,c.zoom),this.checkDialogZonesForPosition(e),this.checkNPCProximity(e,t,c),this.mapManager&&this.mapManager.update(this.cameras.main)}checkDialogZonesForPosition(e){let t=null;for(const s of this.dialogZones)if(e>=s.x&&e<=s.x+s.width){t=s;break}t?.id!==this.currentDialogZone?.id&&(this.currentDialogZone=t,Ls(t))}recheckCurrentZone(){if(!this.currentDialogZone)return;const e=this.dialogZones.find(t=>t.id===this.currentDialogZone?.id);e&&(this.currentDialogZone=e,Ls(e))}checkNPCProximity(e,t,s){if(!this.npcManager)return;const i=this.npcManager.getAllNPCs();let a=null;for(const r of i){const l=r.getDialogData?.()??[];if(!l||l.length===0||!l.some(P=>P.content&&P.content.trim().length>0))continue;const d=r.x-e,h=r.y-t,v=Math.sqrt(d*d+h*h),m=r.triggerRadius??this.NPC_PROXIMITY_THRESHOLD;v<=m&&(!a||v<a.distance)&&(a={id:r.id,distance:v,npc:r})}if(a){const r=a.npc,l=r.x-s.scrollX,c=r.y-s.scrollY,d=r.getContentHeight(),h=c+r.topOffset/2;this.currentNPCId!==a.id?(this.currentNPCId=a.id,ns({npcId:a.id,texts:r.getDialogData()??[],screenX:l,screenY:h,npcHeight:d})):ns({npcId:a.id,texts:r.getDialogData()??[],screenX:l,screenY:h,npcHeight:d})}else this.currentNPCId&&(this.currentNPCId=null,ns(null))}}const as=1,_i=.001,Cr=.15,bi=400;class Pr{scene;camera;worldWidth;worldHeight;isPanning=!1;panStartX=0;panStartY=0;cameraDragStartX=0;cameraDragStartY=0;isDraggingToScroll=!1;dragScrollStartX=0;dragScrollStartY=0;dragScrollCameraStartX=0;dragScrollCameraStartY=0;currentZoom=1;targetZoom=1;minZoom=.1;isAnimatingReset=!1;zoomTargetWorldPoint=null;pinchStartDistance=0;pinchStartZoom=1;activeTouches=new Map;pinchEndTime=0;isPinching=!1;PINCH_COOLDOWN=150;touchStartTime=0;touchStartPos=null;touchOnSelectedSprite=!1;TAP_MAX_DURATION=200;TAP_MAX_DISTANCE=10;constructor(e,t,s){this.scene=e,this.camera=e.cameras.main,this.worldWidth=t,this.worldHeight=s}setup(){this.calculateMinZoom(),this.setupCamera(),this.setupMouseControls(),this.setupKeyboardControls(),this.setupUpdateLoop()}calculateMinZoom(){const e=this.camera.width/this.worldWidth,t=this.camera.height/this.worldHeight;this.minZoom=Math.min(e,t)}setupCamera(){this.currentZoom=this.minZoom,this.targetZoom=this.minZoom,this.camera.setZoom(this.minZoom);const e=this.camera.width/this.minZoom,t=this.camera.height/this.minZoom,s=Math.min(0,(this.worldWidth-e)/2),i=Math.min(0,(this.worldHeight-t)/2),a=Math.max(this.worldWidth,e),r=Math.max(this.worldHeight,t);this.camera.setBounds(s,i,a,r),this.camera.centerOn(this.worldWidth/2,this.worldHeight/2),Lt(this.minZoom)}centerOn(e,t){this.camera.centerOn(e,t),this.clampScroll()}setPosition(e,t,s){this.currentZoom=G.Math.Clamp(s,this.minZoom,as),this.targetZoom=this.currentZoom,this.camera.setZoom(this.currentZoom),this.camera.scrollX=e,this.camera.scrollY=t,this.clampScroll(),Lt(this.currentZoom)}getPosition(){return{scrollX:this.camera.scrollX,scrollY:this.camera.scrollY,zoom:this.currentZoom}}handleResize(){this.calculateMinZoom(),this.currentZoom<this.minZoom&&(this.currentZoom=this.minZoom,this.targetZoom=this.minZoom,this.camera.setZoom(this.minZoom)),this.targetZoom<this.minZoom&&(this.targetZoom=this.minZoom),this.updateCameraBounds(),this.clampScroll(),Lt(this.currentZoom)}updateCameraBounds(){const e=this.camera.width/this.currentZoom,t=this.camera.height/this.currentZoom,s=Math.min(0,(this.worldWidth-e)/2),i=Math.min(0,(this.worldHeight-t)/2),a=Math.max(this.worldWidth,e),r=Math.max(this.worldHeight,t);this.camera.setBounds(s,i,a,r)}getScrollBounds(e=!0){const t=this.camera.width/this.currentZoom,s=this.camera.height/this.currentZoom;let i,a,r,l;return t>this.worldWidth?e?i=a=(this.worldWidth-t)/2:(i=this.worldWidth-t,a=0):(i=0,a=this.worldWidth-t),s>this.worldHeight?e?r=l=(this.worldHeight-s)/2:(r=this.worldHeight-s,l=0):(r=0,l=this.worldHeight-s),{minX:i,maxX:a,minY:r,maxY:l}}clampScroll(){const e=this.getScrollBounds(!0);this.camera.scrollX=G.Math.Clamp(this.camera.scrollX,e.minX,e.maxX),this.camera.scrollY=G.Math.Clamp(this.camera.scrollY,e.minY,e.maxY)}softClampScroll(){const e=this.getScrollBounds(!1);this.camera.scrollX=G.Math.Clamp(this.camera.scrollX,e.minX,e.maxX),this.camera.scrollY=G.Math.Clamp(this.camera.scrollY,e.minY,e.maxY)}applyPanDelta(e,t,s,i,a,r){const l=this.getScrollBounds(),c=(e-s)/this.currentZoom,d=(t-i)/this.currentZoom;this.camera.scrollX=G.Math.Clamp(a-c,l.minX,l.maxX),this.camera.scrollY=G.Math.Clamp(r-d,l.minY,l.maxY)}zoomToPoint(e,t,s){const i=this.camera.getWorldPoint(e,t);this.zoomToWorldPoint(i.x,i.y,s)}zoomToWorldPoint(e,t,s){const i=this.camera.scrollX,a=this.camera.scrollY,r=this.currentZoom;this.currentZoom=s,this.camera.setZoom(s),this.updateCameraBounds(),this.camera.scrollX=e-(e-i)*r/s,this.camera.scrollY=t-(t-a)*r/s,this.softClampScroll(),Lt(this.currentZoom)}setupMouseControls(){this.scene.input.on("wheel",(e,t,s,i,a)=>{if(this.isAnimatingReset)return;if((e.event.ctrlKey||Math.abs(s)<5&&Math.abs(i)>0)&&!e.event.ctrlKey){const l=-i*_i*3;this.targetZoom=G.Math.Clamp(this.targetZoom+l,this.minZoom,as);const c=this.camera.getWorldPoint(e.x,e.y);this.zoomTargetWorldPoint={x:c.x,y:c.y}}else if(e.event.ctrlKey){const l=-i*_i,c=G.Math.Clamp(this.currentZoom+l,this.minZoom,as);this.targetZoom=c,this.zoomToPoint(e.x,e.y,c)}else{const l=this.getScrollBounds();this.camera.scrollX=G.Math.Clamp(this.camera.scrollX+s/this.currentZoom,l.minX,l.maxX),this.camera.scrollY=G.Math.Clamp(this.camera.scrollY+i/this.currentZoom,l.minY,l.maxY)}}),this.scene.input.on("pointerdown",e=>{if(e.wasTouch){if(this.activeTouches.set(e.id,{x:e.x,y:e.y}),this.activeTouches.size===2){this.isPinching=!0,this.startPinch(),this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.scene.data.set("touchDraggingSprite",!1);return}this.activeTouches.size===1&&!this.isPinching&&(this.touchStartTime=Date.now(),this.touchStartPos={x:e.x,y:e.y},this.dragScrollStartX=e.x,this.dragScrollStartY=e.y,this.dragScrollCameraStartX=this.camera.scrollX,this.dragScrollCameraStartY=this.camera.scrollY,this.touchOnSelectedSprite=sr(this.scene,e),this.scene.data.set("touchDraggingSprite",!1),this.scene.data.set("touchStartOnSelectedSprite",this.touchOnSelectedSprite),this.scene.data.set("touchStartWorldX",e.worldX),this.scene.data.set("touchStartWorldY",e.worldY));return}St()||ui()||this.isAnimatingReset||(e.rightButtonDown()||e.middleButtonDown()?(this.isPanning=!0,this.panStartX=e.x,this.panStartY=e.y,this.cameraDragStartX=this.camera.scrollX,this.cameraDragStartY=this.camera.scrollY):e.leftButtonDown()&&!this.isDraggingObject()&&(this.scene.data.get("isDraggingItem")===!0||(this.dragScrollStartX=e.x,this.dragScrollStartY=e.y,this.dragScrollCameraStartX=this.camera.scrollX,this.dragScrollCameraStartY=this.camera.scrollY)))}),this.scene.input.on("pointermove",e=>{if(e.wasTouch){if(this.activeTouches.has(e.id)&&this.activeTouches.set(e.id,{x:e.x,y:e.y}),this.activeTouches.size>=2&&this.isPinching){this.handlePinch();return}if(this.isPinching||Date.now()-this.pinchEndTime<this.PINCH_COOLDOWN||this.scene.data.get("touchDraggingSprite"))return;if(this.touchStartPos&&!this.isDraggingToScroll){const t=Math.abs(e.x-this.touchStartPos.x),s=Math.abs(e.y-this.touchStartPos.y);if(Math.sqrt(t*t+s*s)>this.TAP_MAX_DISTANCE){if(this.touchOnSelectedSprite){this.scene.data.set("touchDragStarted",!0),this.scene.data.set("touchDraggingSprite",!0),this.touchStartPos=null;return}!St()&&!this.isDraggingObject()&&!this.scene.data.get("isDraggingItem")&&(this.isDraggingToScroll=!0,this.touchStartPos=null)}}this.isDraggingToScroll&&this.applyPanDelta(e.x,e.y,this.dragScrollStartX,this.dragScrollStartY,this.dragScrollCameraStartX,this.dragScrollCameraStartY);return}if(!(ui()||this.isAnimatingReset)){if(this.isPanning)this.applyPanDelta(e.x,e.y,this.panStartX,this.panStartY,this.cameraDragStartX,this.cameraDragStartY);else if(e.leftButtonDown()&&!this.isDraggingToScroll&&!this.isDraggingObject()&&!(this.scene.data.get("isDraggingItem")===!0)){const s=Math.abs(e.x-this.dragScrollStartX),i=Math.abs(e.y-this.dragScrollStartY);Math.sqrt(s*s+i*i)>10&&(this.isDraggingToScroll=!0,this.scene.input.setDefaultCursor("grabbing"))}this.isDraggingToScroll&&this.applyPanDelta(e.x,e.y,this.dragScrollStartX,this.dragScrollStartY,this.dragScrollCameraStartX,this.dragScrollCameraStartY)}}),this.scene.input.on("pointerup",e=>{if(e.wasTouch){if(this.isPinching&&(this.pinchEndTime=Date.now(),this.isPinching=!1,ks(!1)),this.touchStartPos&&!this.isDraggingToScroll){const t=Date.now()-this.touchStartTime,s=Math.abs(e.x-this.touchStartPos.x),i=Math.abs(e.y-this.touchStartPos.y),a=Math.sqrt(s*s+i*i);t<this.TAP_MAX_DURATION&&a<this.TAP_MAX_DISTANCE&&(this.scene.data.set("lastTapTime",Date.now()),this.scene.data.set("lastTapWorldX",e.worldX),this.scene.data.set("lastTapWorldY",e.worldY))}this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.activeTouches.delete(e.id),this.scene.data.set("touchDraggingSprite",!1),this.scene.data.set("touchDragStarted",!1),this.scene.data.set("touchStartOnSelectedSprite",!1),this.isDraggingToScroll&&(this.isDraggingToScroll=!1);return}!e.rightButtonDown()&&!e.middleButtonDown()&&(this.isPanning=!1),this.isDraggingToScroll&&(this.isDraggingToScroll=!1,this.scene.input.setDefaultCursor("default"))}),this.scene.input.on("pointerout",e=>{e.wasTouch&&(this.activeTouches.delete(e.id),this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.isPinching&&this.activeTouches.size<2&&(this.isPinching=!1,this.pinchEndTime=Date.now(),ks(!1)))})}startPinch(){const e=Array.from(this.activeTouches.values());if(e.length!==2)return;const[t,s]=e;this.pinchStartDistance=Math.hypot(s.x-t.x,s.y-t.y),this.pinchStartZoom=this.currentZoom,ks(!0)}handlePinch(){const e=Array.from(this.activeTouches.values());if(e.length!==2)return;const[t,s]=e,i=Math.hypot(s.x-t.x,s.y-t.y),a=(t.x+s.x)/2,r=(t.y+s.y)/2,l=i/this.pinchStartDistance,c=G.Math.Clamp(this.pinchStartZoom*l,this.minZoom,as);this.targetZoom=c,this.zoomToPoint(a,r,c)}setupKeyboardControls(){const e={up:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.UP,!1),down:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.DOWN,!1),left:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.LEFT,!1),right:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.RIGHT,!1)},t={w:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.W,!1),a:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.A,!1),s:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.S,!1),d:this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.D,!1)};this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.SPACE,!1).on("down",()=>{Hs()||this.centerOnPlayer()}),this.scene.input.keyboard.addKey(G.Input.Keyboard.KeyCodes.F,!1).on("down",()=>{Hs()||this.resetToFit()}),this.scene.data.set("cameraArrowKeys",e),this.scene.data.set("cameraWasdKeys",t)}setupUpdateLoop(){const e=this.scene.data.get("cameraArrowKeys"),t=this.scene.data.get("cameraWasdKeys");this.scene.events.on("update",()=>{if(!this.isAnimatingReset&&Math.abs(this.currentZoom-this.targetZoom)>1e-4){const a=G.Math.Linear(this.currentZoom,this.targetZoom,Cr);this.zoomTargetWorldPoint?this.zoomToWorldPoint(this.zoomTargetWorldPoint.x,this.zoomTargetWorldPoint.y,a):this.zoomToPoint(this.camera.width/2,this.camera.height/2,a),Math.abs(this.currentZoom-this.targetZoom)<.001&&(this.zoomTargetWorldPoint=null)}if(Hs()||this.isAnimatingReset)return;const s=10/this.currentZoom,i=this.getScrollBounds();e?.left?.isDown||t?.a?.isDown?this.camera.scrollX=G.Math.Clamp(this.camera.scrollX-s,i.minX,i.maxX):(e?.right?.isDown||t?.d?.isDown)&&(this.camera.scrollX=G.Math.Clamp(this.camera.scrollX+s,i.minX,i.maxX)),e?.up?.isDown||t?.w?.isDown?this.camera.scrollY=G.Math.Clamp(this.camera.scrollY-s,i.minY,i.maxY):(e?.down?.isDown||t?.s?.isDown)&&(this.camera.scrollY=G.Math.Clamp(this.camera.scrollY+s,i.minY,i.maxY))})}centerOnPlayer(){const e=this.scene.data.get("playerSprite");e&&(this.camera.centerOn(e.x,e.y),this.clampScroll())}isDraggingObject(){return this.scene.data.get("isDraggingObject")===!0||this.scene.data.get("isDraggingItem")===!0}resetToFit(){if(this.isAnimatingReset)return;this.isAnimatingReset=!0,this.targetZoom=this.minZoom;const e=this.camera.width/this.minZoom,t=this.camera.height/this.minZoom,s=(this.worldWidth-e)/2,i=(this.worldHeight-t)/2,a=s+e/2,r=i+t/2;this.camera.pan(a,r,bi,"Sine.easeInOut"),this.camera.zoomTo(this.minZoom,bi,"Sine.easeInOut",!1,(l,c)=>{c===1&&(this.currentZoom=this.minZoom,this.camera.scrollX=s,this.camera.scrollY=i,this.isAnimatingReset=!1,Lt(this.minZoom))})}destroy(){this.activeTouches.clear()}}class xr{scene;player;modularCharacter=null;worldWidth;worldHeight;unsubscribers=[];interactionCleanup=null;useModular=!1;modularSelection=null;debugGraphics=null;isSelected=!1;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s;const i=localStorage.getItem("useModularPlayer");this.modularSelection=js(),this.useModular=i==="true"&&this.modularSelection!==null}async preload(){!this.useModular||!this.modularSelection||await Ai(this.scene,this.modularSelection)}create(e,t){const s=ze.getCurrentConfig().groundHeight??Ye;if(this.useModular&&this.modularSelection){const i=jt(this.worldHeight,s),a=Math.min(t,i);return this.createModularPlayer(e,a)}else{const i=Math.min(t,kt(this.worldHeight,s));return this.createStaticPlayer(e,i)}}createStaticPlayer(e,t){const s=yt.getSkinId(),i=Ie.find(l=>l.id===s)??Ie[0],a=Zt(i),r=this.scene.add.sprite(e,t,`${s}-idle`,0);return r.setScale(a),r.setDepth(Gt.DEPTH),r.setData("isPlayer",!0),this.player=r,this.scene.data.set("playerSprite",this.player),this.setupInteraction(),this.setupEditModeSubscription(),this.setupSelectionSubscription(),r}createModularPlayer(e,t){this.modularCharacter=new $i(this.scene,e,t,this.modularSelection,{animated:!1,facing:"right",scale:Wt});const s=this.modularCharacter;return s.setDepth(Gt.DEPTH),s.setData("isPlayer",!0),this.player=s,this.scene.data.set("playerSprite",this.player),this.setupInteraction(),this.setupEditModeSubscription(),this.setupSelectionSubscription(),s}setupInteraction(){let e;if(this.useModular&&this.modularCharacter)e=new G.Geom.Rectangle(-80/2,-64/2,lt.FRAME_WIDTH,lt.FRAME_HEIGHT),this.scene.data.set("modularPlayerHitArea",e);else{const t=yt.getSkinId(),s=Ie.find(c=>c.id===t)??Ie[0],i=s.frameWidth??48,a=s.frameHeight??48,r=i*Ks.WIDTH,l=(i-r)/2;e=new G.Geom.Rectangle(l,0,r,a)}this.interactionCleanup=Ps({sprite:this.player,scene:this.scene,useGridSnapping:!1,cursor:"grab",hitArea:e,constraints:{minX:pi,maxX:this.worldWidth-pi,minY:Za},callbacks:{onSelect:()=>{Sa(!0)},isSelected:()=>Ge(di),onDragStart:()=>{this.scene.data.set("isDraggingObject",!0)},onDrag:(t,s)=>{hi(Math.round(t),Math.round(s)),this.updateDebugVisualization()},onDragEnd:(t,s)=>{this.scene.data.set("isDraggingObject",!1);let i=this.player.y;const a=ze.getCurrentConfig().groundHeight??Ye;this.useModular?Aa(this.player.y,this.worldHeight,a)&&(i=jt(this.worldHeight,a),this.player.setY(i)):Ma(this.player.y,this.worldHeight,a)&&(i=kt(this.worldHeight,a),this.player.setY(i)),hi(Math.round(this.player.x),Math.round(i)),this.updateDebugVisualization()}}}),mi&&this.createDebugVisualization()}createDebugVisualization(){this.debugGraphics&&this.debugGraphics.destroy(),this.debugGraphics=this.scene.add.graphics(),this.debugGraphics.setDepth(Gt.DEPTH+1),this.updateDebugVisualization()}updateDebugVisualization(){if(!this.debugGraphics||!mi)return;this.debugGraphics.clear();const e=this.isSelected?ja:za,t=this.isSelected?Va:Ka,s=this.isSelected?qa:Ua;let i=null;if(this.useModular&&this.modularCharacter){const a=this.player,r=this.scene.data.get("modularPlayerHitArea");if(r&&a.input){const l=a.scaleX;i={x:a.x+r.x*l,y:a.y+r.y*l,width:r.width*l,height:r.height*l}}}else{const a=this.player,r=yt.getSkinId(),l=Ie.find(C=>C.id===r)??Ie[0],c=Zt(l),d=(l.frameWidth??48)*c,h=(l.frameHeight??48)*c,v=d*Ks.WIDTH,m=(d-v)/2,P=a.originX??.5,x=a.originY??.5;i={x:a.x-d*P+m,y:a.y-h*x,width:v,height:h}}i&&(this.debugGraphics.fillStyle(vi,e),this.debugGraphics.fillRect(i.x,i.y,i.width,i.height),this.debugGraphics.lineStyle(t,vi,s),this.debugGraphics.strokeRect(i.x,i.y,i.width,i.height))}setupSelectionSubscription(){const e=di.subscribe(t=>{this.isSelected=t,this.updateDebugVisualization(),this.scene.data.set("isPlayerSelected",t)});this.unsubscribers.push(e)}setupEditModeSubscription(){const e=Oe.subscribe(t=>{t==="dialogs"?(this.interactionCleanup&&(this.interactionCleanup(),this.interactionCleanup=null),this.player.disableInteractive(),this.setAlpha(.6)):(this.setAlpha(1),this.interactionCleanup||this.setupInteraction())});this.unsubscribers.push(e)}setAlpha(e){this.modularCharacter?this.modularCharacter.setAlpha(e):this.player.setAlpha(e)}getSprite(){return this.player}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.interactionCleanup&&(this.interactionCleanup(),this.interactionCleanup=null),this.debugGraphics&&(this.debugGraphics.destroy(),this.debugGraphics=null),this.modularCharacter?(this.modularCharacter.destroy(),this.modularCharacter=null):this.player&&this.player.destroy()}}class Dr{scene;graphics;worldWidth;worldHeight;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}create(){return this.graphics=this.scene.add.graphics(),this.graphics.setDepth(dn),this.draw(),this.graphics}draw(){this.graphics.clear(),this.graphics.lineStyle(La,Oa,Ra);const e=Math.max(this.worldHeight,this.scene.scale.height);for(let i=0;i<=this.worldWidth;i+=Pt)this.graphics.beginPath(),this.graphics.moveTo(i,0),this.graphics.lineTo(i,e),this.graphics.strokePath();for(let i=0;i<=e;i+=Pt)this.graphics.beginPath(),this.graphics.moveTo(0,i),this.graphics.lineTo(this.worldWidth,i),this.graphics.strokePath();const t=ze.getCurrentConfig().groundHeight??Ye,s=this.worldHeight-t;this.graphics.lineStyle(Na,Rs,Xa),this.graphics.beginPath(),this.graphics.moveTo(0,s),this.graphics.lineTo(this.worldWidth,s),this.graphics.strokePath(),this.graphics.lineStyle(Ya,Rs,Ba),this.graphics.fillStyle(Rs,Wa),this.graphics.fillRect(0,s,this.worldWidth,e-s)}getGraphics(){return this.graphics}redraw(){this.draw()}destroy(){this.graphics&&this.graphics.destroy()}}class Er{scene;groundY;worldWidth;worldHeight;itemManager;unsubscribers=[];constructor(e,t,s,i){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=i}create(e){return this.itemManager=new us(this.scene,this.groundY,this.worldWidth,this.worldHeight,!0),e&&e.length>0&&this.itemManager.createItems(e),this.setupBackgroundDeselect(),this.setupStoreSubscriptions(),this.setupAssetDropListener(),this.itemManager}setupBackgroundDeselect(){this.itemManager.setupBackgroundDeselect()}setupStoreSubscriptions(){const e=Tt.subscribe(a=>{this.scene.data.set("selectedItemId",a),this.itemManager.updateSelectionVisuals()});this.unsubscribers.push(e);const t=Oe.subscribe(a=>{a==="dialogs"?(At(),this.itemManager.setInteractiveEnabled(!1)):this.itemManager.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const i=Xi.subscribe(a=>{if(!a?.placedItems)return;const r=a.placedItems;s.forEach(l=>{r.find(d=>d.id===l.id)||this.itemManager.removeItem(l.id)}),r.forEach(l=>{const c=s.find(d=>d.id===l.id);c&&JSON.stringify(c)!==JSON.stringify(l)&&this.itemManager.updateItem(l.id,l)}),s=r.map(l=>({...l}))});this.unsubscribers.push(i)}setupAssetDropListener(){const e=Ee.on(be.ASSET_DROPPED,t=>{const{assetKey:s,canvasX:i,canvasY:a}=t,l=this.scene.cameras.main.getWorldPoint(i,a),c=Math.max(0,Math.min(this.worldWidth,l.x)),d=Math.max(0,Math.min(this.worldHeight,l.y)),h=ls.createAtWorldPosition(s,c,d,this.groundY,"behind");da(h),this.itemManager.createItem(h),bs(h.id),rt.set(!1)});this.unsubscribers.push(()=>e.unsubscribe())}getManager(){return this.itemManager}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.itemManager&&this.itemManager.destroy()}}class Ii{scene;worldWidth;worldHeight;socials=new Map;unsubscribers=[];selectionGraphics=null;cleanupFunctions=new Map;doubleClickDetector=new hn;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}static preloadAssets(e){e.load.image("social_discord","assets/socials/Discord.png"),e.load.image("social_facebook","assets/socials/Facebook.png"),e.load.image("social_instagram","assets/socials/Instagram.png"),e.load.image("social_kofi","assets/socials/Ko Fi.png"),e.load.image("social_linkedin","assets/socials/LinkedIn.png"),e.load.image("social_patreon","assets/socials/Patreon.png"),e.load.image("social_tiktok","assets/socials/TikTok.png"),e.load.image("social_twitch","assets/socials/Twitch.png"),e.load.image("social_twitter","assets/socials/Twitter.png"),e.load.image("social_whatsapp","assets/socials/Whatsapp.png"),e.load.image("social_youtube","assets/socials/Youtube.png")}create(e){this.selectionGraphics=this.scene.add.graphics(),this.selectionGraphics.setDepth(Me.SELECTION_GRAPHICS),e&&e.length>0&&e.forEach(t=>this.createSocial(t)),this.setupStoreSubscriptions(),this.setupSocialDropListener()}createSocial(e){const t=`social_${e.socialKey}`;if(!this.scene.textures.exists(t)){console.warn(`Social texture not found: ${t}`);return}const s=e.scale??Dt,i=e.depth??Me.ITEMS_FRONT,a=this.scene.add.sprite(e.x,e.y,t);a.setScale(s),a.setDepth(i),a.setOrigin(.5,.5),a.setData("socialId",e.id),this.socials.set(e.id,{sprite:a,data:e}),this.makeInteractive(e.id)}updateSocialVisuals(e){const t=this.socials.get(e);if(!t)return;const{sprite:s,data:i}=t,a=`social_${i.socialKey}`;s.texture.key!==a&&this.scene.textures.exists(a)&&s.setTexture(a);const r=i.scale??Dt;s.setScale(r)}makeInteractive(e){const t=this.socials.get(e);if(!t)return;const{sprite:s}=t,i=Ps({sprite:s,scene:this.scene,cursor:"grab",useGridSnapping:!0,constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{Yt(e),this.updateSelectionVisuals()},isSelected:()=>Ge(Ut)===e,onDoubleClick:()=>this.doubleClickDetector.check(e)?(Ki(),!0):!1,onDragStart:()=>{s.setTint(Ga)},onDrag:()=>{this.updateSelectionVisuals()},onDragEnd:(a,r)=>{s.clearTint();const l=this.socials.get(e);l&&(l.data.x=Math.round(a),l.data.y=Math.round(r),rs(e,{x:l.data.x,y:l.data.y}))}}});this.cleanupFunctions.set(e,i)}setupStoreSubscriptions(){const e=Ut.subscribe(a=>{this.scene.data.set("selectedSocialId",a),this.updateSelectionVisuals()});this.unsubscribers.push(e);const t=Oe.subscribe(a=>{a==="dialogs"?(Yt(null),this.setInteractiveEnabled(!1)):this.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const i=fa.subscribe(a=>{s.forEach(r=>{a.find(c=>c.id===r.id)||this.removeSocial(r.id)}),a.forEach(r=>{const l=s.find(d=>d.id===r.id),c=this.socials.get(r.id);if(c&&l){const d=l.scale!==r.scale,h=l.socialKey!==r.socialKey;c.data=r,(d||h)&&(this.updateSocialVisuals(r.id),this.scene.data.get("selectedSocialId")===r.id&&this.updateSelectionVisuals())}}),s=a.map(r=>({...r}))});this.unsubscribers.push(i)}setupSocialDropListener(){const e=Ee.on(be.SOCIAL_DROPPED,t=>{const{socialKey:s,canvasX:i,canvasY:a}=t,l=this.scene.cameras.main.getWorldPoint(i,a),c=Math.max(0,Math.min(this.worldWidth,l.x)),d=Math.max(0,Math.min(this.worldHeight,l.y)),h={id:rr(),socialKey:s,x:Math.round(c),y:Math.round(d),scale:Dt,depth:Me.ITEMS_FRONT};ma(h),this.createSocial(h),Yt(h.id)});this.unsubscribers.push(()=>e.unsubscribe())}updateSelectionVisuals(){if(!this.selectionGraphics)return;this.selectionGraphics.clear();const e=this.scene.data.get("selectedSocialId");if(!e){As(null);return}const t=this.socials.get(e);if(!t){As(null);return}const s=t.sprite,i=s.getBounds(),a=this.scene.cameras.main,{screenX:r,screenY:l}=vt(s.x,s.y,a);As({screenX:r,screenY:l,socialHeight:i.height*a.zoom}),this.selectionGraphics.lineStyle(3,Cs.SOCIAL.hex,1),this.selectionGraphics.strokeRect(i.x-4,i.y-4,i.width+8,i.height+8)}removeSocial(e){const t=this.socials.get(e);t&&(t.sprite.destroy(),this.socials.delete(e));const s=this.cleanupFunctions.get(e);s&&(s(),this.cleanupFunctions.delete(e)),this.updateSelectionVisuals()}setInteractiveEnabled(e){this.socials.forEach(({sprite:t})=>{e?(t.setInteractive(),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectionGraphics&&this.selectionGraphics.clear()}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear(),this.socials.forEach(({sprite:e})=>{e.destroy()}),this.socials.clear(),this.selectionGraphics&&(this.selectionGraphics.destroy(),this.selectionGraphics=null)}}class Ci{scene;groundY;worldWidth;worldHeight;npcManager;unsubscribers=[];constructor(e,t,s,i){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=i}static preloadAssets(e){fs.preloadAssets(e)}create(e){return this.npcManager=new fs(this.scene,this.groundY,this.worldWidth,this.worldHeight,!0),e&&e.length>0&&this.npcManager.createNPCs(e),this.setupStoreSubscriptions(),this.setupAssetDropListener(),this.npcManager}setupStoreSubscriptions(){const e=Oe.subscribe(i=>{i==="dialogs"?(At(),this.npcManager.setInteractiveEnabled(!1)):this.npcManager.setInteractiveEnabled(!0)});this.unsubscribers.push(e);let t=[];const s=Xi.subscribe(i=>{if(!i?.placedNPCs)return;const a=i.placedNPCs;t.forEach(r=>{a.find(c=>c.id===r.id)||this.npcManager.removeNPC(r.id)}),a.forEach(r=>{const l=t.find(c=>c.id===r.id);l&&JSON.stringify(l)!==JSON.stringify(r)&&this.npcManager.updateNPC(r.id,r)}),t=JSON.parse(JSON.stringify(a))});this.unsubscribers.push(s)}setupAssetDropListener(){const e=Ee.on(be.NPC_DROPPED,t=>{const{assetKey:s,canvasX:i,canvasY:a}=t,r=this.scene.cameras.main.getWorldPoint(i,a),l=Math.max(0,Math.min(this.worldWidth,r.x)),c=Math.max(0,Math.min(this.worldHeight,r.y)),d=gs(s);if(!d)return;const h={id:`npc_${Date.now()}`,npcId:s,x:Math.round(l),y:Math.round(c),scale:d.scale,flipX:!1};_a(h),this.npcManager.createNPC(h),bs(h.id),ot.set(!1)});this.unsubscribers.push(()=>e.unsubscribe())}update(){this.npcManager.update()}updateAutoDepth(e){this.npcManager.updateAutoDepth(e)}destroy(){this.unsubscribers.forEach(e=>e()),this.npcManager.destroy()}getManager(){return this.npcManager}}const st=dn-1,it=300,Pi=150,Tr=.3,kr=.5,Ns=40,xi=60,Di=16777215,Ei=.6,Ti=0,Ke=60,ki=8;class Mr{scene;worldWidth;worldHeight;graphics=null;zoneAreas=new Map;leftHandles=new Map;leftHandleVisuals=new Map;rightHandles=new Map;rightHandleVisuals=new Map;arrowGraphics=new Map;dragging=null;unsubscribers=[];createZoneSubscription;currentEditMode="items";currentZones=[];currentSelectedId=null;lastClickTime=0;lastClickX=0;DOUBLE_CLICK_THRESHOLD=300;DOUBLE_CLICK_DISTANCE=20;pendingTap=null;TAP_MAX_DURATION=300;TAP_MAX_DISTANCE=15;pendingZoneSelection=null;createZoneAtSubscription;boundWindowPointerUp=()=>{};boundWindowPointerMove=()=>{};currentScreenX=0;autoScrollTimer=null;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}create(){this.graphics=this.scene.add.graphics(),this.graphics.setDepth(st);const e=Oe.subscribe(i=>{this.currentEditMode=i,this.render()});this.unsubscribers.push(e);const t=ei.subscribe(i=>{this.currentZones=i,this.render()});this.unsubscribers.push(t);const s=Is.subscribe(i=>{this.currentSelectedId=i,this.render()});this.unsubscribers.push(s),this.scene.input.on("pointermove",this.handlePointerMove,this),this.scene.input.on("pointerup",this.handlePointerUp,this),this.boundWindowPointerUp=this.handlePointerUp.bind(this),this.boundWindowPointerMove=this.handleWindowPointerMove.bind(this),window.addEventListener("pointerup",this.boundWindowPointerUp),window.addEventListener("pointermove",this.boundWindowPointerMove),this.scene.input.on("pointerdown",this.handlePointerDown,this),this.createZoneSubscription=Ee.on(be.DIALOG_ZONE_CREATE,()=>{this.createNewZone()}),this.createZoneAtSubscription=Ee.on(be.DIALOG_ZONE_CREATE_AT,i=>{this.createZoneAtPosition(i.worldX)}),this.render()}clearVisuals(){this.graphics&&this.graphics.clear(),this.zoneAreas.forEach(e=>e.destroy()),this.zoneAreas.clear(),this.leftHandles.forEach(e=>e.destroy()),this.leftHandles.clear(),this.rightHandles.forEach(e=>e.destroy()),this.rightHandles.clear(),this.leftHandleVisuals.forEach(e=>e.destroy()),this.leftHandleVisuals.clear(),this.rightHandleVisuals.forEach(e=>e.destroy()),this.rightHandleVisuals.clear(),this.arrowGraphics.forEach(e=>e.destroy()),this.arrowGraphics.clear()}render(){if(this.clearVisuals(),this.currentEditMode==="dialogs")for(const e of this.currentZones)this.renderZone(e,e.id===this.currentSelectedId)}renderZone(e,t){if(!this.graphics)return;const s=G.Display.Color.HexStringToColor(e.color).color,i=t?kr:Tr;this.graphics.fillStyle(s,i),this.graphics.fillRect(e.x,0,e.width,this.worldHeight),this.graphics.lineStyle(2,s,.8),this.graphics.strokeRect(e.x,0,e.width,this.worldHeight);const a=this.scene.add.rectangle(e.x+e.width/2,this.worldHeight/2,e.width-Ns*2,this.worldHeight);a.setOrigin(.5,.5),a.setInteractive({cursor:t?"grab":"pointer"}),a.setDepth(st+.1),a.setAlpha(.001),a.setData("zoneId",e.id),a.on("pointerdown",r=>{if(this.isClickOnUIElement(r))return;const l=Date.now(),c=l-this.lastClickTime<this.DOUBLE_CLICK_THRESHOLD&&Math.abs(r.worldX-this.lastClickX)<this.DOUBLE_CLICK_DISTANCE;this.lastClickTime=l,this.lastClickX=r.worldX;const d=this.currentSelectedId===e.id;if(c&&d){Ui();return}d?(this.scene.data.set("isDraggingItem",!0),xt(!0),this.startDrag(e.id,"move",r.worldX)):this.pendingZoneSelection={zoneId:e.id,worldX:r.worldX,startTime:l}}),this.zoneAreas.set(e.id,a),t&&this.createHandles(e)}createHandles(e){const t=this.scene.cameras.main.scrollY,s=this.scene.cameras.main.height,i=t+s/2,a=this.scene.add.rectangle(e.x,this.worldHeight/2,Ns,this.worldHeight);a.setOrigin(.5,.5),a.setDepth(st+.2),a.setFillStyle(Di,Ei);const r=this.scene.add.rectangle(e.x,this.worldHeight/2,xi,this.worldHeight);r.setOrigin(.5,.5),r.setInteractive({cursor:"ew-resize"}),r.setDepth(st+.25),r.setAlpha(.001),r.setData("zoneId",e.id),r.setData("type","left"),r.on("pointerdown",m=>{this.isClickOnUIElement(m)||this.startDrag(e.id,"left",m.worldX)}),this.leftHandles.set(e.id,r),this.leftHandleVisuals.set(e.id,a);const l=8,c=this.scene.add.graphics();c.setDepth(st+.3),this.drawArrow(c,e.x-l,i,"left"),this.arrowGraphics.set(`${e.id}_left`,c);const d=this.scene.add.rectangle(e.x+e.width,this.worldHeight/2,Ns,this.worldHeight);d.setOrigin(.5,.5),d.setDepth(st+.2),d.setFillStyle(Di,Ei);const h=this.scene.add.rectangle(e.x+e.width,this.worldHeight/2,xi,this.worldHeight);h.setOrigin(.5,.5),h.setInteractive({cursor:"ew-resize"}),h.setDepth(st+.25),h.setAlpha(.001),h.setData("zoneId",e.id),h.setData("type","right"),h.on("pointerdown",m=>{this.isClickOnUIElement(m)||this.startDrag(e.id,"right",m.worldX)}),this.rightHandles.set(e.id,h),this.rightHandleVisuals.set(e.id,d);const v=this.scene.add.graphics();v.setDepth(st+.3),this.drawArrow(v,e.x+e.width+l,i,"right"),this.arrowGraphics.set(`${e.id}_right`,v)}drawArrow(e,t,s,i){const r=i==="left"?-1:1;e.fillStyle(3355443,.8),e.beginPath(),e.moveTo(t+r*10+1,s),e.lineTo(t-r*10+1,s-10+1),e.lineTo(t-r*10+1,s+10-1),e.closePath(),e.fillPath(),e.fillStyle(16777215,.9),e.beginPath(),e.moveTo(t+r*10,s),e.lineTo(t-r*10,s-10),e.lineTo(t-r*10,s+10),e.closePath(),e.fillPath()}startDrag(e,t,s){const i=this.currentZones.find(a=>a.id===e);i&&(this.scene.data.set("isDraggingItem",!0),xt(!0),this.dragging={zoneId:e,type:t,startX:s,originalX:i.x,originalWidth:i.width})}getZoneBounds(e){let t=0,s=this.worldWidth;for(const i of this.currentZones){if(i.id===e)continue;const a=i.x+i.width,r=this.currentZones.find(l=>l.id===e);r&&(a<=r.x+r.width/2&&(t=Math.max(t,a+Ti)),i.x>=r.x+r.width/2&&(s=Math.min(s,i.x-Ti)))}return{minX:t,maxX:s-it,maxRight:s}}wouldOverlap(e,t,s){const i=t+s;for(const a of this.currentZones){if(a.id===e)continue;const r=a.x,l=a.x+a.width;if(t<l&&i>r)return!0}return!1}isClickOnUIElement(e){const t=e.downElement;return t?t.tagName?.toUpperCase()!=="CANVAS":!1}cancelPendingIfMoved(e){this.pendingTap&&Math.abs(e-this.pendingTap.worldX)>this.TAP_MAX_DISTANCE&&(this.pendingTap=null),this.pendingZoneSelection&&Math.abs(e-this.pendingZoneSelection.worldX)>this.TAP_MAX_DISTANCE&&(this.pendingZoneSelection=null)}screenToWorld(e,t){const s=this.scene.cameras.main,a=this.scene.game.canvas.getBoundingClientRect(),r=e-a.left,l=t-a.top;return Pa(r,l,s)}handleWindowPointerMove(e){const t=this.screenToWorld(e.clientX,e.clientY);if(this.cancelPendingIfMoved(t.worldX),!this.dragging)return;const i=this.scene.game.canvas.getBoundingClientRect();e.clientX>=i.left&&e.clientX<=i.right&&e.clientY>=i.top&&e.clientY<=i.bottom||(this.currentScreenX=e.clientX-i.left,this.updateDrag(t.worldX),this.checkAutoScroll())}handlePointerMove(e){this.cancelPendingIfMoved(e.worldX),this.dragging&&(this.currentScreenX=e.x,e.event?.stopPropagation?.(),this.updateDrag(e.worldX),this.checkAutoScroll())}checkAutoScroll(){if(!this.dragging||this.dragging.type!=="move"){this.stopAutoScroll();return}const e=this.scene.cameras.main,t=e.width,s=this.currentZones.find(y=>y.id===this.dragging?.zoneId);if(!s)return;const i=Math.max(0,this.worldWidth-e.width/e.zoom);if(i<=0){this.stopAutoScroll();return}const{screenX:a}=vt(s.x,0,e),{screenX:r}=vt(s.x+s.width,0,e),l=a<=Ke,c=r>=t-Ke,d=e.scrollX>0,h=e.scrollX<i,v=s.x>0,m=s.x+s.width<this.worldWidth,P=this.currentScreenX<Ke,x=this.currentScreenX>t-Ke,p=l&&P&&d&&v||c&&x&&h&&m;p&&!this.autoScrollTimer?this.autoScrollTimer=this.scene.time.addEvent({delay:16,callback:this.performAutoScroll,callbackScope:this,loop:!0}):!p&&this.autoScrollTimer&&this.stopAutoScroll()}performAutoScroll(){if(!this.dragging||this.dragging.type!=="move"){this.stopAutoScroll();return}const e=this.scene.cameras.main,t=e.width,s=this.currentZones.find(b=>b.id===this.dragging?.zoneId);if(!s)return;let i=0;if(this.currentScreenX<Ke){if(s.x<=0){this.stopAutoScroll();return}const p=(Ke-this.currentScreenX)/Ke;i=-ki*p}else if(this.currentScreenX>t-Ke){if(s.x+s.width>=this.worldWidth){this.stopAutoScroll();return}const p=(this.currentScreenX-(t-Ke))/Ke;i=ki*p}if(i===0)return;const a=e.scrollX+i,r=0,l=Math.max(0,this.worldWidth-e.width/e.zoom),d=Math.max(r,Math.min(l,a))-e.scrollX;if(l<=0){this.stopAutoScroll();return}if(d===0){this.stopAutoScroll();return}const h=s.x+d,v=Math.max(0,Math.min(this.worldWidth-s.width,h)),m=v-s.x;if(m===0){this.stopAutoScroll();return}const P=e.scrollX+m,x=Math.max(0,Math.min(l,P));if(Math.abs(x-e.scrollX)>Math.abs(m)*2){this.stopAutoScroll();return}e.scrollX=x,this.wouldOverlap(s.id,v,s.width)||(bt(s.id,{x:v}),this.dragging.originalX+=m,this.dragging.startX+=m)}stopAutoScroll(){this.autoScrollTimer&&(this.autoScrollTimer.destroy(),this.autoScrollTimer=null)}updateDrag(e){if(!this.dragging)return;const t=e-this.dragging.startX,s=this.currentZones.find(a=>a.id===this.dragging?.zoneId);if(!s)return;const i=this.getZoneBounds(s.id);if(this.dragging.type==="left"){let a=this.dragging.originalX+t,r=this.dragging.originalWidth-t;if(a<0&&(r+=a,a=0),r<it&&(a=this.dragging.originalX+this.dragging.originalWidth-it,r=it),a<i.minX){const l=i.minX-a;a=i.minX,r-=l}r>=it&&!this.wouldOverlap(s.id,a,r)&&bt(s.id,{x:a,width:r})}else if(this.dragging.type==="right"){let a=this.dragging.originalWidth+t;a<it&&(a=it),s.x+a>this.worldWidth&&(a=this.worldWidth-s.x),s.x+a>i.maxRight&&(a=i.maxRight-s.x),a>=it&&!this.wouldOverlap(s.id,s.x,a)&&bt(s.id,{width:a})}else if(this.dragging.type==="move"){let a=this.dragging.originalX+t;const r=s.width;if(a<0&&(a=0),a+r>this.worldWidth&&(a=this.worldWidth-r),!this.wouldOverlap(s.id,a,r))bt(s.id,{x:a});else{const l=this.findNonOverlappingPosition(s.id,a,r);l!==null&&bt(s.id,{x:l})}}}findNonOverlappingPosition(e,t,s){const i=this.currentZones.filter(h=>h.id!==e).sort((h,v)=>h.x-v.x);if(i.length===0)return Math.max(0,Math.min(t,this.worldWidth-s));let a=t,r=1/0;const l=i[0];if(l.x>=s){const h=l.x-s,v=Math.max(0,Math.min(t,h)),m=Math.abs(v-t);m<r&&(r=m,a=v)}for(let h=0;h<i.length-1;h++){const v=i[h],m=i[h+1],P=v.x+v.width,x=m.x;if(x-P>=s){const b=P,p=x-s,y=Math.max(b,Math.min(t,p)),u=Math.abs(y-t);u<r&&(r=u,a=y)}}const c=i[i.length-1],d=c.x+c.width;if(this.worldWidth-d>=s){const h=d,v=this.worldWidth-s,m=Math.max(h,Math.min(t,v)),P=Math.abs(m-t);P<r&&(r=P,a=m)}return r<1/0&&!this.wouldOverlap(e,a,s)?a:null}handlePointerUp(e){if(this.dragging&&(this.stopAutoScroll(),this.scene.data.set("isDraggingItem",!1),xt(!1),this.dragging=null),this.pendingZoneSelection){let i=Date.now()-this.pendingZoneSelection.startTime<this.TAP_MAX_DURATION;i&&e&&e.worldX!==void 0&&(i=Math.abs(e.worldX-this.pendingZoneSelection.worldX)<this.TAP_MAX_DISTANCE),i&&Bt(this.pendingZoneSelection.zoneId),this.pendingZoneSelection=null}if(this.pendingTap&&this.currentEditMode==="dialogs"){if(Date.now()-this.pendingTap.startTime<this.TAP_MAX_DURATION){let i=!0;e&&e.worldX!==void 0&&(i=Math.abs(e.worldX-this.pendingTap.worldX)<this.TAP_MAX_DISTANCE),i&&this.showTempAddButton(this.pendingTap.worldX,this.pendingTap.worldY)}this.pendingTap=null}}handlePointerDown(e){if(St()||this.currentEditMode!=="dialogs"||this.dragging)return;const t=e.downElement;if(t&&t.tagName?.toUpperCase()!=="CANVAS")return;const s=e.worldX;for(const l of this.currentZones)if(s>=l.x&&s<=l.x+l.width)return;const i=Date.now(),a=i-this.lastClickTime,r=Math.abs(s-this.lastClickX);if(a<this.DOUBLE_CLICK_THRESHOLD&&r<this.DOUBLE_CLICK_DISTANCE){this.createZoneAtPosition(s),this.lastClickTime=0,this.hideTempAddButton();return}this.lastClickTime=i,this.lastClickX=s,this.pendingTap={worldX:s,worldY:e.worldY,startTime:i},this.currentSelectedId&&Bt(null)}showTempAddButton(e,t){const s=this.scene.cameras.main,{screenX:i,screenY:a}=vt(e,t,s);Ee.emit(be.TEMP_ZONE_BUTTON_SHOW,{screenX:i,screenY:a,worldX:e})}hideTempAddButton(){Ee.emit(be.TEMP_ZONE_BUTTON_HIDE,{})}createZoneAtPosition(e){this.createZoneAt(e)}createNewZone(){const e=this.scene.cameras.main,t=e.worldView.x+e.worldView.width/2;this.createZoneAt(t)}createZoneAt(e){let t=e-Pi/2;const s=Pi;if(t=Math.max(0,Math.min(this.worldWidth-s,t)),this.wouldOverlap("",t,s)){const a=this.findNonOverlappingPosition("",t,s);if(a===null){console.warn("No room for a new dialog zone");return}t=a}const i=hr(t,s);i.x=t,va(i),Bt(i.id)}updateSelectionVisuals(){if(this.currentEditMode!=="dialogs"){es(null);return}if(!this.currentSelectedId){es(null);return}const e=this.currentZones.find(r=>r.id===this.currentSelectedId);if(!e){es(null);return}const t=this.scene.cameras.main,s=e.x+e.width/2,{screenX:i}=vt(s,0,t),a=t.height*.65;es({screenX:i,screenY:a})}destroy(){this.hideTempAddButton();for(const e of this.unsubscribers)e();this.unsubscribers=[],this.createZoneSubscription&&this.createZoneSubscription.unsubscribe(),this.createZoneAtSubscription&&this.createZoneAtSubscription.unsubscribe(),this.stopAutoScroll(),this.scene.input.off("pointerdown",this.handlePointerDown,this),this.scene.input.off("pointermove",this.handlePointerMove,this),this.scene.input.off("pointerup",this.handlePointerUp,this),window.removeEventListener("pointerup",this.boundWindowPointerUp),window.removeEventListener("pointermove",this.boundWindowPointerMove),this.clearVisuals(),this.graphics&&(this.graphics.destroy(),this.graphics=null),this.dragging=null}}class Ar extends G.Scene{parallaxLayers=null;cameraController;playerController;gridOverlay;itemsController;socialsController;npcsController;dialogZoneRenderer;config;minimapSubscription;isShuttingDown=!1;savedCameraPosition=null;get itemManager(){return this.itemsController?.getManager()}resetZoom(){this.cameraController?.resetToFit()}getCameraPosition(){return this.cameraController?.getPosition()??null}setCameraPosition(e,t,s){this.cameraController?.setPosition(e,t,s)}constructor(){super({key:We.BUILDER})}init(e){this.config=e.config,this.savedCameraPosition=e.savedCameraPosition??null}preload(){mn(this),us.preloadAssets(this),Ii.preloadAssets(this),Ci.preloadAssets(this)}create(){this.isShuttingDown=!1,this.initializeScene()}async initializeScene(){vn(this),this.physics.world.setBounds(0,0,this.config.worldWidth,this.config.worldHeight);const t=ze.getCurrentConfig().groundHeight??Ye,s=this.config.worldHeight-t;this.cameraController=new Pr(this,this.config.worldWidth,this.config.worldHeight),this.playerController=new xr(this,this.config.worldWidth,this.config.worldHeight),this.gridOverlay=new Dr(this,this.config.worldWidth,this.config.worldHeight),this.itemsController=new Er(this,s,this.config.worldWidth,this.config.worldHeight),this.socialsController=new Ii(this,this.config.worldWidth,this.config.worldHeight),this.npcsController=new Ci(this,s,this.config.worldWidth,this.config.worldHeight),this.dialogZoneRenderer=new Mr(this,this.config.worldWidth,this.config.worldHeight),this.createBackground(),this.gridOverlay.create(),this.createGroundReference(),await this.playerController.preload(),this.playerController.create(this.config.playerStartX,this.config.playerStartY),this.itemsController.create(this.config.placedItems||[]),this.socialsController.create(this.config.placedSocials||[]),this.npcsController.create(this.config.placedNPCs||[]),this.dialogZoneRenderer.create(),this.cameraController.setup(),this.savedCameraPosition?(this.cameraController.setPosition(this.savedCameraPosition.scrollX,this.savedCameraPosition.scrollY,this.savedCameraPosition.zoom),this.savedCameraPosition=null):this.cameraController.centerOn(this.config.playerStartX,this.config.playerStartY),this.minimapSubscription=Ee.on(be.MINIMAP_NAVIGATE,i=>{this.navigateToPosition(i.worldX,i.worldY)}),this.scale.on("resize",this.handleResize,this),this.events.on("shutdown",this.shutdown,this)}async createBackground(){const e=ze.getCurrentConfig();try{await yn(this,e)}catch(t){console.error("Failed to load background:",t);return}this.parallaxLayers&&(_r(this.parallaxLayers),this.parallaxLayers=null),this.parallaxLayers=Sn(this,this.config.worldWidth,this.config.worldHeight,e)}createGroundReference(){const t=ze.getCurrentConfig().groundHeight??Ye;Mt.createVisualGround(this,{worldWidth:this.config.worldWidth,worldHeight:this.config.worldHeight,height:t})}update(){this.parallaxLayers&&wn(this.parallaxLayers,this.cameras.main);const e=this.config.worldHeight,t=this.data.get("playerSprite");if(t){const a=t.getBounds().bottom,r=ws(a,e);t.setDepth(r)}this.itemManager?.updateAutoDepth(e),this.npcsController?.updateAutoDepth(e),this.itemManager?.updateSelectionVisuals(),this.socialsController?.updateSelectionVisuals(),this.dialogZoneRenderer?.updateSelectionVisuals(),this.npcsController?.update();const s=this.cameras.main;Vn({scrollX:s.worldView.x,scrollY:s.worldView.y,viewWidth:s.width,viewHeight:s.height,worldWidth:this.config.worldWidth,worldHeight:this.config.worldHeight,zoom:s.zoom,playerX:t?.x??this.config.playerStartX,playerY:t?.y??this.config.playerStartY})}navigateToPosition(e,t){this.cameraController.centerOn(e,t)}handleResize(e){!this.cameras?.main||!this.config||(this.cameraController?.handleResize(),this.gridOverlay&&this.gridOverlay.redraw())}shutdown(){this.isShuttingDown||(this.isShuttingDown=!0,this.scale.off("resize",this.handleResize,this),this.minimapSubscription&&this.minimapSubscription.unsubscribe(),this.cameraController&&this.cameraController.destroy(),this.playerController&&this.playerController.destroy(),this.gridOverlay&&this.gridOverlay.destroy(),this.itemsController&&this.itemsController.destroy(),this.socialsController&&this.socialsController.destroy(),this.dialogZoneRenderer&&this.dialogZoneRenderer.destroy(),this.npcsController&&this.npcsController.destroy())}}Hn();class $r{currentLanguage="cs";setLanguage(e){this.currentLanguage=e,localStorage.setItem("language",e)}getLanguage(){const e=localStorage.getItem("language");return(e==="cs"||e==="en")&&(this.currentLanguage=e),this.currentLanguage}toggleLanguage(){return this.currentLanguage=this.currentLanguage==="cs"?"en":"cs",this.setLanguage(this.currentLanguage),this.currentLanguage}}const _n=new $r;let Le=null;function Hr(n){Le=n}function Or(){if(!Le)return console.error("Scene manager not initialized"),null;try{const n=Le.scene.getScene(We.GAME);return typeof n.getMapConfig=="function"?n.getMapConfig():n?.mapConfig||null}catch(n){return console.error("Failed to get map config:",n),null}}function Rr(n){if(!Le)return console.error("Scene manager not initialized"),!1;try{if(!Le.scene.getScene(We.GAME))return console.error("GameScene not found"),!1;Le.scene.stop(We.GAME);const t=jn();return ea(n),Le.scene.start(We.BUILDER,{config:n,savedCameraPosition:t}),!0}catch(e){return console.error("Failed to switch to builder:",e),!1}}function Lr(){if(console.log("[SceneManager] switchToGame called"),!Le)return console.error("Scene manager not initialized"),!1;try{const n=Le.scene.getScene(We.BUILDER);if(n){const e=n.getCameraPosition();e&&Un(e.scrollX,e.scrollY,e.zoom)}return console.log("[SceneManager] Stopping builder scene..."),Le.scene.stop(We.BUILDER),console.log("[SceneManager] Exiting builder mode..."),ta(),console.log("[SceneManager] Starting game scene..."),Le.scene.start(We.GAME,{useBuilderConfig:!0}),console.log("[SceneManager] switchToGame completed successfully"),!0}catch(n){return console.error("Failed to switch to game:",n),!1}}function Nr(){if(!Le){console.error("Scene manager not initialized");return}try{Le.scene.start(We.GAME)}catch(n){console.error("Failed to start game scene:",n)}}var Xr=X('<button class="close-btn svelte-164n75j" title="Close"></button>'),Wr=X('<div class="resize-handle resize-handle-nw svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M9 9L1 1M5 1L1 1L1 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-ne svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M1 9L9 1M5 1L9 1L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-sw svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M9 1L1 9M1 5L1 9L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-se svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M1 1L9 9M9 5L9 9L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>',1),Yr=X("<div><!></div> <!>",1),Br=X('<div data-ui=""><div class="panel-header svelte-164n75j"><span class="panel-title svelte-164n75j"> </span> <!> <div class="header-buttons svelte-164n75j"><button class="minimize-btn svelte-164n75j"> </button> <!></div></div> <!></div>');function $t(n,e){ve(e,!0);const t=()=>N(ct,"$isDraggingInBuilder",s),[s,i]=xe();let a=1e3,r=me(e,"initialRight",3,10),l=me(e,"initialTop",3,60),c=me(e,"width",3,280),d=me(e,"minWidth",3,200),h=me(e,"minHeight",3,100),v=me(e,"maxWidth",3,600),m=me(e,"maxHeight",3,800),P=me(e,"resizable",3,!1),x=me(e,"startMinimized",3,!1),C=me(e,"showClose",3,!1),b=se(Ze(x())),p=se(!1),y=se(Ze({x:0,y:0})),u=se(Ze({width:c(),height:e.height??0})),g=se(!1),I=se(!1),f=se("se"),_=se(Ze({x:0,y:0})),E=se(null),W=se(!1),w=se(Ze(a)),k=se(null),O=se("");function R(){a++,$(w,a,!0)}function H(A,Z,ie){let ke=A;const Ne=window.innerWidth-ie-10;ke>Ne&&(ke=Math.max(10,Ne)),ke<10&&(ke=10);let He=Z;const et=window.innerHeight-40;return He>et&&(He=Math.max(10,et)),He<10&&(He=10),{x:ke,y:He}}De(()=>{if(typeof window>"u"||o(W))return;const A=localStorage.getItem(`panel-state-${e.panelId}`);if(A)try{const Z=JSON.parse(A),ie=P()&&Z.width?Z.width:c(),oe=H(Z.x,Z.y,ie);$(y,oe,!0),P()&&Z.width&&Z.height&&$(u,{width:Z.width,height:Z.height},!0);const _e=P()?{x:oe.x,y:oe.y,width:o(u).width,height:o(u).height}:{x:oe.x,y:oe.y};$(O,JSON.stringify(_e),!0)}catch{$(y,{x:window.innerWidth-c()-r(),y:l()},!0)}else $(y,{x:window.innerWidth-c()-r(),y:l()},!0);$(W,!0)}),De(()=>{if(!o(W))return;const A=P()?{x:o(y).x,y:o(y).y,width:o(u).width,height:o(u).height}:{x:o(y).x,y:o(y).y},Z=JSON.stringify(A);Z!==o(O)&&($(O,Z,!0),localStorage.setItem(`panel-state-${e.panelId}`,Z))}),De(()=>{if(!o(W))return;function A(){if(!o(E))return;const Z=P()?o(u).width:c();let ie=o(y).x,oe=o(y).y,_e=!1;const ke=window.innerWidth-Z;o(y).x>ke&&(ie=Math.max(10,ke),_e=!0);const Ne=window.innerHeight-40;o(y).y>Ne&&(oe=Math.max(10,Ne),_e=!0),o(y).x<0&&(ie=10,_e=!0),o(y).y<0&&(oe=10,_e=!0),_e&&$(y,{x:ie,y:oe},!0)}return window.addEventListener("resize",A),()=>{window.removeEventListener("resize",A)}});function D(){$(b,!o(b))}function Y(){e.onclose?.()}function B(){if(P())if(o(p))o(k)&&($(y,{x:o(k).x,y:o(k).y},!0),$(u,{width:o(k).width,height:o(k).height},!0),$(k,null)),$(p,!1);else{$(k,{x:o(y).x,y:o(y).y,width:o(u).width,height:o(u).height},!0);const A=20,Z=Math.min(v(),window.innerWidth-A*2),ie=Math.min(m(),window.innerHeight-A*2),oe=Math.max(A,(window.innerWidth-Z)/2),_e=Math.max(A,(window.innerHeight-ie)/2);$(y,{x:oe,y:_e},!0),$(u,{width:Z,height:ie},!0),$(p,!0)}}function ee(A){A.target.closest("button")||B()}function z(A){A.target.closest("button")||($(g,!0),$(_,{x:A.clientX-o(y).x,y:A.clientY-o(y).y},!0),A.currentTarget.setPointerCapture(A.pointerId),A.preventDefault())}function V(A){if(!o(g))return;const Z=A.clientX-o(_).x,ie=A.clientY-o(_).y,oe=window.innerWidth-(o(E)?.offsetWidth??c()),_e=window.innerHeight-40;$(y,{x:Math.max(0,Math.min(Z,oe)),y:Math.max(0,Math.min(ie,_e))},!0)}function Q(A){o(g)&&($(g,!1),A.currentTarget.releasePointerCapture(A.pointerId))}function L(A){return Z=>{P()&&($(I,!0),$(f,A,!0),Z.currentTarget.setPointerCapture(Z.pointerId),Z.preventDefault(),Z.stopPropagation())}}function F(A){if(!o(I)||!o(E))return;const Z=o(E).getBoundingClientRect();let ie,oe,_e=o(y).x,ke=o(y).y;const Ne=o(f)==="se"||o(f)==="ne",He=o(f)==="se"||o(f)==="sw";Ne?ie=A.clientX-Z.left:(ie=Z.right-A.clientX,_e=A.clientX),He?oe=A.clientY-Z.top:(oe=Z.bottom-A.clientY,ke=A.clientY);const et=Math.max(d(),Math.min(v(),ie)),tt=Math.max(h(),Math.min(m(),oe));Ne||(_e=Z.right-et,_e<0&&(_e=0)),He||(ke=Z.bottom-tt,ke<0&&(ke=0));const Es=Ne?window.innerWidth-o(y).x-10:Z.right-10,ht=He?window.innerHeight-o(y).y-10:Z.bottom-10,Ts=Math.min(et,Es),ut=Math.min(tt,ht);$(u,{width:Ts,height:ut},!0);let Ot=!1,gt=o(y).x,Qt=o(y).y;!Ne&&ie>=d()&&(gt=Math.max(0,_e),Ot=!0),!He&&oe>=h()&&(Qt=Math.max(0,ke),Ot=!0),Ot&&$(y,{x:gt,y:Qt},!0)}function te(A){o(I)&&($(I,!1),A.currentTarget.releasePointerCapture(A.pointerId))}function le(A){A.stopPropagation()}De(()=>{if(!o(E))return;const A=o(E),Z=oe=>{oe.ctrlKey&&oe.preventDefault(),oe.stopPropagation()},ie=oe=>{oe.preventDefault(),oe.stopPropagation()};return A.addEventListener("wheel",Z,{passive:!1}),A.addEventListener("gesturestart",ie,{passive:!1}),A.addEventListener("gesturechange",ie,{passive:!1}),A.addEventListener("gestureend",ie,{passive:!1}),()=>{A.removeEventListener("wheel",Z),A.removeEventListener("gesturestart",ie),A.removeEventListener("gesturechange",ie),A.removeEventListener("gestureend",ie)}});var re=Br();let ce;re.__pointerdown=A=>{R(),le(A)},re.__click=le;var Se=T(re);Se.__pointerdown=z,Se.__pointermove=V,Se.__pointerup=Q,Se.__dblclick=ee;var de=T(Se),pe=T(de),fe=M(de,2);{var we=A=>{var Z=Ce(),ie=ge(Z);zt(ie,()=>e.headerExtra),S(A,Z)};K(fe,A=>{e.headerExtra&&A(we)})}var Be=M(fe,2),$e=T(Be);$e.__click=D;var Re=T($e),dt=M($e,2);{var Ds=A=>{var Z=Xr();Z.__click=Y,S(A,Z)};K(dt,A=>{C()&&A(Ds)})}var Ht=M(Se,2);{var Pn=A=>{var Z=Yr(),ie=ge(Z);let oe;var _e=T(ie);zt(_e,()=>e.children);var ke=M(ie,2);{var Ne=He=>{var et=Wr(),tt=ge(et),Es=j(()=>L("nw"));tt.__pointerdown=function(...ft){o(Es)?.apply(this,ft)},tt.__pointermove=F,tt.__pointerup=te;var ht=M(tt,2),Ts=j(()=>L("ne"));ht.__pointerdown=function(...ft){o(Ts)?.apply(this,ft)},ht.__pointermove=F,ht.__pointerup=te;var ut=M(ht,2),Ot=j(()=>L("sw"));ut.__pointerdown=function(...ft){o(Ot)?.apply(this,ft)},ut.__pointermove=F,ut.__pointerup=te;var gt=M(ut,2),Qt=j(()=>L("se"));gt.__pointerdown=function(...ft){o(Qt)?.apply(this,ft)},gt.__pointermove=F,gt.__pointerup=te,Xe("pointercancel",tt,te),Xe("pointercancel",ht,te),Xe("pointercancel",ut,te),Xe("pointercancel",gt,te),S(He,et)};K(ke,He=>{P()&&He(Ne)})}U(()=>oe=Ae(ie,1,"panel-body svelte-164n75j",null,oe,{"has-fixed-height":P()&&o(u).height>0})),S(A,Z)};K(Ht,A=>{o(b)||A(Pn)})}Et(re,A=>$(E,A),()=>o(E)),U(()=>{ce=Ae(re,1,"draggable-panel svelte-164n75j",null,ce,{minimized:o(b),maximized:o(p),dragging:o(g),resizing:o(I),resizable:P()}),ae(re,`left: ${o(y).x??""}px; top: ${o(y).y??""}px; width: ${o(b)?"auto":`${P()?o(u).width:c()}px`}; ${P()&&o(u).height>0&&!o(b)?`height: ${o(u).height}px;`:""}${t()?" pointer-events: none;":""} z-index: ${o(w)??""};`),Pe(pe,e.title),ne($e,"title",o(b)?"Expand":"Minimize"),Pe(Re,o(b)?"":"")}),Xe("pointercancel",Se,Q),S(n,re),ye(),i()}qe(["pointerdown","click","pointermove","pointerup","dblclick"]);const Mi=10,Zr=150,Gr=`
  position: fixed;
  pointer-events: none;
  z-index: 10000;
  opacity: 0.9;
  image-rendering: pixelated;
  filter: drop-shadow(3px 3px 0 rgba(0, 0, 0, 0.5));
  background: rgba(26, 26, 46, 0.9);
`,Fr=`
  width: 100%;
  height: 100%;
  object-fit: contain;
  image-rendering: pixelated;
`;function oi(n,e,t){const{previewSize:s,borderColor:i,dataKey:a,eventName:r,onDrop:l}=n,c=s/2,d={startX:0,startY:0,hasMoved:!1,isActivated:!1,pendingKey:null,pendingTarget:null,longPressTimer:null};function h(w,k,O){Ee.emit(r,{[a]:w,canvasX:k,canvasY:O}),l?.()}function v(w,k){const O=document.querySelector("canvas");if(!O)return null;const R=O.getBoundingClientRect();return w>=R.left&&w<=R.right&&k>=R.top&&k<=R.bottom?{canvasX:w-R.left,canvasY:k-R.top}:null}function m(w,k,O){const R=document.createElement("div");return R.className="touch-drag-preview",R.innerHTML=`<img src="${w}" alt="" />`,R.style.cssText=`
      ${Gr}
      top: ${O-c}px;
      left: ${k-c}px;
      width: ${s}px;
      height: ${s}px;
      border: 2px solid ${i};
    `,R.querySelector("img").style.cssText=Fr,document.body.appendChild(R),R}function P(w,k,O){w.style.top=`${O-c}px`,w.style.left=`${k-c}px`}function x(){d.longPressTimer&&(clearTimeout(d.longPressTimer),d.longPressTimer=null),d.pendingKey=null,d.pendingTarget=null,d.isActivated=!1,d.hasMoved=!1}function C(){x();const w=e();w.touchDragElement&&(w.touchDragElement.remove(),t({touchDragElement:null})),t({draggedKey:null}),ss(!1)}function b(w,k){if(!w.dataTransfer)return;t({draggedKey:k}),ss(!0),w.dataTransfer.effectAllowed="copy",w.dataTransfer.setData(a,k);const O=w.target,H=(O.querySelector("[data-drag-preview]")||O.querySelector("img"))?.cloneNode(!0);H&&(H.style.position="absolute",H.style.top="-1000px",H.style.left="-1000px",H.style.zIndex="-1",document.body.appendChild(H),w.dataTransfer.setDragImage(H,c,c),requestAnimationFrame(()=>H.remove()))}function p(){t({draggedKey:null}),ss(!1)}function y(w){w.preventDefault(),w.dataTransfer&&(w.dataTransfer.dropEffect="copy")}function u(w){w.preventDefault();const k=w.dataTransfer?.getData(a);if(!k)return;const O=v(w.clientX,w.clientY);O&&h(k,O.canvasX,O.canvasY)}function g(w,k){if(!d.pendingKey||!d.pendingTarget||d.isActivated)return;d.isActivated=!0,t({draggedKey:d.pendingKey}),ss(!0);const O=d.pendingTarget.querySelector("img");if(O){const R=m(O.src,w,k);t({touchDragElement:R})}}function I(w,k){if(w.touches.length!==1)return;const O=w.touches[0];d.startX=O.clientX,d.startY=O.clientY,d.hasMoved=!1,d.isActivated=!1,d.pendingKey=k,d.pendingTarget=w.currentTarget,d.longPressTimer=setTimeout(()=>{d.pendingKey&&!d.hasMoved&&g(O.clientX,O.clientY)},Zr)}function f(w){const k=w.touches[0],O=k.clientX-d.startX,R=k.clientY-d.startY;if(!d.hasMoved&&(Math.abs(O)>Mi||Math.abs(R)>Mi)&&(d.hasMoved=!0,!d.isActivated)){if(Math.abs(R)>Math.abs(O)){x();return}g(k.clientX,k.clientY)}const H=e();d.isActivated&&H.touchDragElement&&(P(H.touchDragElement,k.clientX,k.clientY),w.preventDefault())}function _(w){const k=e(),O=d.isActivated,R=k.draggedKey;if(O&&R&&d.hasMoved){const H=w.changedTouches[0],D=v(H.clientX,H.clientY);D&&h(R,D.canvasX,D.canvasY)}C()}function E(){const w=document.querySelector("canvas");return w?(w.addEventListener("dragover",y),w.addEventListener("drop",u),()=>{w.removeEventListener("dragover",y),w.removeEventListener("drop",u)}):()=>{}}function W(){return document.addEventListener("touchmove",f,{passive:!1}),document.addEventListener("touchend",_),document.addEventListener("touchcancel",_),()=>{document.removeEventListener("touchmove",f),document.removeEventListener("touchend",_),document.removeEventListener("touchcancel",_)}}return{onDragStart:b,onDragEnd:p,onTouchStart:I,setupCanvasListeners:E,setupTouchListeners:W}}var zr=X('<span class="palette-hint svelte-lnmxj4">Drag to place</span>'),Kr=X('<div class="animated-wrapper svelte-lnmxj4" data-drag-preview=""><img class="item-preview animated svelte-lnmxj4"/></div>'),Ur=X('<img class="item-preview svelte-lnmxj4" data-drag-preview=""/>'),jr=X('<div data-ui="" draggable="true" role="button" tabindex="0"><!></div>'),Vr=X('<div class="palette-content svelte-lnmxj4" role="toolbar" tabindex="-1"><div class="palette-grid svelte-lnmxj4"></div></div>');function qr(n,e){ve(e,!0);const t=()=>N(rt,"$isItemPaletteOpen",i),s=()=>N(Oe,"$builderEditMode",i),[i,a]=xe(),r="#4a90e2",l=600,d=ze.getCurrentConfig().itemGroups||["shared"],h=ii.filter(f=>d.includes(f.group));function v(){return window.innerWidth<l}function m(){v()&&rt.set(!1)}let P=se(null),x=se(null);const C=oi({previewSize:48,borderColor:r,dataKey:"assetKey",eventName:be.ASSET_DROPPED,onDrop:m},()=>({draggedKey:o(P),touchDragElement:o(x)}),f=>{"draggedKey"in f&&$(P,f.draggedKey??null,!0),"touchDragElement"in f&&$(x,f.touchDragElement??null,!0)});function b(f){f.stopPropagation()}function p(){rt.set(!1)}function y(f){const _=document.querySelector("canvas");if(!_)return;const E=_.getBoundingClientRect(),W=E.width/2,w=E.height/2;Ee.emit(be.ASSET_DROPPED,{assetKey:f,canvasX:W,canvasY:w}),m()}Ss(()=>C.setupCanvasListeners()),De(()=>C.setupTouchListeners());var u=Ce(),g=ge(u);{var I=f=>{$t(f,{panelId:"item-palette",title:"Items",initialRight:10,initialTop:60,width:280,height:400,minWidth:200,minHeight:160,maxWidth:500,maxHeight:600,resizable:!0,showClose:!0,onclose:p,headerExtra:E=>{var W=zr();S(E,W)},children:(E,W)=>{var w=Vr();w.__pointerdown=b;var k=T(w);je(k,21,()=>h,Ve,(O,R)=>{var H=jr();let D;H.__touchstart=z=>C.onTouchStart(z,o(R).key),H.__dblclick=()=>y(o(R).key),ae(H,"",{},{"--accent-color":r});var Y=T(H);{var B=z=>{const V=j(()=>zs(o(R).key));var Q=Kr();let L;var F=T(Q);let te;U(()=>{L=ae(Q,"",L,{width:`${o(V)?.frameWidth??""}px`,height:`${o(V)?.frameHeight??""}px`}),ne(F,"src",o(R).path),ne(F,"alt",o(R).name),te=ae(F,"",te,{width:`${o(V)?.frameWidth??""}px`,height:`${o(V)?.frameHeight??""}px`,"object-fit":"none","object-position":"0 0"})}),S(z,Q)},ee=z=>{var V=Ur();U(()=>{ne(V,"src",o(R).path),ne(V,"alt",o(R).name)}),S(z,V)};K(Y,z=>{Fs(o(R).key)?z(B):z(ee,!1)})}U(()=>{D=Ae(H,1,"palette-item svelte-lnmxj4",null,D,{dragging:o(P)===o(R).key}),ne(H,"title",`${o(R).name??""} (double-click to place)`)}),Xe("dragstart",H,z=>C.onDragStart(z,o(R).key)),Xe("dragend",H,function(...z){C.onDragEnd?.apply(this,z)}),S(O,H)}),S(E,w)},$$slots:{headerExtra:!0,default:!0}})};K(g,f=>{t()&&s()==="items"&&f(I)})}S(n,u),ye(),a()}qe(["pointerdown","touchstart","dblclick"]);var Jr=X('<span class="palette-hint svelte-4tctcn">Drag to place</span>'),Qr=X('<div data-ui="" draggable="true" role="button" tabindex="0"><img class="item-preview svelte-4tctcn"/> <span class="item-name svelte-4tctcn"> </span></div>'),eo=X('<div class="palette-content svelte-4tctcn" role="toolbar" tabindex="-1"><div class="palette-grid svelte-4tctcn"></div></div>');function to(n,e){ve(e,!0);const t=()=>N(nt,"$isSocialPaletteOpen",i),s=()=>N(Oe,"$builderEditMode",i),[i,a]=xe(),r=Cs.SOCIAL.css,l=ps;let c=se(null),d=se(null);const h=oi({previewSize:64,borderColor:r,dataKey:"socialKey",eventName:be.SOCIAL_DROPPED,onDrop:()=>{nt.set(!1)}},()=>({draggedKey:o(c),touchDragElement:o(d)}),p=>{"draggedKey"in p&&$(c,p.draggedKey??null,!0),"touchDragElement"in p&&$(d,p.touchDragElement??null,!0)});function v(p){p.stopPropagation()}function m(){nt.set(!1)}function P(p){const y=document.querySelector("canvas");if(!y)return;const u=y.getBoundingClientRect(),g=u.width/2,I=u.height/2;Ee.emit(be.SOCIAL_DROPPED,{socialKey:p,canvasX:g,canvasY:I}),nt.set(!1)}Ss(()=>h.setupCanvasListeners()),De(()=>h.setupTouchListeners());var x=Ce(),C=ge(x);{var b=p=>{$t(p,{panelId:"social-palette",title:"Socials",initialRight:10,initialTop:60,width:280,height:350,minWidth:200,minHeight:200,maxWidth:500,maxHeight:500,resizable:!0,showClose:!0,onclose:m,headerExtra:u=>{var g=Jr();S(u,g)},children:(u,g)=>{var I=eo();I.__pointerdown=v;var f=T(I);je(f,21,()=>l,Ve,(_,E)=>{var W=Qr();let w;W.__touchstart=D=>h.onTouchStart(D,o(E).key),W.__dblclick=()=>P(o(E).key);let k;var O=T(W),R=M(O,2),H=T(R);U(()=>{w=Ae(W,1,"palette-item svelte-4tctcn",null,w,{dragging:o(c)===o(E).key}),ne(W,"title",`${o(E).name??""} (double-click to place)`),k=ae(W,"",k,{"--accent-color":r}),ne(O,"src",o(E).path),ne(O,"alt",o(E).name),Pe(H,o(E).name)}),Xe("dragstart",W,D=>h.onDragStart(D,o(E).key)),Xe("dragend",W,function(...D){h.onDragEnd?.apply(this,D)}),S(_,W)}),S(u,I)},$$slots:{headerExtra:!0,default:!0}})};K(C,p=>{t()&&s()==="socials"&&p(b)})}S(n,x),ye(),a()}qe(["pointerdown","touchstart","dblclick"]);var so=X('<span class="palette-hint svelte-1tjg0mk">Drag to place</span>'),io=X("<button> </button>"),no=X('<div data-ui="" draggable="true" role="button" tabindex="0"><div class="animated-wrapper svelte-1tjg0mk" data-drag-preview=""><img class="item-preview animated svelte-1tjg0mk"/></div> <span class="npc-name svelte-1tjg0mk"> </span></div>'),ao=X('<div class="palette-content svelte-1tjg0mk" role="toolbar" tabindex="-1"><div class="category-tabs svelte-1tjg0mk"></div> <div class="palette-grid svelte-1tjg0mk"></div></div>');function ro(n,e){ve(e,!0);const t=()=>N(ot,"$isNPCPaletteOpen",i),s=()=>N(Oe,"$builderEditMode",i),[i,a]=xe(),r="#e67e22",l=600,c=[{id:"humans",label:"Humans"},{id:"fantasy",label:"Fantasy"}];let d=se("humans");const h=j(()=>ni.filter(f=>f.category===o(d)));function v(){return window.innerWidth<l}function m(){v()&&ot.set(!1)}let P=se(null),x=se(null);const C=oi({previewSize:48,borderColor:r,dataKey:"assetKey",eventName:be.NPC_DROPPED,onDrop:m},()=>({draggedKey:o(P),touchDragElement:o(x)}),f=>{"draggedKey"in f&&$(P,f.draggedKey??null,!0),"touchDragElement"in f&&$(x,f.touchDragElement??null,!0)});function b(f){f.stopPropagation()}function p(){Fi()}function y(f){const _=document.querySelector("canvas");if(!_)return;const E=_.getBoundingClientRect(),W=E.width/2,w=E.height/2;Ee.emit(be.NPC_DROPPED,{assetKey:f,canvasX:W,canvasY:w}),ot.set(!1)}Ss(()=>C.setupCanvasListeners()),De(()=>C.setupTouchListeners());var u=Ce(),g=ge(u);{var I=f=>{$t(f,{panelId:"npc-palette",title:"NPCs",initialRight:10,initialTop:60,width:280,height:400,minWidth:200,minHeight:160,maxWidth:500,maxHeight:600,resizable:!0,showClose:!0,onclose:p,headerExtra:E=>{var W=so();S(E,W)},children:(E,W)=>{var w=ao();w.__pointerdown=b;var k=T(w);je(k,21,()=>c,Ve,(R,H)=>{var D=io();let Y;D.__click=()=>$(d,o(H).id,!0);var B=T(D);U(()=>{Y=Ae(D,1,"category-tab svelte-1tjg0mk",null,Y,{active:o(d)===o(H).id}),Pe(B,o(H).label)}),S(R,D)});var O=M(k,2);je(O,21,()=>o(h),Ve,(R,H)=>{var D=no();let Y;D.__touchstart=F=>C.onTouchStart(F,o(H).id),D.__dblclick=()=>y(o(H).id),ae(D,"",{},{"--accent-color":r});var B=T(D);let ee;var z=T(B);let V;var Q=M(B,2),L=T(Q);U(()=>{Y=Ae(D,1,"palette-item svelte-1tjg0mk",null,Y,{dragging:o(P)===o(H).id}),ne(D,"title",`${o(H).name??""} (double-click to place)`),ee=ae(B,"",ee,{width:`${o(H).frameWidth??""}px`,height:`${o(H).frameHeight??""}px`}),ne(z,"src",o(H).path),ne(z,"alt",o(H).name),V=ae(z,"",V,{width:`${o(H).frameWidth??""}px`,height:`${o(H).frameHeight??""}px`,"object-fit":"none","object-position":"0 0"}),Pe(L,o(H).name)}),Xe("dragstart",D,F=>C.onDragStart(F,o(H).id)),Xe("dragend",D,function(...F){C.onDragEnd?.apply(this,F)}),S(R,D)}),S(E,w)},$$slots:{headerExtra:!0,default:!0}})};K(g,f=>{t()&&s()==="npcs"&&f(I)})}S(n,u),ye(),a()}qe(["pointerdown","click","touchstart","dblclick"]);var oo=X("<button> </button>"),lo=X('<div class="language-tabs svelte-1hfe466"></div>');function bn(n,e){ve(e,!0);let t=me(e,"accentColor",3,"#88ddff");var s=lo();je(s,21,()=>ia,Ve,(i,a)=>{var r=oo();let l;r.__click=()=>e.onselect(o(a).code);let c;var d=T(r);U(()=>{l=Ae(r,1,"lang-tab svelte-1hfe466",null,l,{active:e.selectedLanguage===o(a).code}),c=ae(r,"",c,{"--accent-color":t()}),Pe(d,o(a).label)}),S(i,r)}),S(n,s),ye()}qe(["click"]);var co=X("<button></button>"),ho=X('<div class="color-picker svelte-wbnbhn"></div>'),uo=X('<div class="color-section svelte-wbnbhn"><span class="color-label-title svelte-wbnbhn"> </span> <button class="color-button svelte-wbnbhn" title="Change color"><span class="color-preview svelte-wbnbhn"></span> <span class="color-label svelte-wbnbhn">Change</span></button> <!></div>');function go(n,e){ve(e,!0);let t=me(e,"label",3,"Color"),s=me(e,"accentColor",3,"#88ddff"),i=se(!1),a=se(null);De(()=>{o(i)&&o(a)&&requestAnimationFrame(()=>{o(a)?.scrollIntoView({behavior:"smooth",block:"nearest"})})});function r(p){e.onselect(p)}function l(){$(i,!o(i))}var c=uo(),d=T(c),h=T(d),v=M(d,2);v.__click=l;let m;var P=T(v);let x;var C=M(v,2);{var b=p=>{var y=ho();je(y,21,()=>e.colors,Ve,(u,g)=>{var I=co();let f;I.__click=()=>r(o(g));let _;U(()=>{f=Ae(I,1,"color-swatch svelte-wbnbhn",null,f,{selected:e.selectedColor===o(g)}),ne(I,"title",o(g)),_=ae(I,"",_,{background:o(g),"--accent-color":s()})}),S(u,I)}),Et(y,u=>$(a,u),()=>o(a)),S(p,y)};K(C,p=>{o(i)&&p(b)})}U(()=>{Pe(h,t()),m=ae(v,"",m,{"--accent-color":s()}),x=ae(P,"",x,{background:e.selectedColor})}),S(n,c),ye()}qe(["click"]);const vs=400,fo=400,In=70;var po=X('<div class="form-section svelte-vzwc0p"><div class="form-group svelte-vzwc0p"><label class="svelte-vzwc0p"> </label> <textarea rows="6" class="svelte-vzwc0p"></textarea></div></div>');function mo(n,e){ve(e,!0);let t=me(e,"contentPlaceholder",3,"Enter text..."),s=me(e,"idPrefix",3,"text-form"),i=me(e,"accentColor",3,"#88ddff");function a(m){const P=m.target;e.oncontentchange(P.value)}var r=po();let l;var c=T(r),d=T(c),h=T(d),v=M(d,2);v.__input=a,U(()=>{l=ae(r,"",l,{"--accent-color":i()}),ne(d,"for",`${s()??""}-content`),Pe(h,`Content (max ${vs} chars)`),ne(v,"id",`${s()??""}-content`),cs(v,e.content),ne(v,"placeholder",t()),ne(v,"maxlength",vs)}),S(n,r),ye()}qe(["input"]);var vo=X('<div class="panel-content svelte-7qe9ti"><!> <!> <div class="panel-extras svelte-7qe9ti"><!></div> <div class="panel-footer svelte-7qe9ti"><!> <!></div></div>');function yo(n,e){ve(e,!0);const t=()=>N(ei,"$dialogZones",a),s=()=>N(Is,"$selectedDialogZoneId",a),i=()=>N(_s,"$isDialogZonePanelOpen",a),[a,r]=xe(),l="#88ddff";let c=se(Ze(Yi)),d=j(()=>t().find(u=>u.id===s())??null),h=j(()=>o(d)?.texts.find(u=>u.language===o(c))??null);function v(u){s()&&ya(s(),o(c),{content:u})}function m(){s()&&(Qi(s()),ci())}function P(){ci()}function x(u){s()&&bt(s(),{color:u})}function C(u){$(c,u,!0)}var b=Ce(),p=ge(b);{var y=u=>{$t(u,{panelId:"dialog-zone-panel",title:"Dialog Zone",initialRight:10,initialTop:160,width:280,height:450,minWidth:250,minHeight:370,maxWidth:500,maxHeight:700,resizable:!0,showClose:!0,onclose:P,children:(g,I)=>{var f=vo(),_=T(f);bn(_,{get selectedLanguage(){return o(c)},onselect:C,accentColor:l});var E=M(_,2);{let H=j(()=>o(h)?.content??"");mo(E,{get content(){return o(H)},oncontentchange:v,contentPlaceholder:"Enter dialog text...",idPrefix:"dialog",accentColor:l})}var W=M(E,2),w=T(W);go(w,{get colors(){return Us},get selectedColor(){return o(d).color},onselect:x,label:"Zone Color",accentColor:l});var k=M(W,2),O=T(k);he(O,{variant:"cyan",onclick:P,children:(H,D)=>{var Y=ue("CONFIRM");S(H,Y)},$$slots:{default:!0}});var R=M(O,2);he(R,{variant:"red",onclick:m,children:(H,D)=>{var Y=ue("DELETE");S(H,Y)},$$slots:{default:!0}}),S(g,f)},$$slots:{default:!0}})};K(p,u=>{o(d)&&i()&&u(y)})}S(n,b),ye(),r()}var So=X("<button> </button>"),wo=X('<a target="_blank" rel="noopener noreferrer" class="url-preview svelte-6kd0po">Test link </a>'),_o=X('<button><img class="svelte-6kd0po"/></button>'),bo=X('<div class="style-picker svelte-6kd0po"></div>'),Io=X('<div class="panel-content svelte-6kd0po"><div class="social-size-row svelte-6kd0po"><div class="social-size-section svelte-6kd0po"><span class="section-label svelte-6kd0po">Size</span> <div class="size-buttons svelte-6kd0po"></div></div></div> <div class="panel-extras svelte-6kd0po"><div class="url-section svelte-6kd0po"><label for="social-url" class="svelte-6kd0po">Link URL (opens on click)</label> <input id="social-url" type="url" placeholder="https://example.com" class="svelte-6kd0po"/> <!></div> <div class="style-section svelte-6kd0po"><span class="section-label svelte-6kd0po">Social Icon</span> <button class="style-button svelte-6kd0po" title="Change social icon"><img alt="Current social" class="style-preview svelte-6kd0po"/> <span class="style-label svelte-6kd0po"> </span></button> <!></div></div> <div class="panel-footer svelte-6kd0po"><!> <!></div></div>');function Co(n,e){ve(e,!0);const t=()=>N(pa,"$selectedSocial",a),s=()=>N(Ut,"$selectedSocialId",a),i=()=>N(Jt,"$isSocialPanelOpen",a),[a,r]=xe(),l=Cs.SOCIAL.css;let c=j(t),d=j(()=>o(c)?lr(o(c).scale??Dt):"M"),h=j(()=>o(c)?ps.find(_=>_.key===o(c).socialKey):null);function v(_){const E=_.target;s()&&rs(s(),{url:E.value||void 0})}function m(_){s()&&rs(s(),{scale:or(_)})}function P(){s()&&qi(s())}function x(){oa(),Yt(null)}let C=se(!1),b=se(null),p=se(null);function y(_){s()&&rs(s(),{socialKey:_})}function u(){$(C,!o(C))}De(()=>{o(C)&&o(b)&&requestAnimationFrame(()=>{o(b)?.scrollIntoView({behavior:"smooth",block:"nearest"})})}),De(()=>{if(!o(C))return;function _(E){const W=E.target;o(b)&&!o(b).contains(W)&&o(p)&&!o(p).contains(W)&&$(C,!1)}return document.addEventListener("click",_),()=>document.removeEventListener("click",_)});var g=Ce(),I=ge(g);{var f=_=>{$t(_,{panelId:"social-panel",title:"Edit Social",initialRight:10,initialTop:160,width:280,height:350,minWidth:250,minHeight:300,maxWidth:400,maxHeight:500,resizable:!0,showClose:!0,onclose:x,children:(E,W)=>{var w=Io(),k=T(w),O=T(k),R=M(T(O),2);je(R,21,()=>Object.entries(Vt),Ve,(de,pe)=>{var fe=j(()=>On(o(pe),2));let we=()=>o(fe)[0],Be=()=>o(fe)[1].label;var $e=So();let Re;$e.__click=()=>m(we());var dt=T($e);U(()=>{Re=Ae($e,1,"size-btn svelte-6kd0po",null,Re,{active:o(d)===we()}),ne($e,"title",Be()),Pe(dt,we())}),S(de,$e)});var H=M(k,2),D=T(H),Y=M(T(D),2);Y.__input=v;var B=M(Y,2);{var ee=de=>{var pe=wo();U(()=>ne(pe,"href",o(c).url)),S(de,pe)};K(B,de=>{o(c).url&&de(ee)})}var z=M(D,2),V=M(T(z),2);V.__click=u;var Q=T(V),L=M(Q,2),F=T(L);Et(V,de=>$(p,de),()=>o(p));var te=M(V,2);{var le=de=>{var pe=bo();je(pe,21,()=>ps,Ve,(fe,we)=>{var Be=_o();let $e;Be.__click=()=>y(o(we).key);var Re=T(Be);U(()=>{$e=Ae(Be,1,"style-item svelte-6kd0po",null,$e,{selected:o(c).socialKey===o(we).key}),ne(Be,"title",o(we).name),ne(Re,"src",o(we).path),ne(Re,"alt",o(we).name)}),S(fe,Be)}),Et(pe,fe=>$(b,fe),()=>o(b)),S(de,pe)};K(te,de=>{o(C)&&de(le)})}var re=M(H,2),ce=T(re);he(ce,{variant:"pink",onclick:x,children:(de,pe)=>{var fe=ue("CONFIRM");S(de,fe)},$$slots:{default:!0}});var Se=M(ce,2);he(Se,{variant:"red",onclick:P,children:(de,pe)=>{var fe=ue("DELETE");S(de,fe)},$$slots:{default:!0}}),U(()=>{ae(w,`--accent-color: ${l}`),cs(Y,o(c).url??""),ne(Q,"src",o(h)?.path??""),Pe(F,o(h)?.name??"Select")}),S(E,w)},$$slots:{default:!0}})};K(I,_=>{i()&&o(c)&&_(f)})}S(n,g),ye(),r()}qe(["click","input"]);var Po=X('<div class="panel-content svelte-j84kgd"><!> <div class="form-section svelte-j84kgd"><div class="form-group svelte-j84kgd"><label for="npc-content" class="svelte-j84kgd"> </label> <textarea id="npc-content" placeholder="Enter dialog text..." rows="8" class="svelte-j84kgd"></textarea></div> <div class="form-group slider-group svelte-j84kgd"><label for="npc-trigger-radius" class="svelte-j84kgd">Trigger Radius</label> <input type="range" id="npc-trigger-radius" step="100" class="svelte-j84kgd"/></div></div> <div class="panel-footer svelte-j84kgd"><!> <!></div></div>');function xo(n,e){ve(e,!0);const t=()=>N(ti,"$selectedNPC",i),s=()=>N(qt,"$isNPCConfigPanelOpen",i),[i,a]=xe(),r="#e67e22",l=200,c=100,d=500;let h=se(Ze(Yi)),v=j(()=>t()?.dialog?.find(f=>f.language===o(h))??null),m=j(()=>t()?gs(t().npcId)?.name??t().npcId:"NPC"),P=j(()=>t()?.triggerRadius??l);function x(f){if(!t())return;const _=f.target;ba(t().id,o(h),{content:_.value})}function C(f){if(!t())return;const _=f.target;si(t().id,{triggerRadius:parseInt(_.value,10)})}function b(){t()&&tn(t().id)}function p(){ra(),At()}function y(f){$(h,f,!0)}var u=Ce(),g=ge(u);{var I=f=>{$t(f,{panelId:"npc-config-panel",get title(){return o(m)},initialRight:10,initialTop:160,width:280,height:450,minWidth:250,minHeight:370,maxWidth:500,maxHeight:700,resizable:!0,showClose:!0,onclose:p,children:(_,E)=>{var W=Po(),w=T(W);bn(w,{get selectedLanguage(){return o(h)},onselect:y,accentColor:r});var k=M(w,2);ae(k,"",{},{"--accent-color":r});var O=T(k),R=T(O),H=T(R),D=M(R,2);D.__input=x;var Y=M(O,2),B=M(T(Y),2);ne(B,"min",c),ne(B,"max",d),B.__input=C;var ee=M(k,2),z=T(ee);he(z,{variant:"cyan",onclick:p,children:(Q,L)=>{var F=ue("CONFIRM");S(Q,F)},$$slots:{default:!0}});var V=M(z,2);he(V,{variant:"red",onclick:b,children:(Q,L)=>{var F=ue("DELETE");S(Q,F)},$$slots:{default:!0}}),U(()=>{Pe(H,`Content (max ${vs} chars)`),cs(D,o(v)?.content??""),ne(D,"maxlength",vs),cs(B,o(P))}),S(_,W)},$$slots:{default:!0}})};K(g,f=>{s()&&t()&&f(I)})}S(n,u),ye(),a()}qe(["input"]);var Do=X('<div class="temp-zone-button svelte-1vrg7di"><!></div>');function Eo(n,e){ve(e,!0);const t=()=>N(Ni,"$builderCameraInfo",a),s=()=>N(Oe,"$builderEditMode",a),i=()=>N(ct,"$isDraggingInBuilder",a),[a,r]=xe();let l=se(null),c=null,d=null,h=se(null);function v(p){c&&clearTimeout(c),$(l,p,!0),$(h,t()?.scrollX??null,!0),c=setTimeout(()=>{$(l,null),$(h,null)},2e3)}function m(){o(l)&&(Ee.emit(be.DIALOG_ZONE_CREATE_AT,{worldX:o(l).worldX}),$(l,null),$(h,null),c&&(clearTimeout(c),c=null))}function P(){$(l,null),$(h,null),c&&(clearTimeout(c),c=null)}Ss(()=>{d=Ee.on(be.TEMP_ZONE_BUTTON_SHOW,v);const p=Ee.on(be.TEMP_ZONE_BUTTON_HIDE,P);return()=>{d?.unsubscribe(),p.unsubscribe()}}),Rn(()=>{c&&clearTimeout(c)}),De(()=>{s()!=="dialogs"&&($(l,null),$(h,null))}),De(()=>{const p=t()?.scrollX;o(l)&&o(h)!==null&&p!==void 0&&Math.abs(p-o(h))>10&&($(l,null),$(h,null),c&&(clearTimeout(c),c=null))});var x=Ce(),C=ge(x);{var b=p=>{var y=Do(),u=T(y);he(u,{variant:"cyan",width:"90px",onclick:m,children:(g,I)=>{var f=ue("+ ZONE");S(g,f)},$$slots:{default:!0}}),U(()=>ae(y,`left: ${o(l).screenX??""}px; top: ${o(l).screenY-50}px;${i()?" pointer-events: none;":""}`)),S(p,y)};K(C,p=>{o(l)&&s()==="dialogs"&&p(b)})}S(n,x),ye(),r()}var To=X('<div class="item-controls svelte-1529z5h"><div class="controls-row svelte-1529z5h"><!> <!> <!></div></div>');function ko(n,e){ve(e,!0);const t=()=>N(Qs,"$selectedItem",d),s=()=>N(ji,"$selectedItemScreenPosition",d),i=()=>N(Tt,"$selectedItemId",d),a=()=>N(la,"$selectedItemPhysicsEnabled",d),r=()=>N(ca,"$selectedItemFlipX",d),l=()=>N(Oe,"$builderEditMode",d),c=()=>N(ct,"$isDraggingInBuilder",d),[d,h]=xe();let v=j(()=>t()?Da(t().assetKey):!1),m=j(()=>{const u=s();if(!u)return null;const g=10,I=40,f=o(v)?290:200;let _=u.screenY-u.itemHeight/2-45;const E=g+I;_<E&&(_=u.screenY+u.itemHeight/2+10);const W=window.innerHeight-I-g;_>W&&(_=W);let w=u.screenX;const k=f/2,O=k+g,R=window.innerWidth-k-g;return w<O&&(w=O),w>R&&(w=R),{x:w,y:_}});function P(){i()&&ua(i(),!a())}function x(){i()&&ga(i(),!r())}function C(){i()&&(ha(i()),At())}var b=Ce(),p=ge(b);{var y=u=>{var g=To(),I=T(g),f=T(I);{let w=j(()=>r()?"orange":"blue");he(f,{get variant(){return o(w)},title:"Flip item horizontally",onclick:x,children:(k,O)=>{var R=ue("Flip");S(k,R)},$$slots:{default:!0}})}var _=M(f,2);{var E=w=>{{let k=j(()=>a()?"orange":"blue");he(w,{get variant(){return o(k)},title:"Toggle physics: item will block player movement",onclick:P,children:(O,R)=>{var H=ue();U(()=>Pe(H,a()?"Ghost":"Solid")),S(O,H)},$$slots:{default:!0}})}};K(_,w=>{o(v)&&w(E)})}var W=M(_,2);he(W,{variant:"red",title:"Delete selected item",onclick:C,children:(w,k)=>{var O=ue("DEL");S(w,O)},$$slots:{default:!0}}),U(()=>ae(g,`left: ${o(m).x??""}px; top: ${o(m).y??""}px;${c()?" pointer-events: none;":""}`)),S(u,g)};K(p,u=>{l()!=="dialogs"&&i()&&o(m)&&u(y)})}S(n,b),ye(),h()}var Mo=X('<div class="npc-controls svelte-wxsibf"><div class="controls-row svelte-wxsibf"><!> <!> <!></div></div>');function Ao(n,e){ve(e,!0);const t=()=>N(en,"$selectedNPCScreenPosition",l),s=()=>N(ti,"$selectedNPC",l),i=()=>N(wa,"$selectedNPCFlipX",l),a=()=>N(Oe,"$builderEditMode",l),r=()=>N(ct,"$isDraggingInBuilder",l),[l,c]=xe();let d=j(()=>{const b=t();if(!b)return null;const p=10,y=40,u=270;let g=b.screenY-b.npcHeight/2-45;const I=p+y;g<I&&(g=b.screenY+b.npcHeight/2+10);const f=window.innerHeight-y-p;g>f&&(g=f);let _=b.screenX;const E=u/2,W=E+p,w=window.innerWidth-E-p;return _<W&&(_=W),_>w&&(_=w),{x:_,y:g}});function h(){s()&&Ia(s().id,!i())}function v(){zi()}function m(){s()&&(tn(s().id),At())}var P=Ce(),x=ge(P);{var C=b=>{var p=Mo(),y=T(p),u=T(y);{let f=j(()=>i()?"orange":"blue");he(u,{get variant(){return o(f)},title:"Flip NPC horizontally",onclick:h,children:(_,E)=>{var W=ue("Flip");S(_,W)},$$slots:{default:!0}})}var g=M(u,2);he(g,{variant:"cyan",title:"Edit NPC dialog",onclick:v,children:(f,_)=>{var E=ue("EDIT");S(f,E)},$$slots:{default:!0}});var I=M(g,2);he(I,{variant:"red",title:"Delete selected NPC",onclick:m,children:(f,_)=>{var E=ue("DEL");S(f,E)},$$slots:{default:!0}}),U(()=>ae(p,`left: ${o(d).x??""}px; top: ${o(d).y??""}px;${r()?" pointer-events: none;":""}`)),S(b,p)};K(x,b=>{a()!=="dialogs"&&s()&&o(d)&&b(C)})}S(n,P),ye(),c()}var $o=X('<div class="zone-controls svelte-7umuek"><div class="controls-row svelte-7umuek"><!> <!> <!></div></div>');function Ho(n,e){ve(e,!0);const t=()=>N(Ji,"$selectedDialogZoneScreenPosition",r),s=()=>N(Is,"$selectedDialogZoneId",r),i=()=>N(Oe,"$builderEditMode",r),a=()=>N(ct,"$isDraggingInBuilder",r),[r,l]=xe();let c=j(()=>{const C=t();if(!C)return null;const b=10,p=120,y=85;let u=C.screenY;const g=b+p/2,I=window.innerHeight-p/2-b;u<g&&(u=g),u>I&&(u=I);let f=C.screenX;const _=y/2,E=_+b,W=window.innerWidth-_-b;return f<E&&(f=E),f>W&&(f=W),{x:f,y:u}});function d(){Ui()}function h(){s()&&(Qi(s()),Bt(null))}function v(){Bt(null)}var m=Ce(),P=ge(m);{var x=C=>{var b=$o(),p=T(b),y=T(p);he(y,{variant:"cyan",title:"Edit zone content (or double-click)",onclick:d,children:(I,f)=>{var _=ue("EDIT");S(I,_)},$$slots:{default:!0}});var u=M(y,2);he(u,{variant:"red",title:"Delete selected zone",onclick:h,children:(I,f)=>{var _=ue("DEL");S(I,_)},$$slots:{default:!0}});var g=M(u,2);he(g,{variant:"default",title:"Deselect zone",onclick:v,children:(I,f)=>{var _=ue("DONE");S(I,_)},$$slots:{default:!0}}),U(()=>ae(b,`left: ${o(c).x??""}px; top: ${o(c).y??""}px;${a()?" pointer-events: none;":""}`)),S(C,b)};K(P,C=>{i()==="dialogs"&&s()&&o(c)&&C(x)})}S(n,m),ye(),l()}var Oo=X('<div class="social-controls svelte-q16c5x"><div class="controls-row svelte-q16c5x"><!> <!></div></div>');function Ro(n,e){ve(e,!0);const t=()=>N(Vi,"$selectedSocialScreenPosition",r),s=()=>N(Ut,"$selectedSocialId",r),i=()=>N(Oe,"$builderEditMode",r),a=()=>N(ct,"$isDraggingInBuilder",r),[r,l]=xe();let c=j(()=>{const x=t();if(!x)return null;const C=10,b=40,p=190;let y=x.screenY-x.socialHeight/2-45;const u=C+b;y<u&&(y=x.screenY+x.socialHeight/2+10);const g=window.innerHeight-b-C;y>g&&(y=g);let I=x.screenX;const f=p/2,_=f+C,E=window.innerWidth-f-C;return I<_&&(I=_),I>E&&(I=E),{x:I,y}});function d(){Ki()}function h(){s()&&(qi(s()),Yt(null))}var v=Ce(),m=ge(v);{var P=x=>{var C=Oo(),b=T(C),p=T(b);he(p,{variant:"pink",title:"Edit social settings (or double-click)",onclick:d,children:(u,g)=>{var I=ue("EDIT");S(u,I)},$$slots:{default:!0}});var y=M(p,2);he(y,{variant:"red",title:"Delete selected social",onclick:h,children:(u,g)=>{var I=ue("DEL");S(u,I)},$$slots:{default:!0}}),U(()=>ae(C,`left: ${o(c).x??""}px; top: ${o(c).y??""}px;${a()?" pointer-events: none;":""}`)),S(x,C)};K(m,x=>{i()!=="dialogs"&&s()&&o(c)&&x(P)})}S(n,v),ye(),l()}var Lo=X('<div class="hstack svelte-13tonpt"><!></div>');function No(n,e){let t=me(e,"gap",3,"10px"),s=me(e,"align",3,"center");var i=Lo(),a=T(i);zt(a,()=>e.children??Fe),U(()=>ae(i,`gap: ${t()??""}; align-items: ${(s()==="start"?"flex-start":s()==="end"?"flex-end":s())??""};`)),S(n,i)}var Xo=X('<div class="vstack svelte-eir7yr"><!></div>');function Wo(n,e){let t=me(e,"gap",3,"10px"),s=me(e,"align",3,"stretch");var i=Xo(),a=T(i);zt(a,()=>e.children??Fe),U(()=>ae(i,`gap: ${t()??""}; align-items: ${(s()==="start"?"flex-start":s()==="end"?"flex-end":s())??""};`)),S(n,i)}var Yo=X("<div><!></div>");function ys(n,e){const t=()=>N(ct,"$isDraggingInBuilder",s),[s,i]=xe();let a=me(e,"padding",3,"10px");var r=Yo();let l;var c=T(r);zt(c,()=>e.children??Fe),U(()=>{l=Ae(r,1,`fixed fixed--${e.position??""}`,"svelte-cx4lc",l,{"dragging-in-builder":t()}),ae(r,`--padding: ${a()??""};`)}),S(n,r),i()}var Bo=X("<div><!> <!></div>"),Zo=X("<!> <!>",1),Go=X("<!> <!> <!> <!>",1),Fo=X("<div><!></div>"),zo=X("<!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!>",1);function Ko(n,e){ve(e,!0);const t=()=>N(Tt,"$selectedItemId",h),s=()=>N(Is,"$selectedDialogZoneId",h),i=()=>N(Ut,"$selectedSocialId",h),a=()=>N(Oe,"$builderEditMode",h),r=()=>N(ds,"$gridSnappingEnabled",h),l=()=>N(rt,"$isItemPaletteOpen",h),c=()=>N(nt,"$isSocialPaletteOpen",h),d=()=>N(ot,"$isNPCPaletteOpen",h),[h,v]=xe(),m=600;let P=se(Ze(typeof window<"u"?window.innerWidth<m:!1)),x=j(()=>o(P)&&(t()!==null||s()!==null||i()!==null));De(()=>{function B(){$(P,window.innerWidth<m)}return window.addEventListener("resize",B),()=>window.removeEventListener("resize",B)});function C(B){const ee=B.target;ee.closest(".draggable-panel")||ee.tagName!=="CANVAS"&&(rt.set(!1),nt.set(!1),ot.set(!1),Jt.set(!1),_s.set(!1),qt.set(!1))}De(()=>(window.addEventListener("dblclick",C),()=>window.removeEventListener("dblclick",C)));function b(){console.log("[BuilderUI] handleSave called, switching to game...");const B=Lr();console.log("[BuilderUI] switchToGame result:",B)}function p(){Qn()}function y(){Ee.emit(be.DIALOG_ZONE_CREATE)}var u=zo(),g=ge(u);ko(g,{});var I=M(g,2);Ao(I,{});var f=M(I,2);Ho(f,{});var _=M(f,2);Ro(_,{});var E=M(_,2);{var W=B=>{qr(B,{})},w=B=>{var ee=Ce(),z=ge(ee);{var V=L=>{yo(L,{})},Q=L=>{var F=Ce(),te=ge(F);{var le=ce=>{to(ce,{})},re=ce=>{var Se=Ce(),de=ge(Se);{var pe=fe=>{ro(fe,{})};K(de,fe=>{a()==="npcs"&&fe(pe)},!0)}S(ce,Se)};K(te,ce=>{a()==="socials"?ce(le):ce(re,!1)},!0)}S(L,F)};K(z,L=>{a()==="dialogs"?L(V):L(Q,!1)},!0)}S(B,ee)};K(E,B=>{a()==="items"?B(W):B(w,!1)})}var k=M(E,2);Co(k,{});var O=M(k,2);xo(O,{});var R=M(O,2);Eo(R,{});var H=M(R,2),D=M(H,2);ys(D,{position:"top-left",children:(B,ee)=>{var z=Bo();let V;var Q=T(z);he(Q,{variant:"green",width:"100px",onclick:b,children:(F,te)=>{var le=ue("SAVE");S(F,le)},$$slots:{default:!0}});var L=M(Q,2);{let F=j(()=>r()?"blue":"orange");he(L,{get variant(){return o(F)},width:"80px",onclick:p,title:"Toggle grid snapping",children:(te,le)=>{var re=ue();U(()=>Pe(re,r()?"FREE":"SNAP")),S(te,re)},$$slots:{default:!0}})}U(()=>V=Ae(z,1,"left-buttons svelte-1lbkour",null,V,{"hide-left":o(x)})),S(B,z)},$$slots:{default:!0}});var Y=M(D,2);ys(Y,{position:"top-right",children:(B,ee)=>{var z=Fo();let V;var Q=T(z);Wo(Q,{align:"end",children:(L,F)=>{var te=Go(),le=ge(te);{let de=j(()=>a()==="items"&&l()?"orange":"blue");he(le,{get variant(){return o(de)},onclick:()=>{a()==="items"?na():(Nt("items"),rt.set(!0))},title:"Edit items",children:(pe,fe)=>{var we=ue("ITEMS");S(pe,we)},$$slots:{default:!0}})}var re=M(le,2);{let de=j(()=>a()==="socials"&&c()?"orange":"pink");he(re,{get variant(){return o(de)},onclick:()=>{a()==="socials"?aa():(Nt("socials"),nt.set(!0))},title:"Edit social icons",children:(pe,fe)=>{var we=ue("SOCIALS");S(pe,we)},$$slots:{default:!0}})}var ce=M(re,2);{let de=j(()=>a()==="npcs"&&d()?"orange":"green");he(ce,{get variant(){return o(de)},onclick:()=>{a()==="npcs"?Fi():(Nt("npcs"),ot.set(!0))},title:"Edit NPCs",children:(pe,fe)=>{var we=ue("NPCS");S(pe,we)},$$slots:{default:!0}})}var Se=M(ce,2);No(Se,{children:(de,pe)=>{var fe=Zo(),we=ge(fe);{var Be=Re=>{he(Re,{variant:"cyan",width:"100px",onclick:y,title:"Create new dialog zone at center of view",children:(dt,Ds)=>{var Ht=ue("+ ZONE");S(dt,Ht)},$$slots:{default:!0}})};K(we,Re=>{a()==="dialogs"&&Re(Be)})}var $e=M(we,2);{let Re=j(()=>a()==="dialogs"?"orange":"cyan");he($e,{get variant(){return o(Re)},onclick:()=>{a()==="dialogs"?Nt("items"):Nt("dialogs")},title:"Edit dialog zones",children:(dt,Ds)=>{var Ht=ue("DIALOGS");S(dt,Ht)},$$slots:{default:!0}})}S(de,fe)},$$slots:{default:!0}}),S(L,te)},$$slots:{default:!0}}),U(()=>V=Ae(z,1,"right-buttons svelte-1lbkour",null,V,{"hide-right":o(x)})),S(B,z)},$$slots:{default:!0}}),S(n,u),ye(),v()}var Uo=X('<img class="skin-preview-img svelte-12jgjc8"/>'),jo=X('<canvas width="96" height="96" class="skin-preview svelte-12jgjc8"></canvas>'),Vo=X('<button type="button"><div class="skin-preview-container svelte-12jgjc8"><!></div> <span class="skin-name svelte-12jgjc8"> </span></button>'),qo=X('<span class="custom-icon svelte-12jgjc8"></span>'),Jo=X('<span class="custom-icon svelte-12jgjc8"></span>'),Qo=X('<button class="edit-btn svelte-12jgjc8" type="button">EDIT</button>'),el=X('<button class="background-card svelte-12jgjc8" type="button"><div class="preview-container svelte-12jgjc8"><img class="preview-image svelte-12jgjc8"/></div> <span class="background-name svelte-12jgjc8"> </span></button>'),tl=X('<div class="background-select-screen svelte-12jgjc8"><div class="content svelte-12jgjc8"><h1 class="title svelte-12jgjc8">SELECT CHARACTER</h1> <div class="skins-grid svelte-12jgjc8"><!> <div class="skin-card-wrapper svelte-12jgjc8"><button type="button"><div class="skin-preview-container custom-preview svelte-12jgjc8"><!></div> <span class="skin-name svelte-12jgjc8">CUSTOM</span></button> <!></div></div> <h1 class="title svelte-12jgjc8">SELECT BACKGROUND</h1> <div class="backgrounds-grid svelte-12jgjc8"></div></div></div>');function sl(n,e){ve(e,!0);const t="custom";function s(){window.location.href="./builder.html"}const i=Ue,a=Ie,r=js()!==null,l=localStorage.getItem("useModularPlayer")==="true";let c=se(Ze(l&&r?t:yt.getSkinId())),d=Ze({}),h=Ze({});De(()=>{a.forEach(D=>{const Y=os(D),B=new Image;B.onload=()=>{h[D.id]=!0},B.onerror=()=>{h[D.id]=!1,m(D)},B.src=`./${Y}/preview.png`})});function v(D){return`./${os(D)}/preview.png`}function m(D){const Y=d[D.id];if(!Y)return;const B=Y.getContext("2d");if(!B)return;const ee=D.frameWidth??48,z=D.frameHeight??48,V=os(D),Q=new Image;Q.src=`./${V}/idle.png`,Q.onload=()=>{B.clearRect(0,0,Y.width,Y.height),B.imageSmoothingEnabled=!1;const L=Y.width/ee,F=Y.height/z,te=Math.min(L,F),le=ee*te,re=z*te,ce=(Y.width-le)/2,Se=(Y.height-re)/2;B.drawImage(Q,0,0,ee,z,ce,Se,le,re)}}function P(D){return`./assets/backgrounds/${D}/preview.png`}function x(D){if(D===t){if(!r){s();return}$(c,t),localStorage.setItem("useModularPlayer","true"),Zs.set(t)}else $(c,D,!0),yt.setSkin(D),localStorage.setItem("useModularPlayer","false"),Zs.set(D)}function C(){s()}function b(D){ze.setBackgroundByIndex(D),Bi.set(i[D].name),Zi.set(!0),Nr()}var p=tl(),y=T(p),u=M(T(y),2),g=T(u);je(g,17,()=>a,Ve,(D,Y)=>{var B=Vo();let ee;B.__click=()=>x(o(Y).id);var z=T(B),V=T(z);{var Q=le=>{var re=Uo();U(ce=>{ne(re,"src",ce),ne(re,"alt",o(Y).name)},[()=>v(o(Y))]),S(le,re)},L=le=>{var re=jo();Et(re,(ce,Se)=>d[Se.id]=ce,ce=>d?.[ce.id],()=>[o(Y)]),S(le,re)};K(V,le=>{h[o(Y).id]?le(Q):le(L,!1)})}var F=M(z,2),te=T(F);U(()=>{ee=Ae(B,1,"skin-card svelte-12jgjc8",null,ee,{selected:o(c)===o(Y).id}),Pe(te,o(Y).name)}),S(D,B)});var I=M(g,2),f=T(I);let _;f.__click=()=>x(t);var E=T(f),W=T(E);{var w=D=>{var Y=qo();S(D,Y)},k=D=>{var Y=Jo();S(D,Y)};K(W,D=>{r?D(w):D(k,!1)})}var O=M(f,2);{var R=D=>{var Y=Qo();Y.__click=C,S(D,Y)};K(O,D=>{r&&o(c)===t&&D(R)})}var H=M(u,4);je(H,21,()=>i,Ve,(D,Y,B)=>{var ee=el();ee.__click=()=>b(B);var z=T(ee),V=T(z),Q=M(z,2),L=T(Q);U(F=>{ne(V,"src",F),ne(V,"alt",o(Y).name),Pe(L,o(Y).name)},[()=>P(o(Y).folder)]),S(D,ee)}),U(()=>_=Ae(f,1,"skin-card custom-card svelte-12jgjc8",null,_,{selected:o(c)===t})),S(n,p),ye()}qe(["click"]);var il=X('<div class="dialog-content svelte-hli3ii"> </div>'),nl=X("<div><!></div>");function al(n,e){ve(e,!0);const t=()=>N(Oi,"$playerScreenPosition",i),s=()=>N(fn,"$activeDialogText",i),[i,a]=xe(),r=320,l=20;let c=j(()=>Math.max(10,window.innerHeight-t().y+In)),d=j(()=>window.innerWidth<=fo),h=j(()=>{if(o(d))return window.innerWidth/2;const C=r/2,b=C+l,p=window.innerWidth-C-l;return Math.max(b,Math.min(p,t().x))}),v=j(()=>o(d)?0:t().x-o(h));var m=Ce(),P=ge(m);{var x=C=>{var b=nl();let p;var y=T(b);{var u=g=>{var I=il(),f=T(I);U(()=>Pe(f,s().content)),S(g,I)};K(y,g=>{s().content&&g(u)})}U(()=>{p=Ae(b,1,"dialog-bubble svelte-hli3ii",null,p,{narrow:o(d)}),ae(b,`bottom: ${o(c)??""}px; left: ${o(h)??""}px; --arrow-offset: ${o(v)??""}px;`)}),S(C,b)};K(P,C=>{s()&&C(x)})}S(n,m),ye(),a()}var rl=X('<div class="dialog-content svelte-b2j5a3"> </div>'),ol=X('<div class="npc-dialog-bubble svelte-b2j5a3"><!></div>');function ll(n,e){ve(e,!0);const t=()=>N(fn,"$activeDialogText",a),s=()=>N(ri,"$activeNPCDialog",a),i=()=>N(gr,"$activeNPCDialogText",a),[a,r]=xe(),l=300,c=20,d=120;let h=j(()=>!!t()),v=j(()=>{if(!s())return 0;const p=s().screenY-s().npcHeight/2;let y=Math.max(10,window.innerHeight-p+In);return o(h)&&(y+=d),y}),m=j(()=>{if(!s())return 0;const p=s().screenX,y=l/2,u=y+c,g=window.innerWidth-y-c;return Math.max(u,Math.min(g,p))}),P=j(()=>s()?s().screenX-o(m):0);var x=Ce(),C=ge(x);{var b=p=>{var y=ol(),u=T(y);{var g=I=>{var f=rl(),_=T(f);U(()=>Pe(_,i().content)),S(I,f)};K(u,I=>{i().content&&I(g)})}U(()=>ae(y,`bottom: ${o(v)??""}px; left: ${o(m)??""}px; --arrow-offset: ${o(P)??""}px;`)),S(p,y)};K(C,p=>{i()&&s()&&p(b)})}S(n,x),ye(),r()}var cl=X('<div class="game-mask mask-top svelte-1u9aoac"></div> <div class="game-mask mask-bottom svelte-1u9aoac"></div> <div class="game-mask mask-left svelte-1u9aoac"></div> <div class="game-mask mask-right svelte-1u9aoac"></div> <div class="game-frame svelte-1u9aoac"><div class="frame-border frame-top svelte-1u9aoac"></div> <div class="frame-border frame-bottom svelte-1u9aoac"></div> <div class="frame-border frame-left svelte-1u9aoac"></div> <div class="frame-border frame-right svelte-1u9aoac"></div> <div class="frame-corner corner-top-left svelte-1u9aoac"></div> <div class="frame-corner corner-top-right svelte-1u9aoac"></div> <div class="frame-corner corner-bottom-left svelte-1u9aoac"></div> <div class="frame-corner corner-bottom-right svelte-1u9aoac"></div></div>',1);function dl(n,e){ve(e,!1);const t=()=>N(Yn,"$gameFrameColor",i),s=()=>N(Ri,"$gameWorldDimensions",i),[i,a]=xe(),r=Je(),l=Je(),c=Je(),d=Je(),h=Je(),v=Je(),m=Je();Qe(()=>t(),()=>{$(r,t())}),Qe(()=>s(),()=>{$(l,s())}),Qe(()=>o(l),()=>{$(c,`
    top: ${o(l).offsetY}px;
    left: ${o(l).offsetX}px;
    width: ${o(l).worldWidth}px;
    height: ${o(l).worldHeight}px;
  `)}),Qe(()=>o(l),()=>{$(d,o(l).offsetY)}),Qe(()=>o(l),()=>{$(h,o(l).offsetX)}),Qe(()=>o(l),()=>{$(v,o(l).offsetX+o(l).worldWidth)}),Qe(()=>o(l),()=>{$(m,o(l).offsetY+o(l).worldHeight)}),Hi();var P=cl(),x=ge(P),C=M(x,2),b=M(C,2),p=M(b,2),y=M(p,2);U(()=>{ae(x,`height: ${o(d)??""}px; background: ${o(r)??""};`),ae(C,`top: ${o(m)??""}px; background: ${o(r)??""};`),ae(b,`top: ${o(d)??""}px; height: ${o(l),Ft(()=>o(l).worldHeight)??""}px; width: ${o(h)??""}px; background: ${o(r)??""};`),ae(p,`top: ${o(d)??""}px; height: ${o(l),Ft(()=>o(l).worldHeight)??""}px; left: ${o(v)??""}px; background: ${o(r)??""};`),ae(y,`--frame-thickness: 16px; --frame-color: ${o(r)??""}; ${o(c)??""}`)}),S(n,P),ye(),a()}var hl=X("<!> <!>",1),ul=X('<div class="touch-controls"><p class="touch-text">Tap and hold<br/>where you want<br/>to move</p></div>'),gl=X('<div class="desktop-controls"><div class="key-row"><div class="pixel-key">A</div> <div class="pixel-key">W</div> <div class="pixel-key">D</div></div> <p class="or-text">or</p> <div class="key-row"><div class="pixel-key"></div> <div class="pixel-key"></div> <div class="pixel-key"></div></div></div>'),fl=X('<div class="loader-overlay"><div class="pixel-loader"></div></div>'),pl=X('<div class="game-ui-wrapper svelte-1aa1t05"><!> <!> <!> <!> <dialog class="pixel-dialog"><h1>CONTROLS</h1> <div class="controls-content"><!></div></dialog> <!></div>');function ml(n,e){ve(e,!1);const t=()=>N(Xt,"$showControlsDialog",h),s=()=>N(Js,"$hasPlayerMoved",h),i=()=>N(Zi,"$hasSelectedBackground",h),a=()=>N(Bn,"$gameFrameVisible",h),r=()=>N(Jn,"$isBuilderMode",h),l=()=>N(Kt,"$currentLanguage",h),c=()=>N(Gi,"$isTouchDevice",h),d=()=>N(Gs,"$isLoading",h),[h,v]=xe();let m=Je();function P(){const g=_n.toggleLanguage();Kt.set(g)}function x(g){!o(m)?.open||g.target.closest(".pixel-button")||Xt.set(!1)}function C(){const g=Or();if(!g){console.error("Cannot enter builder mode: map config not found");return}Rr(g)}Qe(()=>(o(m),t()),()=>{o(m)&&(t()?o(m).showModal():o(m).close())}),Qe(()=>(s(),o(m),Xt),()=>{s()&&o(m)?.open&&Xt.set(!1)}),Hi(),Xn();var b=Ce();Xe("pointerdown",Ln,x);var p=ge(b);{var y=g=>{sl(g,{})},u=g=>{var I=pl(),f=T(I);{var _=L=>{dl(L,{})};K(f,L=>{a()&&!r()&&L(_)})}var E=M(f,2);{var W=L=>{Ko(L,{})},w=L=>{var F=hl(),te=ge(F);al(te,{});var le=M(te,2);ll(le,{}),S(L,F)};K(E,L=>{r()?L(W):L(w,!1)})}var k=M(E,2);{var O=L=>{ys(L,{position:"top-left",children:(F,te)=>{he(F,{variant:"green",width:"120px",onclick:C,title:"Toggle Builder Mode",children:(le,re)=>{var ce=ue("BUILD");S(le,ce)},$$slots:{default:!0}})},$$slots:{default:!0}})};K(k,L=>{r()||L(O)})}var R=M(k,2);{var H=L=>{ys(L,{position:"top-right",children:(F,te)=>{he(F,{variant:"default",width:"100px",onclick:P,title:"Toggle Language (L)",children:(le,re)=>{var ce=ue();U(Se=>Pe(ce,Se),[()=>(l(),Ft(()=>l().toUpperCase()))]),S(le,ce)},$$slots:{default:!0}})},$$slots:{default:!0}})};K(R,L=>{r()||L(H)})}var D=M(R,2),Y=M(T(D),2),B=T(Y);{var ee=L=>{var F=ul();S(L,F)},z=L=>{var F=gl();S(L,F)};K(B,L=>{c()?L(ee):L(z,!1)})}Et(D,L=>$(m,L),()=>o(m));var V=M(D,2);{var Q=L=>{var F=fl();S(L,F)};K(V,L=>{d()&&L(Q)})}S(g,I)};K(p,g=>{i()?g(u,!1):g(y)})}S(n,b),ye(),v()}Ca();const Cn=document.getElementById("game-ui");if(!Cn)throw new Error("game-ui element not found!");Nn(ml,{target:Cn});Kt.set(_n.getLanguage());Zs.set(yt.getSkinId());Bi.set(ze.getCurrentConfig().name);const vl={type:G.AUTO,width:800,height:600,parent:"game-container",backgroundColor:"#000000",pixelArt:!0,roundPixels:!0,scale:{mode:G.Scale.RESIZE,autoCenter:G.Scale.CENTER_BOTH},input:{activePointers:3},physics:{default:"arcade",arcade:{gravity:{y:1e3,x:0},debug:!1}},audio:{noAudio:!0},scene:[]},xs=new G.Game(vl);xs.scene.add(We.GAME,Ir);xs.scene.add(We.BUILDER,Ar);Hr(xs);const yl=xs.device.input.touch;Gi.set(yl);const Sl=performance.getEntriesByType("navigation")[0]&&performance.getEntriesByType("navigation")[0].type==="reload",wl=sessionStorage.getItem("hasSeenControlsHint");(!wl||Sl)&&(sessionStorage.setItem("hasSeenControlsHint","true"),Xt.set(!0));
//# sourceMappingURL=main-DxHnv8Zg.js.map
