import{t as Gi,i as Bn,s as Gn,a as Nn,c as Kn,u as zn,b as Fe,r as Ws,d as Qt,e as Un,g as r,f as jn,h as Vn,j as qn,n as Qe,m as lt,k as R,l as Jn,M as Zt,o as Kt,P as B,p as Ni,q as Ki,v as qs,w as Qn,x as ot,y as Ce,z as we,A as ie,B as rt,C as F,D,E,F as q,G as mt,H as V,I as Te,J as ge,K as Ee,L as Q,N as je,O as m,Q as ke,R as De,S as ue,T as es,U as G,V as Is,W as Ne,X as ze,Y as ts,Z as de,_ as he,$ as zi,a0 as ea,a1 as ct,a2 as Ui,a3 as ta,a4 as sa}from"./PixelButton-dWW54Xwy.js";import"./phaser-DFK5Ua9d.js";function ji(i,e,t=!1){if(i.multiple){if(e==null)return;if(!Bn(e))return Gn();for(var s of i.options)s.selected=e.includes(gi(s));return}for(s of i.options){var n=gi(s);if(Nn(n,e)){s.selected=!0;return}}(!t||e!==void 0)&&(i.selectedIndex=-1)}function ia(i){var e=new MutationObserver(()=>{ji(i,i.__value)});e.observe(i,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Gi(()=>{e.disconnect()})}function gi(i){return"__value"in i?i.__value:i.value}function na(i=!1){const e=Kn,t=e.l.u;if(!t)return;let s=()=>jn(e.s);if(i){let n=0,a={};const o=Vn(()=>{let l=!1;const c=e.s;for(const d in c)c[d]!==a[d]&&(a[d]=c[d],l=!0);return l&&n++,n});s=()=>r(o)}t.b.length&&zn(()=>{fi(e,s),Ws(t.b)}),Fe(()=>{const n=Qt(()=>t.m.map(Un));return()=>{for(const a of n)typeof a=="function"&&a()}}),t.a.length&&Fe(()=>{fi(e,s),Ws(t.a)})}function fi(i,e){if(i.l.s)for(const t of i.l.s)r(t);e()}let Ys=Symbol();function X(i,e,t){const s=t[e]??={store:null,source:lt(void 0),unsubscribe:Qe};if(s.store!==i&&!(Ys in t))if(s.unsubscribe(),s.store=i??null,i==null)s.source.v=void 0,s.unsubscribe=Qe;else{var n=!0;s.unsubscribe=Js(i,a=>{n?s.source.v=a:R(s.source,a)}),n=!1}return i&&Ys in t?Je(i):r(s.source)}function He(){const i={};function e(){Gi(()=>{for(var t in i)i[t].unsubscribe();qn(i,Ys,{enumerable:!1,value:!0})})}return[i,e]}function Js(i,e,t){if(i==null)return e(void 0),t&&t(void 0),Qe;const s=Qt(()=>i.subscribe(e,t));return s.unsubscribe?()=>s.unsubscribe():s}const Dt=[];function aa(i,e){return{subscribe:se(i,e).subscribe}}function se(i,e=Qe){let t=null;const s=new Set;function n(l){if(Jn(i,l)&&(i=l,t)){const c=!Dt.length;for(const d of s)d[1](),Dt.push(d,i);if(c){for(let d=0;d<Dt.length;d+=2)Dt[d][0](Dt[d+1]);Dt.length=0}}}function a(l){n(l(i))}function o(l,c=Qe){const d=[l,c];return s.add(d),s.size===1&&(t=e(n,a)||Qe),l(i),()=>{s.delete(d),s.size===0&&t&&(t(),t=null)}}return{set:n,update:a,subscribe:o}}function Le(i,e,t){const s=!Array.isArray(i),n=s?[i]:i;if(!n.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const a=e.length<2;return aa(t,(o,l)=>{let c=!1;const d=[];let h=0,f=Qe;const S=()=>{if(h)return;f();const y=e(s?d[0]:d,o,l);a?o(y):f=typeof y=="function"?y:Qe},C=n.map((y,w)=>Js(y,P=>{d[w]=P,h&=~(1<<w),c&&S()},()=>{h|=1<<w}));return c=!0,S(),function(){Ws(C),f(),c=!1}})}function Je(i){let e;return Js(i,t=>e=t)(),e}const ra=se("#2a1a0a"),oa=se(!0),Vi=se({x:0,y:0});function la(i,e){Vi.set({x:i,y:e})}const qi=se({scrollX:0,scrollY:0,zoom:1});function ca(i,e,t=1){qi.set({scrollX:i,scrollY:e,zoom:t})}const Ji=se({worldWidth:640,worldHeight:640,offsetX:0,offsetY:0});function da(i,e,t,s,n=1){const a=i*n,o=e*n,l=Math.max(0,(t-a)/2),c=Math.max(0,(s-o)/2);Ji.set({worldWidth:a,worldHeight:o,offsetX:l,offsetY:c})}const Zs=se(!1);function Qi(){Zs.set(!0),setTimeout(()=>Zs.set(!1),150)}const Qs=se(1);function cs(i){Qs.set(i)}const ei=se({scrollX:0,scrollY:0,viewWidth:0,viewHeight:0,worldWidth:0,worldHeight:0,zoom:1,playerX:0,playerY:0});function ha(i){ei.update(e=>({...e,...i}))}const ua={isActive:!1,config:null,selectedItemId:null,itemDepthLayer:"behind",editMode:"items",selectedDialogZoneId:null,selectedFrameId:null,selectedSocialId:null,isPlayerSelected:!1},J=se(ua),en=Le(J,i=>i.isActive),ga=Le(J,i=>i.config),Ze=Le(J,i=>i.editMode),ys=se(!0);function fa(){ys.update(i=>!i)}const vt=se(!1);function Lt(i){vt.set(i)}const Bs=se(!1);function Ps(i){Bs.set(i)}function pa(i){J.set({isActive:!0,config:{...i,placedItems:i.placedItems||[],dialogZones:i.dialogZones||[],placedFrames:i.placedFrames||[],placedSocials:i.placedSocials||[]},selectedItemId:null,itemDepthLayer:"behind",editMode:"items",selectedDialogZoneId:null,selectedFrameId:null,selectedSocialId:null,isPlayerSelected:!1}),Qs.set(1)}function ma(){J.update(i=>{const e=i.config?{...i.config,dialogZones:(i.config.dialogZones||[]).filter(t=>t.texts.some(s=>s.title.trim()!==""||s.content.trim()!==""))}:i.config;return{...i,isActive:!1,selectedItemId:null,config:e}}),Qs.set(1)}function va(){return Je(J).config}function Bt(i){J.update(e=>({...e,editMode:i,selectedItemId:null,selectedDialogZoneId:null}))}const Ye={BACKGROUND_LAYER_START:-99,GROUND_REFERENCE:-1,ITEMS_BEHIND:5,PLAYER:10,ITEMS_FRONT:15,FOREGROUND_LAYER_START:50,SELECTION_GRAPHICS:999,GRID_OVERLAY:1e3};function ti(i){return i==="behind"?Ye.ITEMS_BEHIND:Ye.ITEMS_FRONT}const xs=Le(J,i=>i.selectedItemId),tn=Le(J,i=>i.itemDepthLayer),si=Le(J,i=>!i.selectedItemId||!i.config?.placedItems?null:i.config.placedItems.find(e=>e.id===i.selectedItemId)??null),ya=Le(si,i=>i?.physicsEnabled??!1),ba=Le(si,i=>i?.flipX??!1),sn=se(null);function Ms(i){sn.set(i)}function Sa(i){J.update(e=>{if(!e.config)return e;const t=e.config.placedItems||[];return{...e,config:{...e.config,placedItems:[...t,i]}}})}function ss(i,e){J.update(t=>!t.config||!t.config.placedItems?t:{...t,config:{...t.config,placedItems:t.config.placedItems.map(s=>s.id===i?{...s,...e}:s)}})}function nn(i){J.update(e=>!e.config||!e.config.placedItems?e:{...e,config:{...e.config,placedItems:e.config.placedItems.filter(t=>t.id!==i)},selectedItemId:e.selectedItemId===i?null:e.selectedItemId})}function an(i){J.update(e=>({...e,selectedItemId:i,isPlayerSelected:i?!1:e.isPlayerSelected}))}function _a(){J.update(i=>({...i,itemDepthLayer:i.itemDepthLayer==="behind"?"front":"behind"}))}function wa(i,e){ss(i,{depth:e})}function Ia(i,e){e?(ss(i,{physicsEnabled:e,depth:ti("behind")}),J.update(t=>({...t,itemDepthLayer:"behind"}))):ss(i,{physicsEnabled:e})}function xa(i,e){ss(i,{flipX:e})}const Ea=[{code:"cs",label:"CZ"},{code:"en",label:"EN"}],rn="cs",is=se("cs"),Gs=se("succubus"),on=se("Forest"),ln=se(!1),Ns=se(!1),Gt=se(!1),cn=se(!1),ii=se(!1),Et=se(!1),wt=se(!1),Es=se(!1),It=se(!1),Cs=se(!1),ni=se(!1),ai=se(rn);function Ca(){Et.update(i=>!i)}function ka(){wt.update(i=>!i)}function dn(){Es.set(!0)}function Ta(){Es.set(!1)}function Da(){It.update(i=>!i)}function hn(){Cs.set(!0)}function Pa(){Cs.set(!1)}function un(){ni.set(!0)}function pi(){ni.set(!1)}function Ma(i){ai.set(i)}const ns=Le(J,i=>i.selectedFrameId),gn=Le(J,i=>i.config?.placedFrames||[]),Aa=Le(J,i=>!i.selectedFrameId||!i.config?.placedFrames?null:i.config.placedFrames.find(e=>e.id===i.selectedFrameId)??null),fn=se(null);function As(i){fn.set(i)}const ri=se(new Map);function $a(i,e,t){ri.update(s=>{const n=new Map(s);return n.set(i,{x:e,y:t}),n})}function Ha(i){ri.update(e=>{const t=new Map(e);return t.delete(i),t})}function La(i){J.update(e=>{if(!e.config)return e;const t=e.config.placedFrames||[];return{...e,config:{...e.config,placedFrames:[...t,i]}}})}function nt(i,e){J.update(t=>!t.config||!t.config.placedFrames?t:{...t,config:{...t.config,placedFrames:t.config.placedFrames.map(s=>s.id===i?{...s,...e}:s)}})}function oi(i){J.update(e=>!e.config||!e.config.placedFrames?e:{...e,config:{...e.config,placedFrames:e.config.placedFrames.filter(t=>t.id!==i)},selectedFrameId:e.selectedFrameId===i?null:e.selectedFrameId})}function zt(i){Es.set(!1),J.update(e=>({...e,selectedFrameId:i,isPlayerSelected:i?!1:e.isPlayerSelected,selectedItemId:i?null:e.selectedItemId}))}const as=Le(J,i=>i.selectedSocialId),Oa=Le(J,i=>i.config?.placedSocials||[]),Ra=Le(J,i=>!i.selectedSocialId||!i.config?.placedSocials?null:i.config.placedSocials.find(e=>e.id===i.selectedSocialId)??null),pn=se(null);function $s(i){pn.set(i)}function Xa(i){J.update(e=>{if(!e.config)return e;const t=e.config.placedSocials||[];return{...e,config:{...e.config,placedSocials:[...t,i]}}})}function gs(i,e){J.update(t=>!t.config||!t.config.placedSocials?t:{...t,config:{...t.config,placedSocials:t.config.placedSocials.map(s=>s.id===i?{...s,...e}:s)}})}function li(i){J.update(e=>!e.config||!e.config.placedSocials?e:{...e,config:{...e.config,placedSocials:e.config.placedSocials.filter(t=>t.id!==i)},selectedSocialId:e.selectedSocialId===i?null:e.selectedSocialId})}function Ut(i){Cs.set(!1),J.update(e=>({...e,selectedSocialId:i,isPlayerSelected:i?!1:e.isPlayerSelected,selectedItemId:i?null:e.selectedItemId,selectedFrameId:i?null:e.selectedFrameId}))}const ks=Le(J,i=>i.selectedDialogZoneId),ci=Le(J,i=>i.config?.dialogZones||[]),mn=se(null);function ds(i){mn.set(i)}function Fa(i){J.update(e=>{if(!e.config)return e;const t=e.config.dialogZones||[];return{...e,config:{...e.config,dialogZones:[...t,i]}}})}function Mt(i,e){J.update(t=>!t.config||!t.config.dialogZones?t:{...t,config:{...t.config,dialogZones:t.config.dialogZones.map(s=>s.id===i?{...s,...e}:s)}})}function vn(i){J.update(e=>!e.config||!e.config.dialogZones?e:{...e,config:{...e.config,dialogZones:e.config.dialogZones.filter(t=>t.id!==i)},selectedDialogZoneId:e.selectedDialogZoneId===i?null:e.selectedDialogZoneId})}function jt(i){J.update(e=>({...e,selectedDialogZoneId:i}))}function mi(i,e,t){J.update(s=>!s.config||!s.config.dialogZones?s:{...s,config:{...s.config,dialogZones:s.config.dialogZones.map(n=>{if(n.id!==i)return n;const a=n.texts.findIndex(l=>l.language===e);let o;return a>=0?o=n.texts.map((l,c)=>c===a?{...l,...t}:l):o=[...n.texts,{language:e,title:"",content:"",...t}],{...n,texts:o}})}})}const vi=Le(J,i=>i.isPlayerSelected);function yi(i,e){J.update(t=>t.config?{...t,config:{...t.config,playerStartX:i,playerStartY:e}}:t)}function Wa(i){J.update(e=>({...e,isPlayerSelected:i,selectedItemId:null}))}function di(){J.update(i=>({...i,selectedItemId:null,selectedFrameId:null,selectedDialogZoneId:null,selectedSocialId:null,isPlayerSelected:!1}))}let yn=!1,At=!1;function hs(i){yn=i}function bi(){return yn}function kt(){return At}function Hs(i){if(!i||i.tagName==="CANVAS")return!1;if(i.closest("[data-ui]"))return!0;const e=document.getElementById("game-ui");return!!(e&&e.contains(i)||i.closest("button"))}function Ya(){document.addEventListener("pointerdown",i=>{At=Hs(i.target)},{capture:!0}),document.addEventListener("pointermove",i=>{i.buttons>0||(At=Hs(i.target))},{capture:!0}),document.addEventListener("pointerup",()=>{setTimeout(()=>{At=!1},10)},{capture:!0}),document.addEventListener("touchstart",i=>{At=Hs(i.target)},{capture:!0,passive:!0}),document.addEventListener("touchend",()=>{setTimeout(()=>{At=!1},10)},{capture:!0,passive:!0})}function Ot(){const i=document.activeElement;if(!i)return!1;const e=i.tagName.toUpperCase();return e==="INPUT"||e==="TEXTAREA"||i.getAttribute("contenteditable")==="true"}function xt(i,e,t){const s=(i-t.worldView.x)*t.zoom,n=(e-t.worldView.y)*t.zoom;return{screenX:s,screenY:n}}function Za(i,e,t){const s=i/t.zoom+t.worldView.x,n=e/t.zoom+t.worldView.y;return{worldX:s,worldY:n}}const bn={campfire:{frameWidth:32,frameHeight:32,frameRate:10,repeat:-1,endFrame:39},campfire_large:{frameWidth:32,frameHeight:32,frameRate:10,repeat:-1,endFrame:39}},hi=[{key:"campfire",name:"Campfire Small",path:"assets/items/campfire.png",scale:3,group:"shared",category:"props"},{key:"campfire_large",name:"Campfire Large",path:"assets/items/campfire.png",scale:5,group:"shared",category:"props"},{key:"stones_0",name:"Stones 0",path:"assets/items/stones_0.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_1",name:"Stones 1",path:"assets/items/stones_1.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_3",name:"Stones 3",path:"assets/items/stones_3.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"stones_4",name:"Stones 4",path:"assets/items/stones_4.png",scale:4,group:"shared",category:"nature",supportsPhysics:!0},{key:"barell",name:"Barrel",path:"assets/items/barell.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"box",name:"Box",path:"assets/items/box.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"chair",name:"Chair",path:"assets/items/chair.png",scale:4,group:"shared",category:"furniture"},{key:"stool",name:"Stool",path:"assets/items/stool.png",scale:4,group:"shared",category:"furniture"},{key:"table_small",name:"Table Small",path:"assets/items/table_small.png",scale:4,group:"shared",category:"furniture"},{key:"table_full",name:"Table Full",path:"assets/items/table_full.png",scale:4,group:"forest_summer",category:"furniture"},{key:"kettle",name:"Kettle",path:"assets/items/kettle.png",scale:4,group:"shared",category:"props"},{key:"log_axe",name:"Log with Axe",path:"assets/items/log_axe.png",scale:4,group:"shared",category:"props"},{key:"log_chisel",name:"Log with Chisel",path:"assets/items/log_chisel.png",scale:4,group:"shared",category:"props"},{key:"apple_basket",name:"Apple Basket",path:"assets/items/apple_basket.png",scale:4,group:"shared",category:"props"},{key:"apples",name:"Apples",path:"assets/items/apples.png",scale:4,group:"forest_summer",category:"props"},{key:"pumpkin",name:"Pumpkin",path:"assets/items/pumpkin.png",scale:4,group:"forest_summer",category:"nature"},{key:"pumpkin_helloween",name:"Pumpkin Halloween",path:"assets/items/pumpkin_helloween.png",scale:4,group:"forest_summer",category:"props"},{key:"scarecrow",name:"Scarecrow",path:"assets/items/scarecrow.png",scale:4,group:"forest_summer",category:"props"},{key:"sign_skogen",name:"Sign Skogen",path:"assets/items/sign_skogen.png",scale:4,group:"forest_shared",category:"props"},{key:"statue",name:"Statue",path:"assets/items/statue.png",scale:4,group:"shared",category:"props",supportsPhysics:!0},{key:"wall",name:"Wall",path:"assets/items/wall.png",scale:4,group:"forest_summer",category:"structures"},{key:"hanger",name:"Hanger",path:"assets/items/hanger.png",scale:4,group:"forest_summer",category:"furniture"},{key:"cauldron_campfire",name:"Cauldron Campfire",path:"assets/items/cauldron_campfire.png",scale:4,group:"shared",category:"props"},{key:"ore_copper",name:"Ore Copper",path:"assets/items/ore_copper.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_dia",name:"Ore Diamond",path:"assets/items/ore_dia.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_gold",name:"Ore Gold",path:"assets/items/ore_gold.png",scale:4,group:"cave_dark",category:"nature"},{key:"ore_tin",name:"Ore Tin",path:"assets/items/ore_tin.png",scale:4,group:"cave_dark",category:"nature"},{key:"tent_large",name:"Tent Large",path:"assets/items/tent_large.png",scale:4,group:"forest_summer",category:"structures"},{key:"tent",name:"Tent Small",path:"assets/items/tent.png",scale:4,group:"forest_summer",category:"structures"},{key:"bush_0",name:"Bush 0",path:"assets/items/bush_0.png",scale:4,group:"forest_summer",category:"nature"},{key:"bush_1",name:"Bush 1",path:"assets/items/bush_1.png",scale:4,group:"forest_summer",category:"nature"},{key:"bush_2",name:"Bush 2",path:"assets/items/bush_2.png",scale:4,group:"forest_summer",category:"nature"},{key:"grass",name:"Grass",path:"assets/items/grass.png",scale:4,group:"forest_summer",category:"nature"},{key:"grass_0",name:"Grass 0",path:"assets/items/grass_0.png",scale:4,group:"forest_summer",category:"nature"},{key:"tree_picea",name:"Tree Picea",path:"assets/items/tree_picea.png",scale:4,group:"forest_summer",category:"nature"},{key:"tree_pinus",name:"Tree Pinus",path:"assets/items/tree_pinus.png",scale:4,group:"forest_summer",category:"nature"},{key:"grave_0",name:"Grave 0",path:"assets/items/grave_0.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_1",name:"Grave 1",path:"assets/items/grave_1.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_2",name:"Grave 2",path:"assets/items/grave_2.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_3",name:"Grave 3",path:"assets/items/grave_3.png",scale:4,group:"forest_shared",category:"props"},{key:"grave_4",name:"Grave 4",path:"assets/items/grave_4.png",scale:4,group:"forest_shared",category:"props"},{key:"icebush_0",name:"Ice Bush 0",path:"assets/items/icebush_0.png",scale:4,group:"forest_birch",category:"nature"},{key:"icebush_1",name:"Ice Bush 1",path:"assets/items/icebush_1.png",scale:4,group:"forest_birch",category:"nature"},{key:"icebush_2",name:"Ice Bush 2",path:"assets/items/icebush_2.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_0",name:"Ice Stones 0",path:"assets/items/icestones_0.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_1",name:"Ice Stones 1",path:"assets/items/icestones_1.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_2",name:"Ice Stones 2",path:"assets/items/icestones_2.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_3",name:"Ice Stones 3",path:"assets/items/icestones_3.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_4",name:"Ice Stones 4",path:"assets/items/icestones_4.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_5",name:"Ice Stones 5",path:"assets/items/icestones_5.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_6",name:"Ice Stones 6",path:"assets/items/icestones_6.png",scale:4,group:"forest_birch",category:"nature"},{key:"icestones_7",name:"Ice Stones 7",path:"assets/items/icestones_7.png",scale:4,group:"forest_birch",category:"nature"},{key:"snow_pile",name:"Snow Pile",path:"assets/items/snow_pile.png",scale:4,group:"forest_birch",category:"nature"}];function Sn(i){return hi.find(e=>e.key===i)}function Ba(i){return Sn(i)?.scale||1}function Ks(i){return i in bn}function zs(i){return bn[i]}function Ga(i){return Sn(i)?.supportsPhysics??!1}class Si{scene;groundY;constructor(e,t){this.scene=e,this.groundY=t}static preloadAssets(e){hi.forEach(t=>{if(Ks(t.key)){const s=zs(t.key);s&&e.load.spritesheet(t.key,t.path,{frameWidth:s.frameWidth,frameHeight:s.frameHeight})}else e.load.image(t.key,t.path)})}createSprite(e){const{id:t,assetKey:s,x:n,scale:a=1,depth:o=5,yOffset:l=0,flipX:c=!1}=e,d=this.groundY+l,h=this.scene.add.sprite(n,d,s);if(h.setScale(a),h.setDepth(o),h.setFlipX(c),h.setData("itemId",t),Ks(s)){const f=`${s}_anim`,S=zs(s);S&&(this.scene.anims.exists(f)||this.scene.anims.create({key:f,frames:this.scene.anims.generateFrameNumbers(s,{start:S.startFrame??0,end:S.endFrame}),frameRate:S.frameRate??8,repeat:S.repeat??-1}),h.play(f))}return h}updatePosition(e,t,s){e.x=t,e.y=this.groundY+s}updateScale(e,t){e.setScale(t)}updateDepth(e,t){e.setDepth(t)}applyUpdates(e,t){t.x!==void 0&&(e.x=t.x),t.yOffset!==void 0&&(e.y=this.groundY+t.yOffset),t.scale!==void 0&&e.setScale(t.scale),t.depth!==void 0&&e.setDepth(t.depth),t.flipX!==void 0&&e.setFlipX(t.flipX)}worldYToOffset(e){return e-this.groundY}getGroundY(){return this.groundY}}function $t(i){return parseInt(i.replace("#",""),16)}const _t={BLUE:"#4a90e2",GREEN:"#27ae60",PURPLE:"#9b59b6",TEAL:"#1abc9c",PINK:"#e91e8f"},ls={ITEM:{hex:$t(_t.BLUE)},FRAME:{hex:$t(_t.PURPLE)},SOCIAL:{css:_t.PINK,hex:$t(_t.PINK)},DIALOG_ZONE:{hex:$t(_t.TEAL)},PLAYER:{hex:$t(_t.GREEN)}},_n=$t(_t.BLUE),wn=240,Na=48;function fs(i){const e=`assets/skins/static/${i.folder}`;return i.variant?`${e}/${i.variant}`:e}function Vt(i){if(i.scale!==void 0)return i.scale;const e=i.frameHeight??Na;return wn/e}const Ae=[{id:"succubus",name:"SUCCUBUS",folder:"succubus",variant:"basic",character:"human",frameWidth:156,frameHeight:72,facingLeft:!0,frameRates:{idle:8,run:12}}],In="succubus";class Ka{currentSkinId=In;constructor(){this.loadFromStorage()}loadFromStorage(){const e=localStorage.getItem("playerSkin");e&&this.isValidSkinId(e)&&(this.currentSkinId=e)}isValidSkinId(e){return Ae.some(t=>t.id===e)}setSkin(e){this.isValidSkinId(e)&&(this.currentSkinId=e,localStorage.setItem("playerSkin",e))}getSkinId(){return this.currentSkinId}getSkinConfig(){return Ae.find(e=>e.id===this.currentSkinId)||Ae[0]}getSkinById(e){return Ae.find(t=>t.id===e)}getAllSkins(){return Ae}getAnimationPrefix(){const e=this.getSkinConfig();return`${e.character}-${e.id}`}}const Ct=new Ka,qt={DEPTH:Ye.PLAYER},za={HALF_HEIGHT:wn/2},pt={FRAME_WIDTH:Zt.WIDTH,FRAME_HEIGHT:Zt.HEIGHT,WIDTH:Zt.WIDTH*Kt,HEIGHT:Zt.HEIGHT*Kt,HALF_HEIGHT:Zt.HEIGHT*Kt/2},qe=40;function xn(i,e=qe){return i-e}function Xt(i,e=qe){return xn(i,e)-za.HALF_HEIGHT}function Ua(i,e,t=qe){const s=Xt(e,t);return i>s}function rs(i,e=qe){return xn(i,e)-pt.HALF_HEIGHT}function ja(i,e,t=qe){const s=rs(e,t);return i>s}const Ls={WIDTH:.33,HEIGHT:.25,OFFSET_Y:.75},_i={WIDTH:.4,HEIGHT:.3},Us={WIDTH:.6};function Va(i,e){const t=Math.round(i*Ls.WIDTH),s=Math.round(e*Ls.HEIGHT),n=Math.round((i-t)/2),a=Math.round(e*Ls.OFFSET_Y);return{width:t,height:s,offsetX:n,offsetY:a}}function qa(){const i=Math.round(pt.WIDTH*_i.WIDTH),e=Math.round(pt.HEIGHT*_i.HEIGHT),t=-i/2,s=pt.HEIGHT/2-e;return{width:i,height:e,offsetX:t,offsetY:s}}const Ht=50,Ja=4871528,Qa=.4,er=1,En=Ye.GRID_OVERLAY,Os=16711680,tr=2,sr=.6,ir=.1,nr=1,ar=.2,wi=50,rr=50,Cn=_n,or=()=>{try{return!1}catch{return!1}},Ii=or(),xi=65280,lr=.1,cr=1,dr=.3,hr=.2,ur=2,gr=.8;class kn{lastClickTime=0;lastClickId=null;threshold;constructor(e=300){this.threshold=e}check(e){const t=Date.now(),s=this.lastClickId===e&&t-this.lastClickTime<this.threshold;return this.lastClickTime=t,this.lastClickId=e,s}reset(){this.lastClickTime=0,this.lastClickId=null}}function us(i,e){return Math.round(i/e)*e}function Ts(i){const{sprite:e,scene:t,callbacks:s={},constraints:n,useGridSnapping:a=!0,cursor:o="grab",hitArea:l}=i;let c=!1,d=0,h=0,f=0;if(l){if(e.setInteractive(l,B.Geom.Rectangle.Contains),e.input){const v=e.input;v.cursor=o,v.useHandCursor=!0}}else e.setInteractive({useHandCursor:!0,cursor:o});const S=(v,g)=>{const u=e.getBounds(),_=5;return v>=u.x-_&&v<=u.x+u.width+_&&g>=u.y-_&&g<=u.y+u.height+_},C=()=>{const v=t.data.get("lastTapTime");if(!v||v===f||Date.now()-v>100)return;f=v;const g=t.data.get("lastTapWorldX"),u=t.data.get("lastTapWorldY");S(g,u)&&s.onSelect?.()},y=v=>{if(v.wasTouch||Je(Bs)||kt()||c||s.onDoubleClick?.())return;const g=s.isSelected?.()??!1;s.onSelect?.(),g&&(c=!0,t.data.set("isDraggingItem",!0),Lt(!0),d=e.x-v.worldX,h=e.y-v.worldY,s.onDragStart?.())},w=v=>{if(v.wasTouch){const _=t.data.get("touchDragStarted");if(!c&&_&&s.isSelected?.()){const k=t.data.get("touchStartWorldX"),$=t.data.get("touchStartWorldY"),I=e.getBounds(),A=10;k>=I.x-A&&k<=I.x+I.width+A&&$>=I.y-A&&$<=I.y+I.height+A&&(c=!0,t.data.set("isDraggingItem",!0),t.data.set("touchDragStarted",!1),Lt(!0),d=e.x-k,h=e.y-$,s.onDragStart?.())}if(c){let x=v.worldX+d,k=v.worldY+h;a&&Je(ys)&&(x=us(x,Ht),k=us(k,Ht)),n&&(n.minX!==void 0&&(x=Math.max(x,n.minX)),n.maxX!==void 0&&(x=Math.min(x,n.maxX)),n.minY!==void 0&&(k=Math.max(k,n.minY)),n.maxY!==void 0&&(k=Math.min(k,n.maxY))),e.setPosition(x,k),s.onDrag?.(x,k)}return}if(!c)return;if(Je(Bs)){p();return}if(!v.isDown){p();return}let g=v.worldX+d,u=v.worldY+h;a&&Je(ys)&&(g=us(g,Ht),u=us(u,Ht)),n&&(n.minX!==void 0&&(g=Math.max(g,n.minX)),n.maxX!==void 0&&(g=Math.min(g,n.maxX)),n.minY!==void 0&&(u=Math.max(u,n.minY)),n.maxY!==void 0&&(u=Math.min(u,n.maxY))),e.setPosition(g,u),s.onDrag?.(g,u)},P=()=>{c&&p()},p=()=>{c=!1,t.data.set("isDraggingItem",!1),Lt(!1),s.onDragEnd?.(e.x,e.y)};e.on("pointerdown",y),t.input.on("pointermove",w),t.input.on("pointerup",P);const b=()=>{C()};return t.events.on("update",b),()=>{e.off("pointerdown",y),t.input.off("pointermove",w),t.input.off("pointerup",P),t.events.off("update",b)}}class fr{scene;groundY;worldWidth;worldHeight;isDragging=!1;callbacks;cleanupFunctions=new Map;constructor(e,t,s,n,a={}){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=n,this.callbacks=a}getIsDragging(){return this.isDragging}makeInteractive(e,t){const s=Ts({sprite:e,scene:this.scene,cursor:"pointer",constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{an(t),this.callbacks.onSelect?.(t)},isSelected:()=>Je(xs)===t,onDragStart:()=>{this.isDragging=!0,e.setTint(_n),this.callbacks.onDragStart?.(t)},onDrag:(n,a)=>{this.callbacks.onDrag?.(t,n,a)},onDragEnd:(n,a)=>{e.clearTint(),this.isDragging=!1;const o=Math.round(n),c=Math.round(a)-this.groundY;ss(t,{x:o,yOffset:c}),this.callbacks.onDragEnd?.(t,o,c)}}});this.cleanupFunctions.set(t,s)}removeInteractivity(e){if(!e||!e.scene)return;const t=e.getData("itemId");t&&this.cleanupFunctions.has(t)&&(this.cleanupFunctions.get(t)(),this.cleanupFunctions.delete(t)),e.removeInteractive()}destroy(){this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear()}}const ft={ITEM:"itemId",FRAME:"frameId",SOCIAL:"socialId",PLAYER:"isPlayer",ZONE:"zoneId"},pr={[ft.ITEM]:"selectedItemId",[ft.FRAME]:"selectedFrameId",[ft.SOCIAL]:"selectedSocialId",[ft.PLAYER]:"isPlayerSelected"};function Tn(i){return typeof i.getData=="function"}function mr(i){return Tn(i)?i.type==="Rectangle"?!!i.getData(ft.ZONE):Object.values(ft).some(e=>e===ft.ZONE?!1:!!i.getData(e)):!1}function vr(i,e){if(!Tn(i))return!1;for(const[t,s]of Object.entries(pr)){const n=i.getData(t);if(n)if(t===ft.PLAYER){const a=e.data.get(s),o=e.data.get("playerSprite");if(a&&i===o)return!0}else{const a=e.data.get(s);if(n===a)return!0}}return!1}function yr(i,e){const t=i.input.hitTestPointer(e);for(const s of t)if(vr(s,i))return!0;return!1}const br={lineWidth:3,lineColor:ls.ITEM.hex,lineAlpha:1,padding:5};class Sr{scene;graphics;style;selectedId=null;constructor(e,t={}){this.scene=e,this.style={...br,...t},this.graphics=e.add.graphics(),this.graphics.setDepth(Ye.SELECTION_GRAPHICS)}setSelectedId(e){this.selectedId=e}getSelectedId(){return this.selectedId}updateVisuals(e){if(this.graphics.clear(),!e||!this.selectedId)return;const t=e.getBounds(),{lineWidth:s,lineColor:n,lineAlpha:a,padding:o}=this.style;this.graphics.lineStyle(s,n,a),this.graphics.strokeRect(t.x-o,t.y-o,t.width+o*2,t.height+o*2)}clearVisuals(){this.graphics.clear(),this.selectedId=null}setupBackgroundDeselect(e){this.scene.input.on("pointerdown",t=>{if(kt()||e())return;this.scene.input.hitTestPointer(t).find(a=>mr(a))||(di(),this.clearVisuals())})}destroy(){this.graphics?.destroy()}}class bs{scene;items=new Map;isBuilderMode=!1;physicsGroup=null;renderer;dragController;selectionManager;constructor(e,t,s,n,a=!1){this.scene=e,this.isBuilderMode=a,this.renderer=new Si(e,t),a||(this.physicsGroup=e.physics.add.staticGroup()),this.isBuilderMode&&(this.dragController=new fr(e,t,s,n,{onSelect:()=>this.updateSelectionVisuals(),onDrag:()=>this.updateSelectionVisuals()}),this.selectionManager=new Sr(e))}static preloadAssets(e){Si.preloadAssets(e)}createItems(e){e.forEach(t=>{this.createItem(t)})}createItem(e){const t=this.renderer.createSprite(e),s={sprite:t,data:e};if(!this.isBuilderMode&&e.physicsEnabled&&this.physicsGroup){const n=this.createPhysicsBody(t,e);s.physicsBody=n}this.items.set(e.id,s),this.isBuilderMode&&this.dragController&&this.dragController.makeInteractive(t,e.id)}createPhysicsBody(e,t){const s=e.getBounds(),n=s.width*.5,a=s.height*.8,o=e.x,l=e.y,c=this.scene.add.rectangle(o,l,n,a);return c.setVisible(!1),this.physicsGroup.add(c),c.setData("itemId",t.id),c}updateSelectionVisuals(){if(!this.selectionManager)return;const e=this.scene.data.get("selectedItemId");if(this.selectionManager.setSelectedId(e),!e){this.selectionManager.clearVisuals(),Ms(null);return}const t=this.items.get(e);if(this.selectionManager.updateVisuals(t?.sprite??null),t?.sprite){const s=this.scene.cameras.main,n=t.sprite.getBounds(),{screenX:a,screenY:o}=xt(n.centerX,n.centerY,s),l=n.height*s.zoom;Ms({screenX:a,screenY:o,itemHeight:l})}else Ms(null)}updateItem(e,t){const s=this.items.get(e);s&&(this.renderer.applyUpdates(s.sprite,t),s.data={...s.data,...t})}removeItem(e){const t=this.items.get(e);t&&(this.dragController&&this.dragController.removeInteractivity(t.sprite),t.physicsBody&&t.physicsBody.destroy(),t.sprite.destroy(),this.items.delete(e))}removeAllItems(){this.items.forEach(e=>{!e.sprite||!e.sprite.scene||(this.dragController&&this.dragController.removeInteractivity(e.sprite),e.physicsBody&&e.physicsBody.destroy(),e.sprite.destroy())}),this.items.clear()}getItem(e){return this.items.get(e)?.data}getAllItems(){return Array.from(this.items.values()).map(e=>e.data)}getPhysicsGroup(){return this.physicsGroup}setInteractiveEnabled(e){!this.isBuilderMode||!this.dragController||(this.items.forEach(({sprite:t,data:s})=>{e?(this.dragController.makeInteractive(t,s.id),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectionManager&&this.selectionManager.clearVisuals())}destroy(){this.removeAllItems(),this.selectionManager?.destroy()}setupBackgroundDeselect(){!this.isBuilderMode||!this.selectionManager||this.selectionManager.setupBackgroundDeselect(()=>this.dragController?.getIsDragging()??!1)}}function _r(){return`frame_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const wr=["#ffffff","#f8f8f8","#fffacd","#ffefd5","#ffe4e1","#e6e6fa","#f0fff0","#f5fffa","#fff0f5","#f0f8ff","#2d2d2d","#1a1a2e","#16213e","#1a1a1a","#2d132c","#1e3a3a","#3d1a1a","#1a2f1a","#3d3d1a","#2a1a3d"],Ir=["#333333","#000000","#ffffff","#1a1a1a","#666666","#8b4513","#2c3e50","#c0392b","#27ae60","#2980b9","#8e44ad","#f39c12"],xr=[12,14,16,18,20,24,28,32],Er=[{value:"top",label:"Top",icon:"↑"},{value:"center",label:"Center",icon:"⬌"},{value:"bottom",label:"Bottom",icon:"↓"}],Dn={S:{label:"Small",scale:3},M:{label:"Medium",scale:4},L:{label:"Large",scale:5}};function Cr(i){return Dn[i].scale}function kr(i){return i<=3?"S":i>=5?"L":"M"}const dt=4,Nt="#ffffff",Pn="#333333",ps=16,Mn="center",Tr=64,Dr=96,Pr=.06,Ei=32,Ss=[{key:"base_1",name:"Frame 1",path:"assets/frames/base 1.png",scale:4},{key:"base_2",name:"Frame 2",path:"assets/frames/base 2.png",scale:4},{key:"base_3",name:"Frame 3",path:"assets/frames/base 3.png",scale:4},{key:"base_4",name:"Frame 4",path:"assets/frames/base 4.png",scale:4},{key:"base_5",name:"Frame 5",path:"assets/frames/base 5.png",scale:4},{key:"base_6",name:"Frame 6",path:"assets/frames/base 6.png",scale:4},{key:"base_7",name:"Frame 7",path:"assets/frames/base 7.png",scale:4},{key:"base_8",name:"Frame 8",path:"assets/frames/base 8.png",scale:4},{key:"base_9",name:"Frame 9",path:"assets/frames/base 9.png",scale:4},{key:"base_10",name:"Frame 10",path:"assets/frames/base 10.png",scale:4},{key:"base_11",name:"Frame 11",path:"assets/frames/base 11.png",scale:4},{key:"base_12",name:"Frame 12",path:"assets/frames/base 12.png",scale:4},{key:"base_13",name:"Frame 13",path:"assets/frames/base 13.png",scale:4},{key:"base_14",name:"Frame 14",path:"assets/frames/base 14.png",scale:4},{key:"base_15",name:"Frame 15",path:"assets/frames/base 15.png",scale:4},{key:"base_16",name:"Frame 16",path:"assets/frames/base 16.png",scale:4},{key:"base_17",name:"Frame 17",path:"assets/frames/base 17.png",scale:4},{key:"base_18",name:"Frame 18",path:"assets/frames/base 18.png",scale:4},{key:"base_19",name:"Frame 19",path:"assets/frames/base 19.png",scale:4},{key:"base_20",name:"Frame 20",path:"assets/frames/base 20.png",scale:4},{key:"base_21",name:"Frame 21",path:"assets/frames/base 21.png",scale:4},{key:"base_22",name:"Frame 22",path:"assets/frames/base 22.png",scale:4},{key:"base_23",name:"Frame 23",path:"assets/frames/base 23.png",scale:4},{key:"base_24",name:"Frame 24",path:"assets/frames/base 24.png",scale:4},{key:"base_25",name:"Frame 25",path:"assets/frames/base 25.png",scale:4}];function Mr(i){return Ss.find(e=>e.key===i)}function Ar(i){return Mr(i)?.scale??dt}function Jt(i=dt,e=!1){const t=Tr*i,s=Dr*i,n=e?s:t,a=e?t:s,o=Math.min(t,s)*Pr,l=n-o*2,c=a-o*2,d=l-Ei*2,h=c-Ei*2;return{frameWidth:n,frameHeight:a,innerWidth:l,innerHeight:c,textWidth:d,textHeight:h}}function ms(i,e,t,s,n,a,o=4){i.clear();const l=parseInt(a.replace("#",""),16);i.fillStyle(l,1),i.fillRoundedRect(e-s/2,t-n/2,s,n,o)}function $r(){return`zone_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const js=["#e74c3c","#e67e22","#f1c40f","#2ecc71","#1abc9c","#3498db","#9b59b6","#e91e8f"];function Hr(){return js[Math.floor(Math.random()*js.length)]}function Lr(i,e=300){return{id:$r(),x:i,width:e,color:Hr(),texts:[{language:"cs",title:"",content:""}]}}function Or(i,e){const t=i.texts.find(s=>s.language===e);return t||i.texts[0]||null}const An=se(null),Rr=Le([An,is],([i,e])=>i?Or(i,e):null);function Rs(i){An.set(i)}class Ci{scene;frames=new Map;constructor(e){this.scene=e}static preloadAssets(e){for(let t=1;t<=25;t++)e.load.image(`frame_base_${t}`,`assets/frames/base ${t}.png`)}createFrames(e){e.forEach(t=>{this.createFrame(t)})}createFrame(e){const t=`frame_${e.frameKey}`;if(!this.scene.textures.exists(t)){console.warn(`[GameFrameManager] Frame texture not found: ${t}`);return}const s=e.scale??dt,n=e.depth??Ye.ITEMS_FRONT,a=(e.rotation??0)*(Math.PI/180),o=e.rotation===90,{innerWidth:l,innerHeight:c}=Jt(s,o),d=this.scene.add.graphics();d.setDepth(n-.1),ms(d,e.x,e.y,l,c,e.backgroundColor||Nt);const h=this.scene.add.sprite(e.x,e.y,t);h.setScale(s),h.setDepth(n),h.setOrigin(.5,.5),h.setRotation(a);const f={sprite:h,background:d,data:e};this.frames.set(e.id,f),e.url&&this.makeClickable(f)}makeClickable(e){const{sprite:t,data:s}=e;t.setInteractive({useHandCursor:!0}),t.on("pointerover",()=>{t.setScale((s.scale??dt)*1.05)}),t.on("pointerout",()=>{t.setScale(s.scale??dt)}),t.on("pointerdown",()=>{s.url&&(Qi(),window.open(s.url,"_blank","noopener,noreferrer"))})}destroy(){this.frames.forEach(({sprite:e,background:t})=>{e.destroy(),t.destroy()}),this.frames.clear()}}function Xr(){return`social_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}const os={S:{label:"Small",scale:1.5},M:{label:"Medium",scale:2},L:{label:"Large",scale:2.5}},Rt=os.M.scale;function Fr(i){return os[i].scale}function Wr(i){return i<=os.S.scale?"S":i>=os.L.scale?"L":"M"}const _s=[{key:"discord",name:"Discord",path:"assets/socials/Discord.png",scale:1},{key:"facebook",name:"Facebook",path:"assets/socials/Facebook.png",scale:1},{key:"instagram",name:"Instagram",path:"assets/socials/Instagram.png",scale:1},{key:"kofi",name:"Ko-Fi",path:"assets/socials/Ko Fi.png",scale:1},{key:"linkedin",name:"LinkedIn",path:"assets/socials/LinkedIn.png",scale:1},{key:"patreon",name:"Patreon",path:"assets/socials/Patreon.png",scale:1},{key:"tiktok",name:"TikTok",path:"assets/socials/TikTok.png",scale:1},{key:"twitch",name:"Twitch",path:"assets/socials/Twitch.png",scale:1},{key:"twitter",name:"Twitter",path:"assets/socials/Twitter.png",scale:1},{key:"whatsapp",name:"WhatsApp",path:"assets/socials/Whatsapp.png",scale:1},{key:"youtube",name:"YouTube",path:"assets/socials/Youtube.png",scale:1}];class ki{scene;socials=new Map;constructor(e){this.scene=e}static preloadAssets(e){_s.forEach(t=>{e.load.image(`social_${t.key}`,t.path)})}createSocials(e){e.forEach(t=>{this.createSocial(t)})}createSocial(e){const t=`social_${e.socialKey}`;if(!this.scene.textures.exists(t)){console.warn(`[GameSocialManager] Social texture not found: ${t}`);return}const s=e.scale??Rt,n=e.depth??Ye.ITEMS_FRONT,a=this.scene.add.sprite(e.x,e.y,t);a.setScale(s),a.setDepth(n),a.setOrigin(.5,.5),this.socials.set(e.id,a),e.url&&this.makeClickable(a,e)}makeClickable(e,t){const s=t.scale??Rt;e.setInteractive({useHandCursor:!0}),e.on("pointerover",()=>{e.setScale(s*1.1)}),e.on("pointerout",()=>{e.setScale(s)}),e.on("pointerdown",()=>{t.url&&(Qi(),window.open(t.url,"_blank","noopener,noreferrer"))})}destroy(){this.socials.forEach(e=>{e.destroy()}),this.socials.clear()}}const et={GAME:"GameScene",BUILDER:"BuilderScene"};class Yr{scene;currentSkinId;constructor(e,t=In){this.scene=e,this.currentSkinId=t}createAll(){console.log("PlayerAnimations.createAll() is deprecated - animations created by skinLoader")}getSkinId(){return this.currentSkinId}setSkinId(e){this.currentSkinId=e}getAnimationKey(e){return`${this.currentSkinId}-${e}`}play(e,t){const s=this.getAnimationKey(t);if(e.anims.currentAnim?.key!==s){if(!this.scene.anims.exists(s)){if(t==="jump"||t==="fall"){const n=this.getAnimationKey("idle");if(this.scene.anims.exists(n)){e.play(n);return}}console.warn(`[PlayerAnimations] Animation not found: ${s}`);return}e.play(s)}}handleSkinChange(e,t){const s=this.currentSkinId;this.currentSkinId=t;const n=e.anims.currentAnim?.key;if(n){const a=n.replace(`${s}-`,""),o=`${t}-${a}`;if(this.scene.anims.exists(o))e.play(o);else{const l=`${t}-idle`;this.scene.anims.exists(l)&&e.play(l)}}}}const St={THRESHOLD_X:20,LANGUAGE_BUTTON:{width:120,height:60},SKIN_BUTTON:{width:120,height:60,yOffset:60}},ws={SPEED:350,JUMP_SPEED:-600};class $n{scene;getPlayerPosition;keyLeft;keyRight;keyUp;keySpace;keyA;keyD;keyW;touchLeft=!1;touchRight=!1;touchJump=!1;touchHandlers;constructor(e){this.scene=e.scene,this.getPlayerPosition=e.getPlayerPosition,this.setupKeyboardControls(),this.setupTouchControls()}setupKeyboardControls(){this.scene.input.keyboard&&(this.keyLeft=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.LEFT,!1),this.keyRight=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.RIGHT,!1),this.keyUp=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.UP,!1),this.keySpace=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.SPACE,!1),this.keyA=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.A,!1),this.keyD=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.D,!1),this.keyW=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.W,!1))}setupTouchControls(){const e=this.scene,t=o=>{if(Je(Zs)){this.touchLeft=!1,this.touchRight=!1,this.touchJump=!1;return}const l=o.x,c=o.y,d=e.scale.width;if(l>d-St.LANGUAGE_BUTTON.width&&c<St.LANGUAGE_BUTTON.height||l>d-St.SKIN_BUTTON.width&&c>=St.SKIN_BUTTON.yOffset&&c<St.SKIN_BUTTON.yOffset+St.SKIN_BUTTON.height)return;const h=e.cameras.main,f=this.getPlayerPosition(),S=f.x-h.scrollX,C=f.y-h.scrollY,y=l-S,w=c-C;y<-20?(this.touchLeft=!0,this.touchRight=!1):y>St.THRESHOLD_X?(this.touchRight=!0,this.touchLeft=!1):(this.touchLeft=!1,this.touchRight=!1),w<-150?this.touchJump=!0:this.touchJump=!1},s=o=>{kt()||t(o)},n=o=>{kt()||o.isDown&&t(o)},a=()=>{this.touchLeft=!1,this.touchRight=!1,this.touchJump=!1};e.input.on("pointerdown",s),e.input.on("pointermove",n),e.input.on("pointerup",a),this.touchHandlers={pointerdown:s,pointermove:n,pointerup:a}}getInputState(){const e=this.keyA?.isDown||this.keyLeft?.isDown||this.touchLeft||!1,t=this.keyD?.isDown||this.keyRight?.isDown||this.touchRight||!1,s=this.keySpace?.isDown||this.keyUp?.isDown||this.keyW?.isDown||this.touchJump||!1;return{left:e,right:t,jump:s}}hasAnyInput(){const e=this.getInputState();return e.left||e.right||e.jump}destroy(){this.touchHandlers&&(this.scene.input.off("pointerdown",this.touchHandlers.pointerdown),this.scene.input.off("pointermove",this.touchHandlers.pointermove),this.scene.input.off("pointerup",this.touchHandlers.pointerup),this.touchHandlers=void 0)}}class Ti extends B.GameObjects.Container{character=null;selection;animState="idle";hasNotifiedMovement=!1;hasReceivedInput=!1;currentFacing="right";inputController;constructor(e,t,s,n){super(e,t,s),this.selection=n,e.add.existing(this),e.physics.add.existing(this);const a=this.body;if(a){a.setCollideWorldBounds(!0),a.setBounce(0);const o=qa();a.setSize(o.width,o.height),a.setOffset(o.offsetX,o.offsetY)}this.inputController=new $n({scene:e,getPlayerPosition:()=>({x:this.x,y:this.y})}),this.setDepth(qt.DEPTH)}getPosition(){return{x:this.x,y:this.y}}setPlayerPosition(e,t){this.x=e,this.y=t}getGroundY(e,t){return rs(e,t)}getPlayerType(){return"modular"}getHitBounds(){const e=pt.WIDTH,t=pt.HEIGHT;return{x:this.x-e/2,y:this.y-t/2,width:e,height:t}}setFacing(e){this.currentFacing!==e&&(this.currentFacing=e,this.character?.setFacing(e))}setTint(e){this.character?.setTint(e)}clearTint(){this.character?.clearTint()}setAlpha(e){return this.character?.setAlpha(e),this}getGameObject(){return this}static async preloadCharacter(e,t){return Ni(e,t)}buildCharacter(){this.character&&this.character.destroy(),this.character=new Ki(this.scene,0,0,this.selection,{animated:!0,animation:"idle",facing:"right",scale:Kt}),this.add(this.character),this.currentFacing="right"}playAnimation(e){this.character?.playAnimation(e)}update(){const e=this.inputController.getInputState(),t=this.body;if(t)switch(this.inputController.hasAnyInput()&&!this.hasReceivedInput&&(this.hasReceivedInput=!0),this.hasReceivedInput&&this.inputController.hasAnyInput()&&!this.hasNotifiedMovement&&(this.hasNotifiedMovement=!0,ii.set(!0)),e.left?(t.setVelocityX(-350),this.setFacing("left")):e.right?(t.setVelocityX(ws.SPEED),this.setFacing("right")):t.setVelocityX(0),e.jump&&t.blocked.down&&t.setVelocityY(ws.JUMP_SPEED),t.blocked.down?e.left||e.right?this.animState="running":this.animState="idle":t.velocity.y<0?this.animState="jumping":this.animState="falling",this.animState){case"idle":this.playAnimation("idle");break;case"running":this.playAnimation("run");break;case"jumping":this.playAnimation("jump");break;case"falling":this.playAnimation("fall");break}}destroy(e){this.inputController.destroy(),this.character&&(this.character.destroy(),this.character=null),super.destroy(e)}}class Zr extends B.Physics.Arcade.Sprite{animations;inputController;animState="idle";hasNotifiedMovement=!1;hasReceivedInput=!1;currentSkin;constructor(e,t,s){const n=Ct.getSkinId();super(e,t,s,`${n}-idle`),e.add.existing(this),e.physics.add.existing(this),this.animations=new Yr(e,n),this.inputController=new $n({scene:e,getPlayerPosition:()=>({x:this.x,y:this.y})}),this.setCollideWorldBounds(!0),this.setBounce(0),this.currentSkin=Ae.find(d=>d.id===n)??Ae[0];const a=Vt(this.currentSkin),o=this.currentSkin.frameWidth??48,l=this.currentSkin.frameHeight??48,c=Va(o,l);this.setSize(c.width,c.height),this.setOffset(c.offsetX,c.offsetY),this.setScale(a),this.setDepth(qt.DEPTH),this.animations.play(this,"idle")}getPosition(){return{x:this.x,y:this.y}}setPlayerPosition(e,t){this.x=e,this.y=t}getGroundY(e,t){return Xt(e,t)}getPlayerType(){return"static"}getHitBounds(){const e=Vt(this.currentSkin),t=(this.currentSkin.frameWidth??48)*e,s=(this.currentSkin.frameHeight??48)*e,n=t*Us.WIDTH,a=(t-n)/2,o=this.originX??.5,l=this.originY??.5,c=this.x-t*o,d=this.y-s*l;return{x:c+a,y:d,width:n,height:s}}setFacing(e){const t=this.currentSkin.facingLeft??!1;e==="left"?this.setFlipX(!t):this.setFlipX(t)}playAnimation(e){(e==="idle"||e==="run"||e==="jump"||e==="fall")&&this.animations.play(this,e)}setTint(e){return super.setTint(e)}clearTint(){return super.clearTint()}setAlpha(e){return super.setAlpha(e)}getGameObject(){return this}changeSkin(e){this.currentSkin=Ae.find(d=>d.id===e)??Ae[0];const t=Vt(this.currentSkin),s=this.currentSkin.frameWidth??48,n=this.currentSkin.frameHeight??48,a=Math.round(s*.33),o=Math.round(n*.25),l=Math.round((s-a)/2),c=Math.round(n*.75);this.setSize(a,o),this.setOffset(l,c),this.setScale(t),this.animations.handleSkinChange(this,e)}update(){const e=this.inputController.getInputState();this.inputController.hasAnyInput()&&!this.hasReceivedInput&&(this.hasReceivedInput=!0),this.hasReceivedInput&&this.inputController.hasAnyInput()&&!this.hasNotifiedMovement&&(this.hasNotifiedMovement=!0,ii.set(!0));const t=this.currentSkin.facingLeft??!1;switch(e.left?(this.setVelocityX(-350),this.setFlipX(!t)):e.right?(this.setVelocityX(ws.SPEED),this.setFlipX(t)):this.setVelocityX(0),e.jump&&this.body?.blocked.down&&this.setVelocityY(ws.JUMP_SPEED),this.body?.blocked.down?e.left||e.right?this.animState="running":this.animState="idle":this.body.velocity.y<0?this.animState="jumping":this.animState="falling",this.animState){case"idle":this.playAnimation("idle");break;case"running":this.playAnimation("run");break;case"jumping":this.playAnimation("jump");break;case"falling":this.playAnimation("fall");break}}destroy(e){this.inputController.destroy(),super.destroy(e)}}const Br=48,Gr=48;function Hn(i){Ae.forEach(e=>{const t=e.frameWidth??Br,s=e.frameHeight??Gr,n=fs(e);i.load.spritesheet(`${e.id}-idle`,`${n}/idle.png`,{frameWidth:t,frameHeight:s}),i.load.spritesheet(`${e.id}-run`,`${n}/run.png`,{frameWidth:t,frameHeight:s}),i.load.spritesheet(`${e.id}-jump`,`${n}/jump.png`,{frameWidth:t,frameHeight:s}),i.load.spritesheet(`${e.id}-fall`,`${n}/fall.png`,{frameWidth:t,frameHeight:s})})}function Nr(i,e){const t=e.id;i.anims.exists(`${t}-idle`)&&i.anims.remove(`${t}-idle`),i.anims.exists(`${t}-run`)&&i.anims.remove(`${t}-run`),i.anims.exists(`${t}-jump`)&&i.anims.remove(`${t}-jump`),i.anims.exists(`${t}-fall`)&&i.anims.remove(`${t}-fall`);const s=i.textures.get(`${t}-idle`),n=i.textures.get(`${t}-run`),a=i.textures.get(`${t}-jump`),o=i.textures.get(`${t}-fall`),l=s.frameTotal-1,c=n.frameTotal-1,d=a.key!=="__MISSING"?a.frameTotal-1:0,h=o.key!=="__MISSING"?o.frameTotal-1:0,f=e.frameRates?.idle??6,S=e.frameRates?.run??12,C=e.frameRates?.jump??10,y=e.frameRates?.fall??10;i.anims.create({key:`${t}-idle`,frames:i.anims.generateFrameNumbers(`${t}-idle`,{start:0,end:l-1}),frameRate:f,repeat:-1}),i.anims.create({key:`${t}-run`,frames:i.anims.generateFrameNumbers(`${t}-run`,{start:0,end:c-1}),frameRate:S,repeat:-1}),d>0&&i.anims.create({key:`${t}-jump`,frames:i.anims.generateFrameNumbers(`${t}-jump`,{start:0,end:d-1}),frameRate:C,repeat:-1}),h>0&&i.anims.create({key:`${t}-fall`,frames:i.anims.generateFrameNumbers(`${t}-fall`,{start:0,end:h-1}),frameRate:y,repeat:-1})}function Ln(i){Ae.forEach(e=>{Nr(i,e)})}const Pt={HEIGHT:qe,VISUAL:{COLOR:9139029,ALPHA:.3},PHYSICS:{COLOR:0,ALPHA:0}},Ft={getGroundY(i,e=qe){return i-e},createVisualGround(i,e){const t=e.height??Pt.HEIGHT,s=Ft.getGroundY(e.worldHeight,t),n=i.add.rectangle(0,s,e.worldWidth,t,e.color??Pt.VISUAL.COLOR,e.alpha??Pt.VISUAL.ALPHA);return n.setOrigin(0,0),n.setDepth(e.depth??Ye.GROUND_REFERENCE),{ground:n,groundY:s}},createPhysicsGround(i,e){const t=e.height??Pt.HEIGHT,s=Ft.getGroundY(e.worldHeight,t),n=i.add.rectangle(0,s,e.worldWidth,t,e.color??Pt.PHYSICS.COLOR,e.alpha??Pt.PHYSICS.ALPHA);return n.setOrigin(0,0),i.physics.add.existing(n,!0),{ground:n,groundY:s}},addPlayerCollision(i,e,t){return i.physics.add.collider(e,t)}};class Kr{scene;player=null;useModularPlayer=!1;savedCharacterSelection=null;constructor(e){this.scene=e}init(){const e=localStorage.getItem("useModularPlayer");this.savedCharacterSelection=qs(),this.useModularPlayer=e==="true"&&this.savedCharacterSelection!==null}preload(){this.useModularPlayer||Hn(this.scene)}async loadAssets(){this.useModularPlayer||Ln(this.scene),this.useModularPlayer&&this.savedCharacterSelection&&await Ti.preloadCharacter(this.scene,this.savedCharacterSelection)}createPlayer(e,t,s){if(this.useModularPlayer&&this.savedCharacterSelection){const n=rs(e.worldHeight,s),a=Math.min(e.playerStartY,n),o=new Ti(this.scene,e.playerStartX,a,this.savedCharacterSelection);o.buildCharacter(),this.player=o,Ft.addPlayerCollision(this.scene,o,t)}else{const n=Xt(e.worldHeight,s),a=Math.min(e.playerStartY,n),o=new Zr(this.scene,e.playerStartX,a);this.player=o,Ft.addPlayerCollision(this.scene,o,t)}return this.player}getPlayer(){return this.player}isModular(){return this.useModularPlayer}}async function Di(){const i=await fetch("./config/map.json");if(!i.ok)throw new Error(`Failed to load map config: ${i.status}`);const e=await i.json();if(!e.worldWidth||!e.worldHeight)throw new Error("Invalid map config structure");return e}const vs={generateId(){return`item_${Date.now()}_${Math.random().toString(36).substr(2,9)}`},create(i){const{assetKey:e,x:t,yOffset:s=0,depthLayer:n="behind",scale:a}=i;return{id:vs.generateId(),assetKey:e,x:Math.round(t),y:0,scale:a??Ba(e),depth:ti(n),yOffset:Math.round(s)}},createAtWorldPosition(i,e,t,s,n="behind"){return vs.create({assetKey:i,x:e,yOffset:t-s,depthLayer:n})},clone(i,e=50){return{...i,id:vs.generateId(),x:i.x+e}}},at=[{name:"FOREST SUMMER",folder:"forest_summer",scrollFactors:[.9,.95,.975,1,1.05],foregroundLayers:1,groundHeight:90,itemGroups:["shared","forest_summer","forest_shared"]},{name:"FOREST BIRCH",folder:"forest_birch",scrollFactors:[.9,.95,.975,1,1.05],foregroundLayers:1,groundHeight:30,itemGroups:["shared","forest_birch","forest_shared"]},{name:"CAVE DARK",folder:"cave_dark",scrollFactors:[.85,.875,.9,.925,.95,.975,1.05],foregroundLayers:2,groundHeight:20,itemGroups:["shared","cave_dark"]}];class zr{currentIndex=0;constructor(){const e=localStorage.getItem("background");if(e){const t=at.findIndex(s=>s.folder===e);t!==-1&&(this.currentIndex=t)}}getBackground(){return at[this.currentIndex].folder}getCurrentConfig(){return at[this.currentIndex]}setBackground(e){const t=at.findIndex(s=>s.folder===e);t!==-1&&(this.currentIndex=t,localStorage.setItem("background",e))}toggleBackground(){this.currentIndex=(this.currentIndex+1)%at.length;const e=at[this.currentIndex];return localStorage.setItem("background",e.folder),e}getAllBackgrounds(){return at}setBackgroundByIndex(e){e>=0&&e<at.length&&(this.currentIndex=e,localStorage.setItem("background",at[e].folder))}getCurrentIndex(){return this.currentIndex}}const tt=new zr;function On(i,e){return new Promise(t=>{for(let s=0;s<e.scrollFactors.length;s++){const n=s+1;i.load.image(`bg${n}-${e.folder}`,`assets/backgrounds/${e.folder}/${n}.png`)}i.load.once("complete",()=>{t(!0)}),i.load.once("loaderror",s=>{console.error(`Failed to load background asset: ${s.key}`),t(!1)}),i.load.start()})}function Rn(i,e,t,s){const n=[],a=[],o=s.foregroundLayers??0,c=s.scrollFactors.length-o;for(let d=0;d<s.scrollFactors.length;d++){const f=`bg${d+1}-${s.folder}`,S=s.scrollFactors[d];if(i.textures.exists(f)){const C=i.textures.getFrame(f),y=C.width,w=C.height,P=t/w,p=y*P,b=e*3,v=Math.ceil(b/p)*y+y,g=i.add.tileSprite(0,0,v,w,f);g.setOrigin(0,0),g.setScale(P),g.setScrollFactor(1),g.setData("scrollFactor",S),g.setData("scale",P),d>=c?(g.setDepth(Ye.FOREGROUND_LAYER_START+(d-c)),a.push(g)):(g.setDepth(Ye.BACKGROUND_LAYER_START+d),n.push(g))}}return{bgLayers:n,fgLayers:a}}function Xn(i,e){if(!i)return;const t=e.width/e.zoom,s=e.getBounds().width,n=Math.max(0,s-t),a=Math.max(0,Math.min(e.scrollX,n)),o=[...i.bgLayers,...i.fgLayers];for(const l of o){const c=l.getData("scrollFactor"),d=l.getData("scale");l.tilePositionX=a*(1-c)/d}}function Ur(i){i.bgLayers.forEach(e=>e.destroy()),i.fgLayers.forEach(e=>e.destroy())}class jr{scene;mapConfig;parallaxLayers=null;loadedBackgrounds=new Set;ground=null;groundY=0;constructor(e){this.scene=e}async loadMapConfiguration(e=!1){try{if(e){const t=va();this.mapConfig=t||await Di()}else this.mapConfig=await Di()}catch(t){console.error("[MapManager] Failed to load map configuration:",t);const s=600;this.mapConfig={worldWidth:3200,worldHeight:s,playerStartX:400,playerStartY:Xt(s),placedItems:[]}}return this.mapConfig}async setupBackground(){const e=tt.getCurrentConfig();this.loadedBackgrounds.has(e.folder)||await On(this.scene,e)&&this.loadedBackgrounds.add(e.folder),this.parallaxLayers=Rn(this.scene,this.mapConfig.worldWidth,this.mapConfig.worldHeight,e)}createGround(){const t=tt.getCurrentConfig().groundHeight??40,s=Ft.createPhysicsGround(this.scene,{worldWidth:this.mapConfig.worldWidth,worldHeight:this.mapConfig.worldHeight,height:t});return this.ground=s.ground,this.groundY=s.groundY,this.scene.physics.world.setBounds(0,0,this.mapConfig.worldWidth,this.mapConfig.worldHeight),{...s,groundHeight:t}}update(e){this.parallaxLayers&&Xn(this.parallaxLayers,e)}getConfig(){return this.mapConfig}getGround(){return this.ground}getGroundY(){return this.groundY}}class Vr extends B.Scene{playerManager;mapManager;player=null;getMapConfig(){return this.mapManager?.getConfig()||null}itemManager;frameManager;socialManager;dialogZones=[];currentDialogZone=null;unsubscribers=[];initData;isInitialized=!1;constructor(){super({key:et.GAME})}init(e){this.initData=e,this.isInitialized=!1,this.playerManager=new Kr(this),this.mapManager=new jr(this),this.playerManager.init()}preload(){this.playerManager.preload(),bs.preloadAssets(this),Ci.preloadAssets(this),ki.preloadAssets(this)}create(){this.events.on("shutdown",this.shutdown,this),this.initializeScene()}async initializeScene(){Ns.set(!0);try{await this.playerManager.loadAssets();const e=await this.mapManager.loadMapConfiguration(this.initData?.useBuilderConfig);await this.mapManager.setupBackground();const{ground:t,groundY:s,groundHeight:n}=this.mapManager.createGround();this.player=this.playerManager.createPlayer(e,t,n),this.itemManager=new bs(this,s,e.worldWidth,e.worldHeight,!1),e.placedItems&&e.placedItems.length>0&&this.itemManager.createItems(e.placedItems);const a=this.itemManager.getPhysicsGroup();a&&this.player&&this.physics.add.collider(this.player.getGameObject(),a),this.frameManager=new Ci(this),e.placedFrames&&e.placedFrames.length>0&&this.frameManager.createFrames(e.placedFrames),this.socialManager=new ki(this),e.placedSocials&&e.placedSocials.length>0&&this.socialManager.createSocials(e.placedSocials),this.dialogZones=e.dialogZones||[];const o=ci.subscribe(l=>{this.dialogZones=l,this.recheckCurrentZone()});this.unsubscribers.push(o),this.player&&this.cameras.main.startFollow(this.player.getGameObject(),!0,.1,.1),this.setupCameraBounds(),this.scale.on("resize",this.handleResize,this),this.isInitialized=!0}catch(e){console.error("[GameScene] Failed to initialize scene:",e)}finally{Ns.set(!1)}}setupCameraBounds(){const e=this.mapManager.getConfig();if(!e)return;const t=this.cameras.main,s=t.height,n=t.width,a=s/e.worldHeight,o=Math.min(1,a);t.setZoom(o);const l=s/o,c=n/o;let d=0,h=e.worldHeight;l>e.worldHeight&&(d=(e.worldHeight-l)/2,h=l);let f=0,S=e.worldWidth;c>e.worldWidth&&(f=(e.worldWidth-c)/2,S=c),t.setBounds(f,d,S,h),da(e.worldWidth,e.worldHeight,n,s,o)}handleResize(e){!this.cameras?.main||!this.mapManager||this.setupCameraBounds()}shutdown(){this.isInitialized=!1,this.scale.off("resize",this.handleResize,this),Rs(null),this.currentDialogZone=null,this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.itemManager&&this.itemManager.destroy(),this.frameManager&&this.frameManager.destroy(),this.socialManager&&this.socialManager.destroy()}update(){if(!this.isInitialized||!this.player)return;this.player.update();const{x:e,y:t}=this.player.getPosition(),s=this.cameras.main,n=e-s.scrollX,a=t-s.scrollY;la(n,a),ca(s.scrollX,s.scrollY,s.zoom),this.checkDialogZonesForPosition(e),this.mapManager&&this.mapManager.update(this.cameras.main)}checkDialogZonesForPosition(e){let t=null;for(const s of this.dialogZones)if(e>=s.x&&e<=s.x+s.width){t=s;break}t?.id!==this.currentDialogZone?.id&&(this.currentDialogZone=t,Rs(t))}recheckCurrentZone(){if(!this.currentDialogZone)return;const e=this.dialogZones.find(t=>t.id===this.currentDialogZone?.id);e&&(this.currentDialogZone=e,Rs(e))}}const Xs=1,Pi=.001,qr=.15,Mi=400;class Jr{scene;camera;worldWidth;worldHeight;isPanning=!1;panStartX=0;panStartY=0;cameraDragStartX=0;cameraDragStartY=0;isDraggingToScroll=!1;dragScrollStartX=0;dragScrollStartY=0;dragScrollCameraStartX=0;dragScrollCameraStartY=0;currentZoom=1;targetZoom=1;minZoom=.1;isAnimatingReset=!1;zoomTargetWorldPoint=null;pinchStartDistance=0;pinchStartZoom=1;activeTouches=new Map;pinchEndTime=0;isPinching=!1;PINCH_COOLDOWN=150;touchStartTime=0;touchStartPos=null;touchOnSelectedSprite=!1;TAP_MAX_DURATION=200;TAP_MAX_DISTANCE=10;constructor(e,t,s){this.scene=e,this.camera=e.cameras.main,this.worldWidth=t,this.worldHeight=s}setup(){this.calculateMinZoom(),this.setupCamera(),this.setupMouseControls(),this.setupKeyboardControls(),this.setupUpdateLoop()}calculateMinZoom(){const e=this.camera.width/this.worldWidth,t=this.camera.height/this.worldHeight;this.minZoom=Math.min(e,t)}setupCamera(){this.currentZoom=this.minZoom,this.targetZoom=this.minZoom,this.camera.setZoom(this.minZoom);const e=this.camera.width/this.minZoom,t=this.camera.height/this.minZoom,s=Math.min(0,(this.worldWidth-e)/2),n=Math.min(0,(this.worldHeight-t)/2),a=Math.max(this.worldWidth,e),o=Math.max(this.worldHeight,t);this.camera.setBounds(s,n,a,o),this.camera.centerOn(this.worldWidth/2,this.worldHeight/2),cs(this.minZoom)}centerOn(e,t){this.camera.centerOn(e,t),this.clampScroll()}handleResize(){this.calculateMinZoom(),this.currentZoom<this.minZoom&&(this.currentZoom=this.minZoom,this.targetZoom=this.minZoom,this.camera.setZoom(this.minZoom)),this.targetZoom<this.minZoom&&(this.targetZoom=this.minZoom),this.updateCameraBounds(),this.clampScroll(),cs(this.currentZoom)}updateCameraBounds(){const e=this.camera.width/this.currentZoom,t=this.camera.height/this.currentZoom,s=Math.min(0,(this.worldWidth-e)/2),n=Math.min(0,(this.worldHeight-t)/2),a=Math.max(this.worldWidth,e),o=Math.max(this.worldHeight,t);this.camera.setBounds(s,n,a,o)}getScrollBounds(e=!0){const t=this.camera.width/this.currentZoom,s=this.camera.height/this.currentZoom;let n,a,o,l;return t>this.worldWidth?e?n=a=(this.worldWidth-t)/2:(n=this.worldWidth-t,a=0):(n=0,a=this.worldWidth-t),s>this.worldHeight?e?o=l=(this.worldHeight-s)/2:(o=this.worldHeight-s,l=0):(o=0,l=this.worldHeight-s),{minX:n,maxX:a,minY:o,maxY:l}}clampScroll(){const e=this.getScrollBounds(!0);this.camera.scrollX=B.Math.Clamp(this.camera.scrollX,e.minX,e.maxX),this.camera.scrollY=B.Math.Clamp(this.camera.scrollY,e.minY,e.maxY)}softClampScroll(){const e=this.getScrollBounds(!1);this.camera.scrollX=B.Math.Clamp(this.camera.scrollX,e.minX,e.maxX),this.camera.scrollY=B.Math.Clamp(this.camera.scrollY,e.minY,e.maxY)}applyPanDelta(e,t,s,n,a,o){const l=this.getScrollBounds(),c=(e-s)/this.currentZoom,d=(t-n)/this.currentZoom;this.camera.scrollX=B.Math.Clamp(a-c,l.minX,l.maxX),this.camera.scrollY=B.Math.Clamp(o-d,l.minY,l.maxY)}zoomToPoint(e,t,s){const n=this.camera.getWorldPoint(e,t);this.zoomToWorldPoint(n.x,n.y,s)}zoomToWorldPoint(e,t,s){const n=this.camera.scrollX,a=this.camera.scrollY,o=this.currentZoom;this.currentZoom=s,this.camera.setZoom(s),this.updateCameraBounds(),this.camera.scrollX=e-(e-n)*o/s,this.camera.scrollY=t-(t-a)*o/s,this.softClampScroll(),cs(this.currentZoom)}setupMouseControls(){this.scene.input.on("wheel",(e,t,s,n,a)=>{if(this.isAnimatingReset)return;if((e.event.ctrlKey||Math.abs(s)<5&&Math.abs(n)>0)&&!e.event.ctrlKey){const l=-n*Pi*3;this.targetZoom=B.Math.Clamp(this.targetZoom+l,this.minZoom,Xs);const c=this.camera.getWorldPoint(e.x,e.y);this.zoomTargetWorldPoint={x:c.x,y:c.y}}else if(e.event.ctrlKey){const l=-n*Pi,c=B.Math.Clamp(this.currentZoom+l,this.minZoom,Xs);this.targetZoom=c,this.zoomToPoint(e.x,e.y,c)}else{const l=this.getScrollBounds();this.camera.scrollX=B.Math.Clamp(this.camera.scrollX+s/this.currentZoom,l.minX,l.maxX),this.camera.scrollY=B.Math.Clamp(this.camera.scrollY+n/this.currentZoom,l.minY,l.maxY)}}),this.scene.input.on("pointerdown",e=>{if(e.wasTouch){if(this.activeTouches.set(e.id,{x:e.x,y:e.y}),this.activeTouches.size===2){this.isPinching=!0,this.startPinch(),this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.scene.data.set("touchDraggingSprite",!1);return}this.activeTouches.size===1&&!this.isPinching&&(this.touchStartTime=Date.now(),this.touchStartPos={x:e.x,y:e.y},this.dragScrollStartX=e.x,this.dragScrollStartY=e.y,this.dragScrollCameraStartX=this.camera.scrollX,this.dragScrollCameraStartY=this.camera.scrollY,this.touchOnSelectedSprite=yr(this.scene,e),this.scene.data.set("touchDraggingSprite",!1),this.scene.data.set("touchStartOnSelectedSprite",this.touchOnSelectedSprite),this.scene.data.set("touchStartWorldX",e.worldX),this.scene.data.set("touchStartWorldY",e.worldY));return}kt()||bi()||this.isAnimatingReset||(e.rightButtonDown()||e.middleButtonDown()?(this.isPanning=!0,this.panStartX=e.x,this.panStartY=e.y,this.cameraDragStartX=this.camera.scrollX,this.cameraDragStartY=this.camera.scrollY):e.leftButtonDown()&&!this.isDraggingObject()&&(this.scene.data.get("isDraggingItem")===!0||(this.dragScrollStartX=e.x,this.dragScrollStartY=e.y,this.dragScrollCameraStartX=this.camera.scrollX,this.dragScrollCameraStartY=this.camera.scrollY)))}),this.scene.input.on("pointermove",e=>{if(e.wasTouch){if(this.activeTouches.has(e.id)&&this.activeTouches.set(e.id,{x:e.x,y:e.y}),this.activeTouches.size>=2&&this.isPinching){this.handlePinch();return}if(this.isPinching||Date.now()-this.pinchEndTime<this.PINCH_COOLDOWN||this.scene.data.get("touchDraggingSprite"))return;if(this.touchStartPos&&!this.isDraggingToScroll){const t=Math.abs(e.x-this.touchStartPos.x),s=Math.abs(e.y-this.touchStartPos.y);if(Math.sqrt(t*t+s*s)>this.TAP_MAX_DISTANCE){if(this.touchOnSelectedSprite){this.scene.data.set("touchDragStarted",!0),this.scene.data.set("touchDraggingSprite",!0),this.touchStartPos=null;return}!kt()&&!this.isDraggingObject()&&!this.scene.data.get("isDraggingItem")&&(this.isDraggingToScroll=!0,this.touchStartPos=null)}}this.isDraggingToScroll&&this.applyPanDelta(e.x,e.y,this.dragScrollStartX,this.dragScrollStartY,this.dragScrollCameraStartX,this.dragScrollCameraStartY);return}if(!(bi()||this.isAnimatingReset)){if(this.isPanning)this.applyPanDelta(e.x,e.y,this.panStartX,this.panStartY,this.cameraDragStartX,this.cameraDragStartY);else if(e.leftButtonDown()&&!this.isDraggingToScroll&&!this.isDraggingObject()&&!(this.scene.data.get("isDraggingItem")===!0)){const s=Math.abs(e.x-this.dragScrollStartX),n=Math.abs(e.y-this.dragScrollStartY);Math.sqrt(s*s+n*n)>10&&(this.isDraggingToScroll=!0,this.scene.input.setDefaultCursor("grabbing"))}this.isDraggingToScroll&&this.applyPanDelta(e.x,e.y,this.dragScrollStartX,this.dragScrollStartY,this.dragScrollCameraStartX,this.dragScrollCameraStartY)}}),this.scene.input.on("pointerup",e=>{if(e.wasTouch){if(this.isPinching&&(this.pinchEndTime=Date.now(),this.isPinching=!1,Ps(!1)),this.touchStartPos&&!this.isDraggingToScroll){const t=Date.now()-this.touchStartTime,s=Math.abs(e.x-this.touchStartPos.x),n=Math.abs(e.y-this.touchStartPos.y),a=Math.sqrt(s*s+n*n);t<this.TAP_MAX_DURATION&&a<this.TAP_MAX_DISTANCE&&(this.scene.data.set("lastTapTime",Date.now()),this.scene.data.set("lastTapWorldX",e.worldX),this.scene.data.set("lastTapWorldY",e.worldY))}this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.activeTouches.delete(e.id),this.scene.data.set("touchDraggingSprite",!1),this.scene.data.set("touchDragStarted",!1),this.scene.data.set("touchStartOnSelectedSprite",!1),this.isDraggingToScroll&&(this.isDraggingToScroll=!1);return}!e.rightButtonDown()&&!e.middleButtonDown()&&(this.isPanning=!1),this.isDraggingToScroll&&(this.isDraggingToScroll=!1,this.scene.input.setDefaultCursor("default"))}),this.scene.input.on("pointerout",e=>{e.wasTouch&&(this.activeTouches.delete(e.id),this.touchStartPos=null,this.touchOnSelectedSprite=!1,this.isPinching&&this.activeTouches.size<2&&(this.isPinching=!1,this.pinchEndTime=Date.now(),Ps(!1)))})}startPinch(){const e=Array.from(this.activeTouches.values());if(e.length!==2)return;const[t,s]=e;this.pinchStartDistance=Math.hypot(s.x-t.x,s.y-t.y),this.pinchStartZoom=this.currentZoom,Ps(!0)}handlePinch(){const e=Array.from(this.activeTouches.values());if(e.length!==2)return;const[t,s]=e,n=Math.hypot(s.x-t.x,s.y-t.y),a=(t.x+s.x)/2,o=(t.y+s.y)/2,l=n/this.pinchStartDistance,c=B.Math.Clamp(this.pinchStartZoom*l,this.minZoom,Xs);this.targetZoom=c,this.zoomToPoint(a,o,c)}setupKeyboardControls(){const e={up:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.UP,!1),down:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.DOWN,!1),left:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.LEFT,!1),right:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.RIGHT,!1)},t={w:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.W,!1),a:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.A,!1),s:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.S,!1),d:this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.D,!1)};this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.SPACE,!1).on("down",()=>{Ot()||this.centerOnPlayer()}),this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.F,!1).on("down",()=>{Ot()||this.resetToFit()}),this.scene.data.set("cameraArrowKeys",e),this.scene.data.set("cameraWasdKeys",t)}setupUpdateLoop(){const e=this.scene.data.get("cameraArrowKeys"),t=this.scene.data.get("cameraWasdKeys");this.scene.events.on("update",()=>{if(!this.isAnimatingReset&&Math.abs(this.currentZoom-this.targetZoom)>1e-4){const a=B.Math.Linear(this.currentZoom,this.targetZoom,qr);this.zoomTargetWorldPoint?this.zoomToWorldPoint(this.zoomTargetWorldPoint.x,this.zoomTargetWorldPoint.y,a):this.zoomToPoint(this.camera.width/2,this.camera.height/2,a),Math.abs(this.currentZoom-this.targetZoom)<.001&&(this.zoomTargetWorldPoint=null)}if(Ot()||this.isAnimatingReset)return;const s=10/this.currentZoom,n=this.getScrollBounds();e?.left?.isDown||t?.a?.isDown?this.camera.scrollX=B.Math.Clamp(this.camera.scrollX-s,n.minX,n.maxX):(e?.right?.isDown||t?.d?.isDown)&&(this.camera.scrollX=B.Math.Clamp(this.camera.scrollX+s,n.minX,n.maxX)),e?.up?.isDown||t?.w?.isDown?this.camera.scrollY=B.Math.Clamp(this.camera.scrollY-s,n.minY,n.maxY):(e?.down?.isDown||t?.s?.isDown)&&(this.camera.scrollY=B.Math.Clamp(this.camera.scrollY+s,n.minY,n.maxY))})}centerOnPlayer(){const e=this.scene.data.get("playerSprite");e&&(this.camera.centerOn(e.x,e.y),this.clampScroll())}isDraggingObject(){return this.scene.data.get("isDraggingObject")===!0||this.scene.data.get("isDraggingItem")===!0}resetToFit(){if(this.isAnimatingReset)return;this.isAnimatingReset=!0,this.targetZoom=this.minZoom;const e=this.camera.width/this.minZoom,t=this.camera.height/this.minZoom,s=(this.worldWidth-e)/2,n=(this.worldHeight-t)/2,a=s+e/2,o=n+t/2;this.camera.pan(a,o,Mi,"Sine.easeInOut"),this.camera.zoomTo(this.minZoom,Mi,"Sine.easeInOut",!1,(l,c)=>{c===1&&(this.currentZoom=this.minZoom,this.camera.scrollX=s,this.camera.scrollY=n,this.isAnimatingReset=!1,cs(this.minZoom))})}destroy(){this.activeTouches.clear()}}class Qr{scene;player;modularCharacter=null;worldWidth;worldHeight;unsubscribers=[];interactionCleanup=null;useModular=!1;modularSelection=null;debugGraphics=null;isSelected=!1;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s;const n=localStorage.getItem("useModularPlayer");this.modularSelection=qs(),this.useModular=n==="true"&&this.modularSelection!==null}async preload(){!this.useModular||!this.modularSelection||await Ni(this.scene,this.modularSelection)}create(e,t){const s=tt.getCurrentConfig().groundHeight??qe;if(this.useModular&&this.modularSelection){const n=rs(this.worldHeight,s),a=Math.min(t,n);return this.createModularPlayer(e,a)}else{const n=Math.min(t,Xt(this.worldHeight,s));return this.createStaticPlayer(e,n)}}createStaticPlayer(e,t){const s=Ct.getSkinId(),n=Ae.find(l=>l.id===s)??Ae[0],a=Vt(n),o=this.scene.add.sprite(e,t,`${s}-idle`,0);return o.setScale(a),o.setDepth(qt.DEPTH),o.setData("isPlayer",!0),this.player=o,this.scene.data.set("playerSprite",this.player),this.setupInteraction(),this.setupEditModeSubscription(),this.setupSelectionSubscription(),o}createModularPlayer(e,t){this.modularCharacter=new Ki(this.scene,e,t,this.modularSelection,{animated:!1,facing:"right",scale:Kt});const s=this.modularCharacter;return s.setDepth(qt.DEPTH),s.setData("isPlayer",!0),this.player=s,this.scene.data.set("playerSprite",this.player),this.setupInteraction(),this.setupEditModeSubscription(),this.setupSelectionSubscription(),s}setupInteraction(){let e;if(this.useModular&&this.modularCharacter)e=new B.Geom.Rectangle(-80/2,-64/2,pt.FRAME_WIDTH,pt.FRAME_HEIGHT),this.scene.data.set("modularPlayerHitArea",e);else{const t=Ct.getSkinId(),s=Ae.find(c=>c.id===t)??Ae[0],n=s.frameWidth??48,a=s.frameHeight??48,o=n*Us.WIDTH,l=(n-o)/2;e=new B.Geom.Rectangle(l,0,o,a)}this.interactionCleanup=Ts({sprite:this.player,scene:this.scene,useGridSnapping:!1,cursor:"grab",hitArea:e,constraints:{minX:wi,maxX:this.worldWidth-wi,minY:rr},callbacks:{onSelect:()=>{Wa(!0)},isSelected:()=>Je(vi),onDragStart:()=>{this.scene.data.set("isDraggingObject",!0)},onDrag:(t,s)=>{yi(Math.round(t),Math.round(s)),this.updateDebugVisualization()},onDragEnd:(t,s)=>{this.scene.data.set("isDraggingObject",!1);let n=this.player.y;const a=tt.getCurrentConfig().groundHeight??qe;this.useModular?ja(this.player.y,this.worldHeight,a)&&(n=rs(this.worldHeight,a),this.player.setY(n)):Ua(this.player.y,this.worldHeight,a)&&(n=Xt(this.worldHeight,a),this.player.setY(n)),yi(Math.round(this.player.x),Math.round(n)),this.updateDebugVisualization()}}}),Ii&&this.createDebugVisualization()}createDebugVisualization(){this.debugGraphics&&this.debugGraphics.destroy(),this.debugGraphics=this.scene.add.graphics(),this.debugGraphics.setDepth(qt.DEPTH+1),this.updateDebugVisualization()}updateDebugVisualization(){if(!this.debugGraphics||!Ii)return;this.debugGraphics.clear();const e=this.isSelected?hr:lr,t=this.isSelected?ur:cr,s=this.isSelected?gr:dr;let n=null;if(this.useModular&&this.modularCharacter){const a=this.player,o=this.scene.data.get("modularPlayerHitArea");if(o&&a.input){const l=a.scaleX;n={x:a.x+o.x*l,y:a.y+o.y*l,width:o.width*l,height:o.height*l}}}else{const a=this.player,o=Ct.getSkinId(),l=Ae.find(w=>w.id===o)??Ae[0],c=Vt(l),d=(l.frameWidth??48)*c,h=(l.frameHeight??48)*c,f=d*Us.WIDTH,S=(d-f)/2,C=a.originX??.5,y=a.originY??.5;n={x:a.x-d*C+S,y:a.y-h*y,width:f,height:h}}n&&(this.debugGraphics.fillStyle(xi,e),this.debugGraphics.fillRect(n.x,n.y,n.width,n.height),this.debugGraphics.lineStyle(t,xi,s),this.debugGraphics.strokeRect(n.x,n.y,n.width,n.height))}setupSelectionSubscription(){const e=vi.subscribe(t=>{this.isSelected=t,this.updateDebugVisualization(),this.scene.data.set("isPlayerSelected",t)});this.unsubscribers.push(e)}setupEditModeSubscription(){const e=Ze.subscribe(t=>{t==="dialogs"?(this.interactionCleanup&&(this.interactionCleanup(),this.interactionCleanup=null),this.player.disableInteractive(),this.setAlpha(.6)):(this.setAlpha(1),this.interactionCleanup||this.setupInteraction())});this.unsubscribers.push(e)}setAlpha(e){this.modularCharacter?this.modularCharacter.setAlpha(e):this.player.setAlpha(e)}getSprite(){return this.player}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.interactionCleanup&&(this.interactionCleanup(),this.interactionCleanup=null),this.debugGraphics&&(this.debugGraphics.destroy(),this.debugGraphics=null),this.modularCharacter?(this.modularCharacter.destroy(),this.modularCharacter=null):this.player&&this.player.destroy()}}class eo{scene;graphics;worldWidth;worldHeight;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}create(){return this.graphics=this.scene.add.graphics(),this.graphics.setDepth(En),this.draw(),this.graphics}draw(){this.graphics.clear(),this.graphics.lineStyle(er,Ja,Qa);const e=Math.max(this.worldHeight,this.scene.scale.height);for(let n=0;n<=this.worldWidth;n+=Ht)this.graphics.beginPath(),this.graphics.moveTo(n,0),this.graphics.lineTo(n,e),this.graphics.strokePath();for(let n=0;n<=e;n+=Ht)this.graphics.beginPath(),this.graphics.moveTo(0,n),this.graphics.lineTo(this.worldWidth,n),this.graphics.strokePath();const t=tt.getCurrentConfig().groundHeight??qe,s=this.worldHeight-t;this.graphics.lineStyle(tr,Os,sr),this.graphics.beginPath(),this.graphics.moveTo(0,s),this.graphics.lineTo(this.worldWidth,s),this.graphics.strokePath(),this.graphics.lineStyle(nr,Os,ar),this.graphics.fillStyle(Os,ir),this.graphics.fillRect(0,s,this.worldWidth,e-s)}getGraphics(){return this.graphics}redraw(){this.draw()}destroy(){this.graphics&&this.graphics.destroy()}}class to{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set);const s=this.listeners.get(e);return s.add(t),{unsubscribe:()=>{s.delete(t),s.size===0&&this.listeners.delete(e)}}}once(e,t){const s=this.on(e,n=>{s.unsubscribe(),t(n)});return s}emit(e,t){const s=this.listeners.get(e);s&&s.forEach(n=>{try{n(t)}catch(a){console.error(`[EventBus] Error in listener for "${e}":`,a)}})}off(e){this.listeners.delete(e)}clear(){this.listeners.clear()}listenerCount(e){return this.listeners.get(e)?.size??0}}const We=new to,$e={ASSET_DROPPED:"asset:dropped",FRAME_DROPPED:"frame:dropped",SOCIAL_DROPPED:"social:dropped",MINIMAP_NAVIGATE:"minimap:navigate",DIALOG_ZONE_CREATE:"dialogZone:create",DIALOG_ZONE_CREATE_AT:"dialogZone:createAt",TEMP_ZONE_BUTTON_SHOW:"tempZoneButton:show",TEMP_ZONE_BUTTON_HIDE:"tempZoneButton:hide"};class so{scene;groundY;worldWidth;worldHeight;itemManager;unsubscribers=[];constructor(e,t,s,n){this.scene=e,this.groundY=t,this.worldWidth=s,this.worldHeight=n}create(e){return this.itemManager=new bs(this.scene,this.groundY,this.worldWidth,this.worldHeight,!0),e&&e.length>0&&this.itemManager.createItems(e),this.setupBackgroundDeselect(),this.setupStoreSubscriptions(),this.setupAssetDropListener(),this.setupDeleteKeys(),this.itemManager}setupBackgroundDeselect(){this.itemManager.setupBackgroundDeselect()}setupStoreSubscriptions(){const e=xs.subscribe(a=>{this.scene.data.set("selectedItemId",a),this.itemManager.updateSelectionVisuals()});this.unsubscribers.push(e);const t=Ze.subscribe(a=>{a==="dialogs"?(di(),this.itemManager.setInteractiveEnabled(!1)):this.itemManager.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const n=ga.subscribe(a=>{if(!a?.placedItems)return;const o=a.placedItems;s.forEach(l=>{o.find(d=>d.id===l.id)||this.itemManager.removeItem(l.id)}),o.forEach(l=>{const c=s.find(d=>d.id===l.id);c&&JSON.stringify(c)!==JSON.stringify(l)&&this.itemManager.updateItem(l.id,l)}),s=o.map(l=>({...l}))});this.unsubscribers.push(n)}setupAssetDropListener(){const e=We.on($e.ASSET_DROPPED,t=>{const{assetKey:s,canvasX:n,canvasY:a}=t,l=this.scene.cameras.main.getWorldPoint(n,a),c=Math.max(0,Math.min(this.worldWidth,l.x)),d=Math.max(0,Math.min(this.worldHeight,l.y));let h="behind";tn.subscribe(C=>{h=C})();const S=vs.createAtWorldPosition(s,c,d,this.groundY,h);Sa(S),this.itemManager.createItem(S),an(S.id),Et.set(!1)});this.unsubscribers.push(()=>e.unsubscribe())}setupDeleteKeys(){const e=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.DELETE,!1),t=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.BACKSPACE,!1),s=()=>{if(Ot())return;const n=this.scene.data.get("selectedItemId");n&&nn(n)};e.on("down",s),t.on("down",s)}getManager(){return this.itemManager}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.itemManager&&this.itemManager.destroy()}}class Ai{scene;worldWidth;worldHeight;frames=new Map;unsubscribers=[];selectionGraphics=null;cleanupFunctions=new Map;doubleClickDetector=new kn;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}static preloadAssets(e){for(let t=1;t<=25;t++)e.load.image(`frame_base_${t}`,`assets/frames/base ${t}.png`)}create(e){this.selectionGraphics=this.scene.add.graphics(),this.selectionGraphics.setDepth(Ye.SELECTION_GRAPHICS),e&&e.length>0&&e.forEach(t=>this.createFrame(t)),this.setupStoreSubscriptions(),this.setupFrameDropListener(),this.setupDeleteKeys()}createFrame(e){const t=`frame_${e.frameKey}`;if(!this.scene.textures.exists(t)){console.warn(`Frame texture not found: ${t}`);return}const s=e.scale??dt,n=e.depth??Ye.ITEMS_FRONT,a=(e.rotation??0)*(Math.PI/180),o=e.rotation===90,{innerWidth:l,innerHeight:c}=Jt(s,o),d=this.scene.add.graphics();d.setDepth(n-.1),ms(d,e.x,e.y,l,c,e.backgroundColor||Nt);const h=this.scene.add.sprite(e.x,e.y,t);h.setScale(s),h.setDepth(n),h.setOrigin(.5,.5),h.setRotation(a),h.setData("frameId",e.id);const f={sprite:h,background:d,data:e};this.frames.set(e.id,f),this.makeInteractive(f,e.id)}updateFrameVisuals(e){const{sprite:t,background:s,data:n}=e,a=`frame_${n.frameKey}`;t.texture.key!==a&&this.scene.textures.exists(a)&&t.setTexture(a);const o=n.scale??dt;t.setScale(o);const l=(n.rotation??0)*(Math.PI/180);t.setRotation(l);const c=n.rotation===90,{innerWidth:d,innerHeight:h}=Jt(o,c);ms(s,t.x,t.y,d,h,n.backgroundColor||Nt)}moveContainer(e,t,s){const{sprite:n,background:a,data:o}=e;n.setPosition(t,s);const l=o.scale??dt,c=o.rotation===90,{innerWidth:d,innerHeight:h}=Jt(l,c);ms(a,t,s,d,h,o.backgroundColor||Nt)}makeInteractive(e,t){const{sprite:s}=e,n=Ts({sprite:s,scene:this.scene,cursor:"grab",useGridSnapping:!0,constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{zt(t),this.updateSelectionVisuals()},isSelected:()=>Je(ns)===t,onDoubleClick:()=>this.doubleClickDetector.check(t)?(dn(),!0):!1,onDragStart:()=>{s.setTint(Cn)},onDrag:(a,o)=>{this.moveContainer(e,a,o),this.updateSelectionVisuals(),$a(t,a,o)},onDragEnd:(a,o)=>{s.clearTint(),Ha(t),e.data.x=Math.round(a),e.data.y=Math.round(o),nt(t,{x:e.data.x,y:e.data.y})}}});this.cleanupFunctions.set(t,n)}setupStoreSubscriptions(){const e=ns.subscribe(a=>{this.scene.data.set("selectedFrameId",a),this.updateSelectionVisuals()});this.unsubscribers.push(e);const t=Ze.subscribe(a=>{a==="dialogs"?(zt(null),this.setInteractiveEnabled(!1)):this.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const n=gn.subscribe(a=>{s.forEach(o=>{a.find(c=>c.id===o.id)||this.removeFrame(o.id)}),a.forEach(o=>{const l=s.find(d=>d.id===o.id),c=this.frames.get(o.id);if(c&&l){const d=l.backgroundColor!==o.backgroundColor,h=l.textColor!==o.textColor,f=l.textSize!==o.textSize,S=JSON.stringify(l.texts)!==JSON.stringify(o.texts),C=l.rotation!==o.rotation,y=l.scale!==o.scale,w=l.frameKey!==o.frameKey;c.data=o,(d||h||f||S||C||y||w)&&(this.updateFrameVisuals(c),this.scene.data.get("selectedFrameId")===o.id&&this.updateSelectionVisuals())}}),s=a.map(o=>({...o}))});this.unsubscribers.push(n)}setupFrameDropListener(){const e=We.on($e.FRAME_DROPPED,t=>{const{frameKey:s,canvasX:n,canvasY:a}=t,l=this.scene.cameras.main.getWorldPoint(n,a),c=Math.max(0,Math.min(this.worldWidth,l.x)),d=Math.max(0,Math.min(this.worldHeight,l.y)),h={id:_r(),frameKey:s,x:Math.round(c),y:Math.round(d),scale:Ar(s),depth:Ye.ITEMS_FRONT,rotation:90,backgroundColor:Nt,textColor:"#333333",textSize:16,texts:[{language:"cs",text:""},{language:"en",text:""}]};La(h),this.createFrame(h),zt(h.id)});this.unsubscribers.push(()=>e.unsubscribe())}setupDeleteKeys(){const e=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.DELETE,!1),t=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.BACKSPACE,!1),s=()=>{if(Ot())return;let n="items";if(Ze.subscribe(l=>n=l)(),n!=="frames")return;const o=this.scene.data.get("selectedFrameId");o&&oi(o)};e.on("down",s),t.on("down",s)}updateSelectionVisuals(){if(!this.selectionGraphics)return;this.selectionGraphics.clear();const e=this.scene.data.get("selectedFrameId");if(!e){As(null);return}const t=this.frames.get(e);if(!t){As(null);return}const s=t.sprite,n=s.getBounds(),a=this.scene.cameras.main,{screenX:o,screenY:l}=xt(s.x,s.y,a);As({screenX:o,screenY:l,frameHeight:n.height*a.zoom}),this.selectionGraphics.lineStyle(3,ls.FRAME.hex,1),this.selectionGraphics.strokeRect(n.x-4,n.y-4,n.width+8,n.height+8)}removeFrame(e){const t=this.frames.get(e);t&&(t.sprite.destroy(),t.background.destroy(),this.frames.delete(e)),this.updateSelectionVisuals()}setInteractiveEnabled(e){this.frames.forEach(({sprite:t,background:s})=>{e?(t.setInteractive(),t.setAlpha(1),s.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6),s.setAlpha(.6))}),!e&&this.selectionGraphics&&this.selectionGraphics.clear()}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.frames.forEach(({sprite:e,background:t})=>{e.destroy(),t.destroy()}),this.frames.clear(),this.selectionGraphics&&(this.selectionGraphics.destroy(),this.selectionGraphics=null)}}class $i{scene;worldWidth;worldHeight;socials=new Map;unsubscribers=[];selectionGraphics=null;cleanupFunctions=new Map;doubleClickDetector=new kn;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}static preloadAssets(e){e.load.image("social_discord","assets/socials/Discord.png"),e.load.image("social_facebook","assets/socials/Facebook.png"),e.load.image("social_instagram","assets/socials/Instagram.png"),e.load.image("social_kofi","assets/socials/Ko Fi.png"),e.load.image("social_linkedin","assets/socials/LinkedIn.png"),e.load.image("social_patreon","assets/socials/Patreon.png"),e.load.image("social_tiktok","assets/socials/TikTok.png"),e.load.image("social_twitch","assets/socials/Twitch.png"),e.load.image("social_twitter","assets/socials/Twitter.png"),e.load.image("social_whatsapp","assets/socials/Whatsapp.png"),e.load.image("social_youtube","assets/socials/Youtube.png")}create(e){this.selectionGraphics=this.scene.add.graphics(),this.selectionGraphics.setDepth(Ye.SELECTION_GRAPHICS),e&&e.length>0&&e.forEach(t=>this.createSocial(t)),this.setupStoreSubscriptions(),this.setupSocialDropListener(),this.setupDeleteKeys()}createSocial(e){const t=`social_${e.socialKey}`;if(!this.scene.textures.exists(t)){console.warn(`Social texture not found: ${t}`);return}const s=e.scale??Rt,n=e.depth??Ye.ITEMS_FRONT,a=this.scene.add.sprite(e.x,e.y,t);a.setScale(s),a.setDepth(n),a.setOrigin(.5,.5),a.setData("socialId",e.id),this.socials.set(e.id,{sprite:a,data:e}),this.makeInteractive(e.id)}updateSocialVisuals(e){const t=this.socials.get(e);if(!t)return;const{sprite:s,data:n}=t,a=`social_${n.socialKey}`;s.texture.key!==a&&this.scene.textures.exists(a)&&s.setTexture(a);const o=n.scale??Rt;s.setScale(o)}makeInteractive(e){const t=this.socials.get(e);if(!t)return;const{sprite:s}=t,n=Ts({sprite:s,scene:this.scene,cursor:"grab",useGridSnapping:!0,constraints:{minX:0,maxX:this.worldWidth,minY:0,maxY:this.worldHeight},callbacks:{onSelect:()=>{Ut(e),this.updateSelectionVisuals()},isSelected:()=>Je(as)===e,onDoubleClick:()=>this.doubleClickDetector.check(e)?(hn(),!0):!1,onDragStart:()=>{s.setTint(Cn)},onDrag:()=>{this.updateSelectionVisuals()},onDragEnd:(a,o)=>{s.clearTint();const l=this.socials.get(e);l&&(l.data.x=Math.round(a),l.data.y=Math.round(o),gs(e,{x:l.data.x,y:l.data.y}))}}});this.cleanupFunctions.set(e,n)}setupStoreSubscriptions(){const e=as.subscribe(a=>{this.scene.data.set("selectedSocialId",a),this.updateSelectionVisuals()});this.unsubscribers.push(e);const t=Ze.subscribe(a=>{a==="dialogs"?(Ut(null),this.setInteractiveEnabled(!1)):this.setInteractiveEnabled(!0)});this.unsubscribers.push(t);let s=[];const n=Oa.subscribe(a=>{s.forEach(o=>{a.find(c=>c.id===o.id)||this.removeSocial(o.id)}),a.forEach(o=>{const l=s.find(d=>d.id===o.id),c=this.socials.get(o.id);if(c&&l){const d=l.scale!==o.scale,h=l.socialKey!==o.socialKey;c.data=o,(d||h)&&(this.updateSocialVisuals(o.id),this.scene.data.get("selectedSocialId")===o.id&&this.updateSelectionVisuals())}}),s=a.map(o=>({...o}))});this.unsubscribers.push(n)}setupSocialDropListener(){const e=We.on($e.SOCIAL_DROPPED,t=>{const{socialKey:s,canvasX:n,canvasY:a}=t,l=this.scene.cameras.main.getWorldPoint(n,a),c=Math.max(0,Math.min(this.worldWidth,l.x)),d=Math.max(0,Math.min(this.worldHeight,l.y)),h={id:Xr(),socialKey:s,x:Math.round(c),y:Math.round(d),scale:Rt,depth:Ye.ITEMS_FRONT};Xa(h),this.createSocial(h),Ut(h.id)});this.unsubscribers.push(()=>e.unsubscribe())}setupDeleteKeys(){const e=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.DELETE,!1),t=this.scene.input.keyboard.addKey(B.Input.Keyboard.KeyCodes.BACKSPACE,!1),s=()=>{if(Ot())return;let n="items";if(Ze.subscribe(l=>n=l)(),n!=="socials")return;const o=this.scene.data.get("selectedSocialId");o&&li(o)};e.on("down",s),t.on("down",s)}updateSelectionVisuals(){if(!this.selectionGraphics)return;this.selectionGraphics.clear();const e=this.scene.data.get("selectedSocialId");if(!e){$s(null);return}const t=this.socials.get(e);if(!t){$s(null);return}const s=t.sprite,n=s.getBounds(),a=this.scene.cameras.main,{screenX:o,screenY:l}=xt(s.x,s.y,a);$s({screenX:o,screenY:l,socialHeight:n.height*a.zoom}),this.selectionGraphics.lineStyle(3,ls.SOCIAL.hex,1),this.selectionGraphics.strokeRect(n.x-4,n.y-4,n.width+8,n.height+8)}removeSocial(e){const t=this.socials.get(e);t&&(t.sprite.destroy(),this.socials.delete(e));const s=this.cleanupFunctions.get(e);s&&(s(),this.cleanupFunctions.delete(e)),this.updateSelectionVisuals()}setInteractiveEnabled(e){this.socials.forEach(({sprite:t})=>{e?(t.setInteractive(),t.setAlpha(1)):(t.disableInteractive(),t.setAlpha(.6))}),!e&&this.selectionGraphics&&this.selectionGraphics.clear()}destroy(){this.unsubscribers.forEach(e=>e()),this.unsubscribers=[],this.cleanupFunctions.forEach(e=>e()),this.cleanupFunctions.clear(),this.socials.forEach(({sprite:e})=>{e.destroy()}),this.socials.clear(),this.selectionGraphics&&(this.selectionGraphics.destroy(),this.selectionGraphics=null)}}const ut=En-1,gt=300,Hi=150,io=.3,no=.5,Fs=40,Li=60,Oi=16777215,Ri=.6,Xi=0,it=60,Fi=8;class ao{scene;worldWidth;worldHeight;graphics=null;zoneAreas=new Map;leftHandles=new Map;leftHandleVisuals=new Map;rightHandles=new Map;rightHandleVisuals=new Map;arrowGraphics=new Map;dragging=null;unsubscribers=[];createZoneSubscription;currentEditMode="items";currentZones=[];currentSelectedId=null;lastClickTime=0;lastClickX=0;DOUBLE_CLICK_THRESHOLD=300;DOUBLE_CLICK_DISTANCE=20;pendingTap=null;TAP_MAX_DURATION=300;TAP_MAX_DISTANCE=15;pendingZoneSelection=null;createZoneAtSubscription;boundWindowPointerUp=()=>{};boundWindowPointerMove=()=>{};currentScreenX=0;autoScrollTimer=null;constructor(e,t,s){this.scene=e,this.worldWidth=t,this.worldHeight=s}create(){this.graphics=this.scene.add.graphics(),this.graphics.setDepth(ut);const e=Ze.subscribe(n=>{this.currentEditMode=n,this.render()});this.unsubscribers.push(e);const t=ci.subscribe(n=>{this.currentZones=n,this.render()});this.unsubscribers.push(t);const s=ks.subscribe(n=>{this.currentSelectedId=n,this.render()});this.unsubscribers.push(s),this.scene.input.on("pointermove",this.handlePointerMove,this),this.scene.input.on("pointerup",this.handlePointerUp,this),this.boundWindowPointerUp=this.handlePointerUp.bind(this),this.boundWindowPointerMove=this.handleWindowPointerMove.bind(this),window.addEventListener("pointerup",this.boundWindowPointerUp),window.addEventListener("pointermove",this.boundWindowPointerMove),this.scene.input.on("pointerdown",this.handlePointerDown,this),this.createZoneSubscription=We.on($e.DIALOG_ZONE_CREATE,()=>{this.createNewZone()}),this.createZoneAtSubscription=We.on($e.DIALOG_ZONE_CREATE_AT,n=>{this.createZoneAtPosition(n.worldX)}),this.render()}clearVisuals(){this.graphics&&this.graphics.clear(),this.zoneAreas.forEach(e=>e.destroy()),this.zoneAreas.clear(),this.leftHandles.forEach(e=>e.destroy()),this.leftHandles.clear(),this.rightHandles.forEach(e=>e.destroy()),this.rightHandles.clear(),this.leftHandleVisuals.forEach(e=>e.destroy()),this.leftHandleVisuals.clear(),this.rightHandleVisuals.forEach(e=>e.destroy()),this.rightHandleVisuals.clear(),this.arrowGraphics.forEach(e=>e.destroy()),this.arrowGraphics.clear()}render(){if(this.clearVisuals(),this.currentEditMode==="dialogs")for(const e of this.currentZones)this.renderZone(e,e.id===this.currentSelectedId)}renderZone(e,t){if(!this.graphics)return;const s=B.Display.Color.HexStringToColor(e.color).color,n=t?no:io;this.graphics.fillStyle(s,n),this.graphics.fillRect(e.x,0,e.width,this.worldHeight),this.graphics.lineStyle(2,s,.8),this.graphics.strokeRect(e.x,0,e.width,this.worldHeight);const a=this.scene.add.rectangle(e.x+e.width/2,this.worldHeight/2,e.width-Fs*2,this.worldHeight);a.setOrigin(.5,.5),a.setInteractive({cursor:t?"grab":"pointer"}),a.setDepth(ut+.1),a.setAlpha(.001),a.setData("zoneId",e.id),a.on("pointerdown",o=>{if(this.isClickOnUIElement(o))return;const l=Date.now(),c=l-this.lastClickTime<this.DOUBLE_CLICK_THRESHOLD&&Math.abs(o.worldX-this.lastClickX)<this.DOUBLE_CLICK_DISTANCE;this.lastClickTime=l,this.lastClickX=o.worldX;const d=this.currentSelectedId===e.id;if(c&&d){un();return}d?(this.scene.data.set("isDraggingItem",!0),Lt(!0),this.startDrag(e.id,"move",o.worldX)):this.pendingZoneSelection={zoneId:e.id,worldX:o.worldX,startTime:l}}),this.zoneAreas.set(e.id,a),t&&this.createHandles(e)}createHandles(e){const t=this.scene.cameras.main.scrollY,s=this.scene.cameras.main.height,n=t+s/2,a=this.scene.add.rectangle(e.x,this.worldHeight/2,Fs,this.worldHeight);a.setOrigin(.5,.5),a.setDepth(ut+.2),a.setFillStyle(Oi,Ri);const o=this.scene.add.rectangle(e.x,this.worldHeight/2,Li,this.worldHeight);o.setOrigin(.5,.5),o.setInteractive({cursor:"ew-resize"}),o.setDepth(ut+.25),o.setAlpha(.001),o.setData("zoneId",e.id),o.setData("type","left"),o.on("pointerdown",S=>{this.isClickOnUIElement(S)||this.startDrag(e.id,"left",S.worldX)}),this.leftHandles.set(e.id,o),this.leftHandleVisuals.set(e.id,a);const l=8,c=this.scene.add.graphics();c.setDepth(ut+.3),this.drawArrow(c,e.x-l,n,"left"),this.arrowGraphics.set(`${e.id}_left`,c);const d=this.scene.add.rectangle(e.x+e.width,this.worldHeight/2,Fs,this.worldHeight);d.setOrigin(.5,.5),d.setDepth(ut+.2),d.setFillStyle(Oi,Ri);const h=this.scene.add.rectangle(e.x+e.width,this.worldHeight/2,Li,this.worldHeight);h.setOrigin(.5,.5),h.setInteractive({cursor:"ew-resize"}),h.setDepth(ut+.25),h.setAlpha(.001),h.setData("zoneId",e.id),h.setData("type","right"),h.on("pointerdown",S=>{this.isClickOnUIElement(S)||this.startDrag(e.id,"right",S.worldX)}),this.rightHandles.set(e.id,h),this.rightHandleVisuals.set(e.id,d);const f=this.scene.add.graphics();f.setDepth(ut+.3),this.drawArrow(f,e.x+e.width+l,n,"right"),this.arrowGraphics.set(`${e.id}_right`,f)}drawArrow(e,t,s,n){const o=n==="left"?-1:1;e.fillStyle(3355443,.8),e.beginPath(),e.moveTo(t+o*10+1,s),e.lineTo(t-o*10+1,s-10+1),e.lineTo(t-o*10+1,s+10-1),e.closePath(),e.fillPath(),e.fillStyle(16777215,.9),e.beginPath(),e.moveTo(t+o*10,s),e.lineTo(t-o*10,s-10),e.lineTo(t-o*10,s+10),e.closePath(),e.fillPath()}startDrag(e,t,s){const n=this.currentZones.find(a=>a.id===e);n&&(this.scene.data.set("isDraggingItem",!0),Lt(!0),this.dragging={zoneId:e,type:t,startX:s,originalX:n.x,originalWidth:n.width})}getZoneBounds(e){let t=0,s=this.worldWidth;for(const n of this.currentZones){if(n.id===e)continue;const a=n.x+n.width,o=this.currentZones.find(l=>l.id===e);o&&(a<=o.x+o.width/2&&(t=Math.max(t,a+Xi)),n.x>=o.x+o.width/2&&(s=Math.min(s,n.x-Xi)))}return{minX:t,maxX:s-gt,maxRight:s}}wouldOverlap(e,t,s){const n=t+s;for(const a of this.currentZones){if(a.id===e)continue;const o=a.x,l=a.x+a.width;if(t<l&&n>o)return!0}return!1}isClickOnUIElement(e){const t=e.downElement;return t?t.tagName?.toUpperCase()!=="CANVAS":!1}cancelPendingIfMoved(e){this.pendingTap&&Math.abs(e-this.pendingTap.worldX)>this.TAP_MAX_DISTANCE&&(this.pendingTap=null),this.pendingZoneSelection&&Math.abs(e-this.pendingZoneSelection.worldX)>this.TAP_MAX_DISTANCE&&(this.pendingZoneSelection=null)}screenToWorld(e,t){const s=this.scene.cameras.main,a=this.scene.game.canvas.getBoundingClientRect(),o=e-a.left,l=t-a.top;return Za(o,l,s)}handleWindowPointerMove(e){const t=this.screenToWorld(e.clientX,e.clientY);if(this.cancelPendingIfMoved(t.worldX),!this.dragging)return;const n=this.scene.game.canvas.getBoundingClientRect();e.clientX>=n.left&&e.clientX<=n.right&&e.clientY>=n.top&&e.clientY<=n.bottom||(this.currentScreenX=e.clientX-n.left,this.updateDrag(t.worldX),this.checkAutoScroll())}handlePointerMove(e){this.cancelPendingIfMoved(e.worldX),this.dragging&&(this.currentScreenX=e.x,e.event?.stopPropagation?.(),this.updateDrag(e.worldX),this.checkAutoScroll())}checkAutoScroll(){if(!this.dragging||this.dragging.type!=="move"){this.stopAutoScroll();return}const e=this.scene.cameras.main,t=e.width,s=this.currentZones.find(b=>b.id===this.dragging?.zoneId);if(!s)return;const n=Math.max(0,this.worldWidth-e.width/e.zoom);if(n<=0){this.stopAutoScroll();return}const{screenX:a}=xt(s.x,0,e),{screenX:o}=xt(s.x+s.width,0,e),l=a<=it,c=o>=t-it,d=e.scrollX>0,h=e.scrollX<n,f=s.x>0,S=s.x+s.width<this.worldWidth,C=this.currentScreenX<it,y=this.currentScreenX>t-it,p=l&&C&&d&&f||c&&y&&h&&S;p&&!this.autoScrollTimer?this.autoScrollTimer=this.scene.time.addEvent({delay:16,callback:this.performAutoScroll,callbackScope:this,loop:!0}):!p&&this.autoScrollTimer&&this.stopAutoScroll()}performAutoScroll(){if(!this.dragging||this.dragging.type!=="move"){this.stopAutoScroll();return}const e=this.scene.cameras.main,t=e.width,s=this.currentZones.find(P=>P.id===this.dragging?.zoneId);if(!s)return;let n=0;if(this.currentScreenX<it){if(s.x<=0){this.stopAutoScroll();return}const p=(it-this.currentScreenX)/it;n=-Fi*p}else if(this.currentScreenX>t-it){if(s.x+s.width>=this.worldWidth){this.stopAutoScroll();return}const p=(this.currentScreenX-(t-it))/it;n=Fi*p}if(n===0)return;const a=e.scrollX+n,o=0,l=Math.max(0,this.worldWidth-e.width/e.zoom),d=Math.max(o,Math.min(l,a))-e.scrollX;if(l<=0){this.stopAutoScroll();return}if(d===0){this.stopAutoScroll();return}const h=s.x+d,f=Math.max(0,Math.min(this.worldWidth-s.width,h)),S=f-s.x;if(S===0){this.stopAutoScroll();return}const C=e.scrollX+S,y=Math.max(0,Math.min(l,C));if(Math.abs(y-e.scrollX)>Math.abs(S)*2){this.stopAutoScroll();return}e.scrollX=y,this.wouldOverlap(s.id,f,s.width)||(Mt(s.id,{x:f}),this.dragging.originalX+=S,this.dragging.startX+=S)}stopAutoScroll(){this.autoScrollTimer&&(this.autoScrollTimer.destroy(),this.autoScrollTimer=null)}updateDrag(e){if(!this.dragging)return;const t=e-this.dragging.startX,s=this.currentZones.find(a=>a.id===this.dragging?.zoneId);if(!s)return;const n=this.getZoneBounds(s.id);if(this.dragging.type==="left"){let a=this.dragging.originalX+t,o=this.dragging.originalWidth-t;if(a<0&&(o+=a,a=0),o<gt&&(a=this.dragging.originalX+this.dragging.originalWidth-gt,o=gt),a<n.minX){const l=n.minX-a;a=n.minX,o-=l}o>=gt&&!this.wouldOverlap(s.id,a,o)&&Mt(s.id,{x:a,width:o})}else if(this.dragging.type==="right"){let a=this.dragging.originalWidth+t;a<gt&&(a=gt),s.x+a>this.worldWidth&&(a=this.worldWidth-s.x),s.x+a>n.maxRight&&(a=n.maxRight-s.x),a>=gt&&!this.wouldOverlap(s.id,s.x,a)&&Mt(s.id,{width:a})}else if(this.dragging.type==="move"){let a=this.dragging.originalX+t;const o=s.width;if(a<0&&(a=0),a+o>this.worldWidth&&(a=this.worldWidth-o),!this.wouldOverlap(s.id,a,o))Mt(s.id,{x:a});else{const l=this.findNonOverlappingPosition(s.id,a,o);l!==null&&Mt(s.id,{x:l})}}}findNonOverlappingPosition(e,t,s){const n=this.currentZones.filter(h=>h.id!==e).sort((h,f)=>h.x-f.x);if(n.length===0)return Math.max(0,Math.min(t,this.worldWidth-s));let a=t,o=1/0;const l=n[0];if(l.x>=s){const h=l.x-s,f=Math.max(0,Math.min(t,h)),S=Math.abs(f-t);S<o&&(o=S,a=f)}for(let h=0;h<n.length-1;h++){const f=n[h],S=n[h+1],C=f.x+f.width,y=S.x;if(y-C>=s){const P=C,p=y-s,b=Math.max(P,Math.min(t,p)),v=Math.abs(b-t);v<o&&(o=v,a=b)}}const c=n[n.length-1],d=c.x+c.width;if(this.worldWidth-d>=s){const h=d,f=this.worldWidth-s,S=Math.max(h,Math.min(t,f)),C=Math.abs(S-t);C<o&&(o=C,a=S)}return o<1/0&&!this.wouldOverlap(e,a,s)?a:null}handlePointerUp(e){if(this.dragging&&(this.stopAutoScroll(),this.scene.data.set("isDraggingItem",!1),Lt(!1),this.dragging=null),this.pendingZoneSelection){let n=Date.now()-this.pendingZoneSelection.startTime<this.TAP_MAX_DURATION;n&&e&&e.worldX!==void 0&&(n=Math.abs(e.worldX-this.pendingZoneSelection.worldX)<this.TAP_MAX_DISTANCE),n&&jt(this.pendingZoneSelection.zoneId),this.pendingZoneSelection=null}if(this.pendingTap&&this.currentEditMode==="dialogs"){if(Date.now()-this.pendingTap.startTime<this.TAP_MAX_DURATION){let n=!0;e&&e.worldX!==void 0&&(n=Math.abs(e.worldX-this.pendingTap.worldX)<this.TAP_MAX_DISTANCE),n&&this.showTempAddButton(this.pendingTap.worldX,this.pendingTap.worldY)}this.pendingTap=null}}handlePointerDown(e){if(kt()||this.currentEditMode!=="dialogs"||this.dragging)return;const t=e.downElement;if(t&&t.tagName?.toUpperCase()!=="CANVAS")return;const s=e.worldX;for(const l of this.currentZones)if(s>=l.x&&s<=l.x+l.width)return;const n=Date.now(),a=n-this.lastClickTime,o=Math.abs(s-this.lastClickX);if(a<this.DOUBLE_CLICK_THRESHOLD&&o<this.DOUBLE_CLICK_DISTANCE){this.createZoneAtPosition(s),this.lastClickTime=0,this.hideTempAddButton();return}this.lastClickTime=n,this.lastClickX=s,this.pendingTap={worldX:s,worldY:e.worldY,startTime:n},this.currentSelectedId&&jt(null)}showTempAddButton(e,t){const s=this.scene.cameras.main,{screenX:n,screenY:a}=xt(e,t,s);We.emit($e.TEMP_ZONE_BUTTON_SHOW,{screenX:n,screenY:a,worldX:e})}hideTempAddButton(){We.emit($e.TEMP_ZONE_BUTTON_HIDE,{})}createZoneAtPosition(e){this.createZoneAt(e)}createNewZone(){const e=this.scene.cameras.main,t=e.worldView.x+e.worldView.width/2;this.createZoneAt(t)}createZoneAt(e){let t=e-Hi/2;const s=Hi;if(t=Math.max(0,Math.min(this.worldWidth-s,t)),this.wouldOverlap("",t,s)){const a=this.findNonOverlappingPosition("",t,s);if(a===null){console.warn("No room for a new dialog zone");return}t=a}const n=Lr(t,s);n.x=t,Fa(n),jt(n.id)}updateSelectionVisuals(){if(this.currentEditMode!=="dialogs"){ds(null);return}if(!this.currentSelectedId){ds(null);return}const e=this.currentZones.find(o=>o.id===this.currentSelectedId);if(!e){ds(null);return}const t=this.scene.cameras.main,s=e.x+e.width/2,{screenX:n}=xt(s,0,t),a=t.height*.65;ds({screenX:n,screenY:a})}destroy(){this.hideTempAddButton();for(const e of this.unsubscribers)e();this.unsubscribers=[],this.createZoneSubscription&&this.createZoneSubscription.unsubscribe(),this.createZoneAtSubscription&&this.createZoneAtSubscription.unsubscribe(),this.stopAutoScroll(),this.scene.input.off("pointerdown",this.handlePointerDown,this),this.scene.input.off("pointermove",this.handlePointerMove,this),this.scene.input.off("pointerup",this.handlePointerUp,this),window.removeEventListener("pointerup",this.boundWindowPointerUp),window.removeEventListener("pointermove",this.boundWindowPointerMove),this.clearVisuals(),this.graphics&&(this.graphics.destroy(),this.graphics=null),this.dragging=null}}class ro extends B.Scene{parallaxLayers=null;cameraController;playerController;gridOverlay;itemsController;framesController;socialsController;dialogZoneRenderer;config;minimapSubscription;isShuttingDown=!1;get itemManager(){return this.itemsController?.getManager()}resetZoom(){this.cameraController?.resetToFit()}constructor(){super({key:et.BUILDER})}init(e){this.config=e.config}preload(){Hn(this),bs.preloadAssets(this),Ai.preloadAssets(this),$i.preloadAssets(this)}create(){this.isShuttingDown=!1,this.initializeScene()}async initializeScene(){Ln(this),this.physics.world.setBounds(0,0,this.config.worldWidth,this.config.worldHeight);const t=tt.getCurrentConfig().groundHeight??qe,s=this.config.worldHeight-t;this.cameraController=new Jr(this,this.config.worldWidth,this.config.worldHeight),this.playerController=new Qr(this,this.config.worldWidth,this.config.worldHeight),this.gridOverlay=new eo(this,this.config.worldWidth,this.config.worldHeight),this.itemsController=new so(this,s,this.config.worldWidth,this.config.worldHeight),this.framesController=new Ai(this,this.config.worldWidth,this.config.worldHeight),this.socialsController=new $i(this,this.config.worldWidth,this.config.worldHeight),this.dialogZoneRenderer=new ao(this,this.config.worldWidth,this.config.worldHeight),this.createBackground(),this.gridOverlay.create(),this.createGroundReference(),await this.playerController.preload(),this.playerController.create(this.config.playerStartX,this.config.playerStartY),this.itemsController.create(this.config.placedItems||[]),this.framesController.create(this.config.placedFrames||[]),this.socialsController.create(this.config.placedSocials||[]),this.dialogZoneRenderer.create(),this.cameraController.setup(),this.cameraController.centerOn(this.config.playerStartX,this.config.playerStartY),this.minimapSubscription=We.on($e.MINIMAP_NAVIGATE,n=>{this.navigateToPosition(n.worldX,n.worldY)}),this.scale.on("resize",this.handleResize,this),this.events.on("shutdown",this.shutdown,this)}async createBackground(){const e=tt.getCurrentConfig();try{await On(this,e)}catch(t){console.error("Failed to load background:",t);return}this.parallaxLayers&&(Ur(this.parallaxLayers),this.parallaxLayers=null),this.parallaxLayers=Rn(this,this.config.worldWidth,this.config.worldHeight,e)}createGroundReference(){const t=tt.getCurrentConfig().groundHeight??qe;Ft.createVisualGround(this,{worldWidth:this.config.worldWidth,worldHeight:this.config.worldHeight,height:t})}update(){this.parallaxLayers&&Xn(this.parallaxLayers,this.cameras.main),this.itemManager?.updateSelectionVisuals(),this.framesController?.updateSelectionVisuals(),this.socialsController?.updateSelectionVisuals(),this.dialogZoneRenderer?.updateSelectionVisuals();const e=this.cameras.main,t=this.data.get("playerSprite");ha({scrollX:e.worldView.x,scrollY:e.worldView.y,viewWidth:e.width,viewHeight:e.height,worldWidth:this.config.worldWidth,worldHeight:this.config.worldHeight,zoom:e.zoom,playerX:t?.x??this.config.playerStartX,playerY:t?.y??this.config.playerStartY})}navigateToPosition(e,t){this.cameraController.centerOn(e,t)}handleResize(e){!this.cameras?.main||!this.config||(this.cameraController?.handleResize(),this.gridOverlay&&this.gridOverlay.redraw())}shutdown(){this.isShuttingDown||(this.isShuttingDown=!0,this.scale.off("resize",this.handleResize,this),this.minimapSubscription&&this.minimapSubscription.unsubscribe(),this.cameraController&&this.cameraController.destroy(),this.playerController&&this.playerController.destroy(),this.gridOverlay&&this.gridOverlay.destroy(),this.itemsController&&this.itemsController.destroy(),this.framesController&&this.framesController.destroy(),this.socialsController&&this.socialsController.destroy(),this.dialogZoneRenderer&&this.dialogZoneRenderer.destroy())}}Qn();class oo{currentLanguage="cs";setLanguage(e){this.currentLanguage=e,localStorage.setItem("language",e)}getLanguage(){const e=localStorage.getItem("language");return(e==="cs"||e==="en")&&(this.currentLanguage=e),this.currentLanguage}toggleLanguage(){return this.currentLanguage=this.currentLanguage==="cs"?"en":"cs",this.setLanguage(this.currentLanguage),this.currentLanguage}}const Fn=new oo;let Ve=null;function lo(i){Ve=i}function co(){if(!Ve)return console.error("Scene manager not initialized"),null;try{const i=Ve.scene.getScene(et.GAME);return typeof i.getMapConfig=="function"?i.getMapConfig():i?.mapConfig||null}catch(i){return console.error("Failed to get map config:",i),null}}function ho(i){if(!Ve)return console.error("Scene manager not initialized"),!1;try{return Ve.scene.getScene(et.GAME)?(Ve.scene.stop(et.GAME),pa(i),Ve.scene.start(et.BUILDER,{config:i}),!0):(console.error("GameScene not found"),!1)}catch(e){return console.error("Failed to switch to builder:",e),!1}}function uo(){if(console.log("[SceneManager] switchToGame called"),!Ve)return console.error("Scene manager not initialized"),!1;try{return console.log("[SceneManager] Stopping builder scene..."),Ve.scene.stop(et.BUILDER),console.log("[SceneManager] Exiting builder mode..."),ma(),console.log("[SceneManager] Starting game scene..."),Ve.scene.start(et.GAME,{useBuilderConfig:!0}),console.log("[SceneManager] switchToGame completed successfully"),!0}catch(i){return console.error("Failed to switch to game:",i),!1}}function go(){if(!Ve){console.error("Scene manager not initialized");return}try{Ve.scene.start(et.GAME)}catch(i){console.error("Failed to start game scene:",i)}}var fo=F('<button class="close-btn svelte-164n75j" title="Close">×</button>'),po=F('<div class="resize-handle resize-handle-nw svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M9 9L1 1M5 1L1 1L1 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-ne svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M1 9L9 1M5 1L9 1L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-sw svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M9 1L1 9M1 5L1 9L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>  <div class="resize-handle resize-handle-se svelte-164n75j"><svg width="10" height="10" viewBox="0 0 10 10" class="svelte-164n75j"><path d="M1 1L9 9M9 5L9 9L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"></path></svg></div>',1),mo=F("<div><!></div> <!>",1),vo=F('<div data-ui=""><div class="panel-header svelte-164n75j"><span class="panel-title svelte-164n75j"> </span> <!> <div class="header-buttons svelte-164n75j"><button class="minimize-btn svelte-164n75j"> </button> <!></div></div> <!></div>');function Wt(i,e){Ce(e,!0);const t=()=>X(vt,"$isDraggingInBuilder",s),[s,n]=He();let a=1e3,o=we(e,"initialRight",3,10),l=we(e,"initialTop",3,60),c=we(e,"width",3,280),d=we(e,"minWidth",3,200),h=we(e,"minHeight",3,100),f=we(e,"maxWidth",3,600),S=we(e,"maxHeight",3,800),C=we(e,"resizable",3,!1),y=we(e,"startMinimized",3,!1),w=we(e,"showClose",3,!1),P=ie(rt(y())),p=ie(!1),b=ie(rt({x:0,y:0})),v=ie(rt({width:c(),height:e.height??0})),g=ie(!1),u=ie(!1),_=ie("se"),x=ie(rt({x:0,y:0})),k=ie(null),$=ie(!1),I=ie(rt(a)),A=ie(null),H=ie("");function O(){a++,R(I,a,!0)}function Y(W,N,ce){let Pe=W;const Ge=window.innerWidth-ce-10;Pe>Ge&&(Pe=Math.max(10,Ge)),Pe<10&&(Pe=10);let Re=N;const st=window.innerHeight-40;return Re>st&&(Re=Math.max(10,st)),Re<10&&(Re=10),{x:Pe,y:Re}}Fe(()=>{if(typeof window>"u"||r($))return;const W=localStorage.getItem(`panel-state-${e.panelId}`);if(W)try{const N=JSON.parse(W),ce=C()&&N.width?N.width:c(),be=Y(N.x,N.y,ce);R(b,be,!0),C()&&N.width&&N.height&&R(v,{width:N.width,height:N.height},!0);const _e=C()?{x:be.x,y:be.y,width:r(v).width,height:r(v).height}:{x:be.x,y:be.y};R(H,JSON.stringify(_e),!0)}catch{R(b,{x:window.innerWidth-c()-o(),y:l()},!0)}else R(b,{x:window.innerWidth-c()-o(),y:l()},!0);R($,!0)}),Fe(()=>{if(!r($))return;const W=C()?{x:r(b).x,y:r(b).y,width:r(v).width,height:r(v).height}:{x:r(b).x,y:r(b).y},N=JSON.stringify(W);N!==r(H)&&(R(H,N,!0),localStorage.setItem(`panel-state-${e.panelId}`,N))}),Fe(()=>{if(!r($))return;function W(){if(!r(k))return;const N=C()?r(v).width:c();let ce=r(b).x,be=r(b).y,_e=!1;const Pe=window.innerWidth-N;r(b).x>Pe&&(ce=Math.max(10,Pe),_e=!0);const Ge=window.innerHeight-40;r(b).y>Ge&&(be=Math.max(10,Ge),_e=!0),r(b).x<0&&(ce=10,_e=!0),r(b).y<0&&(be=10,_e=!0),_e&&R(b,{x:ce,y:be},!0)}return window.addEventListener("resize",W),()=>{window.removeEventListener("resize",W)}});function M(){R(P,!r(P))}function T(){e.onclose?.()}function Z(){if(C())if(r(p))r(A)&&(R(b,{x:r(A).x,y:r(A).y},!0),R(v,{width:r(A).width,height:r(A).height},!0),R(A,null)),R(p,!1);else{R(A,{x:r(b).x,y:r(b).y,width:r(v).width,height:r(v).height},!0);const W=20,N=Math.min(f(),window.innerWidth-W*2),ce=Math.min(S(),window.innerHeight-W*2),be=Math.max(W,(window.innerWidth-N)/2),_e=Math.max(W,(window.innerHeight-ce)/2);R(b,{x:be,y:_e},!0),R(v,{width:N,height:ce},!0),R(p,!0)}}function z(W){W.target.closest("button")||Z()}function ne(W){W.target.closest("button")||(R(g,!0),R(x,{x:W.clientX-r(b).x,y:W.clientY-r(b).y},!0),W.currentTarget.setPointerCapture(W.pointerId),W.preventDefault())}function re(W){if(!r(g))return;const N=W.clientX-r(x).x,ce=W.clientY-r(x).y,be=window.innerWidth-(r(k)?.offsetWidth??c()),_e=window.innerHeight-40;R(b,{x:Math.max(0,Math.min(N,be)),y:Math.max(0,Math.min(ce,_e))},!0)}function le(W){r(g)&&(R(g,!1),W.currentTarget.releasePointerCapture(W.pointerId))}function U(W){return N=>{C()&&(R(u,!0),R(_,W,!0),N.currentTarget.setPointerCapture(N.pointerId),N.preventDefault(),N.stopPropagation())}}function L(W){if(!r(u)||!r(k))return;const N=r(k).getBoundingClientRect();let ce,be,_e=r(b).x,Pe=r(b).y;const Ge=r(_)==="se"||r(_)==="ne",Re=r(_)==="se"||r(_)==="sw";Ge?ce=W.clientX-N.left:(ce=N.right-W.clientX,_e=W.clientX),Re?be=W.clientY-N.top:(be=N.bottom-W.clientY,Pe=W.clientY);const st=Math.max(d(),Math.min(f(),ce)),te=Math.max(h(),Math.min(S(),be));Ge||(_e=N.right-st,_e<0&&(_e=0)),Re||(Pe=N.bottom-te,Pe<0&&(Pe=0));const xe=Ge?window.innerWidth-r(b).x-10:N.right-10,me=Re?window.innerHeight-r(b).y-10:N.bottom-10,Me=Math.min(st,xe),Se=Math.min(te,me);R(v,{width:Me,height:Se},!0);let Xe=!1,Be=r(b).x,Tt=r(b).y;!Ge&&ce>=d()&&(Be=Math.max(0,_e),Xe=!0),!Re&&be>=h()&&(Tt=Math.max(0,Pe),Xe=!0),Xe&&R(b,{x:Be,y:Tt},!0)}function j(W){r(u)&&(R(u,!1),W.currentTarget.releasePointerCapture(W.pointerId))}function ee(W){W.stopPropagation()}var K=vo();let ae;K.__pointerdown=W=>{O(),ee(W)},K.__click=ee;var fe=D(K);fe.__pointerdown=ne,fe.__pointermove=re,fe.__pointerup=le,fe.__dblclick=z;var pe=D(fe),ve=D(pe),oe=E(pe,2);{var ye=W=>{var N=De(),ce=ue(N);es(ce,()=>e.headerExtra),m(W,N)};q(oe,W=>{e.headerExtra&&W(ye)})}var Ie=E(oe,2),Oe=D(Ie);Oe.__click=M;var Ue=D(Oe),Ke=E(Oe,2);{var yt=W=>{var N=fo();N.__click=T,m(W,N)};q(Ke,W=>{w()&&W(yt)})}var Yt=E(fe,2);{var ht=W=>{var N=mo(),ce=ue(N);let be;var _e=D(ce);es(_e,()=>e.children);var Pe=E(ce,2);{var Ge=Re=>{var st=po(),te=ue(st),xe=G(()=>U("nw"));te.__pointerdown=function(...bt){r(xe)?.apply(this,bt)},te.__pointermove=L,te.__pointerup=j;var me=E(te,2),Me=G(()=>U("ne"));me.__pointerdown=function(...bt){r(Me)?.apply(this,bt)},me.__pointermove=L,me.__pointerup=j;var Se=E(me,2),Xe=G(()=>U("sw"));Se.__pointerdown=function(...bt){r(Xe)?.apply(this,bt)},Se.__pointermove=L,Se.__pointerup=j;var Be=E(Se,2),Tt=G(()=>U("se"));Be.__pointerdown=function(...bt){r(Tt)?.apply(this,bt)},Be.__pointermove=L,Be.__pointerup=j,je("pointercancel",te,j),je("pointercancel",me,j),je("pointercancel",Se,j),je("pointercancel",Be,j),m(Re,st)};q(Pe,Re=>{C()&&Re(Ge)})}V(()=>be=Te(ce,1,"panel-body svelte-164n75j",null,be,{"has-fixed-height":C()&&r(v).height>0})),m(W,N)};q(Yt,W=>{r(P)||W(ht)})}mt(K,W=>R(k,W),()=>r(k)),V(()=>{ae=Te(K,1,"draggable-panel svelte-164n75j",null,ae,{minimized:r(P),maximized:r(p),dragging:r(g),resizing:r(u),resizable:C()}),ge(K,`left: ${r(b).x??""}px; top: ${r(b).y??""}px; width: ${r(P)?"auto":`${C()?r(v).width:c()}px`}; ${C()&&r(v).height>0&&!r(P)?`height: ${r(v).height}px;`:""}${t()?" pointer-events: none;":""} z-index: ${r(I)??""};`),Ee(ve,e.title),Q(Oe,"title",r(P)?"Expand":"Minimize"),Ee(Ue,r(P)?"▲":"▼")}),je("pointercancel",fe,le),m(i,K),ke(),n()}ot(["pointerdown","click","pointermove","pointerup","dblclick"]);const Wi=10,yo=150,bo=`
  position: fixed;
  pointer-events: none;
  z-index: 10000;
  opacity: 0.9;
  image-rendering: pixelated;
  filter: drop-shadow(3px 3px 0 rgba(0, 0, 0, 0.5));
  background: rgba(26, 26, 46, 0.9);
`,So=`
  width: 100%;
  height: 100%;
  object-fit: contain;
  image-rendering: pixelated;
`;function ui(i,e,t){const{previewSize:s,borderColor:n,dataKey:a,eventName:o,onDrop:l}=i,c=s/2,d={startX:0,startY:0,hasMoved:!1,isActivated:!1,pendingKey:null,pendingTarget:null,longPressTimer:null};function h(I,A,H){We.emit(o,{[a]:I,canvasX:A,canvasY:H}),l?.()}function f(I,A){const H=document.querySelector("canvas");if(!H)return null;const O=H.getBoundingClientRect();return I>=O.left&&I<=O.right&&A>=O.top&&A<=O.bottom?{canvasX:I-O.left,canvasY:A-O.top}:null}function S(I,A,H){const O=document.createElement("div");return O.className="touch-drag-preview",O.innerHTML=`<img src="${I}" alt="" />`,O.style.cssText=`
      ${bo}
      top: ${H-c}px;
      left: ${A-c}px;
      width: ${s}px;
      height: ${s}px;
      border: 2px solid ${n};
    `,O.querySelector("img").style.cssText=So,document.body.appendChild(O),O}function C(I,A,H){I.style.top=`${H-c}px`,I.style.left=`${A-c}px`}function y(){d.longPressTimer&&(clearTimeout(d.longPressTimer),d.longPressTimer=null),d.pendingKey=null,d.pendingTarget=null,d.isActivated=!1,d.hasMoved=!1}function w(){y();const I=e();I.touchDragElement&&(I.touchDragElement.remove(),t({touchDragElement:null})),t({draggedKey:null}),hs(!1)}function P(I,A){if(!I.dataTransfer)return;t({draggedKey:A}),hs(!0),I.dataTransfer.effectAllowed="copy",I.dataTransfer.setData(a,A);const H=I.target,Y=(H.querySelector("[data-drag-preview]")||H.querySelector("img"))?.cloneNode(!0);Y&&(Y.style.position="absolute",Y.style.top="-1000px",Y.style.left="-1000px",Y.style.zIndex="-1",document.body.appendChild(Y),I.dataTransfer.setDragImage(Y,c,c),requestAnimationFrame(()=>Y.remove()))}function p(){t({draggedKey:null}),hs(!1)}function b(I){I.preventDefault(),I.dataTransfer&&(I.dataTransfer.dropEffect="copy")}function v(I){I.preventDefault();const A=I.dataTransfer?.getData(a);if(!A)return;const H=f(I.clientX,I.clientY);H&&h(A,H.canvasX,H.canvasY)}function g(I,A){if(!d.pendingKey||!d.pendingTarget||d.isActivated)return;d.isActivated=!0,t({draggedKey:d.pendingKey}),hs(!0);const H=d.pendingTarget.querySelector("img");if(H){const O=S(H.src,I,A);t({touchDragElement:O})}}function u(I,A){if(I.touches.length!==1)return;const H=I.touches[0];d.startX=H.clientX,d.startY=H.clientY,d.hasMoved=!1,d.isActivated=!1,d.pendingKey=A,d.pendingTarget=I.currentTarget,d.longPressTimer=setTimeout(()=>{d.pendingKey&&!d.hasMoved&&g(H.clientX,H.clientY)},yo)}function _(I){const A=I.touches[0],H=A.clientX-d.startX,O=A.clientY-d.startY;if(!d.hasMoved&&(Math.abs(H)>Wi||Math.abs(O)>Wi)&&(d.hasMoved=!0,!d.isActivated)){if(Math.abs(O)>Math.abs(H)){y();return}g(A.clientX,A.clientY)}const Y=e();d.isActivated&&Y.touchDragElement&&(C(Y.touchDragElement,A.clientX,A.clientY),I.preventDefault())}function x(I){const A=e(),H=d.isActivated,O=A.draggedKey;if(H&&O&&d.hasMoved){const Y=I.changedTouches[0],M=f(Y.clientX,Y.clientY);M&&h(O,M.canvasX,M.canvasY)}w()}function k(){const I=document.querySelector("canvas");return I?(I.addEventListener("dragover",b),I.addEventListener("drop",v),()=>{I.removeEventListener("dragover",b),I.removeEventListener("drop",v)}):()=>{}}function $(){return document.addEventListener("touchmove",_,{passive:!1}),document.addEventListener("touchend",x),document.addEventListener("touchcancel",x),()=>{document.removeEventListener("touchmove",_),document.removeEventListener("touchend",x),document.removeEventListener("touchcancel",x)}}return{onDragStart:P,onDragEnd:p,onTouchStart:u,setupCanvasListeners:k,setupTouchListeners:$}}var _o=F('<span class="palette-hint svelte-lnmxj4">Drag to place</span>'),wo=F('<span class="size-badge large svelte-lnmxj4">L</span>'),Io=F('<span class="size-badge small svelte-lnmxj4">S</span>'),xo=F('<div class="animated-wrapper svelte-lnmxj4" data-drag-preview=""><img class="item-preview animated svelte-lnmxj4"/></div>'),Eo=F('<img class="item-preview svelte-lnmxj4" data-drag-preview=""/>'),Co=F('<div data-ui="" draggable="true" role="button" tabindex="0"><!> <!></div>'),ko=F('<div class="palette-content svelte-lnmxj4" role="toolbar" tabindex="-1"><div class="palette-grid svelte-lnmxj4"></div></div>');function To(i,e){Ce(e,!0);const t=()=>X(Et,"$isItemPaletteOpen",n),s=()=>X(Ze,"$builderEditMode",n),[n,a]=He(),o="#4a90e2",l=600,d=tt.getCurrentConfig().itemGroups||["shared"],h=hi.filter(_=>d.includes(_.group));function f(){return window.innerWidth<l}function S(){f()&&Et.set(!1)}let C=ie(null),y=ie(null);const w=ui({previewSize:48,borderColor:o,dataKey:"assetKey",eventName:$e.ASSET_DROPPED,onDrop:S},()=>({draggedKey:r(C),touchDragElement:r(y)}),_=>{"draggedKey"in _&&R(C,_.draggedKey??null,!0),"touchDragElement"in _&&R(y,_.touchDragElement??null,!0)});function P(_){_.stopPropagation()}function p(){Et.set(!1)}function b(_){const x=document.querySelector("canvas");if(!x)return;const k=x.getBoundingClientRect(),$=k.width/2,I=k.height/2;We.emit($e.ASSET_DROPPED,{assetKey:_,canvasX:$,canvasY:I}),S()}Is(()=>w.setupCanvasListeners()),Fe(()=>w.setupTouchListeners());var v=De(),g=ue(v);{var u=_=>{Wt(_,{panelId:"item-palette",title:"Items",initialRight:10,initialTop:60,width:280,height:400,minWidth:200,minHeight:160,maxWidth:500,maxHeight:600,resizable:!0,showClose:!0,onclose:p,headerExtra:k=>{var $=_o();m(k,$)},children:(k,$)=>{var I=ko();I.__pointerdown=P;var A=D(I);Ne(A,21,()=>h,ze,(H,O)=>{var Y=Co();let M;Y.__touchstart=U=>w.onTouchStart(U,r(O).key),Y.__dblclick=()=>b(r(O).key),ge(Y,"",{},{"--accent-color":o});var T=D(Y);{var Z=U=>{var L=wo();m(U,L)},z=U=>{var L=De(),j=ue(L);{var ee=K=>{var ae=Io();m(K,ae)};q(j,K=>{r(O).name.toLowerCase().includes("small")&&K(ee)},!0)}m(U,L)};q(T,U=>{r(O).name.toLowerCase().includes("large")?U(Z):U(z,!1)})}var ne=E(T,2);{var re=U=>{const L=G(()=>zs(r(O).key));var j=xo();let ee;var K=D(j);let ae;V(()=>{ee=ge(j,"",ee,{width:`${r(L)?.frameWidth??""}px`,height:`${r(L)?.frameHeight??""}px`}),Q(K,"src",r(O).path),Q(K,"alt",r(O).name),ae=ge(K,"",ae,{width:`${r(L)?.frameWidth??""}px`,height:`${r(L)?.frameHeight??""}px`,"object-fit":"none","object-position":"0 0"})}),m(U,j)},le=U=>{var L=Eo();V(()=>{Q(L,"src",r(O).path),Q(L,"alt",r(O).name)}),m(U,L)};q(ne,U=>{Ks(r(O).key)?U(re):U(le,!1)})}V(()=>{M=Te(Y,1,"palette-item svelte-lnmxj4",null,M,{dragging:r(C)===r(O).key}),Q(Y,"title",`${r(O).name??""} (double-click to place)`)}),je("dragstart",Y,U=>w.onDragStart(U,r(O).key)),je("dragend",Y,function(...U){w.onDragEnd?.apply(this,U)}),m(H,Y)}),m(k,I)},$$slots:{headerExtra:!0,default:!0}})};q(g,_=>{t()&&s()==="items"&&_(u)})}m(i,v),ke(),a()}ot(["pointerdown","touchstart","dblclick"]);var Do=F('<span class="palette-hint svelte-kgdyte">Drag to place</span>'),Po=F('<div data-ui="" draggable="true" role="button" tabindex="0"><img class="item-preview svelte-kgdyte"/></div>'),Mo=F('<div class="palette-content svelte-kgdyte" role="toolbar" tabindex="-1"><div class="palette-grid svelte-kgdyte"></div></div>');function Ao(i,e){Ce(e,!0);const t=()=>X(wt,"$isFramePaletteOpen",n),s=()=>X(Ze,"$builderEditMode",n),[n,a]=He(),o="#9b59b6",l=Ss;let c=ie(null),d=ie(null);const h=ui({previewSize:64,borderColor:o,dataKey:"frameKey",eventName:$e.FRAME_DROPPED,onDrop:()=>{wt.set(!1)}},()=>({draggedKey:r(c),touchDragElement:r(d)}),p=>{"draggedKey"in p&&R(c,p.draggedKey??null,!0),"touchDragElement"in p&&R(d,p.touchDragElement??null,!0)});function f(p){p.stopPropagation()}function S(){wt.set(!1)}function C(p){const b=document.querySelector("canvas");if(!b)return;const v=b.getBoundingClientRect(),g=v.width/2,u=v.height/2;We.emit($e.FRAME_DROPPED,{frameKey:p,canvasX:g,canvasY:u}),wt.set(!1)}Is(()=>h.setupCanvasListeners()),Fe(()=>h.setupTouchListeners());var y=De(),w=ue(y);{var P=p=>{Wt(p,{panelId:"frame-palette",title:"Frames",initialRight:10,initialTop:60,width:320,height:400,minWidth:220,minHeight:200,maxWidth:600,maxHeight:600,resizable:!0,showClose:!0,onclose:S,headerExtra:v=>{var g=Do();m(v,g)},children:(v,g)=>{var u=Mo();u.__pointerdown=f;var _=D(u);Ne(_,21,()=>l,ze,(x,k)=>{var $=Po();let I;$.__touchstart=H=>h.onTouchStart(H,r(k).key),$.__dblclick=()=>C(r(k).key),ge($,"",{},{"--accent-color":o});var A=D($);V(()=>{I=Te($,1,"palette-item svelte-kgdyte",null,I,{dragging:r(c)===r(k).key}),Q($,"title",`${r(k).name??""} (double-click to place)`),Q(A,"src",r(k).path),Q(A,"alt",r(k).name)}),je("dragstart",$,H=>h.onDragStart(H,r(k).key)),je("dragend",$,function(...H){h.onDragEnd?.apply(this,H)}),m(x,$)}),m(v,u)},$$slots:{headerExtra:!0,default:!0}})};q(w,p=>{t()&&s()==="frames"&&p(P)})}m(i,y),ke(),a()}ot(["pointerdown","touchstart","dblclick"]);var $o=F('<span class="palette-hint svelte-4tctcn">Drag to place</span>'),Ho=F('<div data-ui="" draggable="true" role="button" tabindex="0"><img class="item-preview svelte-4tctcn"/> <span class="item-name svelte-4tctcn"> </span></div>'),Lo=F('<div class="palette-content svelte-4tctcn" role="toolbar" tabindex="-1"><div class="palette-grid svelte-4tctcn"></div></div>');function Oo(i,e){Ce(e,!0);const t=()=>X(It,"$isSocialPaletteOpen",n),s=()=>X(Ze,"$builderEditMode",n),[n,a]=He(),o=ls.SOCIAL.css,l=_s;let c=ie(null),d=ie(null);const h=ui({previewSize:64,borderColor:o,dataKey:"socialKey",eventName:$e.SOCIAL_DROPPED,onDrop:()=>{It.set(!1)}},()=>({draggedKey:r(c),touchDragElement:r(d)}),p=>{"draggedKey"in p&&R(c,p.draggedKey??null,!0),"touchDragElement"in p&&R(d,p.touchDragElement??null,!0)});function f(p){p.stopPropagation()}function S(){It.set(!1)}function C(p){const b=document.querySelector("canvas");if(!b)return;const v=b.getBoundingClientRect(),g=v.width/2,u=v.height/2;We.emit($e.SOCIAL_DROPPED,{socialKey:p,canvasX:g,canvasY:u}),It.set(!1)}Is(()=>h.setupCanvasListeners()),Fe(()=>h.setupTouchListeners());var y=De(),w=ue(y);{var P=p=>{Wt(p,{panelId:"social-palette",title:"Socials",initialRight:10,initialTop:60,width:280,height:350,minWidth:200,minHeight:200,maxWidth:500,maxHeight:500,resizable:!0,showClose:!0,onclose:S,headerExtra:v=>{var g=$o();m(v,g)},children:(v,g)=>{var u=Lo();u.__pointerdown=f;var _=D(u);Ne(_,21,()=>l,ze,(x,k)=>{var $=Ho();let I;$.__touchstart=M=>h.onTouchStart(M,r(k).key),$.__dblclick=()=>C(r(k).key);let A;var H=D($),O=E(H,2),Y=D(O);V(()=>{I=Te($,1,"palette-item svelte-4tctcn",null,I,{dragging:r(c)===r(k).key}),Q($,"title",`${r(k).name??""} (double-click to place)`),A=ge($,"",A,{"--accent-color":o}),Q(H,"src",r(k).path),Q(H,"alt",r(k).name),Ee(Y,r(k).name)}),je("dragstart",$,M=>h.onDragStart(M,r(k).key)),je("dragend",$,function(...M){h.onDragEnd?.apply(this,M)}),m(x,$)}),m(v,u)},$$slots:{headerExtra:!0,default:!0}})};q(w,p=>{t()&&s()==="socials"&&p(P)})}m(i,y),ke(),a()}ot(["pointerdown","touchstart","dblclick"]);var Ro=F("<button> </button>"),Xo=F('<div class="language-tabs svelte-1hfe466"></div>');function Wn(i,e){Ce(e,!0);let t=we(e,"accentColor",3,"#88ddff");var s=Xo();Ne(s,21,()=>Ea,ze,(n,a)=>{var o=Ro();let l;o.__click=()=>e.onselect(r(a).code);let c;var d=D(o);V(()=>{l=Te(o,1,"lang-tab svelte-1hfe466",null,l,{active:e.selectedLanguage===r(a).code}),c=ge(o,"",c,{"--accent-color":t()}),Ee(d,r(a).label)}),m(n,o)}),m(i,s),ke()}ot(["click"]);var Fo=F("<button></button>"),Wo=F('<div class="color-picker svelte-wbnbhn"></div>'),Yo=F('<div class="color-section svelte-wbnbhn"><span class="color-label-title svelte-wbnbhn"> </span> <button class="color-button svelte-wbnbhn" title="Change color"><span class="color-preview svelte-wbnbhn"></span> <span class="color-label svelte-wbnbhn">Change</span></button> <!></div>');function Vs(i,e){Ce(e,!0);let t=we(e,"label",3,"Color"),s=we(e,"accentColor",3,"#88ddff"),n=ie(!1),a=ie(null);Fe(()=>{r(n)&&r(a)&&requestAnimationFrame(()=>{r(a)?.scrollIntoView({behavior:"smooth",block:"nearest"})})});function o(p){e.onselect(p)}function l(){R(n,!r(n))}var c=Yo(),d=D(c),h=D(d),f=E(d,2);f.__click=l;let S;var C=D(f);let y;var w=E(f,2);{var P=p=>{var b=Wo();Ne(b,21,()=>e.colors,ze,(v,g)=>{var u=Fo();let _;u.__click=()=>o(r(g));let x;V(()=>{_=Te(u,1,"color-swatch svelte-wbnbhn",null,_,{selected:e.selectedColor===r(g)}),Q(u,"title",r(g)),x=ge(u,"",x,{background:r(g),"--accent-color":s()})}),m(v,u)}),mt(b,v=>R(a,v),()=>r(a)),m(p,b)};q(w,p=>{r(n)&&p(P)})}V(()=>{Ee(h,t()),S=ge(f,"",S,{"--accent-color":s()}),y=ge(C,"",y,{background:e.selectedColor})}),m(i,c),ke()}ot(["click"]);const Yi=50,Zi=400,Zo=400,Bo=70;var Go=F('<div class="form-section svelte-vzwc0p"><div class="form-group svelte-vzwc0p"><label class="svelte-vzwc0p"> </label> <input type="text" class="svelte-vzwc0p"/></div> <div class="form-group svelte-vzwc0p"><label class="svelte-vzwc0p"> </label> <textarea rows="6" class="svelte-vzwc0p"></textarea></div></div>');function No(i,e){Ce(e,!0);let t=we(e,"titlePlaceholder",3,"Enter title..."),s=we(e,"contentPlaceholder",3,"Enter text..."),n=we(e,"idPrefix",3,"text-form"),a=we(e,"accentColor",3,"#88ddff");function o(b){const v=b.target;e.ontitlechange(v.value)}function l(b){const v=b.target;e.oncontentchange(v.value)}var c=Go();let d;var h=D(c),f=D(h),S=D(f),C=E(f,2);C.__input=o;var y=E(h,2),w=D(y),P=D(w),p=E(w,2);p.__input=l,V(()=>{d=ge(c,"",d,{"--accent-color":a()}),Q(f,"for",`${n()??""}-title`),Ee(S,`Title (max ${Yi} chars)`),Q(C,"id",`${n()??""}-title`),ts(C,e.title),Q(C,"placeholder",t()),Q(C,"maxlength",Yi),Q(w,"for",`${n()??""}-content`),Ee(P,`Content (max ${Zi} chars)`),Q(p,"id",`${n()??""}-content`),ts(p,e.content),Q(p,"placeholder",s()),Q(p,"maxlength",Zi)}),m(i,c),ke()}ot(["input"]);var Ko=F('<div class="panel-content svelte-7qe9ti"><!> <!> <div class="panel-extras svelte-7qe9ti"><!></div> <div class="panel-footer svelte-7qe9ti"><!> <!></div></div>');function zo(i,e){Ce(e,!0);const t=()=>X(ci,"$dialogZones",a),s=()=>X(ks,"$selectedDialogZoneId",a),n=()=>X(ni,"$isDialogZonePanelOpen",a),[a,o]=He(),l="#88ddff";let c=ie(rt(rn)),d=G(()=>t().find(g=>g.id===s())??null),h=G(()=>r(d)?.texts.find(g=>g.language===r(c))??null);function f(g){s()&&mi(s(),r(c),{title:g})}function S(g){s()&&mi(s(),r(c),{content:g})}function C(){s()&&(vn(s()),pi())}function y(){pi()}function w(g){s()&&Mt(s(),{color:g})}function P(g){R(c,g,!0)}var p=De(),b=ue(p);{var v=g=>{Wt(g,{panelId:"dialog-zone-panel",title:"Dialog Zone",initialRight:10,initialTop:160,width:280,height:450,minWidth:250,minHeight:370,maxWidth:500,maxHeight:700,resizable:!0,showClose:!0,onclose:y,children:(u,_)=>{var x=Ko(),k=D(x);Wn(k,{get selectedLanguage(){return r(c)},onselect:P,accentColor:l});var $=E(k,2);{let M=G(()=>r(h)?.title??""),T=G(()=>r(h)?.content??"");No($,{get title(){return r(M)},get content(){return r(T)},ontitlechange:f,oncontentchange:S,titlePlaceholder:"Enter title...",contentPlaceholder:"Enter dialog text...",idPrefix:"dialog",accentColor:l})}var I=E($,2),A=D(I);Vs(A,{get colors(){return js},get selectedColor(){return r(d).color},onselect:w,label:"Zone Color",accentColor:l});var H=E(I,2),O=D(H);de(O,{variant:"cyan",onclick:y,children:(M,T)=>{var Z=he("CONFIRM");m(M,Z)},$$slots:{default:!0}});var Y=E(O,2);de(Y,{variant:"red",onclick:C,children:(M,T)=>{var Z=he("DELETE");m(M,Z)},$$slots:{default:!0}}),m(u,x)},$$slots:{default:!0}})};q(b,g=>{r(d)&&n()&&g(v)})}m(i,p),ke(),o()}var Uo=F("<button> </button>"),jo=F("<option> </option>"),Vo=F("<button> </button>"),qo=F('<a target="_blank" rel="noopener noreferrer" class="url-preview svelte-1oasytl">Test link ↗</a>'),Jo=F('<button><img class="svelte-1oasytl"/></button>'),Qo=F('<div class="style-picker svelte-1oasytl"></div>'),el=F('<div class="panel-content svelte-1oasytl"><!> <div class="frame-size-row svelte-1oasytl"><div class="frame-size-section svelte-1oasytl"><span class="section-label svelte-1oasytl">Frame Size</span> <div class="size-buttons svelte-1oasytl"></div></div> <div class="rotate-section svelte-1oasytl"><span class="section-label svelte-1oasytl">Rotate</span> <button class="rotate-btn svelte-1oasytl"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="svelte-1oasytl"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button></div></div> <div class="panel-extras svelte-1oasytl"><div class="text-section svelte-1oasytl"><label for="frame-text" class="svelte-1oasytl">Text</label> <textarea id="frame-text" placeholder="Enter text..." rows="3" class="svelte-1oasytl"></textarea></div> <div class="size-rotation-row svelte-1oasytl"><div class="size-section svelte-1oasytl"><label for="text-size" class="svelte-1oasytl">Text Size</label> <select id="text-size" class="svelte-1oasytl"></select></div></div> <div class="text-align-section svelte-1oasytl"><span class="section-label svelte-1oasytl">Text Alignment</span> <div class="align-buttons svelte-1oasytl"></div></div> <div class="url-section svelte-1oasytl"><label for="frame-url" class="svelte-1oasytl">Link URL (opens on click)</label> <input id="frame-url" type="url" placeholder="https://example.com" class="svelte-1oasytl"/> <!></div> <!> <!> <div class="style-section svelte-1oasytl"><span class="section-label svelte-1oasytl">Frame Style</span> <button class="style-button svelte-1oasytl" title="Change frame style"><img alt="Current frame" class="style-preview svelte-1oasytl"/> <span class="style-label svelte-1oasytl">Change Style</span></button> <!></div></div> <div class="panel-footer svelte-1oasytl"><!> <!></div></div>');function tl(i,e){Ce(e,!0);const t=()=>X(ai,"$builderPreviewLanguage",o),s=()=>X(Aa,"$selectedFrame",o),n=()=>X(ns,"$selectedFrameId",o),a=()=>X(Es,"$isFramePanelOpen",o),[o,l]=He(),c="#9b59b6";let d=G(t),h=G(s),f=G(()=>r(h)?.texts.find(T=>T.language===r(d))??null),S=G(()=>r(h)?kr(r(h).scale??4):"M");function C(T){const Z=T.target;if(!n()||!r(h))return;const z=r(h).texts.map(ne=>ne.language===r(d)?{...ne,text:Z.value}:ne);z.some(ne=>ne.language===r(d))||z.push({language:r(d),text:Z.value}),nt(n(),{texts:z})}function y(T){const Z=T.target;n()&&nt(n(),{url:Z.value||void 0})}function w(T){n()&&nt(n(),{backgroundColor:T})}function P(T){n()&&nt(n(),{textColor:T})}function p(T){const Z=T.target;n()&&nt(n(),{textSize:parseInt(Z.value,10)})}function b(T){n()&&nt(n(),{scale:Cr(T)})}function v(T){n()&&nt(n(),{textAlign:T})}function g(){if(!n()||!r(h))return;const Z=(r(h).rotation??0)===0?90:0;nt(n(),{rotation:Z})}function u(){n()&&oi(n())}function _(){Ta(),zt(null)}function x(T){Ma(T)}let k=ie(!1),$=ie(null),I=ie(null);function A(T){n()&&nt(n(),{frameKey:T})}function H(){R(k,!r(k))}Fe(()=>{r(k)&&r($)&&requestAnimationFrame(()=>{r($)?.scrollIntoView({behavior:"smooth",block:"nearest"})})}),Fe(()=>{if(!r(k))return;function T(Z){const z=Z.target;r($)&&!r($).contains(z)&&r(I)&&!r(I).contains(z)&&R(k,!1)}return document.addEventListener("click",T),()=>document.removeEventListener("click",T)});var O=De(),Y=ue(O);{var M=T=>{Wt(T,{panelId:"frame-panel",title:"Edit Frame",initialRight:10,initialTop:160,width:280,height:520,minWidth:250,minHeight:450,maxWidth:500,maxHeight:700,resizable:!0,showClose:!0,onclose:_,children:(Z,z)=>{var ne=el(),re=D(ne);Wn(re,{get selectedLanguage(){return r(d)},onselect:x,accentColor:c});var le=E(re,2),U=D(le),L=E(D(U),2);Ne(L,21,()=>Object.entries(Dn),ze,(te,xe)=>{var me=G(()=>zi(r(xe),2));let Me=()=>r(me)[0],Se=()=>r(me)[1].label;var Xe=Uo();let Be;Xe.__click=()=>b(Me());var Tt=D(Xe);V(()=>{Be=Te(Xe,1,"size-btn svelte-1oasytl",null,Be,{active:r(S)===Me()}),Q(Xe,"title",Se()),Ee(Tt,Me())}),m(te,Xe)});var j=E(U,2),ee=E(D(j),2);ee.__click=g;var K=E(le,2),ae=D(K),fe=E(D(ae),2);fe.__input=C;var pe=E(ae,2),ve=D(pe),oe=E(D(ve),2);oe.__change=p,Ne(oe,21,()=>xr,ze,(te,xe)=>{var me=jo(),Me=D(me),Se={};V(()=>{Ee(Me,`${r(xe)??""}px`),Se!==(Se=r(xe))&&(me.value=(me.__value=r(xe))??"")}),m(te,me)});var ye;ia(oe);var Ie=E(pe,2),Oe=E(D(Ie),2);Ne(Oe,21,()=>Er,ze,(te,xe)=>{let me=()=>r(xe).value,Me=()=>r(xe).label;var Se=Vo();let Xe;Se.__click=()=>v(me());var Be=D(Se);V(()=>{Xe=Te(Se,1,"align-btn svelte-1oasytl",null,Xe,{active:(r(h).textAlign??Mn)===me()}),Q(Se,"title",Me()),Ee(Be,Me())}),m(te,Se)});var Ue=E(Ie,2),Ke=E(D(Ue),2);Ke.__input=y;var yt=E(Ke,2);{var Yt=te=>{var xe=qo();V(()=>Q(xe,"href",r(h).url)),m(te,xe)};q(yt,te=>{r(h).url&&te(Yt)})}var ht=E(Ue,2);{let te=G(()=>r(h).textColor??Pn);Vs(ht,{get colors(){return Ir},get selectedColor(){return r(te)},onselect:P,label:"Text Color",accentColor:c})}var W=E(ht,2);Vs(W,{get colors(){return wr},get selectedColor(){return r(h).backgroundColor},onselect:w,label:"Background Color",accentColor:c});var N=E(W,2),ce=E(D(N),2);ce.__click=H;var be=D(ce);mt(ce,te=>R(I,te),()=>r(I));var _e=E(ce,2);{var Pe=te=>{var xe=Qo();Ne(xe,21,()=>Ss,ze,(me,Me)=>{var Se=Jo();let Xe;Se.__click=()=>A(r(Me).key);var Be=D(Se);V(()=>{Xe=Te(Se,1,"style-item svelte-1oasytl",null,Xe,{selected:r(h).frameKey===r(Me).key}),Q(Se,"title",r(Me).name),Q(Be,"src",r(Me).path),Q(Be,"alt",r(Me).name)}),m(me,Se)}),mt(xe,me=>R($,me),()=>r($)),m(te,xe)};q(_e,te=>{r(k)&&te(Pe)})}var Ge=E(K,2),Re=D(Ge);de(Re,{variant:"purple",onclick:_,children:(te,xe)=>{var me=he("CONFIRM");m(te,me)},$$slots:{default:!0}});var st=E(Re,2);de(st,{variant:"red",onclick:u,children:(te,xe)=>{var me=he("DELETE");m(te,me)},$$slots:{default:!0}}),V(te=>{Q(ee,"title",r(h).rotation===90?"Portrait (click to rotate)":"Landscape (click to rotate)"),ts(fe,r(f)?.text??""),ye!==(ye=r(h).textSize??ps)&&(oe.value=(oe.__value=r(h).textSize??ps)??"",ji(oe,r(h).textSize??ps)),ts(Ke,r(h).url??""),Q(be,"src",te)},[()=>Ss.find(te=>te.key===r(h).frameKey)?.path??""]),m(Z,ne)},$$slots:{default:!0}})};q(Y,T=>{a()&&r(h)&&T(M)})}m(i,O),ke(),l()}ot(["click","input","change"]);var sl=F("<button> </button>"),il=F('<a target="_blank" rel="noopener noreferrer" class="url-preview svelte-6kd0po">Test link ↗</a>'),nl=F('<button><img class="svelte-6kd0po"/></button>'),al=F('<div class="style-picker svelte-6kd0po"></div>'),rl=F('<div class="panel-content svelte-6kd0po"><div class="social-size-row svelte-6kd0po"><div class="social-size-section svelte-6kd0po"><span class="section-label svelte-6kd0po">Size</span> <div class="size-buttons svelte-6kd0po"></div></div></div> <div class="panel-extras svelte-6kd0po"><div class="url-section svelte-6kd0po"><label for="social-url" class="svelte-6kd0po">Link URL (opens on click)</label> <input id="social-url" type="url" placeholder="https://example.com" class="svelte-6kd0po"/> <!></div> <div class="style-section svelte-6kd0po"><span class="section-label svelte-6kd0po">Social Icon</span> <button class="style-button svelte-6kd0po" title="Change social icon"><img alt="Current social" class="style-preview svelte-6kd0po"/> <span class="style-label svelte-6kd0po"> </span></button> <!></div></div> <div class="panel-footer svelte-6kd0po"><!> <!></div></div>');function ol(i,e){Ce(e,!0);const t=()=>X(Ra,"$selectedSocial",a),s=()=>X(as,"$selectedSocialId",a),n=()=>X(Cs,"$isSocialPanelOpen",a),[a,o]=He(),l=ls.SOCIAL.css;let c=G(t),d=G(()=>r(c)?Wr(r(c).scale??Rt):"M"),h=G(()=>r(c)?_s.find(x=>x.key===r(c).socialKey):null);function f(x){const k=x.target;s()&&gs(s(),{url:k.value||void 0})}function S(x){s()&&gs(s(),{scale:Fr(x)})}function C(){s()&&li(s())}function y(){Pa(),Ut(null)}let w=ie(!1),P=ie(null),p=ie(null);function b(x){s()&&gs(s(),{socialKey:x})}function v(){R(w,!r(w))}Fe(()=>{r(w)&&r(P)&&requestAnimationFrame(()=>{r(P)?.scrollIntoView({behavior:"smooth",block:"nearest"})})}),Fe(()=>{if(!r(w))return;function x(k){const $=k.target;r(P)&&!r(P).contains($)&&r(p)&&!r(p).contains($)&&R(w,!1)}return document.addEventListener("click",x),()=>document.removeEventListener("click",x)});var g=De(),u=ue(g);{var _=x=>{Wt(x,{panelId:"social-panel",title:"Edit Social",initialRight:10,initialTop:160,width:280,height:350,minWidth:250,minHeight:300,maxWidth:400,maxHeight:500,resizable:!0,showClose:!0,onclose:y,children:(k,$)=>{var I=rl(),A=D(I),H=D(A),O=E(D(H),2);Ne(O,21,()=>Object.entries(os),ze,(pe,ve)=>{var oe=G(()=>zi(r(ve),2));let ye=()=>r(oe)[0],Ie=()=>r(oe)[1].label;var Oe=sl();let Ue;Oe.__click=()=>S(ye());var Ke=D(Oe);V(()=>{Ue=Te(Oe,1,"size-btn svelte-6kd0po",null,Ue,{active:r(d)===ye()}),Q(Oe,"title",Ie()),Ee(Ke,ye())}),m(pe,Oe)});var Y=E(A,2),M=D(Y),T=E(D(M),2);T.__input=f;var Z=E(T,2);{var z=pe=>{var ve=il();V(()=>Q(ve,"href",r(c).url)),m(pe,ve)};q(Z,pe=>{r(c).url&&pe(z)})}var ne=E(M,2),re=E(D(ne),2);re.__click=v;var le=D(re),U=E(le,2),L=D(U);mt(re,pe=>R(p,pe),()=>r(p));var j=E(re,2);{var ee=pe=>{var ve=al();Ne(ve,21,()=>_s,ze,(oe,ye)=>{var Ie=nl();let Oe;Ie.__click=()=>b(r(ye).key);var Ue=D(Ie);V(()=>{Oe=Te(Ie,1,"style-item svelte-6kd0po",null,Oe,{selected:r(c).socialKey===r(ye).key}),Q(Ie,"title",r(ye).name),Q(Ue,"src",r(ye).path),Q(Ue,"alt",r(ye).name)}),m(oe,Ie)}),mt(ve,oe=>R(P,oe),()=>r(P)),m(pe,ve)};q(j,pe=>{r(w)&&pe(ee)})}var K=E(Y,2),ae=D(K);de(ae,{variant:"pink",onclick:y,children:(pe,ve)=>{var oe=he("CONFIRM");m(pe,oe)},$$slots:{default:!0}});var fe=E(ae,2);de(fe,{variant:"red",onclick:C,children:(pe,ve)=>{var oe=he("DELETE");m(pe,oe)},$$slots:{default:!0}}),V(()=>{ge(I,`--accent-color: ${l}`),ts(T,r(c).url??""),Q(le,"src",r(h)?.path??""),Ee(L,r(h)?.name??"Select")}),m(k,I)},$$slots:{default:!0}})};q(u,x=>{n()&&r(c)&&x(_)})}m(i,g),ke(),o()}ot(["click","input"]);var ll=F("<div> </div>"),cl=F('<div class="frame-content-layer svelte-ykw3se"></div>');function Yn(i,e){Ce(e,!0);const t=()=>X(gn,"$placedFrames",d),s=()=>X(en,"$isBuilderMode",d),n=()=>X(ei,"$builderCameraInfo",d),a=()=>X(qi,"$gameCameraInfo",d),o=()=>X(ai,"$builderPreviewLanguage",d),l=()=>X(is,"$currentLanguage",d),c=()=>X(ri,"$draggingFramePositions",d),[d,h]=He();let f=G(t),S=G(()=>s()?n().scrollX:a().scrollX),C=G(()=>s()?n().scrollY:a().scrollY),y=G(()=>s()?n().zoom:a().zoom),w=G(()=>s()?o():l()),P=G(c);function p(u){const _=r(P).get(u.id);return _||{x:u.x,y:u.y}}function b(u){const _=u.scale??dt,x=u.rotation===90,{textWidth:k,textHeight:$}=Jt(_,x),I=p(u),A=(I.x-r(S))*r(y),H=(I.y-r(C))*r(y);return{x:A,y:H,width:k*r(y),height:$*r(y)}}function v(u){return(u.texts.find(x=>x.language===r(w))||u.texts[0]||{text:""}).text||""}var g=cl();Ne(g,21,()=>r(f),u=>u.id,(u,_)=>{const x=G(()=>b(r(_))),k=G(()=>v(r(_))),$=G(()=>(r(_).textSize??ps)*r(y)),I=G(()=>r(_).textColor??Pn),A=G(()=>r(_).textAlign??Mn);var H=De(),O=ue(H);{var Y=M=>{var T=ll();let Z;var z=D(T);V(()=>{Z=Te(T,1,"frame-text svelte-ykw3se",null,Z,{"align-top":r(A)==="top","align-center":r(A)==="center","align-bottom":r(A)==="bottom"}),ge(T,`
          left: ${r(x).x??""}px;
          top: ${r(x).y??""}px;
          width: ${r(x).width??""}px;
          height: ${r(x).height??""}px;
          font-size: ${r($)??""}px;
          color: ${r(I)??""};
        `),Ee(z,r(k))}),m(M,T)};q(O,M=>{r(k)&&M(Y)})}m(u,H)}),m(i,g),ke(),h()}var dl=F('<div class="temp-zone-button svelte-1vrg7di"><!></div>');function hl(i,e){Ce(e,!0);const t=()=>X(ei,"$builderCameraInfo",a),s=()=>X(Ze,"$builderEditMode",a),n=()=>X(vt,"$isDraggingInBuilder",a),[a,o]=He();let l=ie(null),c=null,d=null,h=ie(null);function f(p){c&&clearTimeout(c),R(l,p,!0),R(h,t()?.scrollX??null,!0),c=setTimeout(()=>{R(l,null),R(h,null)},2e3)}function S(){r(l)&&(We.emit($e.DIALOG_ZONE_CREATE_AT,{worldX:r(l).worldX}),R(l,null),R(h,null),c&&(clearTimeout(c),c=null))}function C(){R(l,null),R(h,null),c&&(clearTimeout(c),c=null)}Is(()=>{d=We.on($e.TEMP_ZONE_BUTTON_SHOW,f);const p=We.on($e.TEMP_ZONE_BUTTON_HIDE,C);return()=>{d?.unsubscribe(),p.unsubscribe()}}),ea(()=>{c&&clearTimeout(c)}),Fe(()=>{s()!=="dialogs"&&(R(l,null),R(h,null))}),Fe(()=>{const p=t()?.scrollX;r(l)&&r(h)!==null&&p!==void 0&&Math.abs(p-r(h))>10&&(R(l,null),R(h,null),c&&(clearTimeout(c),c=null))});var y=De(),w=ue(y);{var P=p=>{var b=dl(),v=D(b);de(v,{variant:"cyan",width:"90px",onclick:S,children:(g,u)=>{var _=he("+ ZONE");m(g,_)},$$slots:{default:!0}}),V(()=>ge(b,`left: ${r(l).screenX??""}px; top: ${r(l).screenY-50}px;${n()?" pointer-events: none;":""}`)),m(p,b)};q(w,p=>{r(l)&&s()==="dialogs"&&p(P)})}m(i,y),ke(),o()}var ul=F('<div class="item-controls svelte-1529z5h"><div class="controls-row svelte-1529z5h"><!> <!> <!> <!></div></div>');function gl(i,e){Ce(e,!0);const t=()=>X(si,"$selectedItem",h),s=()=>X(sn,"$selectedItemScreenPosition",h),n=()=>X(xs,"$selectedItemId",h),a=()=>X(tn,"$itemDepthLayer",h),o=()=>X(ya,"$selectedItemPhysicsEnabled",h),l=()=>X(ba,"$selectedItemFlipX",h),c=()=>X(Ze,"$builderEditMode",h),d=()=>X(vt,"$isDraggingInBuilder",h),[h,f]=He();let S=G(()=>t()?Ga(t().assetKey):!1),C=G(()=>{const u=s();if(!u)return null;const _=10,x=40,k=r(S)?380:290;let $=u.screenY-u.itemHeight/2-45;const I=_+x;$<I&&($=u.screenY+u.itemHeight/2+10);const A=window.innerHeight-x-_;$>A&&($=A);let H=u.screenX;const O=k/2,Y=O+_,M=window.innerWidth-O-_;return H<Y&&(H=Y),H>M&&(H=M),{x:H,y:$}});function y(){if(!n())return;const u=a()==="behind"?"front":"behind",_=ti(u);_a(),wa(n(),_)}function w(){n()&&Ia(n(),!o())}function P(){n()&&xa(n(),!l())}function p(){n()&&(nn(n()),di())}var b=De(),v=ue(b);{var g=u=>{var _=ul(),x=D(_),k=D(x);{let O=G(()=>a()==="behind"?"blue":"orange"),Y=G(()=>o()?"Solid items must be behind player":"Toggle item depth: behind or in front of player");de(k,{get variant(){return r(O)},get title(){return r(Y)},onclick:y,get disabled(){return o()},children:(M,T)=>{var Z=he();V(()=>Ee(Z,a()==="behind"?"Front":"Back")),m(M,Z)},$$slots:{default:!0}})}var $=E(k,2);{let O=G(()=>l()?"orange":"blue");de($,{get variant(){return r(O)},title:"Flip item horizontally",onclick:P,children:(Y,M)=>{var T=he("Flip");m(Y,T)},$$slots:{default:!0}})}var I=E($,2);{var A=O=>{{let Y=G(()=>o()?"orange":"blue");de(O,{get variant(){return r(Y)},title:"Toggle physics: item will block player movement",onclick:w,children:(M,T)=>{var Z=he();V(()=>Ee(Z,o()?"Ghost":"Solid")),m(M,Z)},$$slots:{default:!0}})}};q(I,O=>{r(S)&&O(A)})}var H=E(I,2);de(H,{variant:"red",title:"Delete selected item",onclick:p,children:(O,Y)=>{var M=he("DEL");m(O,M)},$$slots:{default:!0}}),V(()=>ge(_,`left: ${r(C).x??""}px; top: ${r(C).y??""}px;${d()?" pointer-events: none;":""}`)),m(u,_)};q(v,u=>{c()!=="dialogs"&&n()&&r(C)&&u(g)})}m(i,b),ke(),f()}var fl=F('<div class="frame-controls svelte-1uejmfx"><div class="controls-row svelte-1uejmfx"><!> <!></div></div>');function pl(i,e){Ce(e,!0);const t=()=>X(fn,"$selectedFrameScreenPosition",o),s=()=>X(ns,"$selectedFrameId",o),n=()=>X(Ze,"$builderEditMode",o),a=()=>X(vt,"$isDraggingInBuilder",o),[o,l]=He();let c=G(()=>{const y=t();if(!y)return null;const w=10,P=40,p=190;let b=y.screenY-y.frameHeight/2-45;const v=w+P;b<v&&(b=y.screenY+y.frameHeight/2+10);const g=window.innerHeight-P-w;b>g&&(b=g);let u=y.screenX;const _=p/2,x=_+w,k=window.innerWidth-_-w;return u<x&&(u=x),u>k&&(u=k),{x:u,y:b}});function d(){dn()}function h(){s()&&(oi(s()),zt(null))}var f=De(),S=ue(f);{var C=y=>{var w=fl(),P=D(w),p=D(P);de(p,{variant:"purple",title:"Edit frame content (or double-click)",onclick:d,children:(v,g)=>{var u=he("EDIT");m(v,u)},$$slots:{default:!0}});var b=E(p,2);de(b,{variant:"red",title:"Delete selected frame",onclick:h,children:(v,g)=>{var u=he("DEL");m(v,u)},$$slots:{default:!0}}),V(()=>ge(w,`left: ${r(c).x??""}px; top: ${r(c).y??""}px;${a()?" pointer-events: none;":""}`)),m(y,w)};q(S,y=>{n()!=="dialogs"&&s()&&r(c)&&y(C)})}m(i,f),ke(),l()}var ml=F('<div class="zone-controls svelte-7umuek"><div class="controls-row svelte-7umuek"><!> <!> <!></div></div>');function vl(i,e){Ce(e,!0);const t=()=>X(mn,"$selectedDialogZoneScreenPosition",o),s=()=>X(ks,"$selectedDialogZoneId",o),n=()=>X(Ze,"$builderEditMode",o),a=()=>X(vt,"$isDraggingInBuilder",o),[o,l]=He();let c=G(()=>{const w=t();if(!w)return null;const P=10,p=120,b=85;let v=w.screenY;const g=P+p/2,u=window.innerHeight-p/2-P;v<g&&(v=g),v>u&&(v=u);let _=w.screenX;const x=b/2,k=x+P,$=window.innerWidth-x-P;return _<k&&(_=k),_>$&&(_=$),{x:_,y:v}});function d(){un()}function h(){s()&&(vn(s()),jt(null))}function f(){jt(null)}var S=De(),C=ue(S);{var y=w=>{var P=ml(),p=D(P),b=D(p);de(b,{variant:"cyan",title:"Edit zone content (or double-click)",onclick:d,children:(u,_)=>{var x=he("EDIT");m(u,x)},$$slots:{default:!0}});var v=E(b,2);de(v,{variant:"red",title:"Delete selected zone",onclick:h,children:(u,_)=>{var x=he("DEL");m(u,x)},$$slots:{default:!0}});var g=E(v,2);de(g,{variant:"default",title:"Deselect zone",onclick:f,children:(u,_)=>{var x=he("DONE");m(u,x)},$$slots:{default:!0}}),V(()=>ge(P,`left: ${r(c).x??""}px; top: ${r(c).y??""}px;${a()?" pointer-events: none;":""}`)),m(w,P)};q(C,w=>{n()==="dialogs"&&s()&&r(c)&&w(y)})}m(i,S),ke(),l()}var yl=F('<div class="social-controls svelte-q16c5x"><div class="controls-row svelte-q16c5x"><!> <!></div></div>');function bl(i,e){Ce(e,!0);const t=()=>X(pn,"$selectedSocialScreenPosition",o),s=()=>X(as,"$selectedSocialId",o),n=()=>X(Ze,"$builderEditMode",o),a=()=>X(vt,"$isDraggingInBuilder",o),[o,l]=He();let c=G(()=>{const y=t();if(!y)return null;const w=10,P=40,p=190;let b=y.screenY-y.socialHeight/2-45;const v=w+P;b<v&&(b=y.screenY+y.socialHeight/2+10);const g=window.innerHeight-P-w;b>g&&(b=g);let u=y.screenX;const _=p/2,x=_+w,k=window.innerWidth-_-w;return u<x&&(u=x),u>k&&(u=k),{x:u,y:b}});function d(){hn()}function h(){s()&&(li(s()),Ut(null))}var f=De(),S=ue(f);{var C=y=>{var w=yl(),P=D(w),p=D(P);de(p,{variant:"pink",title:"Edit social settings (or double-click)",onclick:d,children:(v,g)=>{var u=he("EDIT");m(v,u)},$$slots:{default:!0}});var b=E(p,2);de(b,{variant:"red",title:"Delete selected social",onclick:h,children:(v,g)=>{var u=he("DEL");m(v,u)},$$slots:{default:!0}}),V(()=>ge(w,`left: ${r(c).x??""}px; top: ${r(c).y??""}px;${a()?" pointer-events: none;":""}`)),m(y,w)};q(S,y=>{n()!=="dialogs"&&s()&&r(c)&&y(C)})}m(i,f),ke(),l()}var Sl=F('<div class="hstack svelte-13tonpt"><!></div>');function _l(i,e){let t=we(e,"gap",3,"10px"),s=we(e,"align",3,"center");var n=Sl(),a=D(n);es(a,()=>e.children??Qe),V(()=>ge(n,`gap: ${t()??""}; align-items: ${(s()==="start"?"flex-start":s()==="end"?"flex-end":s())??""};`)),m(i,n)}var wl=F('<div class="vstack svelte-eir7yr"><!></div>');function Il(i,e){let t=we(e,"gap",3,"10px"),s=we(e,"align",3,"stretch");var n=wl(),a=D(n);es(a,()=>e.children??Qe),V(()=>ge(n,`gap: ${t()??""}; align-items: ${(s()==="start"?"flex-start":s()==="end"?"flex-end":s())??""};`)),m(i,n)}var xl=F("<div><!></div>");function Bi(i,e){const t=()=>X(vt,"$isDraggingInBuilder",s),[s,n]=He();let a=we(e,"padding",3,"10px");var o=xl();let l;var c=D(o);es(c,()=>e.children??Qe),V(()=>{l=Te(o,1,`fixed fixed--${e.position??""}`,"svelte-cx4lc",l,{"dragging-in-builder":t()}),ge(o,`--padding: ${a()??""};`)}),m(i,o),n()}var El=F("<div><!> <!></div>"),Cl=F("<!> <!>",1),kl=F("<!> <!> <!> <!>",1),Tl=F("<div><!></div>"),Dl=F("<!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!> <!>",1);function Pl(i,e){Ce(e,!0);const t=()=>X(xs,"$selectedItemId",f),s=()=>X(ns,"$selectedFrameId",f),n=()=>X(ks,"$selectedDialogZoneId",f),a=()=>X(as,"$selectedSocialId",f),o=()=>X(Ze,"$builderEditMode",f),l=()=>X(ys,"$gridSnappingEnabled",f),c=()=>X(Et,"$isItemPaletteOpen",f),d=()=>X(wt,"$isFramePaletteOpen",f),h=()=>X(It,"$isSocialPaletteOpen",f),[f,S]=He(),C=600;let y=ie(rt(typeof window<"u"?window.innerWidth<C:!1)),w=G(()=>r(y)&&(t()!==null||s()!==null||n()!==null||a()!==null));Fe(()=>{function z(){R(y,window.innerWidth<C)}return window.addEventListener("resize",z),()=>window.removeEventListener("resize",z)});function P(){console.log("[BuilderUI] handleSave called, switching to game...");const z=uo();console.log("[BuilderUI] switchToGame result:",z)}function p(){fa()}function b(){We.emit($e.DIALOG_ZONE_CREATE)}var v=Dl(),g=ue(v);gl(g,{});var u=E(g,2);pl(u,{});var _=E(u,2);vl(_,{});var x=E(_,2);bl(x,{});var k=E(x,2);{var $=z=>{To(z,{})},I=z=>{var ne=De(),re=ue(ne);{var le=L=>{zo(L,{})},U=L=>{var j=De(),ee=ue(j);{var K=fe=>{Ao(fe,{})},ae=fe=>{var pe=De(),ve=ue(pe);{var oe=ye=>{Oo(ye,{})};q(ve,ye=>{o()==="socials"&&ye(oe)},!0)}m(fe,pe)};q(ee,fe=>{o()==="frames"?fe(K):fe(ae,!1)},!0)}m(L,j)};q(re,L=>{o()==="dialogs"?L(le):L(U,!1)},!0)}m(z,ne)};q(k,z=>{o()==="items"?z($):z(I,!1)})}var A=E(k,2);tl(A,{});var H=E(A,2);ol(H,{});var O=E(H,2);Yn(O,{});var Y=E(O,2);hl(Y,{});var M=E(Y,2),T=E(M,2);Bi(T,{position:"top-left",children:(z,ne)=>{var re=El();let le;var U=D(re);de(U,{variant:"green",width:"100px",onclick:P,children:(j,ee)=>{var K=he("SAVE");m(j,K)},$$slots:{default:!0}});var L=E(U,2);{let j=G(()=>l()?"blue":"orange");de(L,{get variant(){return r(j)},width:"80px",onclick:p,title:"Toggle grid snapping",children:(ee,K)=>{var ae=he();V(()=>Ee(ae,l()?"FREE":"SNAP")),m(ee,ae)},$$slots:{default:!0}})}V(()=>le=Te(re,1,"left-buttons svelte-1lbkour",null,le,{"hide-left":r(w)})),m(z,re)},$$slots:{default:!0}});var Z=E(T,2);Bi(Z,{position:"top-right",children:(z,ne)=>{var re=Tl();let le;var U=D(re);Il(U,{align:"end",children:(L,j)=>{var ee=kl(),K=ue(ee);{let ve=G(()=>o()==="items"&&c()?"orange":"blue");de(K,{get variant(){return r(ve)},onclick:()=>{o()==="items"?Ca():(Bt("items"),Et.set(!0))},title:"Edit items",children:(oe,ye)=>{var Ie=he("ITEMS");m(oe,Ie)},$$slots:{default:!0}})}var ae=E(K,2);{let ve=G(()=>o()==="frames"&&d()?"orange":"purple");de(ae,{get variant(){return r(ve)},onclick:()=>{o()==="frames"?ka():(Bt("frames"),wt.set(!0))},title:"Edit text frames",children:(oe,ye)=>{var Ie=he("FRAMES");m(oe,Ie)},$$slots:{default:!0}})}var fe=E(ae,2);{let ve=G(()=>o()==="socials"&&h()?"orange":"pink");de(fe,{get variant(){return r(ve)},onclick:()=>{o()==="socials"?Da():(Bt("socials"),It.set(!0))},title:"Edit social icons",children:(oe,ye)=>{var Ie=he("SOCIALS");m(oe,Ie)},$$slots:{default:!0}})}var pe=E(fe,2);_l(pe,{children:(ve,oe)=>{var ye=Cl(),Ie=ue(ye);{var Oe=Ke=>{de(Ke,{variant:"cyan",width:"100px",onclick:b,title:"Create new dialog zone at center of view",children:(yt,Yt)=>{var ht=he("+ ZONE");m(yt,ht)},$$slots:{default:!0}})};q(Ie,Ke=>{o()==="dialogs"&&Ke(Oe)})}var Ue=E(Ie,2);{let Ke=G(()=>o()==="dialogs"?"orange":"cyan");de(Ue,{get variant(){return r(Ke)},onclick:()=>{o()==="dialogs"?Bt("items"):Bt("dialogs")},title:"Edit dialog zones",children:(yt,Yt)=>{var ht=he("DIALOGS");m(yt,ht)},$$slots:{default:!0}})}m(ve,ye)},$$slots:{default:!0}}),m(L,ee)},$$slots:{default:!0}}),V(()=>le=Te(re,1,"right-buttons svelte-1lbkour",null,le,{"hide-right":r(w)})),m(z,re)},$$slots:{default:!0}}),m(i,v),ke(),S()}var Ml=F('<img class="skin-preview-img svelte-12jgjc8"/>'),Al=F('<canvas width="96" height="96" class="skin-preview svelte-12jgjc8"></canvas>'),$l=F('<button type="button"><div class="skin-preview-container svelte-12jgjc8"><!></div> <span class="skin-name svelte-12jgjc8"> </span></button>'),Hl=F('<span class="custom-icon svelte-12jgjc8">👤</span>'),Ll=F('<span class="custom-icon svelte-12jgjc8">✨</span>'),Ol=F('<button class="edit-btn svelte-12jgjc8" type="button">EDIT</button>'),Rl=F('<button class="background-card svelte-12jgjc8" type="button"><div class="preview-container svelte-12jgjc8"><img class="preview-image svelte-12jgjc8"/></div> <span class="background-name svelte-12jgjc8"> </span></button>'),Xl=F('<div class="background-select-screen svelte-12jgjc8"><div class="content svelte-12jgjc8"><h1 class="title svelte-12jgjc8">SELECT CHARACTER</h1> <div class="skins-grid svelte-12jgjc8"><!> <div class="skin-card-wrapper svelte-12jgjc8"><button type="button"><div class="skin-preview-container custom-preview svelte-12jgjc8"><!></div> <span class="skin-name svelte-12jgjc8">CUSTOM</span></button> <!></div></div> <h1 class="title svelte-12jgjc8">SELECT BACKGROUND</h1> <div class="backgrounds-grid svelte-12jgjc8"></div></div></div>');function Fl(i,e){Ce(e,!0);const t="custom";function s(){window.location.href="./builder.html"}const n=at,a=Ae,o=qs()!==null,l=localStorage.getItem("useModularPlayer")==="true";let c=ie(rt(l&&o?t:Ct.getSkinId())),d=rt({}),h=rt({});Fe(()=>{a.forEach(M=>{const T=fs(M),Z=new Image;Z.onload=()=>{h[M.id]=!0},Z.onerror=()=>{h[M.id]=!1,S(M)},Z.src=`./${T}/preview.png`})});function f(M){return`./${fs(M)}/preview.png`}function S(M){const T=d[M.id];if(!T)return;const Z=T.getContext("2d");if(!Z)return;const z=M.frameWidth??48,ne=M.frameHeight??48,re=fs(M),le=new Image;le.src=`./${re}/idle.png`,le.onload=()=>{Z.clearRect(0,0,T.width,T.height),Z.imageSmoothingEnabled=!1;const U=T.width/z,L=T.height/ne,j=Math.min(U,L),ee=z*j,K=ne*j,ae=(T.width-ee)/2,fe=(T.height-K)/2;Z.drawImage(le,0,0,z,ne,ae,fe,ee,K)}}function C(M){return`./assets/backgrounds/${M}/preview.png`}function y(M){if(M===t){if(!o){s();return}R(c,t),localStorage.setItem("useModularPlayer","true"),Gs.set(t)}else R(c,M,!0),Ct.setSkin(M),localStorage.setItem("useModularPlayer","false"),Gs.set(M)}function w(){s()}function P(M){tt.setBackgroundByIndex(M),on.set(n[M].name),ln.set(!0),go()}var p=Xl(),b=D(p),v=E(D(b),2),g=D(v);Ne(g,17,()=>a,ze,(M,T)=>{var Z=$l();let z;Z.__click=()=>y(r(T).id);var ne=D(Z),re=D(ne);{var le=ee=>{var K=Ml();V(ae=>{Q(K,"src",ae),Q(K,"alt",r(T).name)},[()=>f(r(T))]),m(ee,K)},U=ee=>{var K=Al();mt(K,(ae,fe)=>d[fe.id]=ae,ae=>d?.[ae.id],()=>[r(T)]),m(ee,K)};q(re,ee=>{h[r(T).id]?ee(le):ee(U,!1)})}var L=E(ne,2),j=D(L);V(()=>{z=Te(Z,1,"skin-card svelte-12jgjc8",null,z,{selected:r(c)===r(T).id}),Ee(j,r(T).name)}),m(M,Z)});var u=E(g,2),_=D(u);let x;_.__click=()=>y(t);var k=D(_),$=D(k);{var I=M=>{var T=Hl();m(M,T)},A=M=>{var T=Ll();m(M,T)};q($,M=>{o?M(I):M(A,!1)})}var H=E(_,2);{var O=M=>{var T=Ol();T.__click=w,m(M,T)};q(H,M=>{o&&r(c)===t&&M(O)})}var Y=E(v,4);Ne(Y,21,()=>n,ze,(M,T,Z)=>{var z=Rl();z.__click=()=>P(Z);var ne=D(z),re=D(ne),le=E(ne,2),U=D(le);V(L=>{Q(re,"src",L),Q(re,"alt",r(T).name),Ee(U,r(T).name)},[()=>C(r(T).folder)]),m(M,z)}),V(()=>x=Te(_,1,"skin-card custom-card svelte-12jgjc8",null,x,{selected:r(c)===t})),m(i,p),ke()}ot(["click"]);var Wl=F("<div> </div>"),Yl=F('<div class="dialog-content svelte-hli3ii"> </div>'),Zl=F("<div><!> <!></div>");function Bl(i,e){Ce(e,!0);const t=()=>X(Rr,"$activeDialogText",n),s=()=>X(Vi,"$playerScreenPosition",n),[n,a]=He();let o=G(()=>t()?.title&&t()?.content),l=G(()=>Math.max(10,window.innerHeight-s().y+Bo)),c=G(()=>window.innerWidth<=Zo),d=G(()=>r(c)?50:s().x),h=G(()=>r(c)?"percent":"px");var f=De(),S=ue(f);{var C=y=>{var w=Zl();let P;var p=D(w);{var b=u=>{var _=Wl();let x;var k=D(_);V(()=>{x=Te(_,1,"dialog-title svelte-hli3ii",null,x,{"has-divider":r(o)}),Ee(k,t().title)}),m(u,_)};q(p,u=>{t().title&&u(b)})}var v=E(p,2);{var g=u=>{var _=Yl(),x=D(_);V(()=>Ee(x,t().content)),m(u,_)};q(v,u=>{t().content&&u(g)})}V(()=>{P=Te(w,1,"dialog-bubble svelte-hli3ii",null,P,{narrow:r(c)}),ge(w,`bottom: ${r(l)??""}px; left: ${r(d)??""}${r(h)??""};`)}),m(y,w)};q(S,y=>{t()&&y(C)})}m(i,f),ke(),a()}var Gl=F('<div class="game-mask mask-top svelte-1u9aoac"></div> <div class="game-mask mask-bottom svelte-1u9aoac"></div> <div class="game-mask mask-left svelte-1u9aoac"></div> <div class="game-mask mask-right svelte-1u9aoac"></div> <div class="game-frame svelte-1u9aoac"><div class="frame-border frame-top svelte-1u9aoac"></div> <div class="frame-border frame-bottom svelte-1u9aoac"></div> <div class="frame-border frame-left svelte-1u9aoac"></div> <div class="frame-border frame-right svelte-1u9aoac"></div> <div class="frame-corner corner-top-left svelte-1u9aoac"></div> <div class="frame-corner corner-top-right svelte-1u9aoac"></div> <div class="frame-corner corner-bottom-left svelte-1u9aoac"></div> <div class="frame-corner corner-bottom-right svelte-1u9aoac"></div></div>',1);function Nl(i,e){Ce(e,!1);const t=()=>X(ra,"$gameFrameColor",n),s=()=>X(Ji,"$gameWorldDimensions",n),[n,a]=He(),o=lt(),l=lt(),c=lt(),d=lt(),h=lt(),f=lt(),S=lt();ct(()=>t(),()=>{R(o,t())}),ct(()=>s(),()=>{R(l,s())}),ct(()=>r(l),()=>{R(c,`
    top: ${r(l).offsetY}px;
    left: ${r(l).offsetX}px;
    width: ${r(l).worldWidth}px;
    height: ${r(l).worldHeight}px;
  `)}),ct(()=>r(l),()=>{R(d,r(l).offsetY)}),ct(()=>r(l),()=>{R(h,r(l).offsetX)}),ct(()=>r(l),()=>{R(f,r(l).offsetX+r(l).worldWidth)}),ct(()=>r(l),()=>{R(S,r(l).offsetY+r(l).worldHeight)}),Ui();var C=Gl(),y=ue(C),w=E(y,2),P=E(w,2),p=E(P,2),b=E(p,2);V(()=>{ge(y,`height: ${r(d)??""}px; background: ${r(o)??""};`),ge(w,`top: ${r(S)??""}px; background: ${r(o)??""};`),ge(P,`top: ${r(d)??""}px; height: ${r(l),Qt(()=>r(l).worldHeight)??""}px; width: ${r(h)??""}px; background: ${r(o)??""};`),ge(p,`top: ${r(d)??""}px; height: ${r(l),Qt(()=>r(l).worldHeight)??""}px; left: ${r(f)??""}px; background: ${r(o)??""};`),ge(b,`--frame-thickness: 16px; --frame-color: ${r(o)??""}; ${r(c)??""}`)}),m(i,C),ke(),a()}var Kl=F("<!> <!>",1),zl=F('<div class="touch-controls"><p class="touch-text">Tap and hold<br/>where you want<br/>to move</p></div>'),Ul=F('<div class="desktop-controls"><div class="key-row"><div class="pixel-key">A</div> <div class="pixel-key">W</div> <div class="pixel-key">D</div></div> <p class="or-text">or</p> <div class="key-row"><div class="pixel-key">←</div> <div class="pixel-key">↑</div> <div class="pixel-key">→</div></div></div>'),jl=F('<div class="loader-overlay"><div class="pixel-loader"></div></div>'),Vl=F('<!> <div class="game-ui-wrapper svelte-1aa1t05"><!> <!> <!> <dialog class="pixel-dialog"><h1>CONTROLS</h1> <div class="controls-content"><!></div></dialog> <!></div>',1);function ql(i,e){Ce(e,!1);const t=()=>X(Gt,"$showControlsDialog",h),s=()=>X(ii,"$hasPlayerMoved",h),n=()=>X(ln,"$hasSelectedBackground",h),a=()=>X(oa,"$gameFrameVisible",h),o=()=>X(en,"$isBuilderMode",h),l=()=>X(is,"$currentLanguage",h),c=()=>X(cn,"$isTouchDevice",h),d=()=>X(Ns,"$isLoading",h),[h,f]=He();let S=lt();function C(){const g=Fn.toggleLanguage();is.set(g)}function y(g){!r(S)?.open||g.target.closest(".pixel-button")||Gt.set(!1)}function w(){const g=co();if(!g){console.error("Cannot enter builder mode: map config not found");return}ho(g)}ct(()=>(r(S),t()),()=>{r(S)&&(t()?r(S).showModal():r(S).close())}),ct(()=>(s(),r(S),Gt),()=>{s()&&r(S)?.open&&Gt.set(!1)}),Ui(),na();var P=De();je("pointerdown",ta,y);var p=ue(P);{var b=g=>{Fl(g,{})},v=g=>{var u=Vl(),_=ue(u);{var x=L=>{Nl(L,{})};q(_,L=>{a()&&!o()&&L(x)})}var k=E(_,2),$=D(k);{var I=L=>{Pl(L,{})},A=L=>{var j=Kl(),ee=ue(j);Bl(ee,{});var K=E(ee,2);Yn(K,{}),m(L,j)};q($,L=>{o()?L(I):L(A,!1)})}var H=E($,2);{var O=L=>{de(L,{position:"top-left",variant:"green",width:"120px",onclick:w,title:"Toggle Builder Mode",children:(j,ee)=>{var K=he("BUILD");m(j,K)},$$slots:{default:!0}})};q(H,L=>{o()||L(O)})}var Y=E(H,2);{var M=L=>{de(L,{position:"top-right",variant:"default",width:"100px",onclick:C,title:"Toggle Language (L)",children:(j,ee)=>{var K=he();V(ae=>Ee(K,ae),[()=>(l(),Qt(()=>l().toUpperCase()))]),m(j,K)},$$slots:{default:!0}})};q(Y,L=>{o()||L(M)})}var T=E(Y,2),Z=E(D(T),2),z=D(Z);{var ne=L=>{var j=zl();m(L,j)},re=L=>{var j=Ul();m(L,j)};q(z,L=>{c()?L(ne):L(re,!1)})}mt(T,L=>R(S,L),()=>r(S));var le=E(T,2);{var U=L=>{var j=jl();m(L,j)};q(le,L=>{d()&&L(U)})}m(g,u)};q(p,g=>{n()?g(v,!1):g(b)})}m(i,P),ke(),f()}Ya();const Zn=document.getElementById("game-ui");if(!Zn)throw new Error("game-ui element not found!");sa(ql,{target:Zn});is.set(Fn.getLanguage());Gs.set(Ct.getSkinId());on.set(tt.getCurrentConfig().name);const Jl={type:B.AUTO,width:800,height:600,parent:"game-container",backgroundColor:"#000000",pixelArt:!0,roundPixels:!0,scale:{mode:B.Scale.RESIZE,autoCenter:B.Scale.CENTER_BOTH},input:{activePointers:3},physics:{default:"arcade",arcade:{gravity:{y:1e3,x:0},debug:!1}},audio:{noAudio:!0},scene:[]},Ds=new B.Game(Jl);Ds.scene.add(et.GAME,Vr);Ds.scene.add(et.BUILDER,ro);lo(Ds);const Ql=Ds.device.input.touch;cn.set(Ql);const ec=performance.getEntriesByType("navigation")[0]&&performance.getEntriesByType("navigation")[0].type==="reload",tc=sessionStorage.getItem("hasSeenControlsHint");(!tc||ec)&&(sessionStorage.setItem("hasSeenControlsHint","true"),Gt.set(!0));
//# sourceMappingURL=main-DIWZ04Fv.js.map
